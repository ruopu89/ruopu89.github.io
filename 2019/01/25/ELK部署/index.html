<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="elk概念 ELK又称为ELK Stack,是 Elasticsearch、Logstash、Kibana 三个开源软件的组合,每个完成不同的功能，官方网站 www.elastic.co  elasticsearch概念 Elasticsearch 可实现数据的实时全文搜索、支持分布式可实现高可用、提供API接口，可以处理大规模日志数据，比如Nginx、Tomcat、系统日志等。  logstas">
<meta name="keywords" content="日志收集">
<meta property="og:type" content="article">
<meta property="og:title" content="ELK部署">
<meta property="og:url" content="http://yoursite.com/2019/01/25/ELK部署/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:description" content="elk概念 ELK又称为ELK Stack,是 Elasticsearch、Logstash、Kibana 三个开源软件的组合,每个完成不同的功能，官方网站 www.elastic.co  elasticsearch概念 Elasticsearch 可实现数据的实时全文搜索、支持分布式可实现高可用、提供API接口，可以处理大规模日志数据，比如Nginx、Tomcat、系统日志等。  logstas">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="http://yoursite.com/images/kibana/访问1.png">
<meta property="og:image" content="http://yoursite.com/images/kibana/配置索引1.png">
<meta property="og:image" content="http://yoursite.com/images/kibana/配置索引2.png">
<meta property="og:image" content="http://yoursite.com/images/kibana/查看1.png">
<meta property="og:image" content="http://yoursite.com/images/kibana/查看2.png">
<meta property="og:image" content="http://yoursite.com/images/kibana/地图1.png">
<meta property="og:image" content="http://yoursite.com/images/kibana/地图2.png">
<meta property="og:image" content="http://yoursite.com/images/kibana/地图3.png">
<meta property="og:image" content="http://yoursite.com/images/kibana/地图4.png">
<meta property="og:updated_time" content="2020-01-28T15:03:17.432Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ELK部署">
<meta name="twitter:description" content="elk概念 ELK又称为ELK Stack,是 Elasticsearch、Logstash、Kibana 三个开源软件的组合,每个完成不同的功能，官方网站 www.elastic.co  elasticsearch概念 Elasticsearch 可实现数据的实时全文搜索、支持分布式可实现高可用、提供API接口，可以处理大规模日志数据，比如Nginx、Tomcat、系统日志等。  logstas">
<meta name="twitter:image" content="http://yoursite.com/images/kibana/访问1.png">






  <link rel="canonical" href="http://yoursite.com/2019/01/25/ELK部署/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ELK部署 | ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/25/ELK部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ELK部署
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-25 09:04:32" itemprop="dateCreated datePublished" datetime="2019-01-25T09:04:32+08:00">2019-01-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-01-28 23:03:17" itemprop="dateModified" datetime="2020-01-28T23:03:17+08:00">2020-01-28</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             閱讀次數： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="elk概念"><a href="#elk概念" class="headerlink" title="elk概念"></a>elk概念</h3><blockquote>
<p>ELK又称为ELK Stack,是 Elasticsearch、Logstash、Kibana 三个开源软件的组合,每个完成不同的功能，官方网站 <a href="http://www.elastic.co" target="_blank" rel="noopener">www.elastic.co</a></p>
</blockquote>
<h4 id="elasticsearch概念"><a href="#elasticsearch概念" class="headerlink" title="elasticsearch概念"></a>elasticsearch概念</h4><blockquote>
<p>Elasticsearch 可实现数据的实时全文搜索、支持分布式可实现高可用、提供<br>API接口，可以处理大规模日志数据，比如Nginx、Tomcat、系统日志等。</p>
</blockquote>
<h4 id="logstash概念"><a href="#logstash概念" class="headerlink" title="logstash概念"></a>logstash概念</h4><blockquote>
<p>Logstash:通过插件实现日志收集，支持日志过滤，支持普通log、自定义json格式的日志解析。</p>
</blockquote>
<h5 id="logstash格式"><a href="#logstash格式" class="headerlink" title="logstash格式"></a>logstash格式</h5><blockquote>
<p>input {} #input 插件收集日志</p>
<p>output {} #output 插件输出日志</p>
</blockquote>
<h4 id="kibana概念"><a href="#kibana概念" class="headerlink" title="kibana概念"></a>kibana概念</h4><blockquote>
<p>kibana：kibana主要是调用elasticsearch的数据，并进行前端数据可视化的展现。</p>
</blockquote>
<h3 id="elk部署"><a href="#elk部署" class="headerlink" title="elk部署"></a>elk部署</h3><h4 id="elk简单部署"><a href="#elk简单部署" class="headerlink" title="elk简单部署"></a>elk简单部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line">======================================================================================</span><br><span class="line">收集单个日志</span><br><span class="line">======================================================================================</span><br><span class="line"></span><br><span class="line">准备三台主机，做els集群，配置：双核处理器，2G内存。地址：192.168.1.20，192.168.1.21，192.168.1.22</span><br><span class="line">准备一台主机，安装nginx，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装kibana，地址：192.168.1.23</span><br><span class="line"></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">sed -i ‘/SELINUX/s/enforcing/disabled/’ /etc/selinux/config</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭三台主机的防火墙和SELinux</span></span><br><span class="line">ulimit -n</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看打开文件最大数</span></span><br><span class="line">echo "* soft nofile 65536" &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo "* hard nofile 65536" &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整打开文件最大数</span></span><br><span class="line">ulimit -n 65535</span><br><span class="line"><span class="meta">#</span><span class="bash"> 临时调整打开文件最大数</span></span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br><span class="line">chronyc</span><br><span class="line"><span class="meta">chronyc&gt;</span><span class="bash"> waitsync</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步三台主机时间</span></span><br><span class="line">yum install jdk-8u201-linux-x64.rpm -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装jdk</span></span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">    export JAVA_HOME=/usr</span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置java家目录并加载</span></span><br><span class="line">yum install -y elasticsearch-6.5.4.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 三台主机均安装els</span></span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">    cluster.name: testelk</span><br><span class="line">    # 集群的名称，名称相同的主机就是处于同一个集群</span><br><span class="line">    node.name: node1</span><br><span class="line">    # 集群情况下，当前node的名字，每个node应该不一样。要将此文件复制到另两个节点</span><br><span class="line">    path.data: /elkdata/data</span><br><span class="line">    # 数据目录</span><br><span class="line">    path.logs: /elkdata/logs</span><br><span class="line">    # 日志目录</span><br><span class="line">    # bootstrap.memory_lock: true</span><br><span class="line">    # 服务启动时即锁定足够大的内存，提高效率。测试中如果打开此项，启动会失败，提示内存未锁定</span><br><span class="line">    network.host: 0.0.0.0</span><br><span class="line">    # 监听的地址</span><br><span class="line">    http.port: 9200</span><br><span class="line">    # 客户端访问端口</span><br><span class="line">    discovery.zen.ping.unicast.hosts: ["192.168.1.20", "192.168.1.21", "192.168.1.22"]</span><br><span class="line">    # 组播范围</span><br><span class="line">    discovery.zen.minimum_master_nodes: 2</span><br><span class="line">    # 设置此项为了必免脑裂，这里的数字是总节点数除以2加1算出来的。</span><br><span class="line">vim /etc/elasticsearch/jvm.options</span><br><span class="line">    -Xms3g  # 初始化的堆内存</span><br><span class="line">    -Xmx3g  # 最大堆内存，可以改大此值。这两个值要保持一致。或将上面配置文件中的bootstrap.memory_lock的值改为false</span><br><span class="line">mkdir /elkdata/&#123;data,logs&#125; -pv</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据和日志目录</span></span><br><span class="line">chown elasticsearch.elasticsearch /elkdata/ -R</span><br><span class="line">systemctl start elasticsearch</span><br><span class="line">systemctl enable elasticsearch</span><br><span class="line"><span class="meta">#</span><span class="bash"> 三台服务器启动并查看状态</span></span><br><span class="line">======================================================================================</span><br><span class="line">Master的职责：</span><br><span class="line">1. 节点状态信息</span><br><span class="line">2. 集群状态信息</span><br><span class="line">3. 创建索引</span><br><span class="line">4. 删除索引</span><br><span class="line">5. 分片管理</span><br><span class="line">6. 关闭节点</span><br><span class="line">Slave节点的职责：</span><br><span class="line">1. 同步数据</span><br><span class="line">2. 等待机会成为master</span><br><span class="line">======================================================================================</span><br><span class="line">-----------------------------------</span><br><span class="line">  node1上安装elasticsearch-head插件</span><br><span class="line">-----------------------------------</span><br><span class="line">git clone git://github.com/mobz/elasticsearch-head.git</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载elasticsearch-head插件，这个插件是为了实现简单的集群监控、主机信息显示和管理等功能</span></span><br><span class="line">yum install -y epel-release</span><br><span class="line">yum install npm -y</span><br><span class="line">cd elasticsearch-head/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意，再次启动监听9100端口时要到这个目录下执行npm run start &amp;，不然会报错。</span></span><br><span class="line">npm install grunt -save</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里可能会有报错<span class="string">"npm: relocation error: npm: symbol SSL_set_cert_cb, version libssl.so.10 not defined in file libssl.so.10 with link time reference"</span>，需要安装openssl即可解决。</span></span><br><span class="line">npm install</span><br><span class="line">npm run start &amp;</span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">    #---------------------------------- http ---------------------------------------</span><br><span class="line">    http.cors.enabled: true     # 打开http功能</span><br><span class="line">    http.cors.allow-origin: "*"     # 允许谁访问</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置elasticsearch允许远程访问</span></span><br><span class="line">systemctl restart elasticsearch</span><br><span class="line"></span><br><span class="line">* nginx</span><br><span class="line">yum install -y gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br><span class="line">tar xf nginx-1.12.2.tar.gz</span><br><span class="line">cd nginx-1.12.2/</span><br><span class="line">./configure --prefix=/usr/local/nginx</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd /usr/local/nginx/</span><br><span class="line">mkdir html/test</span><br><span class="line">echo "nginx test page" &gt;&gt; html/test/index.html</span><br><span class="line">vim conf/nginx.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        location /test &#123;</span><br><span class="line">           root html;</span><br><span class="line">           index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">/usr/local/nginx/sbin/nginx -t</span><br><span class="line">/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">访问http://192.168.1.30/test/测试</span><br><span class="line">======================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面在nginx主机上安装logstash</span></span><br><span class="line">======================================================================================</span><br><span class="line">yum -y install jdk-8u201-linux-x64.rpm</span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">export JAVA_HOME=/usr</span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line">yum -y install logstash-6.5.4.rpm</span><br><span class="line">systemctl start logstash</span><br><span class="line">systemctl enable logstash</span><br><span class="line">/usr/share/logstash/bin/logstash -e "input&#123;stdin&#123;&#125;&#125; output&#123;stdout&#123; codec =&gt; "rydebug"&#125;&#125;"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行此命令并不需要启动logstash服务，执行此命令就是启动服务，Ctrl + c可以关闭服务</span></span><br><span class="line">WARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class="line">[WARN ] 2019-06-25 17:14:39.128 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified</span><br><span class="line">[INFO ] 2019-06-25 17:14:39.153 [LogStash::Runner] runner - Starting Logstash &#123;"logstash.version"=&gt;"6.5.4"&#125;</span><br><span class="line">[INFO ] 2019-06-25 17:14:44.034 [Converge PipelineAction::Create&lt;main&gt;] pipeline - Starting pipeline &#123;:pipeline_id=&gt;"main", "pipeline.workers"=&gt;2, "pipeline.batch.size"=&gt;125, "pipeline.batch.delay"=&gt;50&#125;</span><br><span class="line">The stdin plugin is now waiting for input:</span><br><span class="line">[INFO ] 2019-06-25 17:14:44.444 [Converge PipelineAction::Create&lt;main&gt;] pipeline - Pipeline started successfully &#123;:pipeline_id=&gt;"main", :thread=&gt;"#&lt;Thread:0x71f559d3 run&gt;"&#125;</span><br><span class="line">[INFO ] 2019-06-25 17:14:44.603 [Ruby-0-Thread-1: /usr/share/logstash/lib/bootstrap/environment.rb:6] agent - Pipelines running &#123;:count=&gt;1, :running_pipelines=&gt;[:main], :non_running_pipelines=&gt;[]&#125;</span><br><span class="line">[INFO ] 2019-06-25 17:14:45.472 [Api Webserver] agent - Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是一条使用标准输入输出的命令，上面是执行命令后的正常输出。有时会报错，不明白原因，可能是没有调动logstash，可能是没有设置JAVA_HOME环境变量，修改后一定重启logstash。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次测试时会提示找不到rydebug模块，无法加载。不清楚报错的原因。使用下面的配置文件是没有问题的。启动后</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会监听9600端口</span></span><br><span class="line">    hello    # 输入hello后会有下面信息</span><br><span class="line">    &#123;</span><br><span class="line">        "@timestamp" =&gt; 2019-01-24T08:47:22.515Z,    </span><br><span class="line">        #@timestamp，用来标记当前事件发生的时间</span><br><span class="line">        "message" =&gt; "hello",    #消息的具体内容</span><br><span class="line">            "host" =&gt; "nginx1",    #host标记事件发生在哪里</span><br><span class="line">        "@version" =&gt; "1"    #@version时间版本号，一个事件就是一个ruby对象</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试。这要等待一会儿才会有结果</span></span><br><span class="line">vim /etc/logstash/conf.d/system.conf</span><br><span class="line">    input &#123;</span><br><span class="line">        file&#123;</span><br><span class="line">            type =&gt; "messagelog"</span><br><span class="line">            path =&gt; "/var/log/messages"</span><br><span class="line">            start_position =&gt; "beginning"   # 首次从头收集</span><br><span class="line">        &#125;</span><br><span class="line">        # 从文件输入，类型是messagelog，写明路径，最后指定从头收集</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    output &#123;</span><br><span class="line">        file &#123;</span><br><span class="line">            path =&gt; "/tmp/123.txt"</span><br><span class="line">        &#125;</span><br><span class="line">        # 输出到一个文件，用file引导，下面写明路径。</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; ["192.168.1.20:9200"]    # 指定第一台elaticsearch地址即可。</span><br><span class="line">            index =&gt; "system-messages-%&#123;+YYYY.MM.dd&#125;"   # 索引的命名规则，后面加入日期</span><br><span class="line">        &#125;</span><br><span class="line">        # 输出到elasticsearch，写明地址，索引的名称</span><br><span class="line">    &#125;</span><br><span class="line">/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf -t</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-f指定配置文件，-t表示测试配置文件是否正确</span></span><br><span class="line">chmod 644 /var/log/messages</span><br><span class="line"><span class="meta">#</span><span class="bash"> 让普通用户可以读系统日志</span></span><br><span class="line">systemctl start logstash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动logstash。也可以使用/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf在前台启动</span></span><br><span class="line">tail -f /tmp/123.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以看到输出的日志文件了</span></span><br><span class="line">访问192.168.1.20:9100，在其中的数据浏览中修改上方的连接地址为第一台logstash的地址，之后就可以看到一个叫system-messages-2019.01.24的索引了</span><br><span class="line"></span><br><span class="line">======================================================================================</span><br><span class="line">收集多个日志</span><br><span class="line">======================================================================================</span><br><span class="line">cp /etc/logstash/conf.d/system.conf /etc/logstash/conf.d/nginx.conf -a</span><br><span class="line">vim /etc/logstash/conf.d/nginx.conf</span><br><span class="line">input &#123;</span><br><span class="line">   file&#123;</span><br><span class="line">      type =&gt; "messagelog"      # type是自定义的，为了下面的if判断使用</span><br><span class="line">      path =&gt; "/var/log/messages"</span><br><span class="line">      start_position =&gt; "beginning"</span><br><span class="line">   &#125;</span><br><span class="line">   file &#123;</span><br><span class="line">      type =&gt; "nginxlog"</span><br><span class="line">      path =&gt; "/usr/local/nginx/logs/access.log"</span><br><span class="line">      start_position =&gt; "beginning"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">   file &#123;</span><br><span class="line">      path =&gt; "/tmp/123.txt"</span><br><span class="line">   &#125;</span><br><span class="line">   elasticsearch &#123;</span><br><span class="line">      hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">      index =&gt; "system-messages-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">   &#125;</span><br><span class="line">   if [type] == "nginxlog" &#123;        # 使用if判断type是否为输入中定义的nginxlog，如果是就传输到elasticsearch中</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">      hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">      index =&gt; "nginx-messages-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf -t</span><br><span class="line">systemctl restart logstash</span><br><span class="line">访问192.168.1.20:9100，在概览中可以看到传过来的nginxlog索引了</span><br><span class="line"></span><br><span class="line">* kibana</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面安装kibana</span></span><br><span class="line">yum install -y kibana-6.5.4-x86_64.rpm</span><br><span class="line">vim /etc/kibana/kibana.yml</span><br><span class="line">    server.port: 5601</span><br><span class="line">    server.host: "0.0.0.0"</span><br><span class="line">    elasticsearch.url: "http://192.168.1.20:9200"   # 调用elasticsearch的接口，写一个就可以</span><br><span class="line">systemctl start kibana</span><br><span class="line">yum install -y gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br><span class="line">tar xf nginx-1.12.2.tar.gz</span><br><span class="line">cd nginx-1.12.2/</span><br><span class="line">./configure --prefix=/usr/local/nginx</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用nginx反向代理kibana</span></span><br><span class="line">vim /etc/kibana/kibana.yml</span><br><span class="line">    server.host: "localhost"</span><br><span class="line">    # 改为监听本地地址</span><br><span class="line">cd /usr/local/nginx/</span><br><span class="line">mkdir /usr/local/nginx/conf/conf.d</span><br><span class="line">vim /usr/local/nginx/conf/conf.d/kibana.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name test.kibana.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://localhost:5601;</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">            proxy_set_header Connection 'upgrade';</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_cache_bypass $http_upgrade;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">    http &#123;</span><br><span class="line">        ...</span><br><span class="line">        include /usr/local/nginx/conf/conf.d/*.conf;</span><br><span class="line">    &#125;</span><br><span class="line">/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">设置本机可以解析test.kibana.com</span><br></pre></td></tr></table></figure>
<h5 id="kibana简单设置使用"><a href="#kibana简单设置使用" class="headerlink" title="kibana简单设置使用"></a>kibana简单设置使用</h5><h6 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h6><blockquote>
<p>这里可以选择使用样本数据，也可以只使用自己的数据。可以通过对样本数据设置的学习，了解kibana的设置方法</p>
</blockquote>
<p><img src="/images/kibana/访问1.png" alt=""></p>
<h6 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h6><blockquote>
<p>选择左侧的Management，之后在右边输入从els中获取的索引的名称，只需要输入前面部分，后面的日期可以使用星号配置，这里在下面也可以看到匹配到的索引，最后点击下一步。之后选择按时间过滤并创建即可。</p>
</blockquote>
<p><img src="/images/kibana/配置索引1.png" alt=""></p>
<p><img src="/images/kibana/配置索引2.png" alt=""></p>
<blockquote>
<p>之后可以在Discover中看到我们添加的索引了，如果无法显示数据，可能是右上方的时间有误</p>
</blockquote>
<p><img src="/images/kibana/查看1.png" alt=""></p>
<h5 id="nginx登录认证"><a href="#nginx登录认证" class="headerlink" title="nginx登录认证"></a>nginx登录认证</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* kibana</span><br><span class="line">[root@kibana ~]# yum install -y httpd-tools</span><br><span class="line">[root@kibana ~]# htpasswd -bc /usr/local/nginx/conf/htpasswd.users kibanauser centos</span><br><span class="line">Adding password for user kibanauser</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置登录用户名和密码</span></span><br><span class="line">[root@kibana ~]# vim /usr/local/nginx/conf/conf.d/kibana.conf </span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name test.kibana.com;</span><br><span class="line">   auth_basic "Restricted Access";</span><br><span class="line">   auth_basic_user_file /usr/local/nginx/conf/htpasswd.users;</span><br><span class="line">   location / &#123;</span><br><span class="line">      proxy_pass http://localhost:5601;</span><br><span class="line">      proxy_http_version 1.1;</span><br><span class="line">      proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">      proxy_set_header Connection 'upgrade';</span><br><span class="line">      proxy_set_header Host $host;</span><br><span class="line">      proxy_cache_bypass $http_upgrade;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入认证</span></span><br><span class="line">[root@kibana ~]# /usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">再次访问kibana页面时就需要认证了</span><br></pre></td></tr></table></figure>
<h4 id="日志收集"><a href="#日志收集" class="headerlink" title="日志收集"></a>日志收集</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line">======================================================================================</span><br><span class="line">* 规划</span><br><span class="line">通过在要收集日志的服务器上安装filebeat进行日志收集，之后将收集到的数据写入到redis服务器，再通过logstash服务器取出数据并写入到elasticsearch集群中。也可以通过filebeat收集日志后转发给logstash服务器，再由logstash服务器写入到redis中，再由另一台logstash服务器从redis服务器中取出数据并写入到elasticsearch集群中。</span><br><span class="line"></span><br><span class="line">* 环境</span><br><span class="line">准备三台主机，做els集群，配置：双核处理器，2G内存。地址：192.168.1.20，192.168.1.21，192.168.1.22</span><br><span class="line">准备一台主机，安装nginx，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装kibana，地址：192.168.1.23</span><br><span class="line">准备一台主机，安装redis，地址：192.168.1.24</span><br><span class="line">准备一台主机，安装haproxy，地址：192.168.1.31</span><br><span class="line"></span><br><span class="line">* 软件版本</span><br><span class="line">1. 操作系统:CentOS7.4.1708</span><br><span class="line">2. jdk: jdk-8u201 官方rpm或gz包</span><br><span class="line">3. elasticsearch:6.5.4 官方当前最新rpm</span><br><span class="line">4. logstash:6.5.4 官方当前最新rpm</span><br><span class="line">5. kibana:6.5.4 官方当前最新rpm</span><br><span class="line">6. filebeat:6.5.4 官方当前最新rpm</span><br><span class="line">7. nginx:1.12.2</span><br><span class="line">8. redis:5.0.3 官方最新源码包</span><br><span class="line">======================================================================================</span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis ~]# yum install -y gcc</span><br><span class="line">[root@redis ~]# tar xf redis-5.0.3.tar.gz -C /usr/local/src/</span><br><span class="line">[root@redis redis-5.0.3]# cd /usr/local/src/redis-5.0.3/</span><br><span class="line">[root@redis redis-5.0.3]# make</span><br><span class="line">[root@redis redis-5.0.3]# ln -sv /usr/local/src/redis-5.0.3/ /usr/local/redis</span><br><span class="line">‘/usr/local/redis’ -&gt; ‘/usr/local/src/redis-5.0.3/’</span><br><span class="line">[root@redis redis-5.0.3]# cp src/redis-server src/redis-cli /usr/bin</span><br><span class="line">[root@redis redis-5.0.3]# cd /usr/local/redis/</span><br><span class="line">[root@redis redis]# vim redis.conf</span><br><span class="line">    bind 0.0.0.0</span><br><span class="line">    daemonize yes</span><br><span class="line">    # 让redis以守护进程方式运行</span><br><span class="line">    save ""		</span><br><span class="line">    #save 900 1</span><br><span class="line">    #save 300 10</span><br><span class="line">    #save 60 10000</span><br><span class="line">    # 因为不需要持久存储，所以将save ""打开，将下面三行关闭。</span><br><span class="line">    requirepass centos</span><br><span class="line">    logfile "/var/log/redis.log"</span><br><span class="line">    # 输出日志路径，默认会输出到/dev/null中</span><br><span class="line">[root@redis redis]# redis-server /usr/local/redis/redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动redis，启动时指定配置文件</span></span><br><span class="line">[root@redis redis]# ss -tln</span><br><span class="line">[root@redis redis]# redis-cli </span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">127.0.0.1:6379&gt; AUTH centos</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">(empty list or set)</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  haproxy</span><br><span class="line">-------------</span><br><span class="line">[root@haproxy ~]# yum install jdk-8u201-linux-x64.rpm</span><br><span class="line">[root@haproxy ~]# yum install logstash-6.5.4.rpm</span><br><span class="line">[root@haproxy ~]# yum install -y haproxy</span><br><span class="line">[root@haproxy ~]# vim /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local6		# 这行很重要，local6是haproxy的日志级别，在rsyslog配置文件中也要定义这个级别</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line">frontend myweb		</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server srv1 192.168.1.30:80 check</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里只简单地将haproxy反代到nginx服务器上，实现访问haproxy就会反代到nginx服务器上</span></span><br><span class="line">[root@haproxy ~]# vim /etc/rsyslog.d/haproxy.conf</span><br><span class="line">    $ModLoad imudp</span><br><span class="line">    $UDPServerRun 514</span><br><span class="line">    $ModLoad imtcp</span><br><span class="line">    $InputTCPServerRun 514</span><br><span class="line">    local6.* @@192.168.1.31:5140</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收日志的logstash服务器IP:PORT，local6对应haproxy的日志级别。这里将日志传给了本机的logstash</span></span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/syslog.conf </span><br><span class="line">input &#123;</span><br><span class="line">   syslog &#123;</span><br><span class="line">      type =&gt; "system-rsyslog"</span><br><span class="line">      port =&gt; "5140"		# 从logstash的5140端口输入，实际也是定义logstash监听的端口</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">   stdout &#123;</span><br><span class="line">      codec =&gt; rubydebug</span><br><span class="line">   &#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"		# redis的数据类型要使用list</span><br><span class="line">      key =&gt; "system-rsyslog"		# 写入redis的键名</span><br><span class="line">      host =&gt; "192.168.1.24"		# redis地址</span><br><span class="line">      port =&gt; "6379"		# redis端口</span><br><span class="line">      db =&gt; "0"			# redis库</span><br><span class="line">      password =&gt; "centos"		# redis密码</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# systemctl restart rsyslog</span><br><span class="line"><span class="meta">#</span><span class="bash"> rsyslog监听在514端口</span></span><br><span class="line">[root@haproxy ~]# systemctl start haproxy    </span><br><span class="line">[root@haproxy ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/syslog.conf</span><br><span class="line">在本机设置hosts文件，解析haproxy地址到www.test.com，访问www.test.com，这时应该显示一些信息，如：</span><br><span class="line">&#123;</span><br><span class="line">         "timestamp" =&gt; "Jan 25 12:53:39",</span><br><span class="line">        "@timestamp" =&gt; 2019-01-25T04:53:39.000Z,</span><br><span class="line">           "message" =&gt; "192.168.1.9:33634 [25/Jan/2019:12:53:39.002] myweb websrvs/srv1 0/0/1/1/2 304 175 - - ---- 2/2/0/0/0 0/0 \"GET / HTTP/1.1\"\n",</span><br><span class="line">         "logsource" =&gt; "localhost",</span><br><span class="line">              "type" =&gt; "system-rsyslog",</span><br><span class="line">              "host" =&gt; "192.168.1.31",</span><br><span class="line">          "priority" =&gt; 182,</span><br><span class="line">    "facility_label" =&gt; "local6",</span><br><span class="line">          "severity" =&gt; 6,</span><br><span class="line">           "program" =&gt; "haproxy",</span><br><span class="line">          "facility" =&gt; 22,</span><br><span class="line">    "severity_label" =&gt; "Informational",</span><br><span class="line">               "pid" =&gt; "3817",</span><br><span class="line">          "@version" =&gt; "1"</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到监听了5140端口</span></span><br><span class="line">[root@haproxy ~]# systemctl start logstash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在后台启动</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis redis]# redis-cli -a centos</span><br><span class="line">127.0.0.1:6379&gt; SELECT 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) "system-rsyslog"</span><br><span class="line">127.0.0.1:6379&gt; LLEN system-rsyslog</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; LPOP system-rsyslog</span><br><span class="line">"&#123;\"facility\":22,\"host\":\"192.168.1.31\",\"logsource\":\"localhost\",\"program\":\"haproxy\",\"@version\":\"1\",\"facility_label\":\"local6\",\"message\":\"192.168.1.9:33540 [25/Jan/2019:12:37:37.836] myweb websrvs/srv1 0/0/0/1/1 304 175 - - ---- 2/2/0/1/0 0/0 \\\"GET / HTTP/1.1\\\"\\n\",\"priority\":182,\"pid\":\"3817\",\"timestamp\":\"Jan 25 12:37:37\",\"severity\":6,\"severity_label\":\"Informational\",\"type\":\"system-rsyslog\",\"@timestamp\":\"2019-01-25T04:37:37.000Z\"&#125;"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到相关数据了</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  haproxy</span><br><span class="line">-------------</span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/syslog.conf </span><br><span class="line">input &#123;</span><br><span class="line">   syslog &#123;</span><br><span class="line">      type =&gt; "system-rsyslog"</span><br><span class="line">      port =&gt; "5140"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">   stdout &#123;</span><br><span class="line">      codec =&gt; rubydebug</span><br><span class="line">   &#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      key =&gt; "haproxy-log-31"		# 改变输出到redis中的键名</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# systemctl restart logstash</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) "haproxy-log-31"</span><br><span class="line">2) "system-rsyslog"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到从logstash传入新的键了</span></span><br><span class="line"></span><br><span class="line">======================================================================================</span><br><span class="line">下面设置收集TCP/UDP日志</span><br><span class="line">======================================================================================</span><br><span class="line">-------------</span><br><span class="line">  haproxy</span><br><span class="line">-------------</span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class="line">input &#123;</span><br><span class="line">   tcp &#123;</span><br><span class="line">      port =&gt; "5500"</span><br><span class="line">      type =&gt; "tcp-syslog"</span><br><span class="line">      mode =&gt; "server"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">	stdout &#123;</span><br><span class="line">	  codec =&gt; rubydebug</span><br><span class="line">	&#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      key =&gt; "tcp-syslog"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf -t</span><br><span class="line">WARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class="line">[WARN ] 2019-01-25 13:16:45.820 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified</span><br><span class="line">Configuration OK</span><br><span class="line">[INFO ] 2019-01-25 13:16:47.307 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试配置文件没有问题</span></span><br><span class="line">[root@haproxy ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> logstash启动时还会监听本地的9600端口</span></span><br><span class="line">[root@haproxy ~]# yum install -y nc</span><br><span class="line">[root@haproxy ~]# echo "nc test"|nc 192.168.1.31 5500</span><br><span class="line">这时logstash会在终端输出内容：</span><br><span class="line">&#123;</span><br><span class="line">          "host" =&gt; "haproxy",</span><br><span class="line">       "message" =&gt; "nc test",</span><br><span class="line">          "port" =&gt; 39566,</span><br><span class="line">          "type" =&gt; "tcp-syslog",</span><br><span class="line">    "@timestamp" =&gt; 2019-01-25T05:29:16.034Z,</span><br><span class="line">      "@version" =&gt; "1"</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# nc 192.168.1.31 5500 &lt; /root/anaconda-ks.cfg</span><br><span class="line">[root@haproxy ~]# echo "伪设备" &gt; /dev/tcp/192.168.1.31/5500</span><br><span class="line"><span class="meta">#</span><span class="bash"> /dev后面的部分是没有的，要手动输入，在logstash中也会显示</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) "tcp-syslog"</span><br><span class="line">2) "haproxy-log-31"</span><br><span class="line">3) "system-rsyslog"</span><br><span class="line">127.0.0.1:6379&gt; LLEN tcp-syslog</span><br><span class="line">(integer) 52</span><br><span class="line"><span class="meta">#</span><span class="bash"> redis中也可以看到数据了</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  logstash</span><br><span class="line">-------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用nginx主机中的logstash收集redis中的数据</span></span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class="line">input &#123;</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "haproxy-log-31"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;  </span><br><span class="line">   </span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "tcp-syslog"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">   if [type] == "tcp-syslog" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "tcp-rsyslog-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">      &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">   </span><br><span class="line">   if [type] == "system-rsyslog" &#123;		# 这里判断的是haproxy服务器的logstash设置中input定义的type</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "haproxy-log-31-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">      &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 从redis中取行数据，之后输出到elasticsearch集群中。</span></span><br><span class="line">[root@nginx1 ~]# systemctl start logstash</span><br><span class="line">[root@nginx1 ~]# tail -f /var/log/logstash/logstash-plain.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以通过这个日志文件查看logstash运行是否正常，如是否可以连接到redis服务器</span></span><br><span class="line">访问els服务器：192.168.1.20:9200，这时可以看到haproxy-log-31-*这个索引了</span><br></pre></td></tr></table></figure>
<h4 id="filebeat收集日志"><a href="#filebeat收集日志" class="headerlink" title="filebeat收集日志"></a>filebeat收集日志</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line">======================================================================================</span><br><span class="line">* 规划</span><br><span class="line">1. 在web端安装filebeat进行对日志的收集，之后将日志发送给logstash。</span><br><span class="line">2. 配置一台logstash服务器，将收到的日志转发到redis</span><br><span class="line">3. 使用另一台logstash服务器从redis中读取日志，并将处理的结果写入到elasticsearch集群</span><br><span class="line">4. 配置地图显示IP访问地址</span><br><span class="line">5. 将日志写入数据库持久化保存</span><br><span class="line">6. 通过zabbix对elasticsearch集群状态及redis队列长度监控并实现邮件报警</span><br><span class="line"></span><br><span class="line">* 环境</span><br><span class="line">准备三台主机，做els集群，配置：双核处理器，2G内存。地址：192.168.1.20，192.168.1.21，192.168.1.22</span><br><span class="line">准备一台主机，安装nginx，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装kibana，地址：192.168.1.23</span><br><span class="line">准备一台主机，安装redis，地址：192.168.1.24</span><br><span class="line">准备一台主机，安装logstash负责将日志转发到redis，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装logstash负责从redis中读取数据并写入elasticsearch集群，地址：192.168.1.31。需要从redis中取出数据，所以再配置一台logstash服务器</span><br><span class="line">======================================================================================</span><br><span class="line"></span><br><span class="line">-------------------------------------</span><br><span class="line">  nginx+tomcat+logstash30</span><br><span class="line">-------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面配置nginx日志格式，filebeat获取nginx与系统日志并转发至本机的logstash</span></span><br><span class="line">[root@nginx1 ~]# mkdir /usr/local/nginx/html/web</span><br><span class="line">[root@nginx1 ~]# echo "Nginx WebPage" &gt; /usr/local/nginx/html/web/index.html</span><br><span class="line">访问http://192.168.1.30/web/</span><br><span class="line">[root@nginx1 ~]# vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    log_format access1 '&#123;"@timestamp":"$time_iso8601",'</span><br><span class="line">                         '"host":"$server_addr",'</span><br><span class="line">                         '"clientip":"$remote_addr",'</span><br><span class="line">                         '"size":$body_bytes_sent,'</span><br><span class="line">                         '"responsetime":$request_time,'</span><br><span class="line">                         '"upstreamtime":"$upstream_response_time",'</span><br><span class="line">                         '"upstreamhost":"$upstream_addr",'</span><br><span class="line">                         '"http_host":"$host",'</span><br><span class="line">                         '"url":"$uri",'</span><br><span class="line">                         '"domain":"$host",'</span><br><span class="line">                         '"xff":"$http_x_forwarded_for",'</span><br><span class="line">                         '"referer":"$http_referer",'</span><br><span class="line">                         '"status":"$status"&#125;';</span><br><span class="line">	server &#123;</span><br><span class="line">		...</span><br><span class="line">        access_log  logs/host.access.log  access1;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置日志格式为Json格式。相对普通日志格式,json易于识别,每个值都有与其相对于的key,易于提取日志内容及方便后续进一步对日志的分析。可以到http://www.kjson.com/上验证Json格式是否正确。</span></span><br><span class="line">[root@nginx1 ~]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line">[root@nginx1 ~]# /usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">[root@nginx1 ~]# yum install -y filebeat-6.5.4-x86_64.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装filebeat，这个软件可以在web端实时收集日志并传递给logstash进一步处理</span></span><br><span class="line">======================================================================================</span><br><span class="line">为什么不用logstash在web端收集</span><br><span class="line">1. 依赖java环境，一旦java出问题，可能影响到web服务</span><br><span class="line">2. 系统资源占用率高，且存在bug风险</span><br><span class="line">3. 配置比较复杂，支持匹配过滤</span><br><span class="line">4. filebeat挺好的，专注日志收集，语法简单，安装快捷，配置方便</span><br><span class="line">======================================================================================</span><br><span class="line">[root@nginx1 ~]# vim /etc/filebeat/filebeat.yml</span><br><span class="line"><span class="meta">#</span><span class="bash">filebeat.inputs:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">- <span class="built_in">type</span>: <span class="built_in">log</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  enabled: <span class="literal">false</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  paths:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    - /var/<span class="built_in">log</span>/*.<span class="built_in">log</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">output.elasticsearch:</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Array of hosts to connect to.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  hosts: [<span class="string">"localhost:9200"</span>]</span></span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/messages</span><br><span class="line">  include_lines: ["^ERR","^WARN"]		</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 如果加入此行，filebeat会只发送正则表达式匹配到的日志，其他都不发送。测试中未加此行。</span></span><br><span class="line">  fields:</span><br><span class="line">    service: system-log-30</span><br><span class="line"><span class="meta">#</span><span class="bash"> filebeat6中需要通过fields: service:这样的方式定义输出的类型，而5版本中的设置是使用  document_type: 定义类型。如果6版本中也按5版本的方法设置，在logstash中是找不到的。</span></span><br><span class="line">output.redis:</span><br><span class="line">  hosts: ["192.168.1.24:6379"]</span><br><span class="line">  key: "system-log-30"</span><br><span class="line">  db: 10</span><br><span class="line">  timeout: 5</span><br><span class="line">  password: "centos"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在配置文件最下方加入上面内容，另外需要注释配置文件中的inputs和其他output，不然启动会失败，不能有多个output段。启动失败时日志中会提示如<span class="string">"Exiting: prospectors and inputs used in the configuration file, define only inputs not both"</span></span></span><br><span class="line">[root@nginx1 ~]# tail -f /var/log/filebeat/filebeat</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看日志</span></span><br><span class="line"></span><br><span class="line">[root@nginx1 ~]# vim /etc/filebeat/filebeat.yml</span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/messages</span><br><span class="line">  fields:</span><br><span class="line">    service: system-log-30</span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /usr/local/nginx/logs/access.log</span><br><span class="line">  fields:</span><br><span class="line">    service: nginx-accesslog-30</span><br><span class="line">  </span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: ["192.168.1.30:5044","192.168.1.30:5045"]</span><br><span class="line">  enabled: true</span><br><span class="line">  worker: 1</span><br><span class="line">  compression_level: 3</span><br><span class="line">  loadbalance: true		# 默认为false，全部发送到随机选择的一个，相当于高可用模式</span><br><span class="line">[root@nginx1 filebeat]# systemctl restart filebeat </span><br><span class="line"></span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">    input &#123;				</span><br><span class="line">       beats &#123;		# 这个输入的名称是自定义的</span><br><span class="line">          port =&gt; 5044</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">       beats &#123;</span><br><span class="line">          port =&gt; 5045</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    output &#123;</span><br><span class="line">       stdout &#123;</span><br><span class="line">          codec =&gt; "rubydebug"</span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf</span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">    input &#123;				</span><br><span class="line">       beats &#123;		# 此输入插件使Logstash能够从Elastic Beats框架接收事件</span><br><span class="line">          port =&gt; 5044</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">       beats &#123;</span><br><span class="line">          port =&gt; 5045</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    output &#123;</span><br><span class="line">       if [fields][service] == "system-log-30" &#123;		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的[fields][service] 是在filebeat的input中定义的，这是logstash6版本中的使用方法。如果是5版本，需要使用<span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">""</span>来匹配数据类型</span></span><br><span class="line">          redis &#123;</span><br><span class="line">             data_type =&gt; "list"</span><br><span class="line">             host =&gt; "192.168.1.24"</span><br><span class="line">             port =&gt; "6379"</span><br><span class="line">             key =&gt; "system-log-30"</span><br><span class="line">             db =&gt; "15"</span><br><span class="line">             password =&gt; "centos"</span><br><span class="line">          &#125;  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 收集到的系统日志会因为JSON格式而报错，如<span class="string">"[ERROR] 2019-01-28 00:01:06.861 [defaultEventExecutorGroup-5-1] json - JSON parse error, original data now in message field &#123;:error=&gt;#&lt;LogStash::Json::ParserError: Unrecognized token 'Jan': was expecting ('true', 'false' or 'null')</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> at [Source: (String)<span class="string">"Jan 28 00:01:01 nginx1 systemd: Started Session 197 of user root."</span>; line: 1, column: 4]&gt;, :data=&gt;<span class="string">"Jan 28 00:01:01 nginx1 systemd: Started Session 197 of user root."</span>&#125;<span class="string">"，但数据还是会被写入到redis中。</span></span></span><br><span class="line">       &#125;  </span><br><span class="line">       if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">          redis &#123;</span><br><span class="line">             data_type =&gt; "list"</span><br><span class="line">             host =&gt; "192.168.1.24"</span><br><span class="line">             port =&gt; "6379"</span><br><span class="line">             key =&gt; "nginx-accesslog-30"</span><br><span class="line">             db =&gt; "15"</span><br><span class="line">             password =&gt; "centos"</span><br><span class="line">             codec =&gt; "json"</span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf -t</span><br><span class="line">[root@nginx1 ~]# systemctl start logstash</span><br><span class="line">[root@nginx1 ~]# lsof -i:5045                 </span><br><span class="line">COMMAND    PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">java     22018 logstash  111u  IPv6 265612      0t0  TCP *:osp (LISTEN)</span><br><span class="line">java     22018 logstash  140u  IPv6 265052      0t0  TCP nginx1:osp-&gt;nginx1:60146 (ESTABLISHED)</span><br><span class="line">filebeat 22162     root    5u  IPv4 265051      0t0  TCP nginx1:60146-&gt;nginx1:osp (ESTABLISHED)</span><br><span class="line"><span class="meta">#</span><span class="bash">  查看是否连接到5044端口</span></span><br><span class="line">[root@nginx1 ~]# netstat -alnp | grep filebeat</span><br><span class="line">tcp        0      0 192.168.1.30:60146      192.168.1.30:5045       ESTABLISHED 22162/filebea      </span><br><span class="line">tcp        0      0 192.168.1.30:44502      192.168.1.30:5044       ESTABLISHED 22162/filebea</span><br><span class="line"><span class="meta">#</span><span class="bash">  netstart查看端口</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis ~]# lsof -i:6379 -n    </span><br><span class="line">COMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">redis-ser 15196 root    6u  IPv4  32440      0t0  TCP *:6379 (LISTEN)</span><br><span class="line">redis-ser 15196 root   10u  IPv4 166066      0t0  TCP 192.168.1.24:6379-&gt;192.168.1.30:48894 (ESTABLISHED)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到192.168.1.30连到了这台redis上。</span></span><br><span class="line">[root@redis ~]# redis-cli -a centos</span><br><span class="line">127.0.0.1:6379&gt; SELECT 5</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[5]&gt; KEYS *</span><br><span class="line">1) "system-log-30"</span><br><span class="line">2) "nginx-accesslog-30"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到redis库中已经有数据了。</span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  logstash31</span><br><span class="line">-----------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面配置logstash从redis读取数据</span></span><br><span class="line">[root@haproxy ~]# cd /etc/logstash/conf.d/</span><br><span class="line">[root@haproxy conf.d]# vim redis-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "system-log-30"</span><br><span class="line">      db =&gt; "5"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "nginx-accesslog-30"</span><br><span class="line">      db =&gt; "5"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   codec =&gt; "json"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">   if [fields][service]== "system-log-30" &#123;</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 这里也要使用这样的判断方法，不能使用<span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">""</span>这样的方法</span></span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "system-log-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">         # 这里的%&#123;+yyyy.MM.dd&#125;年和日都要使用小写字母，不能使用大写字母，不然logstash会报错。</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "nginx-accesslog-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy conf.d]# systemctl start logstash</span><br><span class="line">访问http://192.168.1.20:9100/，这时可以看到有日志索引nginx-accesslog-30-****.**.**存在了。</span><br></pre></td></tr></table></figure>
<h5 id="kibana验证nginx访问日志"><a href="#kibana验证nginx访问日志" class="headerlink" title="kibana验证nginx访问日志"></a>kibana验证nginx访问日志</h5><blockquote>
<p>因为kibana是从本机的nginx反向代理的，所以访问的地址是test.kibana.com，访问时出现错误提示：重定向次数过多，需要清理cookie。重启kibana后正常。原因不明。</p>
</blockquote>
<blockquote>
<p>在kibana中创建nginx-accesslog-30-*索引后，就可以看到数据信息了</p>
</blockquote>
<p><img src="/images/kibana/查看2.png" alt=""></p>
<h5 id="部署tomcat"><a href="#部署tomcat" class="headerlink" title="部署tomcat"></a>部署tomcat</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------</span><br><span class="line">  nginx+tomcat+logstash30</span><br><span class="line">-------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面部署tomcat</span></span><br><span class="line">[root@nginx1 ~]# yum install -y tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br><span class="line">[root@nginx1 ~]# mkdir /usr/share/tomcat/webapps/tomcatweb</span><br><span class="line">[root@nginx1 ~]# vim /usr/share/tomcat/webapps/tomcatweb/index.html</span><br><span class="line">	Tomcat Web Page</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个测试页</span></span><br><span class="line">[root@nginx1 ~]# systemctl start tomcat</span><br><span class="line">访问http://192.168.1.30:8080/tomcatweb/</span><br><span class="line">[root@nginx1 ~]# systemctl stop tomcat</span><br><span class="line">[root@nginx1 ~]# vim /etc/tomcat/server.xml</span><br><span class="line">&lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="</span><br><span class="line">logs"</span><br><span class="line">               prefix="localhost_access_log." suffix=".txt"</span><br><span class="line">               pattern="&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;</span><br><span class="line">,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;method&amp;quot;</span><br><span class="line">:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query</span><br><span class="line">?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;AgentVersion&amp;quot;:</span><br><span class="line">&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要注意tomcat日志的json格式，使用两个&amp;quot;将字段和变量分隔，标点符号不需要使用</span></span><br><span class="line">[root@nginx1 ~]# rm -rf /var/log/tomcat/*</span><br><span class="line">[root@nginx1 ~]# systemctl start tomcat</span><br><span class="line">[root@nginx1 ~]# tail /var/log/tomcat/localhost_access_log.2019-01-28.txt</span><br><span class="line">&#123;"clientip":"192.168.1.9","ClientUser":"-","authenticated":"-","AccessTime":"[28/Jan/2019:09:58:44 +0800]","method":"GET /tomcatweb/ HTTP/1.1","status":"304","SendBytes":"-","Query?string":"","partner":"-","AgentVersion":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36"&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证tomcat日志转json</span></span><br><span class="line">[root@nginx1 ~]# vim /etc/filebeat/filebeat.yml</span><br><span class="line">    - input_type: log</span><br><span class="line">      paths:</span><br><span class="line">        - /var/log/tomcat/localhost_access_log.*</span><br><span class="line">      fields:</span><br><span class="line">        service: tomcat-accesslog-30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入对tomcat日志的收集</span></span><br><span class="line">[root@nginx1 ~]# systemctl restart filebeat.service</span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">output &#123;</span><br><span class="line">    ...</span><br><span class="line">    if [fields][service] == "tomcat-accesslog-30" &#123;</span><br><span class="line">      redis &#123;</span><br><span class="line">         data_type =&gt; "list"</span><br><span class="line">         host =&gt; "192.168.1.24"</span><br><span class="line">         port =&gt; "6379"</span><br><span class="line">         key =&gt; "tomcat-accesslog-30"</span><br><span class="line">         db =&gt; "5"</span><br><span class="line">         password =&gt; "centos"</span><br><span class="line">         codec =&gt; "json"</span><br><span class="line">      &#125;  </span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br><span class="line">[root@nginx1 ~]# systemctl restart logstash</span><br><span class="line">[root@nginx1 ~]# yum install -y httpd-tools</span><br><span class="line">[root@nginx1 ~]# ab -n1000 -c10 http://192.168.1.30:8080/tomcatweb/</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis ~]# redis-cli -a centos</span><br><span class="line">127.0.0.1:6379&gt; SELECT 5</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[5]&gt; KEYS *</span><br><span class="line">1) "tomcat-accesslog-30"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到redis中已经有数据了</span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  logstash31</span><br><span class="line">-----------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面配置logstash从redis读取tomcat的数据</span></span><br><span class="line">[root@haproxy conf.d]# vim redis-es.conf       </span><br><span class="line">input &#123;</span><br><span class="line">...</span><br><span class="line">redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "tomcat-accesslog-30"</span><br><span class="line">      db =&gt; "5"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   codec =&gt; "json"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">...</span><br><span class="line">if [fields][service] == "tomcat-accesslog-30" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "tomcat-accesslog-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy conf.d]# systemctl restart logstash</span><br><span class="line">最后加入到kibana中</span><br><span class="line"></span><br><span class="line">--------------------</span><br><span class="line">  elasticsearch</span><br><span class="line">--------------------</span><br><span class="line">[root@els3 ~]# du -sh /elkdata/data/nodes/0/indices/</span><br><span class="line">97M     /elkdata/data/nodes/0/indices/</span><br><span class="line">[root@els3 ~]# du -sh /elkdata/data/nodes/0/indices/*</span><br><span class="line">4.0K    /elkdata/data/nodes/0/indices/--3-U6GWTSifioos1N2yUQ</span><br><span class="line">91M     /elkdata/data/nodes/0/indices/6MycbQuEQWmCbg3-A1q5EA</span><br><span class="line">120K    /elkdata/data/nodes/0/indices/HGUqPJuCQ1iTPJr1EVfxoQ</span><br><span class="line">2.0M    /elkdata/data/nodes/0/indices/KuBtJ9ztSDaI7dFaiNfeFQ</span><br><span class="line">2.9M    /elkdata/data/nodes/0/indices/QbkLT5G7RYu5nivgm2uncA</span><br><span class="line">1.5M    /elkdata/data/nodes/0/indices/_yuF7skcTtWOF4YJl_UaTw</span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证filebeat读取的日志，已经通过logstash写入到elasticsearch的数据目录中</span></span><br></pre></td></tr></table></figure>
<h3 id="kibana配置地图显示IP访问地址"><a href="#kibana配置地图显示IP访问地址" class="headerlink" title="kibana配置地图显示IP访问地址"></a>kibana配置地图显示IP访问地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">-----------------</span><br><span class="line">  logstash31</span><br><span class="line">-----------------</span><br><span class="line">[root@kibana ~]# wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在写入elasticsearch的logstash服务器配置</span></span><br><span class="line">[root@haproxy ~]# gunzip GeoLite2-City.tar.gz</span><br><span class="line">[root@haproxy ~]# tar xf GeoLite2-City.tar</span><br><span class="line">[root@haproxy ~]# cd GeoLite2-City_20190122/</span><br><span class="line">[root@haproxy GeoLite2-City_20190122]# cp GeoLite2-City.mmdb /etc/logstash/ -a</span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/redis-es.conf</span><br><span class="line">input &#123;&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">   filter &#123;</span><br><span class="line">   if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">   geoip &#123;</span><br><span class="line">        source =&gt; "clientip"</span><br><span class="line">        target =&gt; "geoip"</span><br><span class="line">        database =&gt; "/etc/logstash/GeoLite2-City.mmdb"</span><br><span class="line">        add_field =&gt; ["[geoip][coordinates]","%&#123;[geoip][longitude]&#125;"]</span><br><span class="line">        add_field =&gt; ["[geoip][coordinates]","%&#123;[geoip][latitude]&#125;"]</span><br><span class="line">   &#125;</span><br><span class="line">   mutate &#123;</span><br><span class="line">        convert =&gt; ["[geoip][coordinates]","float"]</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    ...</span><br><span class="line">    if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "logstash-nginx-accesslog-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里输出到els中的index名称必须以logstash开头，不然在kibana中创建地图选择Field时会有错误提示<span class="string">"No Compatible Fields: The "</span>nginx-accesslog-30-*<span class="string">" index pattern does not contain any of the following field types: geo_point"</span></span></span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# systemctl restart logstash</span><br></pre></td></tr></table></figure>
<h4 id="kibana创建地图"><a href="#kibana创建地图" class="headerlink" title="kibana创建地图"></a>kibana创建地图</h4><blockquote>
<p>删除旧的索引，重新创建新索引</p>
</blockquote>
<p><img src="/images/kibana/地图1.png" alt=""></p>
<blockquote>
<p>查看字段，会有以geoip开头的字段加入</p>
</blockquote>
<p><img src="/images/kibana/地图2.png" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------</span><br><span class="line">  nginx+tomcat+logstash30</span><br><span class="line">-------------------------------------</span><br><span class="line">[root@nginx1 ~]# echo '&#123;"@timestamp":"2019-01-27T19:27:57+08:00","host":"192.168.1.30","clientip":"106.38.38.83","size":0,"responsetime":0.000,"upstreamtime":"-","upstreamhost":"-","http_host":"192.168.1.30","url":"/index.html","domain":"192.168.1.30","xff":"-","referer":"-","status":"304"&#125;' &gt;&gt; /usr/local/nginx/logs/host.access.log.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入一条假数据到日志文件中，clientip改为公网地址</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>创建地图，选择logstash-nginx-accesslog-30-*</p>
</blockquote>
<p><img src="/images/kibana/地图3.png" alt=""></p>
<blockquote>
<p>在Buckets中的Aggregation选择Geohash，Field选择geoip.location，最后点击上方的三角按钮，这时就可以在地图上看到标记了</p>
</blockquote>
<p><img src="/images/kibana/地图4.png" alt=""></p>
<h3 id="将日志写入数据库"><a href="#将日志写入数据库" class="headerlink" title="将日志写入数据库"></a>将日志写入数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">=======================================================================================</span><br><span class="line">规划</span><br><span class="line">1. 安装数据库并授权</span><br><span class="line">2. 创建表</span><br><span class="line">3. 配置logstash将数据写入数据库</span><br><span class="line">4. 测试</span><br><span class="line"></span><br><span class="line">环境</span><br><span class="line">准备一台主机，安装mariadb，地址：192.168.1.25</span><br><span class="line">logstash地址：192.168.1.30</span><br><span class="line">=======================================================================================</span><br><span class="line">--------------</span><br><span class="line">  mariadb</span><br><span class="line">--------------</span><br><span class="line">[root@mysql ~]# yum install -y mariadb-server</span><br><span class="line">[root@mysql ~]# systemctl start mariadb</span><br><span class="line">[root@mysql ~]# mysql_secure_installation</span><br><span class="line">[root@mysql ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE elk CHARACTER SET utf8 COLLATE utf8_bin;</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL privileges ON elk.* TO elk@"%" identified by "centos";</span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据库并授权</span></span><br><span class="line">[root@els3 ~]# mysql -h192.168.1.25 -uelk -pcentos</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在其他主机验证远程登录数据库</span></span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  logstash</span><br><span class="line">--------------</span><br><span class="line">[root@nginx1 ~]# yum install -y ruby</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要安装ruby后才可以使用gem命令</span></span><br><span class="line">[root@nginx1 ~]# gem sources --add http://gems.ruby-china.com --remove https://rubygems.org/</span><br><span class="line"><span class="meta">#</span><span class="bash"> Gem是一个管理Ruby库和程序的标准包，它通过Ruby Gem（如 http://rubygems.org/ ）源来查找、安装、升级和卸载软件包，非常的便捷。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> taobao Gems 源已停止维护，现由 ruby-china 提供镜像服务，所以将国内源改为http://gems.ruby-china.com</span></span><br><span class="line">[root@nginx1 ~]# mkdir -pv /usr/share/logstash/vendor/jar/jdbc</span><br><span class="line">[root@nginx1 ~]# unzip mysql-connector-java-8.0.14.zip</span><br><span class="line">[root@nginx1 ~]# cp mysql-connector-java-8.0.14/mysql-connector-java-8.0.14.jar /usr/share/logstash/vendor/jar/jdbc/</span><br><span class="line">[root@nginx1 ~]# chown -R logstash.logstash /usr/share/logstash/vendor/jar/</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash-plugin install logstash-output-jdbc</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash-plugin list|grep jdbc</span><br><span class="line">logstash-filter-jdbc_static</span><br><span class="line">logstash-filter-jdbc_streaming</span><br><span class="line">logstash-input-jdbc</span><br><span class="line">logstash-output-jdb</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  mariadb</span><br><span class="line">--------------</span><br><span class="line">[root@mysql ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; use elk</span><br><span class="line">MariaDB [elk]&gt; CREATE TABLE elklog (id int(11) NOT NULL AUTO_INCREMENT,host VARCHAR(255),clientip VARCHAR(255),url VARCHAR(255),status INT(16),time timestamp,PRIMARY KEY (id));</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  logstash</span><br><span class="line">--------------</span><br><span class="line">[root@nginx1 filebeat]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">      redis &#123;</span><br><span class="line">         data_type =&gt; "list"</span><br><span class="line">         host =&gt; "192.168.1.24"</span><br><span class="line">         port =&gt; "6379"</span><br><span class="line">         key =&gt; "nginx-accesslog-30"</span><br><span class="line">         db =&gt; "5"</span><br><span class="line">         password =&gt; "centos"</span><br><span class="line">         codec =&gt; "json"</span><br><span class="line">      &#125;</span><br><span class="line">      jdbc &#123;</span><br><span class="line">         driver_jar_path =&gt; "/usr/share/logstash/vendor/jar/jdbc/mysql-connector-java-8.0.14.jar"</span><br><span class="line">         # 插件路径 </span><br><span class="line">         connection_string =&gt; "jdbc:mysql://192.168.1.25:3306/elk?user=elk&amp;password=centos&amp;useUnic</span><br><span class="line">ode=true&amp;characterEncoding=UTF8"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据库地址、端口、用户名、密码等信息</span></span><br><span class="line">         statement =&gt; ["INSERT INTO elklog(host,clientip,url,status) VALUES(?,?,?,?)","http_host","clientip","url","status"]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最后四个引号(<span class="string">"http_host"</span>,<span class="string">"clientip"</span>,<span class="string">"url"</span>,<span class="string">"status"</span>)中的名称是从logstash中取得的字段名称，这四个引号是传入的变量</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置输出到数据库中</span></span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  mariadb</span><br><span class="line">--------------</span><br><span class="line">[root@mysql ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; use elk</span><br><span class="line">MariaDB [elk]&gt; select * from elklog;</span><br><span class="line">| 6000 | &#123;"containerized":true,"id":"3e6f1f53c66e409f81bc71d9331832af","architecture":"x86_64","os":&#123;"codename":"Core","family":"redhat","platform":"centos","version":"7 (Core)"&#125;,"name":"nginx1"&#125; | 192.168.1.30 | /test/index.html |   NULL | 2019-01-28 21:28:35 |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里保存的host有问题，需要将logstash中的statement最后的引号中的host改为http_host即可取得服务器地址了</span></span><br></pre></td></tr></table></figure>
<h3 id="删除els中索引的脚本"><a href="#删除els中索引的脚本" class="headerlink" title="删除els中索引的脚本"></a>删除els中索引的脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">DATE=`date -d "0 days ago" +%Y.%m.%d`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取今天的日期，如果想获取一个月前的日期，就使用30 days ago</span></span><br><span class="line">LOG_NAME="nginx-accesslog-30"</span><br><span class="line">FILE_NAME=$LOG_NAME-$DATE</span><br><span class="line">curl -XDELETE http://192.168.1.20:9200/$FILE_NAME</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">   echo "$&#123;FILE_NAME&#125; delete success."</span><br><span class="line">else</span><br><span class="line">   echo "$&#123;FILE_NAME&#125; delete error."</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不可直接从/elkdata/data/nodes/0/indices/目录中删除索引，会使els服务器运行出错</span></span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/日志收集/" rel="tag"># 日志收集</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/21/zookeeper-kafka部署/" rel="next" title="zookeeper&kafka部署">
                <i class="fa fa-chevron-left"></i> zookeeper&kafka部署
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/28/LVS部署/" rel="prev" title="LVS部署">
                LVS部署 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概要
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">201</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">152</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#elk概念"><span class="nav-number">1.</span> <span class="nav-text">elk概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#elasticsearch概念"><span class="nav-number">1.1.</span> <span class="nav-text">elasticsearch概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#logstash概念"><span class="nav-number">1.2.</span> <span class="nav-text">logstash概念</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#logstash格式"><span class="nav-number">1.2.1.</span> <span class="nav-text">logstash格式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kibana概念"><span class="nav-number">1.3.</span> <span class="nav-text">kibana概念</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#elk部署"><span class="nav-number">2.</span> <span class="nav-text">elk部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#elk简单部署"><span class="nav-number">2.1.</span> <span class="nav-text">elk简单部署</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#kibana简单设置使用"><span class="nav-number">2.1.1.</span> <span class="nav-text">kibana简单设置使用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#访问"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">访问</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#设置"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">设置</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#nginx登录认证"><span class="nav-number">2.1.2.</span> <span class="nav-text">nginx登录认证</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#日志收集"><span class="nav-number">2.2.</span> <span class="nav-text">日志收集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filebeat收集日志"><span class="nav-number">2.3.</span> <span class="nav-text">filebeat收集日志</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#kibana验证nginx访问日志"><span class="nav-number">2.3.1.</span> <span class="nav-text">kibana验证nginx访问日志</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#部署tomcat"><span class="nav-number">2.3.2.</span> <span class="nav-text">部署tomcat</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kibana配置地图显示IP访问地址"><span class="nav-number">3.</span> <span class="nav-text">kibana配置地图显示IP访问地址</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#kibana创建地图"><span class="nav-number">3.1.</span> <span class="nav-text">kibana创建地图</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将日志写入数据库"><span class="nav-number">4.</span> <span class="nav-text">将日志写入数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除els中索引的脚本"><span class="nav-number">5.</span> <span class="nav-text">删除els中索引的脚本</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
