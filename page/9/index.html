<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/9/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/9/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/09/git使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/09/git使用/" itemprop="url">
                  git使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-12-09 12:26:54" itemprop="dateCreated datePublished" datetime="2018-12-09T12:26:54+08:00">2018-12-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-22 12:59:53" itemprop="dateModified" datetime="2019-01-22T12:59:53+08:00">2019-01-22</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="git管理"><a href="#git管理" class="headerlink" title="git管理"></a>git管理</h3><h4 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install -y git</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">git config --global user.name "Your Name"</span><br><span class="line">git config --global user.email "email@example.com"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每个机器都必须自报家门：你的名字和Email地址。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> git config命令的--global参数，用了这个参数，表示你这台机器上所有的Git仓库都会使用这个配置，也可以对某个仓库指定不同的用户名和Email地址。</span></span><br></pre></td></tr></table></figure>
<h4 id="添加文件并提交"><a href="#添加文件并提交" class="headerlink" title="添加文件并提交"></a>添加文件并提交</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mkdir learngit</span><br><span class="line">cd learngit</span><br><span class="line">git init</span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化</span></span><br><span class="line">	Initialized empty Git repository in /root/learngit/.git/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 所有的版本控制系统，只能跟踪文本文件的改动</span></span><br><span class="line">vim readme.txt</span><br><span class="line">        git is a version control system.</span><br><span class="line">        git is free software</span><br><span class="line">git add .</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加当前目录中的所有文件，也可以只提交某个文件，如：git add readme.txt。可以添加多次文件，最后一并提交。</span></span><br><span class="line">git commit -m "wrote a readme file"</span><br><span class="line">        [master (root-commit) 8f5d632] wrote a readme file</span><br><span class="line">         1 file changed, 2 insertions(+)</span><br><span class="line">         create mode 100644 readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交，-m后面输入的是本次提交的说明，最好将说明写清楚，方便之后查看。1 file changed：1个文件被改动（我们新添加的readme.txt文件）；2 insertions(+)：插入了两行内容（readme.txt有两行内容）</span></span><br></pre></td></tr></table></figure>
<h4 id="修改提交"><a href="#修改提交" class="headerlink" title="修改提交"></a>修改提交</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vim readme.txt</span><br><span class="line">        git is a distributed version control system.                                                                                                                     </span><br><span class="line">        git is free software</span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        # Changes not staged for commit:</span><br><span class="line">        #   (use "git add &lt;file&gt;..." to update what will be committed)</span><br><span class="line">        #   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span><br><span class="line">        #</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line">        #</span><br><span class="line">        no changes added to commit (use "git add" and/or "git commit -a")</span><br><span class="line"><span class="meta">#</span><span class="bash"> git status命令可以让我们时刻掌握仓库当前的状态，上面的命令输出告诉我们，readme.txt被修改过了，但还没有提交修改。	</span></span><br><span class="line">git diff readme.txt </span><br><span class="line">        diff --git a/readme.txt b/readme.txt</span><br><span class="line">        index 488642a..1d72fa6 100644</span><br><span class="line">        --- a/readme.txt</span><br><span class="line">        +++ b/readme.txt</span><br><span class="line">        @@ -1,2 +1,2 @@</span><br><span class="line">        -git is a version control system.</span><br><span class="line">        +git is a distributed version control system.</span><br><span class="line">         git is free software</span><br><span class="line"><span class="meta">#</span><span class="bash"> git diff顾名思义就是查看difference，显示的格式正是Unix通用的diff格式，可以从上面的命令输出看到，我们在第一行添加了一个distributed单词（倒数第二行）。</span></span><br><span class="line">git add readme.txt </span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        # Changes to be committed:</span><br><span class="line">        #   (use "git reset HEAD &lt;file&gt;..." to unstage)</span><br><span class="line">        #</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> git status告诉我们，将要被提交的修改包括readme.txt，下一步，就可以放心地提交了</span></span><br><span class="line">git commit -m "add distributed"</span><br><span class="line">        [master 5e363b3] add distributed</span><br><span class="line">         1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        nothing to commit, working directory clean</span><br><span class="line"><span class="meta">#</span><span class="bash"> Git告诉我们当前没有需要提交的修改，而且，工作目录是干净（working tree clean）的。</span></span><br></pre></td></tr></table></figure>
<h4 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">vim readme.txt</span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">git add readme.txt </span><br><span class="line">git commit -m "append GPL"</span><br><span class="line">        [master 9976125] append GPL</span><br><span class="line">         1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 像这样，你不断对文件进行修改，然后不断提交修改到版本库里，就好比玩RPG游戏时，每通过一关就会自动把游戏状态存盘，如果某一关没过去，你还可以选择读取前一关的状态。有些时候，在打Boss之前，你会手动存盘，以便万一打Boss失败了，可以从最近的地方重新开始。Git也是一样，每当你觉得文件修改到一定程度的时候，就可以“保存一个快照”，这个快照在Git中被称为commit。一旦你把文件改乱了，或者误删了文件，还可以从最近的一个commit恢复，然后继续工作，而不是把几个月的工作成果全部丢失。</span></span><br><span class="line">git log</span><br><span class="line">        commit 997612519811f1809317db4f6016fe785e9960cf</span><br><span class="line">        Author: ruopu89 &lt;ruopu1989@hotmail.com&gt;</span><br><span class="line">        Date:   Sun Dec 9 13:01:59 2018 +0800</span><br><span class="line"></span><br><span class="line">            append GPL</span><br><span class="line"></span><br><span class="line">        commit 5e363b39f5a22a8acf7fed8bb0de91952e93d947</span><br><span class="line">        Author: ruopu89 &lt;ruopu1989@hotmail.com&gt;</span><br><span class="line">        Date:   Sun Dec 9 12:57:05 2018 +0800</span><br><span class="line"></span><br><span class="line">            add distributed</span><br><span class="line"></span><br><span class="line">        commit 8f5d632912474ae28b5fdeb989e28cabc35b815b</span><br><span class="line">        Author: ruopu89 &lt;ruopu1989@hotmail.com&gt;</span><br><span class="line">        Date:   Sun Dec 9 12:45:26 2018 +0800</span><br><span class="line"></span><br><span class="line">            wrote a readme file</span><br><span class="line"><span class="meta"> #</span><span class="bash"> git <span class="built_in">log</span>命令显示从最近到最远的提交日志，我们可以看到3次提交，最近的一次是append GPL，上一次是add distributed，最早的一次是wrote a readme file。</span></span><br><span class="line"> git log --pretty=oneline</span><br><span class="line">        997612519811f1809317db4f6016fe785e9960cf append GPL</span><br><span class="line">        5e363b39f5a22a8acf7fed8bb0de91952e93d947 add distributed</span><br><span class="line">        8f5d632912474ae28b5fdeb989e28cabc35b815b wrote a readme file</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果嫌输出信息太多，可以试试加上--pretty=oneline参数。9976125...是commit id（版本号）。</span></span><br><span class="line">git reset --hard HEAD^</span><br><span class="line">		HEAD is now at 5e363b3 add distributed</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在Git中，用HEAD表示当前版本，也就是最新的提交9976125...，上一个版本就是HEAD^，上上一个版本就是HEAD^^，当然往上100个版本写100个^比较容易数不过来，所以写成HEAD~100。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用git reset命令回退到上一个版本</span></span><br><span class="line">cat readme.txt </span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software</span><br><span class="line"><span class="meta">#</span><span class="bash"> 回退到了add distributed时的版本</span></span><br><span class="line">git log</span><br><span class="line">        commit 5e363b39f5a22a8acf7fed8bb0de91952e93d947</span><br><span class="line">        Author: ruopu89 &lt;ruopu1989@hotmail.com&gt;</span><br><span class="line">        Date:   Sun Dec 9 12:57:05 2018 +0800</span><br><span class="line"></span><br><span class="line">            add distributed</span><br><span class="line"></span><br><span class="line">        commit 8f5d632912474ae28b5fdeb989e28cabc35b815b</span><br><span class="line">        Author: ruopu89 &lt;ruopu1989@hotmail.com&gt;</span><br><span class="line">        Date:   Sun Dec 9 12:45:26 2018 +0800</span><br><span class="line"></span><br><span class="line">            wrote a readme file</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最新的那个版本append GPL已经看不到了，如果想回到这个未来的版本，需要知道这个版本的版本号，也就是commit id，在命令行向上找</span></span><br><span class="line">git reset --hard 9976125</span><br><span class="line">		HEAD is now at 8f5d632 wrote a readme file</span><br><span class="line"><span class="meta">#</span><span class="bash"> 回到append GPL的版本</span></span><br><span class="line">cat readme.txt </span><br><span class="line">		git is a distributed version control system.</span><br><span class="line">		git is free software distributed under the GPL.</span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash"> Git的版本回退速度非常快，因为Git在内部有个指向当前版本的HEAD指针，当你回退版本的时候，Git仅仅是把HEAD从指向append GPL改为指向add distributed。然后顺便把工作区的文件更新了。所以你让HEAD指向哪个版本号，你就把当前版本定位在哪。</span></span><br><span class="line">===========================================================================================</span><br><span class="line">git reflog</span><br><span class="line">        9976125 HEAD@&#123;0&#125;: reset: moving to 9976125</span><br><span class="line">        8f5d632 HEAD@&#123;1&#125;: reset: moving to 8f5d63291</span><br><span class="line">        5e363b3 HEAD@&#123;2&#125;: reset: moving to HEAD^</span><br><span class="line">        9976125 HEAD@&#123;3&#125;: commit: append GPL</span><br><span class="line">        5e363b3 HEAD@&#123;4&#125;: commit: add distributed</span><br><span class="line">        8f5d632 HEAD@&#123;5&#125;: commit (initial): wrote a readme file</span><br><span class="line"><span class="meta">#</span><span class="bash"> git reflog用来记录你的每一次提交与回退。可以看到提交append GPL的版本号是9976125，这样就算不知道版本号，也可以这样查找了。当你 (在一个仓库下) 工作时，Git 会在你每次修改了 HEAD 时悄悄地将改动记录下来。当你提交或修改分支时，reflog 就会更新。git update-ref 命令也可以更新 reflog，任何时间运行 git reflog 命令可以查看当前的状态。运行 git <span class="built_in">log</span> -g 会输出 reflog 的正常日志，从而显示更多有用信息</span></span><br></pre></td></tr></table></figure>
<h4 id="工作区与暂存区"><a href="#工作区与暂存区" class="headerlink" title="工作区与暂存区"></a>工作区与暂存区</h4><p><img src="/images/git/版本库.png" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">===========================================================================================</span><br><span class="line">工作区（Working Directory）：就是你在电脑里能看到的目录，比如我的learngit目录就是一个工作区</span><br><span class="line">版本库（Repository）：工作区有一个隐藏目录.git，这个不算工作区，而是Git的版本库。Git的版本库里存了很多东西，其中最重要的就是称为stage（或者叫index）的暂存区，还有Git为我们自动创建的第一个分支master，以及指向master的一个指针叫HEAD。</span><br><span class="line">把文件往Git版本库里添加的时候，是分两步执行的：</span><br><span class="line">第一步是用git add把文件添加进去，实际上就是把文件修改添加到暂存区；</span><br><span class="line">第二步是用git commit提交更改，实际上就是把暂存区的所有内容提交到当前分支。</span><br><span class="line">因为我们创建Git版本库时，Git自动为我们创建了唯一一个master分支，所以，现在，git commit就是往master分支上提交更改。你可以简单理解为，需要提交的文件修改通通放到暂存区，然后，一次性提交暂存区的所有修改。</span><br><span class="line">===========================================================================================</span><br><span class="line">vim readme.txt</span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改内容，加一行</span></span><br><span class="line">vim LICENSE </span><br><span class="line">		add LICENSE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在工作区再新增一个文件叫LICENSE</span></span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        # Changes not staged for commit:</span><br><span class="line">        #   (use "git add &lt;file&gt;..." to update what will be committed)</span><br><span class="line">        #   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span><br><span class="line">        #</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line">        #</span><br><span class="line">        # Untracked files:</span><br><span class="line">        #   (use "git add &lt;file&gt;..." to include in what will be committed)</span><br><span class="line">        #</span><br><span class="line">        #       LICENSE</span><br><span class="line">        no changes added to commit (use "git add" and/or "git commit -a")</span><br><span class="line"><span class="meta">#</span><span class="bash"> Git非常清楚地告诉我们，readme.txt被修改了，而LICENSE还从来没有被添加过，所以它的状态是Untracked(未跟踪的)。</span></span><br><span class="line">git add .</span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        # Changes to be committed:</span><br><span class="line">        #   (use "git reset HEAD &lt;file&gt;..." to unstage)</span><br><span class="line">        #</span><br><span class="line">        #       new file:   LICENSE</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加两个文件后，查看状态，两个文件被放入了暂存区。git add命令实际上就是把要提交的所有修改放到暂存区（Stage），然后，执行git commit就可以一次性把暂存区的所有修改提交到分支</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/git/版本库1.png" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git commit -m "understand how stage works"</span><br><span class="line">        [master f21dbee] understand how stage works</span><br><span class="line">         2 files changed, 2 insertions(+)</span><br><span class="line">         create mode 100644 LICENSE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交</span></span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        nothing to commit, working directory clean</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将暂存区的文件提交到主分支，如果你又没有对工作区做任何修改，那么工作区就是“干净”的</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 工作区目录中包含版本库，版本库中包括暂存区与分支。在工作区中修改的内容会被添加到暂存区，提交是将暂存区中的内容提交到分支</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/git/版本库2.png" alt=""></p>
<h4 id="管理修改"><a href="#管理修改" class="headerlink" title="管理修改"></a>管理修改</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">vim readme.txt</span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line">        git tracks changes.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改，加一行</span></span><br><span class="line">git add readme.txt </span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        # Changes to be committed:</span><br><span class="line">        #   (use "git reset HEAD &lt;file&gt;..." to unstage)</span><br><span class="line">        #</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加并查看状态</span></span><br><span class="line">vim readme.txt</span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line">        git tracks changes of files.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次修改</span></span><br><span class="line">git commit -m "git tracks changes"</span><br><span class="line">        [master 27975c9] git tracks changes</span><br><span class="line">         1 file changed, 1 insertion(+)ed, 1 insertion(+)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交</span></span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        # Changes not staged for commit:</span><br><span class="line">        #   (use "git add &lt;file&gt;..." to update what will be committed)</span><br><span class="line">        #   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span><br><span class="line">        #</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line">        #</span><br><span class="line">        no changes added to commit (use "git add" and/or "git commit -a")</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第二次修改没有被提交。因为第二次修改没有添加到暂存区，也就是没有使用git add 命令</span></span><br><span class="line">git diff HEAD -- readme.txt </span><br><span class="line">        diff --git a/readme.txt b/readme.txt</span><br><span class="line">        index 6c29947..b7b0032 100644</span><br><span class="line">        --- a/readme.txt</span><br><span class="line">        +++ b/readme.txt</span><br><span class="line">        @@ -1,4 +1,4 @@</span><br><span class="line">         git is a distributed version control system.</span><br><span class="line">         git is free software distributed under the GPL.</span><br><span class="line">         git has a mutable index called stage.</span><br><span class="line">        -git tracks changes.</span><br><span class="line">        +git tracks changes of files.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看工作区和版本库里面最新版本的区别，-git tracks changes.是现在版本库中的内容， +git tracks changes of files.是工作区中的内容。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一次修改 -&gt; git add -&gt; 第二次修改 -&gt; git add -&gt; git commit</span></span><br><span class="line">git add readme.txt </span><br><span class="line">git commit -m "add of files."     </span><br><span class="line">        [master e49d070] add of files.</span><br><span class="line">         1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        nothing to commit, working directory clean</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加并提交第二次修改</span></span><br></pre></td></tr></table></figure>
<h4 id="撤销修改"><a href="#撤销修改" class="headerlink" title="撤销修改"></a>撤销修改</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">1. 修改了内容，但未放入暂存区</span><br><span class="line">vim readme.txt </span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line">        git tracks changes of files.</span><br><span class="line">        My stupid boss still prefers SVN.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改添加一行内容</span></span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        # Changes not staged for commit:</span><br><span class="line">        #   (use "git add &lt;file&gt;..." to update what will be committed)</span><br><span class="line">        #   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span><br><span class="line">        #</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line">        #</span><br><span class="line">        no changes added to commit (use "git add" and/or "git commit -a")</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看状态，提示git checkout -- file可以丢弃工作区的修改</span></span><br><span class="line">git checkout -- readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 丢弃工作区的修改。git checkout -- file命令中的--很重要，没有--，就变成了“切换到另一个分支”的命令</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令git checkout -- readme.txt意思就是，把readme.txt文件在工作区的修改全部撤销，这里有两种情况：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一种是readme.txt自修改后还没有被放到暂存区，现在，撤销修改就回到和版本库一模一样的状态；上面就是这种情况</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一种是readme.txt已经添加到暂存区后，又作了修改，现在，撤销修改就回到添加到暂存区后的状态。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 总之，就是让这个文件回到最近一次git commit或git add时的状态。</span></span><br><span class="line">cat readme.txt </span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line">        git tracks changes of files.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 又恢复到修改前的状态</span></span><br><span class="line"></span><br><span class="line">2. 修改内容并放入了暂存区</span><br><span class="line">vim readme.txt </span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line">        git tracks changes of files.</span><br><span class="line">        My stupid boss still prefers SVN.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改添加一行内容</span></span><br><span class="line">git add readme.txt </span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        # Changes to be committed:</span><br><span class="line">        #   (use "git reset HEAD &lt;file&gt;..." to unstage)</span><br><span class="line">        #</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内容只是被添加到了暂存区，还没有提交，提示使用<span class="string">"git reset HEAD &lt;file&gt;..."</span>可以把暂存区的修改撤销掉（unstage）</span></span><br><span class="line">git reset HEAD readme.txt </span><br><span class="line">        Unstaged changes after reset:</span><br><span class="line">        M       readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> git reset命令既可以回退版本，也可以把暂存区的修改回退到工作区。当我们用HEAD时，表示最新的版本。</span></span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        # Changes not staged for commit:</span><br><span class="line">        #   (use "git add &lt;file&gt;..." to update what will be committed)</span><br><span class="line">        #   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span><br><span class="line">        #</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line">        #</span><br><span class="line">        no changes added to commit (use "git add" and/or "git commit -a")</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到，这里将修改放回了工作区</span></span><br><span class="line">git checkout -- readme.txt </span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        nothing to commit, working directory clean</span><br><span class="line">cat readme.txt </span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line">        git tracks changes of files.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将工作区的内容撤销了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交到暂存区后，如果想撤销，就需要两步，先回退到工作区，再将工作区的修改撤销。如果只是在工作区修改了，那么只要撤销工作区的修改即可。</span></span><br><span class="line"></span><br><span class="line">==============================================================================================</span><br><span class="line">场景1：当你改乱了工作区某个文件的内容，想直接丢弃工作区的修改时，用命令git checkout -- file。</span><br><span class="line">场景2：当你不但改乱了工作区某个文件的内容，还添加到了暂存区时，想丢弃修改，分两步，第一步用命令git reset HEAD &lt;file&gt;，就回到了场景1，第二步按场景1操作。</span><br><span class="line">场景3：已经提交了不合适的修改到版本库时，想要撤销本次提交，使用命令"git reset --hard HEAD^ commit id"回退到上个版本或指定版本号，不过前提是没有推送到远程库。</span><br><span class="line">==============================================================================================</span><br></pre></td></tr></table></figure>
<h4 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1. 从git中删除文件</span><br><span class="line">touch test.txt</span><br><span class="line">echo "add test.txt" &gt; test.txt</span><br><span class="line">git add test.txt</span><br><span class="line">git commit -m "add test.txt"</span><br><span class="line">        [master 97669c9] add test.txt</span><br><span class="line">         1 file changed, 1 insertion(+)</span><br><span class="line">         create mode 100644 test.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加一个新文件</span></span><br><span class="line">rm test.txt </span><br><span class="line">git status</span><br><span class="line">        # On branch master</span><br><span class="line">        # Changes not staged for commit:</span><br><span class="line">        #   (use "git add/rm &lt;file&gt;..." to update what will be committed)</span><br><span class="line">        #   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span><br><span class="line">        #</span><br><span class="line">        #       deleted:    test.txt</span><br><span class="line">        #</span><br><span class="line">        no changes added to commit (use "git add" and/or "git commit -a")</span><br><span class="line"><span class="meta">#</span><span class="bash"> 状态显示删除了文件</span></span><br><span class="line">git rm test.txt</span><br><span class="line">		rm 'test.txt'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从git版本库中删除test.txt文件，这样删除后就不能恢复了</span></span><br><span class="line">git commit -m "remove test.txt"</span><br><span class="line">        [master 1e50e5e] remove test.txt</span><br><span class="line">         1 file changed, 1 deletion(-)</span><br><span class="line">		 delete mode 100644 test.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交，删除文件。现在，文件就从版本库中被删除了。</span></span><br><span class="line"></span><br><span class="line">2. 在git中误删除了文件</span><br><span class="line">echo "add test.txt" &gt; test.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个test.txt文件</span></span><br><span class="line">ls</span><br><span class="line">		LICENSE  readme.txt  test.txt</span><br><span class="line">git add test.txt </span><br><span class="line">git commit -m "add test.txt"</span><br><span class="line">        [master 83de0e9] add test.txt</span><br><span class="line">         1 file changed, 1 insertion(+)</span><br><span class="line">         create mode 100644 test.txt</span><br><span class="line">rm -rf test.txt </span><br><span class="line">git checkout -- test.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面不小心删除了文件，这里可以使用git checkout -- file命令将文件从版本库中恢复</span></span><br><span class="line">ls</span><br><span class="line">		LICENSE  readme.txt  test.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> git rm用于从版本库中删除一个文件，这样操作会删除工作区与版本库中的文件，之后也不能恢复。如果一个文件已经被提交到版本库，那么你永远不用担心误删，但是要小心，你只能恢复文件到最新版本，你会丢失最近一次提交后你修改的内容。</span></span><br></pre></td></tr></table></figure>
<h3 id="远程仓库"><a href="#远程仓库" class="headerlink" title="远程仓库"></a>远程仓库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C "abc@gmail.com"</span><br><span class="line"><span class="meta">#</span><span class="bash"> -t指定加密方法，-C提供一个新的注释</span></span><br><span class="line">cat ~/.ssh/id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDc2tIjUTdNkfGKQanXQmRrxenLU54zzgjqojmiWSNpgWLR2a2/F001GBCQsj6MargtS9kbrUhjAuD6y7rGTIyVqZA+cLZs1WB3F3kq2nMhhohNJi6tdH792iyxBXy9C8pRXp5i/pD8PIv3MksGFruIeZtbwVzIIvBIByWZPX52Nro6+njQEaKRxtRwdoG1s45PMjcbWt2UiuqyOZbSvdJX+fzMiYnViLu6W61OeNvF8ySX/hniy8kJ6rfawetn0/A/8DRwHDzI/31aXNntCoF+rER3KzyUwJl4LN/4IFgfhOdmm0JzZaBiCCUS4kM/A4zi2fsUiLWupL/cEG1CtVj abc@gmail.com</span><br><span class="line">将公钥添加到github</span><br><span class="line"><span class="meta">#</span><span class="bash"> GitHub需要识别出你推送的提交确实是你推送的，而不是别人冒充的，而Git支持SSH协议，所以，GitHub只要知道了你的公钥，就可以确认只有你自己才能推送。</span></span><br><span class="line">git remote add origin git@github.com:ruopu89/test.git</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关联远程仓库，远程库的名字就是origin，这是Git默认的叫法。git@github.com:ruopu89/test.git是项目的地址，在github上可以查看到</span></span><br><span class="line">git push -u origin master</span><br><span class="line">        The authenticity of host 'github.com (52.74.223.119)' can't be established.</span><br><span class="line">        RSA key fingerprint is SHA256:nThbg6kXUpJWGl7E1IGOCspRomTxdCARLviKw6E5SY8.</span><br><span class="line">        RSA key fingerprint is MD5:16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48.</span><br><span class="line">        Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">        Warning: Permanently added 'github.com,52.74.223.119' (RSA) to the list of known hosts.</span><br><span class="line">        Counting objects: 27, done.</span><br><span class="line">        Compressing objects: 100% (21/21), done.</span><br><span class="line">        Writing objects: 100% (27/27), 2.14 KiB | 0 bytes/s, done.</span><br><span class="line">        Total 27 (delta 8), reused 0 (delta 0)</span><br><span class="line">        remote: Resolving deltas: 100% (8/8), done.</span><br><span class="line">        remote: </span><br><span class="line">        remote: Create a pull request for 'master' on GitHub by visiting:</span><br><span class="line">        remote:      https://github.com/ruopu89/test/pull/new/master</span><br><span class="line">        remote: </span><br><span class="line">        To git@github.com:ruopu89/test.git</span><br><span class="line">         * [new branch]      master -&gt; master</span><br><span class="line">        Branch master set up to track remote branch master from origin.</span><br><span class="line"><span class="meta">#</span><span class="bash"> git push命令是把当前分支master推送到远程。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 由于远程库是空的，我们第一次推送master分支时，加上了-u参数，Git不但会把本地的master分支内容推送的远程新的master分支，还会把本地的master分支和远程的master分支关联起来，在以后的推送或者拉取时就可以简化命令。</span></span><br><span class="line">git push origin master</span><br><span class="line"><span class="meta">#</span><span class="bash"> 之后在本地提交后，可以把本地master分支的最新修改推送至GitHub</span></span><br></pre></td></tr></table></figure>
<h3 id="分支管理"><a href="#分支管理" class="headerlink" title="分支管理"></a>分支管理</h3><blockquote>
<p>在git中，开始只有一个master分支。HEAD严格来说不是指向提交，而是指向master，master才是指向提交的，所以，HEAD指向的就是当前分支。开始master分支是一条线，Git用master指向最新的提交，再用HEAD指向master，就能确定当前分支，以及当前分支的提交点。每次提交，master分支都会向前移动一步，这样，随着你不断提交，master分支的线也越来越长。当我们创建新的分支，例如dev时，Git新建了一个指针叫dev，指向master相同的提交，再把HEAD指向dev，就表示当前分支在dev上。从现在开始，对工作区的修改和提交就是针对dev分支了，比如新提交一次后，dev指针往前移动一步，而master指针不变。假如我们在dev上的工作完成了，就可以把dev合并到master上。Git怎么合并呢？最简单的方法，就是直接把master指向dev的当前提交，就完成了合并。合并完分支后，甚至可以删除dev分支。删除dev分支就是把dev指针给删掉，删掉后，我们就剩下了一条master分支。</p>
</blockquote>
<h4 id="分支创建与提交、合并"><a href="#分支创建与提交、合并" class="headerlink" title="分支创建与提交、合并"></a>分支创建与提交、合并</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b dev</span><br><span class="line">		Switched to a new branch 'dev'</span><br><span class="line"><span class="meta">#</span><span class="bash"> git checkout命令加上-b参数表示创建并切换，相当于git branch dev &amp;&amp; git checkout dev两条命令</span></span><br><span class="line">git branch </span><br><span class="line">        * dev</span><br><span class="line">          master</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出所有分支，当前分支前面会标一个*号。</span></span><br><span class="line">vim readme.txt</span><br><span class="line">		...</span><br><span class="line">		Creating a new branch is quick.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在最下方追加一行内容</span></span><br><span class="line">git add readme.txt</span><br><span class="line">git commit -m "branch test"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在dev分支上添加并提交</span></span><br><span class="line">git checkout master</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换回master分支</span></span><br><span class="line">cat readme.txt</span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line">        git tracks changes of files.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在master分支上文件并没有变化。因为那个提交是在dev分支上，而master分支此刻的提交点并没有变</span></span><br><span class="line">git merge dev</span><br><span class="line">        Updating 83de0e9..39ca38a</span><br><span class="line">        Fast-forward</span><br><span class="line">         readme.txt | 1 +</span><br><span class="line">         test.txt   | 1 -</span><br><span class="line">         2 files changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line">         delete mode 100644 test.txt</span><br><span class="line"><span class="meta">#</span><span class="bash">  合并指定分支到当前分支。上面的Fast-forward信息告诉我们，这次合并是“快进模式”，也就是直接把master指向dev的当前提交，所以合并速度非常快。但并不是总可以使用此模式</span></span><br><span class="line">git branch -d dev </span><br><span class="line">		Deleted branch dev (was 39ca38a).</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除dev分支</span></span><br><span class="line">git branch</span><br><span class="line">		* master</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再查看，只有master分支了。</span></span><br></pre></td></tr></table></figure>
<h4 id="解决冲突"><a href="#解决冲突" class="headerlink" title="解决冲突"></a>解决冲突</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b featurel</span><br><span class="line">		witched to a new branch 'featurel'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建并切换分支</span></span><br><span class="line">git branch </span><br><span class="line">        * featurel</span><br><span class="line">          master</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看现在的分支</span></span><br><span class="line">vim readme.txt</span><br><span class="line">          ...</span><br><span class="line">          Creating a new branch is quick and simple.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在最后一行添加一些内容</span></span><br><span class="line">git add readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加到暂存区</span></span><br><span class="line">git commit -m "and simple"</span><br><span class="line">        [featurel 5119ca1] and simple</span><br><span class="line">         1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交</span></span><br><span class="line">git checkout master </span><br><span class="line">        Switched to branch 'master'</span><br><span class="line">        Your branch is ahead of 'origin/master' by 1 commit.</span><br><span class="line">          (use "git push" to publish your local commits)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到master分支，提示当前master分支比远程的master分支超前一个提交</span></span><br><span class="line">vim readme.txt</span><br><span class="line">        ...</span><br><span class="line">        Creating a new branch is quick &amp; simple.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改最后一行</span></span><br><span class="line">git add readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加到暂存区</span></span><br><span class="line">git commit -m "&amp; simple"</span><br><span class="line">        [master 91b537a] &amp; simple</span><br><span class="line">         1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交。现在，master分支和feature1分支各自都分别有新的提交</span></span><br><span class="line">git merge featurel </span><br><span class="line">        Auto-merging readme.txt</span><br><span class="line">        CONFLICT (content): Merge conflict in readme.txt</span><br><span class="line">        Automatic merge failed; fix conflicts and then commit the result.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 合并featurel分支到master分支。这种情况下，Git无法执行“快速合并”，只能试图把各自的修改合并起来，但这种合并可能会有冲突。Git告诉我们，readme.txt文件存在冲突，必须手动解决冲突后再提交。</span></span><br><span class="line">git status </span><br><span class="line">        # On branch master</span><br><span class="line">        # Your branch is ahead of 'origin/master' by 2 commits.</span><br><span class="line">        #   (use "git push" to publish your local commits)</span><br><span class="line">        #</span><br><span class="line">        # You have unmerged paths.</span><br><span class="line">        #   (fix conflicts and run "git commit")</span><br><span class="line">        #</span><br><span class="line">        # Unmerged paths:</span><br><span class="line">        #   (use "git add &lt;file&gt;..." to mark resolution)</span><br><span class="line">        #</span><br><span class="line">        #       both modified:      readme.txt</span><br><span class="line">        #</span><br><span class="line">        no changes added to commit (use "git add" and/or "git commit -a")</span><br><span class="line"><span class="meta">#</span><span class="bash"> git status也可以告诉我们冲突的文件</span></span><br><span class="line">cat readme.txt </span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line">        git tracks changes of files.</span><br><span class="line">        &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span><br><span class="line">        Creating a new branch is quick &amp; simple.</span><br><span class="line">        =======</span><br><span class="line">        Creating a new branch is quick and simple.</span><br><span class="line">        &gt;&gt;&gt;&gt;&gt;&gt;&gt; featurel</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看文件，Git用&lt;&lt;&lt;&lt;&lt;&lt;&lt;，=======，&gt;&gt;&gt;&gt;&gt;&gt;&gt;标记出不同分支的内容</span></span><br><span class="line">vim readme.txt</span><br><span class="line">        ...</span><br><span class="line">        Creating a new branch is quick AND simple.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将文件修改为一个新的样子</span></span><br><span class="line">git add readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加</span></span><br><span class="line">git commit -m "conflict fixed"</span><br><span class="line">		[master c0051d2] conflict fixed</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解决冲突后提交</span></span><br><span class="line">git log --graph --pretty=oneline --abbrev-commit</span><br><span class="line">        *   c0051d2 conflict fixed</span><br><span class="line">        |\  </span><br><span class="line">        | * 5119ca1 and simple</span><br><span class="line">        * | 91b537a &amp; simple</span><br><span class="line">        |/  </span><br><span class="line">        * 39ca38a branch test</span><br><span class="line">        * 83de0e9 add test.txt</span><br><span class="line">        * 1e50e5e remove test.txt</span><br><span class="line">        * 97669c9 add test.txt</span><br><span class="line">        * 1ef2c96 add test.txt</span><br><span class="line">        * e49d070 add of files.</span><br><span class="line">        * 27975c9 git tracks changes</span><br><span class="line">        * f21dbee understand how stage works</span><br><span class="line">        * 9976125 append GPL</span><br><span class="line">        * 5e363b3 add distributed</span><br><span class="line">        * 8f5d632 wrote a readme file</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看日志，显示5119ca1 and simple和91b537a &amp; simple合并成了c0051d2 conflict fixed。--graph选项可以看到分支合并图。</span></span><br><span class="line">git branch -d featurel </span><br><span class="line">		Deleted branch featurel (was 5119ca1).</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除分支</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当Git无法自动合并分支时，就必须首先解决冲突。解决冲突后，再提交，合并完成。解决冲突就是把Git合并失败的文件手动编辑为我们希望的内容，再提交。</span></span><br></pre></td></tr></table></figure>
<h4 id="Bug分支"><a href="#Bug分支" class="headerlink" title="Bug分支"></a>Bug分支</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 软件开发中，bug就像家常便饭一样。有了bug就需要修复，在Git中，由于分支是如此的强大，所以，每个bug都可以通过一个新的临时分支来修复，修复后，合并分支，然后将临时分支删除。</span></span><br><span class="line">git checkout -b dev</span><br><span class="line">		Switched to a new branch 'dev'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建并切换到dev分支</span></span><br><span class="line">git branch </span><br><span class="line">        * dev</span><br><span class="line">          master</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看分支</span></span><br><span class="line">touch hello.txt</span><br><span class="line">echo "hello" &gt; hello.txt </span><br><span class="line">git status </span><br><span class="line">        # On branch dev</span><br><span class="line">        # Untracked files:</span><br><span class="line">        #   (use "git add &lt;file&gt;..." to include in what will be committed)</span><br><span class="line">        #</span><br><span class="line">        #       hello.txt</span><br><span class="line">		nothing added to commit but untracked files present (use "git add" to track)</span><br><span class="line">git add hello.txt</span><br><span class="line">git status </span><br><span class="line">        # On branch dev</span><br><span class="line">        # Changes to be committed:</span><br><span class="line">        #   (use "git reset HEAD &lt;file&gt;..." to unstage)</span><br><span class="line">        #</span><br><span class="line">        #       new file:   hello.txt</span><br><span class="line">vim readme.txt </span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is free software distributed under the GPL.</span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line">        git tracks changes of files.</span><br><span class="line">        Creating a new branch is quick AND simple.</span><br><span class="line">        bug test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改文件内容</span></span><br><span class="line">git add .</span><br><span class="line">git status</span><br><span class="line">        # On branch dev</span><br><span class="line">        # Changes to be committed:</span><br><span class="line">        #   (use "git reset HEAD &lt;file&gt;..." to unstage)</span><br><span class="line">        #</span><br><span class="line">        #       new file:   hello.txt</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加并查看状态</span></span><br><span class="line">git stash </span><br><span class="line">        Saved working directory and index state WIP on dev: c0051d2 conflict fixed</span><br><span class="line">        HEAD is now at c0051d2 conflict fixed</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为不想提交，所以使用stash命令把当前dev分支的工作现场“储藏”起来，等以后恢复现场后继续工作</span></span><br><span class="line">git status </span><br><span class="line">        # On branch dev</span><br><span class="line">        nothing to commit, working directory clean</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看状态，现在工作区是干净的</span></span><br><span class="line">git checkout master</span><br><span class="line">        Switched to branch 'master'</span><br><span class="line">        Your branch is ahead of 'origin/master' by 4 commits.</span><br><span class="line">          (use "git push" to publish your local commits)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到master分支</span></span><br><span class="line">git checkout -b issue</span><br><span class="line">		Switched to a new branch 'issue'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建并切换到issue分支</span></span><br><span class="line">git branch </span><br><span class="line">          dev</span><br><span class="line">        * issue</span><br><span class="line">          master</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看分支</span></span><br><span class="line">vim readme.txt </span><br><span class="line">        git is a distributed version control system.</span><br><span class="line">        git is a free software distributed under the GPL.                                                                                                                </span><br><span class="line">        git has a mutable index called stage.</span><br><span class="line">        git tracks changes of files.</span><br><span class="line">        Creating a new branch is quick AND simple.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改第二行内容</span></span><br><span class="line">git add readme.txt</span><br><span class="line">git commit -m "fix bug"</span><br><span class="line">        [issue 305a5d8] fix bug</span><br><span class="line">         1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line">git checkout master</span><br><span class="line">        Switched to branch 'master'</span><br><span class="line">        Your branch is ahead of 'origin/master' by 4 commits.</span><br><span class="line">          (use "git push" to publish your local commits)</span><br><span class="line">git merge --no-ff -m "merged bug fix" issue </span><br><span class="line">        Merge made by the 'recursive' strategy.</span><br><span class="line">         readme.txt | 2 +-</span><br><span class="line">         1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在issue分支添加并提交修改内容，之后回到master分支，并将issue分支合并到master分支，--no-ff指的是强行关闭fast-forward方式，保留分支的commit历史</span></span><br><span class="line">git checkout dev </span><br><span class="line">		Switched to branch 'dev'</span><br><span class="line">git status </span><br><span class="line">        # On branch dev</span><br><span class="line">        nothing to commit, working directory clean</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换回dev分支，查看工作区还是干净的</span></span><br><span class="line">git stash list</span><br><span class="line">		stash@&#123;0&#125;: WIP on dev: c0051d2 conflict fixed</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看stash list中储存了一个分支工作现场，恢复有两种方法：一是用git stash apply恢复，但是恢复后，stash内容并不删除，你需要用git stash drop来删除；另一种方式是用git stash pop，恢复的同时把stash内容也删了</span></span><br><span class="line">git stash pop</span><br><span class="line">        # On branch dev</span><br><span class="line">        # Changes to be committed:</span><br><span class="line">        #   (use "git reset HEAD &lt;file&gt;..." to unstage)</span><br><span class="line">        #</span><br><span class="line">        #       new file:   hello.txt</span><br><span class="line">        #</span><br><span class="line">        # Changes not staged for commit:</span><br><span class="line">        #   (use "git add &lt;file&gt;..." to update what will be committed)</span><br><span class="line">        #   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span><br><span class="line">        #</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line">        #</span><br><span class="line">        Dropped refs/stash@&#123;0&#125; (515e010252f11e7fa154494d4717eaa66af07784)</span><br><span class="line">git stash list</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再用git stash list查看，就看不到任何stash内容了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 你可以多次stash，恢复的时候，先用git stash list查看，然后恢复指定的stash，用命令git stash apply stash@&#123;0&#125;</span></span><br><span class="line">git stash</span><br><span class="line">        Saved working directory and index state WIP on dev: c0051d2 conflict fixed</span><br><span class="line">        HEAD is now at c0051d2 conflict fixed</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次保存现场</span></span><br><span class="line">git stash list</span><br><span class="line">		stash@&#123;0&#125;: WIP on dev: c0051d2 conflict fixed</span><br><span class="line">git stash apply stash@&#123;0&#125; </span><br><span class="line">        # On branch dev</span><br><span class="line">        # Changes to be committed:</span><br><span class="line">        #   (use "git reset HEAD &lt;file&gt;..." to unstage)</span><br><span class="line">        #</span><br><span class="line">        #       new file:   hello.txt</span><br><span class="line">        #</span><br><span class="line">        # Changes not staged for commit:</span><br><span class="line">        #   (use "git add &lt;file&gt;..." to update what will be committed)</span><br><span class="line">        #   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span><br><span class="line">        #</span><br><span class="line">        #       modified:   readme.txt</span><br><span class="line">        #</span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复stash@&#123;0&#125;的工作</span></span><br><span class="line">git stash list</span><br><span class="line">		stash@&#123;0&#125;: WIP on dev: c0051d2 conflict fixed</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为使用了git stash apply命令，所以还是可以查看到保存的工作现场</span></span><br><span class="line">git stash drop stash@&#123;0&#125; </span><br><span class="line">		Dropped stash@&#123;0&#125; (cd2bfebbef6aed8d05fc79e91ef5d4acc883cd5a)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除保存的工作现场</span></span><br><span class="line">git stash list</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再查看时就没有了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修复bug时，我们会通过创建新的bug分支进行修复，然后合并，最后删除；当手头工作没有完成时，先把工作现场git stash一下，然后去修复bug，修复后，再git stash pop，回到工作现场。</span></span><br></pre></td></tr></table></figure>
<h4 id="Feature分支"><a href="#Feature分支" class="headerlink" title="Feature分支"></a>Feature分支</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 软件开发中，总有无穷无尽的新的功能要不断添加进来。添加一个新功能时，你肯定不希望因为一些实验性质的代码，把主分支搞乱了，所以，每添加一个新功能，最好新建一个feature分支，在上面开发，完成后，合并，最后，删除该feature分支。</span></span><br><span class="line">git checkout -b feature</span><br><span class="line">		Switched to a new branch 'feature'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建并切换分支</span></span><br><span class="line">echo vulcan &gt; vulcan.txt</span><br><span class="line">git add vulcan.txt</span><br><span class="line">git status </span><br><span class="line">        # On branch feature</span><br><span class="line">        # Changes to be committed:</span><br><span class="line">        #   (use "git reset HEAD &lt;file&gt;..." to unstage)</span><br><span class="line">        #</span><br><span class="line">        #       new file:   vulcan.txt</span><br><span class="line">        #</span><br><span class="line">git commit -m "add feature vulcan"</span><br><span class="line">        [feature f098cc4] add feature vulcan</span><br><span class="line">         1 file changed, 1 insertion(+)</span><br><span class="line">         create mode 100644 vulcan.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建、添加、提交文件</span></span><br><span class="line">git checkout dev</span><br><span class="line">		Switched to branch 'dev'</span><br><span class="line">git branch -d feature </span><br><span class="line">        error: The branch 'feature' is not fully merged.</span><br><span class="line">        If you are sure you want to delete it, run 'git branch -D feature'.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时如果使用-d选项删除刚创建的分支会提示feature分支还没有被合并，如果删除，将丢失掉修改，如果要强行删除，需要使用大写的-D参数</span></span><br><span class="line">git branch -D feature  </span><br><span class="line">		Deleted branch feature (was f098cc4).</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-D选项强行删除分支成功。</span></span><br></pre></td></tr></table></figure>
<h4 id="多人协作"><a href="#多人协作" class="headerlink" title="多人协作"></a>多人协作</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">git remote</span><br><span class="line">		origin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当你从远程仓库克隆时，实际上Git自动把本地的master分支和远程的master分支对应起来了，并且，远程仓库的默认名称是origin</span></span><br><span class="line">===========================================================================================</span><br><span class="line">多人协作的工作模式通常是这样：</span><br><span class="line"></span><br><span class="line">1. 首先，可以试图用git push origin &lt;branch-name&gt;推送自己的修改；</span><br><span class="line">2. 如果推送失败，则因为远程分支比你本地的内容更新，需要先用git pull试图合并；</span><br><span class="line">3. 如果合并有冲突，则解决冲突，并在本地提交；</span><br><span class="line">4. 没有冲突或者解决掉冲突后，再用git push origin &lt;branch-name&gt;推送就能成功！</span><br><span class="line">5. 如果git pull提示no tracking information，则说明本地分支和远程分支的链接关系没有创建，用命令git branch --set-upstream-to &lt;branch-name&gt; origin/&lt;branch-name&gt;。</span><br><span class="line">===========================================================================================</span><br><span class="line">git remote -v</span><br><span class="line">        origin  git@github.com:ruopu89/test.git (fetch)</span><br><span class="line">        origin  git@github.com:ruopu89/test.git (push)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用git remote -v显示更详细的信息</span></span><br><span class="line">git push origin master </span><br><span class="line">        Warning: Permanently added the RSA host key for IP address '13.250.177.223' to the list of known hosts.</span><br><span class="line">        Counting objects: 18, done.</span><br><span class="line">        Compressing objects: 100% (16/16), done.</span><br><span class="line">        Writing objects: 100% (16/16), 1.38 KiB | 0 bytes/s, done.</span><br><span class="line">        Total 16 (delta 7), reused 0 (delta 0)</span><br><span class="line">        remote: Resolving deltas: 100% (7/7), completed with 1 local object.</span><br><span class="line">        To git@github.com:ruopu89/test.git</span><br><span class="line">           83de0e9..5f4464a  master -&gt; master</span><br><span class="line"><span class="meta">#</span><span class="bash"> 推送本地的master分支到远程的origin中，创建一个叫master的分支</span></span><br><span class="line">git push origin dev </span><br><span class="line">        Counting objects: 9, done.</span><br><span class="line">        Compressing objects: 100% (5/5), done.</span><br><span class="line">        Writing objects: 100% (7/7), 554 bytes | 0 bytes/s, done.</span><br><span class="line">        Total 7 (delta 2), reused 0 (delta 0)</span><br><span class="line">        remote: Resolving deltas: 100% (2/2), completed with 1 local object.</span><br><span class="line">        remote: </span><br><span class="line">        remote: Create a pull request for 'dev' on GitHub by visiting:</span><br><span class="line">        remote:      https://github.com/ruopu89/test/pull/new/dev</span><br><span class="line">        remote: </span><br><span class="line">        To git@github.com:ruopu89/test.git</span><br><span class="line">         * [new branch]      dev -&gt; dev</span><br><span class="line"><span class="meta">#</span><span class="bash"> 推送本地的dev分支到远程的origin上，创建一个叫dev的分支。这样远程就有了两个分支，一个master，一个dev</span></span><br><span class="line">mkdir learngit2</span><br><span class="line">cd learngit2</span><br><span class="line">git clone git@github.com:ruopu89/test.git</span><br><span class="line">        Cloning into 'test'...</span><br><span class="line">        Warning: Permanently added the RSA host key for IP address '13.229.188.59' to the list of known hosts.</span><br><span class="line">        remote: Enumerating objects: 50, done.</span><br><span class="line">        remote: Counting objects: 100% (50/50), done.</span><br><span class="line">        remote: Compressing objects: 100% (25/25), done.</span><br><span class="line">        remote: Total 50 (delta 17), reused 50 (delta 17), pack-reused 0</span><br><span class="line">        Receiving objects: 100% (50/50), done.</span><br><span class="line">        Resolving deltas: 100% (17/17), done.</span><br><span class="line">cd test/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入克隆下来的目录</span></span><br><span class="line">ls -a</span><br><span class="line">        .  ..  .git  LICENSE  readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看master分支中的文件</span></span><br><span class="line">git branch </span><br><span class="line">		* master</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看现在的分支是master</span></span><br><span class="line">git checkout -b dev origin/dev </span><br><span class="line">        Branch dev set up to track remote branch dev from origin.</span><br><span class="line">        Switched to a new branch 'dev'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建远程origin的dev分支到本地</span></span><br><span class="line">git branch </span><br><span class="line">        * dev</span><br><span class="line">          master</span><br><span class="line">ls</span><br><span class="line">hello.txt  LICENSE  readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> dev分支中的文件</span></span><br><span class="line">echo env &gt; env.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在dev分支中创建文件</span></span><br><span class="line">git add env.txt</span><br><span class="line">git commit -m "add env"</span><br><span class="line">        [dev afff0e7] add env</span><br><span class="line">         1 file changed, 1 insertion(+)</span><br><span class="line">         create mode 100644 env.txt</span><br><span class="line">git push origin dev </span><br><span class="line">        Counting objects: 4, done.</span><br><span class="line">        Compressing objects: 100% (2/2), done.</span><br><span class="line">        Writing objects: 100% (3/3), 329 bytes | 0 bytes/s, done.</span><br><span class="line">        Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">        To git@github.com:ruopu89/test.git</span><br><span class="line">           a285424..afff0e7  dev -&gt; dev</span><br><span class="line"><span class="meta">#</span><span class="bash"> 推送到远程的dev分支中</span></span><br><span class="line">cd ../learngit</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到之前的目录</span></span><br><span class="line">ls</span><br><span class="line">		hello.txt  LICENSE  readme.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里并没有env文件</span></span><br><span class="line">git branch </span><br><span class="line">        * dev</span><br><span class="line">          issue</span><br><span class="line">          master</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 现在也在dev分支上</span></span><br><span class="line">cp ../learngit2/test/env.txt ./</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将克隆下来的目录中的env.txt文件复制到当前目录中</span></span><br><span class="line">ls</span><br><span class="line">		env.txt  hello.txt  LICENSE  readme.txt</span><br><span class="line">echo abc &gt;&gt; env.txt </span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改env.txt文件</span></span><br><span class="line">git add env.txt</span><br><span class="line">git commit -m "add new env"</span><br><span class="line">        [dev c997d7c] add new env</span><br><span class="line">         1 file changed, 2 insertions(+)</span><br><span class="line">         create mode 100644 env.txt</span><br><span class="line">git push origin dev </span><br><span class="line">        To git@github.com:ruopu89/test.git</span><br><span class="line">         ! [rejected]        dev -&gt; dev (fetch first)</span><br><span class="line">        error: failed to push some refs to 'git@github.com:ruopu89/test.git'</span><br><span class="line">        hint: Updates were rejected because the remote contains work that you do</span><br><span class="line">        hint: not have locally. This is usually caused by another repository pushing</span><br><span class="line">        hint: to the same ref. You may want to first merge the remote changes (e.g.,</span><br><span class="line">        hint: 'git pull') before pushing again.</span><br><span class="line">        hint: See the 'Note about fast-forwards' in 'git push --help' for details.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 推送失败。因为刚才最新提交和你试图推送的提交有冲突，解决办法也很简单，Git已经提示我们，先用git pull把最新的提交从origin/dev抓下来，然后，在本地合并，解决冲突，再推送</span></span><br><span class="line">git pull </span><br><span class="line">        remote: Enumerating objects: 4, done.</span><br><span class="line">        remote: Counting objects: 100% (4/4), done.</span><br><span class="line">        remote: Compressing objects: 100% (2/2), done.</span><br><span class="line">        remote: Total 3 (delta 0), reused 3 (delta 0), pack-reused 0</span><br><span class="line">        Unpacking objects: 100% (3/3), done.</span><br><span class="line">        From github.com:ruopu89/test</span><br><span class="line">           a285424..afff0e7  dev        -&gt; origin/dev</span><br><span class="line">        There is no tracking information for the current branch.</span><br><span class="line">        Please specify which branch you want to merge with.</span><br><span class="line">        See git-pull(1) for details</span><br><span class="line"></span><br><span class="line">            git pull &lt;remote&gt; &lt;branch&gt;</span><br><span class="line"></span><br><span class="line">        If you wish to set tracking information for this branch you can do so with:</span><br><span class="line"></span><br><span class="line">            git branch --set-upstream-to=origin/&lt;branch&gt; dev</span><br><span class="line"><span class="meta">#</span><span class="bash"> git pull也失败了，有两种方法解决。一是git pull 远程地址/分支，二是git branch --<span class="built_in">set</span>-upstream-to=origin/&lt;branch&gt; dev</span></span><br><span class="line">git pull git@github.com:ruopu89/test.git dev</span><br><span class="line">        From github.com:ruopu89/test</span><br><span class="line">         * branch            dev        -&gt; FETCH_HEAD</span><br><span class="line">        Auto-merging env.txt</span><br><span class="line">        CONFLICT (add/add): Merge conflict in env.txt</span><br><span class="line">        Automatic merge failed; fix conflicts and then commit the result.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用第一种方法pull下来文件</span></span><br><span class="line">git branch --set-upstream-to=origin/dev dev</span><br><span class="line">		Branch dev set up to track remote branch dev from origin.</span><br><span class="line">git pull</span><br><span class="line">        U       env.txt</span><br><span class="line">        Pull is not possible because you have unmerged files.</span><br><span class="line">        Please, fix them up in the work tree, and then use 'git add/rm &lt;file&gt;'</span><br><span class="line">        as appropriate to mark resolution, or use 'git commit -a'.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用第二种方法pull文件，只是提示不能合并文件，因为上面已经拉过一次了</span></span><br><span class="line">vim env.txt </span><br><span class="line">        env                                                                                                                                                              </span><br><span class="line">        abc</span><br><span class="line">git add env.txt</span><br><span class="line">git commit -m "fix env"</span><br><span class="line">		[dev 59a0059] fix env</span><br><span class="line">git push origin dev</span><br><span class="line">        Counting objects: 7, done.</span><br><span class="line">        Compressing objects: 100% (3/3), done.</span><br><span class="line">        Writing objects: 100% (4/4), 451 bytes | 0 bytes/s, done.</span><br><span class="line">        Total 4 (delta 1), reused 0 (delta 0)</span><br><span class="line">        remote: Resolving deltas: 100% (1/1), done.</span><br><span class="line">        To git@github.com:ruopu89/test.git</span><br><span class="line">           afff0e7..59a0059  dev -&gt; dev  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改文件后再添加、提交、推送就没问题了。</span></span><br></pre></td></tr></table></figure>
<h4 id="变基"><a href="#变基" class="headerlink" title="变基"></a>变基</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">git log --graph --pretty=oneline --abbrev-commit </span><br><span class="line">        *   59a0059 fix env</span><br><span class="line">        |\  </span><br><span class="line">        | * afff0e7 add env</span><br><span class="line">        * | c997d7c add new env</span><br><span class="line">        |/  </span><br><span class="line">        * a285424 test2</span><br><span class="line">        * 15e9ec8 test1</span><br><span class="line">        *   c0051d2 conflict fixed</span><br><span class="line">        |\  </span><br><span class="line">        | * 5119ca1 and simple</span><br><span class="line">        * | 91b537a &amp; simple</span><br><span class="line">        |/  </span><br><span class="line">        * 39ca38a branch test</span><br><span class="line"><span class="meta">#</span><span class="bash"> --graph表示查看分支合并图；--pretty=oneline表示将信息在一行显示；--abbrev-commit表示仅显示SHA-1的前几个字符，而非全部字符（这个SHA-1字符就是指的校验和）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Git用(HEAD -&gt; master)和(origin/master)标识出当前分支的HEAD和远程origin的位置</span></span><br><span class="line">git rebase</span><br><span class="line"><span class="meta">#</span><span class="bash"> rebase操作的特点：把分叉的提交历史“整理”成一条直线，看上去更直观。缺点是本地的分叉提交已经被修改过了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rebase操作可以把本地未push的分叉提交历史整理成直线；rebase的目的是使得我们在查看历史提交的变化时更容易，因为分叉的提交需要三方对比。</span></span><br></pre></td></tr></table></figure>
<h3 id="标签管理"><a href="#标签管理" class="headerlink" title="标签管理"></a>标签管理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">发布一个版本时，我们通常先在版本库中打一个标签（tag），这样，就唯一确定了打标签时刻的版本。将来无论什么时候，取某个标签的版本，就是把那个打标签的时刻的历史版本取出来。所以，标签也是版本库的一个快照。</span><br><span class="line">Git的标签虽然是版本库的快照，但其实它就是指向某个commit的指针（跟分支很像对不对？但是分支可以移动，标签不能移动），所以，创建和删除标签都是瞬间完成的。</span><br><span class="line">git tag v1.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打标签，默认标签是打在最新提交的commit上的</span></span><br><span class="line">git tag </span><br><span class="line">		v1.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看标签</span></span><br><span class="line">git log --pretty=oneline --abbrev-commit </span><br><span class="line">        59a0059 fix env</span><br><span class="line">        c997d7c add new env</span><br><span class="line">        afff0e7 add env</span><br><span class="line">        a285424 test2</span><br><span class="line">        15e9ec8 test1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看日志</span></span><br><span class="line">git tag v1.1 c997d7c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给指定的提交打标签</span></span><br><span class="line">git tag </span><br><span class="line">        v1.0</span><br><span class="line">        v1.1</span><br><span class="line">git show v1.1</span><br><span class="line">        commit c997d7c8f10561e1176ff24c7dd6f3c6468c467f</span><br><span class="line">        Author: ruopu89 &lt;ruopu1989@hotmail.com&gt;</span><br><span class="line">        Date:   Tue Dec 11 15:59:14 2018 +0800</span><br><span class="line"></span><br><span class="line">            add new env</span><br><span class="line"></span><br><span class="line">        diff --git a/env.txt b/env.txt</span><br><span class="line">        new file mode 100644</span><br><span class="line">        index 0000000..f981a8f</span><br><span class="line">        --- /dev/null</span><br><span class="line">        +++ b/env.txt</span><br><span class="line">        @@ -0,0 +1,2 @@</span><br><span class="line">        +env</span><br><span class="line">        +abc        </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看标签打在哪个提交上了</span></span><br><span class="line">git tag -a v1.2 -m "test" afff0e7</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-a选项指定标签名，-m指定说明文字。-a选项在要添加说明信息时使用</span></span><br><span class="line">git show v1.2</span><br><span class="line">        tag v1.2</span><br><span class="line">        Tagger: ruopu89 &lt;ruopu1989@hotmail.com&gt;</span><br><span class="line">        Date:   Tue Dec 11 16:33:49 2018 +0800</span><br><span class="line"></span><br><span class="line">        test</span><br><span class="line"></span><br><span class="line">        commit afff0e76e4e904da31f58bd046667eaac3ce5d5f</span><br><span class="line">        Author: ruopu89 &lt;ruopu1989@hotmail.com&gt;</span><br><span class="line">        Date:   Tue Dec 11 15:56:21 2018 +0800</span><br><span class="line"></span><br><span class="line">            add env</span><br><span class="line"></span><br><span class="line">        diff --git a/env.txt b/env.txt</span><br><span class="line">        new file mode 100644</span><br><span class="line">        index 0000000..0a764a4</span><br><span class="line">        --- /dev/null</span><br><span class="line">        +++ b/env.txt</span><br><span class="line">        @@ -0,0 +1 @@</span><br><span class="line">        +env</span><br><span class="line">git tag -d v1.2</span><br><span class="line">		Deleted tag 'v1.2' (was 5c1f2b9)   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除标签</span></span><br><span class="line">git push origin v1.1</span><br><span class="line">        Total 0 (delta 0), reused 0 (delta 0)</span><br><span class="line">        To git@github.com:ruopu89/test.git</span><br><span class="line">         * [new tag]         v1.1 -&gt; v1.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 推送标签到远程</span></span><br><span class="line">git push origin --tags </span><br><span class="line">        Total 0 (delta 0), reused 0 (delta 0)</span><br><span class="line">        To git@github.com:ruopu89/test.git</span><br><span class="line">         * [new tag]         v1.0 -&gt; v1.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一次性推送全部尚未推送到远程的本地标签</span></span><br><span class="line">git push origin :refs/tags/v1.1</span><br><span class="line">        To git@github.com:ruopu89/test.git</span><br><span class="line">         - [deleted]         v1.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从远程删除。 :refs/tags/v1.1是标签在.git目录中的路径</span></span><br></pre></td></tr></table></figure>
<h3 id="忽略特殊文件"><a href="#忽略特殊文件" class="headerlink" title="忽略特殊文件"></a>忽略特殊文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">创建.gitignore文件可以忽略不想上传的文件，.gitignore文件不需要从头创建，可在https://github.com/github/gitignore下载。</span><br><span class="line">忽略文件的原则是：</span><br><span class="line">1. 忽略操作系统自动生成的文件，比如缩略图等；</span><br><span class="line">2. 忽略编译生成的中间文件、可执行文件等，也就是如果一个文件是通过另一个文件自动生成的，那自动生成的文件就没必要放进版本库，比如Java编译产生的.class文件；</span><br><span class="line">3. 忽略你自己的带有敏感信息的配置文件，比如存放口令的配置文件。</span><br><span class="line">git add -f abc.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-f选项可以强制添加文件</span></span><br></pre></td></tr></table></figure>
<h3 id="github个人博客多电脑使用"><a href="#github个人博客多电脑使用" class="headerlink" title="github个人博客多电脑使用"></a>github个人博客多电脑使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">cd /home/GitHub/ruopu.github.io</span><br><span class="line">ssh-keygen -t rsa -C "ruopu19@hotmail.com"</span><br><span class="line"><span class="meta">#</span><span class="bash"> -C后的是一些描述信息</span></span><br><span class="line">cat .ssh/id_rsa.pub</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将密钥复制到github上</span></span><br><span class="line">ssh -T git@github.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试与github连接是否成功</span></span><br><span class="line">git config --global user.name "ruopu1989"</span><br><span class="line">git config --global user.email "ruopu1989@hotmail.com"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自报家门</span></span><br><span class="line">git init</span><br><span class="line">给源文件目录初始化git，虽然目录中已有内容，但这也不会报错的</span><br><span class="line">git remote add origin https://github.com/abc/abc.github.io.git</span><br><span class="line"><span class="meta">#</span><span class="bash"> 与远程的origin分支关联，最后的地址是github上项目的地址。使用git push时如果提示需要输入用户名和密码，可以删除远程地址，再试。命令：git remote remove origin。另外，这里也可以使用git@github.com:abc/abc.github.io.git地址。</span></span><br><span class="line">git checkout -b source</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建并切换分支，使用-b选择就是为了创建并切换。这与git branch <span class="built_in">source</span> &amp;&amp; git checkout <span class="built_in">source</span>两条命令的执行结果是一样的。</span></span><br><span class="line">git branch</span><br><span class="line"><span class="meta">#</span><span class="bash"> 现在本地只有一个<span class="built_in">source</span>分支，这也就是主分支</span></span><br><span class="line">git add .</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加所有内容到暂存区</span></span><br><span class="line">git commit -m 'add source'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交</span></span><br><span class="line">git push origin source</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将本地的<span class="built_in">source</span>分支推送到远程的origin分支上</span></span><br><span class="line">在github上将source设置为主分支，这样之后clone的就都是这个source分支上的内容了。</span><br><span class="line">** 上传中会有一个问题，就是theme目录中的主题文件上传后可能是灰色的，这是因为获得主题文件时就是从另一个库clone来的，所以主题文件目录中也有.git文件。如果上传了目录，解决方法如下：</span><br><span class="line">1. 将主题文件目录剪切到另一个不相干的目录中</span><br><span class="line">2. git add .</span><br><span class="line">3. git commit -m 'delete theme'</span><br><span class="line">4. git push</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以上几步是为了将没有主题文件目录的信息再次提交，之后推送到远程库，也就删除了远程库上的主题文件目录</span></span><br><span class="line">5. 将主题文件目录中的.git、.gitignore、.gitattributes三个文件删除，之后将主题文件目录再剪切回github的theme目录中</span><br><span class="line">6. git add .</span><br><span class="line">7. git commit -m 'new theme'</span><br><span class="line">8. git push</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次将没有.git文件的主题推送到远程库就没有问题了。</span></span><br><span class="line">==============================================================================================</span><br><span class="line">推送时出现问题，原因是想将本地的文件推送到远程，但与远程有很多不同。可以使用下面命令强行推送。但本地的文件可能丢失。推送前将文件备份，推送后将丢失的文再复制到相应目录，再推送就可以了。</span><br><span class="line">git push -f origin source</span><br><span class="line"></span><br><span class="line">另外还涉及一些常用命令</span><br><span class="line">git branch</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前分支</span></span><br><span class="line">git checkout master</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换分支。加-b选项是创建并切换分支</span></span><br><span class="line">git merge source</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将<span class="built_in">source</span>分支内容合并到当前分支</span></span><br><span class="line">git add .</span><br><span class="line">git commit -m "abc"</span><br><span class="line">git push origin source</span><br><span class="line">git diff</span><br><span class="line">git status</span><br><span class="line">git log</span><br><span class="line">git remote add origin https://github.com/abc/rab.github.io.git</span><br><span class="line">git reset --hard HEAD^</span><br><span class="line"><span class="meta">#</span><span class="bash"> 回退到上一个版本</span></span><br><span class="line">git reflog</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看提交与回退历史</span></span><br></pre></td></tr></table></figure>
<h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 克隆远程分支</span><br><span class="line">git clone -b dev https://git.oschina.net/oschina/android-app.git</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-b选项指定远程分支的名称，这里叫dev</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/05/ShellScript练习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/05/ShellScript练习/" itemprop="url">
                  ShellScript练习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-12-05 16:49:27" itemprop="dateCreated datePublished" datetime="2018-12-05T16:49:27+08:00">2018-12-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-05-29 18:49:36" itemprop="dateModified" datetime="2019-05-29T18:49:36+08:00">2019-05-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 因没办法得到日志，所以只能用tcpdump来抓包，之后将抓到的包中的设备编号取出并排序。这里只取数字</span></span><br><span class="line">tcpdump -i em1 -w netty.cap</span><br><span class="line">vim enginenumber.sh</span><br><span class="line">        #!/bin/bash</span><br><span class="line">        #</span><br><span class="line"></span><br><span class="line">        for i in `tcpdump -X -r $1 | grep stamc | awk '&#123;print $10&#125;'`;do</span><br><span class="line">        # tcpdump -X表示以ASCII码的方式显示，-r表示读取，$1是要输入的cap文件名，解析cap文件后从中找到有stamc的行，最后打印出每10列</span><br><span class="line">           first=`echo $&#123;i##*stamc&#125;`</span><br><span class="line">           # 截取结果中stamc后面的部分，并将结果给first变量。因为结果都是stamc****ve这样的结果</span><br><span class="line">           for j in $first;do</span><br><span class="line">           # 将$first变量的值给j</span><br><span class="line">                echo $&#123;j%ve*&#125; &gt;&gt; ./test.txt</span><br><span class="line">                # 截取结果中ve前面的部分，这时的结果是****ve这样的编号，将结果重定向到当前目录下的test.txt文件中</span><br><span class="line">           done</span><br><span class="line">        done</span><br><span class="line">        sort -n -u test.txt &gt;&gt; $2</span><br><span class="line">        # 将test.txt中的数字以从小到大的顺序排列，并去除重复的数字，最后输出到一个文件，输出的文件需要执行命令时手工输入</span><br><span class="line">        rm -rf ./test.txt</span><br><span class="line">        # 最后删除test.txt文件</span><br></pre></td></tr></table></figure>
<h3 id="查询设备编号"><a href="#查询设备编号" class="headerlink" title="查询设备编号"></a>查询设备编号</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 每日有大量日志文件，每500M打包一个，需要从众多日志文件中查找设备编号，并查看日志结果</span></span><br><span class="line">vim netty.sh</span><br><span class="line">        #!/bin/bash</span><br><span class="line">        #</span><br><span class="line">        read -p "please input month: " -t 10 month</span><br><span class="line">        # 输入月份</span><br><span class="line">        read -p "please input day: " day</span><br><span class="line">        # 输入日期</span><br><span class="line">        read -p "please input engine number: " engine</span><br><span class="line">        # 输入设备编号</span><br><span class="line">        read -p "please input logs path: " path</span><br><span class="line">        # 输入日志路径</span><br><span class="line">        for i in `ls $path/netty.log-2018-$&#123;month&#125;-$&#123;day&#125;.*.log`;do</span><br><span class="line">        # 遍历当天的所有日志</span><br><span class="line">            grep -a "stamc$&#123;engine&#125;ve" $i &gt;&gt; new.txt</span><br><span class="line">            # 从每个日志中查找相应的设备编号，并重定向到new.txt文件中。使用-a选项是因为日志中多是二进制文件，直接打开或查找会显示乱码。</span><br><span class="line">        done</span><br></pre></td></tr></table></figure>
<h3 id="备份日志"><a href="#备份日志" class="headerlink" title="备份日志"></a>备份日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">生产服务器</span><br><span class="line">ssh-keygen -t rsa -P ''</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成密钥</span></span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub '-p 39999 ccjd@126.38.38.85'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 传输公钥到远程备份服务器。如果不是默认的端口，要用单引号括起远程的端口与地址，端口使用-p选项指定。</span></span><br><span class="line">ssh ccjd@106.38.38.85 -p 39999</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接测试</span></span><br><span class="line">vim logbackup.sh </span><br><span class="line">    #!/bin/bash</span><br><span class="line">    #</span><br><span class="line">    cd /usr/local/logs/</span><br><span class="line">    tar -zcf netty.log-`date -d "yesterday" +"%F"`.log.tar.gz ./netty.log-`date -d "yesterday" +"%F"`.*.log</span><br><span class="line">    # 使用date -d "yesterday" +"%F"获取昨天的日期</span><br><span class="line">    scp -P 39999 netty.log-`date -d "yesterday" +"%F"`.log.tar.gz ccjd@106.38.38.85:/home/logsbackup/ </span><br><span class="line">    # 这里指定端口使用-P选项且要将选项放在前面。</span><br><span class="line">    rm -rf netty.log-`date -d "yesterday" +"%F"`.*.log netty.log-`date -d "yesterday" +"%F"`.log.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">hn=`hostname`</span><br><span class="line">listen=`ss -tln4 | grep 10050 | awk '&#123;print $4&#125;' | cut -d':' -f2`</span><br><span class="line">rpm -q zabbix-agent</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">    while [ "$listen" != "10050" ];do</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里使用字符串来判断数字，因为测试中如果没有启动服务listen变量就是空，比较时会报错，脚本不会向下执行。</span></span><br><span class="line">        systemctl start zabbix-agent</span><br><span class="line">        listen=`ss -tln4 | grep 10050 | awk '&#123;print $4&#125;' | cut -d':' -f2`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动之后一定要再检查一次端口是否启动，并赋值给listen</span></span><br><span class="line">    done</span><br><span class="line">else</span><br><span class="line">    yum install -y /netdisk/soft/zabbix/zabbix-agent-3.4.3-1.el7.x86_64.rpm</span><br><span class="line">cat &gt; /etc/zabbix/zabbix_agentd.conf &lt;&lt; EOF</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_agentd.pid</span><br><span class="line">LogFile=/var/log/zabbix/zabbix_agentd.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">EnableRemoteCommands=1</span><br><span class="line">Server=172.16.201.2</span><br><span class="line">ServerActive=127.0.0.1</span><br><span class="line">Hostname=$hn</span><br><span class="line">Include=/etc/zabbix/zabbix_agentd.d/*.conf</span><br><span class="line">EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从cat命令到这里的内容最好都顶头写，尤其最后的EOF，如果不顶头写会报语法错误。中间要输入的内容如果不顶头写，在写入配置文件后也会在内容前有空格。</span></span><br><span class="line">    systemctl start zabbix-agent</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h3 id="跳板机"><a href="#跳板机" class="headerlink" title="跳板机"></a>跳板机</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@template sh]# vim /etc/profile.d/tiaoban.sh</span><br><span class="line">	[ $UID -ne 0 ] &amp;&amp; . /tmp/tiaoban.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断用户是否为root用户，如果不是就加载tiaoban.sh脚本</span></span><br><span class="line">[root@template sh]# vim /tmp/tiaoban.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个脚本要放在一个登录的普通用户可以进入执行的路径 </span></span><br><span class="line">trapper() &#123;</span><br><span class="line">   trap ':' INT EXIT TSTP TERM HUP</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试发现，这里使用<span class="built_in">trap</span> <span class="string">':'</span>或<span class="built_in">trap</span> <span class="string">''</span>都是一样的。如果不使用<span class="built_in">trap</span>命令，普通用户登录后，在菜单中使用ctrl+c可以退出到命令行界面</span></span><br><span class="line">while :;do</span><br><span class="line">   trapper</span><br><span class="line">   clear</span><br><span class="line">   cat &lt;&lt; menu</span><br><span class="line">        1. web a</span><br><span class="line">        2. web b</span><br><span class="line">        3. exit</span><br><span class="line">menu</span><br><span class="line">   read -p "pls select: " num</span><br><span class="line">   case "$num" in</span><br><span class="line">   1)</span><br><span class="line">        echo 1</span><br><span class="line">        ssh root@192.168.1.14</span><br><span class="line">        # 这里如果不指定用户登录，会使用当前的用户登录</span><br><span class="line">        ;;</span><br><span class="line">   2)</span><br><span class="line">        echo 2</span><br><span class="line">        ssh root@192.168.1.15</span><br><span class="line">        ;;</span><br><span class="line">   3|*)</span><br><span class="line">        exit</span><br><span class="line">        ;;</span><br><span class="line">   esac</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户以普通用户的身份登录后只会显示菜单，再传输跳板机中普通用户的密钥到目标主机，最后禁止使用密码登录跳板机或禁止root用户登录即可</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 跳板机的实现，就是通过一个脚本，提供菜单，实现登录远程主机与退出功能，另外，添加一个环境变量，判断只要不是root用户登录，就加载这个跳板机脚本，给用户提供菜单，最后给创建一个普通用户的权限，可以连接跳板机，这样在用户登录时就可以看到菜单，但用户无法连接到这台跳板机服务器的命令行。可否添加高可用keepalived？</span></span><br></pre></td></tr></table></figure>
<h3 id="批量卸载rpm包"><a href="#批量卸载rpm包" class="headerlink" title="批量卸载rpm包"></a>批量卸载rpm包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">for i in `find ./ -name *.rpm`;do</span><br><span class="line"><span class="meta">#</span><span class="bash"> 搜索当前目录下的所有rpm包，路径最好写绝对路径</span></span><br><span class="line">    test=`basename $i | cut -d'.' -f1 | awk -F"-" 'OFS="-"&#123;$NF=""&#125;END&#123;sub(/-$/,"");print&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 先取包名，如：drbd84-utils-8.4.1-2.el6.elrepo.x86_64.rpm，因为不想加包的版本号，所以继续取包名，使用cut命令按点来分隔，取出第一段，这时是这样的：drbd84-utils-8，再使用awk命令，指定分隔符为<span class="string">"-"</span>，之后再指定输出分隔符为<span class="string">"-"</span>，<span class="variable">$NF</span>表示最后一列，如果只写到这里，取出的值是：drbd84-utils-，只去除了以<span class="string">"-"</span>为分隔符后的最后一段，但最后还有一个<span class="string">"-"</span>，这样就使用END命令，在最后再处理一次，sub是内置函数，/-$/是指尾部的<span class="string">"-"</span>，sub(/-$/,<span class="string">""</span>)表示将尾部的<span class="string">"-"</span>改为空，最后打印出来，就成了：drbd84-utils</span></span><br><span class="line">    rpm -e --nodeps $test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用rpm -e --nodeps可以只卸载指定的包，而不卸载依赖包</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="提取JSON文件中的指定值"><a href="#提取JSON文件中的指定值" class="headerlink" title="提取JSON文件中的指定值"></a>提取JSON文件中的指定值</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">有JSON格式文件都在一行中，需要从中提取指定的值，需要从中提取"ChannelName"后的值，如"BTV文艺"，JSON文件内容如下：</span><br><span class="line">&#123;"count": 460, "data": [&#123;"CACardID": "8100103913276261", "SerialNumber": "10081807030091806", "log": "&#123;"ADID":"16512_1_102","Advtype":2,"RandomSeq":"dce3db2d-8331-43e8-8dab-fc42d4bdff4b","LocalTime":"2019-02-01 00:00:00","CACardID":"8100103913276261","EventtypeId":"AdvDataCollect","IsLeave":"1","ServiceID":102,"DeviceType":"DVBIP-1004","CollectManufacturer":"inspur","ChannelName":"BTV文艺","SerialNumber":"10081807030091806","ADPositionID":6,"RegionId":"11132"&#125;", "AdvDataCollect": &#123;"ADPositionID": "6", "Advtype": "2", "ServiceID": "102", "ADID": "16512_1_102", "IsLeave": "1", "ChannelName": "BTV文艺", "LocalTime": "2019-02-01 00:00:00.000+0800"&#125;, "RegionId": "11132", "RandomSeq": "dce3db2d-8331-43e8-8dab-fc42d4bdff4b", "DeviceType": "DVBIP-1004", "time": "2019-02-01 00:00:00.000+0800", "EventtypeId": "AdvDataCollect", "_id": "LsulpGgBnh2vjNXwpHy3", "_collect_time": "2019-02-01 00:02:25.064+0800"&#125;, &#123;"CACardID": "8100103913276261", "SerialNumber": "10081807030091806", "log": "&#123;"ADID":"16512_1_102","Advtype":2,"RandomSeq":"653c618f-4282-452a-b680-d4050ec6b567","LocalTime":"2019-02-01 </span><br><span class="line">.........</span><br><span class="line">23:59:11","CACardID":"8100103913276261","EventtypeId":"LockingDataCollect","DeviceType":"DVBIP-1004","Locked":"true","CollectManufacturer":"inspur","SerialNumber":"10081807030091806","SymbolRate":6875000,"Modulation":"QAM64","Quality":37,"CurrentFrequency":331,"Level":60,"RegionId":"11132"&#125;", "RegionId": "11132", "RandomSeq": "e2c61503-7d9d-47dc-979d-a17cd4db5a30", "DeviceType": "DVBIP-1004", "time": "2019-02-01 23:59:11.000+0800", "EventtypeId": "LockingDataCollect", "_id": "kDTIqWgBNUKkFfMOVTGX", "_collect_time": "2019-02-01 23:58:24.179+0800", "LockingDataCollect": &#123;"Locked": "true", "Level": "60", "Modulation": "QAM64", "SymbolRate": "6875000", "CurrentFrequency": "331", "Quality": "37", "LocalTime": "2019-02-01 23:59:11.000+0800"&#125;&#125;, &#123;"CACardID": "8100103913276261", "SerialNumber": "10081807030091806", "log": "&#123;"DeviceType":"DVBIP-1004","CollectManufacturer":"inspur","RandomSeq":"b7b7896b-c293-425a-ae7c-40675f22252f","SerialNumber":"10081807030091806","LocalTime":"2019-02-01 23:59:11","Idle":91,"SystemRunTime":23475,"RegionId":"11132","FlashRest":4823449,"CACardID":"8100103913276261","EventtypeId":"ResourceDataCollect","RAMRest":638&#125;", "ResourceDataCollect": &#123;"SystemRunTime": 23475.0, "FlashRest": 4823449.0, "Idle": "91", "RAMRest": 638.0, "LocalTime": "2019-02-01 23:59:11.000+0800"&#125;, "RegionId": "11132", "RandomSeq": "b7b7896b-c293-425a-ae7c-40675f22252f", "DeviceType": "DVBIP-1004", "time": "2019-02-01 23:59:11.000+0800", "EventtypeId": "ResourceDataCollect", "_id": "B8TIqWgBnh2vjNXwVauX", "_collect_time": "2019-02-01 23:58:24.602+0800"&#125;], "timed_out": false, "take_time": 5475&#125;</span><br><span class="line"></span><br><span class="line">root@ruopu64:2019-03-07#cat 8100103913276261_2019-02-01.json | tr "," "\n" | grep "ChannelName"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用tr命令将文件中的逗号都转为新行，之后再查找指定值即可。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样的JSON文件每天会产生一个</span></span><br><span class="line">root@ruopu64:2019-03-07#cat *.json &gt; all.json</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将所有文件输出到一个文件中</span></span><br><span class="line">root@ruopu64:2019-03-07#cat all.json | tr "," "\n" | grep "ChannelName" | cut -d":" -f2 | grep -v "^[[:space:]]"|sort -n |uniq -c|sort -n &gt; allOK.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再将统计结果输出到一个文件中。通过这两步就可以统计所有频道点播的次数了</span></span><br><span class="line"></span><br><span class="line">root@ruopu64:2019-03-07#vim all.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">count=$(cat all.json | tr "," "\n" | grep "ChannelName" | cut -d":" -f2 | grep -v "^[[:space:]]"|sort -n |uniq -c|sort -n)</span><br><span class="line">counta=$(cat all.json | tr "," "\n" | grep "ChannelName" | cut -d":" -f2 | grep -v "^[[:space:]]"|sort -n |uniq -c|sort -n|awk '&#123;print $1&#125;')</span><br><span class="line">a=0</span><br><span class="line">for i in `cat all.json | tr "," "\n" | grep "ChannelName" | cut -d":" -f2 | grep -v "^[[:space:]]"|sort -n |uniq -c|sort -n|awk '&#123;print $1&#125;'`;do</span><br><span class="line">    let a=$a+$i                                                                                                              </span><br><span class="line">done</span><br><span class="line">echo $a</span><br></pre></td></tr></table></figure>
<h3 id="自动添加策略路由"><a href="#自动添加策略路由" class="headerlink" title="自动添加策略路由"></a>自动添加策略路由</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">mbm - 04/16/2012 - add additional routes</span></span><br><span class="line"></span><br><span class="line">tablenum=100</span><br><span class="line"></span><br><span class="line">for int_name in &#123;eno2,ens1f0,ens1f1,enp96s0f1,enp24s0f0,enp24s0f1,enp216s0f0,enp216s0f1&#125; ;do</span><br><span class="line">  if  [ -f /etc/sysconfig/network-scripts/ifcfg-$&#123;int_name&#125; ]; then</span><br><span class="line">  . /etc/sysconfig/network-scripts/ifcfg-$&#123;int_name&#125;</span><br><span class="line">  network=$(ipcalc -n $&#123;IPADDR&#125; $&#123;NETMASK&#125; | awk -F= '&#123;print $2&#125;')</span><br><span class="line">  IFS=. read -r i1 i2 i3 i4 &lt;&lt;&lt; $&#123;network&#125; </span><br><span class="line">  ROUTER=$&#123;i1&#125;.$&#123;i2&#125;.$&#123;i3&#125;.$((i4+1))</span><br><span class="line">  prefix=$(ipcalc -p $&#123;IPADDR&#125; $&#123;NETMASK&#125; | awk -F= '&#123;print $2&#125;')</span><br><span class="line">  tablenum=$((tablenum+1))</span><br><span class="line">  else </span><br><span class="line">        continue</span><br><span class="line">  fi</span><br><span class="line">  if [ $&#123;ONBOOT&#125; != 'yes' ] ;then</span><br><span class="line">    continue</span><br><span class="line">  fi</span><br><span class="line">  if ! grep "^$&#123;tablenum&#125; $&#123;DEVICE&#125;$" /etc/iproute2/rt_tables &gt;/dev/null ;then</span><br><span class="line">    echo "$&#123;tablenum&#125; $&#123;DEVICE&#125;" #&gt;&gt;/etc/iproute2/rt_tables</span><br><span class="line">  fi</span><br><span class="line">  echo "ip route add $&#123;network&#125;/$&#123;prefix&#125; dev $&#123;DEVICE&#125; src $&#123;IPADDR&#125; table $&#123;DEVICE&#125;"</span><br><span class="line">  echo "ip route add default via $&#123;ROUTER&#125; dev $&#123;DEVICE&#125; table $&#123;DEVICE&#125;"</span><br><span class="line">  echo "ip rule add from $&#123;IPADDR&#125;/32 table $&#123;DEVICE&#125;"</span><br><span class="line">  echo "ip rule add to $&#123;IPADDR&#125;/32 table $&#123;DEVICE&#125;"</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/05/SSL证书生成/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/05/SSL证书生成/" itemprop="url">
                  SSL证书生成
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-12-05 15:58:41" itemprop="dateCreated datePublished" datetime="2018-12-05T15:58:41+08:00">2018-12-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-12-19 13:29:00" itemprop="dateModified" datetime="2018-12-19T13:29:00+08:00">2018-12-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li><p>SSL也就是Secure Socket Layer，叫做安全套接字协议，是一种应用层协议，主要用于传输数据的加密。SSL证书通过在客户端浏览器和Web服务器之间建立一条SSL安全通道，SSL安全协议主要用来提供对用户和服务器的认证；对传送的数据进行加密和隐藏；确保数据在传送中不被改变，即数据的完整性，现已成为该领域中全球化的标准。</p>
</li>
<li><p>x509证书一般会用到三类文件：key、csr、crt</p>
<p>key是私钥，openssl格式，通常使用rsa算法</p>
<p>csr是证书请求文件 ，用于申请证书。在制作csr文件的时候，必须使用自己的私钥来签署申请。</p>
<p>crt是CA认证后的证书文件，签署人用自己的key给申请人签署的凭证。</p>
</li>
<li><p>先要有CA根证书，之后用CA根证书来签发用户证书。用户申请证书时，先生成一个私钥，之后用私钥生成证书请求，证书中含有公钥信息，再利用证书服务器的CA根证书来签发证书。根证书是CA认证中心给自己颁发的证书，任何安装CA根证书的服务器都意味着对这个CA认证中心是信任的。数字证书则是由证书认证机构（CA）对证书申请者真实身份验证之后，用CA的根证书对申请人的一些基本信息以及申请人的公钥进行签名后形成的一个数字文件。数字证书包含证书中所标识的实体的公钥，由于证书将公钥与特定的个人匹配，并且该证书的真实性由颁发机构保证，因此，数字证书为如何找到用户的公钥并知道它是否有效这一问题提供了解决方案。</p>
</li>
<li><p>openssl中文件的后缀名</p>
<p>.key格式：私有的密钥</p>
<p>.csr格式：证书签名请求，含有公钥信息，csr是certificate signing request的缩写</p>
<p>.crt格式：证书文件，crt是certificate的缩写</p>
<p>.crl格式：证书文件，crl是certificate的缩写</p>
<p>.pem格式：用于导出，导入证书时候的证书的格式，有证书开头，结尾的格式</p>
</li>
<li><p>证书生成步骤：</p>
<p>这里有三个角色，CA根服务器、RA派出服务器、客户端</p>
<p>根证书：生成CA私钥（.key）–&gt;生成CA证书请求（.csr）–&gt;自签名得到根证书（.crt）（CA给自已颁发的证书）。（这里的CA服务器）</p>
<p>派出服务器证书：派出服务器的证书也是自己先生成私钥和请求，再由CA根服务器使用根证书签署后，派出服务器才能使用</p>
<p>客户端证书：客户端证书由客户端生成私钥与请求后，由派出服务器签署生效</p>
<p>个人理解，这里的CA服务器就是操作系统中集成的根证书机构，RA就是可以从出售证书的机构，如阿里等，客户端指需要使用SSL功能的机构，如网站等。用户在电脑上浏览某个https网站时，会下载网站的证书，证书的有效性靠操作系统中集成的根证书来识别。</p>
</li>
<li><p>通信过程：A要与B进行通信，A将自己的公钥发给了B，那B就需要知道A发过来的公钥是否为正规的CA颁发的，A在获得CA给其颁发的证书时CA会在证书上面盖一个戳，因此我们需要通过验证戳的真实性来验证A的公钥的合法性，所以上面的问题关键点就在于验证CA所盖的戳的真实性。通过验证CA自身的证书就可以验证CA盖的戳的真实性。CA证书是从操作系统上获得的，也就是系统发行厂商会把这些CA证书做进操作系统里。在需要的时候可以直接比对，如果操作系统中没有固化的这些CA证书，那么这个证书就不合法。</p>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/02/ShellScript-概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/02/ShellScript-概念/" itemprop="url">
                  ShellScript_概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-12-02 16:58:19" itemprop="dateCreated datePublished" datetime="2018-12-02T16:58:19+08:00">2018-12-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-13 21:02:51" itemprop="dateModified" datetime="2019-01-13T21:02:51+08:00">2019-01-13</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>概念</p>
<p>shell是外殼，用戶連接计算機用的外殼；shell也是一種程序；包括：</p>
<p>GUI:Gnome, KDE, Xfce       圖形</p>
<p>CLI:sh, csh, ksh, bash, tcsh, zsh 命令行</p>
<p>shell在什麼時候被啓動？用戶登陸時要給用戶提供一個輸入命令的地方，這時就打開了一個shell。如果同時登陸兩個用戶，用的shell是一個嗎？因shell是一種程序，所以程序只能有一個，但進程是程序的副本，誰用的時候就拿來復制一個，可以有多個，哪怕是同一個用戶登陸三次也會打開三個進程。三個進程間彼此各不相幹，這是linux的特性；在每個進程看來，當前主機上只存在內核和當前進程，運行的只是自己，它不知道別的進程的存在。因爲系統識別進程是靠進程號識別的，所以進程號不同，就是不同的程序；進程是程序的副本，進程也是程序執行的實例（就是程序運行起來才是進程）；進程是有生命周期的，從啓動那一刻到終止那一刻結束，這個過程由內核來管理。bash是一個外部命令，但啓動後它還有很多內置命令</p>
</li>
<li><p>bash特性：</p>
<ol>
<li><p>命令歷史，上下箭頭可查看之前的命令、命令補全</p>
</li>
<li><p>支持管道、重定向</p>
</li>
<li><p>支持命令別名</p>
</li>
<li><p>支持命令行編輯</p>
</li>
<li><p>支持命令行展開</p>
</li>
<li><p>支持文件名通配</p>
</li>
<li><p>支持使用變量</p>
</li>
<li><p>支持編程</p>
</li>
</ol>
<p>注：可以讀一下bash的幫助文檔，man bash</p>
</li>
<li><p>環境變量：定義用戶的工作環境</p>
<p>PATH：命令搜索路徑</p>
<p>HISTSIZE：命令歷史緩沖區大小，默認是1000條；</p>
<p>例：echo $HISTSIZE(用echo $變量名 可以查看變量名)</p>
</li>
<li><p>SHELL的類型</p>
<p>登錄式shell（站在用戶登錄的角度）</p>
<ol>
<li><p>正常通過某終端登錄</p>
</li>
<li><p>su – username或su –l username</p>
</li>
</ol>
<p>非登錄式shell</p>
<ol>
<li><p>su username</p>
</li>
<li><p>圖形終端下打開命令窗口</p>
</li>
<li><p>自動執行的shell腳本</p>
</li>
</ol>
</li>
<li><p>bash的配置文件</p>
<ul>
<li>全局配置；全局生效</li>
</ul>
<p>​    /etc/profile      /etc/profile.d/*.sh   /etc/bashrc</p>
<ul>
<li>個人配置；當前用戶生效</li>
</ul>
<p>​     ~/.bash_profile              ~/.bashrc</p>
</li>
</ul>
<ul>
<li><p>profile類的文件</p>
<ul>
<li><p>設定環境變量，比如將環境變量放在/etc/profile或/etc/profile.d目錄下（全局和個人都配置了，以個人為準，作用範圍越小的最終先生效）</p>
</li>
<li><p>運行命令或腳本（登陸前的準備工作可以在此類文件中定義）</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>bashrc類的文件</p>
<ul>
<li><p>設定本地變量</p>
</li>
<li><p>定義命令別名</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>登陸式shell如何讀取配置文件</p>
<p>​       讀取過程</p>
<p>​       /etc/profile → /etc/profile.d/*.sh →~/.bash_profile → ~/.bashrc → /etc/bashrc</p>
</li>
</ul>
<ul>
<li><p>非登陸式shell如何讀取配置文件</p>
<p>​       ~/.bashrc → /etc/bashrc → /etc/profile.d/*.sh  (因為不讀取/etc/profile和/.bash_profile所以使用兩種方式su過去的用戶是不同的，所以su – 是完成切換，不加-是半切換)</p>
<p>例：用hive用戶登陸，並alias cls=clear會設置別名，但登出後會失效，但可在~/.bashrc定義別名的地方，在其中加入一行如：alias cls=’clear’即可在當前用戶下次登陸時生效，或使用. ~/.bashrc命令当时生效</p>
<p>~/.bash_profile定義登陸時的提醒信息，在其中加入一行如：echo “Hello,hive.Welcome to our system. It is <code>date</code>”；加入 umask 027 可使umask一直是027，默認是002是在/etc/profile中定義好的</p>
</li>
</ul>
<ul>
<li><p>輸入輸出重定向與管道</p>
<ul>
<li><p>bash：是腳本解釋器</p>
</li>
<li><p>默認輸出設備：也叫標準輸出或STDOUT，文件描述符是1；只輸出正常的數據；如果沒指定輸入輸出設備就從默認的設備裏進行；</p>
</li>
<li><p>默認輸入設備：也叫標準輸入或STDIN，文件描述符是0</p>
</li>
<li><p>標准錯誤輸出：STDERR，描述符2</p>
</li>
<li><p>標準輸入：鍵盤</p>
</li>
<li><p>標准輸出和錯誤輸出：默認都輸出到顯示器</p>
</li>
<li><p>I/O重定向：改變輸入輸出來源</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">\&gt;：輸出重定向，覆蓋輸出</span><br><span class="line">\&gt;&gt;：追加輸出</span><br><span class="line">set -C：禁止對已經存在文件使用覆蓋重定向；強制覆蓋輸出，則使用&gt;|</span><br><span class="line">set +C：關閉上述功能</span><br><span class="line"><span class="meta">2&gt;</span><span class="bash">：重定向錯誤輸出</span></span><br><span class="line"><span class="meta">2&gt;</span><span class="bash">&gt;：追加方式           </span></span><br><span class="line">	例：ls /varr &gt; /tmp/var.out 2&gt; /tmp/err.out</span><br><span class="line">&amp;&gt;：重定向標準輸出或錯誤輸出至同一個文件</span><br><span class="line">&lt;：輸入重定向      例：tr ‘a-z’ ‘A-Z’ &lt; /etc/fstab</span><br><span class="line">&lt;&lt;：在此處生成文檔(Here Document )   </span><br><span class="line">	例：cat &lt;&lt; END 之後可以一直輸入文字，直到輸入END為止，END可以自己定義；cat &gt;&gt; /tmp/myfile.txt &lt;&lt; EOF，系統會等待用戶輸入數據直到輸入EOF為止，這種方式可以腳本中生成文件的</span><br></pre></td></tr></table></figure>
<ul>
<li>管道：前一個命令的輸出，作為後一個命令的輸入</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">命令1 ｜ 命令2 ｜ 命令3 ｜ …</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">echo “redhat” | passwd --stdin hive</span><br><span class="line">cut -d: -f1 /etc/passwd | sort | tr ‘a-z’ ‘A-Z’</span><br><span class="line">echo “hello” | tee /tmp/hello.out   </span><br><span class="line"><span class="meta">#</span><span class="bash"> tee命令是從標准輸入數據讀取並保存一份文檔並輸出到顯示器，這裏顯示器上的結果是tee輸出的不是<span class="built_in">echo</span>輸出的</span></span><br><span class="line">wc –l /etc/passwd | cut –d' ' -f1       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 其中-d選項要指定分隔符為空格</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>編譯器或解釋器是一種軟件，它是一個翻譯官，轉換人與機器所用的語言。shell就是這樣的翻譯官</p>
</li>
<li><p>編程語言：機器語言（01代碼）、匯編語言（人和機器都可以理解）、高級語言（接近人的語言）</p>
</li>
<li><p>高級語言分爲靜態與動態語言</p>
<p>靜態語言屬於編譯型語言，有自己的程序開發環境，不需要借助額外的二進制程序就可以直接寫代碼，寫完後需要一個編譯器將其直接轉換成二進制代碼後可以獨立運行的就是靜態語言。它們是強類型（變量）語言，我們在使用編程的時候，無論哪種語言都提供一些控制語句或關鍵字，這些關鍵字最後能夠被我們的解釋器或編譯器轉換成能夠被機器識別的機器代碼或機器指令。編譯語言需要在程序編譯之前或轉換之前事先完成的，只有轉換完成以後，我們才能運行這個程序</p>
<p>態語言屬於解釋型語言是弱類型的語言。不需要事先完成轉換以後才運行這個程序，代碼寫完後不需要轉換成二進制格式，而是有解釋器解釋一條執行一條，也就是程序在執行的時候才需要轉換。執行特性是on the fly；動態語言的解釋器是靜態語言開發的</p>
</li>
<li><p>面向過程：把編程着眼點放在問題解決過程本身。適合開發小型程序。linux內核是用C開發的；shell, C</p>
<p>面向對象：把整個要實現的項目抽象成一個個的對象並且定義對象之間的動作。更適合開發大型程序；Java, python, perl, c++</p>
</li>
<li><p>變量是內存空間，定義變量是命名內存的過程，空間用完後可回收</p>
<p>內存：編址的存儲單元</p>
<p>進程：數據、指令在內存，臨時存儲在內存；在進程中有一個字符串，人看它的是變量名，機器看是內存地址，機器通過此地址到內存中提取變量，變量被提取後內存空間會被回收</p>
</li>
<li><p>變量類型：決定變量的存儲格式；事先定義好數據的存儲格式和長度，保存不下會溢出</p>
</li>
<li><p>強類型編程語言：變量在使用前，必須事先聲明，甚至還需要初始化，就是給一個值；默認數值型是0,字符串型是空</p>
<p>弱類型編程語言：變量用時聲明，甚至不區分類型；默認是字符串類型</p>
</li>
<li><p>bash變量類型：</p>
<p>環境變量：作用域為當前shell進程及其子進程</p>
<p>本地變量（局部變量）：作用域為整個bash進程，啓動後可從shell中聲明變量，與bash進程相關，bash進程結束時變量也就都沒了。變量是進程的變量。局部變量的作用域為當前代碼段</p>
<p>位置變量：$1,  $2,  …</p>
<p>特殊變量:bash內置，保存特殊數據的</p>
</li>
<li><p>程序執行，可能有兩類返回值：</p>
<p>程序執行結果就是顯示的結果</p>
<p>程序狀態返回代碼（0－255）</p>
<p>​    0：正確執行；1－255：錯誤執行，1，2，127系統預留；</p>
</li>
<li><p>對shell來講默認所有變量值都是字符串所以默認不能作算術運算</p>
</li>
<li><p>腳本是命令的堆砌，按實際需要，結合命令流程控制機制實現的源程序    </p>
</li>
<li><p>shebang：魔數，須以#!開頭之後寫出可執行文件的所在位置，#號注釋行，不執行；命令沒給路徑會到PATH環境變量中查找，要執行命令可以將當前路徑加入PATH環境變量中或用./指明當前路徑，也可以是其他路徑；腳本沒有執行權限時可用bash SCRIPTNAME來執行，這是明確告訴程序用bash解釋器來執行腳本。</p>
</li>
<li><p>腳本在執行時會啟動一個子shell進程：</p>
<p>命令行中啟動的腳本會繼承當前shell環境變量</p>
<p>系統自動執行的腳本（非命令行啟動）就需要自我定義需要的各環境變量</p>
</li>
<li><p>shell是能夠實現接收用戶指令理解用戶接令的命令，並將它傳輸給內核，由內核指揮某個應用程序啓動的一個界面。Shell會提供一個用戶能夠和它交互的界面，其次將用戶的指揮行翻譯爲內核能夠理解的命令。</p>
</li>
<li><p>函數：函數就是功能（function），必須被調用才能執行。函數的主要作用是代碼重用</p>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/02/ShellScript-正则表达式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/02/ShellScript-正则表达式/" itemprop="url">
                  ShellScript_正则表达式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-12-02 16:23:41" itemprop="dateCreated datePublished" datetime="2018-12-02T16:23:41+08:00">2018-12-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-07-17 15:34:54" itemprop="dateModified" datetime="2019-07-17T15:34:54+08:00">2019-07-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基本正则表达式元字符"><a href="#基本正则表达式元字符" class="headerlink" title="基本正则表达式元字符"></a>基本正则表达式元字符</h3><h4 id="转义字符"><a href="#转义字符" class="headerlink" title="转义字符"></a>转义字符</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\r: 回车</span><br><span class="line">\n: 换行符</span><br><span class="line">\t: 制表符</span><br><span class="line">\\: “\” 本身</span><br><span class="line">\^: 匹配^符号本身</span><br><span class="line">\$: 匹配$符号本身</span><br><span class="line">\.: 匹配小数点. 本身</span><br></pre></td></tr></table></figure>
<h4 id="多种字符匹配"><a href="#多种字符匹配" class="headerlink" title="多种字符匹配"></a>多种字符匹配</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\d：任意一个数字，0~9 中的任意一个</span><br><span class="line">\w：任意一个字母或数字或下划线，也就是 A~Z,a~z,0~9,_ 中任意一个</span><br><span class="line">\s：包括空格、制表符、换页符等空白字符的其中任意一个</span><br><span class="line">.：小数点可以匹配除了换行符以外的任意一个字符</span><br></pre></td></tr></table></figure>
<h4 id="字符匹配"><a href="#字符匹配" class="headerlink" title="字符匹配"></a>字符匹配</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.: 匹配任意单个字符</span><br><span class="line">[]:匹配指定范围内的任意单个字符</span><br><span class="line">[^]:匹配指定范围外的任意单个字符</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以上[]当中的范围有以下几种表示方法：</span></span><br><span class="line">[:alnum:]:表示所有的字母和数字</span><br><span class="line">[:alpha:]:表示所有字母（不区分大小写）</span><br><span class="line">[:digit:]:表示所有的数字</span><br><span class="line">[:lower:]:表示所有的小写字母</span><br><span class="line">[:punct:]:表示所有的标点符号</span><br><span class="line">[:space:]:表示所有的空白字符</span><br><span class="line">[:upper:]:表示所有的大写字母</span><br></pre></td></tr></table></figure>
<h4 id="次数匹配"><a href="#次数匹配" class="headerlink" title="次数匹配"></a>次数匹配</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">用于在要指定次数的字符后面或用于指定前面的字符要出现的次数：</span><br><span class="line">*:匹配前面的字符任意次</span><br><span class="line">.*:任意长度的任意字符</span><br><span class="line">?:匹配其前面的字符0次或1次，即前面的可有可无</span><br><span class="line">+:匹配其前面的字符至少1次</span><br><span class="line">\&#123;m\&#125;:匹配前面的字符m次</span><br><span class="line">\&#123;m,n\&#125;:匹配前面的字符至少m次，至多n次</span><br><span class="line">\&#123;,n\&#125;:匹配前面的字符至多n次</span><br><span class="line">\&#123;m,\&#125;:区配前面的字符至少m次</span><br></pre></td></tr></table></figure>
<h4 id="位置锚定"><a href="#位置锚定" class="headerlink" title="位置锚定"></a>位置锚定</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">对特定位置进行定位</span><br><span class="line">^:行首锚定：用于模式的最左侧</span><br><span class="line"><span class="meta">$</span><span class="bash">:行尾锚定：用于模式的最右侧</span></span><br><span class="line">^PATTERN$: 用于模式匹配整行</span><br><span class="line">	^$:空行，不包含有空格的行</span><br><span class="line">	^[[:space:]]*$:空行，但包含有空格的行</span><br><span class="line">\&lt;或\b:词首锚定，用于单词模式的左侧</span><br><span class="line">\&gt;或\b:词尾锚定，用于单词模式的右侧</span><br><span class="line">\&lt;PATTERN\&gt;:匹配整个单词</span><br></pre></td></tr></table></figure>
<h4 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">分组是指将一个或多个字符捆绑在一起，当作一个整体进行处理，其符号为：</span><br><span class="line">\(\):</span><br><span class="line">例：\(xy\)*ab表示xy这个整体可以出现任意次</span><br><span class="line">注意：</span><br><span class="line">1. 分组括号中的模式匹配到的内容会被正则表达式引擎记录于内部的变量中，这些变量的命名方式为：\1, \2, \3, ...。</span><br><span class="line">	\1:从左侧起，第一个左括号以及与之匹配的右括号之间的模式所匹配到的字符；如：\(ab\+\(xy\)*\)中\1表示：ab\+\(xy\)*，\2表示：xy</span><br><span class="line">2. 后向引用：引用前面的分组括号中的模式所匹配的字符，而非模式本身</span><br></pre></td></tr></table></figure>
<h3 id="扩展正则表达式元字符"><a href="#扩展正则表达式元字符" class="headerlink" title="扩展正则表达式元字符"></a>扩展正则表达式元字符</h3><h4 id="字符匹配-1"><a href="#字符匹配-1" class="headerlink" title="字符匹配"></a>字符匹配</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[]:匹配指定范围内的任意单个字符</span><br><span class="line">[^]:匹配指定范围外的任意单个字符</span><br></pre></td></tr></table></figure>
<h4 id="次数匹配-1"><a href="#次数匹配-1" class="headerlink" title="次数匹配"></a>次数匹配</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*:任意次</span><br><span class="line">?:0次或1次</span><br><span class="line">+:至少1次</span><br><span class="line">&#123;m&#125;:精确匹配m次</span><br><span class="line">&#123;m,n&#125;:至少m次，至多n次</span><br><span class="line">&#123;m,&#125;:到少m次</span><br><span class="line">&#123;0,n&#125;:至多n次</span><br></pre></td></tr></table></figure>
<h4 id="锚定"><a href="#锚定" class="headerlink" title="锚定"></a>锚定</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">扩展正则表达式的位置锚定和其本正则表达式相同</span><br></pre></td></tr></table></figure>
<h4 id="分组-1"><a href="#分组-1" class="headerlink" title="分组"></a>分组</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">():用括号括起来表示要引用的内容，不需要转义</span><br><span class="line">后向引用：\1, \2, \3</span><br><span class="line">或</span><br><span class="line">a|b:a或者b</span><br></pre></td></tr></table></figure>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="贪婪与非贪婪匹配"><a href="#贪婪与非贪婪匹配" class="headerlink" title="贪婪与非贪婪匹配"></a>贪婪与非贪婪匹配</h4><p>​    在使用修饰匹配次数的特殊符号时，有几种表示方法可以使同一个表达式能够匹配不同的次数，比如：“{m,n}”, “{m,}”, “?”, “<em>”</em>,<em> “+”</em>，*具体匹配的次数随被匹配的字符串而定。这种重复匹配不定次数的表达式在匹配过程中，总是尽可能多的匹配。</p>
<p>​    比如，文本 “axxxaxxxa”，”(a)(\w+)“，其中”\w+“会匹配”xxxaxxxa”，”(a)(\w+)(a)“则会匹配”xxxaxxx”。由此可见，”\w+“ 在匹配的时候，总是尽可能多的匹配符合它规则的字符。</p>
<p>​    虽然第二个举例中，它没有匹配最后一个 “a”，但那也是为了让整个表达式能够匹配成功。同样的，带 ”“ 和 ”{m,n}“ 的表达式都是尽可能地多匹配，带 ”?“ 的表达式在可匹配可不匹配的时候，也是尽可能的<strong>匹配</strong>。这种匹配原则就叫作”贪婪”模式。</p>
<p>​    非贪婪模式则是指的<strong>在修饰匹配次数的特殊符号后再加上一个 “?” 号</strong>，可以使匹配次数不定的表达式尽可能少的匹配，使可匹配可不匹配的表达式，尽可能的<strong>不匹配</strong>。</p>
<p>​    这种匹配原则也叫作 “勉强” 模式。如果少匹配就会导致整个表达式匹配失败的时候，与贪婪模式类似，非贪婪模式会最小限度的再匹配一些，以使整个表达式匹配成功。如，文本 “axxxaxxxa” ，“(a)(\w+?)”，其中”\w+“只会匹配一个“x”。</p>
<h4 id="反向引用"><a href="#反向引用" class="headerlink" title="反向引用"></a>反向引用</h4><p>​    表达式在匹配时，表达式引擎会将小括号 “()” 包含的表达式所匹配到的字符串记录下来。在获取匹配结果的时候，小括号包含的表达式所匹配到的字符串可以单独获取。当用某种边界来查找，而所要获取的内容又不包含边界时，必须使用小括号来指定所要的范围。如：“<div>(.*?)</div>“即获取div标签内部的内容。</p>
<p>​    这里小括号包含的正则表达式所匹配到的字符串不仅仅是在匹配结束后才可以使用，在匹配过程中也可以使用。表达式后边的部分，可以引用前面括号内的子匹配已经匹配到的字符串。引用方法是 “\” 加上一个数字。”\1” 引用第1对括号内匹配到的字符串，”\2” 引用第2对括号内匹配到的字符串，以此类推，而如果一对括号内包含另一对括号，则外层的括号先排序号。换句话说，哪一对的左括号 “(” 在前，那这一对就先排序号。</p>
<p>​    例如：表达式 “(‘|’)(.*?)(\1)“ 在匹配 ” ‘Hello’, “World” “ 时，匹配结果是：成功；匹配到的内容是：” ‘Hello’ “。再次匹配下一个时，可以匹配到 ” “World” “。</p>
<h4 id="预搜索"><a href="#预搜索" class="headerlink" title="预搜索"></a>预搜索</h4><p>​    如前面所讲”^“、”$“、”\b”字符有一个共同点，就是：它们本身不匹配任何字符，只是对 “字符串的两头” 或者 “字符之间的缝隙” 附加了一个条件。同样的，正则中提供了其他基于此原理的机制，来实现预搜索。</p>
<ul>
<li><p>正向预搜索：”(?=xxxxx)“，”(?!xxxxx)”</p>
<p>格式：”(?=xxxxx)“，在被匹配的字符串中，它对所处的 “缝隙” 或者 “两头” 附加的条件是：所在缝隙的右侧，必须能够匹配上xxxxx这部分的表达式，不影响后边的表达式去真正匹配这个缝隙之后的字符。如：“Mac (?=book|air)” 在匹配 “Mac pro, Mac air” 时，将只匹配 “Mac air” 中的 “Mac”。</p>
<p>格式：“(?!xxxxx)”，所在缝隙的右侧，必须不能匹配 xxxxx 这部分表达式。如：“hello(?!\w)” 在匹配字符串 “hello,helloworld”时，匹配 hello”。这里使用 “(?!\w)” 和使用 “\b” 效果一样。</p>
</li>
<li><p>反向预搜索：“(?&lt;=xxxxx)”，“(?&lt;!xxxxx)”</p>
<p>和正向预搜索类似，反向预搜索要求的条件是：所在缝隙的 “左侧”，两种格式分别要求必须能够匹配和必须不能够匹配指定表达式，而不是去判断右侧。与 “正向预搜索” 一样的是：它们都是对所在缝隙的一种附加条件，本身都不匹配任何字符。</p>
</li>
</ul>
<p>其他通用规则</p>
<ul>
<li><p>可以使用 “\xXX” 和 “\uXXXX” 表示一个字符（”X” 表示一个十六进制数）</p>
</li>
<li><ul>
<li>\xXX: 编号在 0-255 范围的字符，如：空格可以使用 “\x20” 表示</li>
<li>\uXXXX: 任何字符可以使用 “\u” 再加上其编号的4位十六进制数表示，比如：“\u4E2D”</li>
</ul>
</li>
<li><p>在表达式 “\s”，”\d”，”\w”，”\b” 表示特殊意义的同时，对应的大写字母表示相反的意义</p>
</li>
<li><ul>
<li>\S: 匹配所有非空白字符</li>
<li>\D: 匹配所有的非数字字符</li>
<li>\W: 匹配所有的字母、数字、下划线以外的字符</li>
<li>\B: 匹配非单词边界，即左右两边都是 “\w” 范围或者左右两边都不是 “\w” 范围时的字符缝隙</li>
</ul>
</li>
<li><p>括号“()”内的子表达式，如果希望匹配结果不进行记录供以后使用，可以使用 “(?:xxxxx)”格式。如：表达式 “(?:(\w)\1)+” 匹配 “a bbccdd efg” 时，结果是 “bbccdd”。括号 “(?:)” 范围的匹配结果不进行记录，因此 “(\w)” 使用 “\1” 来引用。</p>
</li>
<li><p>常用的表达式属性设置包括：Ignorecase、Singleline、Multiline、Global</p>
</li>
<li><ul>
<li>Ignorecase: 默认情况下，表达式中的字母是要区分大小写的。配置为 Ignorecase 可使匹配时不区分大小写。有的表达式引擎，把 “大小写” 概念延伸至 UNICODE 范围的大小写。</li>
<li>Singleline: 默认情况下，小数点 “.” 匹配除了换行符（\n）以外的字符。配置为Singleline可使小数点可匹配包括换行符在内的所有字符。</li>
<li>Multiline: 默认情况下，表达式 “^” 和 “$” 只匹配字符串的开始1和结尾4位置。如：1xxxxxxxxx2\n 3xxxxxxxxx4</li>
</ul>
</li>
</ul>
<p>配置为 Multiline 可以使 “^” 匹配1外，还可以匹配换行符之后，下一行开始前3的位置，”$“ 匹配4外，还可以匹配换行符之前，一行结束2的位置。使用(?m)可以设置为Multiline模式。如”(?m)^\n +“。</p>
<ul>
<li>Global: 主要在将表达式用来替换时起作用，配置为Global表示替换所有的匹配。</li>
</ul>
<h4 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h4><ul>
<li>如果要求表达式所匹配的内容是整个字符串，而不是其中的一部分，可以在表达式的首尾使用 “^” 和 ““ 要求整个字符串只有数字。</li>
<li>如果要求匹配的内容是一个完整的单词，而不会是单词的一部分，那么在表达式首尾使用 “\b”，如：使用 “\b(if|while|…)\b” 来匹配程序中的关键字。</li>
<li>表达式不要匹配空字符串。否则会一直得到匹配成功，而结果什么都没有匹配到。</li>
<li>能匹配空字符串的子匹配不要循环无限次。如果括号内的子表达式中的每一部分都可以匹配0次，而这个括号整体又可以匹配无限次，那么匹配过程中可能死循环。</li>
<li>“|” 的左右两边，对某个字符应该只有一边可以匹配，以防止”|“两边的表达式因为交换位置而有所不同。</li>
<li>要合理选择贪婪模式与非贪婪模式，如. 与 <em>.</em>?的区别使用。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/29/docker部署-Dockerfile使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/29/docker部署-Dockerfile使用/" itemprop="url">
                  docker部署-Dockerfile使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-29 14:32:28" itemprop="dateCreated datePublished" datetime="2018-11-29T14:32:28+08:00">2018-11-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-02 22:10:31" itemprop="dateModified" datetime="2019-02-02T22:10:31+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Dockerfile测试"><a href="#Dockerfile测试" class="headerlink" title="Dockerfile测试"></a>Dockerfile测试</h3><h4 id="定制基础镜像"><a href="#定制基础镜像" class="headerlink" title="定制基础镜像"></a>定制基础镜像</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">* 测试一</span><br><span class="line">mkdir -p /root/apache_centos</span><br><span class="line">cd /root/apache_centos</span><br><span class="line">vim run.sh</span><br><span class="line">    #!/bin/bash</span><br><span class="line">    /usr/sbin/sshd &amp;</span><br><span class="line">    /usr/local/apache2/bin/httpd -D FOREGROUND</span><br><span class="line">vim Dockerfile</span><br><span class="line">    FROM centos</span><br><span class="line">    RUN yum install -y wget</span><br><span class="line">    WORKDIR /usr/local/src 	# 使用WORKDIR是为了切换目录</span><br><span class="line">    RUN wget http://apache.fayea.com/httpd/httpd-2.4.37.tar.gz</span><br><span class="line">    RUN tar -zxvf httpd-2.4.37.tar.gz</span><br><span class="line">    WORKDIR httpd-2.4.37	</span><br><span class="line">    RUN yum install -y gcc make apr-devel apr apr-util apr-util-devel pcre-devel</span><br><span class="line">    RUN ./configure --prefix=/usr/local/apache2  --enable-mods-shared=most  --enable-so</span><br><span class="line">    RUN make</span><br><span class="line">    RUN make install</span><br><span class="line">    RUN sed -i 's/#ServerName www.example.com:80/ServerName localhost:80/g' /usr/local/apache2/conf/httpd.conf</span><br><span class="line">    RUN /usr/local/apache2/bin/httpd</span><br><span class="line">    ADD run.sh /usr/local/sbin/run.sh</span><br><span class="line">    RUN chmod 755 /usr/local/sbin/run.sh</span><br><span class="line">    EXPOSE 80</span><br><span class="line">    CMD ["/usr/local/sbin/run.sh"]</span><br><span class="line">docker build -t apache_dockerfile:centos .</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成镜像。生成的镜像仓库是apache_dockerfile，标签是centos，以centos镜像为基础。这样创建镜像的问题就是使用了太多的RUN命令，Dockerfile 中每一个指令都会建立一层，RUN也不例外。每一个RUN的行为都会新建立一层，在其上执行这些命令，执行结束后，commit这一层的修改，构成新的镜像。这样创建镜像大概需要十多层</span></span><br><span class="line"></span><br><span class="line">* 测试二</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用Dockerfile文件，简化RUN命令</span></span><br><span class="line">vim Dockerfile</span><br><span class="line">    FROM centos</span><br><span class="line">    RUN buildDeps='wget gcc make apr-devel apr apr-util apr-util-devel pcre-devel' \</span><br><span class="line">    # 这一步非常重要，如果不将要安装的包定义在变量中，下面的yum命令将无法进行，yum会将之后的所有命令都当作要安装的包。</span><br><span class="line">        &amp;&amp; yum install -y $buildDeps \</span><br><span class="line">        &amp;&amp; cd /usr/local/src \</span><br><span class="line">        &amp;&amp; wget http://apache.fayea.com/httpd/httpd-2.4.37.tar.gz \</span><br><span class="line">        &amp;&amp; tar -zxvf httpd-2.4.37.tar.gz \</span><br><span class="line">        &amp;&amp; cd httpd-2.4.37 \</span><br><span class="line">        &amp;&amp; ./configure --prefix=/usr/local/apache2  --enable-mods-shared=most  --enable-so \</span><br><span class="line">        &amp;&amp; make \</span><br><span class="line">        &amp;&amp; make install \</span><br><span class="line">        &amp;&amp; sed -i 's/#ServerName www.example.com:80/ServerName localhost:80/g' /usr/local/apache2/conf/httpd.conf \</span><br><span class="line">        &amp;&amp; /usr/local/apache2/bin/httpd</span><br><span class="line">    COPY run.sh /usr/local/sbin/run.sh</span><br><span class="line">    RUN chmod 755 /usr/local/sbin/run.sh</span><br><span class="line">    EXPOSE 80</span><br><span class="line">    CMD ["/usr/local/sbin/run.sh"]</span><br><span class="line">docker build -t apache_dockerfile1:centos .</span><br><span class="line"></span><br><span class="line">* 测试三</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入构建后的清除动作</span></span><br><span class="line">vim Dockerfile</span><br><span class="line">    FROM centos</span><br><span class="line">    RUN buildDeps='wget gcc make apr-devel apr apr-util apr-util-devel pcre-devel' \</span><br><span class="line">        &amp;&amp; yum install -y $buildDeps \</span><br><span class="line">        &amp;&amp; cd /usr/local/src \</span><br><span class="line">        &amp;&amp; wget http://apache.fayea.com/httpd/httpd-2.4.37.tar.gz \</span><br><span class="line">        &amp;&amp; tar -zxvf httpd-2.4.37.tar.gz \</span><br><span class="line">        &amp;&amp; cd httpd-2.4.37 \</span><br><span class="line">        &amp;&amp; ./configure --prefix=/usr/local/apache2  --enable-mods-shared=most  --enable-so \</span><br><span class="line">        &amp;&amp; make \</span><br><span class="line">        &amp;&amp; make install \</span><br><span class="line">        &amp;&amp; yum clean all \	# 清除所有yum缓存</span><br><span class="line">        &amp;&amp; rm -rf /usr/local/src/httpd-2.4.37.tar.gz \</span><br><span class="line">        &amp;&amp; rm -rf /usr/local/src/httpd-2.4.37 \</span><br><span class="line">        # 删除下载的包</span><br><span class="line">        &amp;&amp; sed -i 's/#ServerName www.example.com:80/ServerName localhost:80/g' /usr/local/apache2/conf/httpd.conf \</span><br><span class="line">        &amp;&amp; /usr/local/apache2/bin/httpd</span><br><span class="line">    COPY run.sh /usr/local/sbin/run.sh</span><br><span class="line">    RUN chmod 755 /usr/local/sbin/run.sh</span><br><span class="line">    EXPOSE 80</span><br><span class="line">    CMD ["/usr/local/sbin/run.sh"]</span><br><span class="line">docker build -t apache_dockerfile2:centos .</span><br><span class="line">docker images</span><br><span class="line">REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">apache_dockerfile2   centos              ad579e67578a        23 minutes ago      304MB</span><br><span class="line">apache_dockerfile1   centos              cce4dadd883f        41 minutes ago      446MB</span><br><span class="line">apache_dockerfile    centos              de4da4d57f3e        About an hour ago   545MB</span><br><span class="line">centos               latest              75835a67d134        7 weeks ago         200MB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到，基础镜像centos只有200M，第一次构建后有545M，减少RUN命令使用后的构建较第一次少了近100M，如果删除缓存与安装包后，镜像较第一次构建少了200多M。</span></span><br><span class="line">root@test:~/apache_centos# docker run -d -p 8000:80 apache_dockerfile2:centos /usr/local/sbin/run.sh</span><br><span class="line">09e9cc066eaf250ea4fa18e8a7755c666d308267dcc3f2e4c40f9d4941fb94c5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建镜像，可以不使用最后的命令，因为与镜像中的命令重复了</span></span><br><span class="line">root@test:~/apache_centos# curl localhost:8000</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 访问测试</span></span><br></pre></td></tr></table></figure>
<h4 id="创建mysql镜像"><a href="#创建mysql镜像" class="headerlink" title="创建mysql镜像"></a>创建mysql镜像</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 测试一</span></span><br><span class="line">* 准备Dockerfile文件</span><br><span class="line">mkdir /root/mysql</span><br><span class="line">cd /root/mysql</span><br><span class="line">vim Dockerfile</span><br><span class="line">    FROM mysql:5.7</span><br><span class="line">    ENV MYSQL_ALLOW_ENPTY_PASSWORD yes</span><br><span class="line">    COPY setup.sh schema.sql privileges.sql /mysql/		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里最后要复制到mysql目录中，mysql后面的斜线一定不能少。</span></span><br><span class="line">    CMD ["sh", "/mysql/setup.sh"]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载mysql:5.7镜像；ENV MYSQL_ALLOW_ENPTY_PASSWORD yes表示可以免密码登录，这是为了方便导入数据，导入后会再设置密码；复制脚本与sql脚本到容器；最后启动容器。这个mysql:5.7是安装在Debian9系统中的</span></span><br><span class="line"></span><br><span class="line">* 准备脚本</span><br><span class="line">vim setup.sh</span><br><span class="line">    #!/bin/bash</span><br><span class="line">    #</span><br><span class="line">    set -e</span><br><span class="line">    echo `service mysql status`</span><br><span class="line">    echo '1. startup mysql...'</span><br><span class="line">    service mysql start</span><br><span class="line">    sleep 3</span><br><span class="line">    echo `service mysql status`</span><br><span class="line">    echo '2. inputing...'</span><br><span class="line">    mysql &lt; /mysql/schema.sql</span><br><span class="line">    echo '3. input OK'</span><br><span class="line">    sleep 3</span><br><span class="line">    echo `service mysql status`</span><br><span class="line">    echo '4. setpassword'</span><br><span class="line">    mysql &lt; /mysql/privileges.sql</span><br><span class="line">    echo '5. setpasswordOK'</span><br><span class="line">    sleep 3</span><br><span class="line">    echo `service mysql status`</span><br><span class="line">    echo 'mysql_container_OK'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动mysql与导入数据。<span class="built_in">set</span> -e表示如果任何语句的执行结果不是<span class="literal">true</span>则应该退出。写这些<span class="built_in">echo</span>是为了之后使用此镜像创建容器时使用docker logs可以查看到相关日志，便于排错。</span></span><br><span class="line">chmod +x setup.sh		# 一定不能忘记给脚本执行权限</span><br><span class="line"></span><br><span class="line">* 准备sql脚本</span><br><span class="line">vim schema.sql</span><br><span class="line">    CREATE database `docker_mysql` default character set utf8 collate utf8_general_ci;</span><br><span class="line"></span><br><span class="line">    USE docker_mysql;</span><br><span class="line"></span><br><span class="line">    DROP TABLE IF EXISTS `user`;</span><br><span class="line"></span><br><span class="line">    CREATE TABLE `user` (</span><br><span class="line">      `id` bigint(20) NOT NULL,</span><br><span class="line">      `created_at` bigint(40) DEFAULT NULL,</span><br><span class="line">      `last_modified` bigint(40) DEFAULT NULL,</span><br><span class="line">      `email` varchar(255) DEFAULT NULL,</span><br><span class="line">      `first_name` varchar(255) DEFAULT NULL,</span><br><span class="line">      `last_name` varchar(255) DEFAULT NULL,</span><br><span class="line">      `username` varchar(255) DEFAULT NULL,</span><br><span class="line">      PRIMARY KEY (`id`)</span><br><span class="line">    ) ENGINE=InnoDB DEFAULT CHARSET=latin1;</span><br><span class="line"></span><br><span class="line">    INSERT INTO `user` (`id`, `created_at`, `last_modified`, `email`, `first_name`, `last_name`, `username`)</span><br><span class="line">    VALUES (0,1490257904,1490257904,'john.doe@example.com','John','Doe','user');</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个docker_mysql库、user表，加入一条测试数据</span></span><br><span class="line">vim privileges.sql</span><br><span class="line">    USE mysql;</span><br><span class="line">    SELECT host, user from user;</span><br><span class="line">    CREATE user docker identified by '123456';</span><br><span class="line">    GRANT all on docker_mysql.* to docker@'%' identified by '123456' with grant option;</span><br><span class="line">    flush privileges;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建用户并设置密码及权限。with grant option表示它具有grant权限</span></span><br><span class="line"></span><br><span class="line">* 构建镜像、启动容器</span><br><span class="line">docker build -t mysqltest:test .</span><br><span class="line"><span class="meta">#</span><span class="bash"> 构建镜像</span></span><br><span class="line">docker images</span><br><span class="line">docker run -d -p 13306:3306 --name testmysql mysqltest:test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建容器，创建容器时最好把库名与标签名都写全</span></span><br><span class="line">docker logs -t 7f78ca1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看日志</span></span><br><span class="line">docker inspect --format '&#123;&#123; .NetworkSettings.IPAddress &#125;&#125;' 7f78ca1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看容器IP地址</span></span><br><span class="line">docker exec -it 7f78ca1 bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入容器</span></span><br><span class="line">mysql -udocker -p123456</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到容器中再进入容器中的mysql</span></span><br><span class="line">SHOW DATABASES;</span><br><span class="line">use docker_mysql</span><br><span class="line">SHOW TABLES;</span><br><span class="line">SELECT * FROM user;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试二</span></span><br><span class="line">mkdir /root/jdycmysql</span><br><span class="line">cd /root/jdycmysql</span><br><span class="line">vim Dockerfile</span><br><span class="line">    FROM mysql:5.7</span><br><span class="line">    ENV MYSQL_ALLOW_ENPTY_PASSWORD yes</span><br><span class="line">    COPY setup.sh echarging.sql user.sql /mysql/</span><br><span class="line">    COPY my.cnf /etc/mysql/</span><br><span class="line">    CMD ["sh", "/mysql/setup.sh"]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 容器中的mysql配置文件在/etc/mysql中，echarging.sql是要用的数据库，user.sql是改密码与权限所用</span></span><br><span class="line">vim setup.sh</span><br><span class="line">    #!/bin/bash</span><br><span class="line">    #</span><br><span class="line">    #set -e</span><br><span class="line">    echo `service mysql status`</span><br><span class="line">    echo '1. startup mysql...'</span><br><span class="line">    service mysql start</span><br><span class="line">    sleep 3</span><br><span class="line">    echo '1.1 createing...'</span><br><span class="line">    /usr/bin/mysql -e "create database echarging"</span><br><span class="line">    echo 'create OK!!!!!!!'</span><br><span class="line">    sleep 3</span><br><span class="line">    echo `service mysql status`</span><br><span class="line">    echo '2. inputing...'</span><br><span class="line">    mysql echarging &lt; /mysql/echarging.sql</span><br><span class="line">    echo '3. input OK'</span><br><span class="line">    sleep 3</span><br><span class="line">    echo `service mysql status`</span><br><span class="line">    echo '4. setpassword'</span><br><span class="line">    mysql &lt; /mysql/user.sql</span><br><span class="line">    echo '5. setpasswordOK'</span><br><span class="line">    sleep 3</span><br><span class="line">    echo `service mysql status`</span><br><span class="line">    echo 'mysql_container_OK'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为<span class="built_in">set</span> -e在返回错误代码时就会退出脚本，所以这里注释了，因为导入数据库时可能会有报错。因为echarging.sql中没有创建数据库的命令，所以这里加入了创建数据库的命令，并且在导入时也指定了数据库，如果不写明这两项，在导入数据库时都会报找不到数据库的错误。</span></span><br><span class="line">vim my.cnf</span><br><span class="line">    [client]</span><br><span class="line">    default-character-set = utf8mb4</span><br><span class="line">    [mysqld]</span><br><span class="line">    init-connect = 'SET NAMES utf8mb4'</span><br><span class="line">    character-set-server = utf8mb4</span><br><span class="line">vim user.sql</span><br><span class="line">    USE mysql</span><br><span class="line">    GRANT all on *.* to echarge@'%' identified by 'CCjd1rj@com' with grant option;</span><br><span class="line">    GRANT all on *.* to root@'%' identified by 'CCjd1rj@com' with grant option;</span><br><span class="line">    flush privileges;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个用户并设置root用户与新建用户的密码与权限。</span></span><br><span class="line">docker build -t jdycm:Jmysql .</span><br><span class="line">docker run -d -p 3306:3306 --name jdycmysql jdycm:Jmysql</span><br><span class="line">watch 'docker logs -t jdycmysql'</span><br><span class="line">    2018-11-30T08:57:34.924250376Z MySQL Community Server 5.7.24 is not running.</span><br><span class="line">    2018-11-30T08:57:34.924304852Z 1. startup mysql...</span><br><span class="line">    2018-11-30T08:57:35.082746075Z 2018-11-30T08:57:35.078891Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timesta</span><br><span class="line">    mp server option (see documentation for more details).</span><br><span class="line">    2018-11-30T08:57:35.281231444Z 2018-11-30T08:57:35.280868Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">    2018-11-30T08:57:35.330693896Z 2018-11-30T08:57:35.330333Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">    2018-11-30T08:57:35.390385937Z 2018-11-30T08:57:35.389987Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has</span><br><span class="line">    been started. Generating a new UUID: fafeea4e-f47d-11e8-87e6-0242ac110003.</span><br><span class="line">    2018-11-30T08:57:35.391824469Z 2018-11-30T08:57:35.391529Z 0 [Warning] Gtid table is not ready to be used. Table 'mysql.gtid_executed' cannot be opened.</span><br><span class="line">    2018-11-30T08:57:35.393019043Z 2018-11-30T08:57:35.392585Z 1 [Warning] root@localhost is created with an empty password ! Please consider switching off the --initiali</span><br><span class="line">    ze-insecure option.</span><br><span class="line">    2018-11-30T08:57:41.396343436Z ..</span><br><span class="line">    2018-11-30T08:57:41.396406084Z MySQL Community Server 5.7.24 is started.</span><br><span class="line">    2018-11-30T08:57:44.399015302Z 1.1 createing...</span><br><span class="line">    2018-11-30T08:57:44.410619098Z create OK!!!!!!!</span><br><span class="line">    2018-11-30T08:57:47.486484333Z MySQL Community Server 5.7.24 is running.</span><br><span class="line">    2018-11-30T08:57:47.486554105Z 2. inputing...</span><br><span class="line">    2018-11-30T09:05:59.990855328Z 3. input OK</span><br><span class="line">    2018-11-30T09:06:03.065787206Z MySQL Community Server 5.7.24 is running.</span><br><span class="line">    2018-11-30T09:06:03.065853836Z 4. setpassword</span><br><span class="line">    2018-11-30T09:06:03.077077343Z 5. setpasswordOK</span><br><span class="line">    2018-11-30T09:06:06.151459148Z MySQL Community Server 5.7.24 is running.</span><br><span class="line">    2018-11-30T09:06:06.151902503Z /mysql/setup.sh: 1: /mysql/setup.sh: mysql_container_OK: not found</span><br><span class="line">    2018-11-30T09:06:06.151989387Z</span><br><span class="line"><span class="meta">#</span><span class="bash"> docker logs的-t选项是显示时间戳的。</span></span><br><span class="line">docker exec -it 901fc12e6e48 bash</span><br><span class="line">mysql</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| echarging          |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use echarging</span></span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show tables;</span></span><br><span class="line">+-----------------------------+</span><br><span class="line">| Tables_in_echarging         |</span><br><span class="line">+-----------------------------+</span><br><span class="line">| area_dictionary             |</span><br><span class="line">| assistant_user              |</span><br><span class="line">| charge_record               |</span><br><span class="line">| communication_board_version |</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/27/docker部署-Nexus3-x使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/27/docker部署-Nexus3-x使用/" itemprop="url">
                  docker部署-Nexus3.x使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-27 08:48:11" itemprop="dateCreated datePublished" datetime="2018-11-27T08:48:11+08:00">2018-11-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-28 14:37:42" itemprop="dateModified" datetime="2018-11-28T14:37:42+08:00">2018-11-28</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ccjd:~# docker run -d --name nexus3 --restart=always -p 8081:8081 -p 8082:8082 --mount src=nexus-data,target=/nexus-data sonatype/nexus3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在后台运行容器，名字叫nexus3，运行了一个restart策略为always的nexus3容器，暴露docker的8081端口为服务器的8081端口，挂载本地的nexus-data目录到容器的/nexus-data目录（这会在本地的/var/lib/docker/volumes中自动创建一个nexus-data目录，在容器中自动创建/nexus-data目录），镜像使用sonatype/nexus3。</span></span><br><span class="line">root@ccjd:~# docker inspect --format '&#123;&#123; .NetworkSettings.IPAddress &#125;&#125;' 48b7fb09c1f8</span><br><span class="line">172.17.0.2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此命令获取docker的IP地址</span></span><br></pre></td></tr></table></figure>
<h3 id="docker命令的–restart选项"><a href="#docker命令的–restart选项" class="headerlink" title="docker命令的–restart选项"></a>docker命令的–restart选项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行容器时使用--restart参数可以指定一个restart策略，来指示在退出时容器应该如何重启或不应该重启。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当容器启用restart策略时，将会在docker ps显示Up或者Restarting状态。也可以使用docker events命令来生效restart策略。</span></span><br><span class="line">docker支持如下restart策略：</span><br><span class="line"></span><br><span class="line">* no – 容器退出时不要自动重启。这个是默认值。</span><br><span class="line">* on-failure[:max-retries] – 只在容器以非0状态码退出时重启。可选的，可以退出docker daemon尝试重启容器的次数。</span><br><span class="line">* always – 不管退出状态码是什么始终重启容器。当指定always时，docker daemon将无限次数地重启容器。容器也会在daemon启动时尝试重启，不管容器当时的状态如何。</span><br><span class="line">* unless-stopped – 不管退出状态码是什么始终重启容器，不过当daemon启动时，如果容器之前已经为停止状态，不要尝试启动它。</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在每次重启容器之前，不断地增加重启延迟[上一次重启的双倍延迟，从100毫秒开始]来防止影响服务器。这意味着daemon将等待100ms,然后200 ms, 400, 800, 1600等等，直到超过on-failure限制，或执行docker stop或docker rm -f。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果容器重启成功[容器启动后并运行至少10秒]，然后delay重置为默认的100ms。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 你可以使用on-failure策略指定docker尝试重启容器的最大次数。默认下docker将无限次数重启容器。可以通过docker inspect来查看已经尝试重启容器了多少次。例如，获取容器“my-container”的重启次数:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker inspect -f <span class="string">"&#123;&#123; .RestartCount &#125;&#125;"</span> my-container</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2</span></span><br><span class="line"></span><br><span class="line">或者获取上一次容器重启时间：</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker inspect -f <span class="string">"&#123;&#123; .State.StartedAt &#125;&#125;"</span> my-container</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2015-03-04T23:47:07.691840179Z</span></span><br><span class="line"></span><br><span class="line">* 示例</span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run --restart=always redis</span></span><br><span class="line">这运行了一个restart策略为always的redis容器，以使得容器退出时,docker将重启它。</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run --restart=on-failure:10 redis</span></span><br><span class="line">这个运行了一个restart策略为on-failure,最大重启次数为10的redis容器。如果redis以非0状态退出连续退出超过10次，那么docker将中断尝试重启这个容器。只有on-failure策略支持设置最大重启次数限制。</span><br></pre></td></tr></table></figure>
<h3 id="配置docker仓库"><a href="#配置docker仓库" class="headerlink" title="配置docker仓库"></a>配置docker仓库</h3><blockquote>
<p>Nexus3 提供了的3种类型的Docker仓库，前两者都可以创建多个仓库，最后一个则可以将他们全部聚合到一个URL来访问。</p>
<ul>
<li>docker (hosted): 自托管</li>
<li>docker (proxy): 代理</li>
<li>docker (group): 聚合</li>
</ul>
</blockquote>
<h4 id="hosted类型"><a href="#hosted类型" class="headerlink" title="hosted类型"></a>hosted类型</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">1. 用浏览器打开192.168.0.198:8081--&gt;点击右上角登录--&gt;点击页面上方的齿轮标志--&gt;点击左侧的Repository中的Bolb Stores创建一个存储块--&gt;点击左侧Repositories--&gt;Create repository--&gt;docker(hosted)--&gt;输入名称；勾选Online，这个开关可以设置这个Docker repo是在线还是离线；选择HTTP并设置创建时用到的8082端口，这是在命令行连接时要用到的端口；勾选Force basic authentication，这样的话就不允许匿名访问了，执行docker pull或 docker push之前，都要先登录：docker login；勾选Docker Registry API Support，Docker registry默认使用的是API v2, 但是为了兼容性，我们可以勾选启用API v1。Storage选择之前创建的存储块设备；Hosted使用默认的Allow redeploy；选择左侧的Security中的Realms，将Docker Bearer Token Realm加入到右侧的Active框中</span><br><span class="line">2. 使用本机的ubuntu16.04测试</span><br><span class="line">root@ccjd:~# vim /lib/systemd/system/docker.service</span><br><span class="line">	[Service]</span><br><span class="line">	...</span><br><span class="line">	ExecStart=/usr/bin/dockerd --insecure-registry 192.168.0.198:8082 -H unix://</span><br><span class="line">	...</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 加入--insecure-registry 192.168.0.198:8082，这里加入的地址必须是宿主机的地址，测试发现如果添加的是docker容器的172地址，在认证时还是会提示<span class="string">"Error response from daemon: Get https://172.17.0.2:8082/v2/: http: server gave HTTP response to HTTPS client"</span></span></span><br><span class="line">root@ccjd:~# systemctl daemon-reload </span><br><span class="line">root@ccjd:~# systemctl restart docker</span><br><span class="line">root@ccjd:~# docker login 192.168.0.198:8082 -u admin -p admin123</span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"><span class="meta">#</span><span class="bash"> 出现Login Succeeded就表示成功了</span></span><br><span class="line">root@ccjd:~# docker tag centos 192.168.0.198:8082/centos</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给现有的centos镜像打一个标签叫192.168.0.198:8082/centos</span></span><br><span class="line">root@ccjd:~# docker image ls</span><br><span class="line">REPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">192.168.0.198:8082/centos   latest              75835a67d134        6 weeks ago         200MB</span><br><span class="line">centos                      latest              75835a67d134        6 weeks ago         200MB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看已有了新的镜像</span></span><br><span class="line">root@ccjd:~# docker push 192.168.0.198:8082/centos</span><br><span class="line">The push refers to repository [192.168.0.198:8082/centos]</span><br><span class="line">f972d139738d: Pushed </span><br><span class="line">latest: digest: sha256:dc29e2bcceac52af0f01300402f5e756cc8c44a310867f6b94f5f7271d4f3fec size: 529</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将镜像推送到本地仓库</span></span><br></pre></td></tr></table></figure>
<h4 id="proxy类型"><a href="#proxy类型" class="headerlink" title="proxy类型"></a>proxy类型</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. 用浏览器打开192.168.0.198:8081--&gt;点击右上角登录--&gt;点击页面上方的齿轮标志--&gt;点击左侧的Repository中的Bolb Stores创建一个存储块。</span><br><span class="line">2. 打开左侧的Repositories--&gt;Create replsitory--&gt;docker(proxy)--&gt;自定义Name；勾选Online；设置http端口；不勾选Force basic authentication；勾选Docker Registry API Support；Remote Storage使用阿里云的加速器地址；Docker Index使用Use proxy registry(specified above)；Storage使用创建的存储块</span><br><span class="line"><span class="meta">#</span><span class="bash"> 勾选Force basic authentication后，proxy仓库的状态会显示在线-正在连接。但下载镜像后状态也不会改变。如果不勾选，下载镜像后会显示在线-远程可用</span></span><br><span class="line">3. 配置</span><br><span class="line">root@ccjd:~# vim /etc/docker/daemon.json</span><br><span class="line">    &#123;</span><br><span class="line">            "registry-mirrors":[</span><br><span class="line">                    "http://192.168.0.198:8083"</span><br><span class="line">            ]</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 改为内部仓库的地址</span></span><br><span class="line">4. 测试</span><br><span class="line">root@ccjd:~# docker pull debian</span><br><span class="line">5. 用浏览器打开192.168.0.198:8081后，点击上面的盒子图标，在左侧的Browse中选择创建的proxy存储块，可以看到我们下载的镜像，这是将镜像持久化存储在块中了。之后如果下载相同的镜像，可以从私有仓库中直接下载。</span><br></pre></td></tr></table></figure>
<h4 id="group类型"><a href="#group类型" class="headerlink" title="group类型"></a>group类型</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1. 创建存储块--&gt;创建group类型库</span><br><span class="line">2. 这里需要注意，在三种类型中都不再选择"Docker Registry API支持"，并修改配置文件，如下：</span><br><span class="line">root@ccjd:~# vim /etc/docker/daemon.json </span><br><span class="line">    &#123;</span><br><span class="line">            "registry-mirrors":["http://192.168.0.130:8083"],</span><br><span class="line">            "insecure-registries":["192.168.0.130:8083","192.168.0.130:8082"],</span><br><span class="line">            "disable-legacy-registry":true</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里第一行定义了group类型的仓库，第二行定义了两个地址为安全地址，可以不用https连接，最后一行定义了关闭<span class="string">"Docker v1 API"</span>，这样就不用在定义三种类型时选择启用Docker v1 API了。</span></span><br><span class="line">3. 测试发现，如果在group类型中一次性加入hosted和proxy类型的两个存储库，那么pull镜像时，proxy类型的库中就不会有反应，去除了hosted类型的库后就可以了。之后再将hosted类型的库加上也没有问题。</span><br><span class="line">4. 官方推荐配置两个Connectors端口，一个配置在docker(group)用来访问所有库，搜索和下载images(group下包含proxy，所以创建proxy仓库的时候可以不设置Connectors-https端口)，另一个配置在docker(hosted)用来push自己的images，使用docker(group)实现搜索和下载images。</span><br><span class="line">The recommended minimal configuration requires one port for a Docker repository group used for read access to all repositories and one port for each hosted Docker repository that will receive push events from your users.</span><br><span class="line">5. 测试</span><br><span class="line">docker login 192.168.0.130:8083 -u admin -p admin123</span><br><span class="line">docker pull centos</span><br><span class="line">再次查看nexus3页面时，在proxy存储块中应该有centos镜像，之后再下载时就可以从私有库中下载了。</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面为三种类型库的配置截图</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/nexus3/dockerblock.jpg" alt=""></p>
<p><img src="/images/nexus3/dockerhosted1.jpg" alt=""></p>
<p><img src="/images/nexus3/dockerhosted2.jpg" alt=""></p>
<p><img src="/images/nexus3/dockerproxy1.jpg" alt=""></p>
<p><img src="/images/nexus3/dockerproxy2.jpg" alt=""></p>
<p><img src="/images/nexus3/dockerproxy3.jpg" alt=""></p>
<p><img src="/images/nexus3/dockergroup1.jpg" alt=""></p>
<p><img src="/images/nexus3/dockergroup2.jpg" alt=""></p>
<h3 id="配置yum仓库"><a href="#配置yum仓库" class="headerlink" title="配置yum仓库"></a>配置yum仓库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">使用nexus3来管理yum仓库相对简单，首先创建存储块，这里共创建了6个，有5个是给每个不同的库使用的，1个是给组用的。之后创建5个不同的proxy类型库，每个库都指向不同的yum源，最后创建一个组来管理这5个库。yum源地址如下：</span><br><span class="line">http://mirrors.aliyun.com/centos/7/os/x86_64</span><br><span class="line">http://mirrors.aliyun.com/centos/7/updates/x86_64</span><br><span class="line">http://mirrors.aliyun.com/centos/7/extras/x86_64</span><br><span class="line">http://mirrors.aliyun.com/centos/7/centosplus/x86_64</span><br><span class="line">http://mirrors.aliyun.com/centos/7/contrib/x86_64</span><br></pre></td></tr></table></figure>
<p><img src="/images/nexus3/yumblock.jpg" alt=""></p>
<p><img src="/images/nexus3/yumRepositories.jpg" alt=""></p>
<p><img src="/images/nexus3/yumproxy1.jpg" alt=""></p>
<p><img src="/images/nexus3/yumproxy2.jpg" alt=""></p>
<p><img src="/images/nexus3/yumgroup.jpg" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/26/ubuntu16-04配置IP地址/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/26/ubuntu16-04配置IP地址/" itemprop="url">
                  ubuntu16.04配置IP地址
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-26 16:21:32 / 修改時間：16:27:36" itemprop="dateCreated datePublished" datetime="2018-11-26T16:21:32+08:00">2018-11-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ubuntu/" itemprop="url" rel="index"><span itemprop="name">ubuntu</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="配置IP"><a href="#配置IP" class="headerlink" title="配置IP"></a>配置IP</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/network/interfaces</span><br><span class="line">    auto eno1</span><br><span class="line">    iface eno1 inet static</span><br><span class="line">    address 10.5.5.198/24</span><br><span class="line"></span><br><span class="line">    auto eno2</span><br><span class="line">    iface eno2 inet static</span><br><span class="line">    address 192.168.0.198/24</span><br><span class="line">    gateway 192.168.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置网卡时，如果有两块网卡，只指定一个网关，不然重启网卡时会报错:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RTNETLINK answers: File exists</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Failed to bring up eth2.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果两块网卡都是dhcp获得地址，就不会有报错的问题</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> auto enp7s0 // 使用的网络接口，之前查询接口是为了这里</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iface enp7s0 inet static // enp7s0这个接口，使用静态ip设置</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> address 10.0.208.222 // 设置ip地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> netmask 255.255.240.0 // 设置子网掩码</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> gateway 10.0.208.1 // 设置网关</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dns-nameservers 10.0.208.1 // 设置dns服务器地址。nameserver也可以写在resolve.conf文件中</span></span><br><span class="line">/etc/init.d/networking restart</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启网卡生效</span></span><br><span class="line">ip addr flush dev eno2 &amp;&amp; /etc/init.d/networking restart</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果重启网卡不能生效，需要使用ip addr flush清除一下网卡的配置，再重启网卡就没问题了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 参考：https://my.oschina.net/zhaomengit/blog/375360</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 参考：https://www.jianshu.com/p/d69a95aa1ed7</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/23/docker学习七：网络/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/23/docker学习七：网络/" itemprop="url">
                  docker学习七：网络
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-23 12:40:12" itemprop="dateCreated datePublished" datetime="2018-11-23T12:40:12+08:00">2018-11-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-02 17:54:11" itemprop="dateModified" datetime="2019-02-02T17:54:11+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="网络功能介绍"><a href="#网络功能介绍" class="headerlink" title="网络功能介绍"></a>网络功能介绍</h3><blockquote>
<p>Docker 允许通过外部访问容器或容器互联的方式来提供网络服务。</p>
</blockquote>
<h4 id="外部访问容器"><a href="#外部访问容器" class="headerlink" title="外部访问容器"></a>外部访问容器</h4><h5 id="映射随机端口"><a href="#映射随机端口" class="headerlink" title="映射随机端口"></a>映射随机端口</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run -d -P --name web1 nginx</span><br><span class="line">e962c7424359a76bb7c185de8acd401616f1854fee9a7768596a020b214aeebf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-P选项可以随机选择一个端口映射到容器中的打开的端口</span></span><br><span class="line">root@ruopu:~# docker container ls -l</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES</span><br><span class="line">58ef89a43297        nginx               "nginx -g 'daemon of…"   About an hour ago   Up About an hour    0.0.0.0:32778-&gt;80/tcp   web1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-l选项只会显示最上面一条运行的容器的信息。可以看到，本地主机的32778端口被映射到了容器的80端口，此时访问本机的32778端口即可访问容器内的80端口</span></span><br><span class="line"></span><br><span class="line">root@ruopu:~# docker logs -f web</span><br><span class="line">192.168.0.89 - - [23/Nov/2018:04:51:29 +0000] "GET / HTTP/1.1" 200 612 "-" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Safari/537.36" "-"</span><br><span class="line">192.168.0.89 - - [23/Nov/2018:04:51:29 +0000] "GET /favicon.ico HTTP/1.1" 404 555 "http://192.168.0.132:32778/" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Safari/537.36" "-"</span><br><span class="line">2018/11/23 04:51:29 [error] 8#8: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 192.168.0.89, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.0.132:32778", referrer: "http://192.168.0.132:32778/"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此命令后，会监听容器的<span class="built_in">log</span>日志，如果有人访问本机的32778端口，日志就会有显示。-f选项表示Follow <span class="built_in">log</span> output，跟踪日志输出。</span></span><br></pre></td></tr></table></figure>
<h5 id="映射所有接口地址"><a href="#映射所有接口地址" class="headerlink" title="映射所有接口地址"></a>映射所有接口地址</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run -d -p 5000:5000 nginx</span><br><span class="line">74a78539f3ae4befc1a272a92432f547ab0476b7a3bcf1800451be292c7ba690</span><br><span class="line">root@ruopu:~# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                            NAMES</span><br><span class="line">74a78539f3ae        nginx               "nginx -g 'daemon of…"   51 seconds ago      Up 51 seconds       80/tcp, 0.0.0.0:5000-&gt;5000/tcp   hungry_leakey</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-p选项，可以指定本地的某端口映射到容器中的某个端口，上面就是映射了本地的5000端口到容器的5000端口。这样定义会监听本地的所有地址。</span></span><br></pre></td></tr></table></figure>
<h5 id="映射到指定地址的指定端口"><a href="#映射到指定地址的指定端口" class="headerlink" title="映射到指定地址的指定端口"></a>映射到指定地址的指定端口</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run -d -p 127.0.0.1:6000:5000 nginx </span><br><span class="line">13221c9107420a3c71a04ae2c6d4bcba8e4ea4c6616863ab085712c38b4821d6</span><br><span class="line">root@ruopu:~# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                              NAMES</span><br><span class="line">13221c910742        nginx               "nginx -g 'daemon of…"   5 seconds ago       Up 5 seconds        80/tcp, 127.0.0.1:6000-&gt;5000/tcp   frosty_agnesi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将本地的回环地址的6000端口映射到容器的5000端口</span></span><br></pre></td></tr></table></figure>
<h5 id="映射到指定地址的任意端口"><a href="#映射到指定地址的任意端口" class="headerlink" title="映射到指定地址的任意端口"></a>映射到指定地址的任意端口</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run -d -p 127.0.0.1::5000 nginx</span><br><span class="line">762d1752599817dc0052080ecdb29543522a0f321bdaaee4ee2495516f92bfe2</span><br><span class="line">root@ruopu:~# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES</span><br><span class="line">762d17525998        nginx               "nginx -g 'daemon of…"   25 seconds ago      Up 25 seconds       80/tcp, 127.0.0.1:32768-&gt;5000/tcp   loving_borg</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将本地的任意端口映射到容器的5000端口，可以看到本地的端口用了32768</span></span><br></pre></td></tr></table></figure>
<h5 id="映射UDP端口"><a href="#映射UDP端口" class="headerlink" title="映射UDP端口"></a>映射UDP端口</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run -d -p 127.0.0.1:4000:5000/udp nginx</span><br><span class="line">1258d3b29d3de4aa8cdf4cced7c2575855d04dc5c53edd6c894bd5670f336e75</span><br><span class="line">root@ruopu:~# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES</span><br><span class="line">1258d3b29d3d        nginx               "nginx -g 'daemon of…"   6 seconds ago       Up 5 seconds        80/tcp, 127.0.0.1:4000-&gt;5000/udp    infallible_aryabhata</span><br></pre></td></tr></table></figure>
<h5 id="查看映射端口配置"><a href="#查看映射端口配置" class="headerlink" title="查看映射端口配置"></a>查看映射端口配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker port web1 80</span><br><span class="line">0.0.0.0:32783</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用port指令可以查看容器内的端口映射到了本地的哪个地址和端口</span></span><br><span class="line">root@ruopu:~# docker container port web 80</span><br><span class="line">0.0.0.0:32771</span><br><span class="line">root@ruopu:~# docker container port web</span><br><span class="line">80/tcp -&gt; 0.0.0.0:32771</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用上面命令也可以显示容器端口的映射情况</span></span><br><span class="line">root@ruopu:~# docker inspect web1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用inspect指令可以获取容器所有的变量</span></span><br></pre></td></tr></table></figure>
<h5 id="绑定多个端口"><a href="#绑定多个端口" class="headerlink" title="绑定多个端口"></a>绑定多个端口</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run -d -p 5001:5000 -p 5002:80 nginx</span><br><span class="line">85ef456480e7bcc0180a07e705a0d8d48c4f4d618ed7fffa5c7474a322dbee98</span><br><span class="line">root@ruopu:~# docker container ls -l</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                          NAMES</span><br><span class="line">85ef456480e7        nginx               "nginx -g 'daemon of…"   9 seconds ago       Up 8 seconds        0.0.0.0:5002-&gt;80/tcp, 0.0.0.0:5001-&gt;5000/tcp   affectionate_bell</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以多次使用-p选项来绑定多个端口</span></span><br></pre></td></tr></table></figure>
<h4 id="容器互联"><a href="#容器互联" class="headerlink" title="容器互联"></a>容器互联</h4><h5 id="新建网络"><a href="#新建网络" class="headerlink" title="新建网络"></a>新建网络</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker network create -d bridge my-net</span><br><span class="line">c2bf630de56e2dc260eef74f0b9afc1e913f97fcef36d37d61025970a081c891</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-d参数指定docker网络类型，有bridge和overlay。其中overlay网络类型用于swarm mode</span></span><br></pre></td></tr></table></figure>
<h5 id="连接容器"><a href="#连接容器" class="headerlink" title="连接容器"></a>连接容器</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run -it --rm --name busybox1 --network my-net busybox sh</span><br><span class="line">Unable to find image 'busybox:latest' locally</span><br><span class="line">latest: Pulling from library/busybox</span><br><span class="line">90e01955edcd: Pull complete </span><br><span class="line">Digest: sha256:2a03a6059f21e150ae84b0973863609494aad70f0a80eaeb64bddd8d92465812</span><br><span class="line">Status: Downloaded newer image for busybox:latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行一个容器连接到新建的my-net网络</span></span><br><span class="line">ruopu@ruopu:~$ docker run -it --rm --name busybox2 --network my-net busybox sh</span><br><span class="line">/ # </span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开一个新终端再创建一个连接my-net网络的容器</span></span><br><span class="line">root@ruopu:~# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                                          NAMES</span><br><span class="line">5097ae5dbbc2        busybox             "sh"                     About a minute ago   Up About a minute                                                  busybox2</span><br><span class="line">c71c2f7646a6        busybox             "sh"                     2 minutes ago        Up 2 minutes                                                       busybox1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开一个新终端查看容器信息</span></span><br><span class="line"></span><br><span class="line">* busybox1</span><br><span class="line">/ # ping busybox2</span><br><span class="line">PING busybox2 (172.18.0.3): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.3: seq=0 ttl=64 time=0.068 ms</span><br><span class="line">64 bytes from 172.18.0.3: seq=1 ttl=64 time=0.074 ms</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在busybox1上ping busybox2，可以ping通，并可以看到busybox2的IP地址</span></span><br><span class="line">/ # cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.18.0.2	711b0a48b174</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在自己的hosts文件中有对本机地址的解析条目</span></span><br><span class="line"></span><br><span class="line">* busybox2</span><br><span class="line">/ # ping busybox1</span><br><span class="line">PING busybox1 (172.18.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.2: seq=0 ttl=64 time=0.048 ms</span><br><span class="line">64 bytes from 172.18.0.2: seq=1 ttl=64 time=0.029 ms</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在busybox2上ping busybox1，可以ping通，并可以看到busybox1的IP地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样,busybox1容器和busybox2容器建立了互联关系。</span></span><br><span class="line">/ # cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.18.0.3	0871d29cd3b4</span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>
<h5 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h5><blockquote>
<p>如果你有多个容器之间需要互相连接，推荐使用Docker Compose</p>
</blockquote>
<h4 id="配置DNS"><a href="#配置DNS" class="headerlink" title="配置DNS"></a>配置DNS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/ # mount</span><br><span class="line">...</span><br><span class="line">/dev/mapper/ubuntu--vg-ubuntu--lv on /etc/resolv.conf type ext4 (rw,relatime,data=ordered)</span><br><span class="line">/dev/mapper/ubuntu--vg-ubuntu--lv on /etc/hostname type ext4 (rw,relatime,data=ordered)</span><br><span class="line">/dev/mapper/ubuntu--vg-ubuntu--lv on /etc/hosts type ext4 (rw,relatime,data=ordered)</span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在容器中使用mount命令可以查看到挂载信息，其中有上面三条，挂载了宿主机的三个文件到容器，当宿主机信息发生改变时，所有Docker容器的配置通过这些文件也随之改变。</span></span><br></pre></td></tr></table></figure>
<h3 id="高级网络配置"><a href="#高级网络配置" class="headerlink" title="高级网络配置"></a>高级网络配置</h3><blockquote>
<p>当 Docker 启动时，会自动在主机上创建一个docker0虚拟网桥，实际上是 Linux 的一个bridge，可以理解为一个软件交换机。它会在挂载到它的网口之间进行转发。<br>同时，Docker 随机分配一个本地未占用的私有网段(在 RFC1918 中定义)中的一个地址给docker0接口。比如典型的172.17.42.1，掩码为255.255.0.0。此后启动的容器内的网口也会自动分配一个同一网段(172.17.0.0/16)的地址。<br>当创建一个 Docker 容器的时候，同时会创建了一对veth pair接口(当数据包发送到一个接口时，另外一个接口也可以收到相同的数据包)。这对接口一端在容器内，即eth0；另一端在本地并被挂载到docker0网桥，名称以veth开头(例如vethAQI2QT)。通过这种方式，主机可以跟容器通信，容器之间也可以相互通信。Docker 就创建了在主机和所有容器之间一个虚拟共享网络。</p>
</blockquote>
<p><img src="/images/docker/dockernet1.jpg" alt=""></p>
<h4 id="快速配置"><a href="#快速配置" class="headerlink" title="快速配置"></a>快速配置</h4><blockquote>
<p>下面是一个跟 Docker 网络相关的命令列表。<br>其中有些命令选项只有在 Docker 服务启动的时候才能配置，而且不能马上生效。</p>
<ul>
<li><p>-b BRIDGE 或 –bridge=BRIDGE：指定容器挂载的网桥</p>
</li>
<li><p>–bip=CIDR：定制 docker0 的掩码</p>
</li>
<li><p>-H SOCKET… 或 –host=SOCKET…：Docker 服务端接收命令的通道</p>
</li>
<li><p>–icc=true|false：是否支持容器之间进行通信</p>
</li>
<li><p>–ip-forward=true|false：转发，请看下文容器之间的通信</p>
</li>
<li><p>–iptables=true|false：是否允许 Docker 添加 iptables 规则</p>
</li>
<li><p>–mtu=BYTES：容器网络中的 MTU</p>
</li>
</ul>
<p>下面2个命令选项既可以在启动服务时指定，也可以在启动容器时指定。在 Docker 服务启动的时候指定则会成为默认值，后面执行 docker run 时可以覆盖设置的默认值。</p>
<ul>
<li><p>–dns=IP_ADDRESS…：使用指定的DNS服务器</p>
</li>
<li><p>–dns-search=DOMAIN…：指定DNS搜索域</p>
</li>
</ul>
<p>最后这些选项只有在 docker run 执行时使用，因为它是针对容器的特性内容。</p>
<ul>
<li>-h HOSTNAME 或 –hostname=HOSTNAME：配置容器主机名</li>
<li>–link=CONTAINER_NAME:ALIAS：添加到另一个容器的连接</li>
<li>–net=bridge|none|container:NAME_or_ID|host：配置容器的桥接模式</li>
<li>-p SPEC 或 –publish=SPEC：映射容器端口到宿主主机</li>
<li>-P or –publish-all=true|false：映射容器所有端口到宿主主机</li>
</ul>
</blockquote>
<h4 id="容器访问控制"><a href="#容器访问控制" class="headerlink" title="容器访问控制"></a>容器访问控制</h4><blockquote>
<p>容器的访问控制，主要通过 Linux 上的iptables防火墙来进行管理和实现。iptables是Linux 上默认的防火墙软件，在大部分发行版中都自带。</p>
</blockquote>
<h5 id="容器访问外部网络"><a href="#容器访问外部网络" class="headerlink" title="容器访问外部网络"></a>容器访问外部网络</h5><blockquote>
<p>容器要想访问外部网络，需要本地系统的转发支持。在Linux 系统中，检查转发是否打开。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">sysctl net.ipv4.ip_forward</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果为 0，说明没有开启转发，则需要手动打开。</span></span><br><span class="line"><span class="meta">$</span><span class="bash">sysctl -w net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果在启动 Docker 服务的时候设定ip_forward，Docker 就会自动设定系统的--ip-forward=<span class="literal">true</span>参数为 1。</span></span><br></pre></td></tr></table></figure>
<h5 id="容器之间访问"><a href="#容器之间访问" class="headerlink" title="容器之间访问"></a>容器之间访问</h5><blockquote>
<p>容器之间相互访问，需要两方面的支持。</p>
<ul>
<li>容器的网络拓扑是否已经互联。默认情况下，所有容器都会被连接到docker0网桥上。</li>
<li>本地系统的防火墙软件 – iptables是否允许通过。</li>
</ul>
</blockquote>
<h5 id="访问所有端口"><a href="#访问所有端口" class="headerlink" title="访问所有端口"></a>访问所有端口</h5><blockquote>
<p>当启动 Docker 服务时候，默认会添加一条转发策略到 iptables 的 FORWARD 链上。策略为通过(ACCEPT)还是禁止(DROP)取决于配置 –icc=true (缺省值)还是 –icc=false。当然，如果手动指定 –iptables=false 则不会添加iptables规则。<br>可见，默认情况下，不同容器之间是允许网络互通的。如果为了安全考虑，可以在 /etc/default/docker 文件中配置 DOCKER_OPTS=–icc=false 来禁止它。</p>
</blockquote>
<h5 id="访问指定端口"><a href="#访问指定端口" class="headerlink" title="访问指定端口"></a>访问指定端口</h5><blockquote>
<p>在通过 -icc=false 关闭网络访问后，还可以通过 –link=CONTAINER_NAME:ALIAS 选项来访问容器的开放端口。</p>
<p>例如，在启动 Docker 服务时，可以同时使用 icc=false –iptables=true 参数来关闭允许相互的网络访问，并让 Docker 可以修改系统中的 iptables 规则。<br>此时，系统中的 iptables 规则可能是类似</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -nL</span></span><br><span class="line">...</span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target prot opt source destination</span><br><span class="line">DROP all 0.0.0.0/0</span><br><span class="line">--</span><br><span class="line">0.0.0.0/0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>之后，启动容器( docker run )时使用 –link=CONTAINER_NAME:ALIAS 选项。Docker 会在 iptable 中为两个容器分别添加一条 ACCEPT 规则，允许相互访问开放的端口(取决于 Dockerfile 中的 EXPOSE 指令)。<br>当添加了 –link=CONTAINER_NAME:ALIAS 选项后，添加了 iptables 规则。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -nL</span></span><br><span class="line">...</span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target prot opt source destination ACCEPT tcp -- 172.17.0.2 172.17.0.3 tcp spt:80</span><br><span class="line">ACCEPT tcp -- 172.17.0.3 172.17.0.2 tcp dpt:80</span><br><span class="line">DROP all -- 0.0.0.0/0 0.0.0.0/0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意: –link=CONTAINER_NAME:ALIAS 中的 CONTAINER_NAME 目前必须是 Docker 分配的名字, 或使用 –name 参数指定的名字。主机名则不会被识别。</p>
</blockquote>
<h5 id="映射容器端口到宿主主机的实现"><a href="#映射容器端口到宿主主机的实现" class="headerlink" title="映射容器端口到宿主主机的实现"></a>映射容器端口到宿主主机的实现</h5><blockquote>
<p>默认情况下，容器可以主动访问到外部网络的连接，但是外部网络无法访问到容器。</p>
</blockquote>
<h4 id="容器访问外部实现"><a href="#容器访问外部实现" class="headerlink" title="容器访问外部实现"></a>容器访问外部实现</h4><blockquote>
<p>容器所有到外部网络的连接，源地址都会被 NAT 成本地系统的 IP 地址。这是使用 iptables 的源地址伪装操作实现的。<br>查看主机的 NAT 规则。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -t nat -nL</span></span><br><span class="line">...</span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target			prot opt source				destination</span><br><span class="line">MASQUERADE		all	--	172.17.0.0/16		!172.17.0.0/16</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其中，上述规则将所有源地址在 172.17.0.0/16 网段，目标地址为其他网段(外部网络)的流量动态伪装为从系统网卡发出。MASQUERADE 跟传统 SNAT相比的好处是它能动态从网卡获取地址。</p>
</blockquote>
<h5 id="外部访问容器实现"><a href="#外部访问容器实现" class="headerlink" title="外部访问容器实现"></a>外部访问容器实现</h5><blockquote>
<p>容器允许外部访问，可以在 docker run 时候通过 -p 或 -P参数来启用。<br>不管用那种办法，其实也是在本地的 iptables 的 nat 表中添加相应的规则。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 使用 -P 时:</span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -t nat -nL</span></span><br><span class="line">...</span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line">target 			prot opt source 			destination</span><br><span class="line">DNAT 			tcp --	0.0.0.0/0			0.0.0.0/0		tcp dpt:49153 to:172.17.</span><br><span class="line">0.2:80</span><br><span class="line"></span><br><span class="line">* 使用 -p 80:80 时:</span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -t nat -nL</span></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line">target 			prot opt source 			destination</span><br><span class="line">DNAT 			tcp -- 0.0.0.0/0			0.0.0.0/0		tcp dpt:80 to:172.17.0.2</span><br><span class="line">:80</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意:</p>
<ul>
<li>这里的规则映射了 0.0.0.0，意味着将接受主机来自所有接口的流量。用户可以通过 -p IP:hostPort:containerPort 或 -p IP::port 来指定允许访问容器的主机上的 IP、接口等，以制定更严格的规则。</li>
<li>如果希望永久绑定到某个固定的 IP 地址，可以在 Docker 配置文件 /etc/docker/daemon.json 中添加如下内容。<br>{<br>“ip”: “0.0.0.0”<br>}</li>
</ul>
</blockquote>
<h4 id="配置-docker0-网桥"><a href="#配置-docker0-网桥" class="headerlink" title="配置 docker0 网桥"></a>配置 docker0 网桥</h4><blockquote>
<p>Docker 服务默认会创建一个 docker0 网桥(其上有一个 docker0 内部接口)，它在内核层连通了其他的物理或虚拟网卡，这就将所有容器和本地主机都放到同一个物理网络。<br>Docker 默认指定了 docker0 接口 的 IP 地址和子网掩码，让主机和容器之间可以通过网桥相互通信，它还给出了 MTU(接口允许接收的最大传输单元)，通常是 1500 Bytes，或宿主主机网络路由上支持的默认值。这些值都可以在服务启动的时候进行配置。</p>
<ul>
<li><p>–bip=CIDR：IP 地址加掩码格式，例如 192.168.1.5/24</p>
</li>
<li><p>–mtu=BYTES：覆盖默认的 Docker mtu 配置</p>
</li>
</ul>
<p>也可以在配置文件中配置 DOCKER_OPTS，然后重启服务。</p>
<p>由于目前 Docker 网桥是 Linux 网桥，用户可以使用 brctl show 来查看网桥和端口连接信息。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo brctl show</span></span><br><span class="line">bridge name 	bridge id 			STP enabled 	interfaces</span><br><span class="line">docker0 		8000.3a1d7362b4ee 	no 				veth65f9</span><br><span class="line">										vethdda6</span><br></pre></td></tr></table></figure>
<blockquote>
<p>*注: brctl 命令在 Debian、Ubuntu 中可以使用 sudo apt-get install bridge-utils 来安装。<br>每次创建一个新容器的时候，Docker 从可用的地址段中选择一个空闲的 IP 地址分配给容器的 eth0 端口。使用本地主机上 docker0 接口的 IP 作为所有容器的默认网关。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo docker run -i -t --rm busybox sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ip addr show eth0</span></span><br><span class="line">24: eth0: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qle</span><br><span class="line">n 1000</span><br><span class="line">    link/ether 32:6f:e0:35:57:91 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.3/16 scope global eth0</span><br><span class="line">    valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::306f:e0ff:fe35:5791/64 scope link</span><br><span class="line">    valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta">$</span><span class="bash"> ip route</span></span><br><span class="line">default via 172.17.42.1 dev eth0</span><br><span class="line">172.17.0.0/16 dev eth0 proto kernel scope link src 172.17.0.3</span><br></pre></td></tr></table></figure>
<h4 id="自定义网桥"><a href="#自定义网桥" class="headerlink" title="自定义网桥"></a>自定义网桥</h4><blockquote>
<p>除了默认的 docker0 网桥，用户也可以指定网桥来连接各个容器。<br>在启动 Docker 服务的时候，使用 -b BRIDGE 或 –bridge=BRIDGE 来指定使用的网桥。<br>如果服务已经运行，那需要先停止服务，并删除旧的网桥。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl stop docker</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt install bridge-utils</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip link <span class="built_in">set</span> dev docker0 down</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo brctl delbr docker0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后创建一个网桥bridge0。</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo brctl addbr bridge0</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip addr add 192.168.5.1/24 dev bridge0</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip link <span class="built_in">set</span> dev bridge0 up</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看确认网桥创建并启动。</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ip addr show bridge0</span></span><br><span class="line">4: bridge0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state UP group default</span><br><span class="line">    link/ether 66:38:d0:0d:76:18 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.5.1/24 scope global bridge0</span><br><span class="line">		valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在 Docker 配置文件 /etc/docker/daemon.json 中添加如下内容，即可将 Docker 默认桥接到创建的网桥上。</span></span><br><span class="line">&#123;</span><br><span class="line">"bridge": "bridge0",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启动 Docker 服务。<br>新建一个容器，可以看到它已经桥接到了 bridge0 上。<br>可以继续用 brctl show 命令查看桥接的信息。另外，在容器中可以使用 ip addr 和 ip route 命令来查看 IP 地址配置和路由信息。</p>
</blockquote>
<h4 id="工具和示例"><a href="#工具和示例" class="headerlink" title="工具和示例"></a>工具和示例</h4><blockquote>
<p>在介绍自定义网络拓扑之前，你可能会对一些外部工具和例子感兴趣:</p>
</blockquote>
<h5 id="pipework"><a href="#pipework" class="headerlink" title="pipework"></a>pipework</h5><blockquote>
<p>Jérôme Petazzoni 编写了一个叫 pipework 的 shell 脚本，可以帮助用户在比较复杂的场景中完成容器的连接。</p>
</blockquote>
<h5 id="playground"><a href="#playground" class="headerlink" title="playground"></a>playground</h5><blockquote>
<p>Brandon Rhodes 创建了一个提供完整的 Docker 容器网络拓扑管理的 Python库，包括路由、NAT 防火墙；以及一些提供 HTTP， SMTP，POP，IMAP，Telnet，SSH，FTP 的服务器。</p>
</blockquote>
<h4 id="编辑网络配置文件"><a href="#编辑网络配置文件" class="headerlink" title="编辑网络配置文件"></a>编辑网络配置文件</h4><blockquote>
<p>Docker 1.2.0 开始支持在运行中的容器里编辑 /etc/hosts , /etc/hostname 和 /etc/resolv.conf文件。<br>但是这些修改是临时的，只在运行的容器中保留，容器终止或重启后并不会被保存下来，也不会被docker commit提交。</p>
</blockquote>
<h4 id="示例：创建一个点到点连接"><a href="#示例：创建一个点到点连接" class="headerlink" title="示例：创建一个点到点连接"></a>示例：创建一个点到点连接</h4><blockquote>
<p>默认情况下，Docker 会将所有容器连接到由docker0提供的虚拟子网中。用户有时候需要两个容器之间可以直连通信，而不用通过主机网桥进行桥接。<br>解决办法很简单：创建一对接口，分别放到两个容器中，配置成点到点链路类型即可。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* 首先启动 2 个容器:</span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -i -t --rm --net=none base /bin/bash</span></span><br><span class="line">root@1f1f4c1f931a:/#</span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -i -t --rm --net=none base /bin/bash</span></span><br><span class="line">root@12e343489d2f:/#</span><br><span class="line"><span class="meta">#</span><span class="bash"> 找到进程号，然后创建网络命名空间的跟踪文件。</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker inspect -f <span class="string">'&#123;&#123;.State.Pid&#125;&#125;'</span> 1f1f4c1f931a</span></span><br><span class="line">2989</span><br><span class="line"><span class="meta">$</span><span class="bash"> docker inspect -f <span class="string">'&#123;&#123;.State.Pid&#125;&#125;'</span> 12e343489d2f</span></span><br><span class="line">3004</span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo mkdir -p /var/run/netns</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ln -s /proc/2989/ns/net /var/run/netns/2989</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ln -s /proc/3004/ns/net /var/run/netns/3004</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一对 peer 接口，然后配置路由</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip link add A <span class="built_in">type</span> veth peer name B</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip link <span class="built_in">set</span> A netns 2989</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip netns <span class="built_in">exec</span> 2989 ip addr add 10.1.1.1/32 dev A</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip netns <span class="built_in">exec</span> 2989 ip link <span class="built_in">set</span> A up</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip netns <span class="built_in">exec</span> 2989 ip route add 10.1.1.2/32 dev A</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip link <span class="built_in">set</span> B netns 3004</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip netns <span class="built_in">exec</span> 3004 ip addr add 10.1.1.2/32 dev B</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip netns <span class="built_in">exec</span> 3004 ip link <span class="built_in">set</span> B up</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ip netns <span class="built_in">exec</span> 3004 ip route add 10.1.1.1/32 dev B</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/23/docker学习六：数据管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/23/docker学习六：数据管理/" itemprop="url">
                  docker学习六：数据管理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-23 09:40:22" itemprop="dateCreated datePublished" datetime="2018-11-23T09:40:22+08:00">2018-11-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-02 16:22:56" itemprop="dateModified" datetime="2019-02-02T16:22:56+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="数据管理"><a href="#数据管理" class="headerlink" title="数据管理"></a>数据管理</h3><h4 id="数据卷-Volumes"><a href="#数据卷-Volumes" class="headerlink" title="数据卷(Volumes)"></a>数据卷(Volumes)</h4><blockquote>
<p>数据卷是一个可供一个或多个容器使用的特殊目录，它绕过UFS，可以提供很多有用的特性：</p>
<ul>
<li>数据卷可以在容器之间共享和重用</li>
<li>对数据卷的修改会立即生效</li>
<li>对数据卷的更新，不会影响镜像</li>
<li>数据卷默认会一直存在，即使容器被删除</li>
</ul>
<p>数据卷的使用，类似于Linux下对目录或文件进行mount，镜像中的被指定为挂载点的目录中的文件会隐藏掉，能显示的是挂载的数据卷</p>
</blockquote>
<h5 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ruopu@ruopu:~$ docker volume  create my-vol</span><br><span class="line">my-vol</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个叫my-vol的卷</span></span><br><span class="line">ruopu@ruopu:~$ docker volume ls  </span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line">local               my-vol</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看所有的数据卷</span></span><br><span class="line">ruopu@ruopu:~$ docker volume inspect my-vol </span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        "CreatedAt": "2018-11-23T01:46:21Z",</span><br><span class="line">        "Driver": "local",</span><br><span class="line">        "Labels": &#123;&#125;,</span><br><span class="line">        "Mountpoint": "/var/lib/docker/volumes/my-vol/_data",</span><br><span class="line">        "Name": "my-vol",</span><br><span class="line">        "Options": &#123;&#125;,</span><br><span class="line">        "Scope": "local"</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看指定数据卷的信息。inspect[<span class="keyword">in</span>ˈspekt]：检查；point[pɔint]：点；mountpoint：挂载点；scope[skəup]：范围</span></span><br><span class="line">root@ruopu:~# ll -h /var/lib/docker/volumes/</span><br><span class="line">total 36K</span><br><span class="line">drwx------  3 root root 4.0K Nov 23 01:46 ./</span><br><span class="line">drwx--x--x 14 root root 4.0K Nov 21 03:40 ../</span><br><span class="line">-rw-------  1 root root  32K Nov 23 01:46 metadata.db</span><br><span class="line">drwxr-xr-x  3 root root 4.0K Nov 23 01:46 my-vol/</span><br></pre></td></tr></table></figure>
<h5 id="启动一个挂载数据卷的容器"><a href="#启动一个挂载数据卷的容器" class="headerlink" title="启动一个挂载数据卷的容器"></a>启动一个挂载数据卷的容器</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ruopu@ruopu:~$ docker run -d -P --name web --mount source=my-vol,target=/webapp nginx </span><br><span class="line">cb192c96fc3232d42e6a33440945e152cd3dd3a20fce95e0a12440b489a822fe</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建容器，-P选项表示让Docker随机映射一个 49000~49900 的端口到内部容器开放的网络端口。<span class="built_in">source</span>指定为外部的数据卷名，target指定容器内的路径，如果容器内没有这个路径，在创建时会自动创建。之后指定从哪个镜像创建。</span></span><br><span class="line">root@ruopu:~# docker exec -it web bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入容器</span></span><br><span class="line">root@fc042722e238:/# ls -l /     </span><br><span class="line">total 72</span><br><span class="line">.......</span><br><span class="line">drwxr-xr-x   1 root root 4096 Nov 12 00:00 usr</span><br><span class="line">drwxr-xr-x   1 root root 4096 Nov 12 00:00 var</span><br><span class="line">drwxr-xr-x   2 root root 4096 Nov 23 01:46 webapp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到容器内根下的webapp目录</span></span><br><span class="line">root@ruopu:~# cp /etc/fstab /var/lib/docker/volumes/my-vol/_data</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在数据卷中还有一个_data目录，要将文件放在这个目录中，这样在容器内的挂载点上就能看到这个文件了。这里将fstab文件放到了_data目录中。</span></span><br><span class="line">root@fc042722e238:/# ls /webapp/</span><br><span class="line">fstab</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在容器内也可以看到这个文件了</span></span><br><span class="line">root@ruopu:~# docker inspect web</span><br><span class="line">...</span><br><span class="line">"Mounts": [</span><br><span class="line">            &#123;</span><br><span class="line">                "Type": "volume",</span><br><span class="line">                "Name": "my-vol",</span><br><span class="line">                "Source": "/var/lib/docker/volumes/my-vol/_data",</span><br><span class="line">                "Destination": "/webapp",</span><br><span class="line">                "Driver": "local",</span><br><span class="line">                "Mode": "z",</span><br><span class="line">                "RW": true,</span><br><span class="line">                "Propagation": ""</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用inspect命令检查web容器的信息，在输出中的Mounts中有数据卷的信息</span></span><br></pre></td></tr></table></figure>
<h5 id="删除数据卷"><a href="#删除数据卷" class="headerlink" title="删除数据卷"></a>删除数据卷</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker volume rm my-vol </span><br><span class="line">Error response from daemon: remove my-vol: volume is in use - [cb192c96fc3232d42e6a33440945e152cd3dd3a20fce95e0a12440b489a822fe, fc042722e2380b62651271fe36a7d4388a50cff2ea2321550ad2953ea46cf4b0]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 直接删除数据卷会有一个错误提示，告知数据卷正在被哪些容器使用，也就是后面中括号中的容器ID。不删除容器，是不能删除数据卷的</span></span><br><span class="line">root@ruopu:~# docker container stop web1</span><br><span class="line">web1</span><br><span class="line">root@ruopu:~# docker container rm web1</span><br><span class="line">web1</span><br><span class="line">root@ruopu:~# docker container rm web</span><br><span class="line">web</span><br><span class="line">root@ruopu:~# docker volume rm my-vol </span><br><span class="line">my-vol</span><br><span class="line">root@ruopu:~# ls /var/lib/docker/volumes/</span><br><span class="line">metadata.db</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除占用数据卷的容器后再删除数据卷就没问题了，再查看本地的相应位置也没有数据卷了</span></span><br><span class="line">root@ruopu:~# docker -v</span><br><span class="line">Docker version 18.09.0, build 4d60db4</span><br><span class="line">root@ruopu:~# docker rm -v web</span><br><span class="line">web</span><br><span class="line">root@ruopu:~# ls /var/lib/docker/volumes/m</span><br><span class="line">metadata.db  my-vol/ </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在18.09.0版本中测试发现，使用<span class="string">"docker rm -v 容器ID"</span>命令并不会删除数据卷。</span></span><br><span class="line"></span><br><span class="line">* 删除无主的数据卷</span><br><span class="line">root@ruopu:~# docker volume create my-vol</span><br><span class="line">my-vol</span><br><span class="line">root@ruopu:~# docker volume inspect my-vol </span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        "CreatedAt": "2018-11-23T03:36:38Z",</span><br><span class="line">        "Driver": "local",</span><br><span class="line">        "Labels": &#123;&#125;,</span><br><span class="line">        "Mountpoint": "/var/lib/docker/volumes/my-vol/_data",</span><br><span class="line">        "Name": "my-vol",</span><br><span class="line">        "Options": &#123;&#125;,</span><br><span class="line">        "Scope": "local"</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">root@ruopu:~# docker volume prune</span><br><span class="line">WARNING! This will remove all local volumes not used by at least one container.</span><br><span class="line">Are you sure you want to continue? [y/N] y</span><br><span class="line">Deleted Volumes:</span><br><span class="line">my-vol</span><br><span class="line"></span><br><span class="line">Total reclaimed space: 0B</span><br><span class="line"><span class="meta">#</span><span class="bash"> prune[pru:n]：修剪</span></span><br><span class="line">root@ruopu:~# docker volume ls </span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line"><span class="meta">#</span><span class="bash"> 先创建一个数据卷，再删除。</span></span><br></pre></td></tr></table></figure>
<h4 id="挂载主机目录-Bind-mounts"><a href="#挂载主机目录-Bind-mounts" class="headerlink" title="挂载主机目录(Bind mounts)"></a>挂载主机目录(Bind mounts)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run -d -P --name web --mount type=bind,source=/etc/init.d,target=/opt/webapp nginx</span><br><span class="line">58ef89a432971bcec8ca0031a69960549d85766b5f42cc40d09e65a662f027c9</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="built_in">type</span>=<span class="built_in">bind</span>将本地的目录挂载到容器中，但用<span class="built_in">source</span>指定的本地目录一定要使用绝对路径，如果本地目录不存在，Docker会报错。</span></span><br><span class="line"></span><br><span class="line">* 以只读方式挂载本地目录</span><br><span class="line">root@ruopu:~# docker run -d -P --name web1 --mount type=bind,source=/etc/init.d,target=/opt/webapp,readonly nginx         </span><br><span class="line">f59500a342675873413040fa09dea6f626df2215430640830fde9e46c1195fc5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建时加入<span class="built_in">readonly</span>，使用户对目录只有只读权限</span></span><br><span class="line">root@10c115755312:/# cd /opt/webapp/</span><br><span class="line">root@10c115755312:/opt/webapp# mkdir a</span><br><span class="line">mkdir: cannot create directory 'a': Read-only file system</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建目录时会有不能创建的提示</span></span><br><span class="line">root@ruopu:~# docker inspect web1|grep Mounts -A 10</span><br><span class="line">            "Mounts": [</span><br><span class="line">                &#123;</span><br><span class="line">                    "Type": "bind",</span><br><span class="line">                    "Source": "/etc/init.d",</span><br><span class="line">                    "Target": "/opt/webapp",</span><br><span class="line">                    "ReadOnly": true</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            "Mounts": [</span><br><span class="line">                &#123;</span><br><span class="line">                    "Type": "bind",</span><br><span class="line">                    "Source": "/etc/init.d",</span><br><span class="line">                    "Destination": "/opt/webapp",</span><br><span class="line">                    "Mode": "",</span><br><span class="line">                    "RW": false,</span><br><span class="line">                    "Propagation": "rprivate"</span><br><span class="line">                &#125;</span><br><span class="line">        	],</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到，上面的ReadOnly是<span class="literal">true</span>，下面的RW是<span class="literal">false</span></span></span><br></pre></td></tr></table></figure>
<h5 id="挂载一个本地主机文件作为数据卷"><a href="#挂载一个本地主机文件作为数据卷" class="headerlink" title="挂载一个本地主机文件作为数据卷"></a>挂载一个本地主机文件作为数据卷</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run --rm -it --mount type=bind,source=$HOME/.bash_history,target=/root/.bash_history ubuntu:14.04 bash</span><br><span class="line">root@4e18204505bf:/# history </span><br><span class="line">    1  apt update</span><br><span class="line">    2  ping www.baidu.com</span><br><span class="line">    3  ip a</span><br><span class="line">    4  ping 192.168.0.1</span><br><span class="line">    5  vim /etc/resolv.conf </span><br><span class="line">    6  ping www.baidu.com</span><br><span class="line">    7  ping 192.168.0.55</span><br><span class="line">    8  vim /etc/network/interfaces </span><br><span class="line">    9  ip a</span><br><span class="line">   10  vim /etc/network/interfaces </span><br><span class="line">   11  systemctl restart networking</span><br><span class="line">   ...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用--mount标记从主机挂载单个文件到容器中，这样就可以记录在容器输入过的命令了，也可以看到本地执行过的命令了</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">142</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">108</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
