<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/18/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/18/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/22/docker学习五：访问Docker仓库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/22/docker学习五：访问Docker仓库/" itemprop="url">
                  docker学习五：访问Docker仓库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-22 16:52:20" itemprop="dateCreated datePublished" datetime="2018-11-22T16:52:20+08:00">2018-11-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-02 15:23:51" itemprop="dateModified" datetime="2019-02-02T15:23:51+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="访问仓库"><a href="#访问仓库" class="headerlink" title="访问仓库"></a>访问仓库</h3><blockquote>
<p>仓库(Repository)是集中存放镜像的地方。<br>一个容易混淆的概念是注册服务器(Registry)。实际上注册服务器是管理仓库的具体服务器，每个服务器上可以有多个仓库，而每个仓库下面有多个镜像。从这方面来说，仓库可以被认为是一个具体的项目或目录。例如对于仓库地址 dl.dockerpool.com/ubuntu来说， dl.dockerpool.com是注册服务器地址，ubuntu是仓库名。</p>
<p>大部分时候，并不需要严格区分这两者的概念。</p>
</blockquote>
<h4 id="Docker-Hub"><a href="#Docker-Hub" class="headerlink" title="Docker Hub"></a>Docker Hub</h4><h5 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h5><blockquote>
<p>你可以在 <a href="https://cloud.docker.com" target="_blank" rel="noopener">https://cloud.docker.com</a> 免费注册一个 Docker 账号</p>
</blockquote>
<h5 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h5><blockquote>
<p>可以通过执行docker login命令交互式的输入用户名及密码来完成在命令行界面登录Docker Hub</p>
</blockquote>
<h5 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker search centos</span><br><span class="line">NAME                               DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span><br><span class="line">centos                             The official build of CentOS.                   4939                [OK]                </span><br><span class="line">ansible/centos7-ansible            Ansible on Centos7                              119                                     [OK]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用search搜索镜像。可以看到返回了很多包含关键字的镜像，其中包括镜像名字、描述、收藏数(表示该镜像的受关注程度)、是否官方创建、是否自动创建。官方的镜像说明是官方项目组创建和维护的，automated 资源允许用户验证镜像的来源和内容。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据是否是官方提供，可将镜像资源分为两类。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一种是类似centos这样的镜像，被称为基础镜像或根镜像。这些基础镜像由 Docker 公司创建、验证、支持、提供。这样的镜像往往使用单个单词作为名字。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 还有一种类型，比如ansible/centos7-ansible镜像，它是由 Docker 的用户创建并维护的，往往带有用户名称前缀。可以通过前缀username/来指定使用某个用户提供的镜像，比如 ansible 用户。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 另外，在查找的时候通过--filter=stars=N参数可以指定仅显示收藏数量为N以上的镜像。</span></span><br><span class="line">root@ruopu:~# docker pull centos</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/centos</span><br><span class="line">aeb7866da422: Pull complete </span><br><span class="line">Digest: sha256:67dad89757a55bfdfabec8abd0e22f8c7c12a1856514726470228063ed86593b</span><br><span class="line">Status: Downloaded newer image for centos:latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用pull命令下载镜像</span></span><br></pre></td></tr></table></figure>
<h5 id="推送镜像"><a href="#推送镜像" class="headerlink" title="推送镜像"></a>推送镜像</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker login </span><br><span class="line">Login with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.</span><br><span class="line">Username: test</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"><span class="meta">#</span><span class="bash"> 登录docker</span></span><br><span class="line">root@ruopu:~# docker tag ubuntu:14.04 test/ubuntu:14.04</span><br><span class="line"><span class="meta">#</span><span class="bash"> 准备要推送的镜像，一定要写为自己docker的username</span></span><br><span class="line">root@ruopu:~# docker image ls</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">test/ubuntu   14.04               f17b6a61de28        2 days ago          188MB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看在本地有了要推送的镜像</span></span><br><span class="line">root@ruopu:~# docker push test/ubuntu:14.04</span><br><span class="line">The push refers to repository [docker.io/test/ubuntu]</span><br><span class="line">85a0d9a0e38e: Mounted from library/ubuntu </span><br><span class="line">fe72fc94fa1a: Mounted from library/ubuntu </span><br><span class="line">ea213108ab36: Mounted from library/ubuntu </span><br><span class="line">960c7c5516b2: Mounted from library/ubuntu </span><br><span class="line">14.04: digest: sha256:296c2904734ac0f13f3ab7265eeafb2efc33f085eeb87c875d28c360cec18700 size: 1152</span><br><span class="line"><span class="meta">#</span><span class="bash"> 推送镜像</span></span><br><span class="line">ruopu@ruopu:~$ docker search test</span><br><span class="line">NAME                DESCRIPTION         STARS               OFFICIAL            AUTOMATED</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询自己上传的镜像，没有结果。可能是因为上传的速度较慢，所以暂时看不到，并且再次上传时提示文件已存在。但登录docker hub后，发现镜像已经上传了。</span></span><br></pre></td></tr></table></figure>
<h5 id="自动创建"><a href="#自动创建" class="headerlink" title="自动创建"></a>自动创建</h5><blockquote>
<p> 自动创建(Automated Builds)功能对于需要经常升级镜像内程序来说，十分方便。<br> 有时候，用户创建了镜像，安装了某个软件，如果软件发布新版本则需要手动更新镜像。而自动创建允许用户通过 Docker Hub 指定跟踪一个目标网站(目前支持 GitHub 或BitBucket)上的项目，一旦项目发生新的提交或者创建新的标签(tag)，Docker Hub 会自动构建镜像并推送到 Docker Hub 中。<br> 要配置自动创建,包括如下的步骤:</p>
<ul>
<li><p>创建并登录 Docker Hub，以及目标网站；</p>
</li>
<li><p>在目标网站中连接帐户到 Docker Hub；</p>
</li>
<li><p>在 Docker Hub 中 配置一个自动创建；</p>
</li>
<li><p>选取一个目标网站中的项目(需要含Dockerfile)和分支；</p>
</li>
<li><p>指定Dockerfile的位置，并提交创建。</p>
</li>
</ul>
<p>之后，可以在 Docker Hub 的自动创建页面中跟踪每次创建的状态。</p>
</blockquote>
<h4 id="私有仓库"><a href="#私有仓库" class="headerlink" title="私有仓库"></a>私有仓库</h4><h4 id="私有仓库高级配置"><a href="#私有仓库高级配置" class="headerlink" title="私有仓库高级配置"></a>私有仓库高级配置</h4><h4 id="Nexus3"><a href="#Nexus3" class="headerlink" title="Nexus3"></a>Nexus3</h4>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/22/dns配置使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/22/dns配置使用/" itemprop="url">
                  dns配置使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-22 10:08:10" itemprop="dateCreated datePublished" datetime="2018-11-22T10:08:10+08:00">2018-11-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-23 09:24:01" itemprop="dateModified" datetime="2018-11-23T09:24:01+08:00">2018-11-23</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li><p>DNS即域名解析；一般網絡上都是用bind（Berkeley Internet Name Domain）軟件實現的</p>
</li>
<li><p>域名：<a href="http://www.magedu.com是主機名或叫FQDN（" target="_blank" rel="noopener">www.magedu.com是主機名或叫FQDN（</a> Full Qualified Domain Name）,譯為完全限定域名，這不能被稱為域名。magedu.com才是域名，com也是域名，因爲它下面包含了magedu等域。</p>
</li>
<li><p>DNS：名稱解析（Name Resolving）；名稱解析就是名稱轉換（背後有查詢過程，所以叫解析，依賴數據庫）</p>
<p>​       FQDN到 IP之間的雙向轉換，DNS提供的是兩者之間的雙向轉換</p>
<p>​       172.16.0.1        <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a>.     </p>
</li>
<li><p>nsswitch：為多種需要提供名稱解析的機制，可以讓別人完成名稱解析。它是提供名稱解析的平台，應用程序到這個框架上找名稱解析的店鋪即可。將DNS解析成IP地址的有兩個，一個是libnss_files和libnss_dns，調用這兩個庫即可。對我們展現的就是一個配置文件，配置文件/etc/nsswitch.conf。服務（如web，telnet，ssh）只需要到nsswitch這個框架上找對應的名稱解析服務就可以了。基於名稱轉換的機制還有NIS</p>
<p>配置文件：nsswitch.conf</p>
<p>格式：hosts : files        dns                 </p>
<p>根據/etc/hosts文件來完成主機名稱到IP地址的轉換的。files指/etc/hosts文件，dns指dns服務，stub resolver被解釋爲最根本的最原始的名稱解析器，它是一個程序，它會根據某個庫調用來完成找nsswitch.conf中的配置，根據nsswitch.conf中的次序先去找files:/etc/hosts裡的文件，查一下有沒有主機名對應的IP，如PING命令在執行時會靠本地的stub resolver完成名稱解析，stub resolver會根據files:/etc/hosts文件找是否有主機名對應的IP，如沒有就找DNS，這就是stub resolver的作用。</p>
<p>轉換的機制叫stub resolver：名稱解析器，它是一個軟件或程序</p>
<p>​       libnss_files.so             libnss_dns.so</p>
</li>
<li><p>早期用hosts文件實現解析</p>
<p>hosts:</p>
<p>​       IP                 FQDN                        Ailases（主機別名）</p>
<p>172.16.0.1    <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a>            www</p>
</li>
</ul>
<p>  a、周期性任務下載hosts文件</p>
<p>  b、之後出現了IANA（互聯網地址名稱分配機構）建的服務器server，由服務器負責轉換地址。互聯網地址名稱分配機構，之後轉由ICANN管理，它管理頂級域。IA在nsswitch中有：</p>
<p>  hosts: files           dns</p>
<p>  NA就負責維護IP與FQDN之間的對應關系的數據庫</p>
<p>  c、分布式數據庫，把DNS從集中的數據庫轉換成分布式數據庫，從最高開始找，主機名是從小到大寫<a href="http://www.magedu.com.，最後的點就是根域，也就是最上層的域，主機名結構從下向上，授權是自上向下的。下級是不知道上級的，但上級是知道直接下級的，但每個人都知道根在哪裡。.net這樣的才叫頂級域或TLD" target="_blank" rel="noopener">www.magedu.com.，最後的點就是根域，也就是最上層的域，主機名結構從下向上，授權是自上向下的。下級是不知道上級的，但上級是知道直接下級的，但每個人都知道根在哪裡。.net這樣的才叫頂級域或TLD</a>(top level domain)。為了節省流量可以將IP與主機名緩存下來。別人是不能用自己的緩存的，這就需要建立一個DNS緩存服務器，第一次由根來查找，由緩存服務器發起一次請求，之後被請求的服務器查找，一級一級地向下傳遞，緩存服務器等待結果，這就是遞歸查找，這會加大根服務器的壓力，但根是不與任何服務器遞歸的；緩存服務器根據提示發起多次請求就是迭代查找，但對於客戶端來講是遞歸查找，對於服務器來講是迭代查找。因為客戶端只向服務器發起一次請求。緩存下來的結果也是非權威答案，只有服務器的上一級給的答案才是權威答案（也就是管理域名的服務器給的答案才是權威答案），緩存時間由上一級來規定，也就是上一級不僅返回答案還返回超時時間，超過時間要重新發起請求，緩存時間的長短會影響主機的性能，時間越長服務器的壓力越小；緩存服務器既要接受本域內的請求，還要接受其他域的查找請求。也就是來自外部的請求查找內部的主機或來自內部的主機查找外部的主機，內部的主機請求查找內部的主機就直接返回結果，而且是權威答案。</p>
<p>  一台服務器可以給多個域進行解析的。那麼它的授權過程是：在根服務器上有一個下級域的數據庫，管理域的是NS（NS（Name Server）记录是<a href="https://baike.baidu.com/item/%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8" target="_blank" rel="noopener">域名服务器</a>记录，用来指定该<a href="https://baike.baidu.com/item/%E5%9F%9F%E5%90%8D" target="_blank" rel="noopener">域名</a>由哪个<a href="https://baike.baidu.com/item/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8" target="_blank" rel="noopener">DNS服务器</a>来进行解析。），在數據庫中有下級域對應的服務器ns名稱及IP，當向根域發起請求後，根域會根據數據庫返回對應的頂級域的IP，如要找.com，根據這個IP找到.com，.com也會根據自己的數據庫返回用戶請求的域的管理主機的IP，這臺管理主機一般也叫NS，如ruopu，這樣再找ruopu這個域的NS服務器，請求查找www主機，如果有就返回IP。這裏NS查找的數據庫就叫授權數據庫，要實現一台服務器管理多個域就需要在授權數據庫中記錄多個域的信息，但不同的域有不同的數據庫，這樣一個IP可以有多個主機名，一個主機名也可以有多個IP，但每次只返回一個，是把多個IP輪流返回的，這就是負載均衡，是DNS的高級功能，但效果較差，他們之間是多對多的關系。</p>
<p>  注：德魯克的扁平化管理</p>
<ul>
<li><p>TLD譯為頂級域分三類，頂級域也叫一級域</p>
<p>​       a、組織域：.com, .org, .net, .cc</p>
<p>​       b、國家域：.cn, .tw, .hk, .iq,</p>
<p>​       c、反向域：IP轉主機名FQDN專用</p>
<p>​              反向：IP –&gt; FQDN</p>
<p>​              正向：FQDN –&gt; IP   正反向用的不是一個數據庫</p>
</li>
<li><font color="red">查詢有兩種方式</font>

<p>​              <font color="red">遞歸：只發出一次請求</font></p>
<p>​              <font color="red">迭代：可能發出多次請求</font></p>
</li>
<li><font color="red">解析：</font>

<p>​              <font color="red">反向：IP –&gt; FQDN</font></p>
<p>​              <font color="red">正向：FQDN –&gt; IP   這兩種用的不是一個數據庫</font></p>
<font color="red">兩段式：第一段是遞歸（客戶端發起），第二段是迭代（服務器查找）</font>
</li>
<li><p>DNS服務器工作</p>
<p>​       a、接受本地客戶端查詢請求（遞歸）</p>
<p>​       b、外部客戶端請求：請求權威答案，如果有就返回肯定答復，沒有就返回一個否定答復，且也有緩存時長（TTL），如果外部客戶端請求非權威答案，這需要設置，但一般不會給外部客戶端遞歸查找的。互聯網上的根、com等是不與任何主機遞歸的，這是為了安全，/etc/resolv.conf（DNS配置文件）文件中填的一定是遞歸的服務器IP，不能給出答案的是沒有用的，一般運營商給的DNS服務器都是遞歸的，不然沒法上網。一般NS只給自己負責的域名遞歸，給權威答案，請求其他的主機都是不給遞歸的</p>
<p>​              肯定答案：TTL值（TTL：存活時間）</p>
<p>​              否定答案：TTL值（存活時間）</p>
</li>
<li><p>根服務器：從a.root-server.net 到m.root-server.net</p>
<p>根服務器掛掉會使世界混亂，要保證絕對的安全。全球共有13台根服務器，13個根是一樣的，任何一台域名服務器數據改變都要多台服務器數據同步，這是自動修改的。如果域內的主機不在線，服務器也會返回相應的結果，只是不能訪問，但如果DNS服務器上沒有記錄的話無論如何也無法訪問。如果DNS服務器掛了，其下的域名是不能訪問的，除非用IP。如果有緩存也可以訪問，但緩存過期就不能訪問。要有兩台服務器保證可以解析，一個出問題，其他可以頂上，這就是主從結構。NS中的數據庫內的信息與信息對應的主機沒有關系，即使主機不在線，NS服務器也會返回查詢結果，只是請求方無法與查詢到的結果建立聯系。但如果NS的數據庫上沒有相關記錄，就算有主機在線，也不能與其聯系。所以服務器與數據庫內的信息應該對應起來。</p>
</li>
<li><p>DNS服務器類型    </p>
<p>DNS服務器主從結構</p>
<p>​       主DNS服務器：在此服務器上完成數據修改</p>
<p>​       輔助DNS服務器：請求數據同步，同步是客戶端請求的，也就是拉取的模式。這是定期同步的，如果改了就同步改了的，沒有就下次再同步</p>
<p>​       主DNS服務器如果掛掉，輔助服務器會定期檢查是否可以同步，如果超時還未恢復，輔助服務器也會掛掉，自殺</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">serial number版本號/序列號       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 定義版本號是為了在同步時如果主DNS與從DNS序列號不一致就證明數據有改變，就同步</span></span><br><span class="line">refresh：檢查時間週期/刷新時期      </span><br><span class="line"><span class="meta">#</span><span class="bash"> 多長時間檢查一次，如果沒有響應，就進入重試時間再檢查，之後如果到了過期時間就認為主DNS掛了</span></span><br><span class="line">retry：重試時間；應小於refresh</span><br><span class="line">expire：重試多久過期</span><br><span class="line">negative ansver TTL：否定答案的緩存時長</span><br><span class="line"><span class="meta">#</span><span class="bash"> 主從服務器要定義這五種屬性</span></span><br></pre></td></tr></table></figure>
<p>緩存DNS服務器，只負責緩存，不負責解析或說不提供任何權威答案；另一種是轉發器，去掉緩存功能就是轉發器，這台服務器可以上互聯網並返回結果，但客戶端不能上互聯網時，或到達某服務器時，可由這台服務器幫助轉發出去</p>
<p>哪台服務器負責解析，由上級指定IP由誰解析，也就是上級授權</p>
<p>數據庫中的每一個條目稱作一個資源記錄（Resource Record簡寫爲RR），靠此記錄來標明服務器的用途，如是DNS服務器還是郵件服務器</p>
</li>
<li><p>主DNS要通知從DNS服務器數據有變更，保證主從一致，這就是區域傳送</p>
<p>區域傳送類型：在未到時間同步時，主服務器通知從DNS服務器來同步</p>
<p>​       完全區域傳送：axfr        # 這是完全同步的</p>
<p>​       增量區域傳送：ixfr        # 只傳送改變的內容</p>
</li>
<li><p>區域類型（傳輸數據時）</p>
<p>​       主區域: master         # 主DNS服務器</p>
<p>​       從區域：slave</p>
<p>​       提示區域：hint         # 定義根在什麼地方</p>
<p>​       轉發區域：forward  # 不找根，直接告訴域在什麼地方，並轉出的</p>
</li>
</ul>
<h4 id="資源記錄"><a href="#資源記錄" class="headerlink" title="資源記錄"></a>資源記錄</h4>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 資源記錄的格式，是橫著寫的，這裡為看清竪寫</span></span><br><span class="line">NAME：名稱</span><br><span class="line">TTL：（可省，如果都一樣的話可在全局定義即可）</span><br><span class="line">IN : internet</span><br><span class="line">RRT：資源記錄類型</span><br><span class="line">VALUE：數據</span><br><span class="line"></span><br><span class="line">*例：</span><br><span class="line">NAME         [TTL]            IN          RRT             VALUE</span><br><span class="line"></span><br><span class="line">www.magedu.com.               IN      A        1.1.1.1                      </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在此條第一項中，www.magedu.com.     最後的點一定要寫，不然會有問題</span></span><br><span class="line"></span><br><span class="line">1.1.1.1                       IN      PTR      www.magedu.com.          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 條爲反向解析，其中的PTR指主機名類型</span></span><br></pre></td></tr></table></figure>
<h4 id="SOA"><a href="#SOA" class="headerlink" title="SOA"></a>SOA</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> SOA(Start Of Authority)起始授權記錄，用於標明一個區域內部主從服務器之間如何同步數據，以及起始授權對象是誰的；數據中的第一條記錄必須是此條，用於標明本區域內多個DNS服務器之間是如何完成數據同步的</span></span><br><span class="line"></span><br><span class="line">ZONE NAME  TTL  IN  SOA  FQDN  ADMINISTRATOR_MAILBOX (</span><br><span class="line">	serial namber                                  </span><br><span class="line"><span class="meta">#</span><span class="bash"> ADMINISTRATOR_MAILBOX指郵箱地址；上面的FQDN是起始授權主機，一般是主DNS服務器地址；serial namber指版本號</span></span><br><span class="line">                    refresh                     </span><br><span class="line">                    retry</span><br><span class="line">                    expire</span><br><span class="line">                    na ttl) </span><br><span class="line"><span class="meta">#</span><span class="bash"> 時間單位可以使用：M（分鍾）、H（小時）、D（天）、W（周）、默認單位是秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 郵箱格式：admin@magedu.com應寫為admin.magedu.com，不能用@，在此@表示當前區域的區域名稱</span></span><br><span class="line"></span><br><span class="line">* 例:</span><br><span class="line">magedu.com.   600   IN   SOA   ns1.magedu.com.  admin.magedu.com.(</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的ZONE NAME寫成@也可，@就表示區域名稱，區域名稱是在配置文件(/etc/named.conf)中定義的；郵件地址不能用@，因@有特殊含義，故用admin.magedu.com.       </span></span><br><span class="line">                         2013040101；    # 2013年4月1日第一版，最長10個數</span><br><span class="line">                         1H              # 一小時刷新一次</span><br><span class="line">                         5M              # 5分鍾重試</span><br><span class="line">                         1W              # 重試一週過期</span><br><span class="line">                         1D)             # 否定回答的TTL值</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這些內容可以不換行，之間用空格隔開即可，也不用加括號了，但不提倡。可以加分號，分號後是注釋，換行才需注釋，一般不用</span></span><br></pre></td></tr></table></figure>
<h4 id="NS"><a href="#NS" class="headerlink" title="NS"></a>NS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> NS: (Name Server)：ZONE NAME（區域名稱） --&gt; FQDN，這是說明哪個區域，它的區域的NS是哪個主機，這裏給的是主機名而非IP，另外還要加一條主機名的IP地址記錄</span></span><br><span class="line"></span><br><span class="line">* 例:</span><br><span class="line">	magedu.com.              600               IN    NS       ns1.magedu.com.</span><br><span class="line">	magedu.com.              600               IN    NS       ns2.magedu.com.</span><br><span class="line">	ns1.magedu.com.     	 600               IN    A        1.1.1.2      </span><br><span class="line"><span class="meta">#</span><span class="bash"> 還要給一個IP，雖然用不上，因爲上級已指定了此域，但有人要查詢時這裏要能返回結果，所以還是要添加此條A記錄；NS服務器的主從在區域文件內定義</span></span><br><span class="line">    ns2.magedu.com.   		 600               IN    A        1.1.1.5</span><br></pre></td></tr></table></figure>
<h4 id="MX"><a href="#MX" class="headerlink" title="MX"></a>MX</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> MX(Mail eXchanger): ZONE NAME --&gt; FQDN（郵件服務器的主機名），格式如下：</span></span><br><span class="line">	ZONE NAME           TTL       IN      MX      pri        VALUE</span><br><span class="line">	magedu.com.         600       IN      MX      10        mail.magedu.com.</span><br><span class="line">	mail.magedu.com.    600       IN      A                  1.1.1.3</span><br><span class="line"><span class="meta">#</span><span class="bash"> pri優先級從0－99，數字越小級別越高；在多台服務器找高優先級的服務器；郵件服務器也要有A記錄</span></span><br></pre></td></tr></table></figure>
<h4 id="A"><a href="#A" class="headerlink" title="A"></a>A</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> A(address)：FQDN--&gt;IPV4  從FQDN（名稱）转换到IPV4（地址）的，主機名轉IP地址的都用A記錄，這是一種最常用的記錄；另一種是AAAA: FQDN --&gt; IPV6</span></span><br></pre></td></tr></table></figure>
<h4 id="PTR"><a href="#PTR" class="headerlink" title="PTR"></a>PTR</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> PTR(pointer指針記錄)：IP --&gt; FQDN，常用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DNS服務器的主從一般是在配置文件的區域內部定義的，定義區域時指明</span></span><br></pre></td></tr></table></figure>
<h4 id="CNAME"><a href="#CNAME" class="headerlink" title="CNAME"></a>CNAME</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> CNAME(Canonical NAME)正式名稱，此名叫別名記錄：FQDN --&gt; FQDN，標示別名是誰</span></span><br><span class="line">www2.magedu.com.             IN      CNAME         www.magedu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> www2是後面www的別名，www是www2的正式名稱</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以下三種是其他的記錄格式，可查詢其意思</span></span><br><span class="line">TXT                     </span><br><span class="line">CHAOS</span><br><span class="line">SRV</span><br></pre></td></tr></table></figure>
<h4 id="域和區域"><a href="#域和區域" class="headerlink" title="域和區域"></a>域和區域</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">域：Domain，邏輯概念</span><br><span class="line">區域：Zone，物理概念</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解析有正向與反向，使用不同的數據庫，這就有了正向區域與反向區域，兩個區域在一起組成了域，域不是存儲的，區域才是。區域與域沒有必然的包含關系，一個域中包含區域，但域的授權又是來自上級的區域所以沒法分清，但正反向的授權是從上級不同的區域而來。</span></span><br><span class="line"></span><br><span class="line">* 例:以magedu.com.    192.168.0.0/24為例</span><br><span class="line">.com                                         # 舉例在.com中已得到授權，下面兩條是授權記錄</span><br><span class="line">magedu.com.            IN          NS         ns.magedu.com.</span><br><span class="line">ns.magedu.com.         IN          A          192.168.0.10</span><br><span class="line"> </span><br><span class="line">www                   192.168.0.1             # 這是要在DNS服務器上做的記錄</span><br><span class="line">mail                  192.168.0.2         MX</span><br><span class="line"> </span><br><span class="line">* 建立兩個區域文件：按規化手動寫入</span><br><span class="line">* 正向區域文件（主機名可寫成@）</span><br><span class="line">	magedu.com. (@)      	IN          SOA             # 無論正反向第一條都要是此條</span><br><span class="line">	www.magedu.com.         IN          A           192.168.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以簡寫為(簡寫主機名不加點，全寫一定要加點)</span></span><br><span class="line">	www                          IN          A           192.168.0.1</span><br><span class="line">	</span><br><span class="line">* 反向區域文件</span><br><span class="line">	0.168.192.in-addr.arpa.（這裡要寫網段地址，反寫，後面是特定後綴）IN       SOA</span><br><span class="line">                            0.168.192.in-addr.arpa.最後的點不能少</span><br><span class="line">                            </span><br><span class="line">* PTR記錄格式</span><br><span class="line">	1. 0.168.192.in-addr.arpa.        IN          PTR              www.magedu.com.(這個主機名不能簡寫，因爲簡寫時補的是區域名，這裏的區域名是0.168.192.in-addr.arpa.)</span><br><span class="line">	1            IN                 PTR                            www.magedu.com.  (這是上一條的簡寫，因為1後面沒有點，所以會補全上面0.168.192開頭的格式)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 正反向的格式除了區域名稱外，都是相同的</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MX記錄只定義在正向區域中，反向不需要；NS記錄正反向都要；A記錄只能定義在正向；PTR只能定義在反向</span></span><br></pre></td></tr></table></figure>
<h3 id="安装与使用"><a href="#安装与使用" class="headerlink" title="安装与使用"></a>安装与使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">* 例：測試</span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line">有域magedu.com.                   172.16.100.0/24</span><br><span class="line">有如下服務器</span><br><span class="line">ns    172.16.100.1   # ns指的就是DNS服務器</span><br><span class="line">www     172.16.100.1, 172.16.100.3</span><br><span class="line">mail              172.16.100.2</span><br><span class="line">ftp是www主機的別名</span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line"> </span><br><span class="line">DNS軟件:BIND Berkeley（博客利） Internet Name Domain，互聯網上用的最多的DNS軟件</span><br><span class="line">www.isc.org 互聯網系統協會，在此下載BIND軟件，是一個源碼包，紅帽上也有rpm包</span><br><span class="line"> </span><br><span class="line">bind-libs包是庫文件包，軟件需要依賴此包運行；bind-utils包是工具包，一般要用utils包就需要libs包。bind-utils中有dig host nslookup nsupdate等常用工具</span><br><span class="line"> </span><br><span class="line">A. bind97(服務器版)</span><br><span class="line">1. bind主配置文件/etc/named.conf，主要用於定義BIND進程的工作屬性，區域的定義；</span><br><span class="line"> </span><br><span class="line">2. /etc/rndc.key（rndc: Remote Name Domain Controller）這是遠程名稱服務控制器，是遠程控制DNS服務器進程可以啟動、關閉、重新裝載等功能的常用命令，rndc.key是讓rndc可以遠程工作的密鑰文件，bind用的是/etc/rndc.conf文件；key中只是密鑰，而conf中還有配置信息，.key和.conf文件一般有一個就可以工作。</span><br><span class="line"> </span><br><span class="line">3. 還要有區域數據文件，用來查詢主機名與IP之間轉換的規則。默認是自己創建的，在/var/named下，名字自己定義</span><br><span class="line"> </span><br><span class="line">4. 還有一個服務腳本</span><br><span class="line">/etc/rc.d/init.d/named &#123;start|stop|restart|status|reload|configtest&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> reload 重讀配置文件和數據文件但不用重啟服務；configtest測試語法錯誤，97版本不支持</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">bind</span>的二進制程序（启动脚本）叫named，只是軟件包的名字叫<span class="built_in">bind</span></span></span><br><span class="line"> </span><br><span class="line">5. devel包是在創建開發環境時使用，一般運維不需要安裝，除非創建開發環境。可以不裝</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用yum info bind97-devel查看此軟件包的信息。</span></span><br><span class="line"> </span><br><span class="line">6. bind-chroot包：</span><br><span class="line">	默認情況bind運行在根/下，有人劫持服務器named進程時，任何運行這個進程的用戶的權限攻擊者都可獲取。運行此進程的用戶是named組也是named，這個用戶和組雖不能登陸系統，但這個用戶named能到達的位置，攻擊者也能到達了。這很不安全。</span><br><span class="line">	這可以把運行named依賴的文件搬到一個假的根下，這樣就可防止上述問題了。如下，很多服務都可以通過這種方式提高安全性，但之後的路徑都要以/var/named/chroot/為根，配置會復雜一些，在這裡不要輕易使用chroot,建議不要裝此包，因爲不熟悉，會改變目錄結構</span><br><span class="line">	/var/named/chroot/           </span><br><span class="line">		etc/named.conf</span><br><span class="line">		etc/rdnc.key</span><br><span class="line">		sbin/named</span><br><span class="line">		var/named   </span><br><span class="line"> </span><br><span class="line">7. caching-nameserver包，能讓DNS成為緩存DNS服務器，這是一個快速建立緩存服務器的工具。這裏不安裝。</span><br><span class="line"></span><br><span class="line">8. 配置DNS服務器過程：</span><br><span class="line">先配置成緩存服務器 --&gt; 然後是主服務器 --&gt; 從服務器</span><br><span class="line"></span><br><span class="line">B、安裝配置過程</span><br><span class="line">1. 安裝bind97</span><br><span class="line">rpm -ql bind97</span><br><span class="line">/etc/rc.d/init.d/named			# 服務腳本</span><br><span class="line">/etc/rndc.conf					# rndc的配置文件</span><br><span class="line">/etc/rndc.key</span><br><span class="line">	/etc/sysconfig/named</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 服務腳本的配置文件，這裏還有很多服務腳本配置文件，gen表示generation，生成之意</span></span><br><span class="line">/usr/sbin/named					# 主程序</span><br><span class="line">	/usr/sbin/named-checkconf	# 檢查配置文件中的語法錯誤</span><br><span class="line">	/usr/sbin/named-checkzone	# 檢查區域文件中的語法錯誤</span><br><span class="line">	/usr/sbin/named-compilezone     	# 編譯區域文件</span><br><span class="line">/usr/sbin/rndc 					# 遠程控制工具</span><br><span class="line">	/usr/sbin/rndc-confgen</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 幫助生成/etc/rndc.conf配置文件的，gen表示生成</span></span><br><span class="line">/var/named/named.ca				# 這些是var下的區域數據文件</span><br><span class="line">/var/named/named.empty</span><br><span class="line">/var/named/named.localhost</span><br><span class="line">/var/named/named.loopback</span><br><span class="line"> </span><br><span class="line">C. 配置文件</span><br><span class="line">1. /etc/named.conf中的內容，這是官方的示例</span><br><span class="line">	options</span><br><span class="line">    # 全局選項，對下面的設置都生效</span><br><span class="line">    logging </span><br><span class="line">    # 定義如何生成與保存日志</span><br><span class="line">    zone             </span><br><span class="line">    # 定義區域</span><br><span class="line">    include </span><br><span class="line">    # 把其他文件包含進來，這意味著這個文件分成片了，而且還有文件在/etc/named.rfc1912.zones中，這個文件中都是區域的定義，這些定議可以與named.conf寫在一個文件中，需要用include包含進去</span><br><span class="line"> </span><br><span class="line">2. /var/named/named.ca中定義了根服務器的地址13個，有些主機有多個地址，如果沒有這個文件也可自己生成，用dig (Domain information gropher)命令，用dig -t NS .命令查找根域的NS記錄，也就是根域的所有DNS服務器，這時的前提是可以訪問互聯網或可以修改/etc/resolv.conf中的nameserver爲內網中可上網的DNS服務器。-t是指定資源記錄類型，並指明通過哪個服務器來查詢就能得到結果。還可以dig -t NS . @a.root-servers.net，指明通過哪台主機來找，這表示不借助本地服務器，而是通過根服務器來找，但也要可以聯網。</span><br><span class="line"></span><br><span class="line">3. /var/named/named.localhost是本地主機，將localhost解析成127.0.0.1的，為了必免DNS服務器配置錯誤，將localhost解析成一個正常地址，使每個主機可以通過localhost訪問本機，這是特別定義的。</span><br><span class="line"></span><br><span class="line">4. /var/named/named.loopback用於將127.0.0.1解析成localhost</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上述兩配置文件是本地主機名的正反向解析。</span></span><br><span class="line"> </span><br><span class="line">5. service named start            # 啓動</span><br><span class="line"></span><br><span class="line">6. DNS監聽的協議及端口：53/udp,53/tcp。除同步數據時用tcp傳輸，默認查詢時都通過UDP的53號端口，速度快。 953/tcp是rndc監聽的</span><br><span class="line"> </span><br><span class="line">7. 配置文件</span><br><span class="line">/etc/named.conf</span><br><span class="line">    options &#123;</span><br><span class="line">		listen-on port 53 &#123; 127.0.0.1; &#125;;                 </span><br><span class="line">    	# 監聽在哪個地址的哪個端口，這裏監聽的是127.0.0.1，所以不能接受遠程主機的查詢請求</span><br><span class="line">		listen-on-v6 port 53 &#123; ::1; &#125;;               </span><br><span class="line">        # 是否監聽IPv6端口</span><br><span class="line">        directory       "/var/named";          </span><br><span class="line">        # 數據文件位置</span><br><span class="line">        dump-file       "/var/named/data/cache_dump.db";</span><br><span class="line">        statistics-file "/var/named/data/named_stats.txt";</span><br><span class="line">        memstatistics-file "/var/named/data/named_mem_stats.txt";</span><br><span class="line">        allow-query     &#123; localhost; &#125;;</span><br><span class="line">        # 只允許誰來查詢</span><br><span class="line">        recursion yes;          </span><br><span class="line">        # 是否遞歸</span><br><span class="line"></span><br><span class="line">        dnssec-enable yes;</span><br><span class="line">        dnssec-validation yes;</span><br><span class="line">        dnssec-lookaside auto;</span><br><span class="line"></span><br><span class="line">        /* Path to ISC DLV key */</span><br><span class="line">        bindkeys-file "/etc/named.iscdlv.key";</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">8. SOCKET：套接字就是IP加端口號   IP:PORT</span><br><span class="line">	套接字的主要目的就是通過此機制讓位於兩個主機上的不同進程能夠通信的。很多軟件是C/S架框的，套接字就是讓客戶端知道到哪去請求服務器端服務的，因此每個服務器只要想讓位於兩個不同主機端可以通訊，服務器端就要監聽在某個位置，這個位置就是套接字，服務器端監聽在套接字上作為訪問入口。127.0.0.1:53是回環地址，如果監聽在此套接字上，訪問的只能是127的地址，也就是本機。要監聽在外網的地址上才能接受來自其他主機的請求，端口如果沒有監聽是不能響應的。如果有多個地址也可以把每個地址與端口寫清或用0.0.0.0:53代表所有IP的53號端口，或可以不寫地址。這是named.conf文件中options中listen-on中指定的監聽的IP，options中的內容是bind服務器配置文件中選項中可使用的指令加對應的值，或參數和對應值。zone會受其控制，全局選項中最重要的是directory一項，它定義了數據文件目錄，只要告訴DNS服務器到哪找數據即可，其他都可不定義。這裡我們自己建一個。此文件權限是640</span><br><span class="line"> </span><br><span class="line">D. 創建配置文件</span><br><span class="line">1. mv /etc/named.conf /etc/named.conf.orig</span><br><span class="line"></span><br><span class="line">2. vim /etc/named.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此文件的語法是每一個完整的語句要用分號結尾，花括號前後要有空格，只要不在同一行中，如果花括號後沒有內容或為分號沒關系</span></span><br><span class="line">		options &#123;                                        </span><br><span class="line">			directory              “/var/named”;</span><br><span class="line">		&#125;；</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 區域的定義方法：任何時候DNS服務器只要能夠解析除了自己權威的或負責的區域以外的其他區域，都必須能夠提交給根的；解析其他區域要給根；<span class="built_in">type</span>指區域類型，指明是什麼區域</span></span><br><span class="line"> </span><br><span class="line">		zone “ZONE NAME” IN &#123;</span><br><span class="line">       		type &#123;master主|slave從|hint根|forward轉發&#125;</span><br><span class="line">		&#125;;</span><br><span class="line"> </span><br><span class="line">a、主區域</span><br><span class="line">如果是主區域還要定義路徑</span><br><span class="line">       file “區域數據文件”</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用file定義區域文件位置，可以使用相對路徑，是相對上面定義的directory的路徑而言</span></span><br><span class="line"> </span><br><span class="line">b. 從區域</span><br><span class="line">如果是從區域還要定義路徑，只是數據文件是同步來的，不用建立</span><br><span class="line">	   file “區域數據文件”；          </span><br><span class="line">       masters &#123; master1_ip; &#125;； </span><br><span class="line"><span class="meta">#</span><span class="bash"> 定義主DNS服務器地址，最後要加分號，外面結尾要加分號，master1_ip指主DNS服務器地址，可以是多個</span></span><br><span class="line"> </span><br><span class="line">c. 根區域</span><br><span class="line">根區域與主區域一樣，只是類型是hint</span><br><span class="line"> </span><br><span class="line">        zone “.” IN &#123;</span><br><span class="line">               type hint;</span><br><span class="line">               file “named.ca”; 			# 這個文件是自動生成的</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone “localhost” IN &#123;</span><br><span class="line">               type master;</span><br><span class="line">               file “named.localhost”;		# 本地正向</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone “0.0.127.in-addr.arpa” IN &#123;</span><br><span class="line">               type master;</span><br><span class="line">               file “named.loopback”;		# 本地反向</span><br><span class="line">        &#125;</span><br><span class="line">        注：上述內容就可創建一個緩存服務器了</span><br><span class="line"> </span><br><span class="line">3. chown root.named /etc/named.conf              </span><br><span class="line"><span class="meta">#</span><span class="bash"> 改變所屬用戶與所屬組</span></span><br><span class="line"></span><br><span class="line">4. chmod 640 /etc/named.conf                  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 改權限</span></span><br><span class="line"></span><br><span class="line">5. named-checkconf       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 檢查主配置文件語法，不報信息表示沒問題</span></span><br><span class="line"></span><br><span class="line">6. named-checkzone "." /var/named/named.ca</span><br><span class="line"><span class="meta">#</span><span class="bash"> 檢查區域文件是否有問題，在命令後指定區域是根，再指明根區域的配置文件路徑。結果提示zone ./IN: not loaded due to errors.也沒有問題</span></span><br><span class="line"></span><br><span class="line">7. named-checkzone "localhost" /var/named/named.localhost</span><br><span class="line"></span><br><span class="line">8. named-checkzone "0.0.127.in-addr.arpa" /var/named/named.loopback</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或可用service named configtest代替上面的三條命令，在bind97中沒有此命令</span></span><br><span class="line"></span><br><span class="line">9. service named start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 啓動</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以查看/var/<span class="built_in">log</span>/messages文件，看一下服務器啟動的日志</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 另外要確保selinux不要啓動</span></span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line">在mint8安裝並配置了bind9成緩存服務器，運行正常</span><br><span class="line">1. apt install bind9</span><br><span class="line"></span><br><span class="line">2. vim /etc/bind/named.***          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件都在這裏，但是分幾個文件寫的</span></span><br><span class="line"></span><br><span class="line">3. /etc/init.d/bind9 start          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 啓動bind9</span></span><br><span class="line">4. vim /etc/bind/named.conf.options</span><br><span class="line">	allow-recursion &#123;192.168.1.0/24;  192.168.5.2; &#125;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打開全局設置，加入上面一行，表示可以給1.0網絡遞歸，這時1.0網段主機就可用此DNS緩存服務器了。如果要給本機遞歸，要加上自己所在的網段或給127.0.0.1放行，但這裏測試127網段失敗）</span></span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line">10. /etc/init.d/bind9 reload</span><br><span class="line">	 </span><br><span class="line">11. netstat -tlunp             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是否有53號端口被監聽</span></span><br><span class="line"></span><br><span class="line">12. 測試上面建立的緩存服務器</span><br><span class="line"><span class="meta">#</span><span class="bash"> 將DNS改成本服務器</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 啟動DNS服務器</span></span><br><span class="line">	dig -t NS . @a.root-servers.net.             </span><br><span class="line"><span class="meta">	#</span><span class="bash"> 測試能否找到根</span></span><br><span class="line">	</span><br><span class="line">13. chkconfig --list named</span><br><span class="line"></span><br><span class="line">14. chkconfig named on</span><br></pre></td></tr></table></figure>
<h4 id="配置文件与正向区域配置"><a href="#配置文件与正向区域配置" class="headerlink" title="配置文件与正向区域配置"></a>配置文件与正向区域配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">* 實現互聯網上的DNS服務器功能</span><br><span class="line">1. vim /etc/named.conf</span><br><span class="line">        options &#123;</span><br><span class="line">                directory       "/var/named";</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone "." IN &#123;</span><br><span class="line">                type hint;</span><br><span class="line">                file "named.ca";</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone "localhost" IN &#123;</span><br><span class="line">                type master;</span><br><span class="line">                file "named.localhost";</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone "0.0.127.in-addr.arpa" IN &#123;</span><br><span class="line">                type master;</span><br><span class="line">                file "named.loopback";</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone "mageedu.com" IN &#123;</span><br><span class="line">                type master;</span><br><span class="line">                file "mageedu.com.zone";             </span><br><span class="line">                # 自定义文件mageedu.com.zone</span><br><span class="line">        &#125;;                 </span><br><span class="line">        # &#125;與；間沒有空格</span><br><span class="line"></span><br><span class="line">named-checkconf       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 此命令只能檢查語法錯誤，不能查邏輯錯誤</span></span><br><span class="line"> </span><br><span class="line">2. vim /var/named/mageedu.com.zone</span><br><span class="line"><span class="meta">	$</span><span class="bash">TTL    600           </span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> 因為是定義全局的值所以要加$號</span></span><br><span class="line">	mageedu.com.    IN    SOA     ns1.mageedu.com.  admin.mageedu.com. (</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 上面的域名可用@代替，因爲在主配置文件中已定義了；主DNS服務器的名字是ns1.mageedu.com. 一個IP可以有多個主機名，一個主機名也可有多個IP</span></span><br><span class="line">						  2016061301</span><br><span class="line">          				  1H</span><br><span class="line">                          5M</span><br><span class="line">                          2D</span><br><span class="line">                          6H)</span><br><span class="line">mageedu.com.    IN      NS      ns1 		# 第一個區域名稱如果與上面一樣可不寫</span><br><span class="line">                IN      MX  10  mail</span><br><span class="line">ns1             IN      A       192.168.5.4</span><br><span class="line">mail            IN      A       192.168.5.5</span><br><span class="line">www             IN      A       192.168.5.4</span><br><span class="line">www             IN      A       192.168.5.6</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這裏只寫www，是因爲省略了域名</span></span><br><span class="line">ftp             IN      CNAME   www                </span><br><span class="line"><span class="meta">#</span><span class="bash"> 別名這裏指的一定是名字，而不是地址</span></span><br><span class="line"> </span><br><span class="line">3. chmod 640 mageedu.com.zone</span><br><span class="line"></span><br><span class="line">4. chown root:named mageedu.com.zone</span><br><span class="line"></span><br><span class="line">5. named-checkzone “mageedu.com” /var/named/mageedu.com.zone</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将DNS改为当前的主机，vim /etc/resolv.conf --&gt; nameserver 192.168.1.107</span></span><br></pre></td></tr></table></figure>
<h4 id="dig命令"><a href="#dig命令" class="headerlink" title="dig命令"></a>dig命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">1. 用dig命令測試</span><br><span class="line">* 语法：</span><br><span class="line">dig -t RT NAME </span><br><span class="line"><span class="meta">#</span><span class="bash"> NAME與RT要配合起來，這是根據RT的類型找NAME對應的值</span></span><br><span class="line">dig -x IP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根據IP查FQDN（主機名）</span></span><br><span class="line"></span><br><span class="line">* 例：</span><br><span class="line">dig -t A www.mageedu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 找A記錄，對應的就是相應類型如A記錄一行中的IP的值，這就是根據屬性的名稱找對應的值，也就是取IP地址的</span></span><br><span class="line">dig -t NS mageedu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查這個域的DNS服務器是誰的，最後一定是一個名稱，而不能是IP地址</span></span><br><span class="line">dig -t RT NAME @IP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加@表示直接到DNS服務器上查找，@IP就是指明DNS服務器地址的</span></span><br><span class="line"> </span><br><span class="line">2. dig命令返回的結果</span><br><span class="line">dig -t A www.mageedu.com返回結果如下：</span><br><span class="line">    QUESTION SECTION:         </span><br><span class="line">    # 提出的問題是什麼</span><br><span class="line">    ANSWER SECTION:            </span><br><span class="line">    # 答案</span><br><span class="line">    AUTHORITY SECTION</span><br><span class="line">    # 誰是提出問題的主機名的權威服務器</span><br><span class="line">    ADDITIONAL SECTION     </span><br><span class="line">    # 補充段，與上一項（權威服務器）NS記錄對應的A記錄</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因爲給web服務配置了兩個地址，所以返回的兩個值每次都會對調，這就是負載均衡了</span></span><br><span class="line">dig -t CNAME ftp.mageedu.com                               </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查別名</span></span><br><span class="line">dig -t NS mageedu.com                                              </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查NS記錄</span></span><br><span class="line">dig -t MX mageedu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面是正向解析的方法；</span></span><br><span class="line">dig -t SOA mageedu.com</span><br><span class="line"></span><br><span class="line">3. 跟踪</span><br><span class="line">vim /etc/resolv.conf</span><br><span class="line">	nameserver 114.114.114.114</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里一定要改为公网的DNS，默认这里是127.0.0.53,虽然也可以访问公网，但使用下面命令时就不行了，因为dig会不断访问公网的DNS询问答案。</span></span><br><span class="line">dig +trace www.sina.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> dig会一直询问公网DNS，之后再到根域，一级域，二级域不断询问要查找的地址。</span></span><br></pre></td></tr></table></figure>
<h4 id="host命令"><a href="#host命令" class="headerlink" title="host命令"></a>host命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 语法：</span><br><span class="line">host -t RT NAME     </span><br><span class="line"><span class="meta">#</span><span class="bash"> 用-t指定資源類型；查詢名稱的解析結果，但不能用@</span></span><br><span class="line">host -t A www.mageedu.com</span><br><span class="line">host -t MX mageedu.com</span><br><span class="line">host -t SOA mageedu.com</span><br></pre></td></tr></table></figure>
<h4 id="nslookup命令"><a href="#nslookup命令" class="headerlink" title="nslookup命令"></a>nslookup命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> nslookup：交互式命令，也可工作在命令行模式下；這裏只介紹交互式模式，用window測試</span></span><br><span class="line">nslookup</span><br><span class="line"><span class="meta">nslookup&gt;</span><span class="bash"> server 192.168.5.4       </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在windows中操作，切換DNS；通過server命令指明用5.4DNS服務器來查詢，如果不指或指的服務器不是負責的域，會給出非權威答案</span></span><br><span class="line"><span class="meta">nslookup&gt;</span><span class="bash"> <span class="built_in">set</span> q=A            </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用<span class="built_in">set</span> q=命令設定資源類型</span></span><br><span class="line"><span class="meta">nslookup&gt;</span><span class="bash"> NAME            </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 要查的域名，如www.mageedu.com</span></span><br><span class="line">set q=NS</span><br><span class="line">mageedu.com</span><br></pre></td></tr></table></figure>
<h4 id="反向区域配置"><a href="#反向区域配置" class="headerlink" title="反向区域配置"></a>反向区域配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">* 反向區域的配置</span><br><span class="line">1. vim /etc/named.conf</span><br><span class="line">        zone "100.16.172.in-addr.arpa" IN &#123;</span><br><span class="line">            type master;</span><br><span class="line">            file "172.16.100.zone";</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">2. cp mageedu.com.zone 172.16.100.zone -p                           </span><br><span class="line"><span class="meta">#</span><span class="bash"> 包括權限完全復制</span></span><br><span class="line"></span><br><span class="line">3. vim 172.16.100.zone</span><br><span class="line"><span class="meta">		$</span><span class="bash">TTL    600</span></span><br><span class="line">		@       IN      SOA     ns1.mageedu.com.  admin.mageedu.com. (   </span><br><span class="line">        # 這裡的DNS主機名不可簡寫      </span><br><span class="line">                        2016061301</span><br><span class="line">                        1H</span><br><span class="line">                        5M</span><br><span class="line">                        2D</span><br><span class="line">   						6H)</span><br><span class="line">                IN      NS      ns1.mageedu.com.  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 反向區域裡DNS域名必須寫完整</span></span><br><span class="line">        1       IN      PTR     ns1.mageedu.com.</span><br><span class="line">        1       IN      PTR     www.mageedu.com.</span><br><span class="line">        2       IN      PTR     mail.mageedu.com.</span><br><span class="line">        3       IN      PTR     www.mageedu.com.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 反向配置文件中不需要A記錄</span></span><br><span class="line"> </span><br><span class="line">4. named-chechconf</span><br><span class="line"></span><br><span class="line">5. named-chechzone “5.168.192.in-addr.arpa” 192.168.5.zone         </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在/var/named目錄中執行此條</span></span><br><span class="line"></span><br><span class="line">6. service named restart</span><br><span class="line"></span><br><span class="line">7. windows測試</span><br><span class="line">        set q=PTR</span><br><span class="line">        192.168.5.2</span><br><span class="line"></span><br><span class="line">        set q=NS</span><br><span class="line">        5.168.192.in-addr.arpa</span><br><span class="line">8. dig -x 192.168.5.4          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在linux中解析IP，-x選項是解析，將DNS指向自建的DNS後才可使用此命令</span></span><br></pre></td></tr></table></figure>
<h4 id="泛域名解析、递归、传送"><a href="#泛域名解析、递归、传送" class="headerlink" title="泛域名解析、递归、传送"></a>泛域名解析、递归、传送</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">* 泛域名解析：如果想不管输入什麼，都轉到主頁。实际上应该是错误页面，這要通過url重定向來處理。</span><br><span class="line">1. 在mageedu.com.zone中添加如下，以實現泛域名解析</span><br><span class="line">		*.mageedu.com.         IN          A           IP</span><br><span class="line"> </span><br><span class="line">2. 设置给谁遞歸，（不是自己負責的域才有遞歸的概念）</span><br><span class="line">	vim /etc/named.conf</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 在全局選項中加入</span></span><br><span class="line">		options &#123;</span><br><span class="line">		recursion yes;            </span><br><span class="line"><span class="meta">		#</span><span class="bash"> 定義是否给所有人開啟遞歸，默認遞歸的客戶端個數是有限制的，這會使DNS服務器不會掛掉，默認也是開啟，不太好這種方式，所以去掉此項用下面的選項。</span></span><br><span class="line">		allow-recursion &#123; 172.16.0.0/16; &#125;;             </span><br><span class="line"><span class="meta">		#</span><span class="bash"> 說明只給哪個網段的用戶遞歸，定義遞歸對象；可加入本機回環地址，但用dig -t A IP時後面要加@127.0.0.1才能給遞歸，這應該是本機的DNS指向了本機IP。測試發現不是同一網段地址默認不給遞歸。如DNS是1網段，主機是5網段。這就要在DNS的配置文件中此項加入5網段才能使用。</span></span><br><span class="line">		allow-query                             </span><br><span class="line"><span class="meta">		#</span><span class="bash"> 只允許誰來查詢，用的不多</span></span><br><span class="line">		allow-transfer &#123;172.16.100.2; &#125;;    </span><br><span class="line"><span class="meta">		#</span><span class="bash"> 只允許172…2這台主機來傳送</span></span><br><span class="line">		notify yes;                 </span><br><span class="line"><span class="meta">		#</span><span class="bash"> 啟動同步通知</span></span><br><span class="line">		recursion no;                    </span><br><span class="line"><span class="meta">		#</span><span class="bash"> 不與任何人遞歸</span></span><br><span class="line">		&#125;           </span><br><span class="line"> </span><br><span class="line">3. 測試遞歸：</span><br><span class="line">dig +[no]tcp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加號 表示以某種方式工作，+no表示不以某種方式工作</span></span><br><span class="line">dig +recurse -t A www.sohu.com @192.168.5.4      </span><br><span class="line"><span class="meta">#</span><span class="bash"> recurse表示遞歸查詢，這是用本機5.4解析sohu的A記錄</span></span><br><span class="line">dig -t A www.sohu.com @192.168.5.4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默認都是遞歸的，加不加recurse也一樣</span></span><br><span class="line">dig +norecurse -t A www.sina.com @192.168.5.4   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 明確表示不遞歸，返回結果會讓去找.com域</span></span><br><span class="line">dig +norecurse -t A www.sina.com @m.gtld-servers.net.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再到.com服務器查詢</span></span><br><span class="line">dig +norecurse -t A www.sina.com @dns.baidu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 經過三次測試才找到網址的A記錄，不遞歸就只會返回一個參考答案</span></span><br><span class="line">dig +trace -t A www.baidu.com @192.168.5.4 </span><br><span class="line"><span class="meta">#</span><span class="bash"> +trace是跟蹤DNS的解析過程，但是不顯示IP地址的</span></span><br><span class="line">在配置文件中加入recursion no;不與任何人遞歸後再試</span><br><span class="line">dig +recurse -t A www.baidu.com @192.168.5.4     </span><br><span class="line"><span class="meta">#</span><span class="bash"> 不會返回結果</span></span><br><span class="line">dig +recurse -t A www.mageedu.com @192.168.5.4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因是自己負責的域會返回權威答案</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不遞歸就不能設為DNS服務器，因為不能解析就沒有意義</span></span><br><span class="line"></span><br><span class="line">vim /etc/named.conf</span><br><span class="line">	options &#123;</span><br><span class="line">		...</span><br><span class="line">		allow-recursion &#123; 192.168.5.0/24; &#125;;</span><br><span class="line">		...</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 添加上面一条</span></span><br><span class="line">dig -t A www.baidu.com @192.168.5.4</span><br><span class="line">dig -t A www.baidu.com @127.0.0.1  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 因為只給192.168.5網段遞歸，所以本機也遞歸不了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加allow-recursion &#123; 192.168.5.0/24;127.0.0.1; &#125;;即可給本機遞歸</span></span><br><span class="line"> </span><br><span class="line">4. 傳送</span><br><span class="line"><span class="meta">#</span><span class="bash"> axfr：完全區域傳送</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ixfr：增量區域傳送</span></span><br><span class="line">dig -t axfr mageedu.com @192.168.5.4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 得到一個區域的完全傳送，得到對方區域內的所有數據</span></span><br><span class="line"> </span><br><span class="line">5. vim mageedu.com.zone</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 在mageedu.com.zone中加入</span></span><br><span class="line">		pop        IN          A           192.168.5.7</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 在每次改完此文件後加把版本號加1，改成2016061302</span></span><br><span class="line">		</span><br><span class="line">6. service named reload</span><br><span class="line"></span><br><span class="line">7. dig -t IXFR=2016061301 mageedu.com        </span><br><span class="line"><span class="meta">#</span><span class="bash"> 2016061301版本以後發生的變化，如果改成2016061302，結果中只會有XFR size: 1 records (messages 1, bytes 75)一條，說明了有幾條變化，但不會有更詳細的結果。所以可以手動完成區域傳送。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##有主從服務器才會有區域傳送，是从主服務器傳送給從服務器，但像剛才的操作並不安全，應只讓從服務傳送才行，也就是添加allow-transfer &#123; 192.168.5.8; &#125;;     只允許誰來傳送，也可將此條寫在zone區域內，也就是某個區域只允許誰來傳送，如果寫在options中就會使全部區域都生效。不讓傳送就將IP地址改成none，如allow-transfer &#123; none; &#125;;</span></span></span><br><span class="line">dig -t axfr mageedu.com         </span><br><span class="line"><span class="meta">#</span><span class="bash"> 測試改爲allow-transfer &#123; none; &#125;;還能否傳送</span></span><br><span class="line"></span><br><span class="line">8. 改另一臺主機地址爲允許傳送的地址</span><br><span class="line">dig -t axfr mageedu.com @192.168.1.4             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 測試是否可以傳送，最後一定指向對方主機，因爲自己不是DNS服務器</span></span><br></pre></td></tr></table></figure>
<h4 id="主从配置"><a href="#主从配置" class="headerlink" title="主从配置"></a>主从配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">1. vim /etc/named.conf</span><br><span class="line">    options &#123;</span><br><span class="line">            directory       "/var/named";</span><br><span class="line">            allow-recursion &#123; 192.168.5.0/24;127.0.0.1; &#125;;</span><br><span class="line">    #       recursion no;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    zone "." IN &#123;</span><br><span class="line">            type hint;</span><br><span class="line">            file "named.ca";</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    zone "localhost" IN &#123;</span><br><span class="line">            type master;</span><br><span class="line">            file "named.localhost";</span><br><span class="line">            allow-transfer &#123; none; &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    zone "0.0.127.in-addr.arpa" IN &#123;</span><br><span class="line">            type master;</span><br><span class="line">            file "named.loopback";</span><br><span class="line">            allow-transfer &#123; none; &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    zone "mageedu.com" IN &#123;</span><br><span class="line">            type master;</span><br><span class="line">            file "mageedu.com.zone";</span><br><span class="line">            allow-transfer &#123; 192.168.5.8; &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    zone "5.168.192.in-addr.arpa" IN &#123;</span><br><span class="line">            type master;</span><br><span class="line">            file "192.168.5.zone";</span><br><span class="line">            allow-transfer &#123; 192.168.5.8; &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只允許5.8這個地址來傳送mageedu.com中的正反向數據，但根區域不用寫allow-transfer，寫了會報錯</span></span><br><span class="line"></span><br><span class="line">2. service named reload</span><br><span class="line"></span><br><span class="line">3. dig -t axfr mageedu.com @192.168.5.4             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 因為5.4不在指定範圍內，所以不能傳送</span></span><br><span class="line"></span><br><span class="line">* 新開一台主機，配置地址為192.168.5.8</span><br><span class="line">dig -t axfr mageedu.com @192.168.5.8             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 用此命令模擬傳送，因是指定主機所以可以傳送</span></span><br><span class="line"> </span><br><span class="line">1. 從服務器配置，在5.8上</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在/var/named目錄中有slaves文件，屬主與屬組都是named，且都有寫權限，但/var/named屬組是named，且沒有寫權限，屬主是root。如果讓從服務器同步數據保存在此目錄中，因是以named身份訪問所以沒有寫權限不能保存，所以要將數據放在slaves中</span></span><br><span class="line"></span><br><span class="line">2. setenforce 0</span><br><span class="line"></span><br><span class="line">3. mv /etc/named.conf /etc/named.conf.orig</span><br><span class="line"></span><br><span class="line">4. scp 192.168.5.4:/etc/named.conf /etc/         </span><br><span class="line"><span class="meta">#</span><span class="bash"> 將5.4的.conf文件下載回來放在/etc下</span></span><br><span class="line"></span><br><span class="line">5. vim /etc/named.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 僅修改下面內容</span></span><br><span class="line">		zone "mageedu.com" IN &#123;</span><br><span class="line">             type slave;</span><br><span class="line">             file "slaves/mageedu.com.zone";           </span><br><span class="line">             # 將文件放在/var/named/slaves/中</span><br><span class="line">             masters &#123; 192.168.5.4; &#125;;                    </span><br><span class="line">             # 指定主服務器</span><br><span class="line">             allow-transfer &#123; none; &#125;;       </span><br><span class="line">             # 不允許同步數據，試驗時可先去掉主從區域中的此條，以免出問題</span><br><span class="line">		&#125;;</span><br><span class="line">        zone "5.168.192.in-addr.arpa" IN &#123;</span><br><span class="line">                type slave;</span><br><span class="line">                file "slaves/192.168.5.zone";</span><br><span class="line">                masters &#123; 192.168.5.4; &#125;;</span><br><span class="line">                allow-transfer &#123; none; &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">       # 將一個服務器設為正向的主服務器反向的從服務器，另一個設為正向的從服務器，反向的主服務器。</span><br><span class="line">       </span><br><span class="line">6. named-checkconf</span><br><span class="line"></span><br><span class="line">7. chgrp named /etc/named.conf</span><br><span class="line"></span><br><span class="line">8. service named start          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 視頻中出現問題，是因爲主服务器的配置文件的屬組是root且其他權限是0,改爲named組再試。查看日志可找到錯誤信息</span></span><br><span class="line"></span><br><span class="line">9. tail /var/log/messages</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在兩台主機上運行此條命令，結果會顯示完全傳送啓動與結束的信息</span></span><br><span class="line"></span><br><span class="line">10. cd /slaves            </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看傳送過來的信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ORIGIN .  與   TTL 都可以聲明多次的</span></span><br></pre></td></tr></table></figure>
<h4 id="增量传送"><a href="#增量传送" class="headerlink" title="增量传送"></a>增量传送</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">* 在主服務器5.4中</span><br><span class="line">1. vim /var/named/mageedu.com</span><br><span class="line">		imap    IN          A           192.168.5.9 </span><br><span class="line"><span class="meta">		#</span><span class="bash"> 加入</span></span><br><span class="line">		2016061303</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 改序列號</span></span><br><span class="line">		</span><br><span class="line">2. service named reload</span><br><span class="line"></span><br><span class="line">3. tail /var/log/messages</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看兩服務器的日志因視頻中的同步沒有發生，所以在主服務器的named.conf中的options中加入了notify yes; 一條讓服務器啟動同步通知，沒有發生同步的真正原因是在主服務器的mageedu.com.zone中沒有定義另一台服務器的IP地址，所以域服務器只知道有一台服務器。</span></span><br><span class="line"></span><br><span class="line">4. 在主服務器的mageedu.com.zone加入兩條</span><br><span class="line">        mageedu.com.    IN      NS      ns2</span><br><span class="line">        ns2             IN      A       192.168.5.8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這是正向的NS和A記錄，反向也要有192.168.5.zone中加入     </span></span><br><span class="line">                    IN          NS         ns2.mageedu.com.</span><br><span class="line">        8    		IN          PTR        ns2.mageedu.com.</span><br><span class="line">5. service named reload          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新讀取主服務器配置文件</span></span><br><span class="line"></span><br><span class="line">6. 將從服務器上slaves中的文件都刪除，讓從服務器再完全同步一次</span><br><span class="line"></span><br><span class="line">7. 到主服務器上vim mageedu.com，加入</span><br><span class="line">		hello      IN   		A    	192.168.5.9</span><br><span class="line">        改序列號</span><br><span class="line">        </span><br><span class="line">8. service named reload</span><br><span class="line"></span><br><span class="line">9. tail /var/log/messages</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入一台NS服務器時一定也要加入ns記錄，放在本區域中所支持的DNS服務器中</span></span><br><span class="line"></span><br><span class="line">10. 在主服務器的反向文件192.168.5.zone中加入</span><br><span class="line">         10          IN   		PTR      hello.mageedu.com.</span><br><span class="line">         </span><br><span class="line">11. service named reload</span><br><span class="line"></span><br><span class="line">12. 查看日志</span><br></pre></td></tr></table></figure>
<h4 id="rndc"><a href="#rndc" class="headerlink" title="rndc"></a>rndc</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">* 用rndc控制DNS服務器</span><br><span class="line">1. rndc-confgen &gt; /etc/rndc.conf   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成配置文件</span></span><br><span class="line"></span><br><span class="line">2. cat /etc/rndc.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> start of rndc.conf與end of rndc.conf中間的段才是生效的，文件中下面還有這樣的一段內容，但注釋掉了，並要求將注釋的內容放到named.conf中</span></span><br><span class="line"></span><br><span class="line">3. vim /etc/rndc.conf</span><br><span class="line">		輸入:.,$-1w &gt;&gt; /etc/named.conf           </span><br><span class="line">        # 定位光標所在行到倒數第二行追加到/etc/named.conf中 </span><br><span class="line">        </span><br><span class="line">4. vim /etc/named.conf</span><br><span class="line">		:.,$s/^# //g          </span><br><span class="line">        # 從光標所在行到最後一行，查找行首的#號且後面有空白，替換為什麼也沒有，之後可以看到rndc-key的保存位置，並標明了是密鑰</span><br><span class="line">        </span><br><span class="line">5. vim /etc/rndc.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這裡也定義了rndc-key</span></span><br><span class="line"></span><br><span class="line">6. rm /etc/rndc.key           </span><br><span class="line"><span class="meta">#</span><span class="bash"> 這是<span class="built_in">bind</span>軟件提供的，刪除即可</span></span><br><span class="line"></span><br><span class="line">7. service named restart</span><br><span class="line"></span><br><span class="line">8. rndc -c /etc/rndc.conf status      </span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-c選項控制服務器，查看服務器狀態</span></span><br><span class="line"></span><br><span class="line">9. rm -rf /etc/rndc.key             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 刪除這個文件，不然上面一條命令會報錯？？？</span></span><br><span class="line">       </span><br><span class="line">10. rndc -c /etc/rndc.conf notify “mageedu.com”     </span><br><span class="line"><span class="meta">#</span><span class="bash"> 手動發送通知</span></span><br><span class="line"></span><br><span class="line">11. rndc -c /etc/rndc.conf flush             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除緩存</span></span><br><span class="line"></span><br><span class="line">12. rndc -c /etc/rndc.conf stop       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止服務器，啟動必須用service命令啟動named</span></span><br><span class="line"></span><br><span class="line">13. netstat -tlunp       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看</span></span><br><span class="line"></span><br><span class="line">14. service named start</span><br><span class="line"><span class="meta">#</span><span class="bash"> rndc命令用於控制與查看服務器，在控制本地主機時較常用</span></span><br></pre></td></tr></table></figure>
<h4 id="控制遠程服務器需注意"><a href="#控制遠程服務器需注意" class="headerlink" title="控制遠程服務器需注意"></a>控制遠程服務器需注意</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1. named.conf中controls一項中的監聽地址要改，如：</span><br><span class="line">controls &#123;</span><br><span class="line">    inet 192.168.5.4 port 953               </span><br><span class="line">    # 監聽的地址</span><br><span class="line">    allow &#123; 192.168.5.8; &#125; keys &#123; “rndc-key”; &#125;;     </span><br><span class="line">    # 允許控制的地址，用什麼控制</span><br><span class="line">&#125;</span><br><span class="line">service named restart</span><br><span class="line"></span><br><span class="line">2. scp /etc/rndc.conf 192.168.5.8:/root </span><br><span class="line"><span class="meta">#</span><span class="bash"> 把密鑰文件拷到控制主機上，並放在root目錄下，如果放在etc下會覆蓋別人的相同文件</span></span><br><span class="line"></span><br><span class="line">3. vim rndc.conf       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 編輯拷過來的文件</span></span><br><span class="line">	改options中的default-server地址為要控制的服務器地址</span><br><span class="line">	</span><br><span class="line">4. 這裡還要同步時間，一般不用開啟遠程控制，不安全。一般只在本機上使用。</span><br></pre></td></tr></table></figure>
<h4 id="测试DNS服务器"><a href="#测试DNS服务器" class="headerlink" title="测试DNS服务器"></a>测试DNS服务器</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">* 例：公司在mageedu.com域下，網站是www.mageedu.com。現兩個部門有各自的網址，分別為www.mageedu.com/fin（財務）和www.mageedu.com/market（市場），現兩個網站有不同的地址，如www.fin.mageedu.com和www.market.mageedu.com，現在就有三個域要管理，也就是mageedu.com域要有DNS服務器管理，新分出的www.fin.mageedu.com和www.market.mageedu.com也要有兩個DNS服務器管理，這就是一個父域和兩個子域，子域要有父域的授權，下面為正向的設置。反向設置比較麻煩</span><br><span class="line"> </span><br><span class="line">正向區域設置</span><br><span class="line">SUB_ZONE_NAME       IN          NS         NSSERVER_SUB_ZONE_NAME</span><br><span class="line">NSSERVER_SUB_ZONE_NAME      IN   A    IP                 A記錄</span><br><span class="line"> </span><br><span class="line">SUB_ZONE_NAME	# 指子域的區域名稱</span><br><span class="line">NSSERVER_SUB_ZONE_NAME	# 指管理這個子域的域名服務器，且一定是當前域的子片</span><br><span class="line"><span class="meta">#</span><span class="bash"> A記錄是管理這個子域的域名服務器的IP地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如在.com域下注冊了mageedu.com，那麼在.com上要用如上方法建立</span></span><br><span class="line">mageedu.com             IN          NS         ns1.mageedu.com.</span><br><span class="line">                        IN          NS         ns2.mageedu.com.</span><br><span class="line">ns1.mageedu.com.        IN          A           192.168.5.38</span><br><span class="line">ns2.mageedu.com.        IN          A           192.168.5.41</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果有輔助服務器是192.168.5.8，在互聯網上是不能用的，因為.com域中沒有記錄。也就是子域中有幾個名稱服務器，在父域中也要建幾條記錄。這裏再次回顧解析過程，如下：</span></span><br><span class="line">dig +trace -t A www.baidu.com @192.168.5.38</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因爲5.38是負責mageedu.com.域的，不負責解析baidu.com域，所以要去找根，根會返回.com域的信息，再找.com域，.com域會根據自己的A記錄再返回baidu.com域的A記錄信息。baidu.com域再根據自己的A記錄返回要查找的內容。所以，如果在baidu.com.域中沒有相關記錄，即使建了從服務器，也不會被找到。如果在父域中有多條記錄，會被輪流使用。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">如上。如自建了兩臺NS服務器，在網上注冊了域名，要在域名提供商提供的頁面中將ns記錄改為自己的服務器，並建兩個記錄指向自己的兩臺NS服務器。</span></span><br><span class="line"> </span><br><span class="line">* 例：現在mageedu.com域已屬我們自己管理，且建好了一主一從兩臺名稱服務器，現在希望授權子域，一個叫fin，一個叫market，並且讓兩個子域可以自我管理。如何實現？建立兩個子域，授權子域可自我管理</span><br><span class="line">在父域上授權子域，這應該是在域名提供網的頁面上做的</span><br><span class="line">fin.mageedu.com.             IN          NS         ns1.fin.mageedu.com.</span><br><span class="line">fin.mageedu.com.             IN          NS         ns2.fin.mageedu.com.             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 這是從服務器</span></span><br><span class="line">ns1.fin.mageedu.com.         IN          A           192.168.5.10             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 子域IP也就是子域與父域不一定在同一網段，但要能與父域通訊</span></span><br><span class="line">ns2.fin.mageedu.com.         IN          A           192.168.5.7        </span><br><span class="line"><span class="meta">#</span><span class="bash"> 子域2的服務器一定要能通信，如果解析返回子域2的IP地址，但不在線，這就不能通信了。從服務器如果不在線也會影響解析工作</span></span><br><span class="line">market.mageedu.com.          IN          NS         ns1.market.mageedu.com.</span><br><span class="line">ns1.market.mageedu.com.      IN          A          192.168.5.11</span><br></pre></td></tr></table></figure>
<h4 id="fin子域服务器"><a href="#fin子域服务器" class="headerlink" title="fin子域服务器"></a>fin子域服务器</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">* 建立fin子域服務器方法：只建一個</span><br><span class="line">1. 在父域上授權，編輯父服務器中的主服務器，加入如下</span><br><span class="line">vim /var/named/mageedu.com.zone</span><br><span class="line">	fin          IN          NS         ns1.fin                              </span><br><span class="line">ns1.fin          IN          A          192.168.5.10</span><br><span class="line">	market       IN          NS         ns1.market</span><br><span class="line">ns1.market       IN          A          192.168.5.11</span><br><span class="line">最後修改序列號，不然從服務器得不到此數據</span><br><span class="line"> </span><br><span class="line">2. service named restart --&gt; tail /var/log/messages                        </span><br><span class="line"><span class="meta">#</span><span class="bash"> 重啓，看日志</span></span><br><span class="line">cd /var/named/slaves                                     </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看從服務器是否同步了數據</span></span><br><span class="line">cat mageedu.com.zone                                  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 其中用<span class="variable">$ORIGIN</span>聲明變量</span></span><br><span class="line"></span><br><span class="line">3. dig -t NS fin.mageedu.com @192.168.5.4 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 雖然NS服務器不存在，但記錄已有。因為沒建立子域，聯系不上子域服務器所以不會返回結果</span></span><br><span class="line">   dig -t A ns1.fin.mageedu.com @192.168.5.4                    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看A記錄是否能找到</span></span><br><span class="line"></span><br><span class="line">4. 在另一臺服務器上建子域服務器，修改IP地址。DNS服務器改爲自己（也就是子域服務器地址），搜索的子域，也就是search一項改爲fin.mageedu.com。重啓網絡服務，ping主DNS服務器，再試</span><br><span class="line">       在/etc/named.conf中加入，並刪除之前所有自定義的域</span><br><span class="line">       zone “fin.mageedu.com” IN &#123;</span><br><span class="line">              type master;</span><br><span class="line">              file “fin.mageedu.com.zone”;</span><br><span class="line">       &#125;;</span><br><span class="line">       </span><br><span class="line">5. 在主DNS中操作</span><br><span class="line">cd /var/named--&gt;復制mageedu.com.zone爲fin.mageedu.com.zone並修改</span><br><span class="line">:%s@mageedu.com@fin.mageedu.com@g</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的%表示全文搜索，將mageedu.com改爲fin.mageedu.com</span></span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 86400</span></span><br><span class="line">@          IN   SOA    ns1.fin.mageedu.com.     admin.fin.mageedu.com.</span><br><span class="line">                2016110101</span><br><span class="line">                2H</span><br><span class="line">                10M</span><br><span class="line">                7D</span><br><span class="line">                2D)</span><br><span class="line">           IN          NS          ns1</span><br><span class="line">           IN          MX   10     mail</span><br><span class="line">ns1        IN          A           192.168.5.41</span><br><span class="line">mail       IN          A           192.168.5.42</span><br><span class="line">www        IN          A           192.168.5.43</span><br><span class="line">上面就建立了子域的名稱服務器，保存退出並啓動</span><br><span class="line"></span><br><span class="line">6. 到子域再試</span><br><span class="line">dig -t NS fin.mageedu.com @192.168.5.41</span><br><span class="line">dig -t A fin.mageedu.com @192.168.5.41</span><br><span class="line"> </span><br><span class="line">7. 到父域再試</span><br><span class="line">dig -t NS fin.mageedu.com @192.168.5.38</span><br><span class="line">dig -t A fin.mageedu.com @192.168.5.38</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只要子域存在就沒問題了。在子域解析時，顯示的flags一行有aa字樣，應該是權威答案。</span></span><br><span class="line"></span><br><span class="line">8. 用windows的nslookup試</span><br><span class="line">server 192.168.5.38          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 指向父域</span></span><br><span class="line">set q=A</span><br><span class="line">www.mageedu.com</span><br><span class="line">www.fin.mageedu.com</span><br><span class="line"> </span><br><span class="line">server 192.168.5.41          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 指向子域</span></span><br><span class="line">set q=A</span><br><span class="line">www.mageedu.com          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 因爲互聯網上沒有這個域，所有不會返回結果</span></span><br><span class="line">www.fin.mageedu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 將發送到子域的請求都轉發給父域</span></span><br></pre></td></tr></table></figure>
<h4 id="子域轉發"><a href="#子域轉發" class="headerlink" title="子域轉發"></a>子域轉發</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 讓子域可以找到互聯網上沒有的父域，定義轉發即可。將子域所有的請求都轉發給父域。</span></span><br><span class="line">* 在子域中</span><br><span class="line">1. vim /etc/named.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在options中加入forward &#123; only|first &#125;，only指把自己解析不了的都轉給指定的服務器，如果指定的服務器不能給答案就算了；first指轉發給指定的服務器如果不能給答案，子域就去找根了。</span></span><br><span class="line">       forward first;             </span><br><span class="line">       # forward表示轉發，這樣設備會報錯</span><br><span class="line">       forwarders &#123; 192.168.5.4; &#125;;   </span><br><span class="line">       # 指定轉發器的位置，也就是轉發給誰。但這是對全局的設定，所有請求都會轉發</span><br><span class="line">       </span><br><span class="line">2. service named restart</span><br><span class="line"></span><br><span class="line">3. windows中測試效果</span><br><span class="line">        nslookup</span><br><span class="line">        set q=A</span><br><span class="line">        www.fin.mageedu.com</span><br><span class="line">        www.mageedu.com </span><br><span class="line">        </span><br><span class="line">4. dig +trace -t A www.baidu.com       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 這裏的請求實際是轉發給父域了，但父域不負責百度，這樣做的意義並不大。我們也可以轉發父域負責的，其他自己去查</span></span><br><span class="line">設置轉發域，在/etc/named.conf中追加新建區域</span><br><span class="line">        zone “mageedu.com” IN &#123;</span><br><span class="line">        type forward;            </span><br><span class="line">        # 說明是轉發域</span><br><span class="line">        forward first;             </span><br><span class="line">        # 將此兩條寫在這裡，說明只有請求的是mageedu.com域時才轉發</span><br><span class="line">        forwarders &#123; 192.168.5.4; &#125;;          </span><br><span class="line">        # 測試這裏不能用acl訪問控制列表</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">5. named-checkconf</span><br><span class="line"></span><br><span class="line">6. 在windows中測試</span><br><span class="line">        set q=A</span><br><span class="line">        www.mageedu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 試一下將所有對.com的請求都轉發給.com</span></span><br><span class="line">dig -t NS com --&gt; 找到.com的A記錄，把A記錄填入forwarders中</span><br></pre></td></tr></table></figure>
<h4 id="acl"><a href="#acl" class="headerlink" title="acl"></a>acl</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ACL的使用（訪問控制列表）</span><br><span class="line">allow-recursion &#123;&#125;;		# 能被遞歸的客戶端來源</span><br><span class="line">allow-query &#123;&#125;; 		# 允許查詢的客戶端</span><br><span class="line">allow-transfer &#123;&#125;;		# 允許傳送的客戶端</span><br><span class="line">在named.conf也可使用變量這種機制，但叫acl（訪問控制列表），假如要在上面三個條目中定義主機，可用acl定義並放在前面，並取名，以後可隨時使用</span><br><span class="line"> </span><br><span class="line">1. 用法：acl在主配置文件named.conf中的options之上定義</span><br><span class="line">        acl innet &#123;                               </span><br><span class="line">               192.168.5.0/24;</span><br><span class="line">               127.0.0.0/8;</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> innet是ACL_NAME（acl的名字），可以隨便起</span></span><br><span class="line">		allow-query &#123; innet; &#125;;            </span><br><span class="line"><span class="meta">#</span><span class="bash"> 再用此項時，可不寫地址，直接寫innet即可</span></span><br><span class="line">		none；</span><br><span class="line"><span class="meta">#</span><span class="bash"> 是內置的常用列表，表示什麼都沒有</span></span><br><span class="line">		any；</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同none一樣是內置的常用列表，表示任意的</span></span><br><span class="line"></span><br><span class="line">* acl一定要先定義才能使用，所以一般對主配置文件來說，acl是寫在最上方的。</span><br><span class="line">例：</span><br><span class="line">        acl innet &#123;</span><br><span class="line">        192.168.5.0/24;</span><br><span class="line">        127.0.0.0/8;</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可參考書&lt;&lt;bind97 Manual&gt;&gt;，另外講的大多數內容在&lt;&lt;OReily DNS and BIND 5th&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="智能DNS"><a href="#智能DNS" class="headerlink" title="智能DNS"></a>智能DNS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">	* 能夠根據客戶端來源所屬的網絡進行判斷，並且返回給一個我們事先定義好的IP地址，這就是智能DNS。</span><br><span class="line">	* 它是怎麼實現智能的？DNS在自己的內部做視圖（view），DNS服務器試圖解析一個域名，我們把所有客戶端來源分爲兩類，一類是來自聯通網的，一類是電信網的。我們希望位於聯通網的解析爲一個聯通的IP地址，電信的返回電信機房的IP地址。這就要將數據文件分成兩部分，來自聯通的就查找聯通的數據文件，電信的查找電信的數據文件。用兩個文件分別應對來自不同網絡的請求。這樣對一個域名的請求就可以一分為二，叫做split brain(腦裂)的結果，這裏不只能分爲兩個，要看有多少個數據文件，就能分幾個。（在各地機房都有服務器，這個服務器可能是緩存服務器，而不是源服務器。）這裡不僅限分成兩個，要看劃分區域多少。實現上可能是建一個服務器集群，之後在各地建緩存服務器，在客戶端請求時，緩存服務器向服務器集群發請求，將web內容緩存到本地，之後客戶端就可從本地緩存服務器上得到請求的結果，這種能判斷客戶端來源並返回最近的服務器內容的網絡，而且這個網絡本身能夠根據原始服務器取得內容以後緩存在本地，它就叫做CDN (Content Delivery Network)內容分發網絡。這裏緩存的一般是靜態內容，只有動態內容才從原始服務器獲取。而很多動態內容也可通過策略靜態化，並緩存在本地。CDN比較重要的前提是可以判斷客戶端來源。而且要能根據客戶端來源返回離他最近的服務器地址。</span><br><span class="line">	</span><br><span class="line">* 測試：分兩個網絡172.16.0.0/16和127.0.0.0/8的是電信網，其他都是聯通網。這要使用view功能，只能一臺服務器實現智能解析。方法：</span><br><span class="line">	route             查看網關爲172.16的網絡</span><br><span class="line">再找一臺主機，改成192.168的網絡，網關指向192.168.0.254，192與172在同一臺主機上是允許路由數據的。這臺主機只是用來做客戶端，停止named服務。</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">vim /etc/named.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 要想實現智能解析，就要使用view視圖。用man named.conf可查看視圖的幫助。</span></span><br><span class="line"> </span><br><span class="line">        view VIEW_NAME &#123;</span><br><span class="line">        # 對option使用的所有指令對視圖都可用。除了directory外。</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> options中的指令在view中幾乎都可使用。一旦使用了視圖，所有區域都必須定義在view中，根區域只需定義在需要遞歸的view中即可。用man named.conf可查看幫助</span></span><br><span class="line"> </span><br><span class="line">* 定義三個視圖，一個叫內網，一個叫電信，一個叫聯通。來自電信和聯通的都不用做遞歸，只要不遞歸就不用提供根的解析。如果此情況在互聯網上是不用聲明根區域的，但一般還是提供根區域的</span><br><span class="line">1. cp /etc/named.conf /root</span><br><span class="line">vim /etc/named.conf</span><br><span class="line">    acl telecom &#123;</span><br><span class="line">        172.16.0.0/16;</span><br><span class="line">        127.0.0.0/8;</span><br><span class="line">    &#125;；</span><br><span class="line">    options &#123;</span><br><span class="line">        directory “/var/named”；</span><br><span class="line">        allow-recursion &#123; telecom; &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    view telecom &#123;</span><br><span class="line">    	match-clients &#123; telecom; &#125;;     </span><br><span class="line">    	# match-clients是view中最常用的指令，判斷是來自哪兒的客戶端的</span><br><span class="line">    	zone “mageedu.com” IN &#123;</span><br><span class="line">            type master;</span><br><span class="line">            file “telecom.magedu.com.zone”;         </span><br><span class="line">            # 每個視圖對應一個區域數據文件，只要區域在不同的區域中都提供了，就要給不同的區域文件。</span><br><span class="line">    	&#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    view unicom &#123;</span><br><span class="line">        match-clients &#123; any; &#125;;            </span><br><span class="line">        # 這裡的any代表除上面定義的telecom網絡外的其他網絡，只要匹配不上上面的就都會匹配這個</span><br><span class="line">    	zone “mageedu.com” IN &#123;</span><br><span class="line">            type master;</span><br><span class="line">            file “unicom.magedu.com.zone”;</span><br><span class="line">    	&#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到這裏測試了一下，named-checkconf --&gt; service named restart</span></span><br><span class="line"> </span><br><span class="line">2. 建立正向解析文件</span><br><span class="line">vim /var/named/telecom.mageedu.com.zone</span><br><span class="line">       $TTL 43200</span><br><span class="line">       @          IN          SOA      ns1.mageedu.com.            admin.mageedu.com. (</span><br><span class="line">                              2016061301</span><br><span class="line">                              1H</span><br><span class="line">                              10M</span><br><span class="line">                              7D</span><br><span class="line">                              1D)</span><br><span class="line">                  IN          NS          ns1</span><br><span class="line">                  IN          MX 10   	  mail</span><br><span class="line">      ns1         IN          A           192.168.5.4</span><br><span class="line">      mail        IN          A           192.168.5.5</span><br><span class="line">      www     	  IN          A           192.168.5.6</span><br><span class="line">      </span><br><span class="line">3. chgrp named telecom.mageedu.com.zone</span><br><span class="line"></span><br><span class="line">4. chmod 640 telecom.mageedu.com.zone</span><br><span class="line"></span><br><span class="line">5. cp -p telecom.mageedu.com.zone unicom.mageedu.com.zone</span><br><span class="line"></span><br><span class="line">6. vim unicom.mageedu.com.zone</span><br><span class="line">        $TTL 43200</span><br><span class="line">        @ 		IN		SOA			ns1.mageedu.com.		admin.mageedu.com. (</span><br><span class="line">                        2016061301</span><br><span class="line">                        1H</span><br><span class="line">                        10M</span><br><span class="line">                        7D</span><br><span class="line">                        1D)</span><br><span class="line">                IN          NS          ns1</span><br><span class="line">                IN          MX 10       mail</span><br><span class="line">        ns1     IN          A           192.168.5.4		# 此條IP是不會變的</span><br><span class="line">        mail    IN          A           172.16.100.2</span><br><span class="line">        www     IN          A           172.16.100.3</span><br><span class="line"> </span><br><span class="line">7. 測試，在客戶端上和服務器上分別做一次</span><br><span class="line">dig -t A www.mageedu.com @172.16.100.1</span><br><span class="line">在windows上測試</span><br><span class="line">server 172.16.100.1</span><br><span class="line">set q=A</span><br><span class="line">www.mageedu.com</span><br><span class="line"> </span><br><span class="line">* 一臺DNS服務器可爲多個域解析，加入a.net網絡，且a.net不用區分網絡。來自a.net的無論哪個網絡都解析一個IP</span><br><span class="line">8. 在主配置文件的兩個view中加入下面內容，這樣才能保證來自不同網絡的客戶端訪問同一個地址。</span><br><span class="line">    zone “a.net” IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file “a.net.zone”;</span><br><span class="line">    &#125;;</span><br><span class="line">這就可以實現如果同時解析多個域，但有些域裡不想使用不同的結果，之後如下</span><br><span class="line">vim a.net.zone</span><br><span class="line">       $TTL 43200</span><br><span class="line">       @          IN          SOA             ns1.a.net.      admin.a.net. (</span><br><span class="line">                              2016061301</span><br><span class="line">                              1H</span><br><span class="line">                              10M</span><br><span class="line">                              7D</span><br><span class="line">                              1D)</span><br><span class="line">				  IN          NS          ns1</span><br><span class="line">       ns1        IN          A           172.16.100.1</span><br><span class="line">       mail       IN          A           172.16.100.2</span><br><span class="line">       www     	  IN          A           172.16.100.3</span><br><span class="line"> </span><br><span class="line">9. chgrp named a.net.zone</span><br><span class="line"></span><br><span class="line">10. chmod 640 a.net.zone</span><br><span class="line"></span><br><span class="line">11. service named restart</span><br><span class="line"></span><br><span class="line">12. dig -t A www.a.net @172.16.100.1                     </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在兩臺主機上測試</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DNS服務啟動後會將數據文件載入內存，解析與查找過程是在內存中完成的，所以很快。但如果修改了數據文件就要重新載入，如果數據文件較大就比較慢了。所以將區域的定義內容可以寫在數據庫中，不再載入內存，不用重新讀取，每次都查數據庫，所以管理方便了，但速度慢了。智能DNS服務器提供商：dnspod、www.dns.la。推薦文檔《利用<span class="built_in">bind</span> DLZ MySQL構建智能DNS》，DLZ是能將DNS數據放入MySQL中的一種機制。還有一種是<span class="built_in">bind</span>-sdb，這也是一種將數據放在數據庫中的機制</span></span><br></pre></td></tr></table></figure>
<h4 id="DNS日志功能"><a href="#DNS日志功能" class="headerlink" title="DNS日志功能"></a>DNS日志功能</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">在互聯網上使用不建議開日志功能，會產生大量磁盤I/O寫日志，影響服務器性能</span><br><span class="line">1. vim /etc/named.conf</span><br><span class="line">		在options中加入</span><br><span class="line">		querylog yes;</span><br><span class="line">		</span><br><span class="line">2. service named restart</span><br><span class="line"></span><br><span class="line">3. dig -t A www.baidu.com @192.168.5.38</span><br><span class="line"></span><br><span class="line">4. tail /var/log/messages</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种方法添加的日志功能，日志文件在messages中</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">bind</span>提供的日志系統要定義兩個子系統，一個category，一個channel</span></span><br><span class="line"></span><br><span class="line">5. category：DNS產生子系統在什麼地方，定義產生日志的源，可以是與查詢相關的，也可以是與區域傳送相關的等。可以通過category自定義日志來源；日志源一共只有15個</span><br><span class="line"> </span><br><span class="line">6. channel：定義日志保存位置</span><br><span class="line">	一個category可以定義到多個channel，但一個channel只能保存到一個category。也就是一个日志查询的源可以保存在多个地方，但一个地方只能保存一种日志源。</span><br><span class="line">	</span><br><span class="line">7. 日志記錄的地方有兩種：syslog和file</span><br><span class="line">        syslog：由syslog定義，存在/var/log/messages中</span><br><span class="line">        file：自定義保存日志信息的文件</span><br><span class="line">        日志級別有：critical  error  warning  notice  info  debug[level] dynamic（動態級別）；默認是info級別</span><br><span class="line"> </span><br><span class="line">* 方法</span><br><span class="line">1. vim /etc/named.conf</span><br><span class="line">        logging &#123;                                         用logging括起來</span><br><span class="line">        	channel querylog &#123;                 </span><br><span class="line">        	# 定義通道，querylog是保存的名字，名字隨便</span><br><span class="line">        		file “/var/log/named/bind_query.log” versions 5 size 10M;          </span><br><span class="line">        		# 類型是file，格式，達到10M後滾動，保存5個版本。另外named用戶要對保存位置有寫權限</span><br><span class="line">        		severity dynamic;                                   </span><br><span class="line">        		# 日志級別</span><br><span class="line">        		print-category yes;                                 </span><br><span class="line">        		# 由哪個category產生的信息</span><br><span class="line">        		print-time yes;                  </span><br><span class="line">        		# 什麼時間產生的信息；但在發往syslog時不用，因爲syslog會自動記錄</span><br><span class="line">        		print-severity yes;            </span><br><span class="line">                # 記錄日志時把當前的級別也寫下來</span><br><span class="line">        	&#125;;</span><br><span class="line"></span><br><span class="line">        	channel xfer_log &#123;</span><br><span class="line">        		file “/var/log/named/transfer.log” versions 3 size 10k;</span><br><span class="line">        		severity debug 3;</span><br><span class="line">        		print-time yes;</span><br><span class="line">        	&#125;;</span><br><span class="line">        	category querise &#123; querylog; &#125;;            </span><br><span class="line">        	# 來自category類別的日志與query（查詢）相關的，記錄到querylog中</span><br><span class="line">        	category xfer-out &#123; xfer_log &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">2. mkdir /var/log/named</span><br><span class="line"></span><br><span class="line">3. chown named:named /var/log/named</span><br><span class="line"></span><br><span class="line">4. chmod 770 /var/log/named</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每重啓服務日志都會自動滾動；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 參考: http://www.ahlinux.com/server/dns/6291.html</span></span><br><span class="line">** 一般查詢與安全日志不開，更新日志開啟 **</span><br></pre></td></tr></table></figure>
<h4 id="DNS服務器性能測試"><a href="#DNS服務器性能測試" class="headerlink" title="DNS服務器性能測試"></a>DNS服務器性能測試</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* dnstop軟件是監控DNS服務器每秒能接受多少查詢的，對哪個域名發起查詢請求的；bind原碼軟件包中有queryperf命令可以對服務器做壓力測試</span><br><span class="line">用queryperf命令</span><br><span class="line">1. 先建一個文件在裡面寫明要查詢的內容</span><br><span class="line">vim test</span><br><span class="line">    www.mageedu.com  		A</span><br><span class="line">    mageedu.com             NS</span><br><span class="line">    mageedu.com             NX</span><br><span class="line">    mail.mageedu.com        A</span><br><span class="line">    ns1.mageedu.com         A</span><br><span class="line">    pop. mageedu.com        A</span><br><span class="line">    imap. mageedu.com       A</span><br><span class="line"><span class="meta">#</span><span class="bash"> 將內容復制了多次達到200000行時測試，:1,<span class="variable">$y</span>從第一行到最後一行復制；這時用top命令查看cpu佔用率；用兩臺不同的主機測試</span></span><br><span class="line"> </span><br><span class="line">2. queryperf -d test -s 172.16.100.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 測試中可能會卡住，這時可用top命令查看一下CPU的壓力；另外這是本機測試，沒有考慮帶寬問題，可用其他主機測試一下，把<span class="built_in">test</span>文件和queryperf文件拷到其他主機</span></span><br><span class="line"> </span><br><span class="line">* 再用dnstop工具監控DNS狀態，編譯安裝此軟件需要安裝libpcap-devel包。這是一個抓包工具</span><br><span class="line">dnstop -4 -Q -R eth0</span><br><span class="line"><span class="meta">#</span><span class="bash"> -4指監聽IPv4地址，-Q指記錄查詢數，-R指記錄響應數，最後是網卡名稱。之後用dig命令查詢，這條命令會有結果顯示</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 多行注釋方法：/*開頭*/結尾</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本節介紹的書籍dns and <span class="built_in">bind</span>、bind97 Manual、利用<span class="built_in">bind</span> DLZ Mysql構建智能DNS</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/22/docker学习四：操作容器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/22/docker学习四：操作容器/" itemprop="url">
                  docker学习四：操作容器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-22 09:27:18" itemprop="dateCreated datePublished" datetime="2018-11-22T09:27:18+08:00">2018-11-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-02 15:04:04" itemprop="dateModified" datetime="2019-02-02T15:04:04+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="操作Docker容器"><a href="#操作Docker容器" class="headerlink" title="操作Docker容器"></a>操作Docker容器</h3><blockquote>
<p>容器是 Docker 又一核心概念。</p>
<p>简单的说，容器是独立运行的一个或一组应用，以及它们的运行态环境。对应的，虚拟机可以理解为模拟运行的一整套操作系统(提供了运行态环境和其他系统环境)和跑在上面的应用。</p>
</blockquote>
<h4 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h4><blockquote>
<p>启动容器有两种方式，一种是基于镜像新建一个容器并启动，另外一个是将在终止状态(stopped)的容器重新启动。</p>
</blockquote>
<h5 id="新建并启动容器"><a href="#新建并启动容器" class="headerlink" title="新建并启动容器"></a>新建并启动容器</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run ubuntu:14.04 /bin/echo 'Hello World'</span><br><span class="line">Unable to find image 'ubuntu:14.04' locally</span><br><span class="line">14.04: Pulling from library/ubuntu</span><br><span class="line">aa1a66b8583a: Pull complete </span><br><span class="line">aaccc2e362b2: Pull complete </span><br><span class="line">a53116a2808f: Pull complete </span><br><span class="line">b3a7298e318c: Pull complete </span><br><span class="line">Digest: sha256:f961d3d101e66017fc6f0a63ecc0ff15d3e7b53b6a0ac500cd1619ded4771bd6</span><br><span class="line">Status: Downloaded newer image for ubuntu:14.04</span><br><span class="line">Hello World</span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建并启动一个容器，因为本地没有ubuntu14.04的镜像，所以会先下载镜像并启动容器，并输出一个<span class="string">"Hello World"</span>。运行完命令后这个容器就会终止。</span></span><br><span class="line">root@ruopu:~# docker run ubuntu:14.04 /bin/echo 'Hello World'</span><br><span class="line">Hello World</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次执行相同命令时就不会再下载了</span></span><br><span class="line"></span><br><span class="line">root@ruopu:~# docker run -t -i ubuntu:14.04 /bin/bash</span><br><span class="line">root@eb5dd3071f75:/#</span><br><span class="line"><span class="meta">#</span><span class="bash"> -t选项让Docker分配一个伪终端(pseudo-tty)并绑定到容器的标准输入上，-i则让容器的标准输入保持打开。</span></span><br><span class="line">root@f55cb4d1089e:/# pwd</span><br><span class="line">/</span><br><span class="line">root@f55cb4d1089e:/# ls</span><br><span class="line">bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在交互模式下，用户可以通过所创建的终端来输入命令</span></span><br><span class="line"></span><br><span class="line">============================================================================================</span><br><span class="line">当利用docker run来创建容器时，Docker 在后台运行的标准操作包括：</span><br><span class="line">* 检查本地是否存在指定的镜像，不存在就从公有仓库下载</span><br><span class="line">* 利用镜像创建并启动一个容器</span><br><span class="line">* 分配一个文件系统，并在只读的镜像层外面挂载一层可读写层</span><br><span class="line">* 从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去</span><br><span class="line">* 从地址池配置一个 ip 地址给容器</span><br><span class="line">* 执行用户指定的应用程序</span><br><span class="line">* 执行完毕后容器被终止</span><br><span class="line">============================================================================================</span><br></pre></td></tr></table></figure>
<h5 id="启动已终止容器"><a href="#启动已终止容器" class="headerlink" title="启动已终止容器"></a>启动已终止容器</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                NAMES</span><br><span class="line">f55cb4d1089e        ubuntu:14.04        "/bin/bash"              6 hours ago         Up 6 hours                               competent_feistel</span><br><span class="line">54b6e4618182        nginx:v2            "nginx -g 'daemon of…"   27 hours ago        Up 27 hours         0.0.0.0:81-&gt;80/tcp   web2</span><br><span class="line">4fc2b542c0de        nginx               "nginx -g 'daemon of…"   28 hours ago        Exited 28 hours         0.0.0.0:80-&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看正在运行的已有容器，如果要查看全部容器，要在命令最后加-a选项</span></span><br><span class="line">root@ruopu:~# docker start f55c</span><br><span class="line">f55c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动已终止的容器，重启可以使用restart</span></span><br><span class="line">root@ruopu:~# docker exec -it f55c bash  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入正在运行的容器</span></span><br><span class="line">root@f55cb4d1089e:/# ps</span><br><span class="line">  PID TTY          TIME CMD</span><br><span class="line">   36 pts/1    00:00:00 bash</span><br><span class="line">   52 pts/1    00:00:00 ps</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可见，容器中仅运行了指定的 bash 应用。这种特点使得 Docker 对资源的利用率极高，是货真价实的轻量级虚拟化。</span></span><br></pre></td></tr></table></figure>
<h4 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run ubuntu:14.04 /bin/sh -c "while true; do echo 'hello world'; sleep 1; done"</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果不使用-d参数运行容器，容器会把输出的结果 (STDOUT) 打印到宿主机上面</span></span><br><span class="line">root@ruopu:~# docker run -d ubuntu:14.04 /bin/sh -c "while true; do echo 'hello world'; sleep 1; done" </span><br><span class="line">299d22cbda4f6d648095732350572999aa6937cad2d0d20db5ab37f09340c19e</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果使用了-d参数运行容器，此时容器会在后台运行并不会把输出的结果 (STDOUT) 打印到宿主机上面。</span></span><br><span class="line">root@ruopu:~# docker logs 299d22</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出结果可以用<span class="string">"docker logs 容器ID"</span>查看。容器是否会长久运行是和docker run指定的命令有关，和-d参数无关。使用-d参数启动后会返回一个唯一的ID。</span></span><br><span class="line">root@ruopu:~# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                NAMES</span><br><span class="line">299d22cbda4f        ubuntu:14.04        "/bin/sh -c 'while t…"   2 minutes ago       Up 2 minutes                             sharp_booth</span><br><span class="line">f55cb4d1089e        ubuntu:14.04        "/bin/bash"              6 hours ago         Up 6 hours                               competent_feistel</span><br><span class="line">54b6e4618182        nginx:v2            "nginx -g 'daemon of…"   27 hours ago        Up 27 hours         0.0.0.0:81-&gt;80/tcp   web2</span><br><span class="line">4fc2b542c0de        nginx               "nginx -g 'daemon of…"   28 hours ago        Up 28 hours         0.0.0.0:80-&gt;80/tcp   webserver</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此命令可以查看容器的信息。</span></span><br><span class="line">root@ruopu:~# docker container logs 299d</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此命令也可以看到容器中输出的内容。logs后可以使用容器ID或容器NAMES。语法：docker container logs [container ID or NAMES]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当使用对容器操作的指令时，docker命令可以默认对容器进行操作，所以不加container也可以。</span></span><br></pre></td></tr></table></figure>
<h4 id="终止容器"><a href="#终止容器" class="headerlink" title="终止容器"></a>终止容器</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker container stop sharp_booth</span><br><span class="line">sharp_booth</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用stop命令终止容器，容器可以用NAMES或ID指明</span></span><br><span class="line">root@ruopu:~# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS                NAMES</span><br><span class="line">299d22cbda4f        ubuntu:14.04        "/bin/sh -c 'while t…"   7 minutes ago       Exited (137) 11 seconds ago                        sharp_booth</span><br><span class="line">e06be3875296        ubuntu:14.04        "/bin/sh -c 'while t…"   9 minutes ago       Exited (0) 9 minutes ago                           recursing_vaughan</span><br><span class="line">2d025ef6aa4c        ubuntu:14.04        "/bin/sh -c 'while t…"   9 minutes ago       Exited (0) 9 minutes ago                           jolly_merkle</span><br><span class="line">f2e9d5847f7f        ubuntu:14.04        "/bin/sh -c 'while t…"   9 minutes ago       Exited (2) 9 minutes ago                           keen_johnson</span><br><span class="line">f55cb4d1089e        ubuntu:14.04        "/bin/bash"              6 hours ago         Up 6 hours                                         competent_feistel</span><br><span class="line">eb5dd3071f75        ubuntu:14.04        "/bin/bash"              7 hours ago         Exited (0) 6 hours ago                             flamboyant_edison</span><br><span class="line">c43e0c0c2836        ubuntu:14.04        "/bin/echo 'Hello Wo…"   7 hours ago         Exited (0) 7 hours ago                             mystifying_nobel</span><br><span class="line">9a4c0b5b979b        ubuntu:14.04        "/bin/echo 'Hello Wo…"   7 hours ago         Exited (0) 7 hours ago                             focused_stallman</span><br><span class="line">54b6e4618182        nginx:v2            "nginx -g 'daemon of…"   27 hours ago        Up 27 hours                   0.0.0.0:81-&gt;80/tcp   web2</span><br><span class="line">4fc2b542c0de        nginx               "nginx -g 'daemon of…"   28 hours ago        Up 28 hours                   0.0.0.0:80-&gt;80/tcp   webserver</span><br><span class="line">c17f952574b5        hello-world         "/hello"                 28 hours ago        Exited (0) 28 hours ago                            clever_bell</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用此命令查看到所有的容器，包括已停止的容器，在信息中会被标记为<span class="string">"Exited"</span>。仍在运行的容器被标记为<span class="string">"Up"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果是只启动了一个终端的容器，用户可以在容器中使用<span class="built_in">exit</span>命令或Ctrl+d来退出终端，退出时创建的容器立刻终止。</span></span><br><span class="line">root@ruopu:~# docker container restart f55c</span><br><span class="line">f55c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用restart命令可以重启容器，容器可以使用ID或NAMES指定</span></span><br></pre></td></tr></table></figure>
<h4 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h4><h5 id="attach命令（不建议使用）"><a href="#attach命令（不建议使用）" class="headerlink" title="attach命令（不建议使用）"></a>attach命令（不建议使用）</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run -dit ubuntu:14.04</span><br><span class="line">64dda1b25fac61f165a0c7ab7c7807f9adf7ac173cdbdc907b0815d796ae0473</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在后台启动一个容器</span></span><br><span class="line">root@ruopu:~# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                NAMES</span><br><span class="line">64dda1b25fac        ubuntu:14.04        "/bin/bash"              About a minute ago   Up About a minute                        gifted_swartz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看已启动的容器</span></span><br><span class="line">root@ruopu:~# docker attach 64dd</span><br><span class="line">root@64dda1b25fac:/#</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用attach进入容器。此时如果使用<span class="built_in">exit</span>退出容器，那么会导致容器的停止。</span></span><br><span class="line">root@64dda1b25fac:/# exit</span><br><span class="line">exit</span><br><span class="line">root@ruopu:~# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS                NAMES</span><br><span class="line">64dda1b25fac        ubuntu:14.04        "/bin/bash"              5 minutes ago       Exited (0) 13 seconds ago                          gifted_swartz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看显示容器已停止</span></span><br></pre></td></tr></table></figure>
<h5 id="exec命令（建议使用）"><a href="#exec命令（建议使用）" class="headerlink" title="exec命令（建议使用）"></a>exec命令（建议使用）</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker run -dit ubuntu:14.04</span><br><span class="line">c063d378b1191193d70d44c8fcb7a81e3e5bf0ab8a2f2cb1db4d526b6b510005</span><br><span class="line">root@ruopu:~# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                NAMES</span><br><span class="line">c063d378b119        ubuntu:14.04        "/bin/bash"              15 seconds ago      Up 15 seconds                            agitated_hopper</span><br><span class="line">root@ruopu:~# docker exec -i c063 bash</span><br><span class="line"></span><br><span class="line">ls</span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">dev</span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只用-i参数时，由于没有分配伪终端，界面没有我们熟悉的Linux命令提示符，但命令执行结果仍然可以返回。直接输入命令就会返回结果。</span></span><br><span class="line">root@ruopu:~# docker exec -it c063 bash</span><br><span class="line">root@c063d378b119:/#</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当-i、-t参数一起使用时，则可以看到我们熟悉的 Linux 命令提示符。</span></span><br><span class="line">root@c063d378b119:/# exit</span><br><span class="line">exit</span><br><span class="line">root@ruopu:~# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                NAMES</span><br><span class="line">c063d378b119        ubuntu:14.04        "/bin/bash"              4 minutes ago       Up 4 minutes                             agitated_hopper</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果使用<span class="built_in">exit</span>退出容器，不会导致容器的停止。</span></span><br></pre></td></tr></table></figure>
<h4 id="导出、导入容器"><a href="#导出、导入容器" class="headerlink" title="导出、导入容器"></a>导出、导入容器</h4><h5 id="导出容器"><a href="#导出容器" class="headerlink" title="导出容器"></a>导出容器</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS                NAMES</span><br><span class="line">9a4c0b5b979b        ubuntu:14.04        "/bin/echo 'Hello Wo…"   7 hours ago         Exited (0) 7 hours ago                             focused_stallman</span><br><span class="line">root@ruopu:~# docker export 9a4c0b5b979b &gt; ubuntu.tar</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样就将容器快照导出到本地文件</span></span><br></pre></td></tr></table></figure>
<h5 id="导入容器快照"><a href="#导入容器快照" class="headerlink" title="导入容器快照"></a>导入容器快照</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# cat ubuntu.tar | docker import - test/ubuntu:v1.0</span><br><span class="line">sha256:34a66c78f8af873bd07ab5b53073b4b2fbfd0a53cece350b54be9ef9910925ad</span><br><span class="line">root@ruopu:~# docker image ls</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">test/ubuntu         v1.0                34a66c78f8af        11 seconds ago      175MB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入容器，容器的REPOSITORY是<span class="built_in">test</span>/ubuntu，TAG是v1.0</span></span><br><span class="line"></span><br><span class="line">root@ruopu:~# docker import http://example.com/exampleimage.tgz example/imagerepo</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以通过指定URL或某个目录来导入</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户既可以使用docker import来导入镜像存储文件到本地镜像库，也可以使用docker load来导入一个容器快照到本地镜像库。这两者的区别在于容器快照文件将丢弃所有的历史记录和元数据信息(即仅保存容器当时的快照状态)，而镜像存储文件将保存完整记录，体积也要大。此外，从容器快照文件导入时可以重新指定标签等元数据信息。</span></span><br></pre></td></tr></table></figure>
<h4 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h4><h5 id="删除已停止的容器"><a href="#删除已停止的容器" class="headerlink" title="删除已停止的容器"></a>删除已停止的容器</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS                NAMES</span><br><span class="line">c063d378b119        ubuntu:14.04        "/bin/bash"              14 minutes ago      Up 14 minutes                                      agitated_hopper</span><br><span class="line">64dda1b25fac        ubuntu:14.04        "/bin/bash"              20 minutes ago      Exited (0) 15 minutes ago                          gifted_swartz</span><br><span class="line">299d22cbda4f        ubuntu:14.04        "/bin/sh -c 'while tb"	 34 minutes ago      Exited (137) 27 minutes ago</span><br><span class="line">root@ruopu:~# docker container rm gifted_swartz</span><br><span class="line">gifted_swartz</span><br><span class="line">root@ruopu:~# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS                NAMES</span><br><span class="line">c063d378b119        ubuntu:14.04        "/bin/bash"              14 minutes ago      Up 14 minutes                                      agitated_hopper</span><br><span class="line">299d22cbda4f        ubuntu:14.04        "/bin/sh -c 'while tb"	 34 minutes ago      Exited (137) 27 minutes ago</span><br></pre></td></tr></table></figure>
<h5 id="删除运行中的容器"><a href="#删除运行中的容器" class="headerlink" title="删除运行中的容器"></a>删除运行中的容器</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS                NAMES</span><br><span class="line">c063d378b119        ubuntu:14.04        "/bin/bash"              14 minutes ago      Up 14 minutes                                      agitated_hopper</span><br><span class="line">root@ruopu:~# docker container rm -f f55c</span><br><span class="line">f55c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-f选项强制删除运行中的容器，Docker 会发送SIGKILL信号给容器。通过容器ID删除容器</span></span><br><span class="line">root@ruopu:~# docker container ls -a     </span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS                NAMES</span><br></pre></td></tr></table></figure>
<h5 id="清理所有处于终止状态的容器"><a href="#清理所有处于终止状态的容器" class="headerlink" title="清理所有处于终止状态的容器"></a>清理所有处于终止状态的容器</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@ruopu:~# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS                NAMES</span><br><span class="line">c063d378b119        ubuntu:14.04        "/bin/bash"              21 minutes ago      Up 21 minutes          </span><br><span class="line">........</span><br><span class="line">root@ruopu:~# docker container prune </span><br><span class="line">WARNING! This will remove all stopped containers.</span><br><span class="line">Are you sure you want to continue? [y/N] y</span><br><span class="line">Deleted Containers:</span><br><span class="line">299d22cbda4f6d648095732350572999aa6937cad2d0d20db5ab37f09340c19e</span><br><span class="line">e06be3875296e3f0beaea61f8f48517c4e2ac39ee8852eef24bb2d6c871b0e12</span><br><span class="line">........</span><br><span class="line">Total reclaimed space: 5B</span><br><span class="line">root@ruopu:~# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                NAMES</span><br><span class="line">c063d378b119        ubuntu:14.04        "/bin/bash"              21 minutes ago      Up 21 minutes                            agitated_hopper</span><br><span class="line">54b6e4618182        nginx:v2            "nginx -g 'daemon ofb</span><br><span class="line">........</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/21/netplan命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/21/netplan命令/" itemprop="url">
                  netplan命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-21 11:25:40" itemprop="dateCreated datePublished" datetime="2018-11-21T11:25:40+08:00">2018-11-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-01-17 08:19:45" itemprop="dateModified" datetime="2020-01-17T08:19:45+08:00">2020-01-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>Netplan 从 /etc/netplan/*.yaml 读取配置，配置可以是管理员或者系统安装人员配置； 也可以是云镜像或者其他操作系统部署设施自动生成。 在系统启动阶段早期， Netplan 在 /run 目录生成好配置文件并将设备控制权交给相关后台程序。</p>
<p><img src="/images/netplan/netplan.png" alt=""></p>
<p>Netplan 目前支持以下两种 <strong>网络管理工具</strong> ：</p>
<ul>
<li>NetworkManager</li>
<li>Systemd-networkd</li>
</ul>
<p>一言以蔽之，从前你需要根据不同的管理工具编写网络配置，现在 Netplan 将管理工具差异性给屏蔽了。 你只需按照 Netplan 规范编写 YAML 配置，不管底层管理工具，只要有这份配置文件即可。</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">    version: 2</span><br><span class="line">    renderer: NetworkManager</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个配置让 NetworkManager 管理所有网络设备 （默认，只要检测到以太网设备接线，便以 DHCP 模式启动该设备）。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 Systemd-networkd ，则不会自动启动网络设备； 每个需要启用的网卡均需要在 /etc/netplan 配置文</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 件中指定配置。 网络配置示例如下：</span></span><br><span class="line">network:</span><br><span class="line">    ethernets:</span><br><span class="line">        enp0s3:</span><br><span class="line">            addresses: []</span><br><span class="line">            dhcp4: true</span><br><span class="line">            optional: true</span><br><span class="line">        enp0s8:</span><br><span class="line">            addresses: [192.168.56.3/24]</span><br><span class="line">            dhcp4: no</span><br><span class="line">            optional: true</span><br><span class="line">    version: 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个配置为 enp0s3 网卡开启 DHCP 自动获取地址； 为 enp0s8 网卡配置了一个静态 IP 192.168.56.3 ，掩码是 24 位。</span></span><br></pre></td></tr></table></figure>
<h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><p>netplan 操作命令提供两个子命令：</p>
<ul>
<li>netplan generate ：以 /etc/netplan 配置为管理工具生成配置；</li>
<li>netplan apply ：应用配置(以便生效)，必要时重启管理工具；</li>
</ul>
<p>因此，调整 /etc/netplan 配置后，需要执行以下命令方能生效：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> netplan apply</span></span><br></pre></td></tr></table></figure>
<ul>
<li>netplan try：测试配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo netplan try</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的命令会在应用配置之前验证其是否有效。如果成功，你就会看到配置被接受。换句话说，Netplan 会尝试将</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新的配置应用到运行的系统上。如果新的配置失败了，Netplan 会自动地恢复到之前使用的配置。成功后，新的配</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 置就会被使用。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看当前系统的 DNS Servers</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systemd-resolve --status</span></span><br><span class="line">Global</span><br><span class="line">          DNSSEC NTA: 10.in-addr.arpa</span><br><span class="line">                      16.172.in-addr.arpa</span><br><span class="line">                      168.192.in-addr.arpa</span><br><span class="line">                      17.172.in-addr.arpa</span><br><span class="line">                      18.172.in-addr.arpa</span><br><span class="line">                      19.172.in-addr.arpa</span><br><span class="line">                      20.172.in-addr.arpa</span><br><span class="line">                      21.172.in-addr.arpa</span><br><span class="line">                      22.172.in-addr.arpa</span><br><span class="line">                      23.172.in-addr.arpa</span><br><span class="line">                      24.172.in-addr.arpa</span><br><span class="line">                      25.172.in-addr.arpa</span><br><span class="line">                      26.172.in-addr.arpa</span><br><span class="line">                      27.172.in-addr.arpa</span><br><span class="line">                      28.172.in-addr.arpa</span><br><span class="line">                      29.172.in-addr.arpa</span><br><span class="line">                      30.172.in-addr.arpa</span><br><span class="line">                      31.172.in-addr.arpa</span><br><span class="line">                      corp</span><br><span class="line">                      d.f.ip6.arpa</span><br><span class="line">                      home</span><br><span class="line">                      internal</span><br><span class="line">                      intranet</span><br><span class="line">                      lan</span><br><span class="line">                      local</span><br><span class="line">                      private</span><br><span class="line">                      test</span><br><span class="line"></span><br><span class="line">Link 2 (enp0s5)</span><br><span class="line">      Current Scopes: DNS</span><br><span class="line">       LLMNR setting: yes</span><br><span class="line">MulticastDNS setting: no</span><br><span class="line">      DNSSEC setting: no</span><br><span class="line">    DNSSEC supported: no</span><br><span class="line">         DNS Servers: 8.8.8.8</span><br><span class="line">                      8.8.4.4</span><br></pre></td></tr></table></figure>
<h3 id="配置IP地址"><a href="#配置IP地址" class="headerlink" title="配置IP地址"></a>配置IP地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/netplay/50-cloud-init.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> ubuntu18.04Server中调整了网络地址配置方式。如果没有此配置文件，需要手动创建。每个网络端口对应一个配置文件</span></span><br><span class="line">   network:</span><br><span class="line">    ethernets:</span><br><span class="line">        ens33:</span><br><span class="line">            addresses: [192.168.1.90/24]</span><br><span class="line">            dhcp4: false</span><br><span class="line">            gateway4: 192.168.1.1</span><br><span class="line">            nameservers:</span><br><span class="line">              addresses:</span><br><span class="line">              - 114.114.114.114</span><br><span class="line">              search: []</span><br><span class="line">    version: 2</span><br><span class="line"> netplan apply</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 配置地址后使用此命令让配置生效</span></span><br><span class="line"> netplan --debug apply</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 使用此命令会给出错误提示</span></span><br></pre></td></tr></table></figure>
<h3 id="配置无线地址"><a href="#配置无线地址" class="headerlink" title="配置无线地址"></a>配置无线地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">    version: 2</span><br><span class="line">    renderer: networkd</span><br><span class="line">    ethernets:</span><br><span class="line">            eth0:</span><br><span class="line">                    addresses:</span><br><span class="line">                            - 172.16.1.253/24</span><br><span class="line"><span class="meta">#</span><span class="bash"> IP地址，这里不要使用类似于“255.255.255.0”的方法而是直接指定掩码位数24为（/24）</span></span><br><span class="line">                    gateway4: 172.16.1.1</span><br><span class="line">                    nameservers:</span><br><span class="line">                            addresses: [172.16.1.1,8.8.8.8] </span><br><span class="line">                            # DNS服务器地址，有多个的情况请使用英文的逗号隔开</span><br><span class="line">    wifis:</span><br><span class="line">            wlan0:</span><br><span class="line">                    dhcp4: no</span><br><span class="line">                    dhcp6: no</span><br><span class="line">                    addresses: [172.16.1.252/24] </span><br><span class="line"><span class="meta">#</span><span class="bash"> IP地址，这里不要使用类似于“255.255.255.0”的方法而是直接指定掩码位数24为（/24）</span></span><br><span class="line">                    gateway4: 172.16.1.1</span><br><span class="line">                    nameservers:</span><br><span class="line">                            addresses: [172.16.1.1,8.8.8.8]</span><br><span class="line">                            # DNS服务器地址，有多个的情况请使用英文的逗号隔开</span><br><span class="line">                    access-points:</span><br><span class="line">                            "zczl": # 无线网络的SSID</span><br><span class="line">                                    password: "123456" # 无线网络的密码</span><br><span class="line">                                    </span><br><span class="line">ubuntu@ubuntu:~$ sudo netplan --debug apply </span><br><span class="line"><span class="meta">#</span><span class="bash"> netplan检查配置文件情况，如果没有问题就会输入下面的结果，如果有问题就会报错。</span></span><br><span class="line">** (generate:16726): DEBUG: 12:53:29.344: Processing input file /etc/netplan/50-cloud-init.yaml..</span><br><span class="line">** (generate:16726): DEBUG: 12:53:29.345: starting new processing pass</span><br><span class="line">** (generate:16726): DEBUG: 12:53:29.346: wlan0: adding wifi AP 'zczl'</span><br><span class="line">** (generate:16726): DEBUG: 12:53:29.346: wlan0: setting default backend to 1</span><br><span class="line">** (generate:16726): DEBUG: 12:53:29.346: Configuration is valid</span><br><span class="line">** (generate:16726): DEBUG: 12:53:29.347: eth0: setting default backend to 1** (generate:16726): DEBUG: 12:53:29.347: Configuration is valid** (generate:16726): DEBUG: 12:53:29.348: Generating output files..</span><br><span class="line">** (generate:16726): DEBUG: 12:53:29.349: NetworkManager: definition eth0 is not for us (backend 1)</span><br><span class="line">** (generate:16726): DEBUG: 12:53:29.349: wlan0: Creating wpa_supplicant configuration file run/netplan/wpa-wlan0.conf</span><br><span class="line">** (generate:16726): DEBUG: 12:53:29.350: Creating wpa_supplicant service enablement link /run/systemd/system/systemd-networkd.service.wants/netplan-wpa@wlan0.service</span><br><span class="line">** (generate:16726): DEBUG: 12:53:29.351: NetworkManager: definition wlan0 is not for us (backend 1)(generate:16726): GLib-DEBUG: 12:53:29.351: posix_spawn avoided (fd close requested) </span><br><span class="line">DEBUG:netplan generated networkd configuration changed, restarting networkd</span><br><span class="line">DEBUG:no netplan generated NM configuration existsDEBUG:eth0 not found in &#123;&#125;</span><br><span class="line">DEBUG:wlan0 not found in &#123;&#125;</span><br><span class="line">DEBUG:Merged config:</span><br><span class="line">    network:  </span><br><span class="line">        bonds: &#123;&#125;  </span><br><span class="line">        bridges: &#123;&#125;  </span><br><span class="line">        ethernets:</span><br><span class="line">            eth0:</span><br><span class="line">                  addresses:</span><br><span class="line">                  - 172.16.1.253/24</span><br><span class="line">                  gateway4: 172.16.1.1      </span><br><span class="line">                  nameservers:        </span><br><span class="line">                      addresses:        </span><br><span class="line">                          - 172.16.1.1        </span><br><span class="line">                          - 8.8.8.8  </span><br><span class="line">            vlans: &#123;&#125;  </span><br><span class="line">            wifis:    </span><br><span class="line">                wlan0:      </span><br><span class="line">                    access-points:        </span><br><span class="line">                        zczl:          </span><br><span class="line">                        password: hz123456      </span><br><span class="line">                        addresses:      </span><br><span class="line">                        - 172.16.1.252/24      </span><br><span class="line">                        dhcp4: false      </span><br><span class="line">                        dhcp6: false      </span><br><span class="line">                        gateway4: 172.16.1.1      </span><br><span class="line">                        nameservers:        </span><br><span class="line">                            addresses:        </span><br><span class="line">                            - 172.16.1.1        </span><br><span class="line">                            - 8.8.8.8</span><br><span class="line">DEBUG:Skipping non-physical interface: lo</span><br><span class="line">DEBUG:device eth0 operstate is up, not changing</span><br><span class="line">DEBUG:device wlan0 operstate is dormant, not changingDEBUG:&#123;&#125;</span><br><span class="line">DEBUG:netplan triggering .link rules for loDEBUG:netplan triggering .link rules for eth0</span><br><span class="line">DEBUG:netplan triggering .link rules for wlan0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo netplan apply   #应用配置</span><br></pre></td></tr></table></figure>
<h3 id="配置桥接"><a href="#配置桥接" class="headerlink" title="配置桥接"></a>配置桥接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">* 之前</span><br><span class="line">network:</span><br><span class="line">    ethernets:</span><br><span class="line">        enp5s0:</span><br><span class="line">            dhcp4: false </span><br><span class="line">            addresses: [192.168.40.20/24]</span><br><span class="line">            gateway4: 192.168.40.1 </span><br><span class="line">            nameservers:</span><br><span class="line">                addresses:</span><br><span class="line">                - 223.5.5.5</span><br><span class="line">                - 114.114.114.114</span><br><span class="line">                - 192.168.40.1</span><br><span class="line">        enp6s0:</span><br><span class="line">            dhcp4: true</span><br><span class="line">            nameservers:</span><br><span class="line">                addresses:</span><br><span class="line">                - 223.5.5.5</span><br><span class="line">                - 223.6.6.6</span><br><span class="line">    version: 2</span><br><span class="line">    </span><br><span class="line">* 修改为桥接</span><br><span class="line">network:</span><br><span class="line">    ethernets:</span><br><span class="line">        enp5s0:</span><br><span class="line">            dhcp4: false </span><br><span class="line">        enp6s0:</span><br><span class="line">            dhcp4: true</span><br><span class="line">            nameservers:</span><br><span class="line">                addresses:</span><br><span class="line">                - 223.5.5.5</span><br><span class="line">                - 223.6.6.6</span><br><span class="line">    bridges:</span><br><span class="line">      kvmbr0:</span><br><span class="line">        interfaces: [enp5s0]</span><br><span class="line">        dhcp4: no</span><br><span class="line">        addresses: [192.168.40.20/24]</span><br><span class="line">        gateway4: 192.168.40.1</span><br><span class="line">        nameservers:</span><br><span class="line">          addresses: [192.168.40.1,223.5.5.5,223.6.6.6,114.114.114.114]</span><br><span class="line">    version: 2</span><br><span class="line">    </span><br><span class="line">sudo networkctl status -a</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/19/Wireshark使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/19/Wireshark使用/" itemprop="url">
                  Wireshark使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-19 14:57:55" itemprop="dateCreated datePublished" datetime="2018-11-19T14:57:55+08:00">2018-11-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-11 11:33:55" itemprop="dateModified" datetime="2019-06-11T11:33:55+08:00">2019-06-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>打开软件后，要选择对哪块网卡抓包，双击即可进入。或点击前头指向的图标</p>
<p><img src="/images/Wireshark/Wireshark启动1.jpg" alt=""></p>
<p>方框部分表示启用混杂模式，然后点击start即可。如果不选择混杂模式，那么抓到的包就都是从选择的网卡进或出的包，也就是只抓取与本机相关的包。如果选择混杂模式，那么经过本机网卡的包都会被抓取。</p>
<p><img src="/images/Wireshark/Wireshark启动2.jpg" alt=""></p>
<p>下面方框部分是抓包筛选器，可以通过筛选器过滤掉不想要的数据包</p>
<p><img src="/images/Wireshark/Wireshark启动3.jpg" alt=""></p>
<p>点击方框部分可以创建一个新的抓包筛选器</p>
<p><img src="/images/Wireshark/Wireshark启动4.jpg" alt=""></p>
<p><img src="/images/Wireshark/Wireshark启动5.jpg" alt=""></p>
<p>比如只想抓IP地址是192.168.2.1的数据包，就可以选择下面方框部分</p>
<p><img src="/images/Wireshark/Wireshark启动6.jpg" alt=""></p>
<p>也可以只抓IP的包（方框部分），或管理筛选器规则（箭头部分）</p>
<p><img src="/images/Wireshark/Wireshark启动7.jpg" alt=""></p>
<p>下面是管理筛选器页面，可以自定义或删除规则</p>
<p><img src="/images/Wireshark/Wireshark启动8.jpg" alt=""></p>
<p>也可以手动输入，这里表示只抓取与本机IP相关的包，用host引导</p>
<p><img src="/images/Wireshark/Wireshark启动9.jpg" alt=""></p>
<p>这时可以看到页面中标明只抓取本机的包</p>
<p><img src="/images/Wireshark/Wireshark启动10.jpg" alt=""></p>
<p>中间部分是包的分层，从方框中的信息可以看到目标地址是本机。</p>
<p><img src="/images/Wireshark/Wireshark启动11.jpg" alt=""></p>
<p>先要停止抓包，才能保存</p>
<p><img src="/images/Wireshark/Wireshark启动12.jpg" alt=""></p>
<p><img src="/images/Wireshark/Wireshark启动13.jpg" alt=""></p>
<p>可以选择保存类型，建议使用pcap的格式，这种格式使用更广泛，也就是下图中的第二种格式，在保存时还可以选择Compress with gzip来进行压缩保存</p>
<p><img src="/images/Wireshark/Wireshark启动14.jpg" alt=""></p>
<p>首选项</p>
<p><img src="/images/Wireshark/Wireshark启动15.jpg" alt=""></p>
<p>调整结构</p>
<p><img src="/images/Wireshark/Wireshark启动16.jpg" alt=""></p>
<p>调整后的效果，这里取消了16进制信息的显示</p>
<p><img src="/images/Wireshark/Wireshark启动17.jpg" alt=""></p>
<p>还可以对包的显示信息列进行调整，也可以添加或删除</p>
<p><img src="/images/Wireshark/Wireshark启动18.jpg" alt=""></p>
<p>方框中是wireshark可以解码的所有协议类型</p>
<p><img src="/images/Wireshark/Wireshark启动19.jpg" alt=""></p>
<p>数据会先经过抓包筛选器进行过滤，之后再对抓到的包进行显示筛选</p>
<p>方框部分就是显示筛选器</p>
<p><img src="/images/Wireshark/Wireshark启动20.jpg" alt=""></p>
<p>只想查看到DNS相关的包，输入好后按右面的箭头进行应用。</p>
<p><img src="/images/Wireshark/Wireshark启动21.jpg" alt=""></p>
<p>这里想创建一个组合的显示条件，输入udp，之后在包分层中按红框选择，在Source上右键，选择Apply as Filter中的and not selected。之后就会在显示筛选器中出现一条筛选语句。这条语句表示，即是udp的包，但来源不是192.168.0.20地址的包</p>
<p><img src="/images/Wireshark/Wireshark启动22.jpg" alt=""></p>
<p>也可以把规则改为目的地址ip.dst，或地址ip.addr。筛选完成后可再按上面步骤进一步筛选，一定要选择and not selected，这样规则就会叠加。</p>
<p><img src="/images/Wireshark/Wireshark启动23.jpg" alt=""></p>
<h3 id="Wireshark信息统计"><a href="#Wireshark信息统计" class="headerlink" title="Wireshark信息统计"></a>Wireshark信息统计</h3><p>统计功能基本都在Statistics菜单下</p>
<p><img src="/images/Wireshark/Wireshark信息统计1.jpg" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/19/tcpdump命令使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/19/tcpdump命令使用/" itemprop="url">
                  tcpdump命令使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-19 10:27:01" itemprop="dateCreated datePublished" datetime="2018-11-19T10:27:01+08:00">2018-11-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-02-26 22:36:28" itemprop="dateModified" datetime="2020-02-26T22:36:28+08:00">2020-02-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="tcpdump命令使用"><a href="#tcpdump命令使用" class="headerlink" title="tcpdump命令使用"></a>tcpdump命令使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">* tcpdump如果不指定字节大小，默认只抓每个包的前68个字节。通常是把tcp、ip、还有包头可以抓完整的</span><br><span class="line">例：</span><br><span class="line">root@kali:~# tcpdump -i eth0 -s 0 -w a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> -i指定网卡；-s指定数据包的大小，如果用0就表示全部包，这里应该指定的是多少字节；-w指定将结果保存到一个</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 文件中。这会抓取到所有经过eth0端口的包。70900 packets captured表示抓到了70900个包</span></span><br><span class="line">ping 172.16.0.108</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用另一台主机ping这台kali，产生一些数据包</span></span><br><span class="line">tcpdump -r a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 读取刚才生成的包文件</span></span><br><span class="line">tcpdump -A -r a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用ASCII码的格式显示包</span></span><br><span class="line">tcpdump -X -r a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用16进制的格式显示包</span></span><br><span class="line">tcpdump -i eth0 tcp port 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 抓取eth0上的tcp协议端口22的包，这叫抓包筛选器</span></span><br><span class="line">nc -nv 172.16.0.108 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用nc命令连接地址的端口</span></span><br><span class="line">nc -nv 172.16.0.108 80</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接80端口，但这时是不会抓取包的，因为只监听了网络的22端口</span></span><br><span class="line"></span><br><span class="line">例：显示筛选器</span><br><span class="line">tcpdump -n -r http.cap | awk '&#123;print $3&#125;' | sort -u</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示筛选器。-n表示不对包内的地址做名称解析。sort的-u选项是去除重复的项</span></span><br><span class="line">tcpdump -n src host 172.16.0.108 -r a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> src host表示源地址，这是只显示源地址是172.16.0.108的包</span></span><br><span class="line">tcpdump -n dst host 172.16.0.108 -r a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示目标地址</span></span><br><span class="line">tcpdump -n port 53 -r http.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示端口为53的包</span></span><br><span class="line">tcpdump -n tcp port 53 -r http.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示tcp的包，也可以显示udp协议的包</span></span><br><span class="line">tcpdump -nX port 80 -r http.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以加上X选项，以16进制显示</span></span><br><span class="line"></span><br><span class="line">* 高级筛选</span><br><span class="line">可以筛选包头里其他部分。图中是TCP的包头结构，以8个位为一个字节，每一行的内容表示4个字节，0-7是一个字节，8-16又是一个字节。一共是32个位。源端口占用了前面的16个位，也就是两个字节。目的端口占用后面的2个位（16个字节）。之后的Sequence Number和Acknowledgment Number都是占用32个位的，也就是4个字节。下面一个字节被分成了两个部分，第一部分是数据的偏移量，如果这时包被分段了，那么就会有数据的偏移量，保留了几个位之后，后面的就是tcp的flag，也就是标签位，表示当前这个包是什么类型的包，如是SYN包，还是回的ACK+SYN包，每一个位表示一个包的类型，如FIN是1，就表示FIN的flag标签的包，也就是哪位是1，就表示是那个位对应的类型的包有效。三次握手后，客户端发送的就是ACK+PSH包，这时这两个会标记为1，表示这是数据传输最起始的步骤。使用筛选时，如果不想看握手的包，就可以指定ACK+PSH为1的数据包。在图中，类型有8个，每个占用一个位，一共8位，我们要筛选的就是ACK+PSH是1，其他位都是0的包，计算成十进制就是24，二进制是00011000，所以转换为十进制是24。另外在表示类型的行上面有三行，共占12个字节。在类型前面的Data Offset和Res.还占用了一个字节，所以tcp的flag位是tcp包头时的每14个字节。（因为tcp包头的字节是从0开始的，这里只筛选tcp包头里第14个字节，但从表达式来说，应该是第13号。也就是第13号字节，实际就是第14个字节）转换为十进制是24的这些数据包，表达式命令如果</span><br><span class="line">tcpdump -A -n 'tcp[13] = 24' -r http.cap</span><br></pre></td></tr></table></figure>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>用简单的话来定义tcpdump，就是：dump the traffic on a network，根据使用者的定义对网络上的数据包进行截获的包分析工具。 tcpdump可以将网络中传送的数据包的“头”完全截获下来提供分析。它支持针对网络层、协议、主机、网络或端口的过滤，并提供and、or、not等逻辑语句来帮助你去掉无用的信息。</p>
<p><img src="/images/tcpdump/tcpdump.png" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">* 默认启动</span><br><span class="line">tcpdump</span><br><span class="line"><span class="meta">#</span><span class="bash"> 普通情况下，直接启动tcpdump将监视第一个网络接口上所有流过的数据包。</span></span><br><span class="line"></span><br><span class="line">* 监视指定网络接口的数据包</span><br><span class="line">tcpdump -i eth1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-i选项指定网卡。如果不指定网卡，默认tcpdump只会监视第一个网络接口，一般是eth0</span></span><br><span class="line"> </span><br><span class="line">* 监视指定主机的数据包</span><br><span class="line">tcpdump host sundown</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印所有进入或离开sundown的数据包.</span></span><br><span class="line"></span><br><span class="line">tcpdump host 210.27.48.1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以指定ip,例如截获所有210.27.48.1 的主机收到的和发出的所有的数据包</span></span><br><span class="line"></span><br><span class="line">tcpdump host helios and \( hot or ace \)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印helios 与 hot 或者与 ace 之间通信的数据包</span></span><br><span class="line"></span><br><span class="line">tcpdump host 210.27.48.1 and \ (210.27.48.2 or 210.27.48.3 \) </span><br><span class="line"><span class="meta">#</span><span class="bash"> 截获主机210.27.48.1 和主机210.27.48.2 或210.27.48.3的通信</span></span><br><span class="line"></span><br><span class="line">tcpdump ip host ace and not helios</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印ace与任何其他主机之间通信的IP 数据包, 但不包括与helios之间的数据包.</span></span><br><span class="line"></span><br><span class="line">tcpdump ip host 210.27.48.1 and ! 210.27.48.2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取主机210.27.48.1除了和主机210.27.48.2之外所有主机通信的ip包</span></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 src host hostname</span><br><span class="line"><span class="meta">#</span><span class="bash"> 截获主机hostname发送的所有数据</span></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 dst host hostname</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监视所有发送到主机hostname的数据包</span></span><br><span class="line"> </span><br><span class="line">* 监视指定主机和端口的数据包</span><br><span class="line"></span><br><span class="line">tcpdump tcp port 23 and host 210.27.48.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取主机210.27.48.1接收或发出的telnet包</span></span><br><span class="line"></span><br><span class="line">tcpdump udp port 123 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 对本机的udp 123 端口进行监视，123为ntp的服务端口</span></span><br><span class="line"> </span><br><span class="line">* 监视指定网络的数据包</span><br><span class="line">tcpdump net ucb-ether</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印本地主机与Berkeley网络上的主机之间的所有通信数据包(nt: ucb-ether, 此处可理解为<span class="string">'Berkeley网络'</span>的网络地址,此表达式最原始的含义可表达为: 打印网络地址为ucb-ether的所有数据包)</span></span><br><span class="line"></span><br><span class="line">tcpdump 'gateway snup and (port ftp or ftp-data)'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印所有通过网关snup的ftp数据包(注意, 表达式被单引号括起来了, 这可以防止shell对其中的括号进行错误解析)</span></span><br><span class="line"></span><br><span class="line">tcpdump ip and not net localnet</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印所有源地址或目标地址是本地主机的IP数据包(如果本地网络通过网关连到了另一网络, 则另一网络并不能算作本地网络.(nt: 此句翻译曲折,需补充).localnet 实际使用时要真正替换成本地网络的名字)</span></span><br><span class="line"> </span><br><span class="line">* 监视指定协议的数据包</span><br><span class="line">tcpdump 'tcp[tcpflags] &amp; (tcp-syn|tcp-fin) != 0 and not src and dst net localnet'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印TCP会话中的的开始和结束数据包, 并且数据包的源或目的不是本地网络上的主机.(nt: localnet, 实际使用时要真正替换成本地网络的名字)</span></span><br><span class="line"></span><br><span class="line">tcpdump 'tcp port 80 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0)'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印所有源或目的端口是80, 网络层协议为IPv4, 并且含有数据,而不是SYN,FIN以及ACK-only等不含数据的数据包.(ipv6的版本的表达式可做练习)(nt: 可理解为, ip[2:2]表示整个ip数据包的长度, (ip[0]&amp;0xf)&lt;&lt;2)表示ip数据包包头的长度(ip[0]&amp;0xf代表包中的IHL域, 而此域的单位为32bit, 要换算成字节数需要乘以4,　即左移2.　(tcp[12]&amp;0xf0)&gt;&gt;4 表示tcp头的长度, 此域的单位也是32bit,　换算成比特数为 ((tcp[12]&amp;0xf0) &gt;&gt; 4)　&lt;&lt;　２,　 即 ((tcp[12]&amp;0xf0)&gt;&gt;2).　((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0　表示: 整个ip数据包的长度减去ip头的长度,再减去 tcp头的长度不为0, 这就意味着, ip数据包中确实是有数据.对于ipv6版本只需考虑ipv6头中的<span class="string">'Payload Length'</span> 与 <span class="string">'tcp头的长度'</span>的差值, 并且其中表达方式<span class="string">'ip[]'</span>需换成<span class="string">'ip6[]'</span>.)</span></span><br><span class="line"></span><br><span class="line">tcpdump 'gateway snup and ip[2:2] &gt; 576'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印长度超过576字节, 并且网关地址是snup的IP数据包</span></span><br><span class="line"></span><br><span class="line">tcpdump 'ether[0] &amp; 1 = 0 and ip[16] &gt;= 224'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印所有IP层广播或多播的数据包， 但不是物理以太网层的广播或多播数据报</span></span><br><span class="line"></span><br><span class="line">tcpdump 'icmp[icmptype] != icmp-echo and icmp[icmptype] != icmp-echoreply'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印除<span class="string">'echo request'</span>或者<span class="string">'echo reply'</span>类型以外的ICMP数据包( 比如,需要打印所有非ping 程序产生的数据包时可用到此表达式 . (nt: <span class="string">'echo reuqest'</span> 与 <span class="string">'echo reply'</span> 这两种类型的ICMP数据包通常由ping程序产生))</span></span><br><span class="line"></span><br><span class="line">tcpdump tcp -i eth1 -t -s 0 -c 100 and dst port ! 22 and src net 192.168.1.0/24 -w ./target.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> tcp: ip icmp arp rarp 和 tcp、udp、icmp这些选项等都要放到第一个参数的位置，用来过滤数据报的类型</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -i eth1 : 只抓经过接口eth1的包 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -t : 不显示时间戳 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -s 0 : 抓取数据包时默认抓取长度为68字节。加上-S 0 后可以抓到完整的数据包 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -c 100 : 只抓取100个数据包 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -dst port ! 22 : 不抓取目标端口是22的数据包 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -src net 192.168.1.0/24 : 数据包的源网络地址为192.168.1.0/24 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -w ./target.cap : 保存成<span class="built_in">cap</span>文件，方便用ethereal(即wireshark)分析</span></span><br><span class="line"></span><br><span class="line">* 使用tcpdump抓取HTTP包</span><br><span class="line">tcpdump  -XvvennSs 0 -i eth0 tcp[20:2]=0x4745 or tcp[20:2]=0x4854</span><br><span class="line"><span class="meta">#</span><span class="bash"> 0x4745 为<span class="string">"GET"</span>前两个字母<span class="string">"GE"</span>,0x4854 为<span class="string">"HTTP"</span>前两个字母<span class="string">"HT"</span>。</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> tcpdump 对截获的数据并没有进行彻底解码，数据包内的大部分内容是使用十六进制的形式直接打印输出的。显然这不利于分析网络故障，通常的解决办法是先使用带-w参数的tcpdump 截获数据并保存到文件中，然后再使用其他程序(如Wireshark)进行解码分析。当然也应该定义过滤规则，以避免捕获的数据包填满整个硬盘。</span></span><br></pre></td></tr></table></figure>
<h3 id="tcpdump的简单选项介绍"><a href="#tcpdump的简单选项介绍" class="headerlink" title="tcpdump的简单选项介绍"></a>tcpdump的简单选项介绍</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">tcpdump采用命令行方式，它的命令格式为：</span><br><span class="line"></span><br><span class="line">　　tcpdump [ -adeflnNOpqStvx ] [ -c 数量 ] [ -F 文件名 ]</span><br><span class="line"></span><br><span class="line">　　　　　　　　　　[ -i 网络接口 ] [ -r 文件名] [ -s snaplen ]</span><br><span class="line"></span><br><span class="line">                                       [ -T 类型 ] [ -w 文件名 ] [表达式 ]</span><br><span class="line"></span><br><span class="line">-a 　　　# 将网络地址和广播地址转变成名字；</span><br><span class="line">-A  # 以ASCII码方式显示每一个数据包(不会显示数据包中链路层头部信息). 在抓取包含网页数据的数据包时, 可方便查看数据(nt: 即Handy for capturing web pages).</span><br><span class="line">-c  count     # tcpdump将在接受到count个数据包后退出.</span><br><span class="line">-C  file-size (nt: 此选项用于配合-w file 选项使用)     # 该选项使得tcpdump在把原始数据包直接保存到文件中之前, 检查此文件大小是否超过file-size. 如果超过了, 将关闭此文件,另创一个文件继续用于原始数据包的记录. 新创建的文件名与-w 选项指定的文件名一致, 但文件名后多了一个数字.该数字会从1开始随着新创建文件的增多而增加. file-size的单位是百万字节(nt: 这里指1,000,000个字节,并非1,048,576个字节, 后者是以1024字节为1k, 1024k字节为1M计算所得, 即1M=1024 ＊ 1024 ＝ 1,048,576)</span><br><span class="line">-d  # 以容易阅读的形式,在标准输出上打印出编排过的包匹配码, 随后tcpdump停止.(nt | rt: human readable, 容易阅读的,通常是指以ascii码来打印一些信息. compiled, 编排过的. packet-matching code, 包匹配码,含义未知, 需补充)</span><br><span class="line">-dd # 以C语言的形式打印出包匹配码.</span><br><span class="line">-ddd # 以十进制数的形式打印出包匹配码(会在包匹配码之前有一个附加的'count'前缀).</span><br><span class="line">-D  # 打印系统中所有tcpdump可以在其上进行抓包的网络接口. 每一个接口会打印出数字编号, 相应的接口名字, 以及可能的一个网络接口描述. 其中网络接口名字和数字编号可以用在tcpdump 的-i flag 选项(nt: 把名字或数字代替flag), 来指定要在其上抓包的网络接口.此选项在不支持接口列表命令的系统上很有用(nt: 比如, Windows 系统, 或缺乏 ifconfig -a 的UNIX系统); 接口的数字编号在windows 2000 或其后的系统中很有用, 因为这些系统上的接口名字比较复杂, 而不易使用. 如果tcpdump编译时所依赖的libpcap库太老,-D 选项不会被支持, 因为其中缺乏 pcap_findalldevs()函数.</span><br><span class="line">-e  # 每行的打印输出中将包括数据包的数据链路层头部信息</span><br><span class="line">-E  spi@ipaddr algo:secret,...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可通过spi@ipaddr algo:secret 来解密IPsec ESP包(nt | rt:IPsec Encapsulating Security Payload,IPsec 封装安全负载, IPsec可理解为, 一整套对ip数据包的加密协议, ESP 为整个IP 数据包或其中上层协议部分被加密后的数据,前者的工作模式称为隧道模式; 后者的工作模式称为传输模式 . 工作原理, 另需补充).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要注意的是, 在终端启动tcpdump 时, 可以为IPv4 ESP packets 设置密钥(secret）.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可用于加密的算法包括des-cbc, 3des-cbc, blowfish-cbc, rc3-cbc, cast128-cbc, 或者没有(none).默认的是des-cbc(nt: des, Data Encryption Standard, 数据加密标准, 加密算法未知, 另需补充).secret 为用于ESP 的密钥, 使用ASCII 字符串方式表达. 如果以 0x 开头, 该密钥将以16进制方式读入.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 该选项中ESP 的定义遵循RFC2406, 而不是 RFC1827. 并且, 此选项只是用来调试的, 不推荐以真实密钥(secret)来使用该选项, 因为这样不安全: 在命令行中输入的secret 可以被其他人通过ps 等命令查看到.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 除了以上的语法格式(nt: 指spi@ipaddr algo:secret), 还可以在后面添加一个语法输入文件名字供tcpdump 使用(nt：即把spi@ipaddr algo:secret,... 中...换成一个语法文件名). 此文件在接受到第一个ESP　包时会打开此文件, 所以最好此时把赋予tcpdump 的一些特权取消(nt: 可理解为, 这样防范之后, 当该文件为恶意编写时,不至于造成过大损害).</span></span><br><span class="line">-f  # 显示外部的IPv4 地址时(nt: foreign IPv4 addresses, 可理解为, 非本机ip地址), 采用数字方式而不是名字.(此选项是用来对付Sun公司的NIS服务器的缺陷(nt: NIS, 网络信息服务, tcpdump 显示外部地址的名字时会用到她提供的名称服务): 此NIS服务器在查询非本地地址名字时,常常会陷入无尽的查询循环). 由于对外部(foreign)IPv4地址的测试需要用到本地网络接口(nt: tcpdump 抓包时用到的接口)及其IPv4 地址和网络掩码. 如果此地址或网络掩码不可用, 或者此接口根本就没有设置相应网络地址和网络掩码(nt: linux 下的 'any' 网络接口就不需要设置地址和掩码, 不过此'any'接口可以收到系统中所有接口的数据包), 该选项不能正常工作.</span><br><span class="line">-F  file     #使用file 文件作为过滤条件表达式的输入, 此时命令行上的输入将被忽略.</span><br><span class="line">-i  interface</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定tcpdump 需要监听的接口.  如果没有指定, tcpdump 会从系统接口列表中搜寻编号最小的已配置好的接口(不包括 loopback 接口).一但找到第一个符合条件的接口, 搜寻马上结束.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在采用2.2版本或之后版本内核的Linux 操作系统上, <span class="string">'any'</span> 这个虚拟网络接口可被用来接收所有网络接口上的数据包(nt: 这会包括目的是该网络接口的, 也包括目的不是该网络接口的). 需要注意的是如果真实网络接口不能工作在<span class="string">'混杂'</span>模式(promiscuous)下,则无法在<span class="string">'any'</span>这个虚拟的网络接口上抓取其数据包.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果 -D 标志被指定, tcpdump会打印系统中的接口编号，而该编号就可用于此处的interface 参数.</span></span><br><span class="line">-l  # 对标准输出进行行缓冲(nt: 使标准输出设备遇到一个换行符就马上把这行的内容打印出来).在需要同时观察抓包打印以及保存抓包记录的时候很有用. 比如, 可通过以下命令组合来达到此目的:     ``tcpdump  -l  |  tee dat'' 或者 ``tcpdump  -l   &gt; dat  &amp;  tail  -f  dat''.(nt: 前者使用tee来把tcpdump 的输出同时放到文件dat和标准输出中, 而后者通过重定向操作'&gt;', 把tcpdump的输出放到dat 文件中, 同时通过tail把dat文件中的内容放到标准输出中)</span><br><span class="line">-L  # 列出指定网络接口所支持的数据链路层的类型后退出.(nt: 指定接口通过-i 来指定)</span><br><span class="line">-m  module     # 通过module 指定的file 装载SMI MIB 模块(nt: SMI，Structure of Management Information, 管理信息结构MIB, Management Information Base, 管理信息库. 可理解为, 这两者用于SNMP(Simple Network Management Protoco)协议数据包的抓取. 具体SNMP 的工作原理未知, 另需补充). 此选项可多次使用, 从而为tcpdump 装载不同的MIB 模块.</span><br><span class="line">-M  # secret  如果TCP 数据包(TCP segments)有TCP-MD5选项(在RFC 2385有相关描述), 则为其摘要的验证指定一个公共的密钥secret.</span><br><span class="line">-n  # 不对地址(比如, 主机地址, 端口号)进行数字表示到名字表示的转换.</span><br><span class="line">-nn：    # 指定将每个监听到的数据包中的域名转换成IP、端口从应用名称转换成端口号后显示</span><br><span class="line">-N  # 不打印出host 的域名部分. 比如, 如果设置了此选现, tcpdump 将会打印'nic' 而不是 'nic.ddn.mil'.</span><br><span class="line">-O  # 不启用进行包匹配时所用的优化代码. 当怀疑某些bug是由优化代码引起的, 此选项将很有用.</span><br><span class="line">-p  # 一般情况下, 把网络接口设置为非'混杂'模式. 但必须注意 , 在特殊情况下此网络接口还是会以'混杂'模式来工作； 从而, '-p' 的设与不设, 不能当做以下选现的代名词:'ether host &#123;local-hw-add&#125;' 或  'ether broadcast'(nt: 前者表示只匹配以太网地址为host 的包, 后者表示匹配以太网地址为广播地址的数据包).</span><br><span class="line">-q  # 快速(也许用'安静'更好?)打印输出. 即打印很少的协议相关信息, 从而输出行都比较简短.</span><br><span class="line">-R  # 设定tcpdump 对 ESP/AH 数据包的解析按照 RFC1825而不是RFC1829(nt: AH, 认证头, ESP， 安全负载封装, 这两者会用在IP包的安全传输机制中). 如果此选项被设置, tcpdump 将不会打印出'禁止中继'域(nt: relay prevention field). 另外,由于ESP/AH规范中没有规定ESP/AH数据包必须拥有协议版本号域,所以tcpdump不能从收到的ESP/AH数据包中推导出协议版本号.</span><br><span class="line">-r  file     # 从文件file 中读取包数据. 如果file 字段为 '-' 符号, 则tcpdump 会从标准输入中读取包数据.</span><br><span class="line">-S  # 打印TCP 数据包的顺序号时, 使用绝对的顺序号, 而不是相对的顺序号.(nt: 相对顺序号可理解为, 相对第一个TCP 包顺序号的差距,比如, 接受方收到第一个数据包的绝对顺序号为232323, 对于后来接收到的第2个,第3个数据包, tcpdump会打印其序列号为1, 2分别表示与第一个数据包的差距为1 和 2. 而如果此时-S 选项被设置, 对于后来接收到的第2个, 第3个数据包会打印出其绝对顺序号:232324, 232325).</span><br><span class="line">-s  snaplen     # 设置tcpdump的数据包抓取长度为snaplen, 如果不设置默认将会是68字节(而支持网络接口分接头(nt: NIT, 上文已有描述,可搜索'网络接口分接头'关键字找到那里)的SunOS系列操作系统中默认的也是最小值是96).68字节对于IP, ICMP(nt: Internet Control Message Protocol,因特网控制报文协议), TCP 以及 UDP 协议的报文已足够, 但对于名称服务(nt: 可理解为dns, nis等服务), NFS服务相关的数据包会产生包截短. 如果产生包截短这种情况, tcpdump的相应打印输出行中会出现''[|proto]''的标志（proto 实际会显示为被截短的数据包的相关协议层次). 需要注意的是, 采用长的抓取长度(nt: snaplen比较大), 会增加包的处理时间, 并且会减少tcpdump 可缓存的数据包的数量， 从而会导致数据包的丢失. 所以, 在能抓取我们想要的包的前提下, 抓取长度越小越好.把snaplen 设置为0 意味着让tcpdump自动选择合适的长度来抓取数据包.</span><br><span class="line">-T  type    # 强制tcpdump按type指定的协议所描述的包结构来分析收到的数据包.  目前已知的type 可取的协议为:     aodv (Ad-hoc On-demand Distance Vector protocol, 按需距离向量路由协议, 在Ad hoc(点对点模式)网络中使用),     cnfp (Cisco  NetFlow  protocol),  rpc(Remote Procedure Call), rtp (Real-Time Applications protocol),     rtcp (Real-Time Applications con-trol protocol), snmp (Simple Network Management Protocol),     tftp (Trivial File Transfer Protocol, 碎文件协议), vat (Visual Audio Tool, 可用于在internet 上进行电     视电话会议的应用层协议), 以及wb (distributed White Board, 可用于网络会议的应用层协议).</span><br><span class="line">-t     # 在每行输出中不打印时间戳</span><br><span class="line">-tt    # 不对每行输出的时间进行格式处理(nt: 这种格式一眼可能看不出其含义, 如时间戳打印成1261798315)</span><br><span class="line">-ttt   # tcpdump 输出时, 每两行打印之间会延迟一个段时间(以毫秒为单位)</span><br><span class="line">-tttt  # 在每行打印的时间戳之前添加日期的打印</span><br><span class="line">-u     # 打印出未加密的NFS 句柄(nt: handle可理解为NFS 中使用的文件句柄, 这将包括文件夹和文件夹中的文件)</span><br><span class="line">-U    # 使得当tcpdump在使用-w 选项时, 其文件写入与包的保存同步.(nt: 即, 当每个数据包被保存时, 它将及时被写入文件中,而不是等文件的输出缓冲已满时才真正写入此文件)。-U 标志在老版本的libcap库(nt: tcpdump 所依赖的报文捕获库)上不起作用, 因为其中缺乏pcap_cump_flush()函数.</span><br><span class="line">-v    # 当分析和打印的时候, 产生详细的输出. 比如, 包的生存时间, 标识, 总长度以及IP包的一些选项. 这也会打开一些附加的包完整性检测, 比如对IP或ICMP包头部的校验和.</span><br><span class="line">-vv   # 产生比-v更详细的输出. 比如, NFS回应包中的附加域将会被打印, SMB数据包也会被完全解码.</span><br><span class="line">-vvv  # 产生比-vv更详细的输出. 比如, telent 时所使用的SB, SE 选项将会被打印, 如果telnet同时使用的是图形界面, 其相应的图形选项将会以16进制的方式打印出来(nt: telnet 的SB,SE选项含义未知, 另需补充).</span><br><span class="line">-w    # 把包数据直接写入文件而不进行分析和打印输出. 这些包数据可在随后通过-r 选项来重新读入并进行分析和打印.</span><br><span class="line">-W    filecount      # 此选项与-C 选项配合使用, 这将限制可打开的文件数目, 并且当文件数据超过这里设置的限制时, 依次循环替代之前的文件, 这相当于一个拥有filecount 个文件的文件缓冲池. 同时, 该选项会使得每个文件名的开头会出现足够多并用来占位的0, 这可以方便这些文件被正确的排序.</span><br><span class="line">-x    # 当分析和打印时, tcpdump 会打印每个包的头部数据, 同时会以16进制打印出每个包的数据(但不包括连接层的头部).总共打印的数据大小不会超过整个数据包的大小与snaplen 中的最小值. 必须要注意的是, 如果高层协议数据没有snaplen 这么长,并且数据链路层(比如, Ethernet层)有填充数据, 则这些填充数据也会被打印.(nt: so for link  layers  that pad, 未能衔接理解和翻译, 需补充 )</span><br><span class="line">-xx   # tcpdump 会打印每个包的头部数据, 同时会以16进制打印出每个包的数据, 其中包括数据链路层的头部.</span><br><span class="line">-X    # 当分析和打印时, tcpdump 会打印每个包的头部数据, 同时会以16进制和ASCII码形式打印出每个包的数据(但不包括连接层的头部).这对于分析一些新协议的数据包很方便.</span><br><span class="line">-XX   # 当分析和打印时, tcpdump 会打印每个包的头部数据, 同时会以16进制和ASCII码形式打印出每个包的数据, 其中包括数据链路层的头部.这对于分析一些新协议的数据包很方便.</span><br><span class="line">-y    # datalinktype       设置tcpdump 只捕获数据链路层协议类型是datalinktype的数据包</span><br><span class="line">-Z    user      # 使tcpdump 放弃自己的超级权限(如果以root用户启动tcpdump, tcpdump将会有超级用户权限), 并把当前tcpdump的用户ID设置为user, 组ID设置为user首要所属组的ID(nt: tcpdump 此处可理解为tcpdump 运行之后对应的进程)。此选项也可在编译的时候被设置为默认打开.(nt: 此时user 的取值未知, 需补充)</span><br></pre></td></tr></table></figure>
<h3 id="expression-表达式"><a href="#expression-表达式" class="headerlink" title="expression 表达式"></a>expression 表达式</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">==一个基本的表达式单元格式为"proto dir type ID"==</span><br><span class="line"></span><br><span class="line">对于表达式语法，参考 pcap-filter 【pcap-filter - packet filter syntax】</span><br><span class="line"></span><br><span class="line">类型 type</span><br><span class="line">host, net, port, portrange</span><br><span class="line"></span><br><span class="line">例如：host 192.168.201.128 , net 128.3, port 20, portrange 6000-6008'</span><br><span class="line"></span><br><span class="line">目标 dir</span><br><span class="line">src, dst, src or dst, src and dst</span><br><span class="line"></span><br><span class="line">协议 proto</span><br><span class="line">tcp， udp ， icmp，若未给定协议类型，则匹配所有可能的类型</span><br><span class="line"></span><br><span class="line">==表达式单元之间可以使用操作符" and / &amp;&amp; / or / || / not / ! "进行连接，从而组成复杂的条件表达式==。如"host foo and not port ftp and not port ftp-data"，这表示筛选的数据包要满足"主机为foo且端口不是ftp(端口21)和ftp-data(端口20)的包"，常用端口和名字的对应关系可在linux系统中的/etc/service文件中找到。</span><br><span class="line"></span><br><span class="line">另外，同样的修饰符可省略，如"tcp dst port ftp or ftp-data or domain"与"tcp dst port ftp or tcp dst port ftp-data or tcp dst port domain"意义相同，都表示包的协议为tcp且目的端口为ftp或ftp-data或domain(端口53)。</span><br><span class="line"></span><br><span class="line">使用括号"()"可以改变表达式的优先级，但需要注意的是括号会被shell解释，所以应该使用反斜线""转义为"()"，在需要的时候，还需要包围在引号中。</span><br></pre></td></tr></table></figure>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">tcpdump –i eth0 ‘port 1111’ -X -c 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> -i 是interface的含义，是指我们有义务告诉tcpdump希望他去监听哪一个网卡,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -X告诉tcpdump命令，需要把协议头和包内容都原原本本的显示出来（tcpdump会以16进制和ASCII的形式显示），这在进行协议分析时是绝对的利器。port 1111我们只关心源端口或目的端口是1111的数据包.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -c 是Count的含义，这设置了我们希望tcpdump帮我们抓几个包。</span></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 port 1111 -l | awk '&#123;print $1&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提取包的每一行的第一个域(时间域)，这种情况下我们就需要-l将默认的全缓冲变为行缓冲了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -l选项的作用就是将tcpdump的输出变为“行缓冲”方式，这样可以确保tcpdump遇到的内容一旦是换行符即将缓冲的内容输出到标准输出，以便于利用管道或重定向方式来进行后续处理。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Linux/UNIX的标准I/O提供了全缓冲、行缓冲和无缓冲三种缓冲方式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 标准错误是不带缓冲的，终端设备常为行缓冲，而其他情况默认都是全缓冲的。</span></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 port 1111 -c 3 -w cp.pcap</span><br><span class="line"><span class="meta">#</span><span class="bash"> -w 直接将包写入文件中(即原始包，如果使用 重定向 &gt; 则只是保存显示的结果，而不是原始文件)，即所谓的“流量保存”---就是把抓到的网络包能存储到磁盘上，保存下来，为后续使用。参数-r 达到“流量回放”---就是把历史上的某一时间段的流量，重新模拟回放出来，用于流量分析。</span></span><br><span class="line"></span><br><span class="line">tcpdump i- eth0 'port 1111' -c 3 -r cp.pcap </span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过-w选项将流量都存储在cp.pcap(二进制格式)文件中了.可以通过 –r 读取raw packets文件 cp.pcap. </span></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 -e -nn -X -c 2 'port1111'</span><br><span class="line"><span class="meta">#</span><span class="bash"> -n不把网络地址转换成名字</span></span><br><span class="line"></span><br><span class="line">ruopu@ruopu-PC:~$ sudo tcpdump -i enp0s25 -e -nnvv -X -c 2 'port 80'</span><br><span class="line">tcpdump: listening on enp0s25, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">14:09:31.285330 50:7b:9d:65:f9:ff &gt; 8c:a6:df:ec:9e:52, ethertype IPv4 (0x0800), length 74: (tos 0x0, ttl 64, id 15932, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    192.168.0.89.43174 &gt; 101.37.97.51.80: Flags [S], cksum 0x8788 (incorrect -&gt; 0xa52d), seq 1891133781, win 29200, options [mss 1460,sackOK,TS val 4099617288 ecr 0,nop,wscale 7], length 0</span><br><span class="line">	0x0000:  4500 003c 3e3c 4000 4006 7526 c0a8 0059  E..&lt;&gt;&lt;@.@.u&amp;...Y</span><br><span class="line">	0x0010:  6525 6133 a8a6 0050 70b8 6955 0000 0000  e%a3...Pp.iU....</span><br><span class="line">	0x0020:  a002 7210 8788 0000 0204 05b4 0402 080a  ..r.............</span><br><span class="line">	0x0030:  f45b 3208 0000 0000 0103 0307            .[2.........</span><br><span class="line">14:09:31.320699 8c:a6:df:ec:9e:52 &gt; 50:7b:9d:65:f9:ff, ethertype IPv4 (0x0800), length 66: (tos 0x0, ttl 51, id 0, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    101.37.97.51.80 &gt; 192.168.0.89.43174: Flags [S.], cksum 0x9a5b (correct), seq 1054611816, ack 1891133782, win 29200, options [mss 1444,nop,nop,sackOK,nop,wscale 9], length 0</span><br><span class="line">	0x0000:  4500 0034 0000 4000 3306 c06a 6525 6133  E..4..@.3..je%a3</span><br><span class="line">	0x0010:  c0a8 0059 0050 a8a6 3edc 1968 70b8 6956  ...Y.P..&gt;..hp.iV</span><br><span class="line">	0x0020:  8012 7210 9a5b 0000 0204 05a4 0101 0402  ..r..[..........</span><br><span class="line">	0x0030:  0103 0309                                ....</span><br><span class="line">2 packets captured</span><br><span class="line">3 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line"><span class="meta">#</span><span class="bash"> tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode表示使用选项-v和-vv可以看到更完全的输出信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> listening on enp0s25, link-type EN10MB (Ethernet), capture size 262144 bytes表示监听enp0s25网卡，它的链路层是基于以太网的，要抓的包大小限制为262144字节。包大小限制值可以通过-s选项来设置。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 14:09:31.285330 表示这个包被抓到的“时”、“分”、“秒”、“微秒”</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 50:7b:9d:65:f9:ff &gt; 8c:a6:df:ec:9e:52表示从哪个MAC地址发往哪个MAC地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ethertype IPv4 (0x0800)表示Ethernet帧的协议类型为ipv4，代码为0x0800</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> length 74表示以太帧长度为74</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 192.168.0.89.43174 &gt; 101.37.97.51.80表示源IP192.168.0.89，端口43174向101.37.97.51的80号端口传输数据。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Flags [S]表示是syn建立连接包(即三次握手的第一次握手)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> seq 1891133781 表示序号为1891133781</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> win 29200  表示窗口大小为29200</span></span><br><span class="line"></span><br><span class="line">* tcpdump过滤语句</span><br><span class="line"><span class="meta">#</span><span class="bash"> 过滤表达式大体可以分成三种过滤条件，“类型”、“方向”和“协议”，这三种条件的搭配组合就构成了我们的过滤表达式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关于类型的关键字，主要包括host，net，port, 例如 host 210.45.114.211，指定主机210.45.114.211，net 210.11.0.0 指明210.11.0.0是一个网络地址，port 21 指明端口号是21。如果没有指定类型，缺省的类型是host.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关于传输方向的关键字，主要包括src , dst ,dst or src, dst and src ,这些关键字指明了传输的方向。例：src 210.45.114.211 ,指明ip包中源地址是210.45.114.211, dst net 210.11.0.0 指明目的网络地址是210.11.0.0。如果没有指明方向关键字，则缺省是src or dst关键字。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关于协议的关键字，主要包括 ether,ip,ip6,arp,rarp,tcp,udp等类型。这几个的包的协议内容。如果没有指定任何协议，则tcpdump将会监听所有协议的信息包。</span></span><br><span class="line"></span><br><span class="line"> tcpdump -i eth0 -nn -c 1 'tcp'</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 只抓tcp的包</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 除了这三种类型的关键字之外，其他重要的关键字：gateway, broadcast,less,greater。还有三种逻辑运算，取非运算是 <span class="string">'not '</span>,<span class="string">'! '</span>, 与运算是<span class="string">'and'</span>,<span class="string">'&amp;&amp;'</span>;或运算是<span class="string">'or'</span>,<span class="string">'||'</span>；</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump -i eth0 -c 10 'dst port 21 or dst port 80'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只想查目标机器端口是21或80的网络包，其他端口的我不关注</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump -i eth0 -c 3 'host 172.16.0.11 and (210.45.123.249 or 210.45.123.248)'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 想要截获主机172.16.0.11 和主机210.45.123.249或 210.45.123.248的通信，使用命令(注意括号的使用)</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump 'port ftp or ftp-data'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 想获取使用ftp端口和ftp数据端口的网络包这里 ftp、ftp-data到底对应哪个端口？ linux系统下 /etc/services这个文件里面，就存储着所有知名服务和传输层端口的对应关系。如果你直接把/etc/services里的ftp对应的端口值从21改为了3333，那么tcpdump就会去抓端口含有3333的网络包了。</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump ip ‘host 172.16.0.11 and ! 210.45.123.249’</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果想要获取主机172.16.0.11除了和主机210.45.123.249之外所有主机通信的ip包</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump -i eth0 ‘host 172.16.0.11 and ! port 80 and ! port 25 and ! port 110’</span><br><span class="line"><span class="meta">#</span><span class="bash"> 抓172.16.0.11的80端口和110和25以外的其他端口的包</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump -i eth0 'host 172.16.0.11 and host google.com and tcp[tcpflags]&amp;tcp-syn!=0' -c 3 -nn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取172.16.10.11和google.com之间建立TCP三次握手中带有SYN标记位的网络包</span></span><br><span class="line"></span><br><span class="line">proto [expr : size]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Proto即protocol的缩写，它表示这里要指定的是某种协议名称，如ip,tcp,udp等。总之可以指定的协议有十多种，如链路层协议 ether,fddi,tr,wlan,ppp,slip,link,网络层协议ip,ip6,arp,rarp,icmp传输层协议tcp,udp等。expr用来指定数据报字节单位的偏移量，该偏移量相对于指定的协议层，默认的起始位置是0；而size表示从偏移量的位置开始提取多少个字节，可以设置为1、2、4,默认为1字节。如果只设置了expr，而没有设置size，则默认提取1个字节。比如ip[2:2]，就表示提取出第3、4个字节；而ip[0]则表示提取ip协议头的第一个字节。在我们提取了特定内容之后，我们就需要设置我们的过滤条件了，我们可用的“比较操作符”包括：&gt;，&lt;，&gt;=，&lt;=，=，!=，总共有6个。</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump 'tcp[13] &amp; 3 != 0 and not(src and dst net 172.16.0.0)' -nn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 截取每个TCP会话的起始和结束报文(SYN 和 FIN 报文), 而且会话方中有一个远程主机.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tcp偏移13字节的位置为2位保留位和6位标志位(URG,ACK,PSH,RST,SYN,FIN), 所以与3相与就可以得出SYN,FIN其中是否一个置位1. 从上面可以看到在写过滤表达式时，需要我们对协议格式比较理解才能把表达式写对。为了让tcpdump工具更人性化一些，有一些常用的偏移量，可以通过一些名称来代替，比如icmptype表示ICMP协议的类型域、icmpcode表示ICMP的code域，tcpflags则表示TCP协议的标志字段域。更进一步的，对于ICMP的类型域，可以用这些名称具体指代：icmp-echoreply, icmp-unreach, icmp-sourcequench, icmp-redirect,icmp-echo, icmp-routeradvert, icmp-routersolicit, icmp-timxceed, icmp-paramprob,icmp-tstamp, icmp-tstampreply, icmp-ireq, icmp-ireqreply, icmp-maskreq,icmp-maskreply。而对于TCP协议的标志字段域，则可以细分为tcp-fin, tcp-syn, tcp-rst, tcp-push, tcp-ack, tcp-urg。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/19/nc命令使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/19/nc命令使用/" itemprop="url">
                  nc命令使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-19 10:02:36" itemprop="dateCreated datePublished" datetime="2018-11-19T10:02:36+08:00">2018-11-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-12-25 10:22:37" itemprop="dateModified" datetime="2018-12-25T10:22:37+08:00">2018-12-25</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="nc命令使用方法"><a href="#nc命令使用方法" class="headerlink" title="nc命令使用方法"></a>nc命令使用方法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">* 将nc命令当telnet使用</span><br><span class="line">语法：</span><br><span class="line">nc -nv IP PORT</span><br><span class="line">例：</span><br><span class="line">mtr 202.106.0.20</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用mtr命令追踪一下路由</span></span><br><span class="line">nc -nv 123.125.50.29 110</span><br><span class="line"><span class="meta">#</span><span class="bash"> -n表示不使用DNS解析(不建议在nc后使用域名)；-v表示显示详细信息。连接163邮箱服务器。进入后可以使用一些命令，但识别的都是base64加密后的数据</span></span><br><span class="line">base64</span><br><span class="line">	zheng.yao@ccgoldenet.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入base64命令后按回车，之后等待输入数据，输入完成后按回车再按Ctrl+d结束，就会产生一个base64编码后的数据</span></span><br><span class="line">nc -vn 123.125.50.138 25</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接163的smtp服务器。</span></span><br><span class="line">nc -vn 1.1.1.1 80</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接后都会提示端口的状态，如open表示打开状态</span></span><br><span class="line">	head /</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入后，可以用head请求头信息</span></span><br><span class="line"></span><br><span class="line">* 使用NC传输文本信息</span><br><span class="line">A：nc -l -p 333</span><br><span class="line"><span class="meta">#</span><span class="bash"> -l(listen)表示要监听端口，-p指定端口号。这可以起到一个服务端的功能</span></span><br><span class="line">B：nc -nv 1.1.1.1 333</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接后，这两台主机就可以聊天了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个功能不为聊天，实际是为电子取证所用</span></span><br><span class="line"></span><br><span class="line">A：nc -l -p 333</span><br><span class="line">B：ls -l | nc -nv 1.1.1.1 333</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将本机ls -l显示的信息传到nc服务器上。这是远程电子审计的标准方法</span></span><br><span class="line"></span><br><span class="line">A：nc -l -p 333 &gt; ps.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将结果重定向到一个文件中</span></span><br><span class="line">B：ps aux|nc -nv 1.1.1.1 333 -q 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 收集进程信息。-q表示标准结果输出后，delay（延迟）一定时间就退出。1就是延迟的时间，表示1秒</span></span><br><span class="line">A： cat ps.txt</span><br><span class="line"></span><br><span class="line">A：nc -l -p 333 &gt; lsof.txt</span><br><span class="line">B：lsof | nc -nv 1.1.1.1 333 -q 1</span><br><span class="line">A： cat lsof.txt</span><br><span class="line"></span><br><span class="line">* 使用NC传输文件/目录</span><br><span class="line">** 传输文件</span><br><span class="line">A：nc -lp 333 &gt; 1.mp4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收端打开333端口，接收到的内容输入到一个文件名</span></span><br><span class="line">B：nc -nv 1.1.1.1 333 &lt; 1.mp4 -q 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送文件到接收端。在windows上使用上面的命令会报错，可能是安装的是netcat软件。需要使用下面命令</span></span><br><span class="line">nc -w 1 1.1.1.1 333 &lt; 1.mp4</span><br><span class="line">或</span><br><span class="line">A：nc -q 1 -lp 333 &lt; a.mp4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从服务器向客户端收送文件，这就成了发送端。这像是一个下载的过程。连接完成后1秒断开</span></span><br><span class="line">B：nc -nv 1.1.1.1 333 &gt; 2.mp4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端成了接收端。</span></span><br><span class="line"></span><br><span class="line">** 传输目录</span><br><span class="line">A：tar -cvf - music/ | nc -lp 333 -q 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打包目录，通过管道入到nc中。视频中强调，cvf后面的横线不能少，少了就不能打包成tar文件了。在 GNU 指令中，如果单独使用 - 符号，不加任何该加的文件名称时，代表<span class="string">"标准输入"</span>的意思。这是 GNU指令的共通选项。如：tar xpvf -，这里的 - 符号，既代表从标准输入读取资料。不过，在 <span class="built_in">cd</span> 指令中则比较特别，<span class="built_in">cd</span> -，这代表变更工作目录到<span class="string">"上一次"</span>工作目录。</span></span><br><span class="line">B：nc -nv 1.1.1.1 333 |tar -xvf -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接到nc，将打包的目录解压到本地</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以反方向传输。</span></span><br><span class="line"></span><br><span class="line">** 加密传文件</span><br><span class="line">A：nc -lp 333 | mcrypt --flush -Fbqd -a rijindael-256 -m ecb &gt; 1.mp4</span><br><span class="line"><span class="meta">#</span><span class="bash"> A端先监听端口，等待别人给其传文件。收到文件后给后面的解密命令解密，之后重新输出一个文件。接收到文件后会提示输入密码</span></span><br><span class="line">B：mcrypt --flush -Fbq -a rijindael-256 -m ecb &lt; a.mp4 | nc -nv 1.1.1.1 333 -q 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将加密文件转给A主机。两边的加密方式应该一致。加密时需要输入两次密码</span></span><br><span class="line"></span><br><span class="line">* 使用NC做流媒体服务</span><br><span class="line">A： cat 1.mp4 | nc -lp 333</span><br><span class="line"><span class="meta">#</span><span class="bash"> mp4文件也可以用cat打开</span></span><br><span class="line">B：nc -nv 1.1.1.1 333 | mplayer -vo x11 -cache 3000 -</span><br><span class="line"><span class="meta">#</span><span class="bash"> mplayer是一个播放器，其他支持命令行的播放器也可以</span></span><br><span class="line"></span><br><span class="line">* 使用NC做端口扫描</span><br><span class="line">nc -nvz 1.1.1.1 1-65535</span><br><span class="line">nc -nvzu 1.1.1.1 1-1024</span><br><span class="line"><span class="meta">#</span><span class="bash"> -z表示使用0输入/输出模式，只在扫描通信端口时使用。默认使用tcp端口，-u表示扫描udp的端口。每一个扫描器扫描的结果都不是完全准确的，可能被防火墙拦截。建议使用多个工具进行扫描</span></span><br><span class="line"></span><br><span class="line">* 使用NC做远程克隆硬盘</span><br><span class="line">A：nc -lp 333 | dd of=/dev/sda</span><br><span class="line">B：dd if=/dev/sda | nc -nv 1.1.1.1 333 -q 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 远程电子取证，可以将目标服务器硬盘远程复制，或者内存。这是块级别的备份。不会只拷贝文件，它会将磁盘扇区上的所有数据都拷贝过来。dd命令就是块级别的复制。<span class="keyword">if</span>表示input file</span></span><br><span class="line"></span><br><span class="line">* 使用NC做远程控制</span><br><span class="line">** 正向</span><br><span class="line">A： nc -lp 333 -c bash</span><br><span class="line">B： nc -nv 1.1.1.1 333</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端控制服务器。连接后可以使用bash命令</span></span><br><span class="line"></span><br><span class="line">** 反向</span><br><span class="line">A：nc -lp 333</span><br><span class="line">B：nc -nv 1.1.1.1 333 -c bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务器控制客户端</span></span><br><span class="line"></span><br><span class="line">注：windows用户把bash改成cmd</span><br><span class="line"></span><br><span class="line">* NC-NCAT</span><br><span class="line">NC缺乏加密和身份验证的能力</span><br><span class="line">NCAT包含于nmap工具包中。NCAT与NC是不一样的</span><br><span class="line">A：ncat -c bash --allow 1.1.1.1 -vnl 333 --ssl</span><br><span class="line"><span class="meta">#</span><span class="bash"> --allow表示允许哪个IP地址来连接本服务器</span></span><br><span class="line">B：ncat -nv 1.1.1.1 333 --ssl；监听的是333端口，--ssl表示ssl加密</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不同系统/平台的NC参数功能不尽相同</span></span><br></pre></td></tr></table></figure>
<h3 id="mtr命令"><a href="#mtr命令" class="headerlink" title="mtr命令"></a>mtr命令</h3><p>mtr命令可以结合ping nslookup tracert 来判断网络的相关特性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">* 参数</span><br><span class="line">mtr -r</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以报告模式显示</span></span><br><span class="line"></span><br><span class="line">mtr -s </span><br><span class="line"><span class="meta">#</span><span class="bash"> 用来指定ping数据包的大小</span></span><br><span class="line"></span><br><span class="line">mtr -c </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置每秒发送数据包的数量</span></span><br><span class="line"></span><br><span class="line">mtr -n </span><br><span class="line"><span class="meta">#</span><span class="bash"> no-dns不对IP地址做域名解析</span></span><br><span class="line"></span><br><span class="line">mtr -a </span><br><span class="line"><span class="meta">#</span><span class="bash"> 来设置发送数据包的IP地址 这个对一个主机由多个IP地址是有用的</span></span><br><span class="line"></span><br><span class="line">mtr -i </span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用这个参数来设置ICMP返回之间的要求默认是1秒</span></span><br><span class="line"></span><br><span class="line">mtr -4 </span><br><span class="line"><span class="meta">#</span><span class="bash"> IPv4</span></span><br><span class="line"></span><br><span class="line">mtr -6 </span><br><span class="line"><span class="meta">#</span><span class="bash"> IPv6</span></span><br><span class="line"></span><br><span class="line">ruopu@ruopu-PC:~$ mtr -r 202.108.33.94</span><br><span class="line">Start: 2018-11-19T11:09:25+0800</span><br><span class="line">HOST: ruopu-PC                    Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1.|-- _gateway                   0.0%    10    0.3   0.4   0.3   0.5   0.1</span><br><span class="line">  2.|-- 106.38.38.81               0.0%    10    3.2   8.7   3.1  54.0  15.9</span><br><span class="line">  3.|-- 237.235.120.106.static.bj 10.0%    10    2.8   3.0   2.8   4.4   0.5</span><br><span class="line">  4.|-- 202.97.57.201              0.0%    10    3.3   3.4   3.2   3.8   0.2</span><br><span class="line">  5.|-- 202.97.88.246             60.0%    10    3.2   3.2   3.1   3.3   0.1</span><br><span class="line">  6.|-- 219.158.44.133             0.0%    10   10.7   8.2   3.5  12.7   2.7</span><br><span class="line">  7.|-- 219.158.3.77               0.0%    10    9.3   7.7   4.8  10.3   2.2</span><br><span class="line">  8.|-- 124.65.194.174            40.0%    10    3.5   3.6   3.4   3.7   0.1</span><br><span class="line">  9.|-- 61.148.143.30              0.0%    10    3.2   3.9   3.2   5.9   0.8</span><br><span class="line"> 10.|-- 210.74.176.138             0.0%    10    3.5   4.1   3.1   8.6   1.6</span><br><span class="line"> 11.|-- ???                       100.0    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> ruopu-PC一列显示的是IP地址或本机域名；Snt一列显示的是设置每秒发送数据包的数量，默认值是10，可以通过参数-c来指定。</span></span><br><span class="line"></span><br><span class="line">ruopu@ruopu-PC:~$ mtr -r -c 15 202.108.33.94</span><br><span class="line">Start: 2018-11-19T11:12:54+0800</span><br><span class="line">HOST: ruopu-PC                    Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1.|-- _gateway                   0.0%    15    0.4   0.4   0.3   0.5   0.1</span><br><span class="line">  2.|-- 106.38.38.81               0.0%    15  187.6  65.7   3.7 187.6  59.1</span><br><span class="line">  3.|-- 237.235.120.106.static.bj  0.0%    15    3.0   3.9   2.6  12.4   2.8</span><br><span class="line">  4.|-- 202.97.57.237              0.0%    15    4.4   6.5   4.0  14.6   3.0</span><br><span class="line">  5.|-- 202.97.57.114              0.0%    15   35.1  17.8   2.9  50.9  17.5</span><br><span class="line">  6.|-- 219.158.44.129             0.0%    15   12.5   7.9   3.3  20.7   4.4</span><br><span class="line">  7.|-- 219.158.3.77               0.0%    15    4.4   6.6   3.1   9.9   2.3</span><br><span class="line">  8.|-- 124.65.194.118            66.7%    15    3.9  12.1   3.7  43.0  17.3</span><br><span class="line">  9.|-- 61.148.143.22              0.0%    15    3.2   7.3   3.2  35.8   9.1</span><br><span class="line"> 10.|-- 210.74.178.198             0.0%    15    3.9   4.2   3.5  10.8   1.8</span><br><span class="line"> 11.|-- ???                       100.0    15    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> HOST:ruopu-PC一列显示的是途经的IP地址或本机域名；Loss%列显示的是每个对应IP的丢包率，只有最后的目标丢包才算是真正的丢包；Snt一列显示的是设置每秒发送数据包的数量，默认值是10，可以通过参数-c来指定；Last列显示的是最近一次的返回时延，按毫秒计算；Avg列显示的是发送ping包的平均时延；Best烈显示的是最好或时延最短的；Wrst列显示的是最差或时延最长的；StDev列显示的是标准偏差。</span></span><br><span class="line"></span><br><span class="line">ruopu@ruopu-PC:~$ sudo mtr -i 0.1 -n -c 100 202.108.33.94</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对不标IP不做解析，ping100次，每0.1秒返回一次结果</span></span><br><span class="line"></span><br><span class="line">ruopu@ruopu-PC:~$ mtr -r -n -c 30 -s 1024 www.baidu.com</span><br><span class="line">Start: 2018-11-19T11:28:06+0800</span><br><span class="line">HOST: ruopu-PC                    Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1.|-- 192.168.0.1                0.0%    30    0.6   0.6   0.5   0.7   0.1</span><br><span class="line">  2.|-- 106.38.38.81               0.0%    30   16.8  56.8  11.6 160.8  36.0</span><br><span class="line">  3.|-- ???                       100.0    30    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  4.|-- 220.181.0.234             83.3%    30    6.1   5.6   4.6   6.1   0.6</span><br><span class="line">  5.|-- 218.30.112.130            60.0%    30    5.0   5.7   4.9  10.3   1.6</span><br><span class="line">  6.|-- 180.149.128.138           26.7%    30   10.6 270.4   6.8 1008. 355.7</span><br><span class="line">  7.|-- 180.149.129.6              0.0%    30    5.3   5.8   4.7  16.9   2.8</span><br><span class="line">  8.|-- ???                       100.0    30    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  9.|-- ???                       100.0    30    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"> 10.|-- 180.149.132.151            0.0%    30    5.8   6.8   5.7  16.6   2.8</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/18/jdyc备份服务器搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/18/jdyc备份服务器搭建/" itemprop="url">
                  jdyc备份服务器搭建
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-18 11:18:41" itemprop="dateCreated datePublished" datetime="2018-11-18T11:18:41+08:00">2018-11-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-19 08:25:14" itemprop="dateModified" datetime="2018-11-19T08:25:14+08:00">2018-11-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/jdbc/" itemprop="url" rel="index"><span itemprop="name">jdbc</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="搭建服务器过程"><a href="#搭建服务器过程" class="headerlink" title="搭建服务器过程"></a>搭建服务器过程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* Server</span><br><span class="line">1. 创建CentOS7服务器</span><br><span class="line">2. 创建备份目录</span><br><span class="line">mkdir /home/logsbackup</span><br><span class="line">3. 将本地地址映射出去</span><br><span class="line"></span><br><span class="line">* Client</span><br><span class="line">ssh-keygen -t rsa -P ''</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub 1.1.1.1</span><br><span class="line">vim /root/sh/logsbackup.sh</span><br><span class="line">    #!/bin/bash</span><br><span class="line">    #</span><br><span class="line">    cd /usr/local/logs</span><br><span class="line">    tar -zcf netty.log-$(date -d yesterday +%Y-%m-%d).tar.gz netty.log-$(date -d yesterday +%Y-%m-%d).*.log</span><br><span class="line">    scp -P 3999 netty.log-$(date -d yesterday +%Y-%m-%d).tar.gz 1.1.1.1:/home/logsbackup</span><br><span class="line">    rm -rf netty.log-$(date -d yesterday +%Y-%m-%d).*.log</span><br><span class="line">    echo $(date +%Y-%m-%d-%T) &gt;&gt; /root/sh/logsbackup.txt	</span><br><span class="line">crontab -e</span><br><span class="line"> 	0 1 * * * /bin/bash /root/sh/logsbackup.sh</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/16/docker学习一：基本概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/16/docker学习一：基本概念/" itemprop="url">
                  docker学习一：基本概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-16 11:11:26" itemprop="dateCreated datePublished" datetime="2018-11-16T11:11:26+08:00">2018-11-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-02 09:57:30" itemprop="dateModified" datetime="2019-02-02T09:57:30+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><ol>
<li><p>Docker 和传统虚拟化方式的不同之处在于传统虚拟机技术是虚拟出一套硬件后,在其上运行一个完整操作系统,在该系统上再运行所需应用进程;而容器内的应用进程直接运行于宿主的内核,容器内没有自己的内核,而且也没有进行硬件虚拟。因此容器要比传统虚拟机更为轻便。</p>
</li>
<li><p>Docker 镜像(Image),就相当于是一个root文件系统。Docker 镜像是一个特殊的文件系统,除了提供容器运行时所需的程序、库、资源、配置等文件外,还包含了一些为运行时准备的一些配置参数(如匿名卷、环境变量、用户等)。镜像不包含任何动态数据,其内容在构建之后也不会被改变。</p>
</li>
<li><p>因为镜像包含操作系统完整的root文件系统,其体积往往是庞大的,因此在 Docker 设计时,就充分利用 Union FS 的技术,将其设计为分层存储的架构。所以严格来说,镜像并非是像一个 ISO 那样的打包文件,镜像只是一个虚拟的概念,其实际体现并非由一个文件组成,而是由一组文件系统组成,或者说,由多层文件系统联合组成。镜像构建时,会一层层构建,前一层是后一层的基础。每一层构建完就不会再发生改变,后一层上的任何改变只发生在自己这一层。比如,删除前一层文件的操作,实际不是真的删除前一层的文件,而是仅在当前层标记为该文件已删除。在最终容器运行的时候,虽然不会看到这个文件,但是实际上该文件会一直跟随镜像。因此,在构建镜像的时候,需要额外小心,每一层尽量只包含该层需要添加的东西,任何额外的东西应该在该层构建结束前清理掉。分层存储的特征还使得镜像的复用、定制变的更为容易。甚至可以用之前构建好的镜像作为基础层,然后进一步添加新的层,以定制自己所需的内容,构建新的镜像。</p>
</li>
<li><p>镜像(Image)和容器(Container)的关系,就像是面向对象程序设计中的类和实例一样,镜像是静态的定义,容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。<br>容器的实质是进程,但与直接在宿主执行的进程不同,容器进程运行于属于自己的独立的命名空间。因此容器可以拥有自己的root文件系统、自己的网络配置、自己的进程空间,甚至自己的用户 ID 空间。容器内的进程是运行在一个隔离的环境里,使用起来,就好像是在一个独立于宿主的系统下操作一样。这种特性使得容器封装的应用比直接在宿主运行更加安全。<br>前面讲过镜像使用的是分层存储,容器也是如此。每一个容器运行时,是以镜像为基础层,在其上创建一个当前容器的存储层,我们可以称这个为容器运行时读写而准备的存储层为容器存储层。<br>容器存储层的生存周期和容器一样,容器消亡时,容器存储层也随之消亡。因此,任何保存于容器存储层的信息都会随容器删除而丢失。<br>按照 Docker 最佳实践的要求,容器不应该向其存储层内写入任何数据,容器存储层要保持无状态化。所有的文件写入操作,都应该使用 数据卷(Volume)、或者绑定宿主目录,在这些位置的读写会跳过容器存储层,直接对宿主(或网络存储)发生读写,其性能和稳定性更高。<br>数据卷的生存周期独立于容器,容器消亡,数据卷不会消亡。因此,使用数据卷后,容器删除或者重新运行之后,数据却不会丢失。</p>
</li>
<li><p>Docker Registry</p>
<p>镜像构建完成后,可以很容易的在当前宿主机上运行,但是,如果需要在其它服务器上使用这个镜像,我们就需要一个集中的存储、分发镜像的服务,Docker Registry 就是这样的服务。<br>一个 Docker Registry 中可以包含多个仓库(Repository);每个仓库可以包含多个标签(Tag);每个标签对应一个镜像。<br>通常,一个仓库会包含同一个软件不同版本的镜像,而标签就常用于对应该软件的各个版本。我们可以通过&lt;仓库名&gt;:&lt;标签&gt;的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签,将以latest作为默认标签。<br>以 Ubuntu 镜像为例,ubuntu是仓库的名字,其内包含有不同的版本标签,如,14.04、16.04。我们可以通过 ubuntu:14.04,或者ubuntu:16.04。来具体指定所需哪个版本的镜像。如果忽略了标签,比如ubuntu,那将视为ubuntu:latest。<br>仓库名经常以两段式路径形式出现,比如jwilder/nginx-proxy,前者往往意味着 Docker Registry 多用户环境下的用户名,后者则往往是对应的软件名。但这并非绝对,取决于所使用的具体 Docker Registry 的软件或服务。</p>
</li>
<li><p>Docker Registry 公开服务<br>Docker Registry 公开服务是开放给用户使用、允许用户管理镜像的 Registry 服务。一般这类公开服务允许用户免费上传、下载公开的镜像,并可能提供收费服务供用户管理私有镜像。<br>最常使用的 Registry 公开服务是官方的 Docker Hub,这也是默认的 Registry,并拥有大量的高质量的官方镜像。除此以外,还有 CoreOS 的 Quay.io,CoreOS 相关的镜像存储在这里;Google 的 Google Container Registry,Kubernetes 的镜像使用的就是这个服务。<br>由于某些原因,在国内访问这些服务可能会比较慢。国内的一些云服务商提供了针对 Docker Hub 的镜像服务(<br>Registry Mirror),这些镜像服务被称为加速器。常见的有 阿里云加速器、DaoCloud 加速器等。使用加速器会直接从国内的地址下载 Docker Hub 的镜像,比直接从 Docker Hub 下载速度会提高很多。<br>国内也有一些云服务商提供类似于 Docker Hub 的公开服务。比如时速云镜像仓库、网易云镜像服务、DaoCloud 镜像市场、阿里云镜像库等。</p>
</li>
<li><p>私有 Docker Registry<br>除了使用公开服务外,用户还可以在本地搭建私有Docker Registry。Docker 官方提供了Docker Registry 镜像,可以直接使用做为私有Registry服务。<br>开源的 Docker Registry 镜像只提供了 Docker Registry API 的服务端实现,足以支持docker命令,不影响使用。但不包含图形界面,以及镜像维护、用户管理、访问控制等高级功能。在官方的商业化版本 Docker Trusted Registry 中,提供了这些高级功能。</p>
<p>除了官方的 Docker Registry 外,还有第三方软件实现了 Docker Registry API,甚至提供了用户界面以及一些高级功能。比如,VMWare Harbor 和 Sonatype Nexus。</p>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/15/阿里云调整/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/15/阿里云调整/" itemprop="url">
                  阿里云调整
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-15 13:04:26" itemprop="dateCreated datePublished" datetime="2018-11-15T13:04:26+08:00">2018-11-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-21 10:56:24" itemprop="dateModified" datetime="2018-11-21T10:56:24+08:00">2018-11-21</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="报警"><a href="#报警" class="headerlink" title="报警"></a>报警</h3><p>可以先创建报警人组与报警人，这里只是对硬件的资源的基本监控。</p>
<p><img src="/images/alichange/监控报警1.jpg" alt=""></p>
<p><img src="/images/alichange/监控报警2.jpg" alt=""></p>
<p><img src="/images/alichange/监控报警3.jpg" alt=""></p>
<p><img src="/images/alichange/监控报警4.jpg" alt=""></p>
<p><img src="/images/alichange/监控报警5.jpg" alt=""></p>
<p><img src="/images/alichange/报警人1.jpg" alt=""></p>
<p><img src="/images/alichange/报警人2.jpg" alt=""></p>
<h3 id="创建交换机"><a href="#创建交换机" class="headerlink" title="创建交换机"></a>创建交换机</h3><p>建议将所有ECS虚拟机放在一个交换机中，这样便于管理，也可以避免不同交换机间通信需要进行一次路由的问题。</p>
<p><img src="/images/alichange/vpc1.jpg" alt=""></p>
<p><img src="/images/alichange/vpc2.jpg" alt=""></p>
<p><img src="/images/alichange/vpc3.jpg" alt=""></p>
<h3 id="共享带宽"><a href="#共享带宽" class="headerlink" title="共享带宽"></a>共享带宽</h3><p>购买NAT网关，设置DNAT，将需要外网访问的内网地址加入DNAT。SNAT中要匹配现有的所有交换机</p>
<p><img src="/images/alichange/NAT1.jpg" alt=""></p>
<p><img src="/images/alichange/NAT2.jpg" alt=""></p>
<p><img src="/images/alichange/NAT3.jpg" alt=""></p>
<p><img src="/images/alichange/NAT4.jpg" alt=""></p>
<p><img src="/images/alichange/NAT5.jpg" alt=""></p>
<p><img src="/images/alichange/NAT6.jpg" alt=""></p>
<h3 id="内网负载均衡"><a href="#内网负载均衡" class="headerlink" title="内网负载均衡"></a>内网负载均衡</h3><p>主要为RabbitMQ使用。在监听中定义要监听的端口，在默认服务器组中加入两台服务器，这样就会监听两个服务器的这些定义了的端口</p>
<p><img src="/images/alichange/balance1.jpg" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/17/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/19/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">222</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">165</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
