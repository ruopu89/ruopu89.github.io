<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/5/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/29/puppet配置与使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/29/puppet配置与使用/" itemprop="url">
                  puppet配置与使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-29 15:17:23" itemprop="dateCreated datePublished" datetime="2019-01-29T15:17:23+08:00">2019-01-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-31 22:04:51" itemprop="dateModified" datetime="2019-01-31T22:04:51+08:00">2019-01-31</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/编排工具/" itemprop="url" rel="index"><span itemprop="name">编排工具</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h4><blockquote>
<ul>
<li>group：定义组</li>
<li>user：定义用户</li>
<li>file：定义配置文件</li>
<li>service：定义服务</li>
<li>exec：执行命令</li>
<li>package：管理程序包</li>
<li>cron：周期性任务计划</li>
<li>notify：主要用于输出puppet的辅助提示信息,在puppet的执行过程中通过这些辅助信息了解执行的过程,它并不会改变任何操作状态.</li>
</ul>
</blockquote>
<h4 id="资源中的参数"><a href="#资源中的参数" class="headerlink" title="资源中的参数"></a>资源中的参数</h4><blockquote>
<ul>
<li>name：指定要创建或显示的信息</li>
<li>system：是否为系统的，true为是，false表示非；</li>
<li>ensure：描述状态的。present表示必须创建，adsent表示不创建。latest表示安装最新版本，installed也表示安装最新版本，如果不想安装最新版本，要指定版本号，用present也可以安装。running表示处理启动状态。file表示是配置文件。directory表示定义为目录；</li>
<li>enable：表示开机是否自启动，如true</li>
<li>require：表示依赖哪个属性；</li>
<li>before：表示先于上面的哪个资源执行</li>
<li>subscribe：订阅前面的资源，如果前面发生改变就通知后面的资源，服务会重启。notify和subscribe是通知相关的其它资源进行“刷新”操作</li>
<li>-&gt;表示某资源要在另一个资源之前执行。-&gt;不能写在下面的资源后，如果要用这个符号，就要写在优先于的资源的上面。</li>
<li>~&gt;表示通知某资源</li>
<li>path：在exec资源中使用时一定要给定命令路径，如’/bin:/sbin:/usr/bin:/usr/sbin’,，如果在exec中没有给路径的情况下。</li>
<li>recurse：表示递归复制整个目录，可用true。</li>
<li>creates：只有在此目录不存在时才执行。对于目录或文件路径类的操作资源来讲，可以用creates来判断，如果不存在才创建</li>
<li>command：要执行的命令</li>
<li>unless：表示其指定的命令执行失败了才执行上面的创建用户命令</li>
<li>refreshonly：refreshonly为true表示触发时才执行命令，如程序包安装了才创建用户，如果没有程序包，就不会创建。如果没有refreshonly时，即使没有事件通知它，exec也会执行。如果加上refreshonly时，exec仅在其他资源用notify或subscribe事件通知时才会执行。refreshonly作用是让exec只在通知时执行，如果被通知多次就执行多次。</li>
<li>refresh：如果有其他资源调用exec的时候，exec会执行好几次，加上refresh后就只会执行一次了，refresh作用就是不管有通知没通知，有多少次通知，都只执行一次。</li>
<li>provider：定义用什么方式安装，如rpm</li>
<li>owner：表示文件属主</li>
<li>group：表示文件属组</li>
<li>mode：表示文件权限</li>
<li>message：输出描述信息</li>
<li>withpath：是否显示完整对象路径。</li>
</ul>
</blockquote>
<h3 id="puppet单机模型"><a href="#puppet单机模型" class="headerlink" title="puppet单机模型"></a>puppet单机模型</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">环境</span><br><span class="line">node1：192.168.1.70</span><br><span class="line">==============================================================================================</span><br><span class="line">------------</span><br><span class="line">  node1</span><br><span class="line">------------ </span><br><span class="line">[root@puppet ~]# yum install -y epel-release</span><br><span class="line">[root@puppet ~]# yum install -y puppet facter</span><br><span class="line"><span class="meta">#</span><span class="bash"> facter是一个非常有用的系统盘点工具，自定义时可以让节点增加更多的标签。这个工具可以通过一些预先设定好变量定位一台主机，比如可以通过变量lsbdistrelease便可以知道当前系统的版本号，通过osfamily便可以知道系统是RedHat还是SLES，还有其他等等。</span></span><br><span class="line">[root@puppet ~]# puppet describe -l</span><br><span class="line">These are the types known to puppet:</span><br><span class="line">augeas          - Apply a change or an array of changes to the  ...</span><br><span class="line">computer        - Computer object management using DirectorySer ...</span><br><span class="line">cron            - Installs and manages cron jobs</span><br><span class="line">exec            - Executes external commands</span><br><span class="line">file            - Manages files, including their content, owner ...</span><br><span class="line">filebucket      - A repository for storing and retrieving file  ...</span><br><span class="line">group           - Manage groups</span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看资源类型</span></span><br><span class="line">[root@puppet ~]# puppet describe group</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看组类型</span></span><br><span class="line">[root@puppet ~]# mkdir manifests</span><br><span class="line">[root@puppet ~]# cd manifests</span><br></pre></td></tr></table></figure>
<h4 id="资源组创建"><a href="#资源组创建" class="headerlink" title="资源组创建"></a>资源组创建</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim first.pp</span><br><span class="line"><span class="meta">#</span><span class="bash"> puppet资源清单要以.pp结尾</span></span><br><span class="line">group&#123;'nginx':			# 如果组中没有空白可以不用引号，这里组名就叫nignx，之后用冒号隔开</span><br><span class="line">   name =&gt; 'nginx',</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一个属性name，用=&gt;表示赋值，也叫nginx，最后用逗号隔开。如果不写name，那么就用上面的title当默认的name，也就是上面的nginx</span></span><br><span class="line">   gid =&gt; 900,		# 指定组id，一定要指定组id，如果不加组id，创建系统组会失败。如果已经有要创建的组了，可以通过这里修改组id</span><br><span class="line">   system =&gt; true,</span><br><span class="line"><span class="meta">#</span><span class="bash"> system表示系统组，这里的<span class="literal">true</span>不能加引号，因为<span class="literal">true</span>是布尔型的值。如果创建普通组，可以去掉system项</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply --verbose --noop first.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.07 seconds</span><br><span class="line">Info: Applying configuration version '1548897081'</span><br><span class="line">Info: Creating state file /var/lib/puppet/state/state.yaml</span><br><span class="line">Notice: Finished catalog run in 0.01 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> apply表示跑一次，--verbose表示查看详细信息，--noop表示干跑。显示结果是绿色表示没有问题</span></span><br><span class="line">[root@puppet manifests]# puppet apply -v first.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.06 seconds</span><br><span class="line">Info: Applying configuration version '1548897756'</span><br><span class="line">Notice: /Stage[main]/Main/Group[nginx]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line">[root@puppet manifests]# cat /etc/group|grep nginx            </span><br><span class="line">nginx:x:900:</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建成功</span></span><br></pre></td></tr></table></figure>
<h4 id="创建组和用户资源"><a href="#创建组和用户资源" class="headerlink" title="创建组和用户资源"></a>创建组和用户资源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim second.pp</span><br><span class="line">group&#123;'memcached':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line"><span class="meta">#</span><span class="bash"> ensure是描述状态的，present表示必须创建出来。定义系统组时必须有此项(CentOS6上500以内为系统用户和组，500开始为普通用户和组。CentOS7上是1000以内)，但最好何时都加上</span></span><br><span class="line">   name =&gt; 'memcached',</span><br><span class="line">   system =&gt; true,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop second.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.06 seconds</span><br><span class="line">Info: Applying configuration version '1548898738'</span><br><span class="line">Notice: /Stage[main]/Main/Group[memcached]/ensure: current_value absent, should be present (noop)</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.03 seconds</span><br><span class="line">[root@puppet manifests]# puppet apply -v second.pp         </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.07 seconds</span><br><span class="line">Info: Applying configuration version '1548898802'</span><br><span class="line">Notice: /Stage[main]/Main/Group[memcached]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line">[root@puppet manifests]# grep -i 'memcached' /etc/group</span><br><span class="line">memcached:x:899:</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这次在second.pp中不加组id也可以创建系统组了。但还是建议加入组id</span></span><br><span class="line">[root@puppet manifests]# vim user1.pp</span><br><span class="line">user&#123;'nginx':</span><br><span class="line">   uid =&gt; 444,</span><br><span class="line">   gid =&gt; 'nginx',</span><br><span class="line">   system =&gt; true,</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop --debug user1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.11 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 基本组要事先存在才能创建用户，--debug可以输出更加详细的信息</span></span><br><span class="line">[root@puppet manifests]# vim user1.pp </span><br><span class="line">group&#123;'nginx':</span><br><span class="line">   system =&gt; true,</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">user&#123;'nginx':</span><br><span class="line">   uid =&gt; 444,</span><br><span class="line">   gid =&gt; 'nginx',</span><br><span class="line">   system =&gt; true,</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --debug --noop user1.pp</span><br><span class="line">[root@puppet manifests]# puppet apply -v --debug user1.pp  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样就能创建了，同一个定义执行多遍，其结果是一样的。这叫幂等性。如果没有幂等性，要让其拥有</span></span><br><span class="line"></span><br><span class="line">[root@puppet manifests]# vim user2.pp</span><br><span class="line">user&#123;'redis':</span><br><span class="line">   gid =&gt; 'redis',</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">group&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop --debug user2.pp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以执行，会先创建组再创建用户，反着写也可以。只要是在同一文件中就没问题</span></span><br><span class="line">[root@puppet manifests]# vim user2.pp                     </span><br><span class="line">user&#123;'redis':</span><br><span class="line">   gid =&gt; 'redis',</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   require =&gt; Group['redis'],</span><br><span class="line"><span class="meta">#</span><span class="bash"> require表示依赖哪个属性，Group这个属性的第一个字母必须大写，后面用[<span class="string">''</span>]的方式写明title。这样定义后，执行时就必须先执行下面的命令</span></span><br><span class="line">&#125;</span><br><span class="line">group&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   before =&gt; User['redis'],</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这表示先于上面的user执行，格式与上面的require一样，这两种方法都可以使group先执行</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet describe package</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看管理程序包的</span></span><br></pre></td></tr></table></figure>
<h4 id="创建程序包资源"><a href="#创建程序包资源" class="headerlink" title="创建程序包资源"></a>创建程序包资源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim pkg1.pp</span><br><span class="line">package&#123;'redis':</span><br><span class="line">   ensure =&gt; latest,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# rpm -q redis</span><br><span class="line">package redis is not installed</span><br><span class="line">[root@puppet manifests]# puppet apply -v pkg1.pp                </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.21 seconds</span><br><span class="line">Warning: The package type's allow_virtual parameter will be changing its default value from false to true in a future release. If you do not want to allow virtual packages, please explicitly set allow_virtual to false.</span><br><span class="line">   (at /usr/share/ruby/vendor_ruby/puppet/type.rb:816:in `set_default')</span><br><span class="line">Info: Applying configuration version '1548900655'</span><br><span class="line">Notice: /Stage[main]/Main/Package[redis]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 11.39 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里会有一个Warning: 提示，可以在文件中加入allow_virtual =&gt; <span class="literal">false</span>，就不会提示了</span></span><br><span class="line">[root@puppet manifests]# rpm -q redis</span><br><span class="line">redis-3.2.12-2.el7.x86_64</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装成功了</span></span><br><span class="line"></span><br><span class="line">下载jdk-8u201-linux-x64.rpm到root目录</span><br><span class="line">[root@puppet manifests]# vim pkg2.pp</span><br><span class="line">package&#123;'jdk':</span><br><span class="line">   ensure =&gt; installed,</span><br><span class="line">   source =&gt; '/root/jdk-8u201-linux-x64.rpm',</span><br><span class="line">   provider =&gt; rpm,</span><br><span class="line">   allow_virtual =&gt; false,		# 不加入此项，还会有警告提示</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop pkg2.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.22 seconds</span><br><span class="line">Info: Applying configuration version '1548905011'</span><br><span class="line">Notice: /Stage[main]/Main/Package[jdk]/ensure: current_value absent, should be present (noop)</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.11 seconds</span><br><span class="line">[root@puppet manifests]# puppet apply -v pkg2.pp        </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.22 seconds</span><br><span class="line">Info: Applying configuration version '1548905065'</span><br><span class="line">Notice: /Stage[main]/Main/Package[jdk]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 7.13 seconds</span><br><span class="line">[root@puppet manifests]# java -version</span><br><span class="line">java version "1.8.0_201"</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_201-b09)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.201-b09, mixed mode)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装成功</span></span><br><span class="line">[root@puppet manifests]# ls /usr/java/</span><br><span class="line">default  jdk1.8.0_201-amd64  latest</span><br><span class="line">[root@puppet manifests]# rpm -q jdk1.8-2000:1.8.0_201-fcs.x86_64</span><br><span class="line">jdk1.8-1.8.0_201-fcs.x86_64</span><br></pre></td></tr></table></figure>
<h4 id="服务与配置文件"><a href="#服务与配置文件" class="headerlink" title="服务与配置文件"></a>服务与配置文件</h4><h5 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim service1.pp</span><br><span class="line">service&#123;'redis':</span><br><span class="line">   ensure =&gt; running,		# 确保处于启动状态</span><br><span class="line">   enable =&gt; true,		# 是否开机自启动</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop service1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.08 seconds</span><br><span class="line">Info: Applying configuration version '1548905408'</span><br><span class="line">Notice: /Stage[main]/Main/Service[redis]/ensure: current_value stopped, should be running (noop)</span><br><span class="line">Info: /Stage[main]/Main/Service[redis]: Unscheduling refresh on Service[redis]</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.03 seconds</span><br><span class="line">[root@puppet manifests]# puppet apply -v service1.pp        </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.08 seconds</span><br><span class="line">Info: Applying configuration version '1548905419'</span><br><span class="line">Notice: /Stage[main]/Main/Service[redis]/ensure: ensure changed 'stopped' to 'running'</span><br><span class="line">Info: /Stage[main]/Main/Service[redis]: Unscheduling refresh on Service[redis]</span><br><span class="line">Notice: Finished catalog run in 0.10 seconds</span><br><span class="line">[root@puppet manifests]# ss -tln</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128    127.0.0.1:6379                   *:*             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到redis启动了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务要依赖程序包，要先安装程序包，才能启动服务</span></span><br><span class="line">[root@puppet manifests]# vim service1.pp                        </span><br><span class="line">package&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">service&#123;'redis':</span><br><span class="line">   ensure =&gt; running,</span><br><span class="line">   enable =&gt; true,</span><br><span class="line">   require =&gt; Package['redis']</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# cp /etc/redis.conf ./</span><br><span class="line">[root@puppet manifests]# vim redis.conf</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">requirepass centos</span><br><span class="line">[root@puppet manifests]# vim file1.pp</span><br><span class="line">file&#123;'/etc/redis.conf':		# 如果只写名字，后面一定要有path。否则就要给目标主机上配置文件的全路径</span><br><span class="line">   ensure =&gt; file,</span><br><span class="line">   source =&gt; '/root/manifests/redis.conf',</span><br><span class="line">   owner =&gt; 'redis',		# 文件属主</span><br><span class="line">   group =&gt; 'root',			# 文件属组</span><br><span class="line">   mode =&gt; '0644',			# 文件权限</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop file1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.07 seconds</span><br><span class="line">Info: Applying configuration version '1548905958'</span><br><span class="line">Notice: /Stage[main]/Main/File[/etc/redis.conf]/content: current_value &#123;md5&#125;d98629fded012cd2a25b9db0599a9251, should be &#123;md5&#125;1a1a5828970c05c20bb80d5930c66f12 (noop)</span><br><span class="line">Notice: /Stage[main]/Main/File[/etc/redis.conf]/mode: current_value 0640, should be 0644 (noop)</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 2 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line">[root@puppet manifests]# puppet apply -v --debug file1.pp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样只会改变文件，但服务不会重启</span></span><br><span class="line">[root@puppet manifests]# grep -E -v "^$|^#" /etc/redis.conf </span><br><span class="line">bind 0.0.0.0</span><br><span class="line">requirepass centos</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到本机的redis配置文件已被修改了</span></span><br></pre></td></tr></table></figure>
<h5 id="通知-amp-订阅"><a href="#通知-amp-订阅" class="headerlink" title="通知&amp;订阅"></a>通知&amp;订阅</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">* 方法一</span><br><span class="line">[root@puppet manifests]# vim service1.pp </span><br><span class="line">package&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">file&#123;'/etc/redis.conf':</span><br><span class="line">   ensure =&gt; file,</span><br><span class="line">   source =&gt; '/root/manifests/redis.conf',</span><br><span class="line">   require =&gt; Package['redis'],</span><br><span class="line">   owner =&gt; 'redis',</span><br><span class="line">   group =&gt; 'root',</span><br><span class="line">&#125;</span><br><span class="line">service&#123;'redis':</span><br><span class="line">   ensure =&gt; running,</span><br><span class="line">   enable =&gt; true,</span><br><span class="line">   require =&gt; Package['redis'],</span><br><span class="line">   subscribe =&gt; File['/etc/redis.conf'],</span><br><span class="line"><span class="meta">#</span><span class="bash"> 订阅前面的资源，如果前面发生改变就通知后面的资源，服务会重启。notify和subscribe是通知相关的其它资源进行“刷新”操作</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# vim redis.conf</span><br><span class="line">requirepass 123456</span><br><span class="line"><span class="meta">#</span><span class="bash"> 改一下模板的密码</span></span><br><span class="line">[root@puppet manifests]# puppet apply -v service1.pp  </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.41 seconds</span><br><span class="line">Warning: The package type's allow_virtual parameter will be changing its default value from false to true in a future release. If you do not want to allow virtual packages, please explicitly set allow_virtual to false.</span><br><span class="line">   (at /usr/share/ruby/vendor_ruby/puppet/type.rb:816:in `set_default')</span><br><span class="line">Info: Applying configuration version '1548906366'</span><br><span class="line">Info: /Stage[main]/Main/File[/etc/redis.conf]: Filebucketed /etc/redis.conf to puppet with sum 1a1a5828970c05c20bb80d5930c66f12</span><br><span class="line">Notice: /Stage[main]/Main/File[/etc/redis.conf]/content: content changed '&#123;md5&#125;1a1a5828970c05c20bb80d5930c66f12' to '&#123;md5&#125;3a3222440b0c68afc02b378da96a22b7'</span><br><span class="line">Notice: /Stage[main]/Main/File[/etc/redis.conf]/mode: mode changed '0644' to '0640'</span><br><span class="line">Info: /Stage[main]/Main/File[/etc/redis.conf]: Scheduling refresh of Service[redis]</span><br><span class="line">Info: /Stage[main]/Main/File[/etc/redis.conf]: Scheduling refresh of Service[redis]</span><br><span class="line">Notice: /Stage[main]/Main/Service[redis]: Triggered 'refresh' from 2 events</span><br><span class="line">Notice: Finished catalog run in 0.25 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提示会刷新服务，对服务来说刷新就是重启</span></span><br><span class="line">[root@puppet manifests]# grep -E -v "^$|^#" /etc/redis.conf                 </span><br><span class="line">bind 0.0.0.0</span><br><span class="line">requirepass 123456</span><br><span class="line"><span class="meta">#</span><span class="bash"> 密码变了</span></span><br><span class="line">[root@puppet manifests]# redis-cli </span><br><span class="line">127.0.0.1:6379&gt; AUTH 123456</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 密码生效了，说明服务重启了</span></span><br><span class="line">[root@puppet manifests]# ss -tln</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128    *:6379                   *:* </span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听地址也改变了</span></span><br><span class="line"></span><br><span class="line">* 方法二</span><br><span class="line">[root@puppet manifests]# vim service1.pp</span><br><span class="line">package&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   allow_virtual =&gt; false,	</span><br><span class="line">&#125; -&gt;		# 表示package在file之前执行</span><br><span class="line">file&#123;'/etc/redis.conf':</span><br><span class="line">   ensure =&gt; file,</span><br><span class="line">   source =&gt; '/root/manifests/redis.conf',</span><br><span class="line">   owner =&gt; 'redis',</span><br><span class="line">   group =&gt; 'root',</span><br><span class="line">&#125; ~&gt;		# 表示通知后面的service</span><br><span class="line">service&#123;'redis':</span><br><span class="line">   ensure =&gt; running,</span><br><span class="line">   enable =&gt; true,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">* 方法三</span><br><span class="line">[root@puppet manifests]# vim service1.pp                    </span><br><span class="line">package&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   allow_virtual =&gt; false,</span><br><span class="line">&#125; </span><br><span class="line">file&#123;'/etc/redis.conf':</span><br><span class="line">   ensure =&gt; file,</span><br><span class="line">   source =&gt; '/root/manifests/redis.conf',</span><br><span class="line">   owner =&gt; 'redis',</span><br><span class="line">   group =&gt; 'root',</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从源文件路径中将文件复制到file指定的目标路径</span></span><br><span class="line">service&#123;'redis':</span><br><span class="line">   ensure =&gt; running,</span><br><span class="line">   enable =&gt; true,</span><br><span class="line">&#125;</span><br><span class="line">Package['redis'] -&gt; File['/etc/redis.conf'] ~&gt; Service['redis']</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以在最下面单独定义通知和依赖关系，感觉这种方法使逻辑更清晰</span></span><br><span class="line">[root@puppet manifests]# vim redis.conf</span><br><span class="line">bind 127.0.0.1</span><br><span class="line">[root@puppet manifests]# puppet apply -v service1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.38 seconds</span><br><span class="line">Info: Applying configuration version '1548907154'</span><br><span class="line">Info: /Stage[main]/Main/File[/etc/redis.conf]: Filebucketed /etc/redis.conf to puppet with sum 3a3222440b0c68afc02b378da96a22b7</span><br><span class="line">Notice: /Stage[main]/Main/File[/etc/redis.conf]/content: content changed '&#123;md5&#125;3a3222440b0c68afc02b378da96a22b7' to '&#123;md5&#125;632baae21fab969118a56acd6b389543'</span><br><span class="line">Info: /Stage[main]/Main/File[/etc/redis.conf]: Scheduling refresh of Service[redis]</span><br><span class="line">Notice: /Stage[main]/Main/Service[redis]: Triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.22 seconds</span><br><span class="line">[root@puppet manifests]# ss -tln</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128    127.0.0.1:6379                   *:* </span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到服务重启了。但有些服务是不能重启的，如nginx。要在定义资源时写restart为nginx -s reload，改restart命令，不让其重启</span></span><br></pre></td></tr></table></figure>
<h5 id="生成指定信息的文件"><a href="#生成指定信息的文件" class="headerlink" title="生成指定信息的文件"></a>生成指定信息的文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim file2.pp</span><br><span class="line">file&#123;'/tmp/test.txt':		# 生成/tmp/test.txt文件</span><br><span class="line">   ensure =&gt; file,		# 这里也可以用persent</span><br><span class="line">   content =&gt; 'Hello there',		# 文件还可以基于content生成，用/n可换行</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用content生成文件信息，写入到file指定的目标文件中</span></span><br><span class="line">[root@puppet manifests]# puppet apply file2.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.07 seconds</span><br><span class="line">Notice: /Stage[main]/Main/File[/tmp/test.txt]/ensure: defined content as '&#123;md5&#125;e8ea7a8d1e93e8764a84a0f3df4644de'</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line">[root@puppet manifests]# cat /tmp/test.txt </span><br><span class="line">Hello there</span><br></pre></td></tr></table></figure>
<h5 id="生成软链接"><a href="#生成软链接" class="headerlink" title="生成软链接"></a>生成软链接</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim file3.pp</span><br><span class="line">file&#123;'/tmp/test.txt.link':		# 生成链接文件</span><br><span class="line">   ensure =&gt; link,		# 链接文件类型</span><br><span class="line">   target =&gt; '/tmp/test.txt',		# 指定源文件路径</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply file3.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.07 seconds</span><br><span class="line">Notice: /Stage[main]/Main/File[/tmp/test.txt.link]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 0.03 seconds</span><br><span class="line">[root@puppet manifests]# ll /tmp</span><br><span class="line">lrwxrwxrwx 1 root root 13 Jan 31 12:09 test.txt.link -&gt; /tmp/test.txt</span><br></pre></td></tr></table></figure>
<h5 id="复制目录"><a href="#复制目录" class="headerlink" title="复制目录"></a>复制目录</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim file4.pp</span><br><span class="line">file&#123;'/tmp/pam.d':</span><br><span class="line">   ensure =&gt; directory,</span><br><span class="line">   source =&gt; '/etc/pam.d',</span><br><span class="line">   recurse =&gt; true,		# 表示递归复制整个目录</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果不用<span class="built_in">source</span>和recurse，那么就会创建一个空目录。测试不用recurse也会创建一个pam.d的空目录。</span></span><br><span class="line">[root@puppet manifests]# puppet apply file4.pp</span><br><span class="line">[root@puppet manifests]# ll /tmp/pam.d/</span><br><span class="line">total 108</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到目录被复制了</span></span><br></pre></td></tr></table></figure>
<h4 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h4><h5 id="基本执行"><a href="#基本执行" class="headerlink" title="基本执行"></a>基本执行</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim exec1.pp</span><br><span class="line">exec&#123;'mkdir':		# mkdir不能当命令用，如果要当，要加路径</span><br><span class="line">   command =&gt; 'mkdir /tmp/testdir',</span><br><span class="line">   path =&gt; '/bin:/sbin:/usr/bin:/usr/sbin',		# 一定要给定命令路径</span><br><span class="line">   creates =&gt; '/tmp/testdir',		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只有在此目录不存在时才执行。对于目录或文件路径类的操作资源来讲，可以用creates来判断，如果不存在才创建</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v exec1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.02 seconds</span><br><span class="line">Info: Applying configuration version '1548908746'</span><br><span class="line">Notice: /Stage[main]/Main/Exec[mkdir]/returns: executed successfully</span><br><span class="line">Notice: Finished catalog run in 0.06 seconds</span><br><span class="line">[root@puppet manifests]# ls /tmp/</span><br><span class="line">testdir</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令执行了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果文件中不加creates一项，执行时会报错，因为已经有目录了，这个命令是不幂等的。如果有creates一项，就不会报错了</span></span><br></pre></td></tr></table></figure>
<h5 id="判断执行"><a href="#判断执行" class="headerlink" title="判断执行"></a>判断执行</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim exec2.pp </span><br><span class="line">exec&#123;'adduser':</span><br><span class="line">   command =&gt; 'useradd -r mogilefs',</span><br><span class="line">   path =&gt; '/bin:/sbin:/usr/bin:/usr/sbin',</span><br><span class="line">   unless =&gt; 'id mogilefs',		# unless表示其指定的命令执行失败了才执行上面的创建用户命令</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply exec2.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.02 seconds</span><br><span class="line">Notice: /Stage[main]/Main/Exec[adduser]/returns: executed successfully</span><br><span class="line">Notice: Finished catalog run in 0.08 seconds</span><br><span class="line">[root@puppet manifests]# id mogilefs</span><br><span class="line">uid=442(mogilefs) gid=442(mogilefs) groups=442(mogilefs)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令执行成功了</span></span><br><span class="line">[root@puppet manifests]# puppet apply exec2.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.02 seconds</span><br><span class="line">Notice: Finished catalog run in 0.06 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次执行时，就不会再执行文件中的命令了</span></span><br><span class="line"></span><br><span class="line">[root@puppet manifests]# vim exec2.pp</span><br><span class="line">package&#123;'mogilefs':</span><br><span class="line">   ensure =&gt; latest,</span><br><span class="line">&#125;</span><br><span class="line">exec&#123;'adduser':</span><br><span class="line">   command =&gt; 'useradd -r mogilefs',</span><br><span class="line">   path =&gt; '/bin:/sbin:/usr/bin:/usr/sbin',</span><br><span class="line">   unless =&gt; 'id mogilefs',</span><br><span class="line">   refreshonly =&gt; true,</span><br><span class="line"><span class="meta">#</span><span class="bash"> refreshonly作用是让<span class="built_in">exec</span>仅在其他资源用notify或subscribe事件通知时才会执行，如果被通知多次就执行多次。</span></span><br><span class="line">   subscribe =&gt; Package['mogilefs'],</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义何时执行，Package表示其指定的包安装后才执行</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# userdel -r mogilefs</span><br><span class="line">[root@puppet manifests]# puppet apply -v exec2.pp   </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.27 seconds</span><br><span class="line">Info: Applying configuration version '1548909636'</span><br><span class="line">Error: Could not update: Execution of '/usr/bin/yum -d 0 -e 0 -y list mogilefs' returned 1: Error: No matching Packages to list</span><br><span class="line">Wrapped exception:</span><br><span class="line">Execution of '/usr/bin/yum -d 0 -e 0 -y list mogilefs' returned 1: Error: No matching Packages to list</span><br><span class="line">Error: /Stage[main]/Main/Package[mogilefs]/ensure: change from absent to latest failed: Could not update: Execution of '/usr/bin/yum -d 0 -e 0 -y list mogilefs' returned 1: Error: No matching Packages to list</span><br><span class="line">Notice: /Stage[main]/Main/Exec[adduser]: Dependency Package[mogilefs] has failures: true</span><br><span class="line">Warning: /Stage[main]/Main/Exec[adduser]: Skipping because of failed dependencies</span><br><span class="line">Notice: Finished catalog run in 4.67 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提示没有程序包，不能执行</span></span><br><span class="line">[root@puppet manifests]# id mogilefs</span><br><span class="line">id: mogilefs: no such user</span><br></pre></td></tr></table></figure>
<h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim cron1.pp</span><br><span class="line">cron&#123;'synctime':</span><br><span class="line">   command =&gt; '/usr/sbin/ntpdate ntp.ubuntu.com &amp;&gt; /dev/null',		# 要执行的命令</span><br><span class="line">   name =&gt; 'synctime from ntp server',</span><br><span class="line">   minute =&gt; '*/3',		# 每3分钟执行一次</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面三个是必须给的属性，不给定用户，就是给当前用户的定时任务</span></span><br><span class="line">   ensure =&gt; present,		# absent表示删除，persent表示添加</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v cron1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.03 seconds</span><br><span class="line">Info: Applying configuration version '1548910460'</span><br><span class="line">Notice: /Stage[main]/Main/Cron[synctime]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 0.09 seconds</span><br><span class="line">[root@puppet manifests]# crontab -l</span><br><span class="line">*/3 * * * * /usr/sbin/ntpdate ntp.ubuntu.com &amp;&gt; /dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加了定时任务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果将上面改为ensure =&gt; absent，再执行一次puppet就会删除定时任务。</span></span><br></pre></td></tr></table></figure>
<h4 id="显示提示信息"><a href="#显示提示信息" class="headerlink" title="显示提示信息"></a>显示提示信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim notify1.pp</span><br><span class="line">notify&#123;'sayhi':</span><br><span class="line">   message =&gt; 'How old are you',</span><br><span class="line">   name =&gt; 'sayhi',</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> notify是显示提示信息的，信息会发送到日志中</span></span><br><span class="line">[root@puppet manifests]# puppet apply notify1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.01 seconds</span><br><span class="line">Notice: How old are you</span><br><span class="line">Notice: /Stage[main]/Main/Notify[sayhi]/message: defined 'message' as 'How old are you'</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 结果中有Notify:后是message定义的信息</span></span><br></pre></td></tr></table></figure>
<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">定义变量：以$开头，如：$system、$flag</span><br><span class="line">赋值：=  ，如：$one = "first one"</span><br><span class="line"></span><br><span class="line">引用变量：有三种方法如下</span><br><span class="line"><span class="meta">$</span><span class="bash">var = <span class="string">"Hello World!"</span></span></span><br><span class="line">notice "1.$var"</span><br><span class="line">notice "2.$&#123;var&#125;"</span><br><span class="line">notice "3.$::var"</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# facter -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 收集打印当前系统上的所有变量，这些变量会传递给puppet主机</span></span><br><span class="line">[root@puppet manifests]# vim user3.pp</span><br><span class="line">[root@puppet manifests]# vim user3.pp             </span><br><span class="line"><span class="meta">$</span><span class="bash">username = <span class="string">"test"</span></span></span><br><span class="line"></span><br><span class="line">group&#123;"$username":		# 在使用变量时要用双引号引用</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   system =&gt; true,</span><br><span class="line">&#125; -&gt;</span><br><span class="line">user&#123;"$username":</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   gid =&gt; "$username",</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v user3.pp</span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.12 seconds</span><br><span class="line">Info: Applying configuration version '1548913706'</span><br><span class="line">Notice: /Stage[main]/Main/Group[test]/ensure: created</span><br><span class="line">Notice: /Stage[main]/Main/User[test]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 0.08 seconds.</span><br><span class="line">[root@puppet manifests]# id test</span><br><span class="line">uid=1000(test) gid=896(test) groups=896(test)</span><br><span class="line">[root@puppet manifests]# grep test /etc/group</span><br><span class="line">test:x:896:</span><br></pre></td></tr></table></figure>
<h4 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">语法结构：</span><br><span class="line"></span><br><span class="line">/(?&lt;ENABLED OPTION&gt;:&lt;SUBPATTERN&gt;)/</span><br><span class="line">/(?-&lt;DISABLED OPTION&gt;:&lt;SUBPATTERN&gt;)/</span><br><span class="line"></span><br><span class="line">OPTION：</span><br><span class="line">i: 忽略字符大小写</span><br><span class="line">m: 把点号当换行符使用</span><br><span class="line">x：忽略模式中的空白字符和注释</span><br><span class="line"></span><br><span class="line">惯常用法：(?i-mx:PATTERN)</span><br><span class="line"><span class="meta">$</span><span class="bash">webpackage=<span class="variable">$operatingsystem</span>? &#123;</span></span><br><span class="line">       /(?i-mx:ubuntu|debian)/ =&gt; ‘apache2‘,</span><br><span class="line">       /(?i-mx:fedora|redhat|centos)/  =&gt; ‘httpd‘,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="判断语句"><a href="#判断语句" class="headerlink" title="判断语句"></a>判断语句</h4><h5 id="if判断"><a href="#if判断" class="headerlink" title="if判断"></a>if判断</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">语法一</span><br><span class="line">if 条件 &#123;</span><br><span class="line">语句</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">条件：是true执行语句，是false则跳过语句</span><br><span class="line"></span><br><span class="line">语法二</span><br><span class="line">if CONDITION &#123;</span><br><span class="line">...</span><br><span class="line">&#125; else &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">语法三</span><br><span class="line">if CONDITION &#123;</span><br><span class="line">...</span><br><span class="line">&#125; elsif CONDITION &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">else &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">if $operatingsystem =~ /^(?i-mx:(Ubuntu|RedHat))/ &#123;</span><br><span class="line">       notice("Welcome to $1 linux distribution.")</span><br><span class="line">&#125; else &#123;</span><br><span class="line">       notice("Welcome to unkown world.")</span><br><span class="line">&#125;</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# vim if.pp</span><br><span class="line">if $operatingsystem == 'CentOS' &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      ensure =&gt; present,</span><br><span class="line">      allow_virtual =&gt; false,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop if.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.22 seconds</span><br><span class="line">Info: Applying configuration version '1548914166'</span><br><span class="line">Notice: /Stage[main]/Main/Package[nginx]/ensure: current_value absent, should be present (noop)</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.13 seconds</span><br><span class="line"></span><br><span class="line">[root@puppet manifests]# vim if.pp</span><br><span class="line">if $operatingsystem == 'Fedora' &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      ensure =&gt; present,</span><br><span class="line">      allow_virtual =&gt; false,</span><br><span class="line">   &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">   notify&#123;'goaway':</span><br><span class="line">      message =&gt; 'allien',</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop if.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.01 seconds</span><br><span class="line">Info: Applying configuration version '1548914282'</span><br><span class="line">Notice: /Stage[main]/Main/Notify[goaway]/message: current_value absent, should be allien (noop)</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行了message</span></span><br></pre></td></tr></table></figure>
<h5 id="unless判断"><a href="#unless判断" class="headerlink" title="unless判断"></a>unless判断</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">语法</span><br><span class="line">unless 条件 &#123;</span><br><span class="line">语句</span><br><span class="line">&#125;</span><br><span class="line">条件：当false时，执行语句。当true时跳过。</span><br><span class="line">==============================================================================================</span><br><span class="line">例</span><br><span class="line"><span class="meta">$</span><span class="bash">varless = 100</span></span><br><span class="line">unless $varless &gt; 1000 &#123;</span><br><span class="line">  notice "$varless &gt; 1000 is false"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="case判断"><a href="#case判断" class="headerlink" title="case判断"></a>case判断</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">语法</span><br><span class="line">case 变量/表达式 &#123;</span><br><span class="line">值1 : &#123;语句1&#125;</span><br><span class="line">值2,值3 : &#123;语句2&#125;</span><br><span class="line">default : &#123;不是上面的值时，执行这条语句&#125;</span><br><span class="line">&#125;</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# vim case.pp</span><br><span class="line">case $operatingsystem &#123;</span><br><span class="line">   RedHat,CentOS,Fedora: &#123; $webserver = 'httpd' &#125;</span><br><span class="line">   /(?i-mx:debian|ubuntu)/: &#123; $webserver = "apache2" &#125;</span><br><span class="line">   default: &#123; $webserver = 'httpd' &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果是RedHat等，就定义webserver变量为httpd，如果是debian等，就为apache2，否则就为httpd</span></span><br><span class="line">&#125;</span><br><span class="line">package&#123;"$webserver":</span><br><span class="line">   ensure =&gt; latest,</span><br><span class="line">   allow_virtual =&gt; false,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v case.pp           </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.23 seconds</span><br><span class="line">Info: Applying configuration version '1548915048'</span><br><span class="line">Notice: /Stage[main]/Main/Package[httpd]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 8.68 seconds</span><br><span class="line">[root@puppet manifests]# rpm -q httpd</span><br><span class="line">httpd-2.4.6-88.el7.centos.x86_64</span><br></pre></td></tr></table></figure>
<h5 id="selector判断"><a href="#selector判断" class="headerlink" title="selector判断"></a>selector判断</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">语法</span><br><span class="line">未知变量 = 可知变量 ? &#123;</span><br><span class="line">值1 =&gt; 赋值1,</span><br><span class="line">值2 =&gt; 赋值2,</span><br><span class="line">default =&gt; 赋值3,</span><br><span class="line">&#125;</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# vim selector.pp</span><br><span class="line"><span class="meta">$</span><span class="bash">webserver = <span class="variable">$operatingsystem</span> ? &#123;</span></span><br><span class="line">   /(ubuntu|debian)/ =&gt; 'apache2',</span><br><span class="line">   /(?i-mx:centos|redhat|fedora)/ =&gt; 'httpd',</span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line">   default =&gt; 'httpd',</span><br><span class="line">&#125;</span><br><span class="line">package&#123;"$webserver":</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   allow_virtual =&gt; false,</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用这种方法也可以判断，判断operatingsystem是什么，然后赋值给webserver。</span></span><br><span class="line">[root@puppet manifests]# yum remove httpd -y</span><br><span class="line">[root@puppet manifests]# puppet apply selector.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.23 seconds</span><br><span class="line">Notice: /Stage[main]/Main/Package[httpd]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 9.19 seconds</span><br><span class="line">[root@puppet manifests]# rpm -q httpd</span><br><span class="line">httpd-2.4.6-88.el7.centos.x86_64</span><br></pre></td></tr></table></figure>
<h4 id="类"><a href="#类" class="headerlink" title="类"></a>类</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">语法</span><br><span class="line">class name &#123;</span><br><span class="line">... puppet code ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义过的类只有被调用(声明)才会执行；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 类名可以包含小写字母、数字和下划线，但只能小写字母开头；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 类会引入新的变量作用域；</span></span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# vim class1.pp</span><br><span class="line">class nginx &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">      allow_virtual =&gt; false,</span><br><span class="line">   &#125; -&gt;</span><br><span class="line">   service&#123;'nginx':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">include nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要使用include来调用，不然是不能执行的</span></span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop class1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.33 seconds</span><br><span class="line">Info: Applying configuration version '1548917037'</span><br><span class="line">Notice: /Stage[main]/Nginx/Package[nginx]/ensure: current_value absent, should be latest (noop)</span><br><span class="line">Notice: /Stage[main]/Nginx/Service[nginx]/ensure: current_value stopped, should be running (noop)</span><br><span class="line">Info: /Stage[main]/Nginx/Service[nginx]: Unscheduling refresh on Service[nginx]</span><br><span class="line">Notice: Class[Nginx]: Would have triggered 'refresh' from 2 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.19 seconds</span><br><span class="line"></span><br><span class="line">[root@puppet manifests]# vim class2.pp</span><br><span class="line">class dbserver ($pkgname='mariadb-server') &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 类有一个参数是<span class="variable">$pkgname</span>，mariadb-server是它的默认值。如果传递值给pkgname，就用传递的值，如果没传，就用默认值</span></span><br><span class="line">   package&#123;"$pkgname":</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">      allow_virtual =&gt; false,</span><br><span class="line">   &#125;</span><br><span class="line">   service&#123;'mariadb.service':</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里要写成mariadb.service，不然会无法启动。测试中，将这里写成mariadb，并在下面加上name =&gt; <span class="string">'mariadb.service'</span>也是不行的，系统还是会提示service中的mariadb启动。会提示找不到。</span></span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果没有定义pkgname的默认值并调用dbserver类，它会不知道包名是什么。如果定义了默认值，在CentOS7上就可以执行了</span></span><br><span class="line">if $operatingsystem == "CentOS" &#123;</span><br><span class="line"><span class="meta">   $</span><span class="bash">dbpkg = <span class="variable">$operatingsystemmajrelease</span> ? &#123;</span></span><br><span class="line">      7 =&gt; 'mariadb-server',</span><br><span class="line">      default =&gt; 'mysqld-server',</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断，如果操作系统是CentOS，并且嵌套判断，如果是7版本，就返回mariadb-server给<span class="variable">$dbpkg</span>，否则，就返回mysqld-server</span></span><br><span class="line">class&#123;'dbserver':		# 给dbserver类的参数传值</span><br><span class="line">   pkgname =&gt; $dbpkg,		# 这里也可以是一个具体的值，用单引号引起</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用class&#123;<span class="string">'dbserver'</span>:传递值也是调用类的一种方法</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果类的参数没有默认值，也可以用这种方法给参数传递值</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样都定义完才能实现根据不同系统安装不同名称的程序包</span></span><br></pre></td></tr></table></figure>
<h4 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# cp class1.pp class3.pp</span><br><span class="line">[root@puppet manifests]# vim class3.pp</span><br><span class="line">class nginx &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">      allow_virtual =&gt; false,</span><br><span class="line">   &#125; -&gt;</span><br><span class="line">   service&#123;'nginx':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">      require =&gt; Package['nginx'],</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">class nginx::web inherits nginx &#123;</span><br><span class="line">   file&#123;'nginx.conf':		# 提供配置文件</span><br><span class="line">      path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">      source =&gt; '/root/manifests/nginx.conf',</span><br><span class="line">   &#125;</span><br><span class="line">   Package['nginx'] -&gt; File['nignx.conf'] ~&gt; Service['nginx']</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义Package要先于File资源，最后要通知Service资源</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> nginx::web是子类的名称，inherits表示继承，最后是父类的名称。这样定义后，子类就能使用父类中定义的内容了</span></span><br><span class="line">class nginx::webproxy inherits nginx &#123;</span><br><span class="line">   file&#123;'nginx.conf':</span><br><span class="line">      path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">      source =&gt; '/root/manifests/nginx-webproxy.conf',</span><br><span class="line">   &#125;</span><br><span class="line">      Service['nginx']&#123;</span><br><span class="line">      enable =&gt; false,</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改父类中属性的值，要先引用属性，再写修改的值。修改的项如果有值，就修改其值，如果没有此项，就新增此项。</span></span><br><span class="line">      require +&gt; File['nginx.conf']		# +&gt;，表示新增一个参数，但不会修改原值，这里表示依赖File属性</span><br><span class="line">   &#125;</span><br><span class="line">   Package['nginx'] -&gt; File['nginx.conf'] ~&gt; Service['nginx']</span><br><span class="line">&#125;</span><br><span class="line">class nginx::mysqlproxy inherits nginx &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">include nginx::webproxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里只能引用一个子类，因为如果定义了多个，在本机上就没法确定用哪个子类了</span></span><br><span class="line">[root@puppet manifests]# yum install -y nginx</span><br><span class="line">[root@puppet manifests]# cp /etc/nginx/nginx.conf /root/manifests</span><br><span class="line">[root@puppet manifests]# cp nginx.conf nginx-webproxy.conf</span><br><span class="line">[root@puppet manifests]# vim nginx-webproxy.conf </span><br><span class="line">location / &#123;</span><br><span class="line">           proxy_pass http://192.168.1.71;</span><br><span class="line">        &#125;</span><br><span class="line">[root@puppet manifests]# yum remove -y nginx</span><br><span class="line">[root@puppet manifests]# puppet apply -v class3.pp</span><br><span class="line"></span><br><span class="line">--------------------</span><br><span class="line">  192.168.1.71</span><br><span class="line">--------------------</span><br><span class="line">[root@puppettest1 ~]# yum install nginx -y</span><br><span class="line">[root@puppettest1 ~]# vim /usr/share/nginx/html/test.html</span><br><span class="line">192.168.1.71</span><br><span class="line">[root@puppettest1 ~]# systemctl start nginx</span><br><span class="line"></span><br><span class="line">访问http://192.168.1.70/test.html，可以看到页面上显示192.168.1.71了。</span><br></pre></td></tr></table></figure>
<h4 id="puppet模板"><a href="#puppet模板" class="headerlink" title="puppet模板"></a>puppet模板</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim template.pp</span><br><span class="line">package&#123;'nginx':</span><br><span class="line">   ensure =&gt; latest,</span><br><span class="line">&#125;</span><br><span class="line">file&#123;'nginx.conf':</span><br><span class="line">   path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">   content =&gt; template('/root/manifests/nginx.conf.erb'),</span><br><span class="line"><span class="meta">#</span><span class="bash"> content表示直接生成内容，template是内建的函数，用它去加载一个指定的模板</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# cp nginx.conf nginx.conf.erb</span><br><span class="line">[root@puppet manifests]# vim nginx.conf.erb </span><br><span class="line">worker_processes &lt;%=  @processorcount %&gt;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> processorcount是变量名称，变量是内建的，与auto相同，通过facter -p processorcount命令可以查看到信息。等号是变量替换</span></span><br><span class="line">[root@puppet manifests]# puppet apply -v template.pp</span><br><span class="line">[root@puppet manifests]# less /etc/nginx/nginx.conf           </span><br><span class="line">worker_processes 2;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用模板后，这里变为了2</span></span><br></pre></td></tr></table></figure>
<h4 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim /etc/puppet/puppet.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件中的[main]表示全局配置段，[agent]表示只用于agent程序</span></span><br><span class="line">[root@puppet manifests]# puppet help config</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看配置文件帮助信息</span></span><br><span class="line">[root@puppet manifests]# puppet config print</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印puppet配置信息。其中的modulepath是模块的路径</span></span><br><span class="line">[root@puppet manifests]# puppet config print modulepath</span><br><span class="line">/etc/puppet/modules:/usr/share/puppet/modules</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只显示modulepath一项</span></span><br><span class="line">[root@puppet manifests]# puppet help module</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看模块配置帮助</span></span><br><span class="line">[root@puppet manifests]# puppet module list</span><br><span class="line">/etc/puppet/modules (no modules installed)</span><br><span class="line">/usr/share/puppet/modules (no modules installed)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看模块信息</span></span><br><span class="line">[root@puppet manifests]# puppet module search nginx</span><br><span class="line">Notice: Searching https://forgeapi.puppetlabs.com ...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到互联网搜索与nginx相关的模块</span></span><br><span class="line">[root@puppet manifests]# puppet module install oris-nginx</span><br><span class="line">Notice: Preparing to install into /etc/puppet/modules ...</span><br><span class="line">Notice: Downloading from https://forgeapi.puppetlabs.com ...</span><br><span class="line">Notice: Installing -- do not interrupt ...</span><br><span class="line">/etc/puppet/modules</span><br><span class="line">└─┬ oris-nginx (v1.3.0)</span><br><span class="line">  ├─┬ puppetlabs-apt (v6.3.0)</span><br><span class="line">  │ └── puppetlabs-translate (v1.2.0)</span><br><span class="line">  └── puppetlabs-stdlib (v5.2.0)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装模块oris-nginx</span></span><br><span class="line">[root@puppet ~]# mkdir modules</span><br><span class="line">[root@puppet ~]# cd modules/</span><br><span class="line">[root@puppet modules]# mkdir -pv chrony/&#123;manifests,files,templates,lib,spec,tests&#125;</span><br><span class="line">[root@puppet modules]# cd chrony/manifests/</span><br><span class="line">[root@puppet manifests]# vim init.pp		# 创建清单，名字不能变，都要叫init.pp</span><br><span class="line">class chrony &#123;		# 这个清单中必须有一个与模块名相同的类的名字。模块名就是module目录中的目录的名字</span><br><span class="line">   package&#123;'chrony':</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">   &#125; -&gt;</span><br><span class="line">   file&#123;'chrony.conf':</span><br><span class="line">      path =&gt; '/etc/chrony.conf',</span><br><span class="line">      source =&gt; 'puppet:///modules/chrony/chrony.conf',</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是源路径，表示/etc/puppet/modules/chrony/files目录，只是files目录是不用写，可以自动找到</span></span><br><span class="line">   &#125; ~&gt;</span><br><span class="line">   service&#123;'chronyd':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# cp /etc/chrony.conf /root/modules/chrony/files/</span><br><span class="line">[root@puppet modules]# vim chrony/files/chrony.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 3.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注释三行</span></span><br><span class="line">[root@puppet modules]# cp -a /root/modules/chrony/ /etc/puppet/modules/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置好模块后，要将整个目录都复制到puppet的模块目录。上面创建的modules目录只是为了临时编辑用的，编辑好后是要复制到指定目录的，指定目录是通过puppet config <span class="built_in">print</span> modulepath命令查看到的两个目录都可以</span></span><br><span class="line">[root@puppet modules]# puppet module list</span><br><span class="line">/etc/puppet/modules</span><br><span class="line">├── chrony (???)</span><br><span class="line">├── oris-nginx (v1.3.0)</span><br><span class="line">├── puppetlabs-apt (v6.3.0)</span><br><span class="line">├── puppetlabs-stdlib (v5.2.0)</span><br><span class="line">└── puppetlabs-translate (v1.2.0)</span><br><span class="line">/usr/share/puppet/modules (no modules installed)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 现在就能看到chrony模块了</span></span><br><span class="line">[root@puppet modules]# puppet apply -v -d --noop -e 'include chrony'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-e调用模块</span></span><br><span class="line">[root@puppet modules]# puppet apply -v -e 'include chrony'</span><br><span class="line">[root@puppet modules]# cat /etc/chrony.conf </span><br><span class="line"><span class="meta">#</span><span class="bash"> Use public servers from the pool.ntp.org project.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span><br><span class="line">server 0.centos.pool.ntp.org iburst</span><br><span class="line"><span class="meta">#</span><span class="bash">server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 3.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到配置文件已被修改</span></span><br><span class="line">[root@puppet modules]# mv /etc/puppet/modules/nginx/ /root</span><br><span class="line"><span class="meta">#</span><span class="bash"> 移走上面安装的nginx模块</span></span><br><span class="line">[root@puppet modules]# mkdir -pv nginx/&#123;manifests,files,templates,spec,lib,tests&#125;</span><br><span class="line">[root@puppet modules]# vim nginx/manifests/init.pp		# 定义一个基类</span><br><span class="line">class nginx &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">   &#125;</span><br><span class="line">   service&#123;'nginx':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet modules]# vim nginx/manifests/webproxy.pp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义子类。如果代码较多，可以定义多个子类，但一定要有一个与清单名一样的类名称。参考官方文档，3.8版本以后的版本中，资源清单文件的文件名要与子类名一样</span></span><br><span class="line">class nginx::webproxy inherits nginx &#123;</span><br><span class="line">   file&#123;'nginx.conf':</span><br><span class="line">      path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">      source =&gt; 'puppet:///modules/nginx/nginx-webproxy.conf',</span><br><span class="line">   &#125;</span><br><span class="line">   Package['nginx'] -&gt; File['nginx.conf'] ~&gt; Service['nginx']</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet modules]# cp /root/manifests/nginx-webproxy.conf nginx/files/</span><br><span class="line">[root@puppet modules]# cp -a nginx/ /etc/puppet/modules/</span><br><span class="line">[root@puppet modules]# puppet module list</span><br><span class="line">/etc/puppet/modules</span><br><span class="line">├── chrony (???)</span><br><span class="line">├── nginx (???)</span><br><span class="line">[root@puppet manifests]# puppet apply -v -d --noop -e 'include nginx::webproxy'</span><br><span class="line">==============================================================================================</span><br><span class="line">注意：</span><br><span class="line">1. puppet 3.8及以后的版本中，资源清单文件的文件名要与文件听类名保持一致，例如某子类名为“base_class::child_class”，其文件名应该为child_class.pp；</span><br><span class="line">2. 无需再资源清单文件中使用import语句；</span><br><span class="line">3. manifests目录下可存在多个清单文件，每个清单文件包含一个类，其文件名同类名；</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# pwd</span><br><span class="line">/etc/puppet/modules/nginx/manifests</span><br><span class="line">[root@puppet manifests]# vim web.pp</span><br><span class="line">class nginx::web inherits nginx &#123;</span><br><span class="line">   file&#123;'nginx.conf':</span><br><span class="line">      path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">      content =&gt; 'template('nginx/nginx.conf.erb')',</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里应该是一个相对路径，也就是/etc/puppet/modules下的nginx目录，这里可以省略nginx目录中的template目录，直接写template目录中的nginx.conf.erb即可。</span></span><br><span class="line">   &#125;</span><br><span class="line">   Package['nginx'] -&gt; File['nginx.conf'] ~&gt; Service['nginx']</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# cp /root/manifests/nginx.conf.erb ../templates/</span><br><span class="line">[root@puppet manifests]# puppet apply -v -d --noop -e 'include nginx::web'</span><br><span class="line"></span><br><span class="line">[root@puppet manifests]# cd /root/modules/</span><br><span class="line">[root@puppet modules]# mkdir -pv redis/&#123;manifests,files,templates,spec,lib,tests&#125;</span><br><span class="line">下载一个redis-3.2.8-1.el7.x86_64.rpm到 /root/modules/redis/tests目录中</span><br><span class="line">[root@puppet modules]# vim redis/manifests/init.pp</span><br><span class="line">class redis &#123;</span><br><span class="line"><span class="meta">   $</span><span class="bash">redispkg=<span class="string">'redis-3.2.8-1.el7.x86_64.rpm'</span></span></span><br><span class="line">   package&#123;'redis':</span><br><span class="line">      ensure =&gt; installed,</span><br><span class="line">      provider =&gt; yum,</span><br><span class="line">      source =&gt; "puppet:///modules/redis/$redispkg",</span><br><span class="line">   &#125;</span><br><span class="line">   service&#123;'redis':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet modules]# cp -a redis/ /etc/puppet/modules/</span><br><span class="line">[root@puppet modules]# puppet module list</span><br><span class="line">/etc/puppet/modules</span><br><span class="line">├── chrony (???)</span><br><span class="line">├── nginx (???)</span><br><span class="line">├── puppetlabs-apt (v6.3.0)</span><br><span class="line">├── puppetlabs-stdlib (v5.2.0)</span><br><span class="line">├── puppetlabs-translate (v1.2.0)</span><br><span class="line">└── redis (???)</span><br><span class="line">[root@puppet modules]# puppet apply -v -d --noop -e 'include redis'</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/29/haproxy部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/29/haproxy部署/" itemprop="url">
                  haproxy部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-29 07:29:34 / 修改時間：15:11:40" itemprop="dateCreated datePublished" datetime="2019-01-29T07:29:34+08:00">2019-01-29</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/balance/" itemprop="url" rel="index"><span itemprop="name">balance</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">haproxy配置段分为两段，一为全局配置段，一为代理配置段。代理配置段又分为三段，第一段是frontend，用来定义接收以及从何处接收请求。第二段是backend，定义接收到请求后代理至哪些主机，以及如何进行代理。第三段是listen，定义直接匹配的前端和后端，没有分开定义。这三段如果使用同一个值，用defaults定义。</span><br><span class="line">==============================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Example configuration <span class="keyword">for</span> a possible web application.  See the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> full configuration options online.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Global settings</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line">global		# 全局配置段</span><br><span class="line">    # to have these messages end up in /var/log/haproxy.log you will</span><br><span class="line">    # need to:</span><br><span class="line">    #</span><br><span class="line">    # 1) configure syslog to accept network log events.  This is done</span><br><span class="line">    #    by adding the '-r' option to the SYSLOGD_OPTIONS in</span><br><span class="line">    #    /etc/sysconfig/syslog</span><br><span class="line">    #</span><br><span class="line">    # 2) configure local2 events to go to the /var/log/haproxy.log</span><br><span class="line">    #   file. A line like the following can be added to</span><br><span class="line">    #   /etc/sysconfig/syslog</span><br><span class="line">    #</span><br><span class="line">    #    local2.*                       /var/log/haproxy.log</span><br><span class="line">    #</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义全局日志配置，日志级别为info。127.0.0.1是定义日志输出的地址，local2是日志设备。也就是使用127上的rsyslog来记录日志。这样定义，日志会输出到messages中</span></span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line"><span class="meta">#</span><span class="bash"> pid存放路径</span></span><br><span class="line">    maxconn     4000</span><br><span class="line"><span class="meta">#</span><span class="bash"> haproxy的最大头连接数，与linux的最大打开的文件数有关。一般小于最大打开文件数</span></span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    nbproc		1</span><br><span class="line"><span class="meta">#</span><span class="bash"> haproxy启动时创建的进程数，不要超时CPU的核数</span></span><br><span class="line">    daemon</span><br><span class="line"><span class="meta">#</span><span class="bash"> 做守护进程</span></span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> common defaults that all the <span class="string">'listen'</span> and <span class="string">'backend'</span> sections will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use <span class="keyword">if</span> not designated <span class="keyword">in</span> their block</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line"><span class="meta">#</span><span class="bash"> haproxy实例的运行模式，一般是tcp或http。http就表示工作在七层</span></span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接后端服务器失败重试的次数，如果超过这个值就标记为不可用</span></span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 成功连接服务器的最长等待时间，没有单位是毫秒</span></span><br><span class="line">    timeout client          1m</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端发送数据最长等待时间</span></span><br><span class="line">    timeout server          1m</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务器端回应客户端的最长等待时间</span></span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置检查后端服务器的超时时间，如果超过这个值就标记不可用</span></span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> main frontend <span class="built_in">which</span> proxys to the backends</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line">frontend  main *:5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> main是名称，可自定义名称。*:5000表示监听在所有地址的5000端口</span></span><br><span class="line">    mode	http</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定负载均衡的工作模式</span></span><br><span class="line">	option	httplog</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置haproxy记录http请求的日志记录。建议打开</span></span><br><span class="line">	option	forwardfor</span><br><span class="line"><span class="meta">#</span><span class="bash"> 让后端服务器获取客户端的真实地址</span></span><br><span class="line">	option	httpclose</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端与服务器完成一次连接后，服务器主动关闭这个连接</span></span><br><span class="line">	log		global</span><br><span class="line"><span class="meta">#</span><span class="bash"> 引用全局的日志配置</span></span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /styleshe</span><br><span class="line">ets</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以-i后定义的内容开头的信息的名称为url_static</span></span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以-i后定义的内容结尾的信息的名称为url_static</span></span><br><span class="line">    use_backend static          if url_static</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果是acl中定义了url_static条件的话，就给后端的static池中定义的主机</span></span><br><span class="line">    default_backend             app</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认给app池中定义的主机，也就是不符合给static池的请求都给app</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> static backend <span class="keyword">for</span> serving up images, stylesheets and such</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line">backend static</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义一组后端服务器，static是自取名</span></span><br><span class="line">	mode 		http</span><br><span class="line">	option		redispatch</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用于会话保持</span></span><br><span class="line">	option		abortonclose</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自动结束处理较长的连接</span></span><br><span class="line">    balance     roundrobin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置调度算法</span></span><br><span class="line">	cookie		SERVERID</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定cookie的ID值，表示允许向cookie插入一个serverID。serverID在下面配置。如果是<span class="built_in">source</span>算法，就不用设置	cookie。因为使用cookie就是为了会话保持</span></span><br><span class="line">	option		httpchk GET /index.jsp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 探测后端服务器状态，健康检测，如果长时间无效应，会将后端服务器剔除。haproxy会访问下面sever中定义的每一个后端主机的IP/index.jsp来探测主机是否正常</span></span><br><span class="line">    server      static 127.0.0.1:4331 cookie server1 weight 6 check inter 2000 rise 2 fall 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> static是主机名，自定义的。之后是地址和端口。cookie server1就是定义上面的cookie   SERVERID的。每个server的SERVERID是不一样的。weight是权重。check表示启用对后端服务器的检查，inter是检查的时间间隔，默认单位是毫秒，rise表示连续检查几次标记为正常，fall表示连续检查几次标记为失败</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> round robin balancing between the various backends</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line">backend app</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server  app1 127.0.0.1:5001 check</span><br><span class="line">    server  app2 127.0.0.1:5002 check</span><br><span class="line">    server  app3 127.0.0.1:5003 check</span><br><span class="line">    server  app4 127.0.0.1:5004 check</span><br><span class="line">    </span><br><span class="line">listen admin_stats</span><br><span class="line"><span class="meta">#</span><span class="bash"> listen可以同时拥前端和后端，将前端与后端绑定在一起。主要配置与监控相关的信息。admin_stats是自定义名称</span></span><br><span class="line">	bind 0.0.0.0:9188</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置状态页地址和端口</span></span><br><span class="line">	mode http</span><br><span class="line">	log 127.0.0.1  local0 err</span><br><span class="line">	stats refresh 20s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 刷新的时间间隔</span></span><br><span class="line">	stats uri /haproxy-status</span><br><span class="line"><span class="meta">#</span><span class="bash"> 状态页的地址</span></span><br><span class="line">	stats realm welcome login\ Haproxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 欢迎信息</span></span><br><span class="line">	status auth admin:admin123</span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证信息，用户名:密码</span></span><br><span class="line">	stats hide-version</span><br><span class="line"><span class="meta">#</span><span class="bash"> 隐藏版本号</span></span><br><span class="line">	stats admin if TRUE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启管理后端服务器功能</span></span><br><span class="line"></span><br><span class="line">==============================================================================================</span><br><span class="line">算法</span><br><span class="line">1. roundrobin：Each server is used in turns, according to their weights.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置高度算法为轮询，这里的轮询是加权轮询，这取决于下面的server中是否设定了权重。roundrobin是动态算法，支持权重的运行时调整，调整完不用重启服务。另外支持慢启动，慢启动指当后端加入一台新服务器时，调度器会将请求慢慢地分配到新加入的服务器上，如果马上全部分配到新加入的服务器上，对服务器的压力很大。roundrobin对后端主机的数量是有限制的。最多支持4095个。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server options： weight <span class="comment">#</span></span></span><br><span class="line">2. static-rr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 静态算法：不支持权重的运行时调整及慢启动；后端主机数量无上限；</span></span><br><span class="line">3. leastconn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加权最少连接，最少连接的接收请求，这个算法也是动态的。建议使用在支持长连接的会话中。例如MySQL、LDAP等；</span></span><br><span class="line">4.  first：</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据服务器在列表中的位置，自上而下进行调度；前面服务器的连接数达到上限，新请求才会分配给下一台服务。如果后端有三台服务器，这个算法会依次将后端服务器请求打满，第一台打满后再给第二台服务器</span></span><br><span class="line">5. source</span><br><span class="line"><span class="meta">#</span><span class="bash"> 源地址<span class="built_in">hash</span>，相当于nginx中的IPhash，LVS的HS。如果<span class="built_in">hash</span>取决于hast-type，如果是map-based就是取模法，取模法就是把所有服务器按权重虚拟成节点，如果是权重是2就虚拟成两个节点。对数组元素数量取模，等于几就映射给索引为几的服务器，但服务器变动，<span class="built_in">hash</span>值会影响全局。如果是consistent就是一致性<span class="built_in">hash</span></span></span><br><span class="line">6. uri</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将请求同一个uri的主机代理到后端同一台主机，取决与<span class="built_in">hash</span>-type</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对URI的左半部分做<span class="built_in">hash</span>计算，并由服务器总权重相除以后派发至某挑出的服务器；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;<span class="comment">#&lt;frag&gt;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 左半部分：/&lt;path&gt;;&lt;params&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 整个uri：/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;<span class="comment">#&lt;frag&gt;</span></span></span><br><span class="line">7. url_param</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调度时以某个特定的值调度到后端同一主机，用处不大。动态还是静态取决于<span class="built_in">hash</span>-type</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对用户请求的uri&lt;params&gt;部分中的参数的值作<span class="built_in">hash</span>计算，并由服务器总权重相除以后派发至某挑出的服务器；通常用于追踪用户，以确保来自同一个用户的请求始终发往同一个Backend Server；</span></span><br><span class="line">8. hdr(&lt;name&gt;)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求报文的首部，对对应首部的值做<span class="built_in">hash</span>，一样的就给同一主机。可以对浏览器调度</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对于每个http请求，此处由&lt;name&gt;指定的http首部将会被取出做<span class="built_in">hash</span>计算； 并由服务器总权重相除以后派发至某挑出的服务器；没有有效值的会被轮询调度；根据HTTP请求头来锁定每一次HTTP请求 </span></span><br><span class="line">9. rdp-cookie(&lt;name&gt;)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 远程桌面协议</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 表示根据cookie(name)来锁定并哈希第一次TCP请求</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> uri向下的四种算法为七层算法，用的不多</span></span><br><span class="line"></span><br><span class="line">常用的负载均衡算法</span><br><span class="line">1.轮询算法：roundrobin</span><br><span class="line">2. 根据请求源IP算法：source</span><br><span class="line">3. 最少连接者先处理算法：leastconn</span><br><span class="line">==============================================================================================</span><br></pre></td></tr></table></figure>
<h3 id="测试轮询"><a href="#测试轮询" class="headerlink" title="测试轮询"></a>测试轮询</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">环境</span><br><span class="line">准备三台主机</span><br><span class="line">haproxy：外网地址：192.168.1.25；内网地址：172.16.106.143</span><br><span class="line">httpd1：内网地址：172.16.106.145</span><br><span class="line">httpd2：内网地址：172.16.106.144</span><br><span class="line">==============================================================================================</span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">  httpd1&amp;2</span><br><span class="line">---------------</span><br><span class="line">[root@httpd1 ~]# yum install -y httpd</span><br><span class="line">[root@httpd1 ~]# systemctl start chronyd</span><br><span class="line">[root@httpd1 ~]# systemctl enable chronyd</span><br><span class="line">[root@httpd1 ~]# chronyc</span><br><span class="line">chrony version 3.1</span><br><span class="line">Copyright (C) 1997-2003, 2007, 2009-2017 Richard P. Curnow and others</span><br><span class="line">chrony comes with ABSOLUTELY NO WARRANTY.  This is free software, and</span><br><span class="line">you are welcome to redistribute it under certain conditions.  See the</span><br><span class="line">GNU General Public License version 2 for details.</span><br><span class="line"></span><br><span class="line"><span class="meta">chronyc&gt;</span><span class="bash"> waitsync </span></span><br><span class="line">try: 1, refid: 771CCEC1, correction: 0.000001078, skew: 32.010</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步时间</span></span><br><span class="line">[root@httpd1 ~]# vim /var/www/html/index.html</span><br><span class="line">Backend Server 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给两台服务器提供一个主面，另一台服务器的内容是Backend Server 2</span></span><br><span class="line">[root@httpd1 ~]# systemctl start httpd</span><br><span class="line">[root@httpd2 ~]# curl 172.16.106.144</span><br><span class="line">Backend Server 2</span><br><span class="line">[root@httpd2 ~]# curl 172.16.106.145</span><br><span class="line">Backend Server 1</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim /etc/rsyslog.conf</span><br><span class="line"><span class="meta">$</span><span class="bash">ModLoad imudp		<span class="comment"># 基于UDP收集日志</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">UDPServerRun 514		<span class="comment"># 监听端口</span></span></span><br><span class="line">local2.*                                                /var/log/haproxy.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入此行，设置haproxy的日志路径</span></span><br><span class="line">[root@haproxy haproxy]# systemctl restart rsyslog</span><br><span class="line">[root@haproxy ~]# cd /etc/haproxy/</span><br><span class="line">[root@haproxy haproxy]# cp haproxy.cfg&#123;,.bak&#125;</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">global</span><br><span class="line">   log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line">frontend  myweb		# 定义前端主机，取名叫myweb</span><br><span class="line">    bind *:80		# 定义haproxy的监听端口</span><br><span class="line">    default_backend             websrvs		# 定义默认使用的后端主机是websrvs</span><br><span class="line">backend websrvs			# 定义后端主机组叫websrvs</span><br><span class="line">    balance     roundrobin		# 使用轮询的方式</span><br><span class="line">    server      srv1 172.16.106.145:80 check</span><br><span class="line">    server      srv2 172.16.106.144:80 check</span><br><span class="line"><span class="meta">#</span><span class="bash"> 后端主机信息，使用server定义，srv1是haproxy内部引用的ID号，自定义的。它是服务器在haproxy上的内部名称；出现在日志及警告信息；check是对主机的健康检测，如果不加，那么会被认为是始终在线的。这是四层检测，发TCP请求，如果响应就表示在线</span></span><br><span class="line">[root@haproxy haproxy]# systemctl start haproxy</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl 192.168.1.25;done</span><br><span class="line">Backend Server 1</span><br><span class="line">Backend Server 2</span><br></pre></td></tr></table></figure>
<h3 id="first算法"><a href="#first算法" class="headerlink" title="first算法"></a>first算法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">根据服务器在列表中的位置，自上而下进行调度；前面服务器的连接数达到上限，新请求才会分配给下一台服务；</span><br><span class="line">==============================================================================================</span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     first</span><br><span class="line">    server      srv1 172.16.106.145:80 check maxconn 3		# maxconn指定最大并发连接数</span><br><span class="line">    server      srv2 172.16.106.144:80 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service </span><br><span class="line">[root@haproxy haproxy]# yum install -y httpd-tools</span><br><span class="line">[root@haproxy haproxy]# ab -n 100000 -c 10 http://192.168.1.25/index.html</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd2</span><br><span class="line">------------</span><br><span class="line">[root@httpd2 ~]# tail -f /var/log/httpd/access_log </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在第二台web服务器上查看日志，如果有请求日志，就说明第一台web服务器打满了</span></span><br></pre></td></tr></table></figure>
<h3 id="uri算法"><a href="#uri算法" class="headerlink" title="uri算法"></a>uri算法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">对URI的左半部分做hash计算，并由服务器总权重相除以后派发至某挑出的服务器；只要访问的是同一页面，不管是哪台主机，都发往同一台服务器</span><br><span class="line">==============================================================================================</span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     uri</span><br><span class="line">    server      srv1 172.16.106.145:80 check maxconn 3		# maxconn指定最大并发连接数</span><br><span class="line">    server      srv2 172.16.106.144:80 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service </span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">  httpd1&amp;2</span><br><span class="line">---------------</span><br><span class="line">[root@httpd2 ~]# for i in &#123;1..10&#125;;do echo "Test Page $i @BES 1" &gt; /var/www/html/test$i.html;done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在两台主机上分别添加主页</span></span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl http://192.168.1.25/test1.html;done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时显示的内容是一样的，因为请求被发到了同一台主机。另外可以换其他主机再访问，结果应该和这里一样，因为访问的都是同一页面</span></span><br></pre></td></tr></table></figure>
<h3 id="hdr算法"><a href="#hdr算法" class="headerlink" title="hdr算法"></a>hdr算法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">hdr(&lt;name&gt;)：对于每个http请求，此处由&lt;name&gt;指定的http首部将会被取出做hash计算，并由服务器总权重相除以后派发至某挑出的服务器，没有有效值的会被轮询调度。</span><br><span class="line">==============================================================================================</span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     hdr(User-Agent)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对客户端浏览器进行<span class="built_in">hash</span>计算并调度，如果浏览器一样就发往后端同一主机</span></span><br><span class="line">    server      srv1 172.16.106.145:80 check maxconn 3		# maxconn指定最大并发连接数</span><br><span class="line">    server      srv2 172.16.106.144:80 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl http://192.168.1.25/test1.html;done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时不管访问哪个页面，都会被发到同一台服务器处理，到哪台后端服务器是不能预测的</span></span><br></pre></td></tr></table></figure>
<h3 id="压缩测试"><a href="#压缩测试" class="headerlink" title="压缩测试"></a>压缩测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check maxconn 3</span><br><span class="line">    server      srv2 172.16.106.144:80 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# cp /var/log/httpd/access_log /var/www/html/log.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 找一个大一些的文件做压缩测试</span></span><br><span class="line">[root@httpd1 ~]# rsync -e ssh -arzv --progress /var/www/html/log.txt 172.16.106.144:/var/www/html/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将文件复制到另一台web服务器上</span></span><br><span class="line"></span><br><span class="line">用firefox访问192.168.1.77/log.txt，按F12，这时Response headers(响应头)中会有Content-Encoding gzip的显示</span><br></pre></td></tr></table></figure>
<h3 id="备用主机"><a href="#备用主机" class="headerlink" title="备用主机"></a>备用主机</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check </span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line"><span class="meta">#</span><span class="bash"> backup指备用主机，也就是sorryserver.</span></span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl http://192.168.1.25/index.html;done</span><br><span class="line">Backend Server 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时请求只会发到第一台web服务器上</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# systemctl stop httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止web服务</span></span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl http://192.168.1.25/index.html;done</span><br><span class="line">Backend Server 2</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# systemctl start httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动web服务后，所有的请求又都会发到httpd1上了</span></span><br></pre></td></tr></table></figure>
<h3 id="七层反向代理"><a href="#七层反向代理" class="headerlink" title="七层反向代理"></a>七层反向代理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    option httpchk</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2</span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 反向代理在四层还是七层取决于mode设置的是tcp还是http</span></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# tail -f /var/log/httpd/access_log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时这里会不停显示<span class="string">"172.16.106.143 - - [29/Jan/2019:09:54:16 +0800] "</span>OPTIONS / HTTP/1.0<span class="string">" 200 - "</span>-<span class="string">" "</span>-<span class="string">""</span>，这表示haproxy发出的健康检测请求，但这会产生大量无效日志</span></span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    option httpchk GET /index.html HTTP/1.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定使用GET方法，对/index.html检测，协议是HTTP/1.0</span></span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> inter是每隔多久检测一次，单位是毫秒；rise是检测几次就上线，fall检测几次就下线</span></span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# tail -f /var/log/httpd/access_log</span><br><span class="line">172.16.106.143 - - [29/Jan/2019:09:57:45 +0800] "GET /index.html HTTP/1.0" 200 17 "-" "-"</span><br></pre></td></tr></table></figure>
<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    option httpchk GET /index.html HTTP/1.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定使用GET方法，对/index.html检测，协议是HTTP/1.0</span></span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 redir http://www.baidu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> redir &lt;prefix&gt;：将发往此server的所有GET和HEAD类的请求重定向至指定的URL</span></span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">访问192.168.1.25时会被转到百度首页</span><br></pre></td></tr></table></figure>
<h3 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用weight定义权重</span></span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl http://192.168.1.25/index.html;done</span><br><span class="line">Backend Server 1</span><br><span class="line">Backend Server 1</span><br><span class="line">Backend Server 2</span><br></pre></td></tr></table></figure>
<h3 id="状态页"><a href="#状态页" class="headerlink" title="状态页"></a>状态页</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    stats enable</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 </span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">访问192.168.1.25/haproxy?stats，如果设置中没有用stats uri指定页面地址，/haproxy?stats是默认的页面。页面中会用颜色标记后端主机，配置文件中的第二个server是backup，不同状态主机用不同颜色标识。停掉第一台web服务器的服务，颜色也会改变</span><br></pre></td></tr></table></figure>
<h3 id="自定义状态页uri"><a href="#自定义状态页uri" class="headerlink" title="自定义状态页uri"></a>自定义状态页uri</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin		# 自定义状态页uri</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 </span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">访问http://192.168.1.25/myproxy?admin</span><br></pre></td></tr></table></figure>
<h3 id="登录状态页认证"><a href="#登录状态页认证" class="headerlink" title="登录状态页认证"></a>登录状态页认证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin		# 自定义状态页uri</span><br><span class="line">    stats realm "HAProxy Stats Page"		# 设置登录认证时弹出的信息。测试中此项未起作用</span><br><span class="line">    stats auth admin:centos		# 设置认证的用户名和密码</span><br><span class="line">    stats admin if TRUE		# 启用页面的管理功能，if TRUE表示一直为真，总是可以访问，生产中不能这样使用</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 </span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">访问http://192.168.1.25/myproxy?admin，打开页面的管理功能后，可以页面进行一些简单操作</span><br></pre></td></tr></table></figure>
<h3 id="自定义状态页面的端口"><a href="#自定义状态页面的端口" class="headerlink" title="自定义状态页面的端口"></a>自定义状态页面的端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2</span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1</span><br><span class="line">listen stats		# listen可以同时拥前端和后端，将前端与后端绑定在一起。主要配置与监控相关的信息。</span><br><span class="line">    bind *:9099</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在这里定义listen，名字叫stats，之后用<span class="built_in">bind</span>指定状态页的端口，打开相应功能。与上面一样实现了状态页功能，只是这里又定义了状态页的端口</span></span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">访问http://192.168.1.25:9099/myproxy?admin</span><br></pre></td></tr></table></figure>
<h3 id="代理ssh"><a href="#代理ssh" class="headerlink" title="代理ssh"></a>代理ssh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2</span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1</span><br><span class="line">listen stats</span><br><span class="line">    bind *:9099</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">listen sshsrvs</span><br><span class="line">    mode tcp</span><br><span class="line">    bind *:22322</span><br><span class="line">    balance leastconn</span><br><span class="line">    server sshsrv1 172.16.106.145:22 check</span><br><span class="line">    server sshsrv2 172.16.106.144:22 check</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再添加一个listen，用mode指定在tcp层(四层)实现代理。监听在22322端口，leastconn算法表示加权最少连接，最少连接的接收请求，建议使用在支持长连接的会话中。这个算法也是动态的</span></span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]#ssh 192.168.1.25 -p 22322</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接了两次，分别连接到了两台httpd上</span></span><br></pre></td></tr></table></figure>
<h3 id="cookie粘性绑定"><a href="#cookie粘性绑定" class="headerlink" title="cookie粘性绑定"></a>cookie粘性绑定</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">	cookie SRV insert indirect nocache</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2 cookie srv1</span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1 cookie srv1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入cookie的键名，server最后的cookie是其值，cookie的值最好和server的名字一致。当用户访问时，如果被调度到第一台web服务器上，用户的cookie中会加入cookie的键和值在开头，这里就是SRV=srv1，当用户再次访问时，这个cookie的键和值也会到haproxy服务器，这时haproxy就知道上次这个用户的请求被调度到哪台服务器上，这次还会调度到同一台服务器上。insert表示信息数据的插入方式，上面表示仅对indirect和nocache这样的数据拷入cookie</span></span><br><span class="line">listen stats</span><br><span class="line">    bind *:9099</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">listen sshsrvs</span><br><span class="line">    mode tcp</span><br><span class="line">    bind *:22322</span><br><span class="line">    balance leastconn</span><br><span class="line">    server sshsrv1 172.16.106.145:22 check</span><br><span class="line">    server sshsrv2 172.16.106.144:22 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">用浏览器访问192.168.1.25，访问多次也不会有变化</span><br></pre></td></tr></table></figure>
<h3 id="让后端主机收到的请求地址是源地址"><a href="#让后端主机收到的请求地址是源地址" class="headerlink" title="让后端主机收到的请求地址是源地址"></a>让后端主机收到的请求地址是源地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">defaults</span><br><span class="line">    option forwardfor       except 127.0.0.0/8 if-none</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此项是原本就有的，forwardfor表示对请求加入一个首部，得到后端服务器真正的请求地址。except表示除了，这里表示除了本机127地址发出的请求，其他请求都加入首部。<span class="keyword">if</span>-none表示如果没有首部才添加</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# vim /etc/httpd/conf/httpd.conf</span><br><span class="line">LogFormat "%&#123;X-Forwarded-For&#125;i %h %l %u %t \"%r\" %&gt;s %b \"%&#123;Referer&#125;i\" \"%&#123;Use</span><br><span class="line">r-Agent&#125;i\"" combined</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将%h改为%&#123;X-Forwarded-For&#125;i，X-Forwarded-For是haproxy中forwardfor默认的格式</span></span><br><span class="line">[root@httpd1 ~]# systemctl restart httpd</span><br><span class="line">[root@httpd1 ~]# tail -f /var/log/httpd/access_log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次访问192.168.1.25时，查看web服务器日志，可以看到客户端的请求IP地址，而不再是haproxy的内网地址了。</span></span><br></pre></td></tr></table></figure>
<h3 id="添加首部"><a href="#添加首部" class="headerlink" title="添加首部"></a>添加首部</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    reqadd X-Proxy-By:\ HAProxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加请求报文首部，\是转义符，转义后面的空格。X-Proxy-By:\ HAProxy都是自定义的名称，表示这个服务器是由Haproxy代理的</span></span><br><span class="line">    rspadd X-Proxy-By:\ HAProxy-1.5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加响应首部</span></span><br><span class="line">    rspidel ^Server:.*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除响应报文中Server开头的所有内容</span></span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">	cookie SRV insert indirect nocache</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2 cookie srv1</span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1 cookie srv1</span><br><span class="line">listen stats</span><br><span class="line">    bind *:9099</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">listen sshsrvs</span><br><span class="line">    mode tcp</span><br><span class="line">    bind *:22322</span><br><span class="line">    balance leastconn</span><br><span class="line">    server sshsrv1 172.16.106.145:22 check</span><br><span class="line">    server sshsrv2 172.16.106.144:22 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# vim /etc/httpd/conf/httpd.conf</span><br><span class="line">LogFormat "%&#123;X-Forwarded-For&#125;i %l %u %t \"%r\" %&gt;s %b \"%&#123;Referer&#125;i\" \"%&#123;User-A</span><br><span class="line">gent&#125;i %&#123;X-Proxy-By&#125;i\"" combined</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将请求首部加到最后</span></span><br><span class="line">[root@httpd1 ~]# systemctl restart httpd</span><br><span class="line">[root@httpd1 ~]# tail -f /var/log/httpd/access_log</span><br><span class="line">192.168.1.9 - - [29/Jan/2019:11:13:52 +0800] "GET / HTTP/1.1" 304 - "-" "Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0 HAProxy"</span><br><span class="line">访问192.168.1.25，并查看日志，可以看到请求首部HAProxy</span><br><span class="line">在浏览器上按F12可以看到响应首部，在Response headers中有X-Proxy-By: HAProxy-1.5</span><br></pre></td></tr></table></figure>
<h3 id="acl访问控制"><a href="#acl访问控制" class="headerlink" title="acl访问控制"></a>acl访问控制</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    reqadd X-Proxy-By:\ HAProxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加请求报文首部，\是转义符，转义后面的空格。X-Proxy-By:\ HAProxy都是自定义的名称，表示这个服务器是由Haproxy代理的</span></span><br><span class="line">    rspadd X-Proxy-By:\ HAProxy-1.5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加响应首部</span></span><br><span class="line">    rspidel ^Server:.*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除响应报文中Server开头的所有内容</span></span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">	cookie SRV insert indirect nocache</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2 cookie srv1</span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1 cookie srv1</span><br><span class="line">listen stats</span><br><span class="line">    bind *:9099</span><br><span class="line">    acl allowstats src 192.168.1.9</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义acl名字是allowstats，只允许源地址是192.168.1.64的地址来访问</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> acl all src 0.0.0.0/0.0.0.0表示设置acl为所有主机地址</span></span><br><span class="line">    block if ! allowstats</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义除allowstats以外的任何主机不能访问，!是取反的。如果没有!号，表示除了allowstats外的主机都能访问。block是阻塞之意。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http-request allow <span class="keyword">if</span> allowstats表示允许allowstats的主机访问，这样所有主机都能访问了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http-request deny <span class="keyword">if</span> all：不允许除allowstats外的其他主机访问</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 先要自定义一个acl，之后用http-request指定，这样可以实现除了allowstats外的其他主机都不能访问</span></span><br><span class="line">==============================================================================================</span><br><span class="line">	acl allowstats src 192.168.1.9</span><br><span class="line">    http-request allow if allowstats</span><br><span class="line">    errorfile 403 /etc/haproxy/errorfiles/403forbid.http</span><br><span class="line">    acl all src 0.0.0.0/0.0.0.0</span><br><span class="line">    http-request deny if all</span><br><span class="line"><span class="meta">#</span><span class="bash">上面可以设置为这样，结果是只有192.168.1.9可以访问状态页，其他主机不可访问。要注意acl与http-request要定义在一起，如果将http-request allow放在http-request deny下面，也会使所有主机都不能访问状态页</span></span><br><span class="line">==============================================================================================</span><br><span class="line">    errorloc 403 http://192.168.1.25:10080/errorloc/403.html</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里不能定义errorfile，因为上面已经拒绝本机访问了，也就是本机不能访问http://192.168.1.25</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里也可以使用errorfile 403 /etc/haproxy/errorfiles/403forbid.http，之后创建/etc/haproxy/errorfiles/403forbid.http，当无权访问时，就会提示错误页的内容。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> errorfile &lt;code&gt; &lt;file&gt;：在用户请求不存在的页面时，返回一个页面文件给客户端而非由haproxy生成的错误代码；可用于所有段中。&lt;code&gt;：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有200、400、403、408、500、502、503和504；&lt;file&gt;：指定用于响应的页面文件；</span></span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">listen sshsrvs</span><br><span class="line">    mode tcp</span><br><span class="line">    bind *:22322</span><br><span class="line">    balance leastconn</span><br><span class="line">    server sshsrv1 172.16.106.145:22 check</span><br><span class="line">    server sshsrv2 172.16.106.144:22 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]# yum install -y nginx</span><br><span class="line">[root@haproxy haproxy]# vim /etc/nginx/conf.d/errorsrv.conf</span><br><span class="line">server &#123;</span><br><span class="line">   listen 10080;</span><br><span class="line">   server_name 192.168.1.25;</span><br><span class="line">   root /data/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy haproxy]# mkdir -pv /data/nginx/html/errorloc</span><br><span class="line">[root@haproxy haproxy]# vim /data/nginx/html/errorloc/403.html</span><br><span class="line">403 Forbidden from nginx </span><br><span class="line">[root@haproxy haproxy]# systemctl start nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用nginx提供一个haproxy的错误页</span></span><br><span class="line">[root@haproxy haproxy]# curl --basic --user admin:centos http://192.168.1.25:9099/myproxy?admin/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用curl命令访问，基于basic认证，用户名和密码用--user指定</span></span><br><span class="line"></span><br><span class="line">使用一台新主机访问http://192.168.1.25:9099/myproxy?admin，因为此主机的地址不是192.168.1.9，所以返回nginx提供的错误页内容：403 Forbidden from nginx。</span><br></pre></td></tr></table></figure>
<h3 id="后端主机动静分离"><a href="#后端主机动静分离" class="headerlink" title="后端主机动静分离"></a>后端主机动静分离</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">后端两台web服务器，一台配置为两个虚拟主机，支持动态服务。另一台也配置为两台虚拟主机，支持静态服务。静态服务当图片服务器</span><br><span class="line">==============================================================================================</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 network-scripts]# yum install -y php</span><br><span class="line">[root@httpd1 ~]# mkdir -pv /data/web/vhost&#123;1,2&#125;</span><br><span class="line">[root@httpd1 ~]# vim /data/web/vhost1/info.php</span><br><span class="line">&lt;h1&gt;Application Server 1&lt;/h1&gt;		#vhost2中将此处改为Application Server 2</span><br><span class="line">&lt;?php</span><br><span class="line">   phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line">[root@httpd1 ~]# cp /data/web/vhost&#123;1,2&#125;/info.php</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将vhost1中的info.php复制到vhost2中</span></span><br><span class="line">[root@httpd1 ~]# vim /etc/httpd/conf.d/vhost1.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www1.test.com</span><br><span class="line">   DocumentRoot "/data/web/vhost1"</span><br><span class="line">   &lt;Directory "/data/web/vhost1"&gt;</span><br><span class="line">      options FollowSymLinks</span><br><span class="line">      AllowOverride None</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@httpd1 ~]# cp /etc/httpd/conf.d/vhost&#123;1,2&#125;.conf</span><br><span class="line">[root@httpd1 ~]# vim /etc/httpd/conf.d/vhost2.conf</span><br><span class="line">Listen 8080</span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">   ServerName www2.test.com</span><br><span class="line">   DocumentRoot "/data/web/vhost2"</span><br><span class="line">   &lt;Directory "/data/web/vhost2"&gt;</span><br><span class="line">      options FollowSymLinks</span><br><span class="line">      AllowOverride None</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@httpd1 ~]# httpd -t</span><br><span class="line">[root@httpd1 ~]# systemctl restart httpd</span><br><span class="line">访问http://172.16.106.145/info.php，http://172.16.106.145:8080/info.php可以看到php页面</span><br><span class="line">[root@httpd1 ~]# scp /etc/httpd/conf.d/vhost* 172.16.106.144:/etc/httpd/conf.d/</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd2</span><br><span class="line">------------</span><br><span class="line">[root@httpd2 ~]# mkdir -pv /data/web/vhost&#123;1,2&#125;</span><br><span class="line">[root@httpd2 vhost1]# find /usr/share -iname "*.jpg" -exec cp &#123;&#125; /data/web/vhost1/ \;</span><br><span class="line">[root@httpd2 vhost1]# find /usr/share -iname "*.jpg" -exec cp &#123;&#125; /data/web/vhost2/ \;</span><br><span class="line">[root@httpd2 ~]# vim /data/web/vhost1/test.txt</span><br><span class="line">Image Server 1</span><br><span class="line">[root@httpd2 ~]# vim /data/web/vhost2/test.txt</span><br><span class="line">Image Server 2</span><br><span class="line">[root@httpd2 ~]# systemctl restart httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里已有从httpd1上复制过来的配置文件</span></span><br><span class="line">访问http://172.16.106.144/test.txt，http://172.16.106.144:8080/test.txt</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    acl static path_end .jpg .jpeg .png .gif .txt .html .css .javascript .js</span><br><span class="line"><span class="meta">#</span><span class="bash"> path_end表示以什么结尾的。请求时，一定要写明后缀，如curl 192.168.1.25/index.html，不然请求都会被代理到动态服务器上。因为设置了默认是发给动态服务器，而且动态服务器设置了cookie粘性绑定，信息是不会变的</span></span><br><span class="line">    acl static path_beg /imgs /images /css /javascripts</span><br><span class="line"><span class="meta">#</span><span class="bash"> path_beg定义以什么开头。两个acl可以一起使用</span></span><br><span class="line">    use_backend staticsrvs if static</span><br><span class="line"><span class="meta">#</span><span class="bash"> use_backend表示当符合指定的条件时使用特定的backend。这表示如果访问的内容是以acl中定义的结尾的静态内容，就给后端的staticsrvs主机。否则就给下面default定义的动态主机</span></span><br><span class="line">	default_backend dynsrvs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认主机组</span></span><br><span class="line">    reqadd X-Proxy-By:\ HAProxy</span><br><span class="line">    rspadd X-Proxy-By:\ HAProxy-1.5</span><br><span class="line">    rspidel ^Server:.*</span><br><span class="line">backend dynsrvs</span><br><span class="line">    cookie SRV insert indirect nocache</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2 cookie dynsrv1</span><br><span class="line">    server      srv2 172.16.106.145:8080 check weight 1 cookie dynsrv2</span><br><span class="line">backend staticsrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.144:80 check</span><br><span class="line">    server      srv2 172.16.106.144:8080 check</span><br><span class="line">listen stats</span><br><span class="line">    bind *:9099</span><br><span class="line">    acl allowstats src 192.168.1.9</span><br><span class="line">    block if ! allowstats</span><br><span class="line">    errorloc 403 http://192.168.1.25:10080/errorloc/403.htm</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">listen sshsrvs</span><br><span class="line">    mode tcp</span><br><span class="line">    bind *:22322</span><br><span class="line">    balance leastconn</span><br><span class="line">    server sshsrv1 172.16.106.145:22 check</span><br><span class="line">    server sshsrv2 172.16.106.144:22 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">访问状态页192.168.1.25:9099/myproxy?admin</span><br><span class="line">访问192.168.1.25/info.php，因为cookie绑定了，所以内容不会变</span><br><span class="line">访问192.168.1.25/test.txt，多次访问会有变化</span><br></pre></td></tr></table></figure>
<h3 id="阻塞curl工具访问"><a href="#阻塞curl工具访问" class="headerlink" title="阻塞curl工具访问"></a>阻塞curl工具访问</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">	acl bad_browsers hdr_reg(User-Agent) .*curl.*</span><br><span class="line">    block if bad_browsers</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入上面两条，定义acl，用hdr_reg，直接匹配用户请求报文中的首部，下面使用block拒绝acl设置的客户端访问</span></span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]# curl http://192.168.1.25</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;</span><br><span class="line">Request forbidden by administrative rules.</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="阻塞域访问"><a href="#阻塞域访问" class="headerlink" title="阻塞域访问"></a>阻塞域访问</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">	acl valid_referers hdr_reg(Referer) \.ruopu\.com.*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用hdr_reg，匹配Referer，匹配来自ruopu.com的任何值</span></span><br><span class="line">    block unless valid_referers</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不是上面定义的值就拒绝</span></span><br><span class="line">[root@haproxy haproxy]# curl -e "http://www.ruopu.com/admin.php" http://192.168.1.25/test2.html</span><br><span class="line">Test Page 2 @BES 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用-e模拟一个Referer，这样就能返回值了</span></span><br><span class="line">[root@haproxy haproxy]# curl http://192.168.1.25/test2.html</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;</span><br><span class="line">Request forbidden by administrative rules.</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 直接访问是没有权限的</span></span><br></pre></td></tr></table></figure>
<h3 id="SSL功能"><a href="#SSL功能" class="headerlink" title="SSL功能"></a>SSL功能</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend https</span><br><span class="line">    bind *:443 ssl crt /etc/haproxy/certs/haproxy.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义用ssl协议，crt指明密钥的路径</span></span><br><span class="line">    acl static path_end .jpg .jpeg .png .gif .txt .html .css .javascript .js</span><br><span class="line">    acl static path_beg /imgs /images /css /javascripts</span><br><span class="line">    use_backend staticsrvs if static</span><br><span class="line">    default_backend dynsrvs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 与上面一样，如果是特定结尾或开头的就转到静态页，不是的就转到动态页</span></span><br><span class="line"></span><br><span class="line">frontend  http   *:80</span><br><span class="line">    redirect scheme https if ! &#123; ssl_fc &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> redirect即为重定向之意。scheme指协议，ssl_fc指非ssl会话的前端链接。这是定义，如果不是https协议的非前端会话，都转到https443端口上。</span></span><br><span class="line">[root@haproxy certs]# mkdir /etc/haproxy/certs</span><br><span class="line">[root@haproxy certs]# cd /etc/pki/CA</span><br><span class="line">[root@haproxy certs]# (umask 077;openssl genrsa -out private/cakey.pem 4096)</span><br><span class="line">[root@haproxy certs]# openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 365</span><br><span class="line">[root@haproxy certs]# touch index.txt</span><br><span class="line">[root@haproxy certs]# echo 01 &gt; serial</span><br><span class="line">[root@haproxy certs]# cd /etc/haproxy/certs/</span><br><span class="line">[root@haproxy certs]# openssl genrsa -out haproxy.key 2048</span><br><span class="line">[root@haproxy certs]# openssl req -new -key haproxy.key -out haproxy.csr</span><br><span class="line">[root@haproxy certs]# openssl ca -in haproxy.csr -out haproxy.crt</span><br><span class="line">[root@haproxy certs]# cat haproxy.crt haproxy.key &gt; haproxy.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将两个文件打包成pem文件</span></span><br><span class="line">[root@haproxy certs]# chmod 600 haproxy.pem</span><br><span class="line">[root@haproxy certs]# systemctl restart haproxy</span><br><span class="line">[root@haproxy certs]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时应该有443和8080端口被监听</span></span><br><span class="line"></span><br><span class="line">访问https://192.168.1.25/test.txt</span><br><span class="line">访问http://192.168.1.25/test.txt，访问会被重定向到https</span><br><span class="line"></span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  http   *:80</span><br><span class="line">    redirect location https://192.168.1.25 if ! &#123; ssl_fc &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置所有请求都重定向到https://172.16.0.67</span></span><br><span class="line"></span><br><span class="line">访问http://192.168.1.25/test.txt，这会重定向到https://172.16.0.67。不论访问什么页面，都会重定向到https://172.16.0.67</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/28/LVS部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/28/LVS部署/" itemprop="url">
                  LVS部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-28 18:18:42 / 修改時間：22:25:44" itemprop="dateCreated datePublished" datetime="2019-01-28T18:18:42+08:00">2019-01-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/balance/" itemprop="url" rel="index"><span itemprop="name">balance</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><blockquote>
<p>LVS是 Linux Virtual Server 的简称，也就是Linux虚拟服务器。这是一个由章文嵩博士发起的一个开源项目，它的官方网是 <a href="http://www.linuxvirtualserver.org" target="_blank" rel="noopener">http://www.linuxvirtualserver.org</a> 现在 LVS 已经是 Linux 内核标准的一部分。使用 LVS 可以达到的技术目标是：通过 LVS 达到的负载均衡技术和 Linux 操作系统实现一个高性能高可用的 Linux 服务器集群，它具有良好的可靠性、可扩展性和可操作性。从而以低廉的成本实现最优的性能。LVS 是一个实现负载均衡集群的开源软件项目，LVS架构从逻辑上可分为调度层、Server集群层和共享存储。</p>
</blockquote>
<h3 id="LVS的基本工作原理"><a href="#LVS的基本工作原理" class="headerlink" title="LVS的基本工作原理"></a>LVS的基本工作原理</h3><p><img src="/images/lvs/基本工作原理.png" alt=""></p>
<blockquote>
<ol>
<li><p>当用户向负载均衡调度器（Director Server）发起请求时，调度器将请求发往至内核空间</p>
</li>
<li><p>PREROUTING链首先会接收到用户请求，判断目标IP确定是本机IP，将数据包发往INPUT链</p>
</li>
<li><p>IPVS是工作在INPUT链上的，当用户请求到达INPUT时，IPVS会将用户请求和自己已定义好的集群服务进行比对，如果用户请求的就是定义的集群服务，那么此时IPVS会强行修改数据包里的目标IP地址及端口，并将新的数据包发往POSTROUTING链</p>
</li>
<li><p>POSTROUTING链接收数据包后发现目标IP地址刚好是自己的后端服务器，那么此时通过选路，将数据包最终发送给后端的服务器</p>
</li>
</ol>
</blockquote>
<h3 id="LVS的组成"><a href="#LVS的组成" class="headerlink" title="LVS的组成"></a>LVS的组成</h3><blockquote>
<p>LVS 由两部分程序组成，包括 ipvs 和 ipvsadm。</p>
<ol>
<li><p>ipvs(ip virtual server)：一段代码工作在内核空间，叫ipvs，是真正生效实现调度的代码。</p>
</li>
<li><p>ipvsadm：在用户空间，负责为ipvs内核框架编写规则，定义谁是集群服务，而谁是后端真实的服务器(Real Server)</p>
</li>
</ol>
</blockquote>
<h3 id="LVS相关术语"><a href="#LVS相关术语" class="headerlink" title="LVS相关术语"></a>LVS相关术语</h3><blockquote>
<ol>
<li>DS：Director Server。前端负载均衡器节点。</li>
<li>RS：Real Server。后端真实的工作服务器。</li>
<li>VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址。</li>
<li>DIP：Director Server IP，前端负载均衡器节点上用于和内部主机通讯的IP地址。</li>
<li>RIP：Real Server IP，后端服务器的IP地址。</li>
<li>CIP：Client IP，访问客户端的IP地址。</li>
</ol>
</blockquote>
<h3 id="LVS-NAT原理和特点"><a href="#LVS-NAT原理和特点" class="headerlink" title="LVS/NAT原理和特点"></a>LVS/NAT原理和特点</h3><p><img src="/images/lvs/nat原理.png" alt=""></p>
<blockquote>
<ol>
<li>当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP</li>
<li>PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</li>
<li>IPVS比对数据包请求的服务是否为集群服务，若是，修改数据包的目标IP地址为后端服务器IP，然后将数据包发至POSTROUTING链。 此时报文的源IP为CIP，目标IP为RIP</li>
<li>POSTROUTING链通过选路，将数据包发送给Real Server</li>
<li>Real Server比对发现目标为自己的IP，开始构建响应报文发回给Director Server。 此时报文的源IP为RIP，目标IP为CIP</li>
<li>Director Server在响应客户端前，此时会将源IP地址修改为自己的VIP地址，然后响应给客户端。 此时报文的源IP为VIP，目标IP为CIP</li>
</ol>
</blockquote>
<h4 id="LVS-NAT模型的特性"><a href="#LVS-NAT模型的特性" class="headerlink" title="LVS-NAT模型的特性"></a>LVS-NAT模型的特性</h4><blockquote>
<ol>
<li>RS应该使用私有地址，RS的网关必须指向DIP</li>
<li>DIP和RIP必须在同一个网段内</li>
<li>请求和响应报文都需要经过Director Server，高负载场景中，Director Server易成为性能瓶颈<br>支持端口映射</li>
<li>RS可以使用任意操作系统</li>
<li>缺陷：对Director Server压力会比较大，请求和响应都需经过director server</li>
</ol>
</blockquote>
<h3 id="LVS-DR原理和特点"><a href="#LVS-DR原理和特点" class="headerlink" title="LVS/DR原理和特点"></a>LVS/DR原理和特点</h3><p><img src="/images/lvs/dr原理.png" alt=""></p>
<blockquote>
<ol>
<li>当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP</li>
<li>PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</li>
<li>IPVS比对数据包请求的服务是否为集群服务，若是，将请求报文中的源MAC地址修改为DIP的MAC地址，将目标MAC地址修改RIP的MAC地址，然后将数据包发至POSTROUTING链。 此时的源IP和目的IP均未修改，仅修改了源MAC地址为DIP的MAC地址，目标MAC地址为RIP的MAC地址</li>
<li>由于DS和RS在同一个网络中，所以是通过二层来传输。POSTROUTING链检查目标MAC地址为RIP的MAC地址，那么此时数据包将会发至Real Server。</li>
<li>RS发现请求报文的MAC地址是自己的MAC地址，就接收此报文。处理完成之后，将响应报文通过lo接口传送给eth0网卡然后向外发出。 此时的源IP地址为VIP，目标IP为CIP</li>
<li>响应报文最终送达至客户端</li>
</ol>
</blockquote>
<h4 id="LVS-DR模型的特性"><a href="#LVS-DR模型的特性" class="headerlink" title="LVS-DR模型的特性"></a>LVS-DR模型的特性</h4><blockquote>
<p>特点</p>
<ol>
<li>保证前端路由将目标地址为VIP报文统统发给Director Server，而不是RS</li>
<li>RS可以使用私有地址；也可以是公网地址，如果使用公网地址，此时可以通过互联网对RIP进行直接访问</li>
<li>RS和Director Server必须在同一个物理网络中</li>
<li>所有的请求报文经由Director Server，但响应报文必须不能经过Director Server</li>
<li>不支持地址转换，也不支持端口映射</li>
<li>RS可以是大多数常见的操作系统</li>
<li>RS的网关绝不允许指向DIP(因为我们不允许他经过director)</li>
<li>RS上的lo接口配置VIP的IP地址</li>
<li>缺陷：RS和DS必须在同一机房中</li>
<li>企业中最常用的是 DR 模型</li>
</ol>
<p>解决</p>
<ol>
<li>在前端路由器做静态地址路由绑定，将对于VIP的地址仅路由到Director Server。但用户未必有路由操作权限，因为有可能是运营商提供的，所以这个方法未必实用</li>
<li>arptables：在arp的层次上实现在ARP解析时做防火墙规则，过滤RS响应ARP请求。这是由iptables提供的。修改RS上内核参数（arp_ignore和arp_announce），将RS上的VIP配置在lo接口的别名上，并限制其不能响应对VIP地址解析请求。</li>
</ol>
</blockquote>
<h3 id="LVS-Tun原理和特点"><a href="#LVS-Tun原理和特点" class="headerlink" title="LVS/Tun原理和特点"></a>LVS/Tun原理和特点</h3><p><img src="/images/lvs/tun原理.png" alt=""></p>
<blockquote>
<ol>
<li>当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP 。</li>
<li>PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</li>
<li>IPVS比对数据包请求的服务是否为集群服务，若是，在请求报文的首部再次封装一层IP报文，封装源IP为为DIP，目标IP为RIP。然后发至POSTROUTING链。 此时源IP为DIP，目标IP为RIP</li>
<li>POSTROUTING链根据最新封装的IP报文，将数据包发至RS（因为在外层封装多了一层IP首部，所以可以理解为此时通过隧道传输）。 此时源IP为DIP，目标IP为RIP</li>
<li>RS接收到报文后发现是自己的IP地址，就将报文接收下来，拆除掉最外层的IP后，会发现里面还有一层IP首部，而且目标是自己的lo接口VIP，那么此时RS开始处理此请求，处理完成之后，通过lo接口送给eth0网卡，然后向外传递。 此时的源IP地址为VIP，目标IP为CIP</li>
<li>响应报文最终送达至客户端</li>
</ol>
</blockquote>
<h4 id="LVS-Tun模型特性"><a href="#LVS-Tun模型特性" class="headerlink" title="LVS-Tun模型特性"></a>LVS-Tun模型特性</h4><blockquote>
<ol>
<li>RIP、VIP、DIP全是公网地址</li>
<li>RS的网关不会也不可能指向DIP</li>
<li>所有的请求报文经由Director Server，但响应报文必须不能进过Director Server</li>
<li>不支持端口映射</li>
<li>RS的系统必须支持隧道</li>
</ol>
</blockquote>
<h3 id="LVS的八种调度算法"><a href="#LVS的八种调度算法" class="headerlink" title="LVS的八种调度算法"></a>LVS的八种调度算法</h3><h4 id="轮叫调度-rr"><a href="#轮叫调度-rr" class="headerlink" title="轮叫调度 rr"></a>轮叫调度 rr</h4><blockquote>
<p>这种算法是最简单的，就是依次将请求调度到不同的服务器上，该算法最大的特点就是简单。轮询算法假设所有的服务器处理请求的能力都是一样的，调度器会将所有的请求平均分配给每个真实服务器，不管后端 RS 配置和处理能力，非常均衡地分发下去。</p>
</blockquote>
<h4 id="加权轮叫-wrr"><a href="#加权轮叫-wrr" class="headerlink" title="加权轮叫 wrr"></a>加权轮叫 wrr</h4><blockquote>
<p>这种算法比 rr 的算法多了一个权重的概念，可以给 RS 设置权重，权重越高，那么分发的请求数越多，权重的取值范围 0 – 100。主要是对rr算法的一种优化和补充， LVS 会考虑每台服务器的性能，并给每台服务器添加权值，如果服务器A的权值为1，服务器B的权值为2，则调度到服务器B的请求会是服务器A的2倍。权值越高的服务器，处理的请求越多。</p>
</blockquote>
<h4 id="最少链接-lc"><a href="#最少链接-lc" class="headerlink" title="最少链接 lc"></a>最少链接 lc</h4><blockquote>
<p>这个算法会根据后端 RS 的连接数来决定把请求分发给谁，比如 RS1 连接数比 RS2 连接数少，那么请求就优先发给 RS1</p>
</blockquote>
<h4 id="加权最少链接-wlc"><a href="#加权最少链接-wlc" class="headerlink" title="加权最少链接 wlc"></a>加权最少链接 wlc</h4><blockquote>
<p>这个算法比 lc 多了一个权重的概念。</p>
</blockquote>
<h4 id="基于局部性的最少连接调度算法-lblc"><a href="#基于局部性的最少连接调度算法-lblc" class="headerlink" title="基于局部性的最少连接调度算法 lblc"></a>基于局部性的最少连接调度算法 lblc</h4><blockquote>
<p>这个算法是请求数据包的目标 IP 地址的一种调度算法，该算法先根据请求的目标 IP 地址寻找最近的该目标 IP 地址所有使用的服务器，如果这台服务器依然可用，并且有能力处理该请求，调度器会尽量选择相同的服务器，否则会继续选择其它可行的服务器</p>
</blockquote>
<h4 id="复杂的基于局部性最少的连接算法-lblcr"><a href="#复杂的基于局部性最少的连接算法-lblcr" class="headerlink" title="复杂的基于局部性最少的连接算法 lblcr"></a>复杂的基于局部性最少的连接算法 lblcr</h4><blockquote>
<p>记录的不是目标 IP 与一台服务器之间的连接记录，而是维护一个目标 IP 到一组服务器之间的映射关系，防止单点服务器负载过高。</p>
</blockquote>
<p>#### </p>
<h4 id="目标地址散列调度算法-dh"><a href="#目标地址散列调度算法-dh" class="headerlink" title="目标地址散列调度算法 dh"></a>目标地址散列调度算法 dh</h4><blockquote>
<p>该算法是根据目标 IP 地址通过散列函数将目标 IP 与服务器建立映射关系，出现服务器不可用或负载过高的情况下，发往该目标 IP 的请求会固定发给该服务器。</p>
</blockquote>
<h4 id="源地址散列调度算法-sh"><a href="#源地址散列调度算法-sh" class="headerlink" title="源地址散列调度算法 sh"></a>源地址散列调度算法 sh</h4><blockquote>
<p>与目标地址散列调度算法类似，但它是根据源地址散列算法进行静态分配固定的服务器资源。</p>
</blockquote>
<h3 id="部署LVS-NAT模型"><a href="#部署LVS-NAT模型" class="headerlink" title="部署LVS/NAT模型"></a>部署LVS/NAT模型</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">环境</span><br><span class="line">准备三台主机</span><br><span class="line">director：外网地址：192.168.1.26；内网地址：172.16.106.140</span><br><span class="line">realServer1：内网地址：172.16.106.142</span><br><span class="line">realServer2：内网地址：172.16.106.141</span><br><span class="line">==============================================================================================</span><br><span class="line">---------------------</span><br><span class="line">  realServer1&amp;2</span><br><span class="line">---------------------</span><br><span class="line">[root@realserver1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">IPADDR=172.16.106.142</span><br><span class="line"><span class="meta">#</span><span class="bash"> realServer2主机的地址为172.16.106.141</span></span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=172.16.106.140</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置两台realServer主机的地址为静态地址，并将网关指向director的内网地址。</span></span><br><span class="line">[root@realserver2 ~]# yum install -y nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 两台主机需要安装nginx，可以临时添加dirctor的防火墙规则，iptables -t nat -A POSTROUTING -s 172.16.106.0/24 -j SNAT --to-source 192.168.1.26，并开启路由转发功能，<span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward，最后为realServer配置DNS。这样realServer就可以连接外网了。安装nginx后再取消director的防火墙规则。</span></span><br><span class="line">[root@realserver1 ~]# mkdir /usr/share/nginx/html/test</span><br><span class="line">[root@realserver1 ~]# vim /usr/share/nginx/html/test/index.html</span><br><span class="line">	realServer1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在两台主机上添加主面测试文件，一个是realServer1，一个是realServer2</span></span><br><span class="line">[root@realserver1 ~]# systemctl start nginx</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  Director</span><br><span class="line">--------------</span><br><span class="line">[root@director ~]# yum install -y ipvsadm</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/all/send_redirects</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/default/send_redirects</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/send_redirects</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/eth1/send_redirects</span><br><span class="line">[root@director ~]# ipvsadm -A -t 192.168.1.26:80 -s wrr</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.1.26:80 -r 172.16.106.142:80 -m -w 1</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.1.26:80 -r 172.16.106.141:80 -m -w 1</span><br><span class="line">[root@director ~]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  192.168.1.26:80 wrr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.16.106.141:80            Masq    1      1          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.16.106.142:80            Masq    1      1          0  </span></span><br><span class="line"> [root@director ~]# ipvsadm -C</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 清除所有ipvs规则</span></span><br><span class="line">---------</span><br><span class="line">  本机</span><br><span class="line">---------</span><br><span class="line">使用IE浏览器访问192.168.1.26/test/，会轮流返回realServer上的页面内容。不能使用realServer访问，访问超时，不会返回结果</span><br></pre></td></tr></table></figure>
<h3 id="部署LVS-DR模型"><a href="#部署LVS-DR模型" class="headerlink" title="部署LVS/DR模型"></a>部署LVS/DR模型</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">环境</span><br><span class="line">准备三台主机，以上面三台主机为基础</span><br><span class="line">director：外网地址：192.168.1.26</span><br><span class="line">realServer1：内网地址：192.168.1.27</span><br><span class="line">realServer2：内网地址：192.168.1.28</span><br><span class="line">VIP：192.168.1.260</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  Director</span><br><span class="line">--------------</span><br><span class="line">[root@director ~]# ipvsadm -C</span><br><span class="line">[root@director ~]# vim lvs_dr.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">vip=192.168.1.60</span><br><span class="line">rs1=192.168.1.27</span><br><span class="line">rs2=192.168.1.28</span><br><span class="line">ifconfig ens33:0 down</span><br><span class="line">ifconfig ens33:0 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line">route add -host $vip dev ens33:0</span><br><span class="line">[root@director ~]# ipvsadm -A -t 192.168.1.60:80 -s wrr</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.1.60:80 -r 192.168.1.27 -g -w 1</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.1.60:80 -r 192.168.1.28 -g -w 1</span><br><span class="line">[root@director ~]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  192.168.1.60:80 wrr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.1.27:80              Route   1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.1.28:80              Route   1      0          0</span></span><br><span class="line">  </span><br><span class="line">---------------------</span><br><span class="line">  realServer1&amp;2</span><br><span class="line">---------------------</span><br><span class="line">[root@realserver1 ~]# vim lvs_dr_rs.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">vip=192.168.1.60</span><br><span class="line">ifconfig lo:0 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line">route add -host $vip lo:0</span><br><span class="line">echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">  本机</span><br><span class="line">---------</span><br><span class="line">使用IE浏览器访问192.168.1.26/test/，会轮流返回realServer上的页面内容。不能使用realServer访问，访问超时，不会返回结果</span><br></pre></td></tr></table></figure>
<h3 id="部署keepalived-LVS环境"><a href="#部署keepalived-LVS环境" class="headerlink" title="部署keepalived+LVS环境"></a>部署keepalived+LVS环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">环境</span><br><span class="line">准备四台主机，以上面三台主机为基础</span><br><span class="line">director1：外网地址：192.168.1.26</span><br><span class="line">director2：外网地址：192.168.1.26</span><br><span class="line">realServer1：内网地址：192.168.1.27</span><br><span class="line">realServer2：内网地址：192.168.1.28</span><br><span class="line">VIP：192.168.1.260</span><br><span class="line"></span><br><span class="line">------------------</span><br><span class="line">  Director1&amp;2</span><br><span class="line">------------------</span><br><span class="line">[root@director keepalived]# ifconfig ens33:0 down</span><br><span class="line"><span class="meta">#</span><span class="bash"> down掉director1上的ens33:0网卡，因为此网卡上有VIP地址。影响下面的keepalived测试</span></span><br><span class="line">[root@realserver2 ~]# yum install -y ipvsadm keeyalived</span><br><span class="line">[root@director ~]# cd /etc/keepalived/</span><br><span class="line">[root@director keepalived]# cp keepalived.conf&#123;,.bak&#125;</span><br><span class="line">[root@director keepalived]# vim keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">      root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id node1		# # director2这里要改为node2</span><br><span class="line">   vrrp_mcast_group4 224.1.101.12</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER		# director2这里要改为BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100		# dirctor2这里要改为96</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.60 dev ens33 label ens33:0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.1.60 80 &#123;</span><br><span class="line">    delay_loop 1</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 192.168.1.27 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">           TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 10</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 192.168.1.28 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">           TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 10</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@director keepalived]# echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">[root@director keepalived]# systemctl start keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动keepalived后，会自动生成ipvs规则</span></span><br><span class="line">[root@director keepalived]# tcpdump -i ens33 -vv -nn host 224.1.101.12</span><br><span class="line"><span class="meta">#</span><span class="bash">这时可以看到探测信息，这是拥有VIP地址的主机发来的。</span></span><br><span class="line">[root@director keepalived]# ip a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到VIP在director1上</span></span><br><span class="line">[root@director keepalived]# ipvsadm -ln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是否生成了ipvs规则，如果未生成，可以用下面命令</span></span><br><span class="line">[root@director keepalived]# ipvsadm -A -t 192.168.1.60:80 -s wrr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成一个虚拟服务器，用加权轮询算法</span></span><br><span class="line">[root@director keepalived]# ipvsadm -a -t 192.168.1.60:80 -r 192.168.1.27:80 -g -w 1</span><br><span class="line">[root@director keepalived]# ipvsadm -a -t 192.168.1.60:80 -r 192.168.1.28:80 -g -w 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将realserver加入到虚拟服务器中，-g表示使用DR直接路由，-w指定权重。</span></span><br><span class="line">[root@director keepalived]# ipvsadm -E -t 10.5.5.140:9999 -s wrr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改调度算法</span></span><br><span class="line"></span><br><span class="line">---------------------</span><br><span class="line">  realServer1&amp;2</span><br><span class="line">---------------------</span><br><span class="line">[root@realserver1 ~]# vim lvs_dr_rs.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">vip=192.168.1.60</span><br><span class="line">ifconfig lo:0 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line">route add -host $vip lo:0</span><br><span class="line">echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">  本机</span><br><span class="line">---------</span><br><span class="line">使用IE浏览器访问192.168.1.26/test/，会轮流返回realServer上的页面内容。不能使用realServer访问，访问超时，不会返回结果。使用命令：</span><br><span class="line">root@ru:ruopu.gitb#for i in `seq 10000`;do curl 192.168.1.60/test/ &amp;&amp; echo $i;done</span><br><span class="line">也会返回两台服务器的页面内容。这时如果停止一台keepalived，VIP地址会转移到另一台上，访问还会继续</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/25/ELK部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/25/ELK部署/" itemprop="url">
                  ELK部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-25 09:04:32" itemprop="dateCreated datePublished" datetime="2019-01-25T09:04:32+08:00">2019-01-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-28 17:28:55" itemprop="dateModified" datetime="2019-01-28T17:28:55+08:00">2019-01-28</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="elk概念"><a href="#elk概念" class="headerlink" title="elk概念"></a>elk概念</h3><blockquote>
<p>ELK又称为ELK Stack,是 Elasticsearch、Logstash、Kibana 三个开源软件的组合,每个完成不同的功能，官方网站 <a href="http://www.elastic.co" target="_blank" rel="noopener">www.elastic.co</a></p>
</blockquote>
<h4 id="elasticsearch概念"><a href="#elasticsearch概念" class="headerlink" title="elasticsearch概念"></a>elasticsearch概念</h4><blockquote>
<p>Elasticsearch 可实现数据的实时全文搜索、支持分布式可实现高可用、提供<br>API接口，可以处理大规模日志数据，比如Nginx、Tomcat、系统日志等。</p>
</blockquote>
<h4 id="logstash概念"><a href="#logstash概念" class="headerlink" title="logstash概念"></a>logstash概念</h4><blockquote>
<p>Logstash:通过插件实现日志收集，支持日志过滤，支持普通log、自定义json格式的日志解析。</p>
</blockquote>
<h5 id="logstash格式"><a href="#logstash格式" class="headerlink" title="logstash格式"></a>logstash格式</h5><blockquote>
<p>input {} #input 插件收集日志</p>
<p>output {} #output 插件输出日志</p>
</blockquote>
<h4 id="kibana概念"><a href="#kibana概念" class="headerlink" title="kibana概念"></a>kibana概念</h4><blockquote>
<p>kibana：kibana主要是调用elasticsearch的数据，并进行前端数据可视化的展现。</p>
</blockquote>
<h3 id="elk部署"><a href="#elk部署" class="headerlink" title="elk部署"></a>elk部署</h3><h4 id="elk简单部署"><a href="#elk简单部署" class="headerlink" title="elk简单部署"></a>elk简单部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">收集单个日志</span><br><span class="line">==============================================================================================</span><br><span class="line"></span><br><span class="line">准备三台主机，做els集群，配置：双核处理器，2G内存。地址：192.168.1.20，192.168.1.21，192.168.1.22</span><br><span class="line">准备一台主机，安装nginx，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装kibana，地址：192.168.1.23</span><br><span class="line"></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">sed -i ‘/SELINUX/s/enforcing/disabled/’ /etc/selinux/config</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭三台主机的防火墙和SELinux</span></span><br><span class="line">ulimit -n</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看打开文件最大数</span></span><br><span class="line">echo "* soft nofile 65536" &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo "* hard nofile 65536" &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整打开文件最大数</span></span><br><span class="line">ulimit -n 65535</span><br><span class="line"><span class="meta">#</span><span class="bash"> 临时调整打开文件最大数</span></span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br><span class="line">chronyc</span><br><span class="line"><span class="meta">chronyc&gt;</span><span class="bash"> waitsync</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步三台主机时间</span></span><br><span class="line">yum install jdk-8u201-linux-x64.rpm -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装jdk</span></span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">    export JAVA_HOME=/usr</span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置java家目录并加载</span></span><br><span class="line">yum install -y elasticsearch-6.5.4.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 三台主机均安装els</span></span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">    cluster.name: testelk</span><br><span class="line">    # 集群的名称，名称相同的主机就是处于同一个集群</span><br><span class="line">    node.name: node1</span><br><span class="line">    # 集群情况下，当前node的名字，每个node应该不一样</span><br><span class="line">    path.data: /elkdata/data</span><br><span class="line">    # 数据目录</span><br><span class="line">    path.logs: /elkdata/logs</span><br><span class="line">    # 日志目录</span><br><span class="line">    # bootstrap.memory_lock: true</span><br><span class="line">    # 服务启动时即锁定足够大的内存，提高效率。测试中如果打开此项，启动会失败，提示内存未锁定</span><br><span class="line">    network.host: 0.0.0.0</span><br><span class="line">    # 监听的地址</span><br><span class="line">    http.port: 9200</span><br><span class="line">    # 客户端访问端口</span><br><span class="line">    discovery.zen.ping.unicast.hosts: ["192.168.1.20", "192.168.1.21", "192.168.1.22"]</span><br><span class="line">    # 组播范围</span><br><span class="line">    discovery.zen.minimum_master_nodes: 2</span><br><span class="line">    # 设置此项为了必免脑裂，这里的数字是总节点数除以2加1算出来的。</span><br><span class="line">vim /etc/elasticsearch/jvm.options</span><br><span class="line">    -Xms3g  # 初始化的堆内存</span><br><span class="line">    -Xmx3g  # 最大堆内存，可以改大此值。这两个值要保持一致。或将上面配置文件中的bootstrap.memory_lock的值改为false</span><br><span class="line">mkdir /elkdata/&#123;data,logs&#125; -pv</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据和日志目录</span></span><br><span class="line">chown elasticsearch.elasticsearch /elkdata/ -R</span><br><span class="line">systemctl start elasticsearch</span><br><span class="line">systemctl enable elasticsearch</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动并查看状态</span></span><br><span class="line">==============================================================================================</span><br><span class="line">Master的职责：</span><br><span class="line">1. 节点状态信息</span><br><span class="line">2. 集群状态信息</span><br><span class="line">3. 创建索引</span><br><span class="line">4. 删除索引</span><br><span class="line">5. 分片管理</span><br><span class="line">6. 关闭节点</span><br><span class="line">Slave节点的职责：</span><br><span class="line">1. 同步数据</span><br><span class="line">2. 等待机会成为master</span><br><span class="line">==============================================================================================</span><br><span class="line">* node1上安装elasticsearch-head插件</span><br><span class="line">git clone git://github.com/mobz/elasticsearch-head.git</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载elasticsearch-head插件，这个插件是为了实现简单的集群监控、主机信息显示和管理等功能</span></span><br><span class="line">yum install -y epel-release</span><br><span class="line">yum install npm -y</span><br><span class="line">cd elasticsearch-head/</span><br><span class="line">npm install grunt -save</span><br><span class="line">npm install</span><br><span class="line">npm run start &amp;</span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">    #---------------------------------- http ---------------------------------------</span><br><span class="line">    http.cors.enabled: true     # 打开http功能</span><br><span class="line">    http.cors.allow-origin: "*"     # 允许谁访问</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置elasticsearch允许远程访问</span></span><br><span class="line">systemctl restart elasticsearch</span><br><span class="line"></span><br><span class="line">* nginx</span><br><span class="line">yum install -y gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br><span class="line">tar xf nginx-1.12.2.tar.gz</span><br><span class="line">cd nginx-1.12.2/</span><br><span class="line">./configure --prefix=/usr/local/nginx</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd /usr/local/nginx/</span><br><span class="line">mkdir html/test</span><br><span class="line">echo "nginx test page" &gt;&gt; html/test/index.html</span><br><span class="line">vim conf/nginx.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        location /test &#123;</span><br><span class="line">           root html;</span><br><span class="line">           index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">/usr/local/nginx/sbin/nginx -t</span><br><span class="line">/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">访问http://192.168.1.30/test/测试</span><br><span class="line">==============================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面在nginx主机上安装logstash</span></span><br><span class="line">==============================================================================================</span><br><span class="line">yum -y install jdk-8u201-linux-x64.rpm</span><br><span class="line">yum -y install logstash-6.5.4.rpm</span><br><span class="line">/usr/share/logstash/bin/logstash -e "input&#123;stdin&#123;&#125;&#125; output&#123;stdout&#123; codec =&gt; "rydebug"&#125;&#125;"</span><br><span class="line">    hello</span><br><span class="line">    &#123;</span><br><span class="line">        "@timestamp" =&gt; 2019-01-24T08:47:22.515Z,</span><br><span class="line">        "message" =&gt; "hello",</span><br><span class="line">            "host" =&gt; "nginx1",</span><br><span class="line">        "@version" =&gt; "1"</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试</span></span><br><span class="line">vim /etc/logstash/conf.d/system.conf</span><br><span class="line">    input &#123;</span><br><span class="line">        file&#123;</span><br><span class="line">            type =&gt; "messagelog"</span><br><span class="line">            path =&gt; "/var/log/messages"</span><br><span class="line">            start_position =&gt; "beginning"   # 首次从头收集</span><br><span class="line">        &#125;</span><br><span class="line">        # 从文件输入，类型是messagelog，写明路径，最后指定从头收集</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    output &#123;</span><br><span class="line">        file &#123;</span><br><span class="line">            path =&gt; "/tmp/123.txt"</span><br><span class="line">        &#125;</span><br><span class="line">        # 输出到一个文件，用file引导，下面写明路径。</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">            index =&gt; "system-messages-%&#123;+YYYY.MM.dd&#125;"   # 索引的命名规则，后面加入日期</span><br><span class="line">        &#125;</span><br><span class="line">        # 输出到elasticsearch，写明地址，索引的名称</span><br><span class="line">    &#125;</span><br><span class="line">/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf -t</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-f指定配置文件，-t表示测试配置文件是否正确</span></span><br><span class="line">chmod 644 /var/log/messages</span><br><span class="line"><span class="meta">#</span><span class="bash"> 让普通用户可以读系统日志</span></span><br><span class="line">systemctl start logstash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动logstash。也可以使用/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf在前台启动</span></span><br><span class="line">tail -f /tmp/123.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以看到输出的日志文件了</span></span><br><span class="line">访问192.168.1.20:9100，在其中的数据浏览中也可以看到一个叫system-messages-2019.01.24的索引了</span><br><span class="line"></span><br><span class="line">==============================================================================================</span><br><span class="line">收集多个日志</span><br><span class="line">==============================================================================================</span><br><span class="line">cp /etc/logstash/conf.d/system.conf /etc/logstash/conf.d/nginx.conf -a</span><br><span class="line">vim /etc/logstash/conf.d/nginx.conf</span><br><span class="line">input &#123;</span><br><span class="line">   file&#123;</span><br><span class="line">      type =&gt; "messagelog"      # type是自定义的？</span><br><span class="line">      path =&gt; "/var/log/messages"</span><br><span class="line">      start_position =&gt; "beginning"</span><br><span class="line">   &#125;</span><br><span class="line">   file &#123;</span><br><span class="line">      type =&gt; "nginxlog"</span><br><span class="line">      path =&gt; "/usr/local/nginx/logs/access.log"</span><br><span class="line">      start_position =&gt; "beginning"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">   file &#123;</span><br><span class="line">      path =&gt; "/tmp/123.txt"</span><br><span class="line">   &#125;</span><br><span class="line">   elasticsearch &#123;</span><br><span class="line">      hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">      index =&gt; "system-messages-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">   &#125;</span><br><span class="line">   if [type] == "nginxlog" &#123;        # 使用if判断type是否为输入中定义的nginxlog，如果是就传输到elasticsearch中</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">      hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">      index =&gt; "nginx-messages-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf -t</span><br><span class="line">systemctl restart logstash</span><br><span class="line">访问192.168.1.20:9100，在概览中可以看到传过来的nginxlog索引了</span><br><span class="line"></span><br><span class="line">* kibana</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面安装kibana</span></span><br><span class="line">yum install -y kibana-6.5.4-x86_64.rpm</span><br><span class="line">vim /etc/kibana/kibana.yml</span><br><span class="line">    server.port: 5601</span><br><span class="line">    server.host: "0.0.0.0"</span><br><span class="line">    elasticsearch.url: "http://192.168.1.20:9200"   # 调用elasticsearch的接口，写一个就可以</span><br><span class="line">systemctl start kibana</span><br><span class="line">yum install -y gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br><span class="line">tar xf nginx-1.12.2.tar.gz</span><br><span class="line">cd nginx-1.12.2/</span><br><span class="line">./configure --prefix=/usr/local/nginx</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用nginx反向代理kibana</span></span><br><span class="line">vim /etc/kibana/kibana.yml</span><br><span class="line">    server.host: "localhost"</span><br><span class="line">    # 改为监听本地地址</span><br><span class="line">cd /usr/local/nginx/</span><br><span class="line">mkdir /usr/local/nginx/conf/conf.d</span><br><span class="line">vim /usr/local/nginx/conf/conf.d/kibana.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name test.kibana.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://localhost:5601;</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">            proxy_set_header Connection 'upgrade';</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_cache_bypass $http_upgrade;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">    http &#123;</span><br><span class="line">        ...</span><br><span class="line">        include /usr/local/nginx/conf/conf.d/*.conf;</span><br><span class="line">    &#125;</span><br><span class="line">/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">设置本机可以解析test.kibana.com</span><br></pre></td></tr></table></figure>
<h5 id="kibana简单设置使用"><a href="#kibana简单设置使用" class="headerlink" title="kibana简单设置使用"></a>kibana简单设置使用</h5><h6 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h6><blockquote>
<p>这里可以选择使用样本数据，也可以只使用自己的数据。可以通过对样本数据设置的学习，了解kibana的设置方法</p>
</blockquote>
<p><img src="/images/kibana/访问1.png" alt=""></p>
<h6 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h6><blockquote>
<p>选择左侧的Management，之后在右边输入从els中获取的索引的名称，只需要输入前面部分，后面的日期可以使用星号配置，这里在下面也可以看到匹配到的索引，最后点击下一步。之后选择按时间过滤并创建即可。</p>
</blockquote>
<p><img src="/images/kibana/配置索引1.png" alt=""></p>
<p><img src="/images/kibana/配置索引2.png" alt=""></p>
<blockquote>
<p>这后可以在Discover中看到我们添加的索引了，如果无法显示数据，可能是右上方的时间有误</p>
</blockquote>
<p><img src="/images/kibana/查看1.png" alt=""></p>
<h5 id="nginx登录认证"><a href="#nginx登录认证" class="headerlink" title="nginx登录认证"></a>nginx登录认证</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* kibana</span><br><span class="line">[root@kibana ~]# yum install -y httpd-tools</span><br><span class="line">[root@kibana ~]# htpasswd -bc /usr/local/nginx/conf/htpasswd.users kibanauser centos</span><br><span class="line">Adding password for user kibanauser</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置登录用户名和密码</span></span><br><span class="line">[root@kibana ~]# vim /usr/local/nginx/conf/conf.d/kibana.conf </span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name test.kibana.com;</span><br><span class="line">   auth_basic "Restricted Access";</span><br><span class="line">   auth_basic_user_file /usr/local/nginx/conf/htpasswd.users;</span><br><span class="line">   location / &#123;</span><br><span class="line">      proxy_pass http://localhost:5601;</span><br><span class="line">      proxy_http_version 1.1;</span><br><span class="line">      proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">      proxy_set_header Connection 'upgrade';</span><br><span class="line">      proxy_set_header Host $host;</span><br><span class="line">      proxy_cache_bypass $http_upgrade;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入认证</span></span><br><span class="line">[root@kibana ~]# /usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">再次访问kibana页面时就需要认证了</span><br></pre></td></tr></table></figure>
<h4 id="日志收集"><a href="#日志收集" class="headerlink" title="日志收集"></a>日志收集</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">* 规划</span><br><span class="line">通过在要收集日志的服务器上安装filebeat进行日志收集，之后将收集到的数据写入到redis服务器，再通过logstash服务器取出数据并写入到elasticsearch集群中。也可以通过filebeat收集日志后转发给logstash服务器，再由logstash服务器写入到redis中，再由另一台logstash服务器从redis服务器中取出数据并写入到elasticsearch集群中。</span><br><span class="line"></span><br><span class="line">* 环境</span><br><span class="line">准备三台主机，做els集群，配置：双核处理器，2G内存。地址：192.168.1.20，192.168.1.21，192.168.1.22</span><br><span class="line">准备一台主机，安装nginx，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装kibana，地址：192.168.1.23</span><br><span class="line">准备一台主机，安装redis，地址：192.168.1.24</span><br><span class="line">准备一台主机，安装haproxy，地址：192.168.1.31</span><br><span class="line"></span><br><span class="line">* 软件版本</span><br><span class="line">1. 操作系统:CentOS7.4.1708</span><br><span class="line">2. jdk: jdk-8u201 官方rpm或gz包</span><br><span class="line">3. elasticsearch:6.5.4 官方当前最新rpm</span><br><span class="line">4. logstash:6.5.4 官方当前最新rpm</span><br><span class="line">5. kibana:6.5.4 官方当前最新rpm</span><br><span class="line">6. filebeat:6.5.4 官方当前最新rpm</span><br><span class="line">7. nginx:1.12.2</span><br><span class="line">8. redis:5.0.3 官方最新源码包</span><br><span class="line">==============================================================================================</span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis ~]# yum install -y gcc</span><br><span class="line">[root@redis ~]# tar xf redis-5.0.3.tar.gz -C /usr/local/src/</span><br><span class="line">[root@redis redis-5.0.3]# cd /usr/local/src/redis-5.0.3/</span><br><span class="line">[root@redis redis-5.0.3]# make</span><br><span class="line">[root@redis redis-5.0.3]# ln -sv /usr/local/src/redis-5.0.3/ /usr/local/redis</span><br><span class="line">‘/usr/local/redis’ -&gt; ‘/usr/local/src/redis-5.0.3/’</span><br><span class="line">[root@redis redis-5.0.3]# cp src/redis-server src/redis-cli /usr/bin</span><br><span class="line">[root@redis redis-5.0.3]# cd /usr/local/redis/</span><br><span class="line">[root@redis redis]# vim redis.conf</span><br><span class="line">    bind 0.0.0.0</span><br><span class="line">    daemonize yes</span><br><span class="line">    # 让redis以守护进程方式运行</span><br><span class="line">    save ""		</span><br><span class="line">    #save 900 1</span><br><span class="line">    #save 300 10</span><br><span class="line">    #save 60 10000</span><br><span class="line">    # 因为不需要持久存储，所以将save ""打开，将下面三行关闭。</span><br><span class="line">    requirepass centos</span><br><span class="line">    logfile "/var/log/redis.log"</span><br><span class="line">    # 输出日志路径，默认会输出到/dev/null中</span><br><span class="line">[root@redis redis]# redis-server /usr/local/redis/redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动redis，启动时指定配置文件</span></span><br><span class="line">[root@redis redis]# ss -tln</span><br><span class="line">[root@redis redis]# redis-cli </span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">127.0.0.1:6379&gt; AUTH centos</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">(empty list or set)</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  haproxy</span><br><span class="line">-------------</span><br><span class="line">[root@haproxy ~]# yum install jdk-8u201-linux-x64.rpm</span><br><span class="line">[root@haproxy ~]# yum install logstash-6.5.4.rpm</span><br><span class="line">[root@haproxy ~]# yum install -y haproxy</span><br><span class="line">[root@haproxy ~]# vim /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local6		# 这行很重要，local6是haproxy的日志级别，在rsyslog配置文件中也要定义这个级别</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line">frontend myweb		</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server srv1 192.168.1.30:80 check</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里只简单地将haproxy反代到nginx服务器上，实现访问haproxy就会反代到nginx服务器上</span></span><br><span class="line">[root@haproxy ~]# vim /etc/rsyslog.d/haproxy.conf</span><br><span class="line">    $ModLoad imudp</span><br><span class="line">    $UDPServerRun 514</span><br><span class="line">    $ModLoad imtcp</span><br><span class="line">    $InputTCPServerRun 514</span><br><span class="line">    local6.* @@192.168.1.31:5140</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收日志的logstash服务器IP:PORT，local6对应haproxy的日志级别。这里将日志传给了本机的logstash</span></span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/syslog.conf </span><br><span class="line">input &#123;</span><br><span class="line">   syslog &#123;</span><br><span class="line">      type =&gt; "system-rsyslog"</span><br><span class="line">      port =&gt; "5140"		# 从logstash的5140端口输入，实际也是定义logstash监听的端口</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">   stdout &#123;</span><br><span class="line">      codec =&gt; rubydebug</span><br><span class="line">   &#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"		# redis的数据类型要使用list</span><br><span class="line">      key =&gt; "system-rsyslog"		# 写入redis的键名</span><br><span class="line">      host =&gt; "192.168.1.24"		# redis地址</span><br><span class="line">      port =&gt; "6379"		# redis端口</span><br><span class="line">      db =&gt; "0"			# redis库</span><br><span class="line">      password =&gt; "centos"		# redis密码</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# systemctl restart rsyslog</span><br><span class="line"><span class="meta">#</span><span class="bash"> rsyslog监听在514端口</span></span><br><span class="line">[root@haproxy ~]# systemctl start haproxy    </span><br><span class="line">[root@haproxy ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/syslog.conf</span><br><span class="line">在本机设置hosts文件，解析haproxy地址到www.test.com，访问www.test.com，这时应该显示一些信息，如：</span><br><span class="line">&#123;</span><br><span class="line">         "timestamp" =&gt; "Jan 25 12:53:39",</span><br><span class="line">        "@timestamp" =&gt; 2019-01-25T04:53:39.000Z,</span><br><span class="line">           "message" =&gt; "192.168.1.9:33634 [25/Jan/2019:12:53:39.002] myweb websrvs/srv1 0/0/1/1/2 304 175 - - ---- 2/2/0/0/0 0/0 \"GET / HTTP/1.1\"\n",</span><br><span class="line">         "logsource" =&gt; "localhost",</span><br><span class="line">              "type" =&gt; "system-rsyslog",</span><br><span class="line">              "host" =&gt; "192.168.1.31",</span><br><span class="line">          "priority" =&gt; 182,</span><br><span class="line">    "facility_label" =&gt; "local6",</span><br><span class="line">          "severity" =&gt; 6,</span><br><span class="line">           "program" =&gt; "haproxy",</span><br><span class="line">          "facility" =&gt; 22,</span><br><span class="line">    "severity_label" =&gt; "Informational",</span><br><span class="line">               "pid" =&gt; "3817",</span><br><span class="line">          "@version" =&gt; "1"</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到监听了5140端口</span></span><br><span class="line">[root@haproxy ~]# systemctl start logstash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在后台启动</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis redis]# redis-cli -a centos</span><br><span class="line">127.0.0.1:6379&gt; SELECT 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) "system-rsyslog"</span><br><span class="line">127.0.0.1:6379&gt; LLEN system-rsyslog</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; LPOP system-rsyslog</span><br><span class="line">"&#123;\"facility\":22,\"host\":\"192.168.1.31\",\"logsource\":\"localhost\",\"program\":\"haproxy\",\"@version\":\"1\",\"facility_label\":\"local6\",\"message\":\"192.168.1.9:33540 [25/Jan/2019:12:37:37.836] myweb websrvs/srv1 0/0/0/1/1 304 175 - - ---- 2/2/0/1/0 0/0 \\\"GET / HTTP/1.1\\\"\\n\",\"priority\":182,\"pid\":\"3817\",\"timestamp\":\"Jan 25 12:37:37\",\"severity\":6,\"severity_label\":\"Informational\",\"type\":\"system-rsyslog\",\"@timestamp\":\"2019-01-25T04:37:37.000Z\"&#125;"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到相关数据了</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  haproxy</span><br><span class="line">-------------</span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/syslog.conf </span><br><span class="line">input &#123;</span><br><span class="line">   syslog &#123;</span><br><span class="line">      type =&gt; "system-rsyslog"</span><br><span class="line">      port =&gt; "5140"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">   stdout &#123;</span><br><span class="line">      codec =&gt; rubydebug</span><br><span class="line">   &#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      key =&gt; "haproxy-log-31"		# 改变输出到redis中的键名</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# systemctl restart logstash</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) "haproxy-log-31"</span><br><span class="line">2) "system-rsyslog"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到从logstash传入新的键了</span></span><br><span class="line"></span><br><span class="line">==============================================================================================</span><br><span class="line">下面设置收集TCP/UDP日志</span><br><span class="line">==============================================================================================</span><br><span class="line">-------------</span><br><span class="line">  haproxy</span><br><span class="line">-------------</span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class="line">input &#123;</span><br><span class="line">   tcp &#123;</span><br><span class="line">      port =&gt; "5500"</span><br><span class="line">      type =&gt; "tcp-syslog"</span><br><span class="line">      mode =&gt; "server"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">	stdout &#123;</span><br><span class="line">	  codec =&gt; rubydebug</span><br><span class="line">	&#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      key =&gt; "tcp-syslog"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf -t</span><br><span class="line">WARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class="line">[WARN ] 2019-01-25 13:16:45.820 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified</span><br><span class="line">Configuration OK</span><br><span class="line">[INFO ] 2019-01-25 13:16:47.307 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试配置文件没有问题</span></span><br><span class="line">[root@haproxy ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> logstash启动时还会监听本地的9600端口</span></span><br><span class="line">[root@haproxy ~]# yum install -y nc</span><br><span class="line">[root@haproxy ~]# echo "nc test"|nc 192.168.1.31 5500</span><br><span class="line">这时logstash会在终端输出内容：</span><br><span class="line">&#123;</span><br><span class="line">          "host" =&gt; "haproxy",</span><br><span class="line">       "message" =&gt; "nc test",</span><br><span class="line">          "port" =&gt; 39566,</span><br><span class="line">          "type" =&gt; "tcp-syslog",</span><br><span class="line">    "@timestamp" =&gt; 2019-01-25T05:29:16.034Z,</span><br><span class="line">      "@version" =&gt; "1"</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# nc 192.168.1.31 5500 &lt; /root/anaconda-ks.cfg</span><br><span class="line">[root@haproxy ~]# echo "伪设备" &gt; /dev/tcp/192.168.1.31/5500</span><br><span class="line"><span class="meta">#</span><span class="bash"> /dev后面的部分是没有的，要手动输入，在logstash中也会显示</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) "tcp-syslog"</span><br><span class="line">2) "haproxy-log-31"</span><br><span class="line">3) "system-rsyslog"</span><br><span class="line">127.0.0.1:6379&gt; LLEN tcp-syslog</span><br><span class="line">(integer) 52</span><br><span class="line"><span class="meta">#</span><span class="bash"> redis中也可以看到数据了</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  logstash</span><br><span class="line">-------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用nginx主机中的logstash收集redis中的数据</span></span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class="line">input &#123;</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "haproxy-log-31"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;  </span><br><span class="line">   </span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "tcp-syslog"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">   if [type] == "tcp-syslog" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "tcp-rsyslog-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">      &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">   </span><br><span class="line">   if [type] == "system-rsyslog" &#123;		# 这里判断的是haproxy服务器的logstash设置中input定义的type</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "haproxy-log-31-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">      &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 从redis中取行数据，之后输出到elasticsearch集群中。</span></span><br><span class="line">[root@nginx1 ~]# systemctl start logstash</span><br><span class="line">[root@nginx1 ~]# tail -f /var/log/logstash/logstash-plain.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以通过这个日志文件查看logstash运行是否正常，如是否可以连接到redis服务器</span></span><br><span class="line">访问els服务器：192.168.1.20:9200，这时可以看到haproxy-log-31-*这个索引了</span><br></pre></td></tr></table></figure>
<h4 id="filebeat收集日志"><a href="#filebeat收集日志" class="headerlink" title="filebeat收集日志"></a>filebeat收集日志</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">* 规划</span><br><span class="line">1. 在web端安装filebeat进行对日志的收集，之后将日志发送给logstash。</span><br><span class="line">2. 配置一台logstash服务器，将收到的日志转发到redis</span><br><span class="line">3. 使用另一台logstash服务器从redis中读取日志，并将处理的结果写入到elasticsearch集群</span><br><span class="line">4. 配置地图显示IP访问地址</span><br><span class="line">5. 将日志写入数据库持久化保存</span><br><span class="line">6. 通过zabbix对elasticsearch集群状态及redis队列长度监控并实现邮件报警</span><br><span class="line"></span><br><span class="line">* 环境</span><br><span class="line">准备三台主机，做els集群，配置：双核处理器，2G内存。地址：192.168.1.20，192.168.1.21，192.168.1.22</span><br><span class="line">准备一台主机，安装nginx，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装kibana，地址：192.168.1.23</span><br><span class="line">准备一台主机，安装redis，地址：192.168.1.24</span><br><span class="line">准备一台主机，安装logstash负责将日志转发到redis，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装logstash负责从redis中读取数据并写入elasticsearch集群，地址：192.168.1.31。需要从redis中取出数据，所以再配置一台logstash服务器</span><br><span class="line">==============================================================================================</span><br><span class="line"></span><br><span class="line">-------------------------------------</span><br><span class="line">  nginx+tomcat+logstash30</span><br><span class="line">-------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面配置nginx日志格式，filebeat获取nginx与系统日志并转发至本机的logstash</span></span><br><span class="line">[root@nginx1 ~]# mkdir /usr/local/nginx/html/web</span><br><span class="line">[root@nginx1 ~]# echo "Nginx WebPage" &gt; /usr/local/nginx/html/web/index.html</span><br><span class="line">访问http://192.168.1.30/web/</span><br><span class="line">[root@nginx1 ~]# vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    log_format access1 '&#123;"@timestamp":"$time_iso8601",'</span><br><span class="line">                         '"host":"$server_addr",'</span><br><span class="line">                         '"clientip":"$remote_addr",'</span><br><span class="line">                         '"size":$body_bytes_sent,'</span><br><span class="line">                         '"responsetime":$request_time,'</span><br><span class="line">                         '"upstreamtime":"$upstream_response_time",'</span><br><span class="line">                         '"upstreamhost":"$upstream_addr",'</span><br><span class="line">                         '"http_host":"$host",'</span><br><span class="line">                         '"url":"$uri",'</span><br><span class="line">                         '"domain":"$host",'</span><br><span class="line">                         '"xff":"$http_x_forwarded_for",'</span><br><span class="line">                         '"referer":"$http_referer",'</span><br><span class="line">                         '"status":"$status"&#125;';</span><br><span class="line">	server &#123;</span><br><span class="line">		...</span><br><span class="line">        access_log  logs/host.access.log  access1;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置日志格式为Json格式。相对普通日志格式,json易于识别,每个值都有与其相对于的key,易于提取日志内容及方便后续进一步对日志的分析。可以到http://www.kjson.com/上验证Json格式是否正确。</span></span><br><span class="line">[root@nginx1 ~]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line">[root@nginx1 ~]# /usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">[root@nginx1 ~]# yum install -y filebeat-6.5.4-x86_64.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装filebeat，这个软件可以在web端实时收集日志并传递给logstash进一步处理</span></span><br><span class="line">==============================================================================================</span><br><span class="line">为什么不用logstash在web端收集</span><br><span class="line">1. 依赖java环境，一旦java出问题，可能影响到web服务</span><br><span class="line">2. 系统资源占用率高，且存在bug风险</span><br><span class="line">3. 配置比较复杂，支持匹配过滤</span><br><span class="line">4. filebeat挺好的，专注日志收集，语法简单，安装快捷，配置方便</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@nginx1 ~]# vim /etc/filebeat/filebeat.yml</span><br><span class="line"><span class="meta">#</span><span class="bash">filebeat.inputs:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">- <span class="built_in">type</span>: <span class="built_in">log</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  enabled: <span class="literal">false</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  paths:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    - /var/<span class="built_in">log</span>/*.<span class="built_in">log</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">output.elasticsearch:</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Array of hosts to connect to.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  hosts: [<span class="string">"localhost:9200"</span>]</span></span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/messages</span><br><span class="line">  include_lines: ["^ERR","^WARN"]		</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 如果加入此行，filebeat会只发送正则表达式匹配到的日志，其他都不发送。测试中未加此行。</span></span><br><span class="line">  fields:</span><br><span class="line">    service: system-log-30</span><br><span class="line"><span class="meta">#</span><span class="bash"> filebeat6中需要通过fields: service:这样的方式定义输出的类型，而5版本中的设置是使用  document_type: 定义类型。如果6版本中也按5版本的方法设置，在logstash中是找不到的。</span></span><br><span class="line">output.redis:</span><br><span class="line">  hosts: ["192.168.1.24:6379"]</span><br><span class="line">  key: "system-log-30"</span><br><span class="line">  db: 10</span><br><span class="line">  timeout: 5</span><br><span class="line">  password: "centos"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在配置文件最下方加入上面内容，另外需要注释配置文件中的inputs和其他output，不然启动会失败，不能有多个output段。启动失败时日志中会提示如<span class="string">"Exiting: prospectors and inputs used in the configuration file, define only inputs not both"</span></span></span><br><span class="line">[root@nginx1 ~]# tail -f /var/log/filebeat/filebeat</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看日志</span></span><br><span class="line"></span><br><span class="line">[root@nginx1 ~]# vim /etc/filebeat/filebeat.yml</span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/messages</span><br><span class="line">  fields:</span><br><span class="line">    service: system-log-30</span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /usr/local/nginx/logs/access.log</span><br><span class="line">  fields:</span><br><span class="line">    service: nginx-accesslog-30</span><br><span class="line">  </span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: ["192.168.1.30:5044","192.168.1.30:5045"]</span><br><span class="line">  enabled: true</span><br><span class="line">  worker: 1</span><br><span class="line">  compression_level: 3</span><br><span class="line">  loadbalance: true		# 默认为false，全部发送到随机选择的一个，相当于高可用模式</span><br><span class="line">[root@nginx1 filebeat]# systemctl restart filebeat </span><br><span class="line"></span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">    input &#123;				</span><br><span class="line">       beats &#123;		# 这个输入的名称是自定义的</span><br><span class="line">          port =&gt; 5044</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">       beats &#123;</span><br><span class="line">          port =&gt; 5045</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    output &#123;</span><br><span class="line">       stdout &#123;</span><br><span class="line">          codec =&gt; "rubydebug"</span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf</span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">    input &#123;				</span><br><span class="line">       beats &#123;		# 此输入插件使Logstash能够从Elastic Beats框架接收事件</span><br><span class="line">          port =&gt; 5044</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">       beats &#123;</span><br><span class="line">          port =&gt; 5045</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    output &#123;</span><br><span class="line">       if [fields][service] == "system-log-30" &#123;		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的[fields][service] 是在filebeat的input中定义的，这是logstash6版本中的使用方法。如果是5版本，需要使用<span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">""</span>来匹配数据类型</span></span><br><span class="line">          redis &#123;</span><br><span class="line">             data_type =&gt; "list"</span><br><span class="line">             host =&gt; "192.168.1.24"</span><br><span class="line">             port =&gt; "6379"</span><br><span class="line">             key =&gt; "system-log-30"</span><br><span class="line">             db =&gt; "15"</span><br><span class="line">             password =&gt; "centos"</span><br><span class="line">          &#125;  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 收集到的系统日志会因为JSON格式而报错，如<span class="string">"[ERROR] 2019-01-28 00:01:06.861 [defaultEventExecutorGroup-5-1] json - JSON parse error, original data now in message field &#123;:error=&gt;#&lt;LogStash::Json::ParserError: Unrecognized token 'Jan': was expecting ('true', 'false' or 'null')</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> at [Source: (String)<span class="string">"Jan 28 00:01:01 nginx1 systemd: Started Session 197 of user root."</span>; line: 1, column: 4]&gt;, :data=&gt;<span class="string">"Jan 28 00:01:01 nginx1 systemd: Started Session 197 of user root."</span>&#125;<span class="string">"，但数据还是会被写入到redis中。</span></span></span><br><span class="line">       &#125;  </span><br><span class="line">       if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">          redis &#123;</span><br><span class="line">             data_type =&gt; "list"</span><br><span class="line">             host =&gt; "192.168.1.24"</span><br><span class="line">             port =&gt; "6379"</span><br><span class="line">             key =&gt; "nginx-accesslog-30"</span><br><span class="line">             db =&gt; "15"</span><br><span class="line">             password =&gt; "centos"</span><br><span class="line">             codec =&gt; "json"</span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf -t</span><br><span class="line">[root@nginx1 ~]# systemctl start logstash</span><br><span class="line">[root@nginx1 ~]# lsof -i:5045                 </span><br><span class="line">COMMAND    PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">java     22018 logstash  111u  IPv6 265612      0t0  TCP *:osp (LISTEN)</span><br><span class="line">java     22018 logstash  140u  IPv6 265052      0t0  TCP nginx1:osp-&gt;nginx1:60146 (ESTABLISHED)</span><br><span class="line">filebeat 22162     root    5u  IPv4 265051      0t0  TCP nginx1:60146-&gt;nginx1:osp (ESTABLISHED)</span><br><span class="line"><span class="meta">#</span><span class="bash">  查看是否连接到5044端口</span></span><br><span class="line">[root@nginx1 ~]# netstat -alnp | grep filebeat</span><br><span class="line">tcp        0      0 192.168.1.30:60146      192.168.1.30:5045       ESTABLISHED 22162/filebea      </span><br><span class="line">tcp        0      0 192.168.1.30:44502      192.168.1.30:5044       ESTABLISHED 22162/filebea</span><br><span class="line"><span class="meta">#</span><span class="bash">  netstart查看端口</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis ~]# lsof -i:6379 -n    </span><br><span class="line">COMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">redis-ser 15196 root    6u  IPv4  32440      0t0  TCP *:6379 (LISTEN)</span><br><span class="line">redis-ser 15196 root   10u  IPv4 166066      0t0  TCP 192.168.1.24:6379-&gt;192.168.1.30:48894 (ESTABLISHED)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到192.168.1.30连到了这台redis上。</span></span><br><span class="line">[root@redis ~]# redis-cli -a centos</span><br><span class="line">127.0.0.1:6379&gt; SELECT 5</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[5]&gt; KEYS *</span><br><span class="line">1) "system-log-30"</span><br><span class="line">2) "nginx-accesslog-30"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到redis库中已经有数据了。</span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  logstash31</span><br><span class="line">-----------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面配置logstash从redis读取数据</span></span><br><span class="line">[root@haproxy ~]# cd /etc/logstash/conf.d/</span><br><span class="line">[root@haproxy conf.d]# vim redis-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "system-log-30"</span><br><span class="line">      db =&gt; "5"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "nginx-accesslog-30"</span><br><span class="line">      db =&gt; "5"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   codec =&gt; "json"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">   if [fields][service]== "system-log-30" &#123;</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 这里也要使用这样的判断方法，不能使用<span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">""</span>这样的方法</span></span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "system-log-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">         # 这里的%&#123;+yyyy.MM.dd&#125;年和日都要使用小写字母，不能使用大写字母，不然logstash会报错。</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "nginx-accesslog-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy conf.d]# systemctl start logstash</span><br><span class="line">访问http://192.168.1.20:9100/，这时可以看到有日志索引nginx-accesslog-30-****.**.**存在了。</span><br></pre></td></tr></table></figure>
<h5 id="kibana验证nginx访问日志"><a href="#kibana验证nginx访问日志" class="headerlink" title="kibana验证nginx访问日志"></a>kibana验证nginx访问日志</h5><blockquote>
<p>因为kibana是从本机的nginx反向代理的，所以访问的地址是test.kibana.com，访问时出现错误提示：重定向次数过多，需要清理cookie。重启kibana后正常。原因不明。</p>
</blockquote>
<blockquote>
<p>在kibana中创建nginx-accesslog-30-*索引后，就可以看到数据信息了</p>
</blockquote>
<p><img src="/images/kibana/查看2.png" alt=""></p>
<h5 id="部署tomcat"><a href="#部署tomcat" class="headerlink" title="部署tomcat"></a>部署tomcat</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------</span><br><span class="line">  nginx+tomcat+logstash30</span><br><span class="line">-------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面部署tomcat</span></span><br><span class="line">[root@nginx1 ~]# yum install -y tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br><span class="line">[root@nginx1 ~]# mkdir /usr/share/tomcat/webapps/tomcatweb</span><br><span class="line">[root@nginx1 ~]# vim /usr/share/tomcat/webapps/tomcatweb/index.html</span><br><span class="line">	Tomcat Web Page</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个测试页</span></span><br><span class="line">[root@nginx1 ~]# systemctl start tomcat</span><br><span class="line">访问http://192.168.1.30:8080/tomcatweb/</span><br><span class="line">[root@nginx1 ~]# systemctl stop tomcat</span><br><span class="line">[root@nginx1 ~]# vim /etc/tomcat/server.xml</span><br><span class="line">&lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="</span><br><span class="line">logs"</span><br><span class="line">               prefix="localhost_access_log." suffix=".txt"</span><br><span class="line">               pattern="&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;</span><br><span class="line">,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;method&amp;quot;</span><br><span class="line">:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query</span><br><span class="line">?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;AgentVersion&amp;quot;:</span><br><span class="line">&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要注意tomcat日志的json格式，使用两个&amp;quot;将字段和变量分隔，标点符号不需要使用</span></span><br><span class="line">[root@nginx1 ~]# rm -rf /var/log/tomcat/*</span><br><span class="line">[root@nginx1 ~]# systemctl start tomcat</span><br><span class="line">[root@nginx1 ~]# tail /var/log/tomcat/localhost_access_log.2019-01-28.txt</span><br><span class="line">&#123;"clientip":"192.168.1.9","ClientUser":"-","authenticated":"-","AccessTime":"[28/Jan/2019:09:58:44 +0800]","method":"GET /tomcatweb/ HTTP/1.1","status":"304","SendBytes":"-","Query?string":"","partner":"-","AgentVersion":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36"&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证tomcat日志转json</span></span><br><span class="line">[root@nginx1 ~]# vim /etc/filebeat/filebeat.yml</span><br><span class="line">    - input_type: log</span><br><span class="line">      paths:</span><br><span class="line">        - /var/log/tomcat/localhost_access_log.*</span><br><span class="line">      fields:</span><br><span class="line">        service: tomcat-accesslog-30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入对tomcat日志的收集</span></span><br><span class="line">[root@nginx1 ~]# systemctl restart filebeat.service</span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">output &#123;</span><br><span class="line">    ...</span><br><span class="line">    if [fields][service] == "tomcat-accesslog-30" &#123;</span><br><span class="line">      redis &#123;</span><br><span class="line">         data_type =&gt; "list"</span><br><span class="line">         host =&gt; "192.168.1.24"</span><br><span class="line">         port =&gt; "6379"</span><br><span class="line">         key =&gt; "tomcat-accesslog-30"</span><br><span class="line">         db =&gt; "5"</span><br><span class="line">         password =&gt; "centos"</span><br><span class="line">         codec =&gt; "json"</span><br><span class="line">      &#125;  </span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br><span class="line">[root@nginx1 ~]# systemctl restart logstash</span><br><span class="line">[root@nginx1 ~]# yum install -y httpd-tools</span><br><span class="line">[root@nginx1 ~]# ab -n1000 -c10 http://192.168.1.30:8080/tomcatweb/</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis ~]# redis-cli -a centos</span><br><span class="line">127.0.0.1:6379&gt; SELECT 5</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[5]&gt; KEYS *</span><br><span class="line">1) "tomcat-accesslog-30"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到redis中已经有数据了</span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  logstash31</span><br><span class="line">-----------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面配置logstash从redis读取tomcat的数据</span></span><br><span class="line">[root@haproxy conf.d]# vim redis-es.conf       </span><br><span class="line">input &#123;</span><br><span class="line">...</span><br><span class="line">redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "tomcat-accesslog-30"</span><br><span class="line">      db =&gt; "5"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   codec =&gt; "json"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">...</span><br><span class="line">if [fields][service] == "tomcat-accesslog-30" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "tomcat-accesslog-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy conf.d]# systemctl restart logstash</span><br><span class="line">最后加入到kibana中</span><br><span class="line"></span><br><span class="line">--------------------</span><br><span class="line">  elasticsearch</span><br><span class="line">--------------------</span><br><span class="line">[root@els3 ~]# du -sh /elkdata/data/nodes/0/indices/</span><br><span class="line">97M     /elkdata/data/nodes/0/indices/</span><br><span class="line">[root@els3 ~]# du -sh /elkdata/data/nodes/0/indices/*</span><br><span class="line">4.0K    /elkdata/data/nodes/0/indices/--3-U6GWTSifioos1N2yUQ</span><br><span class="line">91M     /elkdata/data/nodes/0/indices/6MycbQuEQWmCbg3-A1q5EA</span><br><span class="line">120K    /elkdata/data/nodes/0/indices/HGUqPJuCQ1iTPJr1EVfxoQ</span><br><span class="line">2.0M    /elkdata/data/nodes/0/indices/KuBtJ9ztSDaI7dFaiNfeFQ</span><br><span class="line">2.9M    /elkdata/data/nodes/0/indices/QbkLT5G7RYu5nivgm2uncA</span><br><span class="line">1.5M    /elkdata/data/nodes/0/indices/_yuF7skcTtWOF4YJl_UaTw</span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证filebeat读取的日志，已经通过logstash写入到elasticsearch的数据目录中</span></span><br></pre></td></tr></table></figure>
<h3 id="kibana配置地图显示IP访问地址"><a href="#kibana配置地图显示IP访问地址" class="headerlink" title="kibana配置地图显示IP访问地址"></a>kibana配置地图显示IP访问地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">-----------------</span><br><span class="line">  logstash31</span><br><span class="line">-----------------</span><br><span class="line">[root@kibana ~]# wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在写入elasticsearch的logstash服务器配置</span></span><br><span class="line">[root@haproxy ~]# gunzip GeoLite2-City.tar.gz</span><br><span class="line">[root@haproxy ~]# tar xf GeoLite2-City.tar</span><br><span class="line">[root@haproxy ~]# cd GeoLite2-City_20190122/</span><br><span class="line">[root@haproxy GeoLite2-City_20190122]# cp GeoLite2-City.mmdb /etc/logstash/ -a</span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/redis-es.conf</span><br><span class="line">input &#123;&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">   filter &#123;</span><br><span class="line">   if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">   geoip &#123;</span><br><span class="line">        source =&gt; "clientip"</span><br><span class="line">        target =&gt; "geoip"</span><br><span class="line">        database =&gt; "/etc/logstash/GeoLite2-City.mmdb"</span><br><span class="line">        add_field =&gt; ["[geoip][coordinates]","%&#123;[geoip][longitude]&#125;"]</span><br><span class="line">        add_field =&gt; ["[geoip][coordinates]","%&#123;[geoip][latitude]&#125;"]</span><br><span class="line">   &#125;</span><br><span class="line">   mutate &#123;</span><br><span class="line">        convert =&gt; ["[geoip][coordinates]","float"]</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    ...</span><br><span class="line">    if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "logstash-nginx-accesslog-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里输出到els中的index名称必须以logstash开头，不然在kibana中创建地图选择Field时会有错误提示<span class="string">"No Compatible Fields: The "</span>nginx-accesslog-30-*<span class="string">" index pattern does not contain any of the following field types: geo_point"</span></span></span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# systemctl restart logstash</span><br></pre></td></tr></table></figure>
<h4 id="kibana创建地图"><a href="#kibana创建地图" class="headerlink" title="kibana创建地图"></a>kibana创建地图</h4><blockquote>
<p>删除旧的索引，重新创建新索引</p>
</blockquote>
<p><img src="/images/kibana/地图1.png" alt=""></p>
<blockquote>
<p>查看字段，会有以geoip开头的字段加入</p>
</blockquote>
<p><img src="/images/kibana/地图2.png" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------</span><br><span class="line">  nginx+tomcat+logstash30</span><br><span class="line">-------------------------------------</span><br><span class="line">[root@nginx1 ~]# echo '&#123;"@timestamp":"2019-01-27T19:27:57+08:00","host":"192.168.1.30","clientip":"106.38.38.83","size":0,"responsetime":0.000,"upstreamtime":"-","upstreamhost":"-","http_host":"192.168.1.30","url":"/index.html","domain":"192.168.1.30","xff":"-","referer":"-","status":"304"&#125;' &gt;&gt; /usr/local/nginx/logs/host.access.log.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入一条假数据到日志文件中，clientip改为公网地址</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>创建地图，选择logstash-nginx-accesslog-30-*</p>
</blockquote>
<p><img src="/images/kibana/地图3.png" alt=""></p>
<blockquote>
<p>在Buckets中的Aggregation选择Geohash，Field选择geoip.location，最后点击上方的三角按钮，这时就可以在地图上看到标记了</p>
</blockquote>
<p><img src="/images/kibana/地图4.png" alt=""></p>
<h3 id="将日志写入数据库"><a href="#将日志写入数据库" class="headerlink" title="将日志写入数据库"></a>将日志写入数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">规划</span><br><span class="line">1. 安装数据库并授权</span><br><span class="line">2. 创建表</span><br><span class="line">3. 配置logstash将数据写入数据库</span><br><span class="line">4. 测试</span><br><span class="line"></span><br><span class="line">环境</span><br><span class="line">准备一台主机，安装mariadb，地址：192.168.1.25</span><br><span class="line">logstash地址：192.168.1.30</span><br><span class="line">==============================================================================================</span><br><span class="line">--------------</span><br><span class="line">  mariadb</span><br><span class="line">--------------</span><br><span class="line">[root@mysql ~]# yum install -y mariadb-server</span><br><span class="line">[root@mysql ~]# systemctl start mariadb</span><br><span class="line">[root@mysql ~]# mysql_secure_installation</span><br><span class="line">[root@mysql ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE elk CHARACTER SET utf8 COLLATE utf8_bin;</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL privileges ON elk.* TO elk@"%" identified by "centos";</span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据库并授权</span></span><br><span class="line">[root@els3 ~]# mysql -h192.168.1.25 -uelk -pcentos</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在其他主机验证远程登录数据库</span></span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  logstash</span><br><span class="line">--------------</span><br><span class="line">[root@nginx1 ~]# yum install -y ruby</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要安装ruby后才可以使用gem命令</span></span><br><span class="line">[root@nginx1 ~]# gem sources --add http://gems.ruby-china.com --remove https://rubygems.org/</span><br><span class="line"><span class="meta">#</span><span class="bash"> Gem是一个管理Ruby库和程序的标准包，它通过Ruby Gem（如 http://rubygems.org/ ）源来查找、安装、升级和卸载软件包，非常的便捷。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> taobao Gems 源已停止维护，现由 ruby-china 提供镜像服务，所以将国内源改为http://gems.ruby-china.com</span></span><br><span class="line">[root@nginx1 ~]# mkdir -pv /usr/share/logstash/vendor/jar/jdbc</span><br><span class="line">[root@nginx1 ~]# unzip mysql-connector-java-8.0.14.zip</span><br><span class="line">[root@nginx1 ~]# cp mysql-connector-java-8.0.14/mysql-connector-java-8.0.14.jar /usr/share/logstash/vendor/jar/jdbc/</span><br><span class="line">[root@nginx1 ~]# chown -R logstash.logstash /usr/share/logstash/vendor/jar/</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash-plugin install logstash-output-jdbc</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash-plugin list|grep jdbc</span><br><span class="line">logstash-filter-jdbc_static</span><br><span class="line">logstash-filter-jdbc_streaming</span><br><span class="line">logstash-input-jdbc</span><br><span class="line">logstash-output-jdb</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  mariadb</span><br><span class="line">--------------</span><br><span class="line">[root@mysql ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; use elk</span><br><span class="line">MariaDB [elk]&gt; CREATE TABLE elklog (id int(11) NOT NULL AUTO_INCREMENT,host VARCHAR(255),clientip VARCHAR(255),url VARCHAR(255),status INT(16),time timestamp,PRIMARY KEY (id));</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  logstash</span><br><span class="line">--------------</span><br><span class="line">[root@nginx1 filebeat]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">      redis &#123;</span><br><span class="line">         data_type =&gt; "list"</span><br><span class="line">         host =&gt; "192.168.1.24"</span><br><span class="line">         port =&gt; "6379"</span><br><span class="line">         key =&gt; "nginx-accesslog-30"</span><br><span class="line">         db =&gt; "5"</span><br><span class="line">         password =&gt; "centos"</span><br><span class="line">         codec =&gt; "json"</span><br><span class="line">      &#125;</span><br><span class="line">      jdbc &#123;</span><br><span class="line">         driver_jar_path =&gt; "/usr/share/logstash/vendor/jar/jdbc/mysql-connector-java-8.0.14.jar"</span><br><span class="line">         # 插件路径 </span><br><span class="line">         connection_string =&gt; "jdbc:mysql://192.168.1.25:3306/elk?user=elk&amp;password=centos&amp;useUnic</span><br><span class="line">ode=true&amp;characterEncoding=UTF8"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据库地址、端口、用户名、密码等信息</span></span><br><span class="line">         statement =&gt; ["INSERT INTO elklog(host,clientip,url,status) VALUES(?,?,?,?)","http_host","clientip","url","status"]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最后四个引号(<span class="string">"http_host"</span>,<span class="string">"clientip"</span>,<span class="string">"url"</span>,<span class="string">"status"</span>)中的名称是从logstash中取得的字段名称，这四个引号是传入的变量</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置输出到数据库中</span></span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  mariadb</span><br><span class="line">--------------</span><br><span class="line">[root@mysql ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; use elk</span><br><span class="line">MariaDB [elk]&gt; select * from elklog;</span><br><span class="line">| 6000 | &#123;"containerized":true,"id":"3e6f1f53c66e409f81bc71d9331832af","architecture":"x86_64","os":&#123;"codename":"Core","family":"redhat","platform":"centos","version":"7 (Core)"&#125;,"name":"nginx1"&#125; | 192.168.1.30 | /test/index.html |   NULL | 2019-01-28 21:28:35 |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里保存的host有问题，需要将logstash中的statement最后的引号中的host改为http_host即可取得服务器地址了</span></span><br></pre></td></tr></table></figure>
<h3 id="删除els中索引的脚本"><a href="#删除els中索引的脚本" class="headerlink" title="删除els中索引的脚本"></a>删除els中索引的脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">DATE=`date -d "0 days ago" +%Y.%m.%d`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取今天的日期，如果想获取一个月前的日期，就使用30 days ago</span></span><br><span class="line">LOG_NAME="nginx-accesslog-30"</span><br><span class="line">FILE_NAME=$LOG_NAME-$DATE</span><br><span class="line">curl -XDELETE http://192.168.1.20:9200/$FILE_NAME</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">   echo "$&#123;FILE_NAME&#125; delete success."</span><br><span class="line">else</span><br><span class="line">   echo "$&#123;FILE_NAME&#125; delete error."</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不可直接从/elkdata/data/nodes/0/indices/目录中删除索引，会使els服务器运行出错</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/21/zookeeper-kafka部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/21/zookeeper-kafka部署/" itemprop="url">
                  zookeeper&kafka部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-21 14:51:45" itemprop="dateCreated datePublished" datetime="2019-01-21T14:51:45+08:00">2019-01-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-22 15:20:32" itemprop="dateModified" datetime="2019-01-22T15:20:32+08:00">2019-01-22</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/zookeeper-kafka/" itemprop="url" rel="index"><span itemprop="name">zookeeper&kafka</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="kafka配置文件說明"><a href="#kafka配置文件說明" class="headerlink" title="kafka配置文件說明"></a>kafka配置文件說明</h3><h4 id="Broker配置"><a href="#Broker配置" class="headerlink" title="Broker配置"></a>Broker配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> broker的全局唯一编号，不能重复</span></span><br><span class="line">broker.id=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用来监听链接的端口，producer或consumer将在此端口建立连接</span></span><br><span class="line">port=9092</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 处理网络请求的线程数量，也就是接收消息的线程数。接收线程会将接收到的消息放到内存中，然后再从内存中写入磁盘。</span></span><br><span class="line">num.network.threads=3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 消息从内存中写入磁盘时使用的线程数量。用来处理磁盘IO的线程数量</span></span><br><span class="line">num.io.threads=8</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送套接字的缓冲区大小</span></span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接受套接字的缓冲区大小</span></span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求套接字的缓冲区大小</span></span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> kafka运行日志存放的路径</span></span><br><span class="line">log.dirs=/export/servers/logs/kafka</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> topic在当前broker上的分片个数。每個partition的備份個數，默認為1，建議根據實際條件選擇；如果這個值較大，意味著消息在各個server上同步時需要的延遲較高</span></span><br><span class="line">num.partitions=2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们知道segment文件默认会被保留7天的时间，超时的话就会被清理，那么清理这件事情就需要有一些线程来做。这里就是用来设置恢复和清理data下数据的线程数量</span></span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> segment文件保留的最长时间，默认保留7天（168小时），超时将被删除，也就是说7天之前的数据将被清理掉。</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 滚动生成新的segment文件的最大时间</span></span><br><span class="line">log.roll.hours=168</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志文件中每个segment的大小，默认为1G</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">上面的参数设置了每一个segment文件的大小是1G，那么就需要有一个东西去定期检查segment文件有没有达到1G，多长时间去检查一次，就需要设置一个周期性检查文件大小的时间（单位是毫秒）。</span></span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志清理是否打开</span></span><br><span class="line">log.cleaner.enable=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> broker需要使用zookeeper保存meta数据，因此broker為zk client；此處為zookeeper集群的connectString，後面可以跟上path，比如hostname:port/chroot/kafka。不過需要注意，path的全路徑需要由自己來創建（使用zookeeper腳本工具）</span></span><br><span class="line">zookeeper.connect=zk01:2181,zk02:2181,zk03:2181</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper链接超时时间</span></span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面我们说过接收线程会将接收到的消息放到内存中，然后再从内存写到磁盘上，那么什么时候将消息从内存中写入磁盘，就有一个时间限制（时间阈值）和一个数量限制（数量阈值），这里设置的是数量阈值，下一个参数设置的则是时间阈值。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 为了减少磁盘写入的次数，broker会将消息暂时buffer起来，当消息的个数达到一定阀值或者过了一定的时间间隔时，再flush到磁盘，这样减少了磁盘IO调用的次数。</span></span><br><span class="line">log.flush.interval.messages=10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 消息buffer的时间，达到阈值，将触发将消息从内存flush到磁盘，单位是毫秒。</span></span><br><span class="line">log.flush.interval.ms=3000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除topic需要server.properties中设置delete.topic.enable=<span class="literal">true</span>否则只是标记删除</span></span><br><span class="line">delete.topic.enable=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此处的host.name为本机IP(重要),如果不改,则客户端会抛出：Producer connection to localhost:9092 unsuccessful 错误！指定broker實例綁定的網絡接口地址</span></span><br><span class="line">host.name=kafka01</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> partition leader等待follower同步消息的最大時間，如果超時，leader將follower移除同步列表</span></span><br><span class="line">replica.lag.time.max.ms=10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 允許follower落後的最大消息條數，如果達到閾值，將follower移除同步列表</span></span><br><span class="line"><span class="meta">#</span><span class="bash">replica.lag.max.message=4000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 消息的備份的個數，默認為1</span></span><br><span class="line">num.replica.fetchers=1</span><br><span class="line"></span><br><span class="line">advertised.host.name=192.168.239.128</span><br></pre></td></tr></table></figure>
<h4 id="Consumer主要配置"><a href="#Consumer主要配置" class="headerlink" title="Consumer主要配置"></a>Consumer主要配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 消费者集群通过连接Zookeeper来找到broker。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper连接服务器地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> consumer作為zookeeper client，需要通過zk保存一些meta信息，此處為zk connectString</span></span><br><span class="line">zookeeper.connect=zk01:2181,zk02:2181,zk03:2181</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper的session过期时间，默认5000ms，用于检测消费者是否挂掉</span></span><br><span class="line">zookeeper.session.timeout.ms=5000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当消费者挂掉，其他消费者要等该指定时间才能检查到并且触发重新负载均衡</span></span><br><span class="line">zookeeper.connection.timeout.ms=10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是一个时间阈值。指定多久消费者更新offset到zookeeper中。注意offset更新时基于time而不是每次获得的消息。一旦在更新zookeeper发生异常并重启，将可能拿到已拿到过的消息</span></span><br><span class="line">zookeeper.sync.time.ms=2000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 當前消費者的group名稱，需要指定</span></span><br><span class="line">group.id=xxxxx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是一个数量阈值，经测试是500条。当consumer消费一定量的消息之后,将会自动向zookeeper提交offset信息。注意offset信息并不是每消费一次消息就向zk提交一次,而是现在本地保存(内存),并定期提交,默认为<span class="literal">true</span></span></span><br><span class="line">auto.commit.enable=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 自动更新时间。默认60 * 1000</span></span><br><span class="line">auto.commit.interval.ms=60*1000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前consumer的标识,可以设定,也可以有系统生成，主要用来跟踪消息消费情况，便于观察</span></span><br><span class="line">conusmer.id=xxx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 消费者客户端编号，用于区分不同客户端，默认客户端程序自动产生</span></span><br><span class="line">client.id=xxxx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大取多少块缓存到消费者(默认10)</span></span><br><span class="line">queued.max.message.chunks=50</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当有新的consumer加入到group时,将会reblance，此后将会有partitions的消费端迁移到新的consumer上，如果一个consumer获得了某个partition的消费权限，那么它将会向zk注册 <span class="string">"Partition Owner registry"</span>节点信息，但是有可能此时旧的consumer尚没有释放此节点，此值用于控制，注册节点的重试次数。</span></span><br><span class="line">rebalance.max.retries=5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 每拉取一批消息的最大字节数。获取消息的最大尺寸，broker不会像consumer输出大于此值的消息chunk每次feth将得到多条消息，此值为总大小，提升此值,将会消耗更多的consumer端内存</span></span><br><span class="line">fetch.min.bytes=6553600</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当消息的尺寸不足时，server阻塞的时间，如果超时，消息将立即发送给consumer。数据一批一批到达，如果每一批是10条消息，如果某一批还不到10条，但是超时了，也会立即发送给consumer。</span></span><br><span class="line">fetch.wait.max.ms=5000</span><br><span class="line">socket.receive.buffer.bytes=655360</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果zookeeper没有offset值或offset值超出范围。那么就给个初始的offset。有smallest、largest、anything可选，分别表示给当前最小的offset、当前最大的offset、抛异常。默认largest</span></span><br><span class="line">auto.offset.reset=smallest</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定序列化处理类</span></span><br><span class="line">derializer.class=kafka.serializer.DefaultDecoder</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 獲取消息的最大尺寸，broker不會像consumer輸出大於此值的消息chunk。每次fetch將得到多條消息，此值為總大小</span></span><br><span class="line">fetch.messages.max.bytes=1024*1024</span><br></pre></td></tr></table></figure>
<h4 id="Producer主要配置"><a href="#Producer主要配置" class="headerlink" title="Producer主要配置"></a>Producer主要配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 指定kafka节点列表，用于获取metadata，不必全部指定</span></span><br><span class="line"><span class="meta">#</span><span class="bash">需要kafka的服务器地址，来获取每一个topic的分片数等元数据信息。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">對於開發者而言，需要通過broker.list指定當前producer需要關注的broker列表，producer通過和每個broker連接，並獲取partitions，如果某個broker連接失敗，將導致此上的partitions無法繼續發佈消息。格式：host1:port,host2:port，其中host:port需要參考broker配置文件。對於producer而言沒有使用zookeeper自動發現broker列表，非常奇怪。</span></span><br><span class="line">metadata.broker.list=kafka01:9092,kafka02:9092,kafka03:9092</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生产者生产的消息被发送到哪个block，需要一个分组策略。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">指定分区处理类。默认kafka.producer.DefaultPartitioner，表通过key哈希到对应分区</span></span><br><span class="line"><span class="meta">#</span><span class="bash">partitions路由類，消息在發送時將根據此實例的方法獲得partition索引號</span></span><br><span class="line"><span class="meta">#</span><span class="bash">partitioner.class=kafka.producer.DefaultPartitioner</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生产者生产的消息可以通过一定的压缩策略（或者说压缩算法）来压缩。消息被压缩后发送到broker集群，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">而broker集群是不会进行解压缩的，broker集群只会把消息发送到消费者集群，然后由消费者来解压缩。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">是否压缩，默认0表示不压缩，1表示用gzip压缩，2表示用snappy压缩。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">压缩后消息中会有头来指明消息压缩类型，故在消费者端消息解压是透明的无需指定。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">文本数据会以1比10或者更高的压缩比进行压缩。</span></span><br><span class="line">compression.codec=none</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">指定序列化处理类，消息在网络上传输就需要序列化，它有String、数组等许多种实现。將消息實體轉換成byte[]</span></span><br><span class="line">serializer.class=kafka.serializer.DefaultEncoder</span><br><span class="line">key.serializer.class=$&#123;serializer.class&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">如果要压缩消息，这里指定哪些topic要压缩消息，默认empty，表示不压缩。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果上面启用了压缩，那么这里就需要设置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">compressed.topics= </span></span><br><span class="line"><span class="meta">#</span><span class="bash">这是消息的确认机制，默认值是0。在面试中常被问到。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">producer有个ack参数，有三个值，分别代表：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">（1）不在乎是否写入成功；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">（2）写入leader成功；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">（3）写入leader和所有副本都成功；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">要求非常可靠的话可以牺牲性能设置成最后一种。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">为了保证消息不丢失，至少要设置为1，也就</span></span><br><span class="line"><span class="meta">#</span><span class="bash">是说至少保证leader将消息保存成功。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">设置发送数据是否需要服务端的反馈,有三个值0,1,2，分别代表3种状态：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">0: producer不会等待broker发送ack。生产者只要把消息发送给broker之后，就认为发送成功了，这是第1种情况；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1: 当leader接收到消息之后发送ack。生产者把消息发送到broker之后，并且消息被写入到本地文件，才认为发送成功，这是第二种情况；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2: 当所有的follower都同步消息成功后发送ack。不仅是主的分区将消息保存成功了，而且其所有的分区的副本数也都同步好了，才会被认为发动成功，这是第3种情况。</span></span><br><span class="line">request.required.acks=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">broker必须在该时间范围之内给出反馈，否则失败。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">在向producer发送ack之前,broker允许等待的最大时间 ，如果超时,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">broker将会向producer发送一个error ACK.意味着上一次消息因为某种原因</span></span><br><span class="line"><span class="meta">#</span><span class="bash">未能成功(比如follower未能同步成功)</span></span><br><span class="line">request.timeout.ms=10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生产者将消息发送到broker，有两种方式，一种是同步，表示生产者发送一条，broker就接收一条；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">还有一种是异步，表示生产者积累到一批的消息，装到一个池子里面缓存起来，再发送给broker，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">这个池子不会无限缓存消息，在下面，它分别有一个时间限制（时间阈值）和一个数量限制（数量阈值）的参数供我们来设置。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">一般我们会选择异步。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">同步还是异步发送消息，默认“sync”表同步，<span class="string">"async"</span>表异步。异步可以提高发送吞吐量,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">也意味着消息将会在本地buffer中,并适时批量发送，但是也可能导致丢失未发送过去的消息</span></span><br><span class="line">producer.type=sync</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在async模式下,当message被缓存的时间超过此值后,将会批量发送给broker,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">默认为5000ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">此值和batch.num.messages协同工作.</span></span><br><span class="line">queue.buffering.max.ms = 5000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">异步情况下，缓存中允许存放消息数量的大小。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">在async模式下,producer端允许buffer的最大消息量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">无论如何,producer都无法尽快的将消息发送给broker,从而导致消息在producer端大量沉积</span></span><br><span class="line"><span class="meta">#</span><span class="bash">此时,如果消息的条数达到阀值,将会导致producer端阻塞或者消息被抛弃，默认为10000条消息。</span></span><br><span class="line">queue.buffering.max.messages=20000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">如果是异步，指定每次批量发送数据量，默认为200</span></span><br><span class="line"><span class="meta">#</span><span class="bash">消息在producer端buffer的條數，僅在producer.type=async下有效</span></span><br><span class="line">batch.num.messages=500</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在生产端的缓冲池中，消息发送出去之后，在没有收到确认之前，该缓冲池中的消息是不能被删除的，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">但是生产者一直在生产消息，这个时候缓冲池可能会被撑爆，所以这就需要有一个处理的策略。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">有两种处理方式，一种是让生产者先别生产那么快，阻塞一下，等会再生产；另一种是将缓冲池中的消息清空。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">当消息在producer端沉积的条数达到<span class="string">"queue.buffering.max.meesages"</span>后阻塞一定时间后,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">队列仍然没有enqueue(producer仍然没有发送出任何消息)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">此时producer可以继续阻塞或者将消息抛弃,此timeout值用于控制<span class="string">"阻塞"</span>的时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-1: 不限制阻塞超时时间，让produce一直阻塞,这个时候消息就不会被抛弃</span></span><br><span class="line"><span class="meta">#</span><span class="bash">0: 立即清空队列,消息被抛弃</span></span><br><span class="line">queue.enqueue.timeout.ms=-1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">当producer接收到error ACK,或者没有接收到ACK时,允许消息重发的次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash">因为broker并没有完整的机制来避免消息重复,所以当网络异常时(比如ACK丢失)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">有可能导致broker接收到重复的消息,默认值为3.</span></span><br><span class="line">message.send.max.retries=3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">producer刷新topic metada的时间间隔,producer需要知道partition leader</span></span><br><span class="line"><span class="meta">#</span><span class="bash">的位置,以及当前topic的情况</span></span><br><span class="line"><span class="meta">#</span><span class="bash">因此producer需要一个机制来获取最新的metadata,当producer遇到特定错误时,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">将会立即刷新</span></span><br><span class="line"><span class="meta">#</span><span class="bash">(比如topic失效,partition丢失,leader失效等),此外也可以通过此参数来配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">额外的刷新机制，默认值600000</span></span><br><span class="line">topic.metadata.refresh.interval.ms=60000</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上是关于kafka一些基础说明，在其中我们知道如果要kafka正常运行，必须配置zookeeper，否则无论是kafka集群还是客户端的生产者和消费者都无法正常的工作</p>
</blockquote>
<h3 id="zookeeper集群部署"><a href="#zookeeper集群部署" class="headerlink" title="zookeeper集群部署"></a>zookeeper集群部署</h3><blockquote>
<p>zookeeper是一个为分布式应用提供一致性服务的软件，它是开源的Hadoop项目的一个子项目，并根据google发表的一篇论文来实现的。zookeeper为分布式系统提供了高效且易于使用的协同服务，它可以为分布式应用提供相当多的服务，诸如统一命名服务，配置管理，状态同步和组服务等。zookeeper接口简单，我们不必过多地纠结在分布式系统编程难于处理的同步和一致性问题上，你可以使用zookeeper提供的现成(off-the-shelf)服务来实现分布式系统额配置管理，组管理，Leader选举等功能。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">準備三台主機，主機名分別為kafka1(10.5.5.19)、kafka2(10.5.5.24)、kafka3(10.5.5.155)。</span><br><span class="line"></span><br><span class="line">* kafka1</span><br><span class="line">到http://zookeeper.apache.org/releases.html去下载zookeeper</span><br><span class="line">yum install java-1.8.0-openjdk-deve</span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper依賴java</span></span><br><span class="line">tar -zxvf zookeeper-3.4.9.tar.gz -C /usr/local</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解壓安裝</span></span><br><span class="line">cd /usr/local</span><br><span class="line">ln -sv zookeeper-3.4.9 zookeeper</span><br><span class="line">cd zookeeper/conf</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vim zoo.cfg</span><br><span class="line">	tickTime=2000</span><br><span class="line">    initLimit=10</span><br><span class="line">    syncLimit=5</span><br><span class="line">    dataDir=/usr/local/zookeeper/data</span><br><span class="line">    dataLogDir=/usr/local/zookeeper/logs</span><br><span class="line">    clientPort=2181</span><br><span class="line">    server.1=10.5.5.19:2888:3888</span><br><span class="line">    server.2=10.5.5.24:2888:3888</span><br><span class="line">    server.3=10.5.5.155:2888:3888</span><br><span class="line"><span class="meta">#</span><span class="bash"> tickTime：这个时间是作为Zookeeper服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每个 tickTime 时间就会发送一个心跳。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dataDir：顾名思义就是 Zookeeper保存数据的目录，默认情况下，Zookeeper将写数据的日志文件也保存在这个目录里。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> clientPort：这个端口就是客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> initLimit：这个配置项是用来配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 5个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5*2000=10 秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> syncLimit：这个配置项标识 Leader 与Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是5*2000=10 秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server.A=B：C：D：其中 A 是一个数字，表示这个是第几号服务器；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意：dataDir,dataLogDir中的wwb是当前登录用户名，data，logs目录开始是不存在，需要使用mkdir命令创建相应的目录。并且在该目录下创建文件myid。serve1,server2,server3该文件内容分别为1,2,3。</span></span><br><span class="line">cd /usr/local/zookeeper</span><br><span class="line">mkdir &#123;data,logs&#125;</span><br><span class="line">cd data</span><br><span class="line">echo 1 &gt; myid</span><br><span class="line">cd</span><br><span class="line">scp zookeeper-3.4.9.tar.gz 10.5.5.24:/root</span><br><span class="line">scp zookeeper-3.4.9.tar.gz 10.5.5.155:/root</span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">	export JAVA_HOME=/usr</span><br><span class="line">chmod +x /etc/profile.d/java.sh</span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line">java -version</span><br><span class="line">scp /etc/profile.d/java.sh 10.5.5.24:/etc/profile.d</span><br><span class="line">scp /etc/profile.d/java.sh 10.5.5.155:/etc/profile.d</span><br><span class="line"></span><br><span class="line">* kafka2&amp;kafka3</span><br><span class="line">yum install java-1.8.0-openjdk-deve</span><br><span class="line">cd /root</span><br><span class="line">tar xf zookeeper-3.4.9.tar.gz -C /usr/local/</span><br><span class="line">cd /usr/local/</span><br><span class="line">ln -sv zookeeper-3.4.9 zookeeper</span><br><span class="line">cd zookeeper</span><br><span class="line">mkdir &#123;data,logs&#125;</span><br><span class="line">cd data/</span><br><span class="line">echo 2 &gt; myid</span><br><span class="line"><span class="meta">#</span><span class="bash"> kafka3這裡改為<span class="built_in">echo</span> 3 &gt; myid</span></span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line">* 三台主機</span><br><span class="line">cd /usr/local/zookeeper/bin</span><br><span class="line">./zkServer.sh start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 啟動zookeeper</span></span><br><span class="line">ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這時只有leader節點會監聽2888端口，另外兩台是不監聽的。三台主機都會監聽2181和3888端口</span></span><br><span class="line">./zkCli.sh -server 10.5.5.19:2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這裡如果連接的是本機的zookeeper可以不用參數和地址，連接集群中其他zookeeper需要。</span></span><br></pre></td></tr></table></figure>
<h3 id="kafka集群部署"><a href="#kafka集群部署" class="headerlink" title="kafka集群部署"></a>kafka集群部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">使用生產環境kafka包，版本：kafka_2.12-0.10.2.0。三台主機的操作相同</span><br><span class="line"></span><br><span class="line">cd /root</span><br><span class="line">tar xf kafka_2.12-0.10.2.0.tgz -C /usr/local</span><br><span class="line">cd /usr/local</span><br><span class="line">ln -sv kafka_2.12-0.10.2.0 kafka</span><br><span class="line">cd kafka/config/</span><br><span class="line">vim server.properties</span><br><span class="line">	broker.id=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 三台主機這裡的id是不台一樣的，分別為1、2、3</span></span><br><span class="line">    num.network.threads=3</span><br><span class="line">    num.io.threads=8</span><br><span class="line">    socket.send.buffer.bytes=102400</span><br><span class="line">    socket.receive.buffer.bytes=102400</span><br><span class="line">    socket.request.max.bytes=104857600</span><br><span class="line">    log.dirs=/usr/local/kafka/logs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這裡改了日誌地址</span></span><br><span class="line">    num.partitions=1</span><br><span class="line">    num.recovery.threads.per.data.dir=1</span><br><span class="line">    log.retention.hours=168</span><br><span class="line">    log.segment.bytes=1073741824</span><br><span class="line">    log.retention.check.interval.ms=300000</span><br><span class="line">    zookeeper.connect=10.5.5.19:2181,10.5.5.24:2181,10.5.5.155:2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper集群內的所有地址都寫入</span></span><br><span class="line">    zookeeper.connection.timeout.ms=6000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件基本使用默認配置，之後會再查看配置文件詳細設置</span></span><br><span class="line">mkdir /usr/local/kafka/logs</span><br><span class="line">cd /usr/local/kafka/bin</span><br><span class="line">nohup ./kafka-server-start.sh ../config/server.properties &amp;</span><br><span class="line">ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這時應該監聽了默認端口9092</span></span><br></pre></td></tr></table></figure>
<h3 id="zookeeper命令"><a href="#zookeeper命令" class="headerlink" title="zookeeper命令"></a>zookeeper命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">./zkServer.sh start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 啟動zookeeper</span></span><br><span class="line">./zkServer.sh status</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看當前zookeeper是leader還是follower</span></span><br><span class="line">./zkServer.sh stop</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止zookeeper</span></span><br><span class="line">./zkCli.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper客戶端，連接當前主機上的zookeeper</span></span><br><span class="line">./zkCli.sh -server IP:port</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接远端服务</span></span><br><span class="line">[root@kafka3 zookeeper]# bin/zkCli.sh </span><br><span class="line">Connecting to localhost:2181</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /</span><br><span class="line">[cluster, controller, controller_epoch, brokers, zookeeper, admin, isr_change_notification, consumers, config]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] ls /brokers</span><br><span class="line">[ids, topics, seqid]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] ls /brokers/topics</span><br><span class="line">[test]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 3] ls /brokers/ids   </span><br><span class="line">[0, 1, 2]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 7] get /brokers/ids/0</span><br><span class="line">&#123;"listener_security_protocol_map":&#123;"PLAINTEXT":"PLAINTEXT"&#125;,"endpoints":["PLAINTEXT://192.168.1.14:9092"],"jmx_port":-1,"host":"192.168.1.14","timestamp":"1548120711670","port":9092,"version":4&#125;</span><br><span class="line">cZxid = 0x10000001c</span><br><span class="line">ctime = Tue Jan 22 09:31:51 CST 2019</span><br><span class="line">mZxid = 0x10000001c</span><br><span class="line">mtime = Tue Jan 22 09:31:51 CST 2019</span><br><span class="line">pZxid = 0x10000001c</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x2687326f51f0000</span><br><span class="line">dataLength = 194</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure>
<h3 id="kafka命令"><a href="#kafka命令" class="headerlink" title="kafka命令"></a>kafka命令</h3><h4 id="創建topic"><a href="#創建topic" class="headerlink" title="創建topic"></a>創建topic</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka1 bin]# ./kafka-topics.sh --create --zookeeper 192.168.1.14:2181 --replication-factor 1 --partitions 3 --topic test</span><br><span class="line">Created topic "test".</span><br><span class="line"><span class="meta">#</span><span class="bash"> 創建topic，--create表示創建，--zookeeper指明zookeeper地址，--topic指定topic名稱，--replication-factor指定副本的數量，--partitions指定分區的數量。--<span class="keyword">if</span>-not-exists表示如果topic不存在就創建。創建的副本的數量不能大於broker，不然會有錯誤提示“Error <span class="keyword">while</span> executing topic <span class="built_in">command</span> : replication factor: 4 larger than available brokers: 2”</span></span><br><span class="line">[root@kafka3 kafka]# ls logs/</span><br><span class="line">cleaner-offset-checkpoint  log-cleaner.log                   server.log.2019-01-22-09</span><br><span class="line">controller.log             meta.properties                   state-change.log</span><br><span class="line">kafka-authorizer.log       recovery-point-offset-checkpoint  test-0</span><br><span class="line">kafka-request.log          replication-offset-checkpoint     test-3</span><br><span class="line">kafkaServer-gc.log         server.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在创建topic后，可以在/usr/<span class="built_in">local</span>/kafka/logs目录查看到分区的目录</span></span><br></pre></td></tr></table></figure>
<h4 id="查看topic"><a href="#查看topic" class="headerlink" title="查看topic"></a>查看topic</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka1 bin]# ./kafka-topics.sh --list --zookeeper localhost:2181</span><br><span class="line">test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看所有的topic</span></span><br><span class="line">[root@kafka1 bin]# ./kafka-topics.sh --describe --zookeeper 192.168.1.15:2181 --topic test</span><br><span class="line">Topic:test      PartitionCount:3        ReplicationFactor:1     Configs:</span><br><span class="line">        Topic: test     Partition: 0    Leader: 2       Replicas: 2     Isr: 2</span><br><span class="line">        Topic: test     Partition: 1    Leader: 0       Replicas: 0     Isr: 0</span><br><span class="line">        Topic: test     Partition: 2    Leader: 1       Replicas: 1     Isr: 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看指定topic情況。列出了lx_test_topic的parition数量、replica因子以及每个partition的leader、replica信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PartitionCount：topic对应的partition的个数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ReplicationFactor：topic对应的副本因子，说白就是副本个数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Partition：partition编号，从0开始递增</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Leader：当前partition起作用的breaker.id</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Replicas: 当前副本数据坐在的breaker.id，是一个列表，排在最前面的起作用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Isr：当前kakfa集群中可用的breaker.id列表</span></span><br></pre></td></tr></table></figure>
<h4 id="增加topic分區"><a href="#增加topic分區" class="headerlink" title="增加topic分區"></a>增加topic分區</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka1 bin]# ./kafka-topics.sh --zookeeper localhost:2181 --alter --topic test --partitions 4</span><br><span class="line">WARNING: If partitions are increased for a topic that has a key, the partition logic or ordering of the messages will be affected</span><br><span class="line">Adding partitions succeeded!</span><br><span class="line"><span class="meta">#</span><span class="bash"> 給現有的topic添加分區，使用--alter選項，在命令中不能加--replication-factor選項，不然會報錯。另外，分区的数量只能增加</span></span><br></pre></td></tr></table></figure>
<h4 id="創建生產者"><a href="#創建生產者" class="headerlink" title="創建生產者"></a>創建生產者</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka1 bin]# ./kafka-console-producer.sh --broker-list 192.168.1.15:9092,192.168.1.13:9092 --topic test</span><br><span class="line">abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 創建生產者，這時終端會等待用戶輸入信息</span></span><br></pre></td></tr></table></figure>
<h4 id="創建消費者"><a href="#創建消費者" class="headerlink" title="創建消費者"></a>創建消費者</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka2 bin]# ./kafka-console-consumer.sh --zookeeper 192.168.1.14:2181 --topic test --from-beginning</span><br><span class="line">Using the ConsoleConsumer with old consumer is deprecated and will be removed in a future major release. Consider using the new consumer by passing [bootstrap-server] instead of [zookeeper].</span><br><span class="line">abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 創建消費者，創建後終端會等待生產者生產消息。在生產者終端輸入信息後，消費者終端會顯示生產者輸入的消息，這表示消費者消費了。如果有多個地址，地址間要用逗號隔開。</span></span><br></pre></td></tr></table></figure>
<h4 id="查看消費者列表"><a href="#查看消費者列表" class="headerlink" title="查看消費者列表"></a>查看消費者列表</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">查看consumer group列表有新、旧两种命令，分别查看新版(信息保存在broker中)consumer列表和老版(信息保存在zookeeper中)consumer列表，因而需要区分指定bootstrap--server和zookeeper参数：</span><br><span class="line">[root@kafka3 bin]# ./kafka-consumer-groups.sh --new-consumer --bootstrap-server 127.0.0.1:9092 --list</span><br><span class="line">Note: This will only show information about consumers that use the Java consumer API (non-ZooKeeper-based consumers).</span><br><span class="line">[root@kafka3 bin]# ./kafka-consumer-groups.sh --zookeeper 127.0.0.1:2181 --list</span><br><span class="line">Note: This will only show information about consumers that use ZooKeeper (not those using the Java consumer API).</span><br><span class="line"></span><br><span class="line">console-consumer-6777</span><br><span class="line">--------------------------------------------</span><br><span class="line">bin/kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --broker-info --group inbound --topic inboundMsg --zookeeper 192.168.2.182:2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> 结果中的Lag是待消费的数量</span></span><br><span class="line">watch '/usr/local/kafka/bin/kafka-consumer-groups.sh --new-consumer --bootstrap-server 192.168.2.182:9092 --group inbound --describe'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果是多个分区，用此命令</span></span><br><span class="line">--------------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看特定consumer group 详情，使用--group与--describe参数</span></span><br></pre></td></tr></table></figure>
<h4 id="查看kafka日誌"><a href="#查看kafka日誌" class="headerlink" title="查看kafka日誌"></a>查看kafka日誌</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./kafka-run-class.sh kafka.tools.DumpLogSegments</span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们可以看到都需要哪些参数，根据不同的需求我们可以选择不同的参数。</span></span><br><span class="line">[root@kafka3 bin]# ./kafka-run-class.sh kafka.tools.DumpLogSegments --files /usr/local/kafka/logs/test-0/00000000000000000000.log --print-data-log</span><br><span class="line">Dumping /usr/local/kafka/logs/test-0/00000000000000000000.log</span><br><span class="line">Starting offset: 0</span><br><span class="line">offset: 0 position: 0 CreateTime: 1548121485387 isvalid: true payloadsize: 3 magic: 1 compresscodec: NONE crc: 3938834414 payload: abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里--<span class="built_in">print</span>-data-log 是表示查看消息内容的，不加此项是查看不到详细的消息内容。如果要查看多个<span class="built_in">log</span>文件可以用逗号分隔。</span></span><br></pre></td></tr></table></figure>
<h4 id="刪除topic"><a href="#刪除topic" class="headerlink" title="刪除topic"></a>刪除topic</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim server.properties</span><br><span class="line">	delete.topic.enable=true</span><br><span class="line">kill -9 kafka</span><br><span class="line">zkServer.sh restart</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置文件後要重啟zookeeper和kafka</span></span><br><span class="line">zkCli.sh</span><br><span class="line">rmr /brokers/topic/topic-name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 進入zookeeper中再刪除topic</span></span><br></pre></td></tr></table></figure>
<h3 id="kafka测试"><a href="#kafka测试" class="headerlink" title="kafka测试"></a>kafka测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 测试生产者</span><br><span class="line">[root@kafka1 kafka]# bin/kafka-topics.sh --create --zookeeper localhost:2181 --topic test-rep-one --partitions 6 --replication-factor 1      </span><br><span class="line">Created topic "test-rep-one".</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个六分区一个副本的topic</span></span><br><span class="line">[root@kafka1 kafka]# bin/kafka-producer-perf-test.sh --num-records 500000 --throughput 100000 --record-size 3000 --topic testtest-rep-one --producer-props bootstrap.servers=192.168.1.14:9092,192.168.1.15:9092,192.168.1.13:9092</span><br><span class="line">...</span><br><span class="line">51490 records sent, 10298.0 records/sec (29.46 MB/sec), 997.3 ms avg latency, 1031.0 max latency.</span><br><span class="line">52075 records sent, 10415.0 records/sec (29.80 MB/sec), 982.8 ms avg latency, 1019.0 max latency.</span><br><span class="line">500000 records sent, 10366.131774 records/sec (29.66 MB/sec), 971.63 ms avg latency, 1033.00 ms max latency, 988 ms 50th, 1014 ms 95th, 1022 ms 99th, 1028 ms 99.9th.</span><br><span class="line"><span class="meta">#</span><span class="bash"> --num-records：要生成的消息数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --throughput：将最大消息吞吐量限制为*大约*吞吐量消息/秒，也就是每秒发送多少条数据</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --record-size：消息大小（字节）。注意，您必须只提供一个--record-size或--payload文件。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --topic：指定主题</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --producer-props：kafka生产者相关的配置属性，如bootstrap。 servers，client.id等。这些配置优先于通过--producer.config传递的配置。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bootstrap.servers：指定kafka地址与端口</span></span><br></pre></td></tr></table></figure>
<h3 id="附錄"><a href="#附錄" class="headerlink" title="附錄"></a>附錄</h3><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">Kafka <span class="keyword">is</span> a distributed,partitioned,replicated commit logservice</span><br><span class="line">卡夫卡是一个分布式的，分区的，复制提交的日志服务</span><br><span class="line">distributed<span class="comment">[dɪ'strɪbjʊtɪd]</span>	adj. 分布式的，分散式的</span><br><span class="line">partitioned adj. 分割的；分区的；分段的</span><br><span class="line">replicated 重复的</span><br><span class="line">topic n. 主题（等于theme）；题目；</span><br><span class="line">partition n. 划分，分开；<span class="comment">[数]</span> 分割；隔墙；隔离物</span><br><span class="line">append 添加；附加</span><br><span class="line">offset 偏移</span><br><span class="line">anatomy <span class="keyword">of</span> a topic</span><br><span class="line">解剖一个主题</span><br><span class="line">anatomy<span class="comment">[ə'nætəmɪ]</span>	n. 解剖；解剖学；剖析；骨骼</span><br><span class="line">consumer n. 消费者；用户，顾客</span><br><span class="line">producer<span class="comment">[prə'djuːsə]</span> n. 制作人，制片人；生产者；发生器</span><br><span class="line">replica<span class="comment">['replɪkə]</span> n. 复制品，复制物</span><br><span class="line">queue<span class="comment">[kjuː]</span> n. 队列；长队；辫子</span><br><span class="line">guarantee<span class="comment">[,ɡærən'ti]</span> n. 保证；担保；保证人；保证书；抵押品</span><br><span class="line">replication factor 複製因子</span><br><span class="line">factor<span class="comment">['fæktə]</span> n. 因素；要素；<span class="comment">[物]</span> 因数；代理人</span><br><span class="line">Websit activity tracking 網絡活動追蹤</span><br><span class="line">activity<span class="comment">[ækˈtɪvətɪ]</span> n. 活动；行动；活跃</span><br><span class="line">Log Aggregation 日誌收集</span><br><span class="line">aggregation<span class="comment">[,æɡrɪ'ɡeɪʃən]</span> n. <span class="comment">[地质]</span><span class="comment">[数]</span> 聚合，聚集；聚集体，集合体</span><br><span class="line">fetch<span class="comment">[fetʃ]</span> vi. 拿；取物；</span><br><span class="line">push<span class="comment">[pʊʃ]</span> n. 推</span><br><span class="line">pull<span class="comment">[pʊl]</span> n. 拉</span><br><span class="line">batch fetch 批量獲取</span><br><span class="line">batch<span class="comment">[bætʃ]</span> n. 一批</span><br><span class="line">provider<span class="comment">[prə'vaɪdə]</span> n. 供应者；养家者</span><br><span class="line">exactly once 恰一次</span><br><span class="line">exactly<span class="comment">[ɪɡ'zæktli]</span>  adv. 恰好地；正是；精确地；正确地</span><br><span class="line">at most once 最多一次</span><br><span class="line">at least once 至少一次</span><br><span class="line">up to date 最新的</span><br><span class="line">log entry　日誌條目</span><br><span class="line">entry<span class="comment">[ˈentrɪ]</span> n. 进入；入口；条目；登记；报关手续；对土地的侵占</span><br><span class="line">segment<span class="comment">['segm(ə)nt]</span> n. 段；部分</span><br><span class="line">chunk<span class="comment">[tʃʌŋk]</span> 數據塊</span><br><span class="line">copy on write 寫入時複製</span><br><span class="line">meta<span class="comment">['metə]</span> 元</span><br><span class="line">Broker node registry Broker節點註冊</span><br><span class="line">registry<span class="comment">['redʒɪstrɪ]</span> n. 注册；登记处；挂号处；船舶的国籍</span><br><span class="line">stream<span class="comment">[striːm]</span> n. 溪流；流动；潮流；光线</span><br><span class="line">balance<span class="comment">['bæl(ə)ns]</span> n. 平衡；余额；匀称</span><br><span class="line">off the shelf 現成的</span><br><span class="line">shelf<span class="comment">[ʃelf]</span> n. 架子；搁板；搁板状物；暗礁</span><br><span class="line">chubby<span class="comment">['tʃʌbɪ]</span> adj. 圆胖的，丰满的 <span class="comment">[ 比较级 chubbier 最高级 chubbiest ]</span></span><br><span class="line">election<span class="comment">[ɪ'lekʃ(ə)n]</span> n. 选举；当选；选择权；上帝的选拔</span><br><span class="line">discovery<span class="comment">[dɪ'skʌv(ə)rɪ]</span> n. 发现，发觉；被发现的事物</span><br><span class="line">broadcast<span class="comment">['brɔːdkɑːst]</span> n. 广播；播音；广播节目</span><br><span class="line">random<span class="comment">['rændəm]</span> adj. <span class="comment">[数]</span> 随机的；任意的；胡乱的</span><br><span class="line">controller<span class="comment">[kən'trəʊlə]</span>	n. 控制器；管理员</span><br><span class="line">proposal<span class="comment">[prəˈpəuzəl]</span> n. 提议;建议; 求婚; 〈美〉投标;</span><br><span class="line">epoch<span class="comment">[ˈi:pɔk]</span> n. 纪元;时期;新时代;世;</span><br><span class="line">failover<span class="comment">[feɪl'əʊvər]</span> n.</span><br><span class="line"><span class="comment">[电脑]</span><span class="comment">[数据库]</span>失效备援 （为系统备援能力的一种，当系统中其中一项设备失效而无法运作时，另一项设备即可自动接手原失效系统所执行的工作）</span><br><span class="line">persist<span class="comment">[pəˈsist]</span> v. 坚持;   固执;   存留;   继续存在; </span><br><span class="line">ephemeral<span class="comment">[ɪˈfemərəl]</span> adj. 短暂的，瞬息的;   朝露;   一年生;   朝生暮死;</span><br><span class="line">sequence<span class="comment">[ˈsi:kwəns]</span>	n. <span class="comment">[数]</span>数列，序列;   顺序;   连续;   片断插曲; </span><br><span class="line">split brain<span class="comment">[split]</span><span class="comment">[brein]</span> 脑裂</span><br><span class="line">split n. 划分;   分歧;   裂缝;   劈叉; </span><br><span class="line">brain n. 脑;   智慧;   聪明的人;   （群体中）最聪明的人;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/21/kafka概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/21/kafka概念/" itemprop="url">
                  kafka概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-21 08:49:36" itemprop="dateCreated datePublished" datetime="2019-01-21T08:49:36+08:00">2019-01-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-22 10:06:32" itemprop="dateModified" datetime="2019-01-22T10:06:32+08:00">2019-01-22</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/zookeeper-kafka/" itemprop="url" rel="index"><span itemprop="name">zookeeper&kafka</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h3><blockquote>
<p> Kafka is a distributed，partitioned，replicated commit logservice。它提供了类似于JMS的特性，但是在设计实现上完全不同，此外它并不是JMS规范的实现。kafka对消息保存时根据Topic进行归类，发送消息者稱为Producer，消息接受者稱为Consumer，此外kafka集群由多个kafka实例组成，每个实例(server)稱为broker。无论是kafka集群，还是producer和consumer都依赖于zookeeper来保证系统可用性，zookeeper集群保存一些meta(元數據)信息。</p>
</blockquote>
<p><img src="/images/kafka/介绍.png" alt=""></p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="消息队列（Message-Queue）"><a href="#消息队列（Message-Queue）" class="headerlink" title="消息队列（Message Queue）"></a>消息队列（Message Queue）</h4><blockquote>
<ul>
<li>消息 Message<br>网络中的两台计算机或者两个通讯设备之间传递的数据。例如说：文本、音乐、视频等内容。</li>
<li>队列 Queue<br>一种特殊的线性表（数据元素首尾相接），特殊之处在于只允许在首部删除元素和在尾部追加元素。入队、出队。</li>
<li>消息队列 MQ<br>消息+队列，保存消息的队列。消息的传输过程中的容器；主要提供生产、消费接口供外部调用做数据的存储和获取。</li>
</ul>
</blockquote>
<h4 id="MQ分类"><a href="#MQ分类" class="headerlink" title="MQ分类"></a>MQ分类</h4><blockquote>
<p>MQ主要分为两类：点对点(p2p)、发布订阅(Pub/Sub)</p>
<ul>
<li><p>共同点：<br>消息生产者生产消息发送到queue中，然后消息消费者从queue中读取并且消费消息。</p>
</li>
<li><p>不同点：<br>p2p模型包括：消息队列(Queue)、发送者(Sender)、接收者(Receiver)<br>一个生产者生产的消息只有一个消费者(Consumer)(即一旦被消费，消息就不在消息队列中)。比如说打电话。</p>
<p>Pub/Sub包含：消息队列(Queue)、主题(Topic)、发布者(Publisher)、订阅者(Subscriber)<br>每个消息可以有多个消费者，彼此互不影响。比如我发布一个微博：关注我的人都能够看到。<br>那么在大数据领域呢，为了满足日益增长的数据量，也有一款可以满足百万级别消息的生成和消费，分布式、持久稳定的产品——Kafka。</p>
</li>
</ul>
</blockquote>
<h4 id="Kafka组件"><a href="#Kafka组件" class="headerlink" title="Kafka组件"></a>Kafka组件</h4><blockquote>
<ul>
<li>Topic：主题，Kafka处理的消息的不同分类。</li>
<li>Broker：消息代理，Kafka集群中的一个kafka服务节点称为一个broker，主要存储消息数据。存在硬盘中。每个topic都是有分区的。</li>
<li>Partition：Topic物理上的分组，一个topic在broker中被分为1个或者多个partition，分区在创建topic的时候指定。</li>
<li>Message：消息，是通信的基本单位，每个消息都属于一个partition</li>
<li>Producer：消息和数据的生产者，向Kafka的一个topic发布消息。</li>
<li>Consumer：消息和数据的消费者，定于topic并处理其发布的消息。</li>
<li>Zookeeper：协调kafka的正常运行。</li>
</ul>
</blockquote>
<h4 id="Topics-logs"><a href="#Topics-logs" class="headerlink" title="Topics/logs"></a><strong>Topics/logs</strong></h4><blockquote>
<p> 一个Topic可以认为是一类消息，每个topic将被分成多个partition(分区)，每个partition在存储层面是append log文件。任何发布到此partition的消息都会被直接追加到log文件的尾部，每条消息在文件中的位置称为offset（偏移量），offset为一个long型数字，它唯一的标记一条消息。kafka并没有提供其他额外的索引机制来存储offset，因为在kafka中几乎不允许对消息进行“随机读写”。</p>
</blockquote>
<p><img src="/images/kafka/topics_logs.png" alt=""></p>
<blockquote>
<p>kafka和JMS（Java Message Service）实现(activeMQ)不同的是：即使消息被消费,消息仍然不会被立即删除。日志文件将会根据broker中的配置要求，保留一定的时间之后删除；比如log文件保留2天，那么两天后,文件会被清除，无论其中的消息是否被消费。kafka通过这种简单的手段，来释放磁盘空间，以及减少消息消费之后对文件内容改动的磁盘IO开支。</p>
<p>对于consumer而言，它需要保存消费消息的offset，对于offset的保存和使用，由consumer来控制；当consumer正常消费消息时，offset将会”线性”的向前驱动，即消息将依次顺序被消费。事实上consumer可以使用任意顺序消费消息，它只需要将offset重置为任意值。(offset将会保存在zookeeper中)</p>
<p>kafka集群几乎不需要维护任何consumer和producer状态信息，这些信息由zookeeper保存；因此producer和consumer的客户端实现非常轻量级，它们可以随意离开，而不会对集群造成额外的影响。</p>
<p>partitions的设计目的有多个。最根本原因是kafka基于文件存储。通过分区，可以将日志内容分散到多个server上，来避免文件尺寸达到单机磁盘的上限，每个partiton都会被当前server(kafka实例)保存；可以将一个topic切分為任意多个partitions，来提高消息保存/消费的效率。此外越多的partitions意味着可以容纳更多的consumer，有效提升并发消费的能力。</p>
</blockquote>
<h4 id="Distribution"><a href="#Distribution" class="headerlink" title="Distribution"></a>Distribution</h4><blockquote>
<p> 一个Topic的多个partitions，被分布在kafka集群中的多个server上；每个server(kafka实例)负责partitions中消息的读写操作；此外kafka还可以配置partitions需要备份的个数(replicas)，每个partition将会被备份到多台机器上，以提高可用性。</p>
<p> 基于replicated方案，那么就意味着需要对多个备份进行调度；每个partition都有一个server为”leader”；leader负责所有的读写操作，如果leader失效，那么将会有其他follower来接管(成为新的leader)；follower只是单调的和leader跟进，同步消息即可。由此可见作为leader的server承载了全部的请求压力，因此从集群的整体考虑，有多少个partitions就意味着有多少个”leader”，kafka会将”leader”均衡的分散在每个实例上，来确保整体的性能稳定。</p>
<ul>
<li><p>Producers</p>
<p>Producer将消息发布到指定的Topic中，同时Producer也能决定将此消息归属于哪个partition；比如基于”round-robin”方式或者通过其他的一些算法等。</p>
</li>
<li><p>Consumers</p>
<p>本质上kafka只支持Topic。每个consumer属于一个consumer group；反过来说，每个group中可以有多个consumer。发送到Topic的消息，只会被订阅此Topic的每个group中的一个consumer消费。</p>
<p>如果所有的consumer都具有相同的group，这种情况和queue模式很像；消息将会在consumers之间负载均衡。</p>
<p>如果所有的consumer都具有不同的group，那这就是”发布-订阅”；消息将会广播给所有的消费者。</p>
<p>在kafka中，一个partition中的消息只会被group中的一个consumer消费；每个group中consumer消息消费互相独立；我们可以认为一个group是一个”订阅”者，因為一个Topic中的每个partions，只会被一个”订阅者”中的一个consumer消费，不过一个consumer可以消费多个partitions中的消息。kafka只能保证一个partition中的消息被某个consumer消费时，消息是顺序的。事实上，从Topic角度来说，消息仍不是有序的。</p>
<p>kafka的设计原理决定，对于一个topic，同一个group中不能有多于partitions个数的consumer同时消费，否则将意味着某些consumer将无法得到消息。partition與consumer的數量最好相等。</p>
</li>
<li><p>Guarantees</p>
</li>
</ul>
<ol>
<li>发送到partitions中的消息将会按照它接收的顺序追加到日志中</li>
<li>对于消费者而言，它们消费消息的顺序和日志中消息顺序一致。</li>
<li>如果Topic的“replication factor”为N,那么允许N-1个kafka实例失效。</li>
</ol>
</blockquote>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><blockquote>
<ol>
<li>Messaging<br>对于一些常规的消息系统，kafka是个不错的选择；partitons/replication和容错，可以使kafka具有良好的扩展性和性能优势。不过到目前为止，我们应该很清楚认识到，kafka并没有提供JMS中的”事务性””消息传输担保(消息确认机制)””消息分组”等企业级特性；kafka只能使用作为”常规”的消息系统，在一定程度上，尚未确保消息的发送与接收绝对可靠(比如消息重发，消息发送丢失等)</li>
<li>Websit activity tracking<br>kafka可以作为”网站活動跟踪”的最佳工具；可以将网页/用户操作等信息发送到kafka中。并实时监控，或者离线统计分析等</li>
<li>Log Aggregation<br>kafka的特性决定它非常适合作为”日志收集中心”；application可以将操作日志”批量””异步”的发送到kafka集群中，而不是保存在本地或者DB中；kafka可以批量提交消息/压缩消息等，这对producer端而言，几乎感觉不到性能的开支。此时consumer端可以使用hadoop等其他系统化的存储和分析系统。</li>
</ol>
</blockquote>
<h3 id="设计原理"><a href="#设计原理" class="headerlink" title="设计原理"></a>设计原理</h3><blockquote>
<p> kafka的设计初衷是希望作为一个统一的信息收集平台，能够实时的收集反馈信息，并需要能够支撑较大的数据量，且具备良好的容错能力。</p>
</blockquote>
<h4 id="持久性"><a href="#持久性" class="headerlink" title="持久性"></a>持久性</h4><blockquote>
<p> kafka使用文件存储消息，这就直接决定kafka在性能上严重依赖文件系统的本身特性。且无论任何OS下，对文件系统本身的优化几乎没有可能。文件缓存/直接内存映射等是常用的手段。因为kafka是对日志文件进行append操作，因此磁盘检索的开支是较小的；同时为了减少磁盘写入的次数，broker会将消息暂时buffer起来，当消息的个数(或尺寸)达到一定閾值时，再flush到磁盘，这样减少了磁盘IO调用的次数。</p>
</blockquote>
<h4 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h4><blockquote>
<p>需要考虑的影响性能点很多，除磁盘IO之外，我们还需要考虑网络IO，这直接关系到kafka的吞吐量问题。kafka并没有提供太多高超的技巧；对于producer端，可以将消息buffer起来，当消息的条数达到一定閾值时，批量发送给broker；对于consumer端也是一样，批量fetch多条消息。不过消息量的大小可以通过配置文件来指定。对于kafka broker端，似乎有个sendfile系统调用[^註釋]可以潜在的提升网络IO的性能。将文件的数据映射到系统内存中，socket直接读取相应的内存区域即可，而无需进程再次copy和交换。 其实对于producer/consumer/broker三者而言，CPU的开支应该都不大，因此启用消息压缩机制是一个良好的策略；压缩需要消耗少量的CPU资源，不过对于kafka而言，网络IO更应该需要考虑。可以将任何在网络上传输的消息都经过压缩。kafka支持gzip/snappy等多种压缩方式。</p>
</blockquote>
<h4 id="生產者"><a href="#生產者" class="headerlink" title="生產者"></a>生產者</h4><blockquote>
<p>负载均衡：producer将会和Topic下所有partition leader保持socket连接；消息由producer直接通过socket发送到broker，中间不会经过任何”路由层”。事实上，消息被路由到哪个partition上，由producer客户端决定。比如可以采用”random””key-hash””轮询”等方式，如果一个topic中有多个partitions，那么在producer端实现”消息均衡分发”是必要的。</p>
<p>其中partition leader的位置(host:port)注册在zookeeper中，producer作为zookeeper client，已经注册了watch用来监听partition leader的变更事件。</p>
<p>异步发送：将多条消息暂且在客户端buffer起来，并将他们批量的发送到broker，小数据IO太多，会拖慢整体的网络延迟，批量延迟发送事实上提升了网络效率。不过这也有一定的隐患，比如说当producer失效时，那些尚未发送的消息将会丢失。</p>
</blockquote>
<h4 id="消費者"><a href="#消費者" class="headerlink" title="消費者"></a>消費者</h4><blockquote>
<p>consumer端向broker发送”fetch”请求，并告知其获取消息的offset；此后consumer将会获得一定条数的消息；consumer端也可以重置offset来重新消费消息。</p>
<p>在JMS实现中，Topic模型基于push方式，即broker将消息推送给consumer端。不过在kafka中，采用了pull方式，即consumer在和broker建立连接之后，主动去pull(或者说fetch)消息；这種模式有些优点，首先consumer端可以根据自己的消费能力适时的去fetch消息并处理，且可以控制消息消费的进度(offset)；此外，消费者可以良好的控制消息消费的数量，batch fetch（批量獲取）.</p>
<p>其他JMS实现，消息消费的位置是由provider保留，以便避免重复发送消息或者将没有消费成功的消息重发等，同时还要控制消息的状态。这就要求JMS broker需要太多额外的工作。在kafka中，partition中的消息只有一个consumer在消费，且不存在消息状态的控制，也没有复杂的消息确认机制，可见kafka broker端是相当轻量级的。当消息被consumer接收之后，consumer可以在本地保存最后消費的offset，并间歇性的向zookeeper注册offset。由此可见，consumer客户端也很轻量级。</p>
</blockquote>
<p><img src="/images/kafka/消费者.png" alt=""></p>
<h4 id="消息傳送機制"><a href="#消息傳送機制" class="headerlink" title="消息傳送機制"></a>消息傳送機制</h4><blockquote>
<p>对于JMS实现，消息传输担保非常直接，有且只有一次(exactly once)。在kafka中稍有不同：</p>
<ol>
<li>at most once：最多一次，这个和JMS中”非持久化”消息类似。发送一次，无论成败，将不会重发。</li>
<li>at least once：消息至少发送一次，如果消息未能接受成功，可能会重发，直到接收成功。</li>
<li>exactly once：消息只会发送一次。</li>
</ol>
<ul>
<li>at most once：消费者fetch消息，然后保存offset，然后处理消息；当client保存offset之后，但是在消息处理过程中出现了异常，导致部分消息未能继续处理。那么此后”未处理”的消息将不能被fetch到，这就是”at most once”。</li>
<li>at least once：消费者fetch消息，然后处理消息，然后保存offset。如果消息处理成功之后，但是在保存offset阶段zookeeper异常导致保存操作未能执行成功，这就导致接下来再次fetch时可能获得上次已经处理过的消息，这就是”at least once”，原因offset没有及时的提交给zookeeper，zookeeper恢复正常还是之前offset状态。</li>
<li><p>exactly once：kafka中并没有严格的去实现(基于2阶段提交,事务)，我们认为这种策略在kafka中是没有必要的。</p>
<p>通常情况下”at-least-once”是我们首选(相比at most once而言，重复接收数据总比丢失数据要好)。</p>
</li>
</ul>
</blockquote>
<h4 id="複製備份"><a href="#複製備份" class="headerlink" title="複製備份"></a>複製備份</h4><blockquote>
<p>kafka将每个partition数据复制到多个server上，任何一个partition都有一个leader和多个follower(可以没有)；备份的个数可以通过broker配置文件来设定。leader处理所有的read-write请求，follower需要和leader保持同步。Follower和consumer一样，消费消息并保存在本地日志中；leader负责跟踪所有的follower状态，如果follower”落后”太多或者失效，leader将会把它从replicas同步列表中删除。当所有的follower都将一条消息保存成功，此消息才被认为是”committed”，那么此时consumer才能消费它。即使只有一个replicas实例存活,仍然可以保证消息的正常发送和接收，只要zookeeper集群存活即可。(不同于其他分布式存储，比如hbase需要”多数派”存活才行)<br>当leader失效时，需在followers中选取出新的leader，可能此时follower落后于leader，因此需要选择一个”up-to-date”的follower。选择follower时需要兼顾一个问题，就是新leaderserver上已经承载的partition leader的个数，如果一个server上有过多的partition leader，意味着此server将承受着更多的IO压力。在选举新leader，需要考虑到”负载均衡”。</p>
</blockquote>
<h4 id="日誌"><a href="#日誌" class="headerlink" title="日誌"></a>日誌</h4><blockquote>
<p>如果一个topic的名称为”my_topic”，它有2个partitions，那么日志将会保存在my_topic_0和my_topic_1两个目录中；日志文件中保存了一序列”log entries”(日志条目)，每个log entry格式为”4个字节的数字，N表示消息的长度” + “N个字节的消息内容”；每个日志都有一个offset来唯一的标记一条消息，offset的值为8个字节的数字，表示此消息在此partition中所处的起始位置。**每个partition在物理存储层面有多个log file组成(称为segment)。segmentfile的命名为”最小offset”.kafka(log)。例如”00000000000.kafka(log)”；其中”最小offset”表示此segment中起始消息的offset。</p>
</blockquote>
<p><img src="/images/kafka/日志.png" alt=""></p>
<blockquote>
<p>其中每个partiton中所持有的segments列表信息会存储在zookeeper中。</p>
<p>当segment文件尺寸达到一定閾值时(可以通过配置文件设定，默认1G)，将会创建一个新的文件；当buffer中消息的条数达到閾值时将会触发日志信息flush到日志文件中，同时如果”距离最近一次flush的时间差”达到閾值时，也会触发flush到日志文件。如果broker失效，极有可能会丢失那些尚未flush到文件的消息。因为server意外仍然会导致log文件格式的破坏(文件尾部)，那么就要求当server启動時需要检测最后一个segment的文件结构是否合法并进行必要的修复。</p>
<p>获取消息时，需要指定offset和最大chunk尺寸，offset用来表示消息的起始位置，chunk size用来表示最大获取消息的总长度(间接的表示消息的条数)。根据offset，可以找到此消息所在segment文件，然后根据segment的最小offset取差值，得到它在file中的相对位置，直接读取输出即可。</p>
<p>日志文件的删除策略非常简单，启动一个后台线程定期扫描log file列表，把保存时间超过閾值的文件直接删除(根据文件的创建时间)。为了避免删除文件时仍然有read操作(consumer消费)，采取copy-on-write方式。</p>
</blockquote>
<h4 id="分配"><a href="#分配" class="headerlink" title="分配"></a>分配</h4><blockquote>
<p>kafka使用zookeeper来存储一些meta信息，并使用了zookeeper watch机制来发现meta信息的变更并作出相应的动作(比如consumer失效，触发负载均衡等)</p>
<ol>
<li><p>Broker node registry：当一个kafkabroker启动后，首先会向zookeeper注册自己的节点信息(临时znode)，同时当broker和zookeeper断开连接时，此znode也会被删除。</p>
<p>格式： /broker/ids/[0…N]   –&gt;host:port，其中[0..N]表示broker id，每个broker的配置文件中都需要指定一个数字类型的id(全局不可重复)，znode的值为此broker的host:port信息。</p>
</li>
<li><p>Broker Topic Registry：当一个broker启动时，会向zookeeper注册自己持有的topic和partitions信息，仍然是一个临时znode。</p>
<p>格式： /broker/topics/[topic]/[0…N]，其中[0..N]表示partition索引号。</p>
</li>
<li><p>Consumer and Consumer group：每个consumer客户端被创建时，会向zookeeper注册自己的信息，此作用主要是为了”负载均衡”。</p>
<p>一个group中的多个consumer可以交错的消费一个topic的所有partitions；简而言之，保证此topic的所有partitions都能被此group所消费，且消费时为了性能考虑，让partition相对均衡的分散到每个consumer上。</p>
</li>
<li><p>Consumer id Registry： 每个consumer都有一个唯一的ID(host:uuid，可以通过配置文件指定，也可以由系统生成)，此id用来标记消费者信息。</p>
<p>格式：/consumers/[group_id]/ids/[consumer_id]</p>
<p>仍然是一个临时的znode，此节点的值为{“topic_name”:#streams…}，即表示此consumer目前所消费的topic + partitions列表。</p>
</li>
<li><p>Consumer offset Tracking：用来跟踪每个consumer目前所消费的partition中最大的offset。</p>
<p>格式：/consumers/[group_id]/offsets/[topic]/[broker_id-partition_id]–&gt;offset_value</p>
<p>此znode为持久节点，可以看出offset跟group_id有关，以表明当group中一个消费者失效，其他consumer可以继续消费。</p>
</li>
<li><p>Partition Owner registry：用来标记partition被哪个consumer消费。临时znode</p>
<p>格式：/consumers/[group_id]/owners/[topic]/[broker_id-partition_id]–&gt;consumer_node_id</p>
<p>当consumer启动时，所触发的操作：<br>A. 首先进行”Consumer id Registry”；<br>B. 然后在”Consumer id Registry”节点下注册一个watch用来监听当前group中其他consumer的”leave”和”join”；只要此znode path下节点列表变更，都会触发此group下consumer的负载均衡。(比如一个consumer失效，那么其他consumer接管partitions)。<br>C. 在”Broker id registry”节点下，注册一个watch用来监听broker的存活情况；如果broker列表变更，将会触发所有的groups下的consumer重新balance（在consumer間再平衡，重新分配？）。</p>
</li>
</ol>
</blockquote>
<p><img src="/images/kafka/分配.png" alt=""></p>
<blockquote>
<ol>
<li>Producer端使用zookeeper用来”发现”broker列表，以及和Topic下每个partition leader建立socket连接并发送消息。</li>
<li>Broker端使用zookeeper用来注册broker信息，以监测partitionleader存活性。</li>
<li>Consumer端使用zookeeper用来注册consumer信息，其中包括consumer消费的partition列表等，同时也用来发现broker列表，并和partition leader建立socket连接，并获取消息。</li>
</ol>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/18/zookeeper概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/18/zookeeper概念/" itemprop="url">
                  zookeeper概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-18 22:07:12" itemprop="dateCreated datePublished" datetime="2019-01-18T22:07:12+08:00">2019-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-21 14:50:17" itemprop="dateModified" datetime="2019-01-21T14:50:17+08:00">2019-01-21</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/zookeeper-kafka/" itemprop="url" rel="index"><span itemprop="name">zookeeper&kafka</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h3 id="分布式系統"><a href="#分布式系統" class="headerlink" title="分布式系統"></a>分布式系統</h3><blockquote>
<p>只要不是工作在同一節點的工作系統和應用，就可稱為分佈式系統。是一个硬件或软件组件分布在网络中的不同的计算机之上，彼此间仅通过消息传递进行通信和协作的系统。</p>
</blockquote>
<h3 id="分佈式系統特征"><a href="#分佈式系統特征" class="headerlink" title="分佈式系統特征"></a>分佈式系統特征</h3><blockquote>
<p>分布性、对等性、并发性、缺乏全局时钟、故障必然会发生 </p>
</blockquote>
<h3 id="分佈式系統典型问题"><a href="#分佈式系統典型问题" class="headerlink" title="分佈式系統典型问题"></a>分佈式系統典型问题</h3><blockquote>
<p>通信异常、网络分区、三态(成功、失败、超时)、节点故障</p>
</blockquote>
<h3 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h3><blockquote>
<ul>
<li>Consistency 一致性</li>
<li>Availability 可用性(指的是快速获取数据)</li>
<li>Tolerance of network Partition 分区容错性(分布式)</li>
</ul>
</blockquote>
<h3 id="BASE"><a href="#BASE" class="headerlink" title="BASE"></a>BASE</h3><blockquote>
<ul>
<li>基本可用（Basically Available）：用户都有一种愚蠢的期望，就是当他们把浏览器指向一个网页时，就会有某些信息出现。这是你期望发生的，即便系统的某些部分宕机了也一样。这听上去微不足道，事实却并非如此；有很多系统只要一台服务器宕了，整个系统就宕了。</li>
<li>可伸缩（Scalable/Soft-state ）：添加更多的服务器使得服务更多的客户成为可能。不是创建一个巨大的怪物服务器，而是添加更多的服务器，这更具有前瞻性，而且也通常更便宜。重申一下，这是用户的期望之一：信息不仅仅是出现，而且还要快速地出现。（注意这项用户期望不仅要求伸缩性，还同时要求性能。）</li>
<li>最终一致性（Eventually Consistent）：如果数据最终在所有副本出现的地方变为可用，这就足够了（如上一点所述，你可以有很多副本）。这里的期望是，信息要快速出现才会显得及时。 当你在Craigslist上发布一个广告，它不会马上出现在列表和搜索结果中，这不是太大的问题；但如果一个广告需要几天才出现，就没有人会去用那个网站了。</li>
</ul>
<p>BASE模型與ACID模型完全不同，牺牲高一致性，获得可用性或可靠性： Basically Available基本可用。支持分区失败(e.g. sharding碎片划分数据库) 。Soft state软状态，状态可以有一段时间不同步，异步。 Eventually consistent最终一致，最终数据是一致的就可以了，而不是實时一致。BASE思想的主要实现有：1.按功能划分数据库；2.sharding碎片。BASE思想主要强调基本的可用性，如果你需要高可用性，也就是纯粹的高性能，那么就要以一致性或容错性为牺牲，BASE思想的方案在性能上还是有潜力可挖的。</p>
</blockquote>
<h3 id="保证分布式系统的一致性多种协议"><a href="#保证分布式系统的一致性多种协议" class="headerlink" title="保证分布式系统的一致性多种协议"></a>保证分布式系统的一致性多种协议</h3><blockquote>
<ul>
<li>2PC：2 Phase-Commit（兩段式提交），请求和执行，所有節點的請求都到達了才會進入第二段提交</li>
<li>3PC：3 Phase-Commit（三段式提交）， CanCommit（發出請求）–&gt; PreCommit（預提交）–&gt; DoCommit（提交）</li>
<li>Paxos（帕克索斯）：Leslie Lamport，1990年提出</li>
</ul>
</blockquote>
<h3 id="分布式鎖服務"><a href="#分布式鎖服務" class="headerlink" title="分布式鎖服務"></a>分布式鎖服務</h3><blockquote>
<p>Google Chubby，分布式锁服务[^1]，GFS/BigTable都用到了chubby</p>
<p>提供分布式协作、元数据存储、Master选举等功能</p>
<p>分布式鎖服務的作用是允許各客戶端可以通過chubby進行同步彼此的操作，有一個公共的存儲或服務，各節點與這個公共存儲或服務通信，各節點按固定週期將自己的數據同步到這個公共存儲，在公共存儲上有數據節點，一個數據節點對應一個節點，如果節點故障，公共存儲上的數據節點也隨之移除，其他節點取不到這個節點的數據時，就認為這個節點不存在了。公共存儲還提供主節點選舉功能，為必免公共存儲故障，所以公共存儲也要高可用，另外公共存儲的高可用也會自己為自己提供所謂的分佈式協作服務。</p>
<p>HDFS/HBase, Zookeeper</p>
<p>zookeeper是一个开源的分布式协调服务，由知名互联网公司Yahoo创建，它是Chubby的开源实现；换句话讲，<strong>zk是一个典型的分布式数据一致性解决方案，分布式应用程序可以基于它实现数据的发布/订阅、负载均衡、名称服务、分布式协调/通知、集群管理、Master选举、分布式锁和分布式队列；</strong></p>
</blockquote>
<h2 id="Zookeeper基本概念"><a href="#Zookeeper基本概念" class="headerlink" title="Zookeeper基本概念"></a>Zookeeper基本概念</h2><blockquote>
<p>Zookeeper是一个分布式协调服务，可用于服务发现，分布式锁，分布式领导选举，配置管理等。<br>这一切的基础，都是Zookeeper提供了一个类似于Linux文件系统的树形结构（可认为是轻量级的内存文件系统，但只适合存少量信息，完全不适合存储大量文件或者大文件），同时提供了对于每个节点的监控与通知机制。</p>
</blockquote>
<h3 id="Zookeeper架构"><a href="#Zookeeper架构" class="headerlink" title="Zookeeper架构"></a>Zookeeper架构</h3><h4 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h4><blockquote>
<p>Zookeeper集群是一个基于主从复制的高可用集群，每个服务器承担如下三种角色中的一种</p>
<ul>
<li><strong>Leader</strong>：一个Zookeeper集群同一时间只会有一个实际工作的Leader，它会发起并维护与各Follwer及Observer间的心跳。所有的写操作必须要通过Leader完成再由Leader将写操作广播给其它服务器。</li>
<li><strong>Follower</strong>：一个Zookeeper集群可能同时存在多个Follower，它会响应Leader的心跳。Follower可直接处理并返回客户端的读请求，同时会将写请求转发给Leader处理，并且负责在Leader处理写请求时对请求进行投票。</li>
<li><strong>Observer</strong> 角色与Follower类似，但是无投票权。</li>
</ul>
</blockquote>
<p><img src="/images/zookeeper/角色.png" alt=""></p>
<h4 id="原子广播（ZAB）"><a href="#原子广播（ZAB）" class="headerlink" title="原子广播（ZAB）"></a>原子广播（ZAB）</h4><blockquote>
<p>为了保证写操作的一致性与可用性，Zookeeper专门设计了一种名为原子广播（ZAB）的支持崩溃恢复的一致性协议。基于该协议，Zookeeper实现了一种主从模式的系统架构来保持集群中各个副本之间的数据一致性。</p>
<p>根据ZAB协议，所有的写操作都必须通过Leader完成，Leader写入本地日志后再复制到所有的Follower节点。</p>
<p>一旦Leader节点无法工作，ZAB协议能够自动从Follower节点中重新选出一个合适的替代者，即新的Leader，该过程即为领导选举。该领导选举过程，是ZAB协议中最为重要和复杂的过程。</p>
</blockquote>
<h4 id="写操作"><a href="#写操作" class="headerlink" title="写操作"></a>写操作</h4><h5 id="写Leader"><a href="#写Leader" class="headerlink" title="写Leader"></a>写Leader</h5><blockquote>
<p>通过Leader进行写操作流程如下图所示</p>
</blockquote>
<p><img src="/images/zookeeper/写leader.png" alt=""></p>
<blockquote>
<p>由上图可见，通过Leader进行写操作，主要分为五步：</p>
<ol>
<li>客户端向Leader发起写请求</li>
<li>Leader将写请求以Proposal(建议;提议;)的形式发给所有Follower并等待ACK</li>
<li>Follower收到Leader的Proposal后返回ACK</li>
<li>Leader得到过半数的ACK（Leader对自己默认有一个ACK）后向所有的Follower和Observer发送Commmit</li>
<li>Leader将处理结果返回给客户端</li>
</ol>
<p>这里要注意</p>
<ul>
<li>Leader并不需要得到Observer的ACK，即Observer无投票权</li>
<li>Leader不需要得到所有Follower的ACK，只要收到过半的ACK即可，同时Leader本身对自己有一个ACK。上图中有4个Follower，只需其中两个返回ACK即可，因为(2+1) / (4+1) &gt; 1/2</li>
<li>Observer虽然无投票权，但仍须同步Leader的数据从而在处理读请求时可以返回尽可能新的数据</li>
</ul>
</blockquote>
<h5 id="写Follower-Observer"><a href="#写Follower-Observer" class="headerlink" title="写Follower/Observer"></a>写Follower/Observer</h5><blockquote>
<p>通过Follower/Observer进行写操作流程如下图所示：</p>
</blockquote>
<p><img src="/images/zookeeper/写follower_observer.png" alt=""></p>
<blockquote>
<p>从上图可见</p>
<ul>
<li>Follower/Observer均可接受写请求，但不能直接处理，而需要将写请求转发给Leader处理</li>
<li>除了多了一步请求转发，其它流程与直接写Leader无任何区别</li>
</ul>
</blockquote>
<h4 id="读操作"><a href="#读操作" class="headerlink" title="读操作"></a>读操作</h4><blockquote>
<p>Leader/Follower/Observer都可直接处理读请求，从本地内存中读取数据并返回给客户端即可。</p>
</blockquote>
<p><img src="/images/zookeeper/读操作.png" alt=""></p>
<blockquote>
<p>由于处理读请求不需要服务器之间的交互，Follower/Observer越多，整体可处理的读请求量越大，也即读性能越好。 </p>
</blockquote>
<h3 id="FastLeaderElection-快速领袖选举-原理"><a href="#FastLeaderElection-快速领袖选举-原理" class="headerlink" title="FastLeaderElection(快速领袖选举)原理"></a>FastLeaderElection(快速领袖选举)原理</h3><h4 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h4><h5 id="myid"><a href="#myid" class="headerlink" title="myid"></a>myid</h5><blockquote>
<p>每个Zookeeper服务器，都需要在数据文件夹下创建一个名为myid的文件，该文件包含整个Zookeeper集群唯一的ID（整数）。例如某Zookeeper集群包含三台服务器，hostname分别为zoo1、zoo2和zoo3，其myid分别为1、2和3，则在配置文件中其ID与hostname必须一一对应，如下所示。在该配置文件中，<code>server.</code>后面的数据即为myid</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.1=zoo1:2888:3888</span><br><span class="line">server.2=zoo2:2888:3888</span><br><span class="line">server.3=zoo3:2888:3888</span><br></pre></td></tr></table></figure>
<h5 id="zxid-事务ID"><a href="#zxid-事务ID" class="headerlink" title="zxid(事务ID)"></a>zxid(事务ID)</h5><blockquote>
<p>类似于RDBMS中的事务ID，用于标识一次更新操作的Proposal ID。为了保证顺序性，该zxid必须单调递增<a href="单调递增指只增加不会减小。">^2</a>。因此Zookeeper使用一个64位的数来表示，高32位是Leader的epoch，从1开始，每次选出新的Leader，epoch加一。低32位为该epoch内的序号，每次epoch变化，都将低32位的序号重置。这样保证了zxid的全局递增性。</p>
</blockquote>
<h4 id="支持的领导选举算法"><a href="#支持的领导选举算法" class="headerlink" title="支持的领导选举算法"></a>支持的领导选举算法</h4><blockquote>
<p>可通过<code>electionAlg</code>配置项设置Zookeeper用于领导选举的算法。</p>
<p>到3.4.10版本为止，可选项有</p>
<ul>
<li>0：基于UDP的LeaderElection</li>
<li>1：基于UDP的FastLeaderElection</li>
<li>2：基于UDP和认证的FastLeaderElection</li>
<li>3：基于TCP的FastLeaderElection</li>
</ul>
<p>在3.4.10版本中，默认值为3，也即基于TCP的FastLeaderElection。另外三种算法已经被弃用，并且有计划在之后的版本中将它们彻底删除而不再支持。</p>
</blockquote>
<h4 id="FastLeaderElection"><a href="#FastLeaderElection" class="headerlink" title="FastLeaderElection"></a>FastLeaderElection</h4><blockquote>
<p>FastLeaderElection选举算法是标准的Fast Paxos算法实现，可解决LeaderElection选举算法收敛速度慢的问题。</p>
</blockquote>
<h5 id="服务器状态"><a href="#服务器状态" class="headerlink" title="服务器状态"></a>服务器状态</h5><blockquote>
<ul>
<li><strong>LOOKING</strong> 不确定Leader状态。该状态下的服务器认为当前集群中没有Leader，会发起Leader选举</li>
<li><strong>FOLLOWING</strong> 跟随者状态。表明当前服务器角色是Follower，并且它知道Leader是谁</li>
<li><strong>LEADING</strong> 领导者状态。表明当前服务器角色是Leader，它会维护与Follower间的心跳</li>
<li><strong>OBSERVING</strong> 观察者状态。表明当前服务器角色是Observer，与Follower唯一的不同在于不参与选举，也不参与集群写操作时的投票</li>
</ul>
</blockquote>
<h5 id="选票数据结构"><a href="#选票数据结构" class="headerlink" title="选票数据结构"></a>选票数据结构</h5><blockquote>
<p>每个服务器在进行领导选举时，会发送如下关键信息</p>
<ul>
<li><strong>logicClock</strong> 每个服务器会维护一个自增的整数，名为logicClock，它表示这是该服务器发起的第多少轮投票</li>
<li><strong>state</strong> 当前服务器的状态</li>
<li><strong>self_id</strong> 当前服务器的myid</li>
<li><strong>self_zxid</strong> 当前服务器上所保存的数据的最大zxid</li>
<li><strong>vote_id</strong> 被推举的服务器的myid</li>
<li><strong>vote_zxid</strong> 被推举的服务器上所保存的数据的最大zxid</li>
</ul>
</blockquote>
<h5 id="投票流程"><a href="#投票流程" class="headerlink" title="投票流程"></a>投票流程</h5><h6 id="自增选举轮次"><a href="#自增选举轮次" class="headerlink" title="自增选举轮次"></a>自增选举轮次</h6><blockquote>
<p>Zookeeper规定所有有效的投票都必须在同一轮次中。每个服务器在开始新一轮投票时，会先对自己维护的logicClock进行自增操作。 </p>
</blockquote>
<h6 id="初始化选票"><a href="#初始化选票" class="headerlink" title="初始化选票"></a>初始化选票</h6><blockquote>
<p>每个服务器在广播自己的选票前，会将自己的投票箱清空。该投票箱记录了所收到的选票。例：服务器2投票给服务器3，服务器3投票给服务器1，则服务器1的投票箱为(2, 3), (3, 1), (1, 1)。票箱中只会记录每一投票者的最后一票，如投票者更新自己的选票，则其它服务器收到该新选票后会在自己票箱中更新该服务器的选票。 </p>
</blockquote>
<h6 id="发送初始化选票"><a href="#发送初始化选票" class="headerlink" title="发送初始化选票"></a>发送初始化选票</h6><blockquote>
<p>每个服务器最开始都是通过广播把票投给自己。</p>
</blockquote>
<h6 id="接收外部投票"><a href="#接收外部投票" class="headerlink" title="接收外部投票"></a>接收外部投票</h6><blockquote>
<p>服务器会尝试从其它服务器获取投票，并记入自己的投票箱内。如果无法获取任何外部投票，则会确认自己是否与集群中其它服务器保持着有效连接。如果是，则再次发送自己的投票；如果否，则马上与之建立连接。</p>
</blockquote>
<h6 id="判断选举轮次"><a href="#判断选举轮次" class="headerlink" title="判断选举轮次"></a>判断选举轮次</h6><blockquote>
<p>收到外部投票后，首先会根据投票信息中所包含的logicClock来进行不同处理</p>
<ul>
<li>外部投票的logicClock大于自己的logicClock。说明该服务器的选举轮次落后于其它服务器的选举轮次，立即清空自己的投票箱并将自己的logicClock更新为收到的logicClock，然后再对比自己之前的投票与收到的投票以确定是否需要变更自己的投票，最终再次将自己的投票广播出去。</li>
<li>外部投票的logicClock小于自己的logicClock。当前服务器直接忽略该投票，继续处理下一个投票。</li>
<li>外部投票的logickClock与自己的相等。当时进行选票PK。</li>
</ul>
</blockquote>
<h6 id="选票PK"><a href="#选票PK" class="headerlink" title="选票PK"></a>选票PK</h6><blockquote>
<p>选票PK是基于(self_id, self_zxid)与(vote_id, vote_zxid)的对比</p>
<ul>
<li>外部投票的logicClock大于自己的logicClock，则将自己的logicClock及自己的选票的logicClock变更为收到的logicClock</li>
<li>若logicClock一致，则对比二者的vote_zxid，若外部投票的vote_zxid比较大，则将自己的票中的vote_zxid与vote_myid更新为收到的票中的vote_zxid与vote_myid并广播出去，另外将收到的票及自己更新后的票放入自己的票箱。如果票箱内已存在(self_myid, self_zxid)相同的选票，则直接覆盖</li>
<li>若二者vote_zxid一致，则比较二者的vote_myid，若外部投票的vote_myid比较大，则将自己的票中的vote_myid更新为收到的票中的vote_myid并广播出去，另外将收到的票及自己更新后的票放入自己的票箱</li>
</ul>
</blockquote>
<h6 id="统计选票"><a href="#统计选票" class="headerlink" title="统计选票"></a>统计选票</h6><blockquote>
<p>如果已经确定有过半服务器认可了自己的投票（可能是更新后的投票），则终止投票。否则继续接收其它服务器的投票。</p>
</blockquote>
<h6 id="更新服务器状态"><a href="#更新服务器状态" class="headerlink" title="更新服务器状态"></a>更新服务器状态</h6><blockquote>
<p>投票终止后，服务器开始更新自身状态。若过半的票投给了自己，则将自己的服务器状态更新为LEADING，否则将自己的状态更新为FOLLOWING</p>
</blockquote>
<h4 id="几种领导选举场景"><a href="#几种领导选举场景" class="headerlink" title="几种领导选举场景"></a>几种领导选举场景</h4><h5 id="集群启动领导选举"><a href="#集群启动领导选举" class="headerlink" title="集群启动领导选举"></a>集群启动领导选举</h5><h6 id="初始投票给自己"><a href="#初始投票给自己" class="headerlink" title="初始投票给自己"></a>初始投票给自己</h6><blockquote>
<p>集群刚启动时，所有服务器的logicClock都为1，zxid都为0。</p>
<p>各服务器初始化后，都投票给自己，并将自己的一票存入自己的票箱，如下图所示。</p>
</blockquote>
<p><img src="/images/zookeeper/初始投票给自己.png" alt=""></p>
<blockquote>
<p>在上图中，(1, 1, 0)第一位数代表投出该选票的服务器的logicClock，第二位数代表被推荐的服务器的myid，第三位代表被推荐的服务器的最大的zxid。由于该步骤中所有选票都投给自己，所以第二位的myid即是自己的myid，第三位的zxid即是自己的zxid。  此时各自的票箱中只有自己投给自己的一票。 </p>
</blockquote>
<h6 id="更新选票"><a href="#更新选票" class="headerlink" title="更新选票"></a>更新选票</h6><blockquote>
<p>服务器收到外部投票后，进行选票PK，相应更新自己的选票并广播出去，并将合适的选票存入自己的票箱，如下图所示。 </p>
</blockquote>
<p><img src="/images/zookeeper/更新选票.png" alt=""></p>
<blockquote>
<p>服务器1收到服务器2的选票（1, 2, 0）和服务器3的选票（1, 3, 0）后，由于所有的logicClock都相等，所有的zxid都相等，因此根据myid判断应该将自己的选票按照服务器3的选票更新为（1, 3, 0），并将自己的票箱全部清空，再将服务器3的选票与自己的选票存入自己的票箱，接着将自己更新后的选票广播出去。此时服务器1票箱内的选票为(1, 3)，(3, 3)。  同理，服务器2收到服务器3的选票后也将自己的选票更新为（1, 3, 0）并存入票箱然后广播。此时服务器2票箱内的选票为(2, 3)，(3, 3)。  服务器3根据上述规则，无须更新选票，自身的票箱内选票仍为（3, 3）。  服务器1与服务器2更新后的选票广播出去后，由于三个服务器最新选票都相同，最后三者的票箱内都包含三张投给服务器3的选票。 </p>
</blockquote>
<h6 id="根据选票确定角色"><a href="#根据选票确定角色" class="headerlink" title="根据选票确定角色"></a>根据选票确定角色</h6><blockquote>
<p>根据上述选票，三个服务器一致认为此时服务器3应该是Leader。因此服务器1和2都进入FOLLOWING状态，而服务器3进入LEADING状态。之后Leader发起并维护与Follower间的心跳。</p>
</blockquote>
<p><img src="/images/zookeeper/根据选票确定角色.png" alt=""></p>
<h5 id="Follower重启"><a href="#Follower重启" class="headerlink" title="Follower重启"></a>Follower重启</h5><h6 id="Follower重启投票给自己"><a href="#Follower重启投票给自己" class="headerlink" title="Follower重启投票给自己"></a>Follower重启投票给自己</h6><blockquote>
<p>Follower重启，或者发生网络分区后找不到Leader，会进入LOOKING状态并发起新的一轮投票。</p>
</blockquote>
<p><img src="/images/zookeeper/follower重启投票给自己.png" alt=""></p>
<h6 id="发现已有Leader后成为Follower"><a href="#发现已有Leader后成为Follower" class="headerlink" title="发现已有Leader后成为Follower"></a>发现已有Leader后成为Follower</h6><blockquote>
<p>服务器3收到服务器1的投票后，将自己的状态LEADING以及选票返回给服务器1。服务器2收到服务器1的投票后，将自己的状态FOLLOWING及选票返回给服务器1。此时服务器1知道服务器3是Leader，并且通过服务器2与服务器3的选票可以确定服务器3确实得到了超过半数的选票。因此服务器1进入FOLLOWING状态。 </p>
</blockquote>
<p><img src="/images/zookeeper/发现已有leader后成为follower.png" alt=""></p>
<h5 id="Leader重启"><a href="#Leader重启" class="headerlink" title="Leader重启"></a>Leader重启</h5><h6 id="Follower发起新投票"><a href="#Follower发起新投票" class="headerlink" title="Follower发起新投票"></a>Follower发起新投票</h6><blockquote>
<p>Leader（服务器3）宕机后，Follower（服务器1和2）发现Leader不工作了，因此进入LOOKING状态并发起新的一轮投票，并且都将票投给自己。</p>
</blockquote>
<p><img src="/images/zookeeper/follower发起新投票.png" alt=""></p>
<h6 id="广播更新选票"><a href="#广播更新选票" class="headerlink" title="广播更新选票"></a>广播更新选票</h6><blockquote>
<p>服务器1和2根据外部投票确定是否要更新自身的选票。这里有两种情况</p>
<ul>
<li>服务器1和2的zxid相同。例如在服务器3宕机前服务器1与2完全与之同步。此时选票的更新主要取决于myid的大小</li>
<li>服务器1和2的zxid不同。在旧Leader宕机之前，其所主导的写操作，只需过半服务器确认即可，而不需所有服务器确认。换句话说，服务器1和2可能一个与旧Leader同步（即zxid与之相同）另一个不同步（即zxid比之小）。此时选票的更新主要取决于谁的zxid较大</li>
</ul>
<p>在上图中，服务器1的zxid为11，而服务器2的zxid为10，因此服务器2将自身选票更新为（3, 1, 11），如下图所示。</p>
</blockquote>
<p><img src="/images/zookeeper/广播更新选票.png" alt=""></p>
<h6 id="选出新Leader"><a href="#选出新Leader" class="headerlink" title="选出新Leader"></a>选出新Leader</h6><blockquote>
<p>经过上一步选票更新后，服务器1与服务器2均将选票投给服务器1，因此服务器2成为Follower，而服务器1成为新的Leader并维护与服务器2的心跳。</p>
</blockquote>
<p><img src="/images/zookeeper/选出新leader1.png" alt=""></p>
<h6 id="旧Leader恢复后发起选举"><a href="#旧Leader恢复后发起选举" class="headerlink" title="旧Leader恢复后发起选举"></a>旧Leader恢复后发起选举</h6><blockquote>
<p>旧的Leader恢复后，进入LOOKING状态并发起新一轮领导选举，并将选票投给自己。此时服务器1会将自己的LEADING状态及选票（3, 1, 11）返回给服务器3，而服务器2将自己的FOLLOWING状态及选票（3, 1, 11）返回给服务器3。如下图所示。 </p>
</blockquote>
<p><img src="/images/zookeeper/旧Leader恢复后发起选举.png" alt=""></p>
<h6 id="旧Leader成为Follower"><a href="#旧Leader成为Follower" class="headerlink" title="旧Leader成为Follower"></a>旧Leader成为Follower</h6><blockquote>
<p>服务器3了解到Leader为服务器1，且根据选票了解到服务器1确实得到过半服务器的选票，因此自己进入FOLLOWING状态。</p>
</blockquote>
<p><img src="/images/zookeeper/旧Leader成为Follower.png" alt=""></p>
<h3 id="一致性保证"><a href="#一致性保证" class="headerlink" title="一致性保证"></a>一致性保证</h3><blockquote>
<p>ZAB协议保证了在Leader选举的过程中，已经被Commit的数据不会丢失，未被Commit的数据对客户端不可见。 </p>
</blockquote>
<h4 id="Commit过的数据不丢失"><a href="#Commit过的数据不丢失" class="headerlink" title="Commit过的数据不丢失"></a>Commit过的数据不丢失</h4><h5 id="Failover前状态"><a href="#Failover前状态" class="headerlink" title="Failover前状态"></a><strong>Failover前状态</strong></h5><blockquote>
<p>为更好演示Leader Failover过程，本例中共使用5个Zookeeper服务器。A作为Leader，共收到P1、P2、P3三条消息，并且Commit了1和2，且总体顺序为P1、P2、C1、P3、C2。根据顺序性原则，其它Follower收到的消息的顺序肯定与之相同。其中B与A完全同步，C收到P1、P2、C1，D收到P1、P2，E收到P1，如下图所示。</p>
</blockquote>
<p><img src="/images/zookeeper/Failover前状态.png" alt=""></p>
<blockquote>
<p>这里要注意</p>
<ul>
<li>由于A没有C3，意味着收到P3的服务器的总个数不会超过一半，也即包含A在内最多只有两台服务器收到P3。在这里A和B收到P3，其它服务器均未收到P3</li>
<li>由于A已写入C1、C2，说明它已经Commit了P1、P2，因此整个集群有超过一半的服务器，即最少三个服务器收到P1、P2。在这里所有服务器都收到了P1，除E外其它服务器也都收到了P2</li>
</ul>
</blockquote>
<h5 id="选出新Leader-1"><a href="#选出新Leader-1" class="headerlink" title="选出新Leader"></a>选出新Leader</h5><blockquote>
<p>旧Leader也即A宕机后，其它服务器根据上述FastLeaderElection算法选出B作为新的Leader。C、D和E成为Follower且以B为Leader后，会主动将自己最大的zxid发送给B，B会将Follower的zxid与自身zxid间的所有被Commit过的消息同步给Follower，如下图所示。 </p>
</blockquote>
<p><img src="/images/zookeeper/选出新leader2.png" alt=""></p>
<blockquote>
<p>在上图中</p>
<ul>
<li>P1和P2都被A Commit，因此B会通过同步保证P1、P2、C1与C2都存在于C、D和E中</li>
<li>P3由于未被A Commit，同时幸存的所有服务器中P3未存在于大多数据服务器中，因此它不会被同步到其它Follower</li>
</ul>
</blockquote>
<h5 id="通知Follower可对外服务"><a href="#通知Follower可对外服务" class="headerlink" title="通知Follower可对外服务"></a>通知Follower可对外服务</h5><blockquote>
<p>同步完数据后，B会向D、C和E发送NEWLEADER命令并等待大多数服务器的ACK（下图中D和E已返回ACK，加上B自身，已经占集群的大多数），然后向所有服务器广播UPTODATE命令。收到该命令后的服务器即可对外提供服务。 </p>
</blockquote>
<p><img src="/images/zookeeper/通知Follower可对外服务.png" alt=""></p>
<h4 id="未Commit过的消息对客户端不可见"><a href="#未Commit过的消息对客户端不可见" class="headerlink" title="未Commit过的消息对客户端不可见"></a>未Commit过的消息对客户端不可见</h4><blockquote>
<p>在上例中，P3未被A Commit过，同时因为没有过半的服务器收到P3，因此B也未Commit P3（如果有过半服务器收到P3，即使A未Commit P3，B会主动Commit P3，即C3），所以它不会将P3广播出去。</p>
<p>具体做法是，B在成为Leader后，先判断自身未Commit的消息（本例中即P3）是否存在于大多数服务器中从而决定是否要将其Commit。然后B可得出自身所包含的被Commit过的消息中的最小zxid（记为min_zxid）与最大zxid（记为max_zxid）。C、D和E向B发送自身Commit过的最大消息zxid（记为max_zxid）以及未被Commit过的所有消息（记为zxid_set）。B根据这些信息作出如下操作</p>
<ul>
<li>如果Follower的max_zxid与Leader的max_zxid相等，说明该Follower与Leader完全同步，无须同步任何数据</li>
<li>如果Follower的max_zxid在Leader的(min_zxid，max_zxid)范围内，Leader会通过TRUNC命令通知Follower将其zxid_set中大于Follower的max_zxid（如果有）的所有消息全部删除</li>
</ul>
<p>上述操作保证了未被Commit过的消息不会被Commit从而对外不可见。</p>
<p>上述例子中Follower上并不存在未被Commit的消息。但可考虑这种情况，如果将上述例子中的服务器数量从五增加到七，服务器F包含P1、P2、C1、P3，服务器G包含P1、P2。此时服务器F、A和B都包含P3，但是因为票数未过半，因此B作为Leader不会Commit P3，而会通过TRUNC命令通知F删除P3。如下图所示。</p>
</blockquote>
<p><img src="/images/zookeeper/未Commit过的消息对客户端不可见.png" alt=""></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote>
<ul>
<li>由于使用主从复制模式，所有的写操作都要由Leader主导完成，而读操作可通过任意节点完成，因此Zookeeper读性能远好于写性能，更适合读多写少的场景</li>
<li>虽然使用主从复制模式，同一时间只有一个Leader，但是Failover机制保证了集群不存在单点失败（SPOF）的问题</li>
<li>ZAB协议保证了Failover过程中的数据一致性</li>
<li>服务器收到数据后先写本地文件再进行处理，保证了数据的持久性</li>
</ul>
</blockquote>
<h3 id="Zookeeper特点"><a href="#Zookeeper特点" class="headerlink" title="Zookeeper特点"></a>Zookeeper特点</h3><h4 id="Zookeeper节点类型"><a href="#Zookeeper节点类型" class="headerlink" title="Zookeeper节点类型"></a>Zookeeper节点类型</h4><blockquote>
<p>如上文《<a href="http://www.jasongj.com/zookeeper/fastleaderelection" target="_blank" rel="noopener">Zookeeper架构及FastLeaderElection机制</a>》所述，Zookeeper 提供了一个类似于 Linux 文件系统的树形结构。该树形结构中每个节点被称为 znode ，可按如下两个维度分类</p>
<ul>
<li><em>Persist vs. Ephemeral</em> (表示永久节点与临时节点)<ul>
<li><strong>Persist</strong>节点，一旦被创建，便不会意外丢失，即使服务器全部重启也依然存在。每个 Persist 节点即可包含数据，也可包含子节点</li>
<li><strong>Ephemeral</strong>节点，在创建它的客户端与服务器间的 Session 结束时自动被删除。服务器重启会导致 Session 结束，因此 Ephemeral 类型的 znode 此时也会自动删除</li>
</ul>
</li>
<li><em>Sequence vs. Non-sequence</em> （序列化与非序列化）<ul>
<li><strong>Non-sequence</strong>节点，多个客户端同时创建同一 Non-sequence 节点时，只有一个可创建成功，其它匀失败。并且创建出的节点名称与创建时指定的节点名完全一样</li>
<li><strong>Sequence</strong>节点，创建出的节点名在指定的名称之后带有10位10进制数的序号。多个客户端创建同一名称的节点时，都能创建成功，只是序号不同</li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="Zookeeper语义保证"><a href="#Zookeeper语义保证" class="headerlink" title="Zookeeper语义保证"></a>Zookeeper语义保证</h4><blockquote>
<p>Zookeeper 简单高效，同时提供如下语义保证，从而使得我们可以利用这些特性提供复杂的服务。</p>
<ul>
<li><strong>顺序性</strong>　客户端发起的更新会按发送顺序被应用到 Zookeeper 上</li>
<li><strong>原子性</strong> 更新操作要么成功要么失败，不会出现中间状态</li>
<li><strong>单一系统镜像</strong>　一个客户端无论连接到哪一个服务器都能看到完全一样的系统镜像（即完全一样的树形结构）。<strong>注：</strong>根据上文《<a href="http://www.jasongj.com/zookeeper/fastleaderelection" target="_blank" rel="noopener">Zookeeper架构及FastLeaderElection机制</a>》介绍的 ZAB 协议，写操作并不保证更新被所有的 Follower 立即确认，因此通过部分 Follower 读取数据并不能保证读到最新的数据，而部分 Follwer 及 Leader 可读到最新数据。如果一定要保证<strong>单一系统镜像</strong>，可在读操作前使用 sync 方法。</li>
<li><strong>可靠性</strong>　一个更新操作一旦被接受即不会意外丢失，除非被其它更新操作覆盖</li>
<li><strong>最终一致性</strong>　写操作最终（而非立即）会对客户端可见</li>
</ul>
</blockquote>
<h4 id="Zookeeper-Watch机制"><a href="#Zookeeper-Watch机制" class="headerlink" title="Zookeeper Watch机制"></a>Zookeeper Watch机制</h4><blockquote>
<p><strong>所有对 Zookeeper 的读操作，都可附带一个 Watch </strong>。一旦相应的数据有变化，该 Watch 即被触发。Watch 有如下特点</p>
<ul>
<li><strong>主动推送</strong>　Watch被触发时，由 Zookeeper 服务器主动将更新推送给客户端，而不需要客户端轮询。</li>
<li><strong>一次性</strong>　数据变化时，Watch 只会被触发一次。如果客户端想得到后续更新的通知，必须要在 Watch 被触发后重新注册一个 Watch。</li>
<li><strong>可见性</strong>　如果一个客户端在读请求中附带 Watch，Watch 被触发的同时再次读取数据，客户端在得到 Watch 消息之前肯定不可能看到更新后的数据。换句话说，更新通知先于更新结果。也就是先收到通知，才能看到结果。</li>
<li><strong>顺序性</strong>　如果多个更新触发了多个 Watch ，那 Watch 被触发的顺序与更新顺序一致。</li>
</ul>
</blockquote>
<h3 id="分布式锁与领导选举关键点"><a href="#分布式锁与领导选举关键点" class="headerlink" title="分布式锁与领导选举关键点"></a>分布式锁与领导选举关键点</h3><h4 id="最多一个获取锁-成为Leader"><a href="#最多一个获取锁-成为Leader" class="headerlink" title="最多一个获取锁 / 成为Leader"></a>最多一个获取锁 / 成为Leader</h4><blockquote>
<p>对于分布式锁（这里特指排它锁）而言，任意时刻，最多只有一个进程（对于单进程内的锁而言是单线程）可以获得锁。</p>
<p>对于领导选举而言，任意时间，最多只有一个成功当选为Leader。否则即出现脑裂（Split brain）</p>
</blockquote>
<h4 id="锁重入-确认自己是Leader"><a href="#锁重入-确认自己是Leader" class="headerlink" title="锁重入 / 确认自己是Leader"></a>锁重入 / 确认自己是Leader</h4><blockquote>
<p>对于分布式锁，需要保证获得锁的进程在释放锁之前可再次获得锁，即锁的可重入性。</p>
<p>对于领导选举，Leader需要能够确认自己已经获得领导权，即确认自己是Leader。</p>
</blockquote>
<h4 id="释放锁-放弃领导权"><a href="#释放锁-放弃领导权" class="headerlink" title="释放锁 / 放弃领导权"></a>释放锁 / 放弃领导权</h4><blockquote>
<p>锁的获得者应该能够正确释放已经获得的锁，并且当获得锁的进程宕机时，锁应该自动释放，从而使得其它竞争方可以获得该锁，从而避免出现死锁的状态。</p>
<p>领导应该可以主动放弃领导权，并且当领导所在进程宕机时，领导权应该自动释放，从而使得其它参与者可重新竞争领导而避免进入无主状态。</p>
</blockquote>
<h4 id="感知锁释放-领导权的放弃"><a href="#感知锁释放-领导权的放弃" class="headerlink" title="感知锁释放 / 领导权的放弃"></a>感知锁释放 / 领导权的放弃</h4><blockquote>
<p>当获得锁的一方释放锁时，其它对于锁的竞争方需要能够感知到锁的释放，并再次尝试获取锁。</p>
<p>原来的Leader放弃领导权时，其它参与方应该能够感知该事件，并重新发起选举流程。</p>
</blockquote>
<h3 id="非公平领导选举"><a href="#非公平领导选举" class="headerlink" title="非公平领导选举"></a>非公平领导选举</h3><blockquote>
<p>从上面几个方面可见，分布式锁与领导选举的技术要点非常相似，实际上其实现机制也相近。本章就以领导选举为例来说明二者的实现原理，分布式锁的实现原理也几乎一致。 </p>
</blockquote>
<h4 id="选主过程"><a href="#选主过程" class="headerlink" title="选主过程"></a>选主过程</h4><blockquote>
<p>假设有三个Zookeeper的客户端，如下图所示，同时竞争Leader。这三个客户端同时向Zookeeper集群注册<strong>Ephemeral</strong>且<strong>Non-sequence</strong>类型的节点，路径都为<code>/zkroot/leader</code>（工程实践中，路径名可自定义）。</p>
</blockquote>
<p><img src="/images/zookeeper/选主过程.png" alt=""></p>
<blockquote>
<p>如上图所示，由于是<strong>Non-sequence</strong>节点，这三个客户端只会有一个创建成功，其它节点均创建失败。此时，创建成功的客户端（即上图中的<code>Client 1</code>）即成功竞选为 Leader 。其它客户端（即上图中的<code>Client 2</code>和<code>Client 3</code>）此时匀为 Follower。 </p>
</blockquote>
<h4 id="放弃领导权"><a href="#放弃领导权" class="headerlink" title="放弃领导权"></a>放弃领导权</h4><blockquote>
<p>如果 Leader 打算主动放弃领导权，直接删除<code>/zkroot/leader</code>节点即可。</p>
<p>如果 Leader 进程意外宕机，其与 Zookeeper 间的 Session 也结束，该节点由于是<strong>Ephemeral</strong>类型的节点，因此也会自动被删除。</p>
<p>此时<code>/zkroot/leader</code>节点不复存在，对于其它参与竞选的客户端而言，之前的 Leader 已经放弃了领导权。</p>
</blockquote>
<h4 id="感知领导权的放弃"><a href="#感知领导权的放弃" class="headerlink" title="感知领导权的放弃"></a>感知领导权的放弃</h4><blockquote>
<p>由上图可见，创建节点失败的节点，除了成为 Follower 以外，还会向<code>/zkroot/leader</code>注册一个 Watch ，一旦 Leader 放弃领导权，也即该节点被删除，所有的 Follower 会收到通知。 </p>
</blockquote>
<h4 id="重新选举"><a href="#重新选举" class="headerlink" title="重新选举"></a>重新选举</h4><blockquote>
<p>感知到旧 Leader 放弃领导权后，所有的 Follower 可以再次发起新一轮的领导选举，如下图所示。 </p>
</blockquote>
<p><img src="/images/zookeeper/重新选举.png" alt=""></p>
<blockquote>
<p>从上图中可见</p>
<ul>
<li>新一轮的领导选举方法与最初的领导选举方法完全一样，都是发起节点创建请求，创建成功即为 Leader，否则为 Follower ，且 Follower 会 Watch 该节点</li>
<li>新一轮的选举结果，无法预测，与它们在第一轮选举中的顺序无关。这也是该方案被称为<code>非公平模式</code>的原因</li>
</ul>
</blockquote>
<h4 id="非公平模式总结"><a href="#非公平模式总结" class="headerlink" title="非公平模式总结"></a>非公平模式总结</h4><blockquote>
<ul>
<li>非公平模式实现简单，每一轮选举方法都完全一样</li>
<li>竞争参与方不多的情况下，效率高。每个 Follower 通过 Watch 感知到节点被删除的时间不完全一样，只要有一个 Follower 得到通知即发起竞选，即可保证当时有新的 Leader 被选出</li>
<li>给Zookeeper 集群造成的负载大，因此扩展性差。如果有上万个客户端都参与竞选，意味着同时会有上万个写请求发送给 Zookeper。如《<a href="http://www.jasongj.com/zookeeper/fastleaderelection/" target="_blank" rel="noopener">Zookeeper架构</a>》一文所述，Zookeeper 存在单点写的问题，写性能不高。同时一旦 Leader 放弃领导权，Zookeeper 需要同时通知上万个 Follower，负载较大。</li>
</ul>
</blockquote>
<h3 id="公平领导选举"><a href="#公平领导选举" class="headerlink" title="公平领导选举"></a>公平领导选举</h3><h4 id="选主过程-1"><a href="#选主过程-1" class="headerlink" title="选主过程"></a>选主过程</h4><blockquote>
<p>如下图所示，公平领导选举中，各客户端均创建<code>/zkroot/leader</code>节点，且其类型为<strong>Ephemeral</strong>与<strong>Sequence</strong>。</p>
</blockquote>
<p><img src="/images/zookeeper/公平选主过程.png" alt=""></p>
<blockquote>
<p>由于是<strong>Sequence</strong>类型节点，故上图中三个客户端均创建成功，只是序号不一样。此时，每个客户端都会判断自己创建成功的节点的序号是不是当前最小的。如果是，则该客户端为 Leader，否则即为 Follower。</p>
<p>在上图中，<code>Client 1</code>创建的节点序号为 1 ，<code>Client 2</code>创建的节点序号为 2，<code>Client 3</code>创建的节点序号为3。由于最小序号为 1 ，且该节点由<code>Client 1</code>创建，故<code>Client 1</code>为 Leader 。</p>
</blockquote>
<h4 id="放弃领导权-1"><a href="#放弃领导权-1" class="headerlink" title="放弃领导权"></a>放弃领导权</h4><blockquote>
<p>Leader 如果主动放弃领导权，直接删除其创建的节点即可。</p>
<p>如果 Leader 所在进程意外宕机，其与 Zookeeper 间的 Session 结束，由于其创建的节点为<strong>Ephemeral</strong>类型，故该节点自动被删除。</p>
</blockquote>
<h4 id="感知领导权的放弃-1"><a href="#感知领导权的放弃-1" class="headerlink" title="感知领导权的放弃"></a>感知领导权的放弃</h4><blockquote>
<p>与非公平模式不同，每个 Follower 并非都 Watch 由 Leader 创建出来的节点，而是 Watch 序号刚好比自己序号小的节点。</p>
<p>在上图中，总共有 1、2、3 共三个节点，因此<code>Client 2</code> Watch <code>/zkroot/leader1</code>，<code>Client 3</code> Watch <code>/zkroot/leader2</code>。（注：序号应该是10位数字，而非一位数字，这里为了方便，以一位数字代替）</p>
<p>一旦 Leader 宕机，<code>/zkroot/leader1</code>被删除，<code>Client 2</code>可得到通知。此时<code>Client 3</code>由于 Watch 的是<code>/zkroot/leader2</code>，故不会得到通知。</p>
</blockquote>
<h4 id="重新选举-1"><a href="#重新选举-1" class="headerlink" title="重新选举"></a>重新选举</h4><blockquote>
<p><code>Client 2</code>得到<code>/zkroot/leader1</code>被删除的通知后，不会立即成为新的 Leader 。而是先判断自己的序号 2 是不是当前最小的序号。在该场景下，其序号确为最小。因此<code>Client 2</code>成为新的 Leader 。</p>
</blockquote>
<p><img src="/images/zookeeper/公平重新选举.png" alt=""></p>
<p>这里要注意，如果在<code>Client 1</code>放弃领导权之前，<code>Client 2</code>就宕机了，<code>Client 3</code>会收到通知。此时<code>Client 3</code>不会立即成为Leader，而是要先判断自己的序号 3 是否为当前最小序号。很显然，由于<code>Client 1</code>创建的<code>/zkroot/leader1</code>还在，因此<code>Client 3</code>不会成为新的 Leader ，并向<code>Client 2</code>序号 2 前面的序号，也即 1 创建 Watch。该过程如下图所示。 </p>
<p><img src="/images/zookeeper/公平重新选举2.png" alt=""></p>
<h4 id="公平模式总结"><a href="#公平模式总结" class="headerlink" title="公平模式总结"></a>公平模式总结</h4><blockquote>
<ul>
<li>实现相对复杂</li>
<li>扩展性好，每个客户端都只 Watch 一个节点且每次节点被删除只须通知一个客户端</li>
<li>旧 Leader 放弃领导权时，其它客户端根据竞选的先后顺序（也即节点序号）成为新 Leader，这也是<code>公平模式</code>的由来</li>
<li>延迟相对非公平模式要高，因为它必须等待特定节点得到通知才能选出新的 Leader</li>
</ul>
</blockquote>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><blockquote>
<p>基于 Zookeeper 的领导选举或者分布式锁的实现均基于 Zookeeper 节点的特性及通知机制。充分利用这些特性，还可以开发出适用于其它场景的分布式应用。 </p>
</blockquote>
<h4 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h4><blockquote>
<ul>
<li>Leader：选举产生，读/写；</li>
<li>Follower：参与选举，可被选举，读服务；</li>
<li>Observer：参与选举，不可被选举，提供读服务；一般不需要Observer</li>
</ul>
</blockquote>
<h4 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h4><blockquote>
<p> ZK中，客户端要長期與服务端保持連接，使用TCP长连接；分佈式系統利用zk來進行協調，這個分佈式系統也可能是一個集群，如果想知道分佈式系統中其他節點的狀態，可以到zk上請求相應的信息。zk中的數據管理模型是倒置的樹狀結構。是在zk的內存中存放的樹狀文件系統，一個分佈式系統可以註冊使用一個樹狀文件系統的子節點。</p>
</blockquote>
<h4 id="数据节点-ZNode"><a href="#数据节点-ZNode" class="headerlink" title="数据节点(ZNode)"></a>数据节点(ZNode)</h4><blockquote>
<p> 即zk数据模型中的数据单元；zk的数据都存储于内存中，数据模型为树状结构(ZNode Tree)；每个ZNode都会保存自己的数据于内存中；znode有兩類：</p>
<ul>
<li>持久节点：仅显式删除才消失</li>
<li>临时节点：会话中止即自动消失</li>
</ul>
</blockquote>
<h4 id="版本（version）：ZK会为每个ZNode维护一个称之为Stat的数据结构，记录了当前ZNode的三个数据版本"><a href="#版本（version）：ZK会为每个ZNode维护一个称之为Stat的数据结构，记录了当前ZNode的三个数据版本" class="headerlink" title="版本（version）：ZK会为每个ZNode维护一个称之为Stat的数据结构，记录了当前ZNode的三个数据版本"></a>版本（version）：ZK会为每个ZNode维护一个称之为Stat的数据结构，记录了当前ZNode的三个数据版本</h4><blockquote>
<ul>
<li>version：当前版本</li>
<li>cversion：当前znode的子节点的版本</li>
<li>aversion：当前znode的ACL的版本</li>
</ul>
</blockquote>
<h4 id="ACL：ZK使用ACL机制进行权限控制"><a href="#ACL：ZK使用ACL机制进行权限控制" class="headerlink" title="ACL：ZK使用ACL机制进行权限控制"></a>ACL：ZK使用ACL机制进行权限控制</h4><blockquote>
<p> CREATE， READ，WRITE，DELETE，ADMIN</p>
</blockquote>
<h4 id="事件监听器-Watcher"><a href="#事件监听器-Watcher" class="headerlink" title="事件监听器(Watcher)"></a>事件监听器(Watcher)</h4><blockquote>
<p> ZK上，由用户指定的触发机制，在某些事件产生时，ZK能够将通知發给相关的客户端；</p>
</blockquote>
<h4 id="ZAB协议"><a href="#ZAB协议" class="headerlink" title="ZAB协议"></a>ZAB协议</h4><blockquote>
<p>Zookeeper Atomic Broadcast，ZK原子广播协议；用來支持崩潰恢復機制，保證在leader進程崩潰時重新選舉出新的leader，并且保證數據完整性，這指的是zk自己的leader分区，也包含基於zk所註冊的leader分區，如果不強調，就專指zk自己的。</p>
<p>根据ZAB协议，所有的写操作都必须通过Leader完成，Leader写入本地日志后再复制到所有的Follower节点。</p>
<p>一旦Leader节点无法工作，ZAB协议能够自动从Follower节点中重新选出一个合适的替代者，即新的Leader，该过程即为领导选举。该领导选举过程，是ZAB协议中最为重要和复杂的过程。</p>
<p>zk中所有事務請求都是由leader來處理的。當一個節點要寫某一數據時，寫操作是發給zk的leader的，leader要把這個寫請求轉為一個提案，向當前的zk集群中進行廣播，意思是我現在要改一個數據，大家是否同意，如果有一個follower同意，這就超過半數了(集群中有三個節點)，如果過半數，數據便會被寫進內存了，並更新到元數據，并且結果會通知到沒來參加選舉的節點。所有事務都要由leader來接收和處理，所以客戶端無論連接哪個zk節點上，如果它不是一個leader的話，它應該把信息轉給leader，leader會把每個客戶端的請求轉為一個提案，向當前的集群中進行廣播，在收到過半數的Follower同意之後，將會確認此操作並將結果廣播給其他的Follower而後完成提交</p>
</blockquote>
<h4 id="ZAB协议中存在三种状态"><a href="#ZAB协议中存在三种状态" class="headerlink" title="ZAB协议中存在三种状态"></a>ZAB协议中存在三种状态</h4><blockquote>
<ul>
<li>Looking, 每個zk節點剛啟動時，它應該先去找leader，所謂找組織，或選舉leader的狀態</li>
<li>Following，Follower所處的狀態就是Following狀態，表示已經有leader了</li>
<li><p>Leading，Leader所處的狀態就是Leading狀態</p>
<p>zk啟動時，所有節點都處於Looking狀態，這時集群會嘗試選舉出一個Leader，被選舉出的Leader將狀態切換為Leading，其他的切換為Following狀態，當節點其他主機發現已經選舉出了Leader，如後來加入的主機，將自動從Looking轉為Following狀態，嘗試與Leader保持同步數據，當Follower與Leader節點失去聯繫時，Follower會再切換到Looking狀態並開啟新一輪選舉。zk集群中的主機會在這三個狀態之間轉換。選舉出Leader節點後，ZAB協議將進入原子廣播階段，這時Leader會與自己同步的每一個Follower節點創建一個操作序列，因為Follower與Leader的數據不一樣，所以Leader要將自己所有的數據打包，同步給每一個Follower節點。Leader與Follower節點還必須使用心跳檢測機制，去檢測每一個Follower是否處於正常狀態。這種檢測機制就相當於Follower在不斷地在集群中的某個數據節點更新自己的數據版本或時間戳，如果更新了，那麼Leader就認為Follower是正常的，否則一旦在一個超出指令時間的範圍當中，一個Follower沒有更新自己的心跳信息，這個Follower就被認為失去了連接狀態，如果是Leader失去連接，那麼所有節點就轉為Looking狀態，再進行選舉。</p>
</li>
</ul>
</blockquote>
<h4 id="四个阶段"><a href="#四个阶段" class="headerlink" title="四个阶段"></a>四个阶段</h4><blockquote>
<p> 选举:election</p>
<p> 发现：discovery</p>
<p> 同步：sync</p>
<p> 广播：Broadcast</p>
</blockquote>
<h3 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h3><blockquote>
<p>启动zookeeper后，会在/root目录下生成一个zookeeper.out文件，这个文件会非常大，需要使用<code>echo &quot;&quot; &gt; zookeeper.out</code>命令清空此文件，如果删除此文件，磁盘空间不会立即释放，还需要重启zookeeper服务。</p>
</blockquote>
<p>[^註釋]: 在传统的文件传输里面（read/write方式），在实现上其实是比较复杂的，需要经过多次上下文的切换，当需要对一个文件进行传输的时候，其具体流程细节如下：调用read函数，文件数据被copy到内核缓冲区read函数返回，文件数据从内核缓冲区copy到用户缓冲区write函数调用，将文件数据从用户缓冲区copy到内核与socket相关的缓冲区。数据从socket缓冲区copy到相关协议引擎。以上细节是传统read/write方式进行网络文件传输的方式，我们可以看到，在这个过程当中，文件数据实际上是经过了四次copy操作：硬盘—&gt;内核buf—&gt;用户buf—&gt;socket相关缓冲区—&gt;协议引擎。而sendfile系统调用则提供了一种减少以上多次copy，提升文件传输性能的方法。Sendfile系统调用是在2.1版本内核时引进的：sendfile(socket, file, len)运行流程如下：sendfile系统调用，文件数据被copy至内核缓冲区再从内核缓冲区copy至内核中socket相关的缓冲区，最后再從socket相关的缓冲区copy到协议引擎。相较传统read/write方式，2.1版本内核引进的sendfile已经减少了内核缓冲区到user缓冲区，再由user缓冲区到socket相关缓冲区的文件copy，而在内核版本2.4之后，文件描述符结果被改变，sendfile实现了更简单的方式，系统调用方式仍然一样，细节与2.1版本的不同之处在于，当文件数据被复制到内核缓冲区时，不再将所有数据copy到socket相关的缓冲区，而是仅仅将记录数据位置和长度相关的数据保存到socket相关的缓存，而实际数据将由DMA模块直接发送到协议引擎，再次减少了一次copy操作。</p>
<p>[^1]: 分布式锁，是单机锁的一种扩展，主要是为了锁住分布式系统中不同机器代码的物理块或逻辑块。以此保证不同机器之间的逻辑一致性。1. 可以保证在分布式部署的应用集群中，同一个方法在同一时间只能被一台机器上的一个线程执行。2. 这把锁要是一把可重入锁（避免死锁）. 3. 这把锁最好是一把阻塞锁（根据业务需求考虑要不要这条）4. 有高可用的获取锁和释放锁功能. 5. 获取锁和释放锁的性能要好</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/17/tomcat部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/17/tomcat部署/" itemprop="url">
                  tomcat部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-17 09:27:52" itemprop="dateCreated datePublished" datetime="2019-01-17T09:27:52+08:00">2019-01-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-03-17 22:36:18" itemprop="dateModified" datetime="2019-03-17T22:36:18+08:00">2019-03-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tomcat/" itemprop="url" rel="index"><span itemprop="name">tomcat</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><blockquote>
<p>tomcat最外层为Server，表示一个实例；一个Server内部可以容纳多个Service，Service的目地主要是把Connetor和engine建立关联关系，一个engine可以有多个Connetor，但一个Connetor只能属于一个engine，Connector是对服务地址和端口的定义，还可以定义最大并发连接数等功能。engine是真正的窗口类组件，就是能够存放webapp并可以解析以后响应给用户的组件，这些组件有engine、host、context。它们被定义在server.xml这个主配置文件中。一般不用tomcat面向客户请求，而是用反代。可以用nginx、 httpd反代。用nt或at表示。在后端也不会只用tomcat，还会在tomcat前加一个nginx或httpd处理静态服务，另外，这个前端的nginx服务器还会将动态内容反代到其后面的tomcat处理。也就是nnt或nat。因为给动态服务器处理的内容中有一些如js、css等格式的内容</p>
</blockquote>
<p><img src="/images/tomcat/tomcat结构.jpg" alt=""></p>
<blockquote>
<p>对tomcat来讲，一个主机上的实例叫一个server，或说每个tomcat进程叫一个server，一台主机上可以有多个server。一般一个主机上只运行一个server。tomcat运行在java的虚拟机（JVM）上，java虚拟机有一个特点，就是单进程使用内存不能超过32G。server可以监听在某个套接字上，用来管理。像vanish监听在6082上进行管理一样，但tomcat的管理默认没有认证功能，所有只能监听在127.0.0.1上，甚至最好不要监听。server只代表是一个进程而已，与web无关。为了表示tomcat自己的组件，需要运行一个叫容器的组件，就是在server中的engine，它是用来让用户能够存储java代码，也就是jsp代码，并把代码加载后运行生成结果的组件。它像是一个JVM的实例，就是一个java虚拟机进程。server只是一个环境，engine才是运行代码的引擎或叫jsp容器。用户请求的动态资源都应该由引擎来运行，请求到达主机后要能交给引擎组件才行。引擎要能通过套接字与其他主机联系，但引擎不能监听端口，所以在server中还要有一个到多个连接器connector。一个server内部可以存在多个引擎，连接器与引擎之间只能一一对应，请求到连接器后，这个请求属于哪个引擎，请求就会被路由到哪个引擎。但连接器是不能直接与引擎建立连接关系的。在server内部还有service，service可以有多个，它的作用主要在于把一个或多个连接器与特定的引擎关联起来。实际是在一个service中可以有一个引擎和多个连接器。一个连接器只能属于一个service，因此，属于service的连接器，也就属于了service中的引擎。一个引擎内可以有多个虚拟主机（Host），一般tomcat只使用基于主机名的虚拟主机。每一个应用叫一个context，context可以出现多个。valve用来过滤日志、用户请求等。（布署进，除了布署应用本身，还要布署应用依赖的环境被满足）。后端的tomcat只处理动态内容，静态内容由nginx处理，所以请求的如果是静态内容，就由nginx处理，如果是动态内容，就由nginx反代到tomcat上，处理后返回给nginx。这是一个nt的组合</p>
<p>网站的基本组织框架：第一层接入层、第二层缓存层、第三层应用程序服务器层、第四层存储层</p>
</blockquote>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# yum install -y java-1.8.0-openjdk-devel</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装openjdk</span></span><br><span class="line">[root@test ~]# java -version</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看版本，参数是一个横杠</span></span><br><span class="line">[root@test ~]# vim /etc/profile.d/java.sh</span><br><span class="line">export JAVA_HOME=/usr</span><br><span class="line">[root@test ~]# . /etc/profile.d/</span><br><span class="line">[root@test ~]# echo $JAVA_HOME          </span><br><span class="line">/usr</span><br><span class="line"><span class="meta">#</span><span class="bash"> java程序会依赖这个变量找java的安装环境</span></span><br><span class="line">[root@test ~]# yum install -y tomcat tomcat-webapps tomcat-admin-webapps tomcat-docs-webapp</span><br><span class="line"><span class="meta">#</span><span class="bash"> tomcat-jsp-2.2-api和tomcat-servlet-3.0-api是类库。tomcat-webapps提供的是测试页；admin-webapps提供的是Manager App和Host Manager，访问是要认证的；tomcat-docs-webapp提供的是页面中的Documentation</span></span><br><span class="line">[root@test ~]# systemctl start tomcat</span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> tomcat默认监听在8080上</span></span><br><span class="line">访问http://192.168.1.14:8080/</span><br><span class="line">[root@test ~]# cd /etc/tomcat/</span><br><span class="line">[root@test tomcat]# cp server.xml&#123;,.bak&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> rpm包主配置文件在/etc/tomcat/server.xml，如果是解压安装的tomcat，主配置文件在/usr/<span class="built_in">local</span>/tomcat/conf下</span></span><br><span class="line">[root@test tomcat]# vim server.xml</span><br><span class="line">&lt;Server port="8005" shutdown="SHUTDOWN"&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Server是tomcat的管理端，这表示server监听在哪个端口，并接受SHUTDOWN命令，可以关闭。这个功能是不安全的，将port改为-1或在shutdown后添加一个随机字符串就可使关闭功能失效</span></span><br><span class="line">	&lt;Listener className="org.apache.catalina.core.AprLifecycleListener" SSLEngine="on" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Listener表示侦听器，作用是查看对应的某个类是否被加载，如果加载了就启用起来，以便侦听某些类的资源</span></span><br><span class="line"> &lt;GlobalNamingResources&gt;</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 这是定义全局命名资源的，对主机和用户的名称解析</span></span><br><span class="line"> &lt;Service name="Catalina"&gt;</span><br><span class="line"><span class="meta"> #</span><span class="bash"> Service只有一个名称叫Catalina，Service把连接器和engine关联起来的</span></span><br><span class="line">     &lt;Connector port="8080" protocol="HTTP/1.1"</span><br><span class="line">                   connectionTimeout="20000"</span><br><span class="line">                   redirectPort="8443" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Connector对服务端口进行定义。指明连接器的端口和协议，连接超时时间，最后是一旦超时，重定向到哪个端口。这些定义的都是类的属性</span></span><br><span class="line">	&lt;Engine name="Catalina" defaultHost="localhost"&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同一个Service中的Connector都属于同一个Engine，定义名称为Catalina，defaultHost表示当用户访问的主机与tomcat中的主机没有一个匹配时，就用这个默认的主机来响应</span></span><br><span class="line">    &lt;Host name="localhost"  appBase="webapps"</span><br><span class="line">                unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用Host定义虚拟主机，appBase表示网页根文档在哪，rpm包安装的tomcat的网页根目录在/var/lib/tomcat/webapps的ROOT下，unpackWARs自动展开，autoDeploy自动布署</span></span><br><span class="line">[root@test tomcat]# yum install -y nc</span><br><span class="line">[root@test tomcat]# nc -nv 127.0.0.1 8005</span><br><span class="line">Ncat: Version 7.50 ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Connected to 127.0.0.1:8005.</span><br><span class="line">SHUTDOWN</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接管理端口，输入SHUTDOWN命令后就可以关闭tomcat了</span></span><br><span class="line">[root@test tomcat]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口关闭了</span></span><br><span class="line">[root@test tomcat]# mkdir -pv test/&#123;WEB-INF,META-INF,lib,classes&#125;</span><br><span class="line">[root@test tomcat]# vim test/index.jsp</span><br><span class="line">&lt;%@ page language="java" %&gt;		# 定义当前网站使用的默认语言是java</span><br><span class="line">&lt;%@ page import="java.util.*" %&gt;  		# 导入java.util下面的所有类</span><br><span class="line">   &lt;html&gt;</span><br><span class="line">      &lt;head&gt;</span><br><span class="line">         &lt;title&gt;Test Page&lt;/title&gt;</span><br><span class="line">      &lt;/head&gt;</span><br><span class="line">      &lt;body&gt;</span><br><span class="line">         &lt;% out.println("hello world");			# out.println是java的输出命令</span><br><span class="line">         %&gt;</span><br><span class="line">      &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br><span class="line">[root@test tomcat]# cp -a test/ /var/lib/tomcat/webapps/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将网页目录放到根下，因为文件少，所以没有打包网页目录。因为配置文件中定义了自动布署，所以可以自动导入java.util下面的所有类。如果是war文件，也会自动展开的。因为配置文件中定义了自动展开</span></span><br><span class="line">[root@test tomcat]# systemctl start tomcat</span><br><span class="line">访问http://192.168.1.14:8080/test/index.jsp</span><br><span class="line">[root@test tomcat]# ls /var/cache/tomcat/work</span><br><span class="line">Catalina</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译后的页面在/var/cache/tomcat/work中叫Catalina</span></span><br></pre></td></tr></table></figure>
<h4 id="调整tomcat使用jvm内存"><a href="#调整tomcat使用jvm内存" class="headerlink" title="调整tomcat使用jvm内存"></a>调整tomcat使用jvm内存</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 源码安装</span><br><span class="line">[root@jenkins local]# vim /usr/local/tomcat/bin/catalina.sh</span><br><span class="line">    JAVA_OPTS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整tomcat使用jvm内存</span></span><br><span class="line">[root@jenkins tomcat]# /usr/local/tomcat/bin/startup.sh</span><br><span class="line">[root@jenkins tomcat]# tail -f /usr/local/tomcat/logs/catalina.out</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看启动过程</span></span><br><span class="line">[root@jenkins local]# ps aux|grep tomcat</span><br><span class="line">root       3101 33.7 38.4 3704844 717556 pts/0  Sl   13:02   0:17 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line"></span><br><span class="line">* rpm包安装</span><br><span class="line">[root@jenkins ~]# vim /etc/sysconfig/jenkins</span><br><span class="line">JENKINS_JAVA_OPTIONS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整jenkins的使用内存，默认此项是-Djava.awt.headless=<span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xms：初始堆内存Heap大小，使用的最小内存，cpu性能高时此值应设的大一些</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xmx：初始堆内存heap最大值，使用的最大内存</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -XX:MaxPermSize:设定最大内存的永久保存区域</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xms与-Xmx设置相同的值，需要根据实际情况设置，增大内存可以提高读写性能</span></span><br></pre></td></tr></table></figure>
<h4 id="页面中的manager"><a href="#页面中的manager" class="headerlink" title="页面中的manager"></a>页面中的manager</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@test tomcat]# vim /etc/tomcat/tomcat-users.xml.</span><br><span class="line">&lt;role rolename="manager-gui"/&gt; </span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开manager-gui功能</span></span><br><span class="line">&lt;user name="tomcat" password="tomcat" roles="manager-gui" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自定义用户名和密码，这里要设置password和roles，roles后的内容要与上面的role中定义的一样</span></span><br><span class="line">[root@test tomcat]# systemctl restart tomcat</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改后必须重启，因为启动时此文件已装载进内存</span></span><br><span class="line">访问http://192.168.1.14:8080中的Manager App，使用上面的用户名和密码，在这里可以管理站点，在这里也可以热布署</span><br></pre></td></tr></table></figure>
<h4 id="测试热部署"><a href="#测试热部署" class="headerlink" title="测试热部署"></a>测试热部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@test tomcat]# cp -a test/ /var/lib/tomcat/webapps/test2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在管理页中的Deploy中的Context Path (required)中输入/test2（视频中去掉了斜线），点Deploy，有错误提示，但也可以在上面的页面管理中看到test2了。在下面还有WAR file to deploy，是热布署war文件的，也是选择好文件，并点击Deploy即可。实际测试中在复制<span class="built_in">test</span>文件后，在管理页面中就已经可以看到test2的内容了</span></span><br></pre></td></tr></table></figure>
<h4 id="管理虚拟主机"><a href="#管理虚拟主机" class="headerlink" title="管理虚拟主机"></a>管理虚拟主机</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@test tomcat]# vim /etc/tomcat/tomcat-users.xml</span><br><span class="line">&lt;role rolename="admin-gui"/&gt; </span><br><span class="line">&lt;role rolename="manager-gui"/&gt;</span><br><span class="line">&lt;user name="tomcat" password="tomcat" roles="manager-gui,admin-gui" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 页面中的Host Manager是管理虚拟主机的，用户所属的角色是admin-gui，加入即可。</span></span><br><span class="line">[root@test tomcat]# systemctl restart tomcat</span><br><span class="line">[root@test tomcat]# mkdir -pv /appdata/ilinux/ROOT</span><br><span class="line">[root@test tomcat]# cp -r test/* /appdata/ilinux/ROOT/</span><br><span class="line">[root@test tomcat]# vim /appdata/ilinux/ROOT/index.jsp</span><br><span class="line">&lt;%@ page language="java" %&gt;</span><br><span class="line">&lt;%@ page import="java.util.*" %&gt;</span><br><span class="line">   &lt;html&gt;</span><br><span class="line">      &lt;head&gt;</span><br><span class="line">         &lt;title&gt;ilinux page&lt;/title&gt;</span><br><span class="line">      &lt;/head&gt;</span><br><span class="line">      &lt;body&gt;</span><br><span class="line">         &lt;% out.println("hello ilinux");</span><br><span class="line">         %&gt;</span><br><span class="line">      &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br><span class="line">访问http://192.168.1.14:8080，进入Host Manager中可以创建删除虚拟主机，定义虚拟主机时要指明Name站点名称，这里用了www.ilinux.io，Aliases站点别名，这里用ilinux.io，App base站点路径，这里用/appdata/ilinux/，下面选项是，AutoDeploy：是否自动布署；DeployOnStartup：是否启动时自动布署；DeployXML：是否基于xml文件来布署；UnpackWARs：是否自动展开WAR文件；Manager App：是否用Manager App来管理，最后添加就行了</span><br><span class="line"></span><br><span class="line">** 让自己的主机可以解析www.ilinux.io，配置hosts文件</span><br><span class="line"></span><br><span class="line">访问 www.ilinux.io:8080，不用在访问时写ROOT，tomcat可以自动识别，根文件就在ROOT中。但这种方式是定义在内存中的，如果重启tomcat后，就不存在了。如果要长期有效，还要定义在server.xml中。访问显示hello ilinux</span><br><span class="line">[root@test tomcat]# vim server.xml</span><br><span class="line">&lt;Connector port="8080" protocol="HTTP/1.1"</span><br><span class="line">               connectionTimeout="20000"</span><br><span class="line">               redirectPort="8443" maxThreads="1000" acceptCount="200" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入，最大并发连接数是1000，等待队列是200。端口如果改为80是启动不了的，因为是普通用户</span></span><br><span class="line">&lt;Engine name="Catalina" defaultHost="localhost"&gt;</span><br><span class="line">      &lt;Host name="www.ilinux.io" appBase="/appdata/ilinux"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"/&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里只要将Host写在已有的&lt;Engine&gt;中即可，用&lt;Host&gt;&lt;/Host&gt;或&lt;.../&gt;的方式都可以</span></span><br><span class="line">[root@test tomcat]# systemctl restart tomcat</span><br><span class="line">访问www.ilinux.io:8080，访问显示hello ilinux</span><br><span class="line">上传shopxx-a5-Beta.zip到tomcat主机</span><br><span class="line">[root@test ~]# unzip shopxx-a5-Beta.zip</span><br><span class="line">[root@test ~]# cp -a /root/shopxx-v3.0-Beta/shopxx-3.0Beta/ /appdata/ilinux/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 放在/appdata/ilinux目录中，是因为上面在server.xml中的Host中定义了www.ilinux.io的网页目录路径</span></span><br><span class="line">[root@test ~]# ln -sv /appdata/ilinux/shopxx-3.0Beta/ /appdata/ilinux/shopxx</span><br><span class="line">访问www.ilinux.io:8080/shopxx，这里可以看到安装界面</span><br><span class="line">[root@test ~]# rm -f /appdata/ilinux/shopxx</span><br><span class="line">[root@test ~]# mkdir /e-shop</span><br><span class="line">[root@test ~]# cp -a /root/shopxx-v3.0-Beta/shopxx-3.0Beta/ /e-shop/</span><br><span class="line">[root@test ~]# cd /e-shop/</span><br><span class="line">[root@test e-shop]# ln -sv shopxx-3.0Beta/ shopxx</span><br><span class="line">[root@test e-shop]# vim /etc/tomcat/server.xml</span><br><span class="line">&lt;Engine name="Catalina" defaultHost="localhost"&gt;</span><br><span class="line">      &lt;Host name="www.ilinux.io" appBase="/appdata/ilinux"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line">         &lt;Context path="/eshop" docBase="/e-shop/shopxx/" reloadable="true"/&gt;</span><br><span class="line">      &lt;/Host&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里一定要注意，Context一定要定义在某个Host中，不然是无法访问的。Context类似<span class="built_in">alias</span>，就是将设置的URL指向设置的路径，这里用path设置URL，docBase设置真正的路径，reloadable表示是否自动装载。这时访问eshop时就会到/e-shop/shopxx找文件了</span></span><br><span class="line">[root@test e-shop]# systemctl restart tomcat</span><br><span class="line">访问www.ilinux.io:8080/eshop，这时也可以看到安装界面</span><br></pre></td></tr></table></figure>
<h4 id="添加日志功能"><a href="#添加日志功能" class="headerlink" title="添加日志功能"></a>添加日志功能</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@test tomcat]# vim server.xml</span><br><span class="line">&lt;Engine name="Catalina" defaultHost="localhost"&gt;</span><br><span class="line">      &lt;Host name="www.ilinux.io" appBase="/appdata/ilinux"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line">         &lt;Context path="/eshop" docBase="/e-shop/shopxx/" reloadable="true"/&gt;</span><br><span class="line">         &lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"</span><br><span class="line">         prefix="ilinux_access_log." suffix=".log"</span><br><span class="line">         pattern="%h %l %u %t &amp;quot;%r&amp;quot; %s %b"/&gt;</span><br><span class="line">      &lt;/Host&gt; </span><br><span class="line">[root@test tomcat]# systemctl restart tomcat</span><br><span class="line">访问www.ilinux.io:8080/eshop</span><br><span class="line">[root@test ~]# tail -f /var/log/tomcat/ilinux_access_log.2019-01-17.log</span><br></pre></td></tr></table></figure>
<h4 id="nginx反向代理"><a href="#nginx反向代理" class="headerlink" title="nginx反向代理"></a>nginx反向代理</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">准备两台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。另一台是内网主机，地址：172.16.106.133。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* tomcat</span><br><span class="line">[root@test ~]# yum install -y java-1.8.0-openjdk-devel tomcat tomcat-webapps tomcat-admin-webapps tomcat-docs-webapp</span><br><span class="line">[root@test tomcat]# vim tomcat-users.xml</span><br><span class="line">&lt;role rolename="admin-gui"/&gt; </span><br><span class="line">&lt;role rolename="manager-gui"/&gt; </span><br><span class="line">&lt;user name="tomcat" password="tomcat" roles="admin-gui,manager-gui" /&gt;</span><br><span class="line">[root@test ~]# systemctl start tomcat</span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line">访问http://172.16.106.133:8080/，测试tomcat是否正常</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test ~]# yum install -y nginx</span><br><span class="line">[root@test ~]# cd /etc/nginx/</span><br><span class="line">[root@test nginx]# vim conf.d/ilinux.conf</span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.ilinux.io;</span><br><span class="line">   location / &#123;</span><br><span class="line">        proxy_pass http://172.16.106.133:8080;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@test nginx]# nginx -t</span><br><span class="line">[root@test nginx]# systemctl start nginx</span><br><span class="line">设置本机hosts文件，可以解析www.ilinux.io;</span><br><span class="line">访问www.ilinux.io。这时如果不关闭firewall是不能访问的，如果关闭了firewall而未关闭selinux会提示502无法访问</span><br><span class="line"></span><br><span class="line">* tomcat</span><br><span class="line">[root@test ~]# mkdir -pv /var/lib/tomcat/webapps/test/&#123;WEB-INF,META-INF,classes,lib&#125;</span><br><span class="line">[root@test ~]# vim /var/lib/tomcat/webapps/test/index.jsp</span><br><span class="line">&lt;%@ page language="java" %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="red"&gt;TomcatA.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">      &lt;table align="centre" border="1"&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">           &lt;% session.setAttribute("magedu.com","magedu.com"); %&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line">   &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">访问www.ilinux.io/test/，www.ilinux.io/manager</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test ~]# tail -f /var/log/nginx/access.log</span><br><span class="line">[root@test nginx]# vim conf.d/ilinux.conf </span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.ilinux.io;</span><br><span class="line">   location / &#123;</span><br><span class="line">        proxy_pass http://172.16.106.132:8080;</span><br><span class="line">   &#125;</span><br><span class="line">   location ~*\.(jsp|do)$ &#123;</span><br><span class="line">        proxy_pass http://172.16.106.133:8080;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样设置就可以实现动静分离</span></span><br><span class="line">访问http://www.ilinux.io/test/index.jsp，如果不写后面的index.jsp会打不开页面</span><br></pre></td></tr></table></figure>
<h4 id="http反向代理"><a href="#http反向代理" class="headerlink" title="http反向代理"></a>http反向代理</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">准备两台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。另一台是内网主机，地址：172.16.106.133。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test ~]# yum install -y httpd</span><br><span class="line">[root@test ~]# cd /etc/httpd/</span><br><span class="line">[root@test httpd]# vim conf.d/ilinux-http-tomcat.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www.ilinux.io</span><br><span class="line">   proxyRequests off		# 关闭正向代理</span><br><span class="line">   ProxyPreserveHost on			# 将主机头传到后端</span><br><span class="line">   ProxyVia on			# 是否在响应报文中加上via首部</span><br><span class="line">   &lt;Proxy *&gt;			# Proxy功能可以被谁使用</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Proxy&gt;</span><br><span class="line">   ProxyPass / http://172.16.106.133:8080/     </span><br><span class="line"><span class="meta">   #</span><span class="bash"> 将自己的哪个URL代理到后端的哪个URL，最后的/线不能少</span></span><br><span class="line">   ProxyPassReverse / http://172.16.106.133:8080/		# 这条不写也可以</span><br><span class="line">   &lt;Location /&gt;			# 哪个URL可以被谁访问</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@test httpd]# httpd -M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 看一下是否有proxy_module和proxy_http_module两个模块</span></span><br><span class="line">[root@test httpd]# httpd -t</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查语法</span></span><br><span class="line">[root@test httpd]# systemctl start httpd</span><br><span class="line">[root@test httpd]# ss -tln</span><br><span class="line">访问 www.ilinux.io</span><br><span class="line">[root@test httpd]# tail -f /var/log/httpd/access_log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用之前的nginx反代到后端的httpd上，httpd再反代到本机的tomcat上。实现nat架构</span></span><br></pre></td></tr></table></figure>
<h4 id="ajp反向代理"><a href="#ajp反向代理" class="headerlink" title="ajp反向代理"></a>ajp反向代理</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">准备两台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。另一台是内网主机，地址：172.16.106.133。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test httpd]# cp /etc/httpd/conf.d/ilinux-http-tomcat.conf /etc/httpd/conf.d/iunix-ajp-tomcat.conf</span><br><span class="line">[root@test httpd]# vim conf.d/iunix-ajp-tomcat.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www.iunix.io</span><br><span class="line">   proxyRequests off</span><br><span class="line">   ProxyPreserveHost on</span><br><span class="line">   ProxyVia on</span><br><span class="line">   &lt;Proxy *&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Proxy&gt;</span><br><span class="line">   ProxyPass / ajp://172.16.106.133:8009/		# 改协议为ajp，端口为8009</span><br><span class="line">   ProxyPassReverse / ajp://172.16.106.133:8009/</span><br><span class="line">   &lt;Location /&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@test httpd]# httpd -M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意proxy_ajp_module模块要加载</span></span><br><span class="line">[root@test httpd]# systemctl restart httpd</span><br><span class="line">访问www.iunix.io</span><br><span class="line"><span class="meta">#</span><span class="bash"> ajp的好处是用浏览器是不能访问的，只要注释掉8080端口（因为ajp联系的是8009端口），更安全。显示的结果与http的结果是一样的，也是tomcat主页</span></span><br></pre></td></tr></table></figure>
<h4 id="httpd负载均衡"><a href="#httpd负载均衡" class="headerlink" title="httpd负载均衡"></a>httpd负载均衡</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">准备三台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。tomcat1是内网主机，地址：172.16.106.133。tomcat2地址：172.16.106.134。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test httpd]# httpd -M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 要加载proxy_balancer_module模块</span></span><br><span class="line">[root@test httpd]# vim conf.d/ilinux-http-tomcat.conf</span><br><span class="line">&lt;Proxy balancer://tcsrvs&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义组，balancer://是调用这个模块，不能变。tcsrvs是自定义的名字</span></span><br><span class="line">   BalancerMember http://172.16.106.133:8080</span><br><span class="line">   BalancerMember http://172.16.106.134:8080</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调度的成员</span></span><br><span class="line">   ProxySet lbmethod=byrequests</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义算法，这是加权轮询的。byrequests：默认。基于请求数量计算权重。bytraffic：基于I/O流量大小计算权重。bybusyness：基于挂起的请求(排队暂未处理)数量计算权重。</span></span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www.ilinux.io</span><br><span class="line">   proxyRequests off</span><br><span class="line">   ProxyPreserveHost on</span><br><span class="line">   ProxyVia on</span><br><span class="line">   &lt;Proxy *&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Proxy&gt;</span><br><span class="line">   ProxyPass / balancer://tcsrvs/</span><br><span class="line">   ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">   &lt;Location /&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@test httpd]# systemctl restart httpd</span><br><span class="line">[root@test httpd]# ss -tln</span><br><span class="line"></span><br><span class="line">* tomcat1</span><br><span class="line">[root@test ~]# scp -r /usr/share/tomcat/webapps/test/ 172.16.106.134:/root</span><br><span class="line"></span><br><span class="line">* tomcat2</span><br><span class="line">[root@test ~]# yum install -y java-1.8.0-openjdk-devel tomcat tomcat-webapps tomcat-admin-webapps tomcat-docs-webapp</span><br><span class="line">[root@test ~]# vim /etc/profile.d/java.sh</span><br><span class="line">export JAVA_HOME=/usr</span><br><span class="line">[root@test ~]# cp -r test/ /usr/share/tomcat/webapps/</span><br><span class="line">[root@test ~]# vim /var/lib/tomcat/webapps/test/index.jsp               </span><br><span class="line">&lt;%@ page language="java" %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatB&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="blue"&gt;TomcatB.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">      &lt;table align="centre" border="1"&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">           &lt;% session.setAttribute("magedu.com","magedu.com"); %&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line">   &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@test ~]# vim /etc/tomcat/tomcat-users.xml</span><br><span class="line">&lt;role rolename="admin-gui"/&gt; </span><br><span class="line">&lt;role rolename="manager-gui"/&gt; </span><br><span class="line">&lt;user name="tomcat" password="tomcat" roles="admin-gui,manager-gui" /&gt;</span><br><span class="line">[root@test ~]# systemctl start tomcat</span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test httpd]# vim /etc/hosts</span><br><span class="line">192.168.1.14 www.ilinux.io www.iunix.io</span><br><span class="line">[root@test httpd]# for i in &#123;1..10&#125;;do curl -s http://www.ilinux.io/test/ | grep -i 'tomcat';done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时应该返回两台服务器的结果</span></span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="red"&gt;TomcatA.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatB&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="blue"&gt;TomcatB.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
<h4 id="ajp负载均衡"><a href="#ajp负载均衡" class="headerlink" title="ajp负载均衡"></a>ajp负载均衡</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">准备三台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。tomcat1是内网主机，地址：172.16.106.133。tomcat2地址：172.16.106.134。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test httpd]# vim conf.d/iunix-ajp-tomcat.conf </span><br><span class="line">&lt;Proxy balancer://tomcatsrvs&gt;</span><br><span class="line">   BalancerMember ajp://172.16.106.133:8009</span><br><span class="line">   BalancerMember ajp://172.16.106.134:8009</span><br><span class="line">   ProxySet lbmethod=byrequests</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www.iunix.io</span><br><span class="line">   proxyRequests off</span><br><span class="line">   ProxyPreserveHost on</span><br><span class="line">   ProxyVia on</span><br><span class="line">   &lt;Proxy *&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Proxy&gt;</span><br><span class="line">   ProxyPass / balancer://tomcatsrvs/</span><br><span class="line">   ProxyPassReverse / balancer://tomcatsrvs/</span><br><span class="line">   &lt;Location /&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@test httpd]# systemctl restart httpd</span><br><span class="line">[root@test httpd]# for i in &#123;1..10&#125;;do curl -s http://www.iunix.io/test/ | grep -i 'tomcat';done</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="red"&gt;TomcatA.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatB&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="blue"&gt;TomcatB.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
<h4 id="会话粘性-内建管理页"><a href="#会话粘性-内建管理页" class="headerlink" title="会话粘性/内建管理页"></a>会话粘性/内建管理页</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@test httpd]# vim conf.d/ilinux-http-tomcat.conf</span><br><span class="line">Header add Set-Cookie "ROUTEID=%&#123;BALANCER_WORKER_ROUTE&#125;e; path=/" env=BALANCER_ROUTE_CHANGED</span><br><span class="line">&lt;Proxy balancer://tcsrvs&gt;</span><br><span class="line">   BalancerMember http://172.16.106.133:8080 route=TomcatA</span><br><span class="line">   BalancerMember http://172.16.106.134:8080 route=TomcatB</span><br><span class="line">   ProxySet lbmethod=byrequests</span><br><span class="line">   ProxySet stickysession=ROUTEID</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www.ilinux.io</span><br><span class="line">   proxyRequests off</span><br><span class="line">   ProxyPreserveHost on</span><br><span class="line">   ProxyVia on</span><br><span class="line">   &lt;Proxy *&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Proxy&gt;</span><br><span class="line">   ProxyPass / balancer://tcsrvs/</span><br><span class="line">   ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">   &lt;Location /&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">   &lt;Location /bstatus&gt;</span><br><span class="line">      SetHandler balancer-manager</span><br><span class="line">      ProxyPass !</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@test httpd]# httpd -t</span><br><span class="line">[root@test httpd]# systemctl restart httpd</span><br><span class="line">访问http://www.ilinux.io/bstatus可以看到管理页面，访问http://www.ilinux.io/test/按F12查看，可以看到cookie一项中有ROUTEID=TomcatA或B，表示cookie会话绑定</span><br></pre></td></tr></table></figure>
<h4 id="session会话绑定，用session-cluster的方法实现"><a href="#session会话绑定，用session-cluster的方法实现" class="headerlink" title="session会话绑定，用session cluster的方法实现"></a>session会话绑定，用session cluster的方法实现</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">准备三台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。tomcat1是内网主机，地址：172.16.106.133。tomcat2地址：172.16.106.134。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    upstream tcsrvs &#123;</span><br><span class="line">        server 172.16.106.133:8080;</span><br><span class="line">        server 172.16.106.134:8080;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入upstream段</span></span><br><span class="line">[root@test ~]# vim /etc/nginx/conf.d/ilinux.conf</span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.ilinux.io;</span><br><span class="line">   location / &#123;</span><br><span class="line">        proxy_pass http://tcsrvs;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里没有在两台tomcat主机上再安装nginx进行静态处理及动态内容反代</span></span><br><span class="line">[root@test ~]# systemctl start nginx</span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line">访问www.ilinux.io/test，这时是轮询的，这时的session ID是会改变的，只要刷新。因为被识别为新用户了。这个测试就是要让sessionID不变。</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看官方文档第十八章，Clustering/Session Replication HOW-TO。这个组件就叫Cluster，只能放在Engine或Host内部。因为每个集群节点都要配置，所以时间都要同步。之后会通过多播地址228.0.0.4进行通信，多播端口是45564。只要监听这个地址和端口就可以成为成员。接收多播信息要监听在4000-4100之间。</span></span><br><span class="line"></span><br><span class="line">* tomcat1&amp;tomcat2</span><br><span class="line">[root@test ~]# vim /etc/tomcat/server.xml</span><br><span class="line">&lt;Host name="localhost"  appBase="webapps"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line">&lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"</span><br><span class="line">        channelSendOptions="8"&gt;</span><br><span class="line">        &lt;Manager className="org.apache.catalina.ha.session.DeltaManager"</span><br><span class="line">        expireSessionsOnShutdown="false" </span><br><span class="line">        notifyListenersOnReplication="true"/&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义使用哪一个会话管理器，一共有五种；expireSessionsOnShutdown表示关机后会话是否过期，这里是不允许；</span></span><br><span class="line">        &lt;Channel className="org.apache.catalina.tribes.group.GroupChannel"&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Channel是用来定义信道的</span></span><br><span class="line">        &lt;Membership className="org.apache.catalina.tribes.membership.McastService"</span><br><span class="line">           address="228.0.0.4" 		# 多播地址最好改一下</span><br><span class="line">           port="45564" </span><br><span class="line">           frequency="500" 		# 健康检测500毫秒</span><br><span class="line">           dropTime="3000"/&gt;		# 3000毫秒没有响应就将节点去除</span><br><span class="line">        &lt;Receiver className="org.apache.catalina.tribes.transport.nio.NioReceiver"</span><br><span class="line">           address="172.16.106.133" </span><br><span class="line">           # 改为自己的地址。如果是auto与hosts文件有关，它会做主机名反解</span><br><span class="line">           port="4000" </span><br><span class="line">           autoBind="100" </span><br><span class="line">           selectorTimeout="5000"</span><br><span class="line">           maxThreads="6"/&gt;</span><br><span class="line">        &lt;Sender className="org.apache.catalina.tribes.transport.ReplicationTransmitter"&gt;</span><br><span class="line">        &lt;Transport className="org.apache.catalina.tribes.transport.nio.PooledParallelSender"/&gt;</span><br><span class="line">        &lt;/Sender&gt;</span><br><span class="line">        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.TcpFailureDetector"/&gt;</span><br><span class="line">        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor"/&gt;</span><br><span class="line">        &lt;/Channel&gt;</span><br><span class="line">        &lt;Valve className="org.apache.catalina.ha.tcp.ReplicationValve" filter=""/&gt;</span><br><span class="line">        &lt;Valve className="org.apache.catalina.ha.session.JvmRouteBinderValve"/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Deployer className="org.apache.catalina.ha.deploy.FarmWarDeployer"</span><br><span class="line">           tempDir="/tmp/war-temp/"</span><br><span class="line">           deployDir="/tmp/war-deploy/"</span><br><span class="line">           watchDir="/tmp/war-listen/"</span><br><span class="line">           watchEnabled="false"/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;ClusterListener className="org.apache.catalina.ha.session.ClusterSessionListener"/&gt;</span><br><span class="line">        &lt;/Cluster&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在想使用集群的Host中添加上面的内容</span></span><br><span class="line">[root@test ~]# cp web.xml /var/lib/tomcat/webapps/test/WEB-INF/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给<span class="built_in">test</span>提供一个web.xml文件</span></span><br><span class="line">[root@test ~]# vim /var/lib/tomcat/webapps/test/WEB-INF/web.xml</span><br><span class="line">	&lt;distributable/&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在web-app段内任一位置添加&lt;distributable/&gt;才能实现上面的集群功能。当然，还要是在想实现集群功能的页面中的web.xml文件中添加，这里就是在<span class="built_in">test</span>的web.xml文件中添加的</span></span><br><span class="line">[root@test ~]# scp /etc/tomcat/server.xml 172.16.106.133:/etc/tomcat</span><br><span class="line">[root@test ~]# scp /var/lib/tomcat/webapps/test/WEB-INF/web.xml root@172.16.106.133:/var/lib/tomcat/webapps/test/WEB-INF</span><br><span class="line">[root@test test]# systemctl stop tomcat</span><br><span class="line">[root@test test]# systemctl start tomcat</span><br><span class="line">[root@test ~]# tail -f /var/log/tomcat/catalina.2019-01-17.log</span><br><span class="line">访问www.ilinux.io/test，这时不管是TomcatA还是B，session ID都是不会变的。测试中出现问题，Session无法绑定，原因是test中的WEB-INF目录的名字有问题，改回来就没问题了。</span><br></pre></td></tr></table></figure>
<h4 id="tomcat-memcached"><a href="#tomcat-memcached" class="headerlink" title="tomcat + memcached"></a>tomcat + memcached</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">准备三台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。tomcat1是内网主机，地址：172.16.106.133。tomcat2地址：172.16.106.134。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* tomcat1 &amp; tomcat2</span><br><span class="line">[root@test ~]# yum install -y memcached</span><br><span class="line">[root@test ~]# systemctl start memcached</span><br><span class="line">[root@test ~]# cd /etc/tomcat/</span><br><span class="line">[root@test ~]# cp server.xml&#123;,.cluster&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将tomcat恢复成最初状态，将cluster一段删除</span></span><br><span class="line">[root@test ~]# vim server.xml</span><br><span class="line">&lt;Context path="/test" docBase="test" reloadable="true"&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> reloadable表示自动装载</span></span><br><span class="line">            &lt;Manager className="de.javakaffee.web.msm.MemcachedBackupSessionManager"</span><br><span class="line">            memcachedNodes="m1:172.16.106.133:11211,m2:172.16.106.134:11211"</span><br><span class="line">            failoverNodes="m2"</span><br><span class="line">            requestUriIgnorePattern=".*\.(ico|png|gif|jpg|css|js)$"</span><br><span class="line">            transcoderFactoryClass="de.javakaffee.web.msm.serializer.javolution.JavolutionTran</span><br><span class="line">scoderFactory" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> serializer后的javolution开头的j一定要小写</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> memcachedNodes中m1是自定义的名称，后面是节点的地址；failoverNodes=<span class="string">"m2"</span>表示m2是备用节点，如果m1有故障m2才上线。requestUriIgnorePattern指有些内容是不缓存的，因为是静态文件。</span></span><br><span class="line">         &lt;/Context&gt;</span><br><span class="line">[root@test ~]# scp /etc/tomcat/server.xml 172.16.106.134:/etc/tomcat/</span><br><span class="line">下载相关包到两台tomcat</span><br><span class="line">1.  javolution-5.4.3.1.jar 		# 流式化工具</span><br><span class="line">2. msm-javolution-serializer-1.9.7.jar		# MSM支持两种模式即粘性sessions和非粘性sessions</span><br><span class="line">3. memcached-session-manager-1.9.7.jar		# memcached会话管理器</span><br><span class="line">4. memcached-session-manager-tc7-1.9.7.jar		# memcached会话管理器</span><br><span class="line">5. spymemcached-2.11.1.jar		# 驱动：tomcat连接memcached</span><br><span class="line">[root@test ~]# scp *.jar 172.16.106.134:/usr/share/java/tomcat/</span><br><span class="line">[root@test ~]# systemctl stop tomcat.</span><br><span class="line">[root@test ~]# systemctl start tomcat</span><br><span class="line">[root@test ~]# tail -f /var/log/tomcat/catalina.2019-01-17.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监控日志，看启动是否有问题。启动没有问题后，访问www.ilinux.io/<span class="built_in">test</span>，这时的SessionID是不会有变化的。因为sticky设置成了<span class="literal">true</span>，如果是<span class="literal">false</span>，那么就会有变化了。SessionID的最后有m1或m2的标识，可以知道是在哪个memcached上。</span></span><br><span class="line"></span><br><span class="line">* tomcat1</span><br><span class="line">[root@test ~]# systemctl stop memcached</span><br><span class="line">再访问www.ilinux.io/test，这时的SessionID还是不会有变化，只是Session ID一行最后变成了m2。切记，一定要先启动memcached再启动tomcat。</span><br><span class="line">[root@test ~]# yum install -y libmemcached-devel</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个包是C与memcached连接用的，提供了很多命令</span></span><br><span class="line">[root@test ~]# memstat --servers="172.16.106.133"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示memcached的各种数据</span></span><br></pre></td></tr></table></figure>
<h4 id="memcached安装使用"><a href="#memcached安装使用" class="headerlink" title="memcached安装使用"></a>memcached安装使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">在tomcat主机上安装测试</span><br><span class="line"></span><br><span class="line">[root@test ~]# yum install -y telnet</span><br><span class="line">[root@test ~]# vim /etc/sysconfig/memcached</span><br><span class="line">PORT="11211"		# 端口</span><br><span class="line">USER="memcached"		# 启动服务的用户名</span><br><span class="line">MAXCONN="1024"		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大并发连接数;存储层是不面向用户的，是从前面的反代发来的，所以1024并不小</span></span><br><span class="line">CACHESIZE="64"		# 缓存空间大小，这要改一下，如2G</span><br><span class="line">OPTIONS=""</span><br><span class="line">[root@test ~]# cat /usr/lib/systemd/system/memcached.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Memcached </span><br><span class="line">Before=httpd.service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/memcached</span><br><span class="line">ExecStart=/usr/bin/memcached -u $USER -p $PORT -m $CACHESIZE -c $MAXCONN $OPTIONS</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到，启动时就是调用配置文件中的几个参数</span></span><br><span class="line">[root@test ~]# telnet 127.0.0.1 11211</span><br><span class="line">stats</span><br><span class="line">stats slabs  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内存分配器</span></span><br><span class="line">add mykey 1 600 13  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置存储数据的信息，这里存储的键叫mykey，标志位是1，过期时间是600秒，占用内存大小是13个字符。</span></span><br><span class="line">www.ilinux.io 	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是要存储的数据，成功后返回STORED</span></span><br><span class="line">stats	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时cmd_set的值是1了。</span></span><br><span class="line">get mykey	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看mykey的信息</span></span><br><span class="line">append mykey 1 600 12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在后面追加数据</span></span><br><span class="line">www.iunix.io  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 返回了NOT_STORED，因为数据过期了，不能追加</span></span><br><span class="line">get mykey</span><br><span class="line">prepend mykey 1 600 7	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在前面补</span></span><br><span class="line">http://		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加这些内容</span></span><br><span class="line">get mykey</span><br><span class="line">delete mykey</span><br><span class="line">get mykey</span><br><span class="line">add counter 1 600 1	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置一个计数器</span></span><br><span class="line">0	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 值是0</span></span><br><span class="line">get counter</span><br><span class="line">incr counter 1	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 增加1</span></span><br><span class="line">get counter</span><br><span class="line">incr counter 2</span><br><span class="line">decr counter 1	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 减1</span></span><br><span class="line">flush_all	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清空数据</span></span><br><span class="line">quit</span><br><span class="line"><span class="meta">#</span><span class="bash"> 退出</span></span><br></pre></td></tr></table></figure>
<h4 id="tomcat-redis实现session绑定"><a href="#tomcat-redis实现session绑定" class="headerlink" title="tomcat + redis实现session绑定"></a>tomcat + redis实现session绑定</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">准备一台redis，两台tomcat</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test ~]# yum install -y redis</span><br><span class="line">[root@test ~]# vim /etc/redis.conf</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">[root@test ~]# systemctl start redis</span><br><span class="line">[root@test ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">...</span><br><span class="line">upstream tcsrvs &#123;</span><br><span class="line">        server 192.168.1.13:8080;</span><br><span class="line">        server 192.168.1.15:8080;</span><br><span class="line">    &#125;</span><br><span class="line">[root@test ~]# vim /etc/nginx/conf.d/ilinux.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.ilinux.io;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://tcsrvs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">* tomcat1 &amp; tomcat 2</span><br><span class="line">下载commons-pool2-2.0.jar、jedis-2.7.2.jar、tomcat-redis-session-manager1.2.jar到/usr/share/java/tomcat中</span><br><span class="line"><span class="meta">#</span><span class="bash"> 试过上面三个包的其他版本，tomcat启动时均有报错，用上面三个版本没有问题。可以个人百度网盘下载。参考：https://my.oschina.net/xshuai/blog/916122</span></span><br><span class="line">[root@test tomcat]# vim /etc/tomcat/context.xml</span><br><span class="line">&lt;Valve className="com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve" /&gt;</span><br><span class="line">    &lt;Manager className="com.orangefunction.tomcat.redissessions.RedisSessionManager"</span><br><span class="line">         host="192.168.1.14" </span><br><span class="line">         port="6379" </span><br><span class="line">         database="0" </span><br><span class="line">         maxInactiveInterval="60"/&gt;</span><br><span class="line">[root@test tomcat]# mkdir -pv /var/lib/tomcat/webapps/test/&#123;WEB-INF,META-INF,classes,lib&#125;</span><br><span class="line">[root@test tomcat]# vim /usr/share/tomcat/webapps/test/index.jsp</span><br><span class="line">&lt;%@ page language="java" %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="red"&gt;TomcatA.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">      &lt;table align="centre" border="1"&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">           &lt;% session.setAttribute("magedu.com","magedu.com"); %&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line">   &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@test tomcat]# cd /usr/share/java/tomcat</span><br><span class="line">[root@test tomcat]# scp /etc/tomcat/context.xml 192.168.1.13:/etc/tomcat/</span><br><span class="line">[root@test tomcat]# scp jedis-2.7.2.jar commons-pool2-2.0.jar tomcat-redis-session-manager1.2.jar 192.168.1.13:/usr/share/java/tomcat/</span><br><span class="line">[root@test tomcat]# scp -r /usr/share/tomcat/webapps/test/ 192.168.1.13:/usr/share/tomcat/webapps/</span><br><span class="line">[root@test tomcat]# vim /etc/tomcat/tomcat-users.xml</span><br><span class="line">&lt;role rolename="admin-gui"/&gt;</span><br><span class="line">&lt;role rolename="manager-gui"/&gt;</span><br><span class="line">&lt;user name="admin" password="adminadmin" roles="admin-gui,manager-gui" /&gt;</span><br><span class="line">[root@test tomcat]# scp /etc/tomcat/tomcat-users.xml 192.168.1.13:/etc/tomcat</span><br><span class="line">[root@test tomcat]# systemctl start tomcat</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动两台tomcat</span></span><br><span class="line">访问http://www.ilinux.io/test/，这时可以看到sessionID是不会变化的</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/15/linux性能监控命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/15/linux性能监控命令/" itemprop="url">
                  linux性能监控命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-15 17:08:59" itemprop="dateCreated datePublished" datetime="2019-01-15T17:08:59+08:00">2019-01-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-17 00:04:07" itemprop="dateModified" datetime="2019-01-17T00:04:07+08:00">2019-01-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="CPU查看"><a href="#CPU查看" class="headerlink" title="CPU查看"></a>CPU查看</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# cat /proc/cpuinfo |grep "physical id"|sort|uniq|wc -l</span><br><span class="line">1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看物理cpu个数</span></span><br><span class="line">[root@test ~]# cat /proc/cpuinfo |grep "cpu cores"|wc -l                       </span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看每个物理cpu中的核心数</span></span><br><span class="line">[root@test ~]# cat /proc/cpuinfo |grep "processor"|wc -l             </span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 逻辑cpu的个数。物理cpu个数*核数=逻辑cpu个数（不支持超线程技术的情况下）</span></span><br><span class="line">[root@test ~]# lscpu</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此命令也可查询上述信息</span></span><br></pre></td></tr></table></figure>
<h3 id="内存查看"><a href="#内存查看" class="headerlink" title="内存查看"></a>内存查看</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           976M        127M        510M         55M        338M        625M</span><br><span class="line">Swap:          2.0G          0B        2.0G</span><br><span class="line"><span class="meta">#</span><span class="bash"> total：内存总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> used：已经使用的内存数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> free：空闲内存数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> shared：多个进程共享的内存总额</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - buffers/cache：(已用)的内存数，即used-buffers-cached(CentOS6)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> + buffers/cache：(可用)的内存数，即free+buffers+cached(CentOS6)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Buffer Cache用于针对磁盘块的读写；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Page Cache用于针对文件inode的读写，这些Cache能有效地缩短I/O系统调用的时间。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对操作系统来说free/used是系统可用/占用的内存；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对应用程序来说-/+ buffers/cache是可用/占用内存,因为buffers/cache很快就会被使用。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 经验公式：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 应用程序可用内存/系统物理内存&gt;70%，表示系统内存资源非常充足，不影响系统性能;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 应用程序可用内存/系统物理内存&lt;20%，表示系统内存资源紧缺，需要增加系统内存;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 20%&lt;应用程序可用内存/系统物理内存&lt;70%，表示系统内存资源基本能满足应用需求，暂时不影响系统性能</span></span><br></pre></td></tr></table></figure>
<h3 id="磁盘查看"><a href="#磁盘查看" class="headerlink" title="磁盘查看"></a>磁盘查看</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# fdisk -l</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看硬盘及分区信息</span></span><br><span class="line">[root@test ~]# df -h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看文件系统的磁盘空间占用情况</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# du -sh /etc</span><br><span class="line">35M     /etc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看linux系统中某目录的大小</span></span><br></pre></td></tr></table></figure>
<h3 id="其他参数"><a href="#其他参数" class="headerlink" title="其他参数"></a>其他参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# lsmod</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统已载入的相关模块</span></span><br><span class="line">[root@test ~]# lspci</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看pci设置</span></span><br><span class="line">[root@test ~]# uname -a</span><br><span class="line">Linux test 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内核版本号等信息，也可以使用-r选项，只显示内核信息</span></span><br><span class="line">[root@test ~]# file /lib/systemd/systemd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统是32位还是64位的</span></span><br><span class="line">[root@test ~]# cat /etc/redhat-release </span><br><span class="line">CentOS Linux release 7.4.1708 (Core)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看发行版</span></span><br></pre></td></tr></table></figure>
<h3 id="uptime命令"><a href="#uptime命令" class="headerlink" title="uptime命令"></a>uptime命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# uptime </span><br><span class="line"> 21:14:43 up 1 min,  1 user,  load average: 0.05, 0.03, 0.01</span><br><span class="line"><span class="meta"> #</span><span class="bash"> load average三值大小一般不能大于系统CPU的个数。系统有8个CPU,如load average三值长期大于8，说明CPU很繁忙，负载很高，可能会影响系统性能。如load average输出值小于CPU个数，则表示CPU有空闲时间片，比如本例中的输出，CPU是非常空闲的</span></span><br></pre></td></tr></table></figure>
<h3 id="PS命令"><a href="#PS命令" class="headerlink" title="PS命令"></a>PS命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">用途</span><br><span class="line">显示进程的状态。</span><br><span class="line"></span><br><span class="line">语法</span><br><span class="line">ps [options] [--help]</span><br><span class="line"></span><br><span class="line">参数</span><br><span class="line">-A 列出所有的行程</span><br><span class="line">-w 显示加宽可以显示较多的资讯</span><br><span class="line">au 显示较详细的资讯</span><br><span class="line">aux 显示所有包含其他使用者的行程，也可使用-ef参数</span><br><span class="line"></span><br><span class="line">* au(x) 输出格式 :</span><br><span class="line">USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND</span><br><span class="line">USER: 进程拥有者</span><br><span class="line">PID: pid</span><br><span class="line"><span class="meta">%</span><span class="bash">CPU: 占用的 CPU 使用率</span></span><br><span class="line"><span class="meta">%</span><span class="bash">MEM: 占用的内存使用率</span></span><br><span class="line">VSZ: 占用的虚拟内存大小</span><br><span class="line">RSS: 占用的内存大小</span><br><span class="line">TTY: 终端的次要装置号码 (minor device number of tty)</span><br><span class="line">STAT: 此进程的状态:</span><br><span class="line">D: 不可中断的</span><br><span class="line">R: 正在执行中</span><br><span class="line">S: 静止状态</span><br><span class="line">T: 暂停执行</span><br><span class="line">Z: 不存在但暂时无法消除</span><br><span class="line">W: 没有足够的内存分页可分配</span><br><span class="line">&lt;: 高优先级的进程</span><br><span class="line">N: 低优先级的进程</span><br><span class="line">L: 有内存分页分配并锁在内存内 (实时系统或A I/O)</span><br><span class="line">START: 进程开始时间</span><br><span class="line">TIME: 执行的时间</span><br><span class="line">COMMAND:所执行的指令</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@test ~]# ps -A</span><br><span class="line">   PID TTY          TIME CMD</span><br><span class="line">     1 ?        00:00:02 systemd</span><br><span class="line">     2 ?        00:00:00 kthreadd</span><br><span class="line">     3 ?        00:00:00 ksoftirqd/0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示进程信息</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# ps -u root</span><br><span class="line">   PID TTY          TIME CMD</span><br><span class="line">     1 ?        00:00:02 systemd</span><br><span class="line">     2 ?        00:00:00 kthreadd</span><br><span class="line">     3 ?        00:00:00 ksoftirqd/0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示root用户的进程信息</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# ps -ef</span><br><span class="line">UID         PID   PPID  C STIME TTY          TIME CMD</span><br><span class="line">root          1      0  0 10:02 ?        00:00:02 /usr/lib/systemd/systemd --switched-root --s</span><br><span class="line">root          2      0  0 10:02 ?        00:00:00 [kthreadd]</span><br><span class="line">root          3      2  0 10:02 ?        00:00:00 [ksoftirqd/0]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有命令，连带命令行</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# ps axo user,comm,pid,psr,pcpu</span><br><span class="line">USER     COMMAND            PID PSR %CPU</span><br><span class="line">root     systemd              1   1  0.0</span><br><span class="line">root     kthreadd             2   0  0.0</span><br><span class="line">root     ksoftirqd/0          3   0  0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个命令是查看进程的名称、PID以及CPU的占用率。psr表示绑定内核线程的处理器（如果有）的逻辑处理器号。 对一个进程来说，如果它的线程全都绑定到同一处理器上，那么显示该字段。pcpu表示CPU的占用率。comm表示进程名称。pid表示进程的ID号</span></span><br></pre></td></tr></table></figure>
<h3 id="top命令"><a href="#top命令" class="headerlink" title="top命令"></a>top命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">用途</span><br><span class="line">用于实时显示 process 的动态。</span><br><span class="line"></span><br><span class="line">语法</span><br><span class="line">top [-] [d delay] [c] [S] [s] [i] [n] [b]</span><br><span class="line"></span><br><span class="line">参数</span><br><span class="line">d : 改变显示的更新速度，或在交互式指令列( interactive command)按 s</span><br><span class="line">c : 切换显示模式，共有两种模式，一是只显示执行程序的名称，另一种是显示完整的路径与名称</span><br><span class="line">S : 累积模式，会将己完成或消失的子行程 ( dead child process ) 的 CPU time 累积起来</span><br><span class="line">s : 安全模式，将交互式指令取消, 避免潜在的危机</span><br><span class="line">i : 不显示任何闲置 (idle) 或无用 (zombie) 的进程</span><br><span class="line">n : 更新的次数，完成后将会退出 top</span><br><span class="line">b : 批次模式，搭配 "n" 参数一起使用，可以用来将 top 的结果输出到文件内</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@test ~]# top</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示进程信息</span></span><br><span class="line">top - 17:44:23 up  7:42,  4 users,  load average: 0.02, 0.02, 0.05</span><br><span class="line">Tasks: 110 total,   1 running, 109 sleeping,   0 stopped,   0 zombie</span><br><span class="line"><span class="meta">%</span><span class="bash">Cpu(s):  0.0 us,  0.5 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.2 si,  0.0 st</span></span><br><span class="line">KiB Mem :   999720 total,   522516 free,   131076 used,   346128 buff/cache</span><br><span class="line">KiB Swap:  2097148 total,  2097148 free,        0 used.   640836 avail Mem </span><br><span class="line"></span><br><span class="line">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                 </span><br><span class="line">   893 root      20   0  549.2m  18.2m   5.7m S   0.3  1.9   0:03.52 /usr/bin/python -Es /us+</span><br><span class="line">   </span><br><span class="line">* 统计信息区</span><br><span class="line">前五行是系统整体的统计信息。第一行是任务队列信息，同 uptime 命令的执行结果。其内容如下：</span><br><span class="line">01:06:48：当前时间</span><br><span class="line">up 1:22：系统运行时间，格式为时:分</span><br><span class="line">1 user：当前登录用户数</span><br><span class="line">load average: 0.06, 0.60, 0.48：系统负载，即任务队列的平均长度。三个数值分别为 1分钟、5分钟、15分钟前到现在的平均值。</span><br><span class="line">第二、三行为进程和CPU的信息。当有多个CPU时，这些内容可能会超过两行。内容如下：</span><br><span class="line">Tasks: 29 total：进程总数</span><br><span class="line">1 running：正在运行的进程数</span><br><span class="line">28 sleeping：睡眠的进程数</span><br><span class="line">0 stopped：停止的进程数</span><br><span class="line">0 zombie：僵尸进程数</span><br><span class="line">Cpu(s): 0.3% us：用户空间占用CPU百分比</span><br><span class="line">1.0% sy： 内核空间占用CPU百分比</span><br><span class="line">0.0% ni：用户进程空间内改变过优先级的进程占用CPU百分比</span><br><span class="line">98.7% id：空闲CPU百分比</span><br><span class="line">0.0% wa：等待输入输出的CPU时间百分比</span><br><span class="line">0.0% hi</span><br><span class="line">0.0% si</span><br><span class="line">最后两行为内存信息。内容如下：</span><br><span class="line">Mem: 191272k total：物理内存总量</span><br><span class="line">173656k used：使用的物理内存总量</span><br><span class="line">17616k free：空闲内存总量</span><br><span class="line">22052k buffers：用作内核缓存的内存量</span><br><span class="line">Swap: 192772k total：交换区总量</span><br><span class="line">0k used：使用的交换区总量</span><br><span class="line">192772k free：空闲交换区总量</span><br><span class="line">123988k cached：缓冲的交换区总量。</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存中的内容被换出到交换区，而后又被换入到内存，但使用过的交换区尚未被覆盖，该数值即为这些内容已存在于内存中的交换区的大小。相应的内存再次被换出时可不必再对交换区写入。</span></span><br><span class="line"></span><br><span class="line">* 进程信息区</span><br><span class="line">统计信息区域的下方显示了各个进程的详细信息。</span><br><span class="line">PID：进程id</span><br><span class="line">PPID：父进程id</span><br><span class="line">RUSER Real user name</span><br><span class="line">UID：进程所有者的用户id</span><br><span class="line">USER：进程所有者的用户名</span><br><span class="line">GROUP：进程所有者的组名</span><br><span class="line">TTY：启动进程的终端名。不是从终端启动的进程则显示为 ?</span><br><span class="line">PR：优先级</span><br><span class="line">NI：nice值。负值表示高优先级，正值表示低优先级</span><br><span class="line">P：最后使用的CPU，仅在多CPU环境下有意义</span><br><span class="line"><span class="meta">%</span><span class="bash">CPU：上次更新到现在的CPU时间占用百分比</span></span><br><span class="line">TIME：进程使用的CPU时间总计，单位秒</span><br><span class="line">TIME+：进程使用的CPU时间总计，单位1/100秒</span><br><span class="line"><span class="meta">%</span><span class="bash">MEM：进程使用的物理内存百分比</span></span><br><span class="line">VIRT：进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES</span><br><span class="line">SWAP：进程使用的虚拟内存中，被换出的大小，单位kb。</span><br><span class="line">RES：进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA</span><br><span class="line">CODE：可执行代码占用的物理内存大小，单位kb</span><br><span class="line">DATA：可执行代码以外的部分(数据段+栈)占用的物理内存大小，单位kb</span><br><span class="line">SHR：共享内存大小，单位kb</span><br><span class="line">nFLT：页面错误次数</span><br><span class="line">nDRT：最后一次写入到现在，被修改过的页面数。</span><br><span class="line">S：进程状态。</span><br><span class="line">    D=不可中断的睡眠状态</span><br><span class="line">    R=运行</span><br><span class="line">    S=睡眠</span><br><span class="line">    T=跟踪/停止</span><br><span class="line">    Z=僵尸进程</span><br><span class="line">COMMAND：命令名/命令行</span><br><span class="line">WCHAN：若该进程在睡眠，则显示睡眠中的系统函数名</span><br><span class="line">Flags：任务标志</span><br><span class="line"></span><br><span class="line">* 更改显示内容</span><br><span class="line">通过 f 键可以选择显示的内容。按 f 键之后会显示列的列表，按 a-z 即可显示或隐藏对应的列，最后按回车键确定。</span><br><span class="line">按 o 键可以改变列的显示顺序。按小写的 a-z 可以将相应的列向右移动，而大写的 A-Z 可以将相应的列向左移动。最后按回车键确定。</span><br><span class="line">按大写的 F 或 O 键，然后按 a-z 可以将进程按照相应的列进行排序。而大写的 R 键可以将当前的排序倒转。</span><br><span class="line"></span><br><span class="line">* 交互命令</span><br><span class="line">h或者?：显示帮助画面，给出一些简短的命令总结说明。</span><br><span class="line">k：终止一个进程。系统将提示用户输入需要终止的进程PID，以及需要发送给该进程什么样的信号。一般的终止进程可以使用15信号；如果不能正常结束那就使用信号9强制结束该进程。默认值是信号15。在安全模式中此命令被屏蔽。</span><br><span class="line">i：忽略闲置和僵死进程。这是一个开关式命令。</span><br><span class="line">q：退出程序。</span><br><span class="line">r ：重新安排一个进程的优先级别。系统提示用户输入需要改变的进程PID以及需要设置的进程优先级值。输入一个正值将使优先级降低，反之则可以使该进程拥有更高的优先权。默认值是10。</span><br><span class="line">S：切换到累计模式。</span><br><span class="line">s：改变两次刷新之间的延迟时间。系统将提示用户输入新的时间，单位为s。如果有小数，就换算成m s。输入0值则系统将不断刷新，默认值是5 s。需要注意的是如果设置太小的时间，很可能会引起不断刷新，从而根本来不及看清显示的情况，而且系统负载也会大大增加。</span><br><span class="line">f或者F：从当前显示中添加或者删除项目。</span><br><span class="line">o或者O：改变显示项目的顺序。</span><br><span class="line">l：切换显示平均负载和启动时间信息。</span><br><span class="line">m：切换显示内存信息。</span><br><span class="line">t：切换显示进程和CPU状态信息。</span><br><span class="line">c：切换显示命令名称和完整命令行。</span><br><span class="line">M：根据驻留内存大小进行排序。</span><br><span class="line">P：根据CPU使用百分比大小进行排序。</span><br><span class="line">T：根据时间/累计时间进行排序。</span><br><span class="line">W：将当前设置写入~/.toprc文件中。</span><br><span class="line">1：查看CPU数量</span><br><span class="line"></span><br><span class="line">[root@test ~]# top -c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示完整命令</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# top -b</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以批处理模式显示程序信息</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# top -S</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以累积模式显示程序信息</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# top -n 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置信息更新次数，这里会更新两次后终止更新显示</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# top -d 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置信息更新时间，这条命令更新周期为3秒</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# top -p 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示指定的进程信息</span></span><br></pre></td></tr></table></figure>
<h3 id="iostat命令"><a href="#iostat命令" class="headerlink" title="iostat命令"></a>iostat命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">用法：iostat [ 选项 ] [ &lt;时间间隔&gt; [ &lt;次数&gt; ]]</span><br><span class="line">常用选项说明：</span><br><span class="line">-c：只显示系统CPU统计信息，即单独输出avg-cpu结果，不包括device结果</span><br><span class="line">-d：单独输出Device结果，不包括cpu结果</span><br><span class="line">-k/-m：输出结果以kB/mB为单位，而不是以扇区数为单位</span><br><span class="line">-x：输出更详细的io设备统计信息</span><br><span class="line">interval/count：每次输出间隔时间，count表示输出次数，不带count表示循环输出</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此命令需要安装sysstat包</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@test ~]# iostat</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从系统开机到当前执行时刻的统计信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avg-cpu: 总体cpu使用情况统计信息，对于多核cpu，这里为所有cpu的平均值。重点关注iowait值，表示CPU用于等待io请求的完成时间。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Device：各磁盘设备的IO统计信息。各列含义如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Device：以sdX形式显示的设备名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tps： 每秒进程下发的IO读、写请求数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> KB_read/s：每秒从驱动器读入的数据量，单位为K。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> KB_wrtn/s：每秒从驱动器写入的数据量，单位为K。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> KB_read：读入数据总量，单位为K。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> KB_wrtn：写入数据总量，单位为K。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  重点关注参数：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iowait% 表示CPU等待IO时间占整个CPU周期的百分比，如果iowait值超过50%，或者明显大于%system、%user以及%idle，表示IO可能存在问题。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avgqu-sz 表示磁盘IO队列长度，即IO等待个数。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> await 表示每次IO请求等待时间，包括等待时间和处理时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> svctm 表示每次IO请求处理的时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %util 表示磁盘忙碌情况，一般该值超过80%表示该磁盘可能处于繁忙状态。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# ll /dev/centos/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 7 Jan 16 21:13 root -&gt; ../dm-0</span><br><span class="line">lrwxrwxrwx 1 root root 7 Jan 16 21:13 swap -&gt; ../dm-1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用此命令查看dm-*对应的分区名称</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# iostat -x -k -d 1 2</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sda               0.00     0.02    0.62    0.12    12.85     1.85    40.04     0.00    0.32    0.28    0.55   0.16   0.01</span><br><span class="line">dm-0              0.00     0.00    0.34    0.13    11.44     1.58    55.41     0.00    0.52    0.46    0.65   0.21   0.01</span><br><span class="line">dm-1              0.00     0.00    0.01    0.00     0.30     0.00    47.40     0.00    0.13    0.13    0.00   0.06   0.00</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每隔1秒输出磁盘IO的详细信息，总共采样2次</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rrqm/s：每秒对该设备的读请求被合并次数，文件系统会对读取同块(block)的请求进行合并</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wrqm/s：每秒对该设备的写请求被合并次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> r/s：每秒完成的读次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> w/s：每秒完成的写次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rkB/s：每秒读数据量(kB为单位)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wkB/s：每秒写数据量(kB为单位)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avgrq-sz：平均每次IO操作的数据量(扇区数为单位)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avgqu-sz：平均等待处理的IO请求队列长度</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> await：平均每次IO请求等待时间(包括等待时间和处理时间，毫秒为单位)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> svctm：平均每次IO请求的处理时间(毫秒为单位)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %util：采用周期内用于IO操作的时间比率，即IO队列非空的时间比率</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# iostat -x 1 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看硬盘的I/O性能。每隔一秒显示一次，显示5次。如果%util接近100%,说明产生的I/O请求太多，I/O系统已经满负荷，该磁盘可能存在瓶颈。如果idle小于70%，I/O的压力就比较大了，说明读取进程中有较多的<span class="built_in">wait</span>。</span></span><br></pre></td></tr></table></figure>
<h3 id="vmstat命令"><a href="#vmstat命令" class="headerlink" title="vmstat命令"></a>vmstat命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# vmstat 2 2</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class="line"> 1  0      0 766596   2108 116392    0    0   334    36  144  191  0  1 98  0  0</span><br><span class="line"> 0  0      0 766596   2108 116392    0    0     0     0  180  148  0  0 100  0  0</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 显示系统各种资源之间相关性能简要信息，主要看CPU负载情况。2表示每个两秒采集一次服务器状态，2表示只采集两次。也可以只使用vmstat 2命令，每2秒显示一次，一直监控</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> r：表示运行队列(就是说多少个进程真的分配到CPU)，我测试的服务器目前CPU比较空闲，没什么程序在跑，当这个值超过了CPU数目，就会出现CPU瓶颈了。这个也和top的负载有关系，一般负载超过了3就比较高，超过了5就高，超过了10就不正常了，服务器的状态很危险。top的负载类似每秒的运行队列。如果运行队列过大，表示你的CPU很繁忙，一般会造成CPU使用率很高。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> b：表示阻塞的进程,这个不多说，进程阻塞，大家懂的。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> swpd：虚拟内存已使用的大小，如果大于0，表示你的机器物理内存不足了，如果不是程序内存泄露的原因，那么你该升级内存了或者把耗内存的任务迁移到其他机器。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> free：空闲的物理内存的大小，我的机器内存总共8G，剩余3415M。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> buff：Linux/Unix系统是用来存储，目录里面有什么内容，权限等的缓存，我本机大概占用300多M</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cache：cache直接用来记忆我们打开的文件,给文件做缓冲，我本机大概占用300多M(这里是Linux/Unix的聪明之处，把空闲的物理内存的一部分拿来做文件和目录的缓存，是为了提高 程序执行的性能，当程序使用内存时，buffer/cached会很快地被使用。)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> si：每秒从磁盘读入虚拟内存的大小，如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉。我的机器内存充裕，一切正常。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> so：每秒虚拟内存写入磁盘的大小，如果这个值大于0，同上。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bi：块设备每秒接收的块数量，这里的块设备是指系统上所有的磁盘和其他块设备，默认块大小是1024byte，我本机上没什么IO操作，所以一直是0，但是我曾在处理拷贝大量数据(2-3T)的机器上看过可以达到140000/s，磁盘写入速度差不多140M每秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bo：块设备每秒发送的块数量，例如我们读取文件，bo就要大于0。bi和bo一般都要接近0，不然就是IO过于频繁，需要调整。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span>：每秒CPU的中断次数，包括时间中断</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cs：每秒上下文切换次数，例如我们调用系统函数，就要进行上下文切换，线程的切换，也要进程上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的数目,例如在apache和nginx这种web服务器中，我们一般做性能测试时会进行几千并发甚至几万并发的测试，选择web服务器的进程可以由进程或者线程的峰值一直下调，压测，直到cs到一个比较小的值，这个进程和线程数就是比较合适的值了。系统调用也是，每次调用系统函数，我们的代码就会进入内核空间，导致上下文切换，这个是很耗资源，也要尽量避免频繁调用系统函数。上下文切换次数过多表示你的CPU大部分浪费在上下文切换，导致CPU干正经事的时间少了，CPU没有充分利用，是不可取的。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> us：用户CPU时间，我曾经在一个做加密解密很频繁的服务器上，可以看到us接近100,r运行队列达到80(机器在做压力测试，性能表现不佳)。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sy：系统CPU时间，如果太高，表示系统调用时间长，例如是IO操作频繁。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> id：空闲 CPU时间，一般来说，id + us + sy = 100,一般我认为id是空闲CPU使用率，us是用户CPU使用率，sy是系统CPU使用率。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> si、so的值长期不为0，表示系统内存不足。需增加系统内存。</span></span><br></pre></td></tr></table></figure>
<h3 id="sar命令"><a href="#sar命令" class="headerlink" title="sar命令"></a>sar命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"> sar（System ActivityReporter系统活动情况报告）是目前Linux上最为全面的系统性能分析工具之一，可以从多方面对系统的活动进行报告，包括：文件的读写情况、系统调用的使用情况、磁盘I/O、CPU效率、内存使用状况、进程活动及IPC有关的活动等，sar命令由sysstat安装包安装</span><br><span class="line"></span><br><span class="line">用法: sar [ 选项 ] [ &lt;时间间隔&gt; [ &lt;次数&gt; ] ]</span><br><span class="line">选项:</span><br><span class="line">-A：所有报告的总和</span><br><span class="line">-b：显示I/O和传递速率的统计信息</span><br><span class="line">-B：显示换页状态</span><br><span class="line">-d：输出每一块磁盘的使用信息</span><br><span class="line">-e：设置显示报告的结束时间</span><br><span class="line">-f：从制定的文件读取报告</span><br><span class="line">-i：设置状态信息刷新的间隔时间</span><br><span class="line">-P：报告每个CPU的状态</span><br><span class="line">-R：显示内存状态</span><br><span class="line">-u：输出cpu使用情况和统计信息</span><br><span class="line">-v：显示索引节点、文件和其他内核表的状态</span><br><span class="line">-w：显示交换分区的状态</span><br><span class="line">-x：显示给定进程的装</span><br><span class="line">-r：报告内存利用率的统计信息</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@test ~]# sar -u 3 4</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:18:58 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">09:19:01 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">09:19:04 PM     all      0.00      0.00      0.17      0.00      0.00     99.83</span><br><span class="line">09:19:07 PM     all      0.00      0.00      0.17      0.00      0.00     99.83</span><br><span class="line">09:19:10 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">Average:        all      0.00      0.00      0.08      0.00      0.00     99.92</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每间隔3秒钟统计一次总共统计4次</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %user：显示用户进程消耗的CPU 时间百分比。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %nice：显示运行正常进程所消耗的CPU 时间百分比。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %system：显示系统进程消耗的CPU时间百分比。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %iowait：显示IO等待所占用的CPU时间百分比</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %steal：显示在内存相对紧张的环境下pagein强制对不同的页面进行的steal操作 。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %idle：显示CPU处在空闲状态的时间百分比。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果系统CPU整体利用率不高，而应用响应缓慢，可能是在一个多CPU的系统中，程序使用了单线程的原因。单线程只使用一个CPU，导致这个CPU占用率为100%，无法处理其它请求，而其它的CPU却闲置，这就导致了整体CPU使用率不高，而应用缓慢现象的发生。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在以上的显示当中，主要看%iowait和%idle，%iowait过高表示存在I/O瓶颈，即磁盘IO无法满足业务需求，如果%idle过低表示CPU使用率比较严重，需要结合内存使用等情况判断CPU是否瓶颈。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -P 1 3 3</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:36:03 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">11:36:06 PM       1      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">11:36:09 PM       1      0.00      0.00      0.33      0.00      0.00     99.67</span><br><span class="line">11:36:12 PM       1      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">Average:          1      0.00      0.00      0.11      0.00      0.00     99.89</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-P选项指定监控1号CPU信息，每3秒显示一次，一共显示3次</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -u -o /tmp/1.txt 2 3</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:37:52 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">11:37:54 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">11:37:56 PM     all      0.00      0.00      0.25      0.00      0.00     99.75</span><br><span class="line">11:37:58 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">Average:        all      0.00      0.00      0.08      0.00      0.00     99.92</span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存监控文件，保存后的文件是二进制的，无法使用vim和cat直接打开</span></span><br><span class="line">[root@test ~]# sar -u -f /tmp/1.txt </span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:37:52 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">11:37:54 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">11:37:56 PM     all      0.00      0.00      0.25      0.00      0.00     99.75</span><br><span class="line">11:37:58 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">Average:        all      0.00      0.00      0.08      0.00      0.00     99.92</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从二进制文件读取</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -q</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:13:34 PM       LINUX RESTART</span><br><span class="line"></span><br><span class="line">09:20:01 PM   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked</span><br><span class="line">09:30:01 PM         0       113      0.00      0.01      0.01         0</span><br><span class="line">09:40:01 PM         0       113      0.08      0.03      0.02         0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看平均负载</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> runq-sz：运行队列的长度（等待运行的进程数，每核的CP不能超过3个）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> plist-sz：进程列表中的进程（processes）和线程数（threads）的数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ldavg-1：最后1分钟的CPU平均负载，即将多核CPU过去一分钟的负载相加再除以核心数得出的平均值，5分钟和15分钟以此类推</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ldavg-5：最后5分钟的CPU平均负载</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ldavg-15：最后15分钟的CPU平均负载</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -r</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:13:34 PM       LINUX RESTART</span><br><span class="line"></span><br><span class="line">09:20:01 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">09:30:01 PM    765604    234116     23.42      2108     77200    268076      8.66     83636     62712         0</span><br><span class="line">09:40:01 PM    765664    234056     23.41      2108     77212    268076      8.66     83944     62428         0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内存使用情况</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kbmemfree：空闲的物理内存大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kbmemused：使用中的物理内存大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %memused：物理内存使用率</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kbbuffers：内核中作为缓冲区使用的物理内存大小，kbbuffers和kbcached:这两个值就是free命令中的buffer和cache. </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kbcached：缓存的文件大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kbcommit：保证当前系统正常运行所需要的最小内存，即为了确保内存不溢出而需要的最少内存（物理内存+Swap分区）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> commit 这个值是kbcommit与内存总量（物理内存+swap分区）的一个百分比的值</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -W</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:13:34 PM       LINUX RESTART</span><br><span class="line"></span><br><span class="line">09:20:01 PM  pswpin/s pswpout/s</span><br><span class="line">09:30:01 PM      0.00      0.00</span><br><span class="line">09:40:01 PM      0.00      0.00</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统swap分区的统计信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pswpin/s：每秒从交换分区到系统的交换页面（swap page）数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pswpott/s：每秒从系统交换到swap的交换页面（swap page）的数量</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -b</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:13:34 PM       LINUX RESTART</span><br><span class="line"></span><br><span class="line">09:20:01 PM       tps      rtps      wtps   bread/s   bwrtn/s</span><br><span class="line">09:30:01 PM      0.08      0.00      0.08      0.00      1.18</span><br><span class="line">09:40:01 PM      0.09      0.00      0.09      0.00      1.12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看I/O和传递速率的统计信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tps：磁盘每秒钟的IO总数，等于iostat中的tps</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rtps：每秒钟从磁盘读取的IO总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wtps：每秒钟从写入到磁盘的IO总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bread/s：每秒钟从磁盘读取的块总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bwrtn/s：每秒钟此写入到磁盘的块总数</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -dp 2 2</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:44:35 PM       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util</span><br><span class="line">11:44:37 PM       sda      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line"><span class="meta">#</span><span class="bash"> sar –d组合，可以对系统的磁盘IO做一个基本的统计</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DEV 磁盘设备的名称，如果不加-p，会显示dev253-0类似的设备名称，因此加上-p显示的名称更直接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tps：每秒I/O的传输总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rd_sec/s：每秒读取的扇区的总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wr_sec/s：每秒写入的扇区的总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avgrq-sz：平均每次次磁盘I/O操作的数据大小（扇区）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avgqu-sz：磁盘请求队列的平均长度</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> await：平均每次设备I/O操作等待时间（毫秒）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> svctm：平均每次设备I/O操作的服务时间（毫秒）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %util：一秒钟有百分之几的时间用于I/O操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对磁盘IO性能评判标准：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 正常svctm应小于await值，而svctm和磁盘性能有关，CPU、内存负荷也会对svctm值造成影响，过多的请求也会间接的导致svctm值的增加。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> await值取决svctm和I/O队列长度以及I/O请求模式，如果svctm的值与await很接近，表示几乎没有I/O等待，磁盘性能很好，如果await的值远高于svctm的值，则表示I/O队列等待太长，系统上运行的应用程序将变慢，此时可以通过更换更快的硬盘来解决问题。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %util：衡量磁盘I/O重要指标，如%util接近100%，表示磁盘产生的I/O请求太多，I/O系统已经满负荷工作，该磁盘可能存在瓶颈。可优化程序或者 通过更换 更高、更快的磁盘。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -v</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:13:34 PM       LINUX RESTART</span><br><span class="line"></span><br><span class="line">09:20:01 PM dentunusd   file-nr  inode-nr    pty-nr</span><br><span class="line">09:30:01 PM      8571      1088     17484         1</span><br><span class="line">09:40:01 PM      8574      1120     17481         1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进程、inode、文件和锁表状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dentunusd：在缓冲目录条目中没有使用的条目数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> file-nr：被系统使用的文件句柄数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> inode-nr：已经使用的索引数量 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pty-nr：使用的pty数量</span></span><br><span class="line">================================================================================</span><br><span class="line">这里面的索引和文件句柄值不是ulimit -a查看到的值，而是sysctl.conf里面定义的和内核相关的值， max-file表示系统级别的能够打开的文件句柄的数量， 而ulimit -n控制进程级别能够打开的文件句柄的数量，可以使用sysctl  -a | grep inode和sysctl  -a | grep file查看，具体含义如下：</span><br><span class="line"></span><br><span class="line">file-max中指定了系统范围内所有进程可打开的文件句柄的数量限制(系统级别， kernel-level)。 （The value in file-max denotes the maximum number of file handles that the Linux kernel will allocate）。当收到"Too many open files in system"这样的错误消息时， 就应该增加这个值了。</span><br><span class="line">[root@test ~]# cat /proc/sys/fs/file-max</span><br><span class="line">95823</span><br><span class="line">[root@test ~]# echo 100000 &gt; /proc/sys/fs/file-max</span><br><span class="line">或者</span><br><span class="line">[root@test ~]# echo ""fs.file-max=65535" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@test ~]# sysctl -p</span><br><span class="line">file-nr 可以查看系统中当前打开的文件句柄的数量。 他里面包括3个数字： 第一个表示已经分配了的文件描述符数量， 第二个表示空闲的文件句柄数量， 第三个表示能够打开文件句柄的最大值（跟file-max一致）。  内核会动态的分配文件句柄， 但是不会再次释放他们（这个可能不适应最新的内核了， 在我的file-nr中看到第二列一直为0， 第一列有增有减）	</span><br><span class="line">man bash， 找到说明ulimit的那一节：提供对shell及其启动的进程的可用资源（包括文件句柄， 进程数量， core文件大小等）的控制。 这是进程级别的， 也就是说系统中某个session及其启动的每个进程能打开多少个文件描述符， 能fork出多少个子进程等... 当达到上限时， 会报错"Too many open files"或者遇上Socket/File: Can’t open so many files等</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -n DEV 1 1</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:52:46 PM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</span><br><span class="line">11:52:47 PM     ens35      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">11:52:47 PM        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">11:52:47 PM     ens33      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每间隔1秒统计一次，总计统计1次</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sar -n选项使用6个不同的开关：DEV，EDEV，NFS，NFSD，SOCK，IP，EIP，ICMP，EICMP，TCP，ETCP，UDP，SOCK6，IP6，EIP6，ICMP6，EICMP6和UDP6 ，DEV显示网络接口信息，EDEV显示关于网络错误的统计数据，NFS统计活动的NFS客户端的信息，NFSD统计NFS服务器的信息，SOCK显示套接字信息，ALL显示所有5个开关。它们可以单独或者一起使用。 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IFACE：本地网卡接口的名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxpck/s：每秒钟接受的数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txpck/s：每秒钟发送的数据库</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxKB/S：每秒钟接受的数据包大小，单位为KB</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txKB/S：每秒钟发送的数据包大小，单位为KB</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxcmp/s：每秒钟接受的压缩数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txcmp/s：每秒钟发送的压缩包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxmcst/s：每秒钟接收的多播数据包  </span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -n EDEV 1 1</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:55:30 PM     IFACE   rxerr/s   txerr/s    coll/s  rxdrop/s  txdrop/s  txcarr/s  rxfram/s  rxfifo/s  txfifo/s</span><br><span class="line">11:55:31 PM     ens35      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">11:55:31 PM        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">11:55:31 PM     ens33      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计网络设备通信失败信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IFACE：网卡名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxerr/s：每秒钟接收到的损坏的数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txerr/s：每秒钟发送的数据包错误数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> coll/s：当发送数据包时候，每秒钟发生的冲撞（collisions）数，这个是在半双工模式下才有</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxdrop/s：当由于缓冲区满的时候，网卡设备接收端每秒钟丢掉的网络包的数目</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txdrop/s：当由于缓冲区满的时候，网络设备发送端每秒钟丢掉的网络包的数目</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txcarr/s：当发送数据包的时候，每秒钟载波错误发生的次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxfram：在接收数据包的时候，每秒钟发生的帧对其错误的次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxfifo：在接收数据包的时候，每秒钟缓冲区溢出的错误发生的次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txfifo：在发生数据包 的时候，每秒钟缓冲区溢出的错误发生的次数</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -n SOCK 1 1    </span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:57:03 PM    totsck    tcpsck    udpsck    rawsck   ip-frag    tcp-tw</span><br><span class="line">11:57:04 PM       568         3         4         0         0         0</span><br><span class="line">Average:          568         3         4         0         0         0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计socket连接信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> totsck：当前被使用的socket总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tcpsck：当前正在被使用的TCP的socket总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> udpsck：当前正在被使用的UDP的socket总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rawsck：当前正在被使用于RAW的skcket总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span>-frag：当前的IP分片的数目</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tcp-tw：TCP套接字中处于TIME-WAIT状态的连接数量</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -n TCP 1 3</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:59:25 PM  active/s passive/s    iseg/s    oseg/s</span><br><span class="line">11:59:26 PM      0.00      0.00      0.00      0.00</span><br><span class="line">11:59:27 PM      0.00      0.00      1.00      1.00</span><br><span class="line">11:59:28 PM      0.00      0.00      1.00      1.00</span><br><span class="line">Average:         0.00      0.00      0.67      0.67</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP连接的统计</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> active/s：新的主动连接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> passive/s：新的被动连接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iseg/s：接受的段</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> oseg/s：输出的段</span></span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">sar -n 使用总结</span><br><span class="line">-n DEV ： 网络接口统计信息。</span><br><span class="line">-n EDEV ： 网络接口错误。</span><br><span class="line">-n IP ： IP数据报统计信息。</span><br><span class="line">-n EIP ： IP错误统计信息。</span><br><span class="line">-n TCP ： TCP统计信息。</span><br><span class="line">-n ETCP ： TCP错误统计信息。</span><br><span class="line">-n SOCK ： 套接字使用。</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line">常用命令</span><br><span class="line">sar -b 5 5：IO传送速率</span><br><span class="line">sar -B 5 5：页交换速率</span><br><span class="line">sar -c 5 5：进程创建的速率</span><br><span class="line">sar -d 5 5：块设备的活跃信息</span><br><span class="line">sar -n DEV 5 5：网路设备的状态信息</span><br><span class="line">sar -n SOCK 5 5：SOCK的使用情况</span><br><span class="line">sar -n ALL 5 5：所有的网络状态信息</span><br><span class="line">sar -P ALL 5 5：每颗CPU的使用状态信息和IOWAIT统计状态 </span><br><span class="line">sar -q 5 5：队列的长度（等待运行的进程数）和负载的状态</span><br><span class="line">sar -r 5 5：内存和swap空间使用情况</span><br><span class="line">sar -R 5 5：内存的统计信息（内存页的分配和释放、系统每秒作为BUFFER使用内存页、每秒被cache到的内存页）</span><br><span class="line">sar -u 5 5：CPU的使用情况和IOWAIT信息（同默认监控）</span><br><span class="line">sar -v 5 5 ：inode, file and other kernel tablesd的状态信息</span><br><span class="line">sar -w 5 5 ：每秒上下文交换的数目</span><br><span class="line">sar -W 5 5：SWAP交换的统计信息(监控状态同iostat 的si so)</span><br><span class="line">sar -x 2906 5 5：显示指定进程(2906)的统计信息，信息包括：进程造成的错误、用户级和系统级用户CPU的占用情况、运行在哪颗CPU上</span><br><span class="line">sar -y 5 5：TTY设备的活动状态</span><br><span class="line">sar将结果输出到文件(-o)和读取记录信息(-f)</span><br></pre></td></tr></table></figure>
<h3 id="netstat命令"><a href="#netstat命令" class="headerlink" title="netstat命令"></a>netstat命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">功能说明：显示网络状态。</span><br><span class="line">语　　法：netstat [-acCeFghilMnNoprstuvVwx] [-A&lt;网络类型&gt;][--ip]</span><br><span class="line">补充说明：利用netstat指令可让你得知整个Linux系统的网络情况。</span><br><span class="line">参　　数：</span><br><span class="line">-a 或--all：显示所有连线中的Socket。</span><br><span class="line">-A ：&lt;网络类型&gt;或–&lt;网络类型&gt; 列出该网络类型连线中的相关地址。</span><br><span class="line">-c或--continuous：持续列出网络状态。</span><br><span class="line">-C或--cache：显示路由器配置的快取信息。</span><br><span class="line">-e或--extend：显示网络其他相关信息。</span><br><span class="line">-F或--fib：显示FIB。</span><br><span class="line">-g或--groups：显示多重广播功能群组组员名单。</span><br><span class="line">-h或--help：在线帮助。</span><br><span class="line">-i或--interfaces：显示网络界面信息表单。</span><br><span class="line">-l或--listening：显示监控中的服务器的Socket。</span><br><span class="line">-M或--masquerade：显示伪装的网络连线。</span><br><span class="line">-n或--numeric：直接使用IP地址，而不通过域名服务器。</span><br><span class="line">-N或--netlink或--symbolic：显示网络硬件外围设备的符号连接名称。</span><br><span class="line">-o或--timers：显示计时器。</span><br><span class="line">-p或--programs：显示正在使用Socket的程序识别码和程序名称。</span><br><span class="line">-r或--route：显示 Routing Table。</span><br><span class="line">-s或--statistice：显示网络工作信息统计表。</span><br><span class="line">-t或--tcp：显示TCP 传输协议的连线状况。</span><br><span class="line">-u或--udp：显示UDP传输协议的连线状况。</span><br><span class="line">-v或--verbose：显示指令执行过程。</span><br><span class="line">-V或--version：显示版本信息。</span><br><span class="line">-w或--raw：显示RAW传输协议的连线状况。</span><br><span class="line">-x或--unix：此参数的效果和指定”-A unix”参数相同。</span><br><span class="line">–ip或--inet：此参数的效果和指定”-A inet”参数相同。</span><br><span class="line"></span><br><span class="line">网络连接状态详解</span><br><span class="line">共有12中可能的状态，前面11种是按照TCP连接建立的三次握手和TCP连接断开的四次挥手过程来描述的。</span><br><span class="line">1. LISTEN：首先服务端需要打开一个socket进行监听，状态为LISTEN。/* The socket is listening for incoming connections. 侦听来自远方TCP端口的连接请求*/</span><br><span class="line">2. SYN_SENT：客户端通过应用程序调用connect进行active open。于是客户端tcp发送一个SYN以请求建立一个连接。之后状态置为SYN_SENT。/*The socket is actively attempting to establish a connection. 在发送连接请求后等待匹配的连接请求 */</span><br><span class="line">3. SYN_RECV：服务端应发出ACK确认客户端的 SYN，同时自己向客户端发送一个SYN。之后状态置为SYN_RECV。/* A connection request has been received from the network. 在收到和发送一个连接请求后等待对连接请求的确认 */</span><br><span class="line">4. ESTABLISHED：代表一个打开的连接，双方可以进行或已经在数据交互了。/* The socket has an established connection. 代表一个打开的连接，数据可以传送给用户 */</span><br><span class="line">5. FIN_WAIT1：主动关闭(active close)端应用程序调用close，于是其TCP发出FIN请求主动关闭连接，之后进入FIN_WAIT1状态。/* The socket is closed, and the connection is shutting down. 等待远程TCP的连接中断请求，或先前的连接中断请求的确认 */</span><br><span class="line">6. CLOSE_WAIT：被动关闭(passive close)端TCP接到FIN后，就发出ACK以回应FIN请求(它的接收也作为文件结束符传递给上层应用程序)，并进入CLOSE_WAIT。/* The remote end has shut down, waiting for the socket to close. 等待从本地用户发来的连接中断请求 */</span><br><span class="line">7. FIN_WAIT2：主动关闭端接到ACK后，就进入了 FIN-WAIT-2 。/* Connection is closed, and the socket is waiting for a shutdown from the remote end. 从远程TCP等待连接中断请求 */</span><br><span class="line">8. LAST_ACK:：被动关闭端一段时间后，接收到文件结束符的应用程序将调用CLOSE关闭连接。这导致它的TCP也发送一个 FIN，等待对方的ACK。就进入了LAST-ACK 。/* The remote end has shut down, and the socket is closed. Waiting for acknowledgement. 等待原来发向远程TCP的连接中断请求的确认 */</span><br><span class="line">9. TIME_WAIT：在主动关闭端接收到FIN后，TCP 就发送ACK包，并进入TIME-WAIT状态。/* The socket is waiting after close to handle packets still in the network.等待足够的时间以确保远程TCP接收到连接中断请求的确认 */</span><br><span class="line">10. CLOSING: 比较少见。/* Both sockets are shut down but we still don’t have all our data sent. 等待远程TCP对连接中断的确认 */</span><br><span class="line">11. CLOSED：被动关闭端在接受到ACK包后，就进入了closed的状态。连接结束。/* The socket is not being used. 没有任何连接状态 */</span><br><span class="line">12. UNKNOWN：未知的Socket状态。/* The state of the socket is unknown. */</span><br><span class="line"></span><br><span class="line">SYN： (同步序列编号，Synchronize Sequence Numbers)该标志仅在三次握手建立TCP连接时有效。表示一个新的TCP连接请求。</span><br><span class="line">ACK：(确认编号，Acknowledgement Number)是对TCP请求的确认标志，同时提示对端系统已经成功接收所有数据。</span><br><span class="line">FIN： (结束标志，FINish)用来结束一个TCP回话。但对应端口仍处于开放状态，准备接收后续数据。</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@test ~]# netstat -a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出所有端口</span></span><br><span class="line">[root@test ~]# netstat -at</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出所有TCP端口</span></span><br><span class="line">[root@test ~]# netstat -au</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出所有UDP端口</span></span><br><span class="line">[root@test ~]# netstat -l</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只显示监听端口</span></span><br><span class="line">[root@test ~]# netstat -lt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示监听TCP端口</span></span><br><span class="line">[root@test ~]# netstat -lu</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示监听UDP端口</span></span><br><span class="line">[root@test ~]# netstat -lx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示监听UNIX端口</span></span><br><span class="line">[root@test ~]# netstat -s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有端口的统计信息</span></span><br><span class="line">[root@test ~]# netstat -st</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有TCP的统计信息</span></span><br><span class="line">[root@test ~]# netstat -su</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有UDP的统计信息</span></span><br><span class="line">[root@test ~]# netstat -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示 PID 和进程名称</span></span><br><span class="line">[root@test ~]# netstat -r</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface</span><br><span class="line">default         bogon           0.0.0.0         UG        0 0          0 ens33</span><br><span class="line">172.16.106.0    0.0.0.0         255.255.255.0   U         0 0          0 ens35</span><br><span class="line">192.168.1.0     0.0.0.0         255.255.255.0   U         0 0          0 ens33</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示核心路由信息</span></span><br><span class="line">[root@test ~]# netstat -rn</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface</span><br><span class="line">0.0.0.0         192.168.1.1     0.0.0.0         UG        0 0          0 ens33</span><br><span class="line">172.16.106.0    0.0.0.0         255.255.255.0   U         0 0          0 ens35</span><br><span class="line">192.168.1.0     0.0.0.0         255.255.255.0   U         0 0          0 ens33</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示数字格式，不查询主机名称</span></span><br><span class="line">[root@test ~]# netstat -c</span><br><span class="line"><span class="meta">#</span><span class="bash"> netstat 将每隔一秒输出网络信息</span></span><br><span class="line">[root@test ~]# netstat -ie</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示网络接口列表详细信息，结果如ifconfig</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# netstat -ant|grep "192.168.1.14:22"|awk '&#123;print $5&#125;'|sort|uniq -c|sort -nr|head -20</span><br><span class="line">      1 192.168.1.9:51292</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看连接某服务端口最多的的IP地址。uniq的-c或--count选项是在每列旁边显示该行重复出现的次数。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# netstat -nat |awk '&#123;print $6&#125;'|sort|uniq -c|sort -rn</span><br><span class="line">      4 LISTEN</span><br><span class="line">      1 Foreign</span><br><span class="line">      1 ESTABLISHED</span><br><span class="line">      1 established)</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP各种状态列表</span></span><br></pre></td></tr></table></figure>
<h3 id="系统连接状态"><a href="#系统连接状态" class="headerlink" title="系统连接状态"></a>系统连接状态</h3><h4 id="查看TCP连接状态"><a href="#查看TCP连接状态" class="headerlink" title="查看TCP连接状态"></a>查看TCP连接状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">netstat -nat |awk '&#123;print $6&#125;'|sort|uniq -c|sort -rn</span><br><span class="line">netstat -n | awk  '/^tcp/ &#123;++S[$NF]&#125;;END &#123;for(a in S) print a, S[a]&#125;'</span><br><span class="line">netstat -n | awk '/^tcp/ &#123;++state[$NF]&#125;; END &#123;for(key in state) print key,"\t",state[key]&#125;'</span><br><span class="line">netstat -n | awk '/^tcp/ &#123;++arr[$NF]&#125;;END &#123;for(k in arr) print k,"\t",arr[k]&#125;'</span><br><span class="line">netstat -n |awk '/^tcp/ &#123;print $NF&#125;'|sort|uniq -c|sort -rn</span><br><span class="line">netstat -ant | awk '&#123;print $NF&#125;' | grep -v '[a-z]' | sort | uniq -c</span><br></pre></td></tr></table></figure>
<h4 id="查找请求数请20个IP（常用于查找攻击来源）"><a href="#查找请求数请20个IP（常用于查找攻击来源）" class="headerlink" title="查找请求数请20个IP（常用于查找攻击来源）"></a>查找请求数请20个IP（常用于查找攻击来源）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -anlp|grep 80|grep tcp|awk '&#123;print $5&#125;'|awk -F: '&#123;print $1&#125;'|sort|uniq -c|sort -nr|head -n20</span><br><span class="line">netstat -ant |awk '/:80/&#123;split($5,ip,':');++A[ip[1]]&#125;END&#123;for(i in A) print A[i],i&#125;' |sort -rn|head -n20</span><br></pre></td></tr></table></figure>
<h4 id="用tcpdump嗅探80端口的访问看看谁最高"><a href="#用tcpdump嗅探80端口的访问看看谁最高" class="headerlink" title="用tcpdump嗅探80端口的访问看看谁最高"></a>用tcpdump嗅探80端口的访问看看谁最高</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# tcpdump -i ens33 -tnn dst port 80 -c 1000 | awk -F"." '&#123;print $1"."$2"."$3"."$4&#125;' | sort | uniq -c | sort -nr |head -20</span><br></pre></td></tr></table></figure>
<h4 id="查找较多time-wait连接"><a href="#查找较多time-wait连接" class="headerlink" title="查找较多time_wait连接"></a>查找较多time_wait连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -n|grep TIME_WAIT|awk '&#123;print $5&#125;'|sort|uniq -c|sort -rn|head -n20</span><br></pre></td></tr></table></figure>
<h4 id="找查较多的SYN连接"><a href="#找查较多的SYN连接" class="headerlink" title="找查较多的SYN连接"></a>找查较多的SYN连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an | grep SYN | awk '&#123;print $5&#125;' | awk -F: '&#123;print $1&#125;' | sort | uniq -c | sort -nr | more</span><br></pre></td></tr></table></figure>
<h4 id="根据端口列进程PID"><a href="#根据端口列进程PID" class="headerlink" title="根据端口列进程PID"></a>根据端口列进程PID</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ntlp | grep 80 | awk '&#123;print $7&#125;' | cut -d/ -f1</span><br></pre></td></tr></table></figure>
<h3 id="网站日志分析（Apache）"><a href="#网站日志分析（Apache）" class="headerlink" title="网站日志分析（Apache）"></a>网站日志分析（Apache）</h3><h4 id="获得访问前10位的ip地址"><a href="#获得访问前10位的ip地址" class="headerlink" title="获得访问前10位的ip地址"></a>获得访问前10位的ip地址</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat access.log|awk '&#123;print $1&#125;'|sort|uniq -c|sort -nr|head -10</span><br><span class="line">cat access.log|awk '&#123;counts[$(11)]+=1&#125;; END &#123;for(url in counts) print counts[url], url&#125;'</span><br></pre></td></tr></table></figure>
<h4 id="访问次数最多的文件或页面-取前20"><a href="#访问次数最多的文件或页面-取前20" class="headerlink" title="访问次数最多的文件或页面,取前20"></a>访问次数最多的文件或页面,取前20</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log|awk '&#123;print $11&#125;'|sort|uniq -c|sort -nr|head -20</span><br></pre></td></tr></table></figure>
<h4 id="列出传输最大的几个exe文件（分析下载站的时候常用）"><a href="#列出传输最大的几个exe文件（分析下载站的时候常用）" class="headerlink" title="列出传输最大的几个exe文件（分析下载站的时候常用）"></a>列出传输最大的几个exe文件（分析下载站的时候常用）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '($7~/\.exe/)&#123;print $10 " " $1 " " $4 " " $7&#125;'|sort -nr|head -20</span><br></pre></td></tr></table></figure>
<h4 id="列出输出大于200000byte-约200kb-的exe文件以及对应文件发生次数"><a href="#列出输出大于200000byte-约200kb-的exe文件以及对应文件发生次数" class="headerlink" title="列出输出大于200000byte(约200kb)的exe文件以及对应文件发生次数"></a>列出输出大于200000byte(约200kb)的exe文件以及对应文件发生次数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '($10 &gt; 200000 &amp;&amp; $7~/\.exe/)&#123;print $7&#125;'|sort -n|uniq -c|sort -nr|head -100</span><br></pre></td></tr></table></figure>
<h4 id="如果日志最后一列记录的是页面文件传输时间，则有列出到客户端最耗时的页面"><a href="#如果日志最后一列记录的是页面文件传输时间，则有列出到客户端最耗时的页面" class="headerlink" title="如果日志最后一列记录的是页面文件传输时间，则有列出到客户端最耗时的页面"></a>如果日志最后一列记录的是页面文件传输时间，则有列出到客户端最耗时的页面</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '($7~/\.php/)&#123;print $NF " " $1 " " $4 " " $7&#125;'|sort -nr|head -100</span><br></pre></td></tr></table></figure>
<h4 id="列出最最耗时的页面-超过60秒的-的以及对应页面发生次数"><a href="#列出最最耗时的页面-超过60秒的-的以及对应页面发生次数" class="headerlink" title="列出最最耗时的页面(超过60秒的)的以及对应页面发生次数"></a>列出最最耗时的页面(超过60秒的)的以及对应页面发生次数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '($NF &gt; 60 &amp;&amp; $7~/\.php/)&#123;print $7&#125;'|sort -n|uniq -c|sort -nr|head -100</span><br></pre></td></tr></table></figure>
<h4 id="列出传输时间超过-30-秒的文件"><a href="#列出传输时间超过-30-秒的文件" class="headerlink" title="列出传输时间超过 30 秒的文件"></a>列出传输时间超过 30 秒的文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '($NF &gt; 30)&#123;print $7&#125;'|sort -n|uniq -c|sort -nr|head -20</span><br></pre></td></tr></table></figure>
<h4 id="统计网站流量（G"><a href="#统计网站流量（G" class="headerlink" title="统计网站流量（G)"></a>统计网站流量（G)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '&#123;sum+=$10&#125; END &#123;print sum/1024/1024/1024&#125;'</span><br></pre></td></tr></table></figure>
<h4 id="统计404的连接"><a href="#统计404的连接" class="headerlink" title="统计404的连接"></a>统计404的连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk '($9 ~/404/)' access.log | awk '&#123;print $9,$7&#125;' | sort</span><br></pre></td></tr></table></figure>
<h4 id="统计http-status"><a href="#统计http-status" class="headerlink" title="统计http status"></a>统计http status</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '&#123;counts[$(9)]+=1&#125;; END &#123;for(code in counts) print code, counts[code]&#125;'</span><br><span class="line">cat access.log |awk '&#123;print $9&#125;'|sort|uniq -c|sort -rn</span><br></pre></td></tr></table></figure>
<h4 id="蜘蛛分析"><a href="#蜘蛛分析" class="headerlink" title="蜘蛛分析"></a>蜘蛛分析</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/tcpdump -i eth0 -l -s 0 -w - dst port 80 | strings | grep -i user-agent | grep -i -E 'bot|crawler|slurp|spider'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是哪些蜘蛛在抓取内容</span></span><br></pre></td></tr></table></figure>
<h4 id="网站日分析Squid"><a href="#网站日分析Squid" class="headerlink" title="网站日分析Squid"></a>网站日分析Squid</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zcat squid_access.log.tar.gz| awk '&#123;print $10,$7&#125;' |awk 'BEGIN&#123;FS="[ /]"&#125;&#123;trfc[$4]+=$1&#125;END&#123;for(domain in trfc)&#123;printf "%s\t%d\n",domain,trfc[domain]</span><br></pre></td></tr></table></figure>
<h3 id="查看数据库执行的sql"><a href="#查看数据库执行的sql" class="headerlink" title="查看数据库执行的sql"></a>查看数据库执行的sql</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 -s 0 -l -w - dst port 3306 | strings | egrep -i 'SELECT|UPDATE|DELETE|INSERT|SET|COMMIT|ROLLBACK|CREATE|DROP|ALTER|CALL'</span><br></pre></td></tr></table></figure>
<h3 id="系统Debug分析"><a href="#系统Debug分析" class="headerlink" title="系统Debug分析"></a>系统Debug分析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">strace -p pid</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调试命令</span></span><br><span class="line"></span><br><span class="line">gdb -p pid</span><br><span class="line"><span class="meta">#</span><span class="bash"> 跟踪指定进程的PID</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/13/shellScript语法及使用方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/13/shellScript语法及使用方法/" itemprop="url">
                  shellScript语法及使用方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-13 21:02:43" itemprop="dateCreated datePublished" datetime="2019-01-13T21:02:43+08:00">2019-01-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-03-20 15:53:25" itemprop="dateModified" datetime="2019-03-20T15:53:25+08:00">2019-03-20</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="清除日志的三种方法"><a href="#清除日志的三种方法" class="headerlink" title="清除日志的三种方法"></a>清除日志的三种方法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. echo &gt; test.log 或 echo "" &gt; test.log</span><br><span class="line">2. &gt;test.log</span><br><span class="line">3. cat /dev/null &gt; test.log</span><br></pre></td></tr></table></figure>
<h3 id="Shell脚本执行方式"><a href="#Shell脚本执行方式" class="headerlink" title="Shell脚本执行方式"></a>Shell脚本执行方式</h3><blockquote>
<p>当shell脚本以非交互的方式运行时，它会先查找环境变量ENV，该变量指定了一个环境文件（通常是.bashrc），然后从该环境变量文件开始执行，当读取了ENV文件后，SHELL才开始执行shell脚本中的内容。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1. bash script-name或sh script-name（推荐使用）；没有执行权限也可以执行。</span><br><span class="line">2. path/script-name或./script-name（当前路径 下执行脚本）</span><br><span class="line">3. source script-name或. script-name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意“.”点号；使用<span class="built_in">source</span>或点号来加载或读入脚本，然后，依次执行指定shell脚本文件son.sh中的所有语句。这些语句将作为当前父shell脚本father.sh进程的一部分运行。因此，使用<span class="built_in">source</span>或点号可以将son.sh自身脚本中的变量的值或函数等的返回值传递到当前的父shell脚本father.sh中使用。这就是在脚本中使用点或<span class="built_in">source</span>加载文件的意义，为使用加载的文件中的内容可被当前脚本使用。这是第三种方法与前两种的最大区别。</span></span><br><span class="line">全局环境变量：/etc/profile、/etc/profile.d、/etc/bashrc</span><br><span class="line">用户环境变量：./bash_profile、.bashrc</span><br><span class="line">例：</span><br><span class="line">[root@template sh]# vim tesh1.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">userdir=`pwd`</span><br><span class="line">[root@template sh]# chmod +x tesh1.sh </span><br><span class="line">[root@template sh]# bash tesh1.sh </span><br><span class="line">[root@template sh]# echo $userdir</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 没有执行结果</span></span><br><span class="line">[root@template sh]# . tesh1.sh </span><br><span class="line">[root@template sh]# echo $userdir</span><br><span class="line">/root/sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用<span class="built_in">source</span>或点号执行后，再用<span class="built_in">echo</span>命令执行才有结果。用<span class="built_in">source</span>或点号执行才能将变量加载到当前环境变量。</span></span><br></pre></td></tr></table></figure>
<h3 id="shell脚本开发基本规范及习惯"><a href="#shell脚本开发基本规范及习惯" class="headerlink" title="shell脚本开发基本规范及习惯"></a>shell脚本开发基本规范及习惯</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1. 开头指定脚本解释器</span><br><span class="line">2. 开头加版本版权等信息</span><br><span class="line">    #Date: 16:29 2012-3-30	时间</span><br><span class="line">    #Authou: oldboy	作者</span><br><span class="line">    #Mail：aaaa@qq.com	联系方式</span><br><span class="line">    #Function：this scripts function is ...	脚本的功能是什么 </span><br><span class="line">    #Version： 1.1	脚本的版本号</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可配置vim编辑文件时自动加上以上信息，方法是修改~/.vimrc配置文件</span></span><br><span class="line">3. 脚本中不用中文件注释</span><br><span class="line">4. 脚本以.sh为扩展名</span><br><span class="line">5. 代码书写优秀习惯</span><br><span class="line">    1. 成对内容的一次写出来，防止挂失</span><br><span class="line">    2. []中括号两端要有空格</span><br><span class="line">    3. 流程控制语句一次书写完</span><br><span class="line">        if 条件内容</span><br><span class="line">        then</span><br><span class="line">            内容</span><br><span class="line">        fi</span><br><span class="line">6. 通过缩进让代码易读</span><br></pre></td></tr></table></figure>
<h3 id="变量分类"><a href="#变量分类" class="headerlink" title="变量分类"></a>变量分类</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">* 变量分两类：环境变量（全局变量）和局部变量</span><br><span class="line"></span><br><span class="line">* 环境变量可以在命令中设置，但用户退出时这些变量值也会丢失，因此最好在用户家目录下的.bash_profile文件中或全局设置/etc/bashrc，/etc/profile文件或者/etc/profile.d中定义。将环境变量放入profile文件中，每次用户登录时这些变量值都将被初始化。</span><br><span class="line"></span><br><span class="line">* 有一些环境变量，比如HOME、PATH、SHELL、UID、USER等，在用户登录之前就已经被/bin/login程序设置好了。通常环境变量定义并保存在用户家目录下的.bash_profile文件中</span><br><span class="line"></span><br><span class="line">* PS1环境变量定义用户登录后的提示符如[\u@\h \W]$，\u表示用户名，\h表示主机名，\W表示路径</span><br><span class="line"></span><br><span class="line">TMOUT＝3600，此变量表示多久不操作就退出终端</span><br><span class="line">UID＝0，此变量表示用户的UID</span><br><span class="line">USER＝root，此变量表示当前用户的用户名</span><br><span class="line">HISTFILESIZE=50，历史文件能包含的最大行数</span><br><span class="line">HISTSIZE=50，记录在命令行历史文件中的命令行数</span><br><span class="line">HISTFILE=/root/.bash_history，历史记录文件的全路径 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的环境变量都可以加到/etc/profile文件中，加入后用<span class="built_in">source</span>或点号加载生效。</span></span><br><span class="line"></span><br><span class="line">*  设置环境变量要在给环境变量赋值后或设置变量时用export命令。带-x选项的declare内置命令也可以完成同样的功能。（注意：输出变量时不要在变量名前加$）</span><br><span class="line">1. export 变量名＝value</span><br><span class="line">2. 变量名＝value --&gt; export 变量名</span><br><span class="line">3. declare -x 变量名＝value</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以查看/etc/profile文件中是如何定义变量的</span></span><br><span class="line">用unset 变量名取消环境变量，变量名前不要加$符号。如果要永久生效，也要写到/etc/profile中。</span><br><span class="line"></span><br><span class="line">* 局部变量</span><br><span class="line">变量名＝value</span><br><span class="line">变量名＝'value'</span><br><span class="line">变量名="value"</span><br><span class="line">shell中变量名的要求：一般是字母，数字，下划线组成。字母开头</span><br><span class="line"></span><br><span class="line">* 自定义变量建议</span><br><span class="line">1. 纯数字（不带空格），定义方式可以不加引号（单或双）</span><br><span class="line">2. 没特殊情况，字符串一般用双引号定义，特别是多个字符串中间有空格时</span><br><span class="line">3. 变量内容需要原样输出时，要用单引号''</span><br><span class="line"></span><br><span class="line">* 变量命名规范</span><br><span class="line">1. 变量命名要统一，使用全部大写字母</span><br><span class="line">2. 避免无含义字符或数字</span><br><span class="line"><span class="meta">#</span><span class="bash"> 看/etc/init.d/<span class="built_in">functions</span>脚本中如何定义变量</span></span><br><span class="line"></span><br><span class="line">* 把命令定义为变量，就是将命令的执行结果给变量，用反引号或$()括起命令即可。</span><br><span class="line">tar zcf etc_$&#123;cmd&#125;_oldboy.tar.gz /etc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里cmd是自定义的变量，但如果要这样使用，要用大括号括起，因为如果不括起，系统就不能分辨出哪个是变量，可以会找<span class="variable">$cmd_oldboy</span>，这会执行错误。</span></span><br></pre></td></tr></table></figure>
<h3 id="位置变量"><a href="#位置变量" class="headerlink" title="位置变量"></a>位置变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">0：获取当前执行的shell脚本的文件名</span></span><br><span class="line"><span class="meta">$</span><span class="bash">n：获取当前执行的shell脚本的第n个参数</span></span><br><span class="line"><span class="meta">$</span><span class="bash">*：获取当前shell的所有参数，将所有的命令行参数视为单个字符</span></span><br><span class="line"><span class="meta">$</span><span class="bash"><span class="comment">#：获取当前shell命令行中参数的总个数</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">!：执行上一个指令的PID</span></span><br><span class="line"><span class="meta">$</span><span class="bash">?：获取执行结果返回值</span></span><br><span class="line">        执行结果返回值的意义：</span><br><span class="line">        0：正确执行</span><br><span class="line">        2：权限拒绝</span><br><span class="line">        1－125：表示运行失败</span><br><span class="line">        126：找到该命令了，但是无法执行</span><br><span class="line">        127：未找到要运行的命令</span><br><span class="line">        &gt;128：命令被系统强制结束</span><br><span class="line"><span class="meta">$</span><span class="bash">$：获取当前shell的进程号（PID）</span></span><br><span class="line"><span class="meta">$</span><span class="bash">_：在此之前执行的命令或脚本的最后一个参数</span></span><br><span class="line"><span class="meta">$</span><span class="bash">@：这个程序的所有参数，如<span class="string">"<span class="variable">$1</span>"</span> <span class="string">"<span class="variable">$2</span>"</span> <span class="string">"<span class="variable">$3</span>"</span>...</span></span><br><span class="line">=======================================================================================</span><br><span class="line"><span class="meta">$</span><span class="bash">*与 <span class="variable">$@</span>区别</span></span><br><span class="line"><span class="meta">$</span><span class="bash">*：将所有的命令行所有参数视为单个字符串，等同于“<span class="variable">$1</span><span class="variable">$2</span><span class="variable">$3</span>”</span></span><br><span class="line"><span class="meta">$</span><span class="bash">@：将命令行每个参数视为单独的字符串，等同于<span class="string">"<span class="variable">$1</span>"</span><span class="string">"<span class="variable">$2</span>"</span><span class="string">"<span class="variable">$3</span>"</span>。这是将参数传递给其他程序的最佳 方式，因为他会促使所有内嵌在每个参数里的任何空白。</span></span><br><span class="line">=======================================================================================</span><br><span class="line">例：</span><br><span class="line">sh n.sh "1 2 3"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用引号括起的部分表示一个参数。</span></span><br><span class="line"></span><br><span class="line">basename：获取名称，也就是最后的一段</span><br><span class="line">dirname：获取文件所在路径，也就是最后一段前面的内容</span><br></pre></td></tr></table></figure>
<h3 id="常用内部命令"><a href="#常用内部命令" class="headerlink" title="常用内部命令"></a>常用内部命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo</span><br><span class="line"></span><br><span class="line">exec</span><br><span class="line"></span><br><span class="line">eval</span><br><span class="line"></span><br><span class="line">export</span><br><span class="line"></span><br><span class="line">readonly</span><br><span class="line"></span><br><span class="line">read</span><br><span class="line"></span><br><span class="line">shift</span><br><span class="line"><span class="meta">#</span><span class="bash"> 按如下方式重新命名所有的位置参数变量，即<span class="variable">$2</span>成为<span class="variable">$1</span>，<span class="variable">$3</span>成为<span class="variable">$2</span>...在程序中每使用一次<span class="built_in">shift</span>语句，都使所有的位置参数依次向左移动一个位置，并使位置参数<span class="variable">$#</span>减1，直到减到0为止。可以查看ssh-copy-id脚本是如何使用<span class="built_in">shift</span>的</span></span><br><span class="line"></span><br><span class="line">wait</span><br><span class="line"></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">点</span><br></pre></td></tr></table></figure>
<h3 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">* 判断读取字符串的值</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var&#125;：变量var的值, 与<span class="variable">$var</span>相同</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var-DEFAULT&#125;：如果var没有被声明, 那么就以<span class="variable">$DEFAULT</span>作为其值 *</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var:-DEFAULT&#125;：如果var没有被声明, 或者其值为空, 那么就以<span class="variable">$DEFAULT</span>作为其值 *</span></span><br><span class="line">例</span><br><span class="line">[root@template sh]# echo $&#123;bbb-'ok'&#125;</span><br><span class="line">ok</span><br><span class="line">[root@template sh]# echo $bbb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> bbb没有被声明过</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var=DEFAULT&#125;：如果var没有被声明, 那么就以<span class="variable">$DEFAULT</span>作为其值 *</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var:=DEFAULT&#125;：如果var没有被声明, 或者其值为空, 那么就以<span class="variable">$DEFAULT</span>作为其值 *</span></span><br><span class="line">例</span><br><span class="line">[root@template sh]# echo $&#123;abc='ok'&#125;</span><br><span class="line">ok</span><br><span class="line">[root@template sh]# echo $abc</span><br><span class="line">ok</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var+OTHER&#125;：如果var声明了, 那么其值就是<span class="variable">$OTHER</span>, 否则就为null字符串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var:+OTHER&#125;：如果var被设置了, 那么其值就是<span class="variable">$OTHER</span>, 否则就为null字符串</span></span><br><span class="line"> 	 </span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var?ERR_MSG&#125;：如果var没被声明, 那么就打印<span class="variable">$ERR_MSG</span> *</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var:?ERR_MSG&#125;：如果var没被设置, 那么就打印<span class="variable">$ERR_MSG</span> *</span></span><br><span class="line"> 	 </span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;!varprefix*&#125;：匹配之前所有以varprefix开头进行声明的变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;!varprefix@&#125;：匹配之前所有以varprefix开头进行声明的变量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$&#123;!varprefix*&#125;</span>与<span class="variable">$&#123;!varprefix@&#125;</span>相似，可以通过变量名前缀字符，搜索已经定义的变量,无论是否为空值。</span></span><br><span class="line">例</span><br><span class="line">[root@template sh]# var1=11;var2=22;var3=33</span><br><span class="line">[root@template sh]# echo $var1</span><br><span class="line">11</span><br><span class="line">[root@template sh]# echo $var2</span><br><span class="line">22</span><br><span class="line">[root@template sh]# echo $var3</span><br><span class="line">33</span><br><span class="line">[root@template sh]# echo $&#123;!v@&#125;</span><br><span class="line">var1 var2 var3</span><br><span class="line">[root@template sh]# echo $&#123;!v*&#125;</span><br><span class="line">var1 var2 var3</span><br><span class="line"></span><br><span class="line">* 字符串操作</span><br><span class="line">	* 截取长度</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;<span class="comment">#string&#125;：$string的长度</span></span></span><br><span class="line"></span><br><span class="line">	* 截取字符串</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string:position&#125;：在<span class="variable">$string</span>中, 从位置<span class="variable">$position</span>开始提取子串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string:position:length&#125;：在<span class="variable">$string</span>中, 从位置<span class="variable">$position</span>开始提取长度为<span class="variable">$length</span>的子串</span></span><br><span class="line"> 	 </span><br><span class="line"> 	 * 删除子串</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string<span class="comment">#substring&#125;：从变量$string的开头, 删除最短匹配$substring的子串</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string<span class="comment">##substring&#125;：从变量$string的开头, 删除最长匹配$substring的子串</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string%substring&#125;：从变量<span class="variable">$string</span>的结尾, 删除最短匹配<span class="variable">$substring</span>的子串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string%%substring&#125;：从变量<span class="variable">$string</span>的结尾, 删除最长匹配<span class="variable">$substring</span>的子串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;变量名<span class="comment">#substring正则表达式&#125;：从字符串开头开始配备substring，删除匹配上的表达式。</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;变量名%substring正则表达式&#125;：从字符串结尾开始配备substring，删除匹配上的表达式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$&#123;test##*/&#125;</span>,<span class="variable">$&#123;test%/*&#125;</span> 分别是得到文件名，或者目录地址最简单方法。 	 </span></span><br><span class="line"></span><br><span class="line"> 	 * 字符串替换</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string/substring/replacement&#125;：使用<span class="variable">$replacement</span>, 来代替第一个匹配的<span class="variable">$substring</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string//substring/replacement&#125;：使用<span class="variable">$replacement</span>, 代替所有匹配的<span class="variable">$substring</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string/<span class="comment">#substring/replacement&#125;：如果$string的前缀匹配$substring, 那么就用$replacement来代替匹配到的$substring</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string/%substring/replacement&#125;：如果<span class="variable">$string</span>的后缀匹配<span class="variable">$substring</span>, 那么就用<span class="variable">$replacement</span>来代替匹配到的<span class="variable">$substring</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"* <span class="variable">$substring</span>"</span> 可以是一个正则表达式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$&#123;变量/查找/替换值&#125;</span> 一个“/”表示替换第一个，”//”表示替换所有,当查找中出现了：”/”请加转义符”\/”表示。</span></span><br><span class="line">例</span><br><span class="line">[root@template sh]# num=oldboy5343</span><br><span class="line">[root@template sh]# echo "$&#123;num//[0-9]/&#125;" </span><br><span class="line">oldboy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是使用空来代替oldboy5343中的所有数字，所以取的值只有字母</span></span><br><span class="line">[root@template sh]# echo "$&#123;num//[0-9]/a&#125;"</span><br><span class="line">oldboyaaaa</span><br></pre></td></tr></table></figure>
<h3 id="变量的数值计算"><a href="#变量的数值计算" class="headerlink" title="变量的数值计算"></a>变量的数值计算</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">* (())用法：此方法很常用，且效率高。执行简单的整数运算，只需将特定的算术表达式用"$((算术运算表达式))"。shell的算术运算符号都置于"$((算术运算表达式))"的语法中。这一语法如同双引号功能，除了内嵌双引号无需转义。</span><br><span class="line">=======================================================================================</span><br><span class="line">运算符</span><br><span class="line">++  --：增加及减少，可前置也可放在结尾。放在开头表示先自增或自减再赋值，放在结尾表示先赋值再自增或自减。变量话前，先输出变量值，变量在后，就是先运算后输出变量的值。</span><br><span class="line">+ - ! ~	：一元的正号与负号；逻辑与位的取反</span><br><span class="line">* / %：乘法、除法、与取余</span><br><span class="line">+ -	：加法、减法</span><br><span class="line">&lt; &lt;= &gt; &gt;=：比较符号</span><br><span class="line">== !=：判断相等与不相等</span><br><span class="line">&lt;&lt; &gt;&gt;：向左位移、向右位移</span><br><span class="line">&amp;：位的AND</span><br><span class="line">^：位的异或</span><br><span class="line">｜：位的或</span><br><span class="line">&amp;&amp;：逻辑的AND</span><br><span class="line">||：逻辑的OR</span><br><span class="line">?：条件表达式</span><br><span class="line">= += -= *= /= %= &amp;= ^=</span><br><span class="line">&lt;&lt;=  &gt;&gt;=  \=：赋值运算符</span><br><span class="line">=======================================================================================</span><br><span class="line">例</span><br><span class="line">[root@template sh]# echo $((3&gt;2))</span><br><span class="line">1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断，如果是真就输出1，假输出0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 括号两边有几个空格不敏感，也可以没有</span></span><br><span class="line">[root@template sh]# echo $((3&gt;8))</span><br><span class="line">0</span><br><span class="line">[root@template sh]# ((a=1+2**3-4%3))</span><br><span class="line"><span class="meta">#</span><span class="bash"> **是幂，表示几次方</span></span><br><span class="line">[root@template sh]# echo $a</span><br><span class="line">8</span><br><span class="line">[root@template sh]# b=$((1+2**3-4%3))</span><br><span class="line">[root@template sh]# echo $b</span><br><span class="line">8</span><br><span class="line">[root@template sh]# echo $((1+2**3-4%3))</span><br><span class="line">8</span><br><span class="line">[root@template sh]# echo $((a+=1))</span><br><span class="line">9</span><br><span class="line"><span class="meta">#</span><span class="bash"> a++表示先赋值再自增1、++a表示先自增1再赋值、a--与--a同理</span></span><br><span class="line">[root@template sh]# echo $((100*(100+1)/2))</span><br><span class="line">5050</span><br><span class="line">[root@template sh]# echo $((1000*(1000+1)/2))</span><br><span class="line">500500</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从1加到100的计算公式是n*(n+1)/2，只要从1开始，间隔为1的相加计算都可以用此公式</span></span><br><span class="line">[root@template sh]# echo $((1.1+1))</span><br><span class="line">-bash: 1.1+1: syntax error: invalid arithmetic operator (error token is ".1+1")</span><br><span class="line"><span class="meta">#</span><span class="bash"> 双括号中只能使用整数，不能使用小数</span></span><br><span class="line"></span><br><span class="line">例：使用传参的方式对两个变量进行计算</span><br><span class="line">[root@template sh]# vim test2.sh</span><br><span class="line">echo "a-b=$(($a-$b))"</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">a=$1</span><br><span class="line">b=$2</span><br><span class="line">echo "a-b=$(($a-$b))"</span><br><span class="line">echo "a+b=$(($a+$b))"</span><br><span class="line">echo "a*b=$(($a*$b))"</span><br><span class="line">echo "a/b=$(($a/$b))"</span><br><span class="line">echo "a**b=$(($a**$b))"</span><br><span class="line">echo "a%b=$(($a%$b))"</span><br><span class="line">[root@template sh]# chmod +x test2.sh </span><br><span class="line">[root@template sh]# bash test2.sh 5 2</span><br><span class="line">a-b=3</span><br><span class="line">a+b=7</span><br><span class="line">a*b=10</span><br><span class="line">a/b=2</span><br><span class="line">a**b=25</span><br><span class="line"><span class="meta">a%</span><span class="bash">b=1</span></span><br><span class="line"></span><br><span class="line">* []的用法，$[算术运算表达式]，与$((算术运算表达式))相同</span><br><span class="line"></span><br><span class="line">* let命令的用法</span><br><span class="line">格式：</span><br><span class="line">	let 赋值表达式</span><br><span class="line">	let i=$[$i+1]</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 这里不加<span class="built_in">let</span>也可以，因为有中括号了</span></span><br><span class="line">	let i++</span><br><span class="line">	let i+=1</span><br><span class="line">	</span><br><span class="line">例</span><br><span class="line">[root@template sh]# i=2</span><br><span class="line">[root@template sh]# let i=i+9</span><br><span class="line">[root@template sh]# echo $i</span><br><span class="line">11</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">let</span> i=i+8等同于((i=i+8))，但双括号效率更高</span></span><br><span class="line"></span><br><span class="line">例：利用let计数监控web服务状态</span><br><span class="line">[root@template sh]# vim web.sh </span><br><span class="line">ServerMonitor() &#123;</span><br><span class="line">   timeout=10</span><br><span class="line">   fails=0</span><br><span class="line">   success=0</span><br><span class="line">   while true;do</span><br><span class="line">        /usr/bin/wget --timeout=$timeout --tries=1 http://192.168.1.24 -q -O /de</span><br><span class="line">v/null</span><br><span class="line">        if [ $? -ne 0 ];then</span><br><span class="line">           let fails+=1</span><br><span class="line">           success=0</span><br><span class="line">        else</span><br><span class="line">           fail=0</span><br><span class="line">           let success=1</span><br><span class="line">        fi</span><br><span class="line">        if [ $success -eq 1 ];then</span><br><span class="line">           exit 0</span><br><span class="line">        fi</span><br><span class="line">        if [ $fails -ge 2 ];then</span><br><span class="line">           Critical="web应用服务故障"</span><br><span class="line">           echo $Critical </span><br><span class="line">        fi</span><br><span class="line">        sleep 10</span><br><span class="line">done</span><br><span class="line">&#125;</span><br><span class="line">ServerMonitor</span><br><span class="line"><span class="meta">#</span><span class="bash"> 探测主页，之后判断，如果返回值不是0，fails变量就自增1，否则success变量就等于1。再判断success变量是否等于1,如果等于1，如果是，就正常退出，返回0。再判断fails变量是否大于等于2,如果是就定义一个变量Critical，并显示变量值。最后，每10秒检查一次。</span></span><br><span class="line"></span><br><span class="line">* expr命令用法</span><br><span class="line"><span class="meta">#</span><span class="bash"> expr命令一般用于整数值，但也可用于字符串，用来求表达式变量的值，同时expr也是一个手工命令行计算器。</span></span><br><span class="line">语法：</span><br><span class="line">	expr Expression</span><br><span class="line">例</span><br><span class="line">[root@template sh]# expr 2 + 2</span><br><span class="line">4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运算符两侧必须有空格</span></span><br><span class="line">[root@template sh]# expr 2 - 2</span><br><span class="line">0</span><br><span class="line">[root@template sh]# expr 2 \* 2</span><br><span class="line">4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 乘号要转义</span></span><br><span class="line">[root@template sh]# expr 2 / 2 </span><br><span class="line">1</span><br><span class="line">[root@template sh]# expr 3 % 2</span><br><span class="line">1</span><br><span class="line">[root@template sh]# i=0</span><br><span class="line">[root@template sh]# i=`expr $i + 1`</span><br><span class="line">[root@template sh]# echo $i</span><br><span class="line">1</span><br><span class="line"><span class="meta">#</span><span class="bash"> expr在循环中可用于增量计算。首先，循环初始化为0，然后循环值加1，反引号的用法为命令替代。最其本的一种是从(expr)命令接受输出并将之放入循环变量</span></span><br><span class="line">[root@template sh]# expr $[2+3]</span><br><span class="line">5</span><br><span class="line"><span class="meta">#</span><span class="bash"> expr如果加上$[]后，运算符两侧就不用空格了。运算符两侧必须为整数</span></span><br><span class="line"></span><br><span class="line">例：ssh-copy-id脚本中使用expr命令</span><br><span class="line">if expr "$1" : ".*\.pub";then</span><br><span class="line"><span class="meta">#</span><span class="bash"> 冒号两侧一样要有空格</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置结果可能为expr id_dsa.pub:<span class="string">".*\.pub"</span>，匹配*.pub格式的文件如果是则为真。如：</span></span><br><span class="line">[root@template sh]# expr ~/.ssh/id_rsa.pub : ".*\.pub"</span><br><span class="line">21</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果为真就会打印出字符数，假就显示0</span></span><br><span class="line">[root@template sh]# expr ~/.ssh/id_rsa.pub : ".*\.pub" &amp;&amp; echo 1||echo 0</span><br><span class="line">21</span><br><span class="line">1</span><br><span class="line">[root@template sh]# expr ~/.ssh/id_rsa.p : ".*\.pub" &amp;&amp; echo 1||echo 0  </span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断文件或字符串的扩展名</span></span><br><span class="line"></span><br><span class="line">例：判断变量是否为整数</span><br><span class="line">[root@template sh]# vim expr.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">read -p "Pls input: " a</span><br><span class="line">expr $a + 0 &amp;&gt; /dev/null</span><br><span class="line">[ $? -eq 0 ] &amp;&amp; echo int || echo chars</span><br><span class="line"></span><br><span class="line">例：计算字符串的长度</span><br><span class="line">[root@template sh]# chars=`seq -s " " 100`      </span><br><span class="line"><span class="meta">#</span><span class="bash"> -s选项表示指定分隔符，上面是以空格为分隔符。默认是回车。</span></span><br><span class="line">[root@template sh]# echo $&#123;#chars&#125;              </span><br><span class="line">291</span><br><span class="line">[root@template sh]# echo $(expr length "$chars")</span><br><span class="line">291</span><br><span class="line"></span><br><span class="line">* $[]的用法与(())一样，效果也一样</span><br><span class="line">[root@template sh]# echo $((2-2))</span><br><span class="line">0</span><br><span class="line">[root@template sh]# echo $[2-2]</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<h3 id="read命令"><a href="#read命令" class="headerlink" title="read命令"></a>read命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">可以使用read命令从标准输入获得参数</span><br><span class="line">语法：</span><br><span class="line">	read [参数] [变量名]</span><br><span class="line">常用选项：</span><br><span class="line">	-p prompt：设置提示信息</span><br><span class="line">	-t timeout：设置输入等待时间，单位默认为秒</span><br><span class="line">例</span><br><span class="line">[root@template sh]# read -p "pls input two number: " a b</span><br><span class="line">pls input two number: 1 2   </span><br><span class="line">或</span><br><span class="line">[root@template sh]# echo -n "pls input two number: ";read a b</span><br><span class="line">pls input two number: 4 3</span><br><span class="line">[root@template sh]# echo $a</span><br><span class="line">4</span><br><span class="line">[root@template sh]# echo $b</span><br><span class="line">3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这两种方式都可以使用<span class="built_in">read</span>获得参数</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim read.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">read -t 10 -p "Pls input two number: " a b</span><br><span class="line">echo "a-b=$(($a-$b))"</span><br><span class="line">echo "a+b=$(($a+$b))"</span><br><span class="line">echo "a*b=$(($a*$b))"</span><br><span class="line">echo "a/b=$(($a/$b))"</span><br><span class="line">echo "a**b=$(($a**$b))"</span><br><span class="line">echo "a%b=$(($a%$b))"</span><br><span class="line"></span><br><span class="line">[root@template sh]# vim read1.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">echo -n "Pls input two number"</span><br><span class="line">read a b</span><br><span class="line">echo "a-b=$(($a-$b))"</span><br><span class="line">echo "a+b=$(($a+$b))"</span><br><span class="line">echo "a*b=$(($a*$b))"</span><br><span class="line">echo "a/b=$(($a/$b))"</span><br><span class="line">echo "a**b=$(($a**$b))"</span><br><span class="line">echo "a%b=$(($a%$b))"</span><br></pre></td></tr></table></figure>
<h3 id="条件测试"><a href="#条件测试" class="headerlink" title="条件测试"></a>条件测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">* 测试语句</span><br><span class="line">条件测试语法</span><br><span class="line">1. test &lt;测试表达式&gt;</span><br><span class="line">2. [&lt;测试表达式&gt;]</span><br><span class="line">3. [[&lt;测试表达式&gt;]]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 格式1和格式2是一样的，只是写法不同。格式3为扩展的<span class="built_in">test</span>命令。在[[]]中可以使用通配符进行模式匹配。&amp;&amp;、||、&gt;、&lt;等操作符，但不能用于[]中。对整数进行关系运算，也可以使用shell的算术运算符(())</span></span><br><span class="line"></span><br><span class="line">* 文件测试操作符</span><br><span class="line">-f 文件：若文件存在且为普通文件则为真</span><br><span class="line">-d 文件：若文件存在且为目录则为真</span><br><span class="line">-s 文件：若文件存在且不为空（文件大小非0）则为真</span><br><span class="line">-e 文件：若文件存在则为真，要与-f区别，-f只判断是否为普通文件</span><br><span class="line">-r 文件：若文件可读则为真</span><br><span class="line">-w 文件：若文件可写则为真</span><br><span class="line">-x 文件：若文件可执行则为真</span><br><span class="line">-L 文件：若文件存在且为链接文件则为真</span><br><span class="line">f1 -nt f2：若文件f1比f2新则为真</span><br><span class="line">f1 -ot f2：若文件f1比f2旧则为真</span><br><span class="line"></span><br><span class="line">例：test</span><br><span class="line">[root@template sh]# test -f file &amp;&amp; echo true||echo false  </span><br><span class="line">false</span><br><span class="line">[root@template sh]# test -f expr.sh &amp;&amp; echo true||echo false    </span><br><span class="line">true</span><br><span class="line">[root@template sh]# test ! -f file &amp;&amp; echo true||echo false</span><br><span class="line">true</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用!号可以取反</span></span><br><span class="line"></span><br><span class="line">例：[]</span><br><span class="line">[root@template sh]# [ -f file ] &amp;&amp; echo true || echo false</span><br><span class="line">false</span><br><span class="line">[root@template sh]# [ ! -f file ] &amp;&amp; echo true || echo false</span><br><span class="line">true</span><br><span class="line"></span><br><span class="line">例：[[]]</span><br><span class="line">[root@template sh]# [[ -f file ]] &amp;&amp; echo true || echo false  </span><br><span class="line">false</span><br><span class="line">[root@template sh]# [[ ! -f file ]] &amp;&amp; echo true || echo false</span><br><span class="line">true</span><br><span class="line">[root@template sh]# [[ -f file &amp;&amp; -f expr.sh ]] &amp;&amp; echo true || echo false</span><br><span class="line">false</span><br><span class="line">[root@template sh]# [[ ! -f file &amp;&amp; -f expr.sh ]] &amp;&amp; echo true || echo false</span><br><span class="line">true</span><br></pre></td></tr></table></figure>
<h3 id="字符串及整数操作符"><a href="#字符串及整数操作符" class="headerlink" title="字符串及整数操作符"></a>字符串及整数操作符</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">字符串测试操作符的作用：比较两个字符串是否相同、字符串长度是否为零，字符串是否为NULL（bash区分零长度字符串与空字符串）等。</span><br><span class="line">=比较两个字符串是相同，与==等价，如if[ "$a" = "$b" ]，其中$a这样的变量最好用""括起来，因为如果中间有空格，*等符号就可能出错了，也可以用[ "$&#123;a&#125;" = "$&#123;b&#125;" ]这样的方法。!=比较两个字符串是否相同，不同则为真</span><br><span class="line">* 字符串测试操作符</span><br><span class="line">-z "字符串"：若串长度为0则为真</span><br><span class="line">-n "字符串"：若串长度不为0则为真</span><br><span class="line">"串1"="串2"：若串1等于串2则为真，也可以使用==代替=</span><br><span class="line">"串1"!="串2"：若串1不等于串2则为真</span><br></pre></td></tr></table></figure>
<p>整数二元比较操作符</p>
<table>
<thead>
<tr>
<th>在[]中使用的比较符</th>
<th>在(())和[[]]中使用的比较符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-eq</td>
<td>==</td>
<td>equal</td>
</tr>
<tr>
<td>-ne</td>
<td>!=</td>
<td>not equal</td>
</tr>
<tr>
<td>-gt</td>
<td>&gt;</td>
<td>greater than</td>
</tr>
<tr>
<td>-ge</td>
<td>&gt;=</td>
<td>greater equal</td>
</tr>
<tr>
<td>-lt</td>
<td>&lt;</td>
<td>less thean</td>
</tr>
<tr>
<td>-le</td>
<td>&lt;=</td>
<td>less equal</td>
</tr>
</tbody>
</table>
<p><strong>在[]中也可以使用&gt;、&lt;、=号，但&gt;、&lt;号要转义</strong></p>
<h3 id="逻辑操作符"><a href="#逻辑操作符" class="headerlink" title="逻辑操作符"></a>逻辑操作符</h3><p>逻辑连接符</p>
<table>
<thead>
<tr>
<th>在[]中使用的逻辑操作符</th>
<th>在[[]]中使用的逻辑操作符</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-a</td>
<td>&amp;&amp;</td>
<td style="text-align:left">与，两端都为真，则为真</td>
</tr>
<tr>
<td>-o</td>
<td>\</td>
<td style="text-align:left">\</td>
<td></td>
<td>或，两端有一端为真则为真</td>
</tr>
<tr>
<td>!</td>
<td>!</td>
<td style="text-align:left">非，相反则为真</td>
</tr>
</tbody>
</table>
<h3 id="单级与多级菜单"><a href="#单级与多级菜单" class="headerlink" title="单级与多级菜单"></a>单级与多级菜单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@template ~]# vim menu.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">menu() &#123;</span><br><span class="line">   cat &lt;&lt; END</span><br><span class="line">   1. [install lamp]</span><br><span class="line">   2. [install lnmp]</span><br><span class="line">   3. [install nfs]</span><br><span class="line">   4. [install rsync]</span><br><span class="line">   Pls input the num that you want:</span><br><span class="line">END</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试中，如果将END改为EOF会报错，内容如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> menu.sh: line 14: warning: here-document at line 4 delimited by end-of-file (wanted `EOF<span class="string">')</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> menu.sh: line 15: syntax error: unexpected end of file</span></span><br><span class="line">read a</span><br><span class="line">[ $a -eq 1 ] &amp;&amp; &#123;</span><br><span class="line">cat &lt;&lt; END</span><br><span class="line">[1. install apache]</span><br><span class="line">[2. install mysql]</span><br><span class="line">[3. install php]</span><br><span class="line">END</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">menu</span><br><span class="line">read b</span><br><span class="line">echo "You selected $b"</span><br><span class="line">[root@template ~]# bash menu.sh </span><br><span class="line">   1. [install lamp]</span><br><span class="line">   2. [install lnmp]</span><br><span class="line">   3. [install nfs]</span><br><span class="line">   4. [install rsync]</span><br><span class="line">   Pls input the num that you want:</span><br><span class="line">1</span><br><span class="line">[1. install apache]</span><br><span class="line">[2. install mysql]</span><br><span class="line">[3. install php]</span><br><span class="line">1</span><br><span class="line">You selected 1</span><br></pre></td></tr></table></figure>
<h3 id="if条件语句"><a href="#if条件语句" class="headerlink" title="if条件语句"></a>if条件语句</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">* if条件单分支</span><br><span class="line">语法：</span><br><span class="line">if [条件]</span><br><span class="line">	then</span><br><span class="line">		指令</span><br><span class="line">fi</span><br><span class="line">或</span><br><span class="line">if [条件];then</span><br><span class="line">	指令</span><br><span class="line">fi</span><br><span class="line">特殊写法：if [ -f "$file" ];then echo 1;fi，相当于：[ -f "$file" ] &amp;&amp; echo 1</span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim if.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">cur_free=`free -m|awk '/buffers\// &#123;print $NF&#125;'`</span><br><span class="line">chars="current memory is $cur_free"</span><br><span class="line">if [ $cur_free -lt 900 ];then</span><br><span class="line">   echo $chars</span><br><span class="line">fi</span><br><span class="line">[root@template sh]# chmod +x if.sh </span><br><span class="line">[root@template sh]# ./if.sh</span><br><span class="line">current memory is 855</span><br><span class="line"></span><br><span class="line">* 双分支、多分支if语句</span><br><span class="line">双分支语法：</span><br><span class="line">if [条件];then</span><br><span class="line">   指令</span><br><span class="line">else</span><br><span class="line">	指令</span><br><span class="line">fi</span><br><span class="line">多分支语法：</span><br><span class="line">if [条件];then</span><br><span class="line">   指令</span><br><span class="line">elif [条件];then</span><br><span class="line">	指令</span><br><span class="line">else</span><br><span class="line">	指令</span><br><span class="line">fi</span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim if1.sh      </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">a=$1</span><br><span class="line">b=$2</span><br><span class="line">if [ $# -ne 2 ];then</span><br><span class="line">   echo "Usage: sh $0 num1 num2"</span><br><span class="line">   exit 1</span><br><span class="line">fi</span><br><span class="line">[ -n "`echo $1|sed 's/[0-9]//g'`" ] &amp;&amp; echo "first parameter must num" &amp;&amp; exit 1</span><br><span class="line">[ -n "`echo $2|sed 's/[0-9]//g'`" ] &amp;&amp; echo "second parameter must num" &amp;&amp; exit 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里是要显示输入的内容，将内容传给sed命令，sed命令将数字部分都替换为空，再对这个显示的值做字符串长度的计算，如果不是0就要提示应该输入数字，不然就退出。</span></span><br><span class="line">if [ $a -gt $b ];then</span><br><span class="line">   echo "yes,$a &gt; $b"</span><br><span class="line">elif [ $a -eq $b ];then</span><br><span class="line">   echo "yes,$a = $b"</span><br><span class="line">else</span><br><span class="line">   echo "yes,$a &lt; $b"</span><br><span class="line">fi</span><br><span class="line">[root@template sh]# bash if1.sh 99 89</span><br><span class="line">yes,99 &gt; 89</span><br><span class="line">[root@template sh]# bash if1.sh 99 99</span><br><span class="line">yes,99 = 99</span><br><span class="line">[root@template sh]# bash if1.sh 69 99 </span><br><span class="line">yes,69 &lt; 99</span><br><span class="line"></span><br><span class="line">例：检查mysql是否启动</span><br><span class="line">[root@template sh]# vim check_db.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">portNum=`netstat -lnt|grep 3306|wc -l`</span><br><span class="line">if [ $portNum -eq 1 ];then</span><br><span class="line">   echo "db is running"</span><br><span class="line">else</span><br><span class="line">   service mysqld start</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 脚本的名称中最好不要包括要查询的服务的名称，如这里就是mysql</span></span><br><span class="line"></span><br><span class="line">例：检查mysql是否启动，更完整 </span><br><span class="line">[root@template sh]# vim check1_db.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">LogPath=/tmp/mysql.log</span><br><span class="line">portNum=`netstat -lnt|grep 3306|wc -l`</span><br><span class="line">mysqlProcessNum=`ps -ef|grep mysqld|grep -v grep|wc -l`</span><br><span class="line">if [ $portNum -eq 1 ] &amp;&amp; [ $mysqlProcessNum -eq 2 ];then</span><br><span class="line">   echo "db is running"</span><br><span class="line">else</span><br><span class="line">   /etc/init.d/mysqld start</span><br><span class="line">   sleep 10</span><br><span class="line">   portNum=`netstat -lnt|grep 3306|wc -l`</span><br><span class="line">   mysqlProcessNum=`ps -ef|grep mysqld|grep -v grep|wc -l`</span><br><span class="line">   if [ $portNum -ne 1 ] &amp;&amp; [ $mysqlProcessNum -ne 2 ];then</span><br><span class="line">        while true;do</span><br><span class="line">           killall mysqld &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">           [ $? -ne 0 ] &amp;&amp; break</span><br><span class="line">           sleep 1</span><br><span class="line">        done</span><br><span class="line">        /etc/init.d/mysqld start &gt;&gt; $LogPath &amp;&amp; status="successful" || status="failure"</span><br><span class="line">        mail -s "mysql startup status is $status" root@localost &lt; $LogPath</span><br><span class="line">   fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：检查mysql是否启动，利用mysql帐号登录测试</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">LogPath=/tmp/mysql.log</span><br><span class="line">mysql -uroot -p'centos' -S /var/lib/mysql/mysql.sock -e "select version();" &gt;&amp; /dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的用户名与密码一定要正确，不然也会执行失败，使下面判断mysql为未启动状态。</span></span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">   echo "db is running"</span><br><span class="line">else</span><br><span class="line">   /etc/init.d/mysqld start &gt; $LogPath</span><br><span class="line">   sleep 10</span><br><span class="line">   mysql -uroot -p'centos' -S /var/lib/mysql/mysql.sock -e "select version();" &gt;&amp; /dev/null</span><br><span class="line">   if [ $? -ne 0 ];then</span><br><span class="line">        while true;do</span><br><span class="line">           killall mysqld &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">           [ $? -ne 0 ] &amp;&amp; break</span><br><span class="line">           # 这里只检查killall命令执行是否正确，如果正确就跳出循环。个人认为还应该加上检查进程是否存在更准确</span><br><span class="line">           sleep 1</span><br><span class="line">        done</span><br><span class="line">        /etc/init.d/mysqld start &gt;&gt; $LogPath &amp;&amp; status="successful" || status="failure"</span><br><span class="line">        mail -s "mysql startup status is $status" root@localost &lt; $LogPath</span><br><span class="line">   fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：检查mysql是否启动的php脚本</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="meta">   $</span><span class="bash">link_id=mysql_connect(<span class="string">'localhost'</span>,<span class="string">'root'</span>,<span class="string">'centos'</span>) or mysql_error();</span></span><br><span class="line">   if ($link_id) &#123;</span><br><span class="line">       echo "mysql successful !";</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">       echo mysql_error();</span><br><span class="line">   &#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">监控mysql数据库是否异常的多种方法</span><br><span class="line">1. 根据mysql端口号监控mysql(本地)</span><br><span class="line">2. 根据mysql进程监控mysql(本地)。只能本地监控，进程在服务可能不正常，如：负载很高，CPU很高，连接数满了，另外，进程也可以远程监控，如通过ssh key，expect</span><br><span class="line">3. 通过mysql客户端命令及用户帐户连接mysql，然后根据返回命令状态或返回内容确认mysql是否正常（本地和远程连接判断）。必须要有mysql客户端，要有数据库的帐号与密码及连接数据库主机授权。</span><br><span class="line">4. 通过php/java程序url方式监控mysql，此方法最接近用户访问，效果最好。报警的最佳方式不是服务是否开启了，而是网站的用户是否还能正常访问</span><br><span class="line">5. 以上四种方法的综合运用</span><br><span class="line"></span><br><span class="line">例：本地监控web服务</span><br><span class="line">[root@template sh]# vim check_web.sh     </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">HttpPortNum=`netstat -tln|grep 80|wc -l`</span><br><span class="line">if [ $HttpPortNum -ge 1 ];then</span><br><span class="line">   echo "web is running"</span><br><span class="line">else</span><br><span class="line">   echo "web is not running"</span><br><span class="line">   /etc/init.d/nginx start</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：远程监控web服务</span><br><span class="line">[root@template sh]# vim check1_web.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">HttpPortNum=`nmap 192.168.1.24 -p 80|grep open|wc -l`</span><br><span class="line">if [ $HttpPortNum -ge 1 ];then</span><br><span class="line">   echo "web is running"</span><br><span class="line">else</span><br><span class="line">   echo "web is not running"</span><br><span class="line">   /etc/init.d/nginx start</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：通过url地址远程监控web服务</span><br><span class="line">[root@template sh]# vim check2_web.sh             </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">wget -T 10 -q --spider http://192.168.1.24 &gt; /dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"> -T表示超时时间，-q表示静默模式，--spider表示爬虫</span></span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">   echo "web is running"</span><br><span class="line">else</span><br><span class="line">   echo "web is not running"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：通过状态码查看服务是否启动</span><br><span class="line">[root@template sh]# vim check3_web.sh    </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">[ -f /etc/init.d/functions ] &amp;&amp; . /etc/init.d/functions</span><br><span class="line">httpCode=`curl -I -s 192.168.1.24|head -1|cut -d" " -f2`</span><br><span class="line">if [ "$httpCode" == "200" ];then</span><br><span class="line">   action "nginx is running" /bin/true</span><br><span class="line"><span class="meta">   #</span><span class="bash"> action是调用<span class="built_in">functions</span>函数</span></span><br><span class="line">else</span><br><span class="line">   action "nginx is not running" /bin/false</span><br><span class="line">   sleep 1</span><br><span class="line">   /etc/init.d/nginx start</span><br><span class="line">   action "nginx is started" /bin/true</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：使用传参的方式查看服务是否启动</span><br><span class="line">[root@template sh]# vim check4_web.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">if [ $# -ne 2 ];then</span><br><span class="line">   echo "Usage: $0 ip port "</span><br><span class="line">fi</span><br><span class="line">PortNum=`nmap $1 -p $2 |grep open|wc -l`</span><br><span class="line">if [ $PortNum -eq 1 ];then</span><br><span class="line">   echo "$1 $2 is open"</span><br><span class="line">else</span><br><span class="line">   echo "$1 $2 is closed"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h3 id="case条件语句"><a href="#case条件语句" class="headerlink" title="case条件语句"></a>case条件语句</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">case "字符串变量" in</span><br><span class="line">	值1) 指令 ...</span><br><span class="line">	;;</span><br><span class="line">	值2) 指令 ...</span><br><span class="line">	;;</span><br><span class="line">	*) 指令 ...</span><br><span class="line">	;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">[root@template sh]# vim plus_color.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">new_chars() &#123;</span><br><span class="line">RED_COLOR='\E[1;31m'</span><br><span class="line">GREEN_COLOR='\E[1;32m'</span><br><span class="line">YELLOW_COLOR='\E[1;33m'</span><br><span class="line">BLUE_COLOR='\E[1;34m'</span><br><span class="line">PINK_COLOR='\E[1;35m'</span><br><span class="line">RES='\E[0m'</span><br><span class="line"></span><br><span class="line">if [ $# -ne 2 ];then</span><br><span class="line">   echo "Usage $0 content &#123;red|yellow|blue|green&#125;"</span><br><span class="line">   exit</span><br><span class="line">fi</span><br><span class="line">case "$2" in</span><br><span class="line">   red|RED)</span><br><span class="line">        echo -e "$&#123;RED_COLOR&#125;$1$&#123;RES&#125;"</span><br><span class="line">   ;;</span><br><span class="line">   yellow|YELLOW)</span><br><span class="line">        echo -e "$&#123;YELLOW_COLOR&#125;$1$&#123;RES&#125;"</span><br><span class="line">   ;;</span><br><span class="line">   green|GREEN)</span><br><span class="line">        echo -e "$&#123;GREEN_COLOR&#125;$1$&#123;RES&#125;"</span><br><span class="line">   ;;</span><br><span class="line">   blue|BLUE)</span><br><span class="line">        echo -e "$&#123;BLUE_COLOR&#125;$1$&#123;RES&#125;"</span><br><span class="line">   ;;</span><br><span class="line">   pink|PINK)</span><br><span class="line">        echo -e "$&#123;PINK_COLOR&#125;$1$&#123;RES&#125;"</span><br><span class="line">   ;;</span><br><span class="line">   *)</span><br><span class="line">        echo "Usage $0 content &#123;red|yellow|blue|green&#125;"</span><br><span class="line">   ;;</span><br><span class="line">esac</span><br><span class="line">&#125;</span><br><span class="line">new_chars abc red</span><br><span class="line">new_chars abc yellow</span><br><span class="line">new_chars abc green</span><br><span class="line">new_chars abc blue</span><br><span class="line">new_chars abc pink</span><br><span class="line"></span><br><span class="line">例：利用case语句启动web服务</span><br><span class="line">[root@template sh]# vim nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">nginx="/etc/init.d/nginx"</span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">case "$1" in</span><br><span class="line">   start)</span><br><span class="line">        $nginx start &gt;&amp; /dev/null</span><br><span class="line">        [ $? -eq 0 ] &amp;&amp; action "nginx is started" /bin/true ||\</span><br><span class="line">        action "nginx is started" /bin/false</span><br><span class="line">   ;;</span><br><span class="line">   stop)</span><br><span class="line">        $nginx stop &gt;&amp; /dev/null</span><br><span class="line">        [ $? -eq 0 ] &amp;&amp; action "nginx is stoped" /bin/true ||\</span><br><span class="line">        action "nginx is stoped" /bin/false</span><br><span class="line">   ;;</span><br><span class="line">   restart)</span><br><span class="line">        $nginx restart &gt;&amp; /dev/null</span><br><span class="line">        [ $? -eq 0 ] &amp;&amp; action "nginx is restarted" /bin/true ||\</span><br><span class="line">        action "nginx is restarted" /bin/false</span><br><span class="line">   ;;</span><br><span class="line">   *)</span><br><span class="line">        echo "Usage: $0 &#123;start|stop|restart&#125;"</span><br><span class="line">        exit</span><br><span class="line">   ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<h3 id="while语句"><a href="#while语句" class="headerlink" title="while语句"></a>while语句</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">while 条件;do</span><br><span class="line">	指令</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 条件满足就退出</span></span><br><span class="line"></span><br><span class="line">while读文件方式</span><br><span class="line">方式一</span><br><span class="line">exec &lt; FILE</span><br><span class="line">sum=0</span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">	cmd</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">方式二</span><br><span class="line">cat $&#123;FILE_PATH&#125; | while read line</span><br><span class="line">do</span><br><span class="line">	cmd</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">方式三</span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">	cmd</span><br><span class="line">done &lt; FILE</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim while1.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">while true;do</span><br><span class="line">   uptime</span><br><span class="line">   sleep 2</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">while</span> <span class="literal">true</span>表示永远为真，是死循环</span></span><br><span class="line">[root@template sh]# vim while2.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">while [ 1 ];do</span><br><span class="line">   uptime</span><br><span class="line">   usleep 1000000</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的条件为[ 1 ]，也是死循环的意思。usllep是使用微秒为单位</span></span><br><span class="line"></span><br><span class="line">=======================================================================================</span><br><span class="line">ctrl+z：暂停执行当前脚本或任务</span><br><span class="line">bg：把当前脚本或任务放到后台执行</span><br><span class="line">fg：把当前脚本或任务拿到前台执行，如果有多个任务，可以fg加任务编号调出，如fg 1</span><br><span class="line">jobs：查看执行的脚本或任务</span><br><span class="line">=======================================================================================</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim while3.sh     </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">i=1</span><br><span class="line">sum=0</span><br><span class="line">while ((i &lt;= 100));do</span><br><span class="line">   ((sum=sum+i))</span><br><span class="line">   ((i++))</span><br><span class="line">done</span><br><span class="line">echo $sum</span><br><span class="line"></span><br><span class="line">例：循环竖向打印10-1，使用双小括号</span><br><span class="line">[root@template sh]# vim while4.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">i=10</span><br><span class="line">while ((i&gt;0));do</span><br><span class="line">   echo $i</span><br><span class="line">   ((i--))</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例：循环竖向打印10-1，使用双中括号</span><br><span class="line">[root@template sh]# vim while5.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">i=10</span><br><span class="line">while [[ $i&gt;0 ]];do</span><br><span class="line">   echo $i</span><br><span class="line">   ((i--))</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用双中括号时必须使用<span class="variable">$i</span>，而不能用i</span></span><br><span class="line"></span><br><span class="line">例：循环竖向打印10-1，使用单中括号</span><br><span class="line">[root@template sh]# vim while6.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">i=10</span><br><span class="line">while [ $i -gt 0 ];do</span><br><span class="line">   echo $i</span><br><span class="line">   ((i--))</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 这里也可以写为<span class="built_in">let</span> i--或i=$[<span class="variable">$i</span>-1]，中括号中不能写成i--这样的形式。</span></span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用单中括号时，<span class="keyword">while</span>的比较运算符要使用-gt的形式，或使用\&gt;的形式，也就是使用大于号时要转义</span></span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">[root@template sh]# vim while7.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">read -t 20 -p "pls input the num: " i</span><br><span class="line">while ((--i));do</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当i为0时就会退出循环</span></span><br><span class="line">   echo $i</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例：测试负载均衡是否平均分配到了节点</span><br><span class="line">[root@template sh]# vim while8.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">while true;do</span><br><span class="line">   curl -I -s http://www.test.com|head -1</span><br><span class="line">   sleep 10</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例：数组方法</span><br><span class="line">[root@template sh]# vim check_url.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">url_list=(</span><br><span class="line">http://www.baidu.com</span><br><span class="line">http://www.sina.com</span><br><span class="line">http://www.sohu.com</span><br><span class="line">http://192.168.1.24</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">wait_time() &#123;</span><br><span class="line">   echo -n "3秒后，执行此操作"</span><br><span class="line">   for ((i=0;i&lt;3;i++));do</span><br><span class="line">        echo -n ".";sleep 1</span><br><span class="line">   done</span><br><span class="line">   echo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_url() &#123;</span><br><span class="line">   wait_time</span><br><span class="line">   echo 'check url...'</span><br><span class="line">   for ((i=0;i&lt;`echo $&#123;#url_list[*]&#125;`;i++));do</span><br><span class="line">        judge=($(curl -I -s $&#123;url_list[$i]&#125;|head -1|tr "\r" "\n"))</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里还是将结果当作一个数组传给judge变量，下面对数组的各值做判断。       </span></span><br><span class="line">        if [[ "$&#123;judge[1]&#125;" == '200' &amp;&amp; "$&#123;judge[2]&#125;" == 'OK' ]];then</span><br><span class="line">        # 这里的问题是只以200状态码与OK为正常，如果是301也是正常的，但这里就会判断为不正常。</span><br><span class="line">           action "$&#123;url_list[$i]&#125;" /bin/true</span><br><span class="line">        else</span><br><span class="line">           action "$&#123;url_list[$i]&#125;" /bin/false</span><br><span class="line">        fi</span><br><span class="line">   done</span><br><span class="line">&#125;</span><br><span class="line">check_url</span><br><span class="line">=======================================================================================</span><br><span class="line">curl命令</span><br><span class="line">-I/--head：只显示响应报文首部信息</span><br><span class="line">-s/--silent：静音模式。不输出任何东西</span><br><span class="line">-o/--output：把输出写到一个文件中，这是保存网页的方法</span><br><span class="line">-w/--write-out [format]：如 -w %&#123;http_code&#125;可以取得网页的状态码。</span><br><span class="line">例</span><br><span class="line">curl -o /dev/null -s -w %&#123;http_code&#125; www.linux.com</span><br><span class="line">=======================================================================================</span><br><span class="line"></span><br><span class="line">例：读日志文件，计算其中所有行的日志各元素的访问字节数的总和</span><br><span class="line">[root@template sh]# vim while9.sh    </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">sum=0</span><br><span class="line">while read line;do</span><br><span class="line">   size=`echo $line|awk '&#123;print $10&#125;'`</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 以空格为分隔符，日志的第10段是访问数据的大小</span></span><br><span class="line">   [ "$size" == "-" ] &amp;&amp; continue</span><br><span class="line">   ((sum=sum+$size))</span><br><span class="line">done &lt; /var/log/nginx/access.log</span><br><span class="line">echo $sum</span><br></pre></td></tr></table></figure>
<h3 id="until语句"><a href="#until语句" class="headerlink" title="until语句"></a>until语句</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">until 条件;do</span><br><span class="line">	指令</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 条件不满足就退出，until应用场合不多见</span></span><br></pre></td></tr></table></figure>
<h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">for 变量名 in 变量取值列表</span><br><span class="line">do</span><br><span class="line">	指令</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在此结构中<span class="string">"in 变量取值列表"</span>可省略，省略时相当于<span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>，使用<span class="keyword">for</span> i 就相当于使用<span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span> </span></span><br><span class="line"></span><br><span class="line">for ((exp1;exp2;exp3))</span><br><span class="line">do</span><br><span class="line">	指令</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim for1.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">size=`awk '&#123;print $10&#125;' $1`</span><br><span class="line">sum=0</span><br><span class="line">for num in $size;do</span><br><span class="line">   [ -n "$num" -a "$num" = "$&#123;num//[^0-9]/&#125;" ] || continue</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 这里要判断一下，<span class="variable">$sum</span>是否不为空，再判断，替换了<span class="variable">$num</span>中开头的数字后，<span class="variable">$num</span>是否等于<span class="variable">$num</span>，如果等于，说明这里有字母，就退出本轮循环。</span></span><br><span class="line">   ((sum=$num+sum))</span><br><span class="line">done</span><br><span class="line">echo "Log size: $sum bytes=`echo $(($sum/1024))`KB"</span><br><span class="line">[root@template sh]# ./for1.sh /var/log/nginx/access.log </span><br><span class="line">Log size: 139959 bytes=136KB</span><br><span class="line"></span><br><span class="line">另一种方法</span><br><span class="line">[root@template sh]# echo `awk '&#123;print $10&#125;' /var/log/nginx/access.log|grep -v -|tr "\n" "+"|sed 's/3698+$/3698/'`|bc</span><br><span class="line">139959</span><br><span class="line"></span><br><span class="line">例：批量改名</span><br><span class="line">[root@template sh]# vim for2.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">for filename in `ls *.jpg`;do</span><br><span class="line">   mv $filename `echo $filename|cut -d . -f1`.git</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例：乘法表</span><br><span class="line">[root@template sh]# vim for3.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">for i in `seq 9`;do</span><br><span class="line">   for j in `seq 9`;do</span><br><span class="line">        [ $j -le $i ] &amp;&amp; echo -en "$j * $i = `expr $i \* $j` \c"</span><br><span class="line">        # -n表示不换行输出，-e表示激活转义字符，\c表示最后不加上换行符号</span><br><span class="line">   done</span><br><span class="line">   echo " "</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例：访问十次页面</span><br><span class="line">[root@template sh]# vim for4.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">for ((i=0;i&lt;=10;i++));do</span><br><span class="line">   curl http://192.168.1.24/index1.html</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="取随机数的方法"><a href="#取随机数的方法" class="headerlink" title="取随机数的方法"></a>取随机数的方法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">方法一</span><br><span class="line">[root@template sh]# echo $RANDOM</span><br><span class="line">9066</span><br><span class="line"></span><br><span class="line">方法二</span><br><span class="line">[root@template sh]# openssl rand -base64 8</span><br><span class="line">sT9rgkzhDKQ=</span><br><span class="line">[root@template sh]# openssl rand -base64 10</span><br><span class="line">dK5aymAlYRlJxA==</span><br><span class="line"></span><br><span class="line">方法三</span><br><span class="line">[root@template sh]# date +%s%N</span><br><span class="line">1547475685362659766</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过时间获取随机数</span></span><br><span class="line"></span><br><span class="line">方法四</span><br><span class="line">[root@template sh]# head /dev/urandom | cksum </span><br><span class="line">3543804650 1922</span><br><span class="line"><span class="meta">#</span><span class="bash"> /dev/random设备，存储着系统当前运行的环境的实时数据。它可以看作是系统某个时候，唯一值数据，因此可以用作随机数元数据。/dev/urandom这个设备数据与random里面一样，只是，它是非阻塞的随机数发生器，读取操作不会产生阻塞。</span></span><br><span class="line"></span><br><span class="line">方法五</span><br><span class="line">[root@template sh]# cat /proc/sys/kernel/random/uuid </span><br><span class="line">9794b963-3311-483e-aa9b-ace2df623d07</span><br><span class="line"></span><br><span class="line">方法六</span><br><span class="line">[root@template sh]# yum install -y expect</span><br><span class="line">[root@template sh]# mkpasswd -l 8</span><br><span class="line"><span class="meta">E&gt;</span><span class="bash">jC45ut</span></span><br><span class="line"></span><br><span class="line">[root@template sh]# cat /proc/sys/kernel/random/uuid | md5sum | cut -c 1-9</span><br><span class="line">c1baddd2e</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的命令得到随机数后都通过md5sum再计算一次得到一个数字，到通过cut命令取指定长度的数字。cut的-c选项就是仅显示行中指定范围的字符</span></span><br></pre></td></tr></table></figure>
<h3 id="break、continue、exit对比"><a href="#break、continue、exit对比" class="headerlink" title="break、continue、exit对比"></a>break、continue、exit对比</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>break n</td>
<td>n表示跳出循环的层数，如果省略n表示跳出整个循环</td>
</tr>
<tr>
<td>continue n</td>
<td>n表示退出到第n层继续循环，如果省略n表示跳过本次循环，忽略本次循环的接任代码，进入循环的下一次循环</td>
</tr>
<tr>
<td>exit n</td>
<td>退出当前shell程序，终止整个shell脚本，并返回n。n也可以省略。</td>
</tr>
<tr>
<td>return</td>
<td>与exit相似，在函数中使用，用于跳出函数</td>
</tr>
</tbody>
</table>
<h3 id="shell函数"><a href="#shell函数" class="headerlink" title="shell函数"></a>shell函数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">简单的语法：</span><br><span class="line">函数名() &#123;</span><br><span class="line">    指令</span><br><span class="line">    return n</span><br><span class="line">&#125;</span><br><span class="line">规范的语法：</span><br><span class="line">function 函数名() &#123;</span><br><span class="line">    指令</span><br><span class="line">    return n</span><br><span class="line">&#125;</span><br><span class="line">调用函数：</span><br><span class="line">1. 直接执行函数名即可。注意，不需要带小括号</span><br><span class="line">例：函数名</span><br><span class="line">2. 带参数的函数执行方法：</span><br><span class="line">例：函数名 参数1 参数2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在函数体中的位置参数(<span class="variable">$1</span>、<span class="variable">$2</span>、<span class="variable">$3</span>、<span class="variable">$#</span>、$*、$?、<span class="variable">$@</span>)都可以是函数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 父脚本的参数则临时地被函数参数所掩盖或隐藏</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$0</span>比较特殊，它仍然是父脚本的名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 函数一定要在调用之前定义并加载</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim func1.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">if [ $# -ne 1 ];then</span><br><span class="line">   echo "error" &amp;&amp; exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">Check_Url() &#123;</span><br><span class="line">   curl -I -s $1|head -1 &amp;&amp; return 0||return 1</span><br><span class="line">&#125;</span><br><span class="line">Check_Url $1</span><br><span class="line"><span class="meta">#</span><span class="bash"> Check_Url后的<span class="variable">$1</span>是命令行的第一个参数，curl中的<span class="variable">$1</span>是函数的第一个参数。这两个<span class="variable">$1</span>的作用是不一样的</span></span><br><span class="line"></span><br><span class="line">例：生产环境批量检查web服务是否正常并且发送相关邮件</span><br><span class="line">[root@template sh]# vim check_service.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">RETVAL=0</span><br><span class="line">FAILCOUNT=0</span><br><span class="line">SCRIPTS_PATH="/root/sh"</span><br><span class="line">MAIL_GROUP="root@localhost"</span><br><span class="line">LOG_FILE="/tmp/web_check.log"</span><br><span class="line">GetUrlStatus() &#123;</span><br><span class="line">   for ((i=1;i&lt;=3;i++));do</span><br><span class="line">        wget -T 10 --tries=1 --spider http://$&#123;1&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        [ $? -ne 0 ] &amp;&amp; let FAILCOUNT+=1</span><br><span class="line">   done</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 访问三次页面，如果返回值不是0，变量FAILCOUNT就自增1。</span></span><br><span class="line">   if [ $FAILCOUNT -gt 1 ];then</span><br><span class="line">        RETVAL=1</span><br><span class="line">        NowTime=`date +"%m-%d %H:%M:%S"`</span><br><span class="line">        SC="http://$&#123;1&#125; service is error,$&#123;NowTime&#125;."</span><br><span class="line">        echo "send to : $MAIL_USER, Title: $SUBJECT_CONTENT" &gt; $LOG_FILE</span><br><span class="line">        for MAIL_USER in $MAIL_GROUP;do</span><br><span class="line">           mail -s "$SC" $MAIL_USER &lt; $LOG_FILE</span><br><span class="line">        done</span><br><span class="line">   else</span><br><span class="line">        RETVAL=0</span><br><span class="line">   fi</span><br><span class="line">   return $RETVAL</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 判断变量FAILCOUNT是否大于1，如果大于1,就发邮件，并记入日志文件，并将变量RETVAL的值改为1，否则RETVAL的值是0，RETVAL的值就是返回码，退出函数。</span></span><br><span class="line">&#125;</span><br><span class="line">[ ! -d "$SCRIPTS_PATH" ] &amp;&amp; mkdir -p $SCRIPTS_PATH</span><br><span class="line">[ ! -f "$SCRIPTS_PATH"/domain.list ] &amp;&amp; &#123;</span><br><span class="line">cat &gt; $SCRIPTS_PATH/domain.list &lt;&lt; END</span><br><span class="line">www.baidu.com</span><br><span class="line">www.sohu.com</span><br><span class="line">192.168.1.24</span><br><span class="line">END</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断变量SCRIPTS_PATH指定的目录是否存在，不存在就创建，再判断变量SCRIPTS_PATH中的domain.list文件是否存在，不存在就创建，其中是网页地址。</span></span><br><span class="line">for URL in `cat $SCRIPTS_PATH/domain.list`;do</span><br><span class="line">   echo -n "checking $URL: "</span><br><span class="line">   GetUrlStatus $URL &amp;&amp; echo ok || echo no</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 循环检查domain.list文件中的网址，将变量URL的值给GetUrlStatus函数，在GetUrlStatus函数中由<span class="variable">$1</span>接收。如果返回值是0就显示ok，否则显示no</span></span><br><span class="line">[root@template sh]# bash check_service.sh   </span><br><span class="line">checking www.baidu.com: ok</span><br><span class="line">checking www.sohu.com: ok</span><br><span class="line">checking 192.168.1.24: no</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>
<h3 id="优化linux系统"><a href="#优化linux系统" class="headerlink" title="优化linux系统"></a>优化linux系统</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 安装系统时精简安装包，最小化安装</span><br><span class="line">2. 配置国内高速yum源</span><br><span class="line">3. 禁用开机不需要启动的服务</span><br><span class="line">4. 优化系统内核参数，/etc/sysctl.conf</span><br><span class="line">5. 增加系统文件描述符、堆栈等配置</span><br><span class="line">6. 有外网IP的机器要开启配置防火墙，仅对外开启需要提供服务的端口，配置或关闭selinux</span><br><span class="line">7. 清除无用的默认系统帐户或组（非必须）</span><br><span class="line">8. 锁定敏感文件，如/etc/passwd（非必须）</span><br><span class="line">9. 配置服务器和互联网时间同步</span><br><span class="line">10. 配置sudo对普通用户权限精细控制</span><br><span class="line">11. 把以上10点写成一键优化脚本</span><br></pre></td></tr></table></figure>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">方法一</span><br><span class="line">array=(value1 value2 value3 ...)</span><br><span class="line">echo $&#123;#array[@]&#125;</span><br><span class="line">echo $&#123;#array[*]&#125;</span><br><span class="line">echo $&#123;#array[0]&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 计算数组中的共有几个值</span></span><br><span class="line">echo $&#123;array[*]&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出数组中的所有值</span></span><br><span class="line">echo $&#123;array[0]&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出数组中的某个值，数组的下标从0开始</span></span><br><span class="line">array[3]=4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给某个数组下标赋值</span></span><br><span class="line">array[0]=abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给已有的数组下标修改值</span></span><br><span class="line">unset array</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除整个数组</span></span><br><span class="line">unset array[0]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除数组中某个下标的值</span></span><br><span class="line">echo $&#123;array[@]:1:3&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从第几个元素开始截取，截取几个</span></span><br><span class="line">array=($&#123;array[@]/5/6&#125;)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将第5个元素的值改为6</span></span><br><span class="line">echo $&#123;array[@]#o&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从左开始最短匹配删除</span></span><br><span class="line">echo $&#123;array[@]#fo&#125;</span><br><span class="line">echo $&#123;array[@]%t*e&#125;</span><br><span class="line">echo $&#123;array[@]%%t*e&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数组也是变量，因此也适合于变量的子串处理的功能应用。</span></span><br><span class="line"></span><br><span class="line">方法二</span><br><span class="line">array=([1]=one [2]=two [3]=three)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义下标与值</span></span><br><span class="line"></span><br><span class="line">方法三</span><br><span class="line">array[0]=a array[1]=b array[2]=c </span><br><span class="line"></span><br><span class="line">方法四</span><br><span class="line">declare -a array</span><br><span class="line"></span><br><span class="line">方法五</span><br><span class="line">array=($(ls))</span><br></pre></td></tr></table></figure>
<h3 id="trap信号"><a href="#trap信号" class="headerlink" title="trap信号"></a>trap信号</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">trap使用信号的方法</span><br><span class="line">trap命令用于指定在接收到信号后将要采取的行动。trap命令的一种常见用途是在脚本程序被中断时完成清理工作。历史上，shell总是用数字来代表信号，而新的脚本程序应该使用的名字，它们保存在用#include命令包含进来的signal.h头文件中，在使用信号名时需要省略SIG前缀。你可以在命令提示符下输入命令trap -l来查看信号编号及其关联的名称。</span><br><span class="line">脚本程序通常是以从上到下的顺序解释执行的，所以必须在你想保护的那部分代码以前指定trap命令。</span><br><span class="line">如果要重置桔某个信号的处理条件到其默认值，只需简单的将command设置为-。如果要忽略某个信号，就把command设置为空字符串''，一个不带参数的trap命令将列出当前设置的信号及其行动的清单。exit命令后传输就是就是这个信号的代码</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template ~]# trap "" 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 屏蔽ctrl+c信号 </span></span><br><span class="line">[root@template ~]# trap ":" 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复ctrl+c信号 </span></span><br><span class="line">[root@template ~]# trap "echo -n 'you are typing ctrl+c'" 2 </span><br><span class="line">[root@template ~]# ^Cyou are typing ctrl+c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置一个提示，当输入指定信号时就会提示</span></span><br><span class="line">[root@template ~]# trap "" HUP INT QUIT TSTP TERM</span><br><span class="line"><span class="meta">#</span><span class="bash"> 屏蔽多个信号</span></span><br><span class="line">[root@template ~]# trap ":" HUP INT QUIT TSTP TERM</span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复多个信号 </span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim showdate.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">trap 'echo “you go…”;exit 1' INT</span><br><span class="line">while :; do</span><br><span class="line">    date</span><br><span class="line">    sleep 2</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 捕捉到信號，顯示命令。要想用ctrl+c退出，要在<span class="built_in">echo</span> you go后加&amp;&amp; <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim ping.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">NET=192.168.1</span><br><span class="line">FILE=`mktemp /tmp/file.XXXXX`</span><br><span class="line">clearup() &#123;</span><br><span class="line">   echo “quit…”</span><br><span class="line">   rm -f $FILE</span><br><span class="line">   exit 1</span><br><span class="line">&#125;</span><br><span class="line">trap 'clearup' INT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试发现，只要有退出码，就可以使用ctrl+c退出脚本。如上面的退出码是<span class="built_in">exit</span> 1。如果注释了上面的函数，再使用ctrl+c退出时只能退出当前ping的命令，脚本会继续ping下一个地址。</span></span><br><span class="line">for I in &#123;200..254&#125;; do</span><br><span class="line">   if ping -c 1 -W 1 $NET.$I &amp;&gt; /dev/null; then</span><br><span class="line">      echo “$NET.$I is up .” | tee &gt;&gt; $FILE</span><br><span class="line">   else</span><br><span class="line">      echo “$NET.$I is down”</span><br><span class="line">   fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">124</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">28</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">94</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
