<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/5/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/22/zabbix安装与配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/22/zabbix安装与配置/" itemprop="url">
                  zabbix安装与配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-04-22 10:45:50" itemprop="dateCreated datePublished" datetime="2019-04-22T10:45:50+08:00">2019-04-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-05-18 11:03:41" itemprop="dateModified" datetime="2019-05-18T11:03:41+08:00">2019-05-18</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/监控/" itemprop="url" rel="index"><span itemprop="name">监控</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><blockquote>
<p>Zabbix是一个企业级的开源监控软件，可以监控IT基础架构的可用性和应用的性能，为用户提供集中管理、分布式监控的一站式（all in one）监控解决方案，是一款真正的开源产品（True Open source）。采用GPL协议发布，不论是商业或非商业的使用没有任何限制，可以说是绝对的自由使用。</p>
<p>Zabbix最基本的目的是收集监控数据，将收集的数据统一保存到数据库中进行分析处理，利用Web前端页面可以轻松的将这些监控数据实时展示出来。通过与设定的阈值进行比较触发特定的事件并产生相应的动作，发出告警通知或执行远程命令。Zabbix 提供了多种监控方式用来监控基础架构的各个方面，不仅有专用的Agent，还支持External checks、SNMP、IPMI、JMX monitoring、SSH checks等多种方式收集监控数据，具有丰富的功能和灵活的扩展性。事实上，几乎所有你能想到的都可以在Zabbix中实现监控。</p>
</blockquote>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><blockquote>
<p>Zabbix监控系统包含四个主要组件：Zabbixserver、Zabbix proxy、Zabbix database和Zabbix GUI。每个组件都有其自身的特点和要求：</p>
<ul>
<li>Zabbix server：这是核心引擎，负责收集或接收来自被监控设备的数据。它是用C语言开发的，与Zabbix agents、Zabbix proxy和 Zabbix database进行通信。它是最主要的组件，管理所有的规则（包括收集监控数据、触发器、告警等等）。</li>
<li>Zabbix GUI：这是 Zabbix Web前端管理页面，用户通过Web前端页面可以查看Zabbixserver收集的数据，也可以对Zabbix server进行配置。它是用 PHP 开发的，使用支持 PHP程序运行的 web 服务器 (Apache或Nginx)，并与 Zabbix 数据库通信。</li>
<li>Zabbix database： 这是 Zabbix 数据存储库。 Zabbix的后端数据库可以是 Oracle、 IBM DB2、PostgreSQL、MySQL 或 SQLite3。在这本书中，我们将使用MySQL 作为数据库。</li>
<li>Zabbix proxy：这是一个可选的组件，利用它来实现分布式监控架构或分担Zabbix server的负载，提高Zabbix server的性能。它的主要功能是协助 Zabbix server从被监视的主机或设备收集数据。Zabbix proxy收集的数据首先存放到本地临时数据库中，随后定时发送到 Zabbix server中，即便Zabbix server和Zabbix proxy的连接断开也不会导致数据的丢失（数据保留的时间可在proxy的配置文件中设置）。在3.0版本中原生支持Zabbix server和Zabbix proxy之间的数据加密传输（基于证书或者基于共享秘钥的加密都是支持的）。</li>
</ul>
</blockquote>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><blockquote>
<p>Zabbix是一个三层架构，在实现时我们需要安装以下三个服务器，即Web服务器、Database服务器和Zabbix服务器。如果需要监控的规模比较小（几台或几十台主机），三个服务器可以同时安装在一个物理服务器中，这种方式的优点是安装配置简单快速，初期部署成本比较低。随着监控规模的不断扩大，需要保存和处理更多的监控数据，也会有更多的运维人员访问Zabbix Web前端页面，这样势必会让Zabbixserver的处理性能下降，出现断图、Web前端页面访问慢等问题。这时我们可以将Web服务器、Database服务器和Zabbix服务器拆分，分别安装到不同的物理服务器中。这种方式中每个服务器组件使用专用的硬件资源，可以解决相应的性能问题，但是需要增加服务器硬件的投入。</p>
</blockquote>
<h2 id="zabbix数据处理流程"><a href="#zabbix数据处理流程" class="headerlink" title="zabbix数据处理流程"></a>zabbix数据处理流程</h2><blockquote>
<p>在标准的Zabbix数据处理流程中，主要是通过几个不同的数据源端发送数据到Zabbix server，所有的数据都会保存到数据库中，并通过Web GUI为用户展现结果。发送数据的主要源包括：</p>
<ul>
<li>Zabbix agent</li>
<li>Zabbix sender</li>
<li>Other agent （如脚本或者自定义的第三方的agent）</li>
<li>Zabbix proxy</li>
</ul>
</blockquote>
<h2 id="zabbix部署架构"><a href="#zabbix部署架构" class="headerlink" title="zabbix部署架构"></a>zabbix部署架构</h2><blockquote>
<p>Zabbix在大部分场景中以集中式架构部署即可满足要求，所谓集中式架构就是无论Zabbix server、Database server和Web server是否安装在同一台服务器中，所有的监控数据都是由Zabbix server收集。如果你需要监控的IT基础架构有多个分中心或分支机构，建议采用分布式架构部署，在每个分中心或分支机构增加Zabbix proxy，由Zabbix proxy收集本地的监控数据后统一传输到Zabbix server中存储和处理，实现分布式架构、集中监控的方案。</p>
</blockquote>
<h1 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h1><h2 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a>Server端</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">===========================================================================================</span><br><span class="line">环境：</span><br><span class="line">系统：CentOS Linux release 7.4.1708 (Core)，地址：192.168.2.140，此次测试将Server端与agent端安装在同一台主机上。关闭防火墙与SELinux。</span><br><span class="line">===========================================================================================</span><br><span class="line">------------------------------</span><br><span class="line">   安装mariadb数据库</span><br><span class="line">------------------------------</span><br><span class="line">[root@zabbix ~]# yum install mariadb-server</span><br><span class="line">[root@zabbix ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip_name_resolve = ON</span><br><span class="line">innodb_file_per_table = ON</span><br><span class="line">[root@zabbix ~]# systemctl start mariadb.service</span><br><span class="line">[root@zabbix ~]# systemctl enable mariadb.service</span><br><span class="line">[root@zabbix ~]# mysql_secure_installation</span><br><span class="line">[root@zabbix ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE zabbix CHARSET 'utf8';</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL ON zabbix.* TO 'zbxuser'@'%' IDENTIFIED BY 'zbxpass';</span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">-----------------------------</span><br><span class="line">   安装zabbix_server</span><br><span class="line">-----------------------------</span><br><span class="line">[root@zabbix ~]# wget https://mirrors.aliyun.com/zabbix/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4.0版本下载地址：https://mirrors.aliyun.com/zabbix/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm </span></span><br><span class="line">[root@zabbix ~]# yum install -y zabbix-release-3.0-1.el7.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载源文件并安装</span></span><br><span class="line">[root@zabbix ~]# vim /etc/yum.repos.d/zabbix.repo</span><br><span class="line">[zabbix]</span><br><span class="line">name=Zabbix Official Repository - $basearch</span><br><span class="line">baseurl=http://repo.zabbix.com/zabbix/3.0/rhel/7/$basearch/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX</span><br><span class="line"></span><br><span class="line">[zabbix-non-supported]</span><br><span class="line">name=Zabbix Official Repository non-supported - $basearch</span><br><span class="line">baseurl=http://repo.zabbix.com/non-supported/rhel/7/$basearch/</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX</span><br><span class="line">gpgcheck=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将gpgcheck都改为0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的repo地址可能连接有问题，可以将[zabbix]中的baseurl改为阿里地址，https://mirrors.aliyun.com/zabbix/zabbix/4.0/rhel/7/x86_64/。</span></span><br><span class="line">[root@zabbix ~]# yum install -y zabbix-server-mysql.x86_64 zabbix-web.noarch zabbix-get.x86_64 zabbix-web-mysql.noarch zabbix-agent.x86_64 zabbix-sender.x86_64 httpd php php-mysql php-mbstring php-gd php-bcmath php-ldap php-xml </span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装4.0版本需要先安装libiksemel.so.3，libiksemel.so.3在iksemel-1.4-6.sdl7.x86_64.rpm包中，下载地址：https://centos.pkgs.org/7/puias-unsupported-x86_64/iksemel-1.4-6.sdl7.x86_64.rpm.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装zabbix相关包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix程序组件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix_server：服务端守护进程</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix_aget：agent守护进程</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix_proxy：代理服务器，可选；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix_database：存储系统，mysql/pgsql</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix_web：web GUI</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix_get:命令行工具，测试向agent端发起数据采集请求使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix_sender：命令行，测试向server端发送数据</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix_java_gateway：java网关</span></span><br><span class="line"></span><br><span class="line">------------------</span><br><span class="line">   导入数据库</span><br><span class="line">------------------</span><br><span class="line">[root@zabbix ~]# cp /usr/share/doc/zabbix-server-mysql-3.0.27/create.sql.gz /root</span><br><span class="line">[root@zabbix ~]# gzip -d create.sql.gz</span><br><span class="line">[root@zabbix ~]# mysql -uzbxuser -h 127.0.0.1 -pzbxpass zabbix &lt; ./create.sql</span><br><span class="line">[root@zabbix ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; USE zabbix;</span><br><span class="line">MariaDB [(none)]&gt; SHOW tables;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以看到导入的表</span></span><br><span class="line"></span><br><span class="line">-----------------------------</span><br><span class="line">   配置zabbix_server</span><br><span class="line">-----------------------------</span><br><span class="line">[root@zabbix ~]# cd /etc/zabbix/</span><br><span class="line">[root@zabbix ~]# cp zabbix_server.conf&#123;,.bak&#125;</span><br><span class="line">[root@zabbix ~]# vim zabbix_server.conf</span><br><span class="line">ListenPort=10051</span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix-server默认监听端口为10051</span></span><br><span class="line">SourceIP=192.168.2.140</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果Server端有多个IP，此项一定要定义，这是被客户端允许采样的IP</span></span><br><span class="line">LogType=file</span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志格式，有三种，默认是file，表示自己记录到一个文件中。这个file就是下面LogFile定义的路径</span></span><br><span class="line">LogFile=/var/log/zabbix/zabbix_server.log</span><br><span class="line">LogFileSize=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指明日志文件大小，大于这里指定的数字将会滚动。日志是否滚动，0表示不滚动</span></span><br><span class="line">DebugLevel=3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志级别，3表示正常，数字越大越详细，最大是5</span></span><br><span class="line">PidFile=/var/run/zabbix/zabbix_server.pid</span><br><span class="line">DBHost=localhost</span><br><span class="line"><span class="meta">#</span><span class="bash"> zabbix数据库的地址</span></span><br><span class="line">DBName=zabbix</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据库名字</span></span><br><span class="line">DBUser=zbxuser</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接数据库用的用户名</span></span><br><span class="line">DBPassword=zbxpass</span><br><span class="line">DBSocket=/var/lib/mysql/mysql.sock</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接数据库用的sock，用rpm包安装的mysql，sock在/var/lib/mysql/mysql.sock，这是在my.cnf中定义的</span></span><br><span class="line">DBPort=3306</span><br><span class="line">SNMPTrapperFile=/var/log/snmptrap/snmptrap.log</span><br><span class="line">Timeout=4</span><br><span class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">LogSlowQueries=3000</span><br><span class="line">[root@zabbix ~]# systemctl start zabbix-server</span><br><span class="line">[root@zabbix ~]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是否监听10051端口</span></span><br><span class="line">[root@zabbix ~]# cd /etc/httpd/conf.d/</span><br><span class="line">[root@zabbix ~]# vim zabbix.conf</span><br><span class="line">php_value date.timezone Asia/Shanghai   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置时区</span></span><br><span class="line">[root@zabbix ~]# systemctl start httpd</span><br><span class="line">下面进入页面访问安装，地址:IP/zabbix</span><br></pre></td></tr></table></figure>
<p><img src="/images/zabbix/安装1.png" alt=""></p>
<p><img src="/images/zabbix/安装2.png" alt=""></p>
<p><img src="/images/zabbix/安装3-mysql.png" alt=""></p>
<p>上图输入在mysql中设置的用户名与密码</p>
<p><img src="/images/zabbix/安装4.png" alt=""></p>
<p>上图只输入服务器地址与端口即可</p>
<p><img src="/images/zabbix/安装5.png" alt=""></p>
<p><img src="/images/zabbix/安装6.png" alt=""></p>
<p>上图页面中提示你Zabbix前端已经成功安装，并在目录/etc/zabbix/web/中创建了配置文件zabbix.conf.php。</p>
<p><img src="/images/zabbix/登录页面.png" alt=""></p>
<p>在上图的Web前端登录页面中，我们输入Zabbix默认的用户名和密码，用户名：Admin，密码：zabbix </p>
<p><img src="/images/zabbix/登录首页.png" alt=""></p>
<h2 id="agent端"><a href="#agent端" class="headerlink" title="agent端"></a>agent端</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">----------------------------</span><br><span class="line">   安装zabbix_agent</span><br><span class="line">----------------------------</span><br><span class="line">[root@zabbix ~]# yum install zabbix-agent zabbix-sender</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里以在server端安装agent端为例，可按此方法在其他主机安装agent端</span></span><br><span class="line">[root@zabbix ~]# cd /etc/zabbix/</span><br><span class="line">[root@zabbix ~]# cp zabbix_agentd.conf&#123;,.bak&#125;</span><br><span class="line">[root@zabbix ~]# vim zabbix_agentd.conf</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_agentd.pid</span><br><span class="line">LogFile=/var/log/zabbix/zabbix_agentd.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">Server=127.0.0.1,192.168.2.140</span><br><span class="line"><span class="meta">#</span><span class="bash"> 被动模式下需要设置，从哪个服务器连接agent，这里要输入的是zabbix_server的地址。</span></span><br><span class="line">ServerActive=127.0.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash">  主动模式下需要设置，向哪个服务器发送数据，这里要输入的是zabbix_server的地址。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 主动与被动指的是客户端主动还是被动</span></span><br><span class="line">Hostname=Zabbix server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 主动模式下必须设置，被动模式不需要</span></span><br><span class="line">Include=/etc/zabbix/zabbix_agentd.d/</span><br><span class="line">[root@zabbix ~]# systemctl start zabbix-agent</span><br><span class="line">[root@zabbix ~]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是否监听10050端口</span></span><br><span class="line">[root@zabbix ~]# zabbix_get -s 192.168.2.140 -k "system.cpu.switches"</span><br><span class="line">1456242</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试，采集CPU的某个值</span></span><br><span class="line">[root@zabbix ~]# zabbix_get -s 192.168.2.140 -k "system.cpu.switches"</span><br><span class="line">zabbix_get [4179]: Get value error: cannot connect to [[192.168.2.140]:10050]: [111] Connection refused</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果agent服务未启动，采集时会报错。</span></span><br></pre></td></tr></table></figure>
<h2 id="配置中文页面"><a href="#配置中文页面" class="headerlink" title="配置中文页面"></a>配置中文页面</h2><p><img src="/images/zabbix/配置中文页面1.png" alt=""></p>
<p>点击右上角的Admin图标，进入页面选择Language为Chinese(zh_CN)，再次刷新页面后就会变为中文，但还是会有问题。就是在图形展示时，图形下的说明文字会有乱码问题，解决方法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">从windows系统中复制simkai.ttf（楷体）字体到CentOS系统</span><br><span class="line">[root@zabbix ~]# cp simkai.ttf /usr/share/fonts/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将字体复制到/usr/share/fonts/</span></span><br><span class="line">[root@zabbix ~]# chmod +r /usr/share/fonts/simkai.ttf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不知此步是否有用，因为看到有教程中simkai.ttf的权限是544</span></span><br><span class="line">[root@zabbix ~]# alternatives --install /usr/share/zabbix/fonts/graphfont.ttf zabbix-web-font /usr/share/fonts/simkai.ttf 100</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是将字体加入到zabbix-web-font中</span></span><br><span class="line">[root@zabbix ~]# alternatives --display zabbix-web-font</span><br><span class="line">...</span><br><span class="line">Current `best' version is /usr/share/fonts/simkai.ttf.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示zabbix-web-font目前的字体，应该有上面的字样</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/10/redis使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/10/redis使用/" itemprop="url">
                  redis使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-04-10 10:39:14" itemprop="dateCreated datePublished" datetime="2019-04-10T10:39:14+08:00">2019-04-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-04-26 16:39:06" itemprop="dateModified" datetime="2019-04-26T16:39:06+08:00">2019-04-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="查询redis库中数据的类型"><a href="#查询redis库中数据的类型" class="headerlink" title="查询redis库中数据的类型"></a>查询redis库中数据的类型</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.16.201.120:7000&gt; TYPE recommend_datasource_ghzongyi</span><br><span class="line">list</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用TYPE可以查看数据的类型</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/04/logrotate配置使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/04/logrotate配置使用/" itemprop="url">
                  logrotate配置使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-04-04 10:33:06" itemprop="dateCreated datePublished" datetime="2019-04-04T10:33:06+08:00">2019-04-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-26 10:34:52" itemprop="dateModified" datetime="2019-06-26T10:34:52+08:00">2019-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><blockquote>
<p>logrotate是个十分有用的日志切割工具，它可以自动对日志进行截断（或轮循）、压缩以及删除旧的日志文件。</p>
</blockquote>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@webdav ~]# vim /etc/logrotate.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> see <span class="string">"man logrotate"</span> <span class="keyword">for</span> details</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rotate <span class="built_in">log</span> files weekly  </span></span><br><span class="line">weekly</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每周轮替一次，也就是多久生成一个新的日志文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> keep 4 weeks worth of backlogs</span></span><br><span class="line">rotate 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 保留4个轮替日志 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> create new (empty) <span class="built_in">log</span> files after rotating old ones</span></span><br><span class="line">create</span><br><span class="line"><span class="meta">#</span><span class="bash"> 轮替后创建新的日志文件 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use date as a suffix of the rotated file</span></span><br><span class="line">dateext</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用时间作为轮替文件的后缀 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> uncomment this <span class="keyword">if</span> you want your <span class="built_in">log</span> files compressed</span></span><br><span class="line"><span class="meta">#</span><span class="bash">compress</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果需要压缩日志，去除注释</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RPM packages drop <span class="built_in">log</span> rotation information into this directory</span></span><br><span class="line">include /etc/logrotate.d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 让/etc/logrotate.d目录下面配置文件内容参与轮替 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> no packages own wtmp and btmp -- we<span class="string">'ll rotate them here</span></span></span><br><span class="line">/var/log/wtmp &#123;			# 轮替对象为/var/log/中的wtmp文件 </span><br><span class="line">    monthly			# 每个月轮替一次</span><br><span class="line">    create 0664 root utmp		#创建新的日志文件的权限，所属用户所属组 	</span><br><span class="line">        minsize 1M			# 日志大小大于1M后才能参与轮替</span><br><span class="line">    rotate 1			# 保留一个轮替日志文件 </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/var/log/btmp &#123;</span><br><span class="line">    missingok			#  如果日志文件不存在，继续进行下一个操作，不报错 </span><br><span class="line">    monthly</span><br><span class="line">    create 0600 root utmp</span><br><span class="line">    rotate 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>daily</td>
<td>每天轮替一次</td>
</tr>
<tr>
<td>weekly</td>
<td>每周轮替一次</td>
</tr>
<tr>
<td>monthly</td>
<td>每月轮替一次</td>
</tr>
<tr>
<td>yearly</td>
<td>每年轮替一次</td>
</tr>
<tr>
<td>rotate</td>
<td>保留几个轮替日志文件</td>
</tr>
<tr>
<td>ifempty</td>
<td>不论日志是否空，都进行轮替</td>
</tr>
<tr>
<td>notifempty</td>
<td>若日志为空，则不进行轮替</td>
</tr>
<tr>
<td>create</td>
<td>旧日志文件轮替后创建新的日志文件</td>
</tr>
<tr>
<td>size</td>
<td>日志达到多少后进行rotate</td>
</tr>
<tr>
<td>minsize</td>
<td>文件容量一定要超过多少后才进行rotate</td>
</tr>
<tr>
<td>nocompress</td>
<td>轮替但不进行压缩</td>
</tr>
<tr>
<td>compress</td>
<td>压缩轮替文件</td>
</tr>
<tr>
<td>dateext</td>
<td>轮替旧日志文件时，文件名添加-%Y %m %d形式日期，可用dateformat选项扩展配置。</td>
</tr>
<tr>
<td>nodateext</td>
<td>旧日志文件不使用dateext扩展名，后面序数自增如”*.log.1”</td>
</tr>
<tr>
<td>dateformat</td>
<td>只允许%Y %m %d和%s指定符。注意：系统时钟需要设置到2001-09-09之后，%s才可以正确工作</td>
</tr>
<tr>
<td>sharedscripts</td>
<td>作用域下文件存在至少有一个满足轮替条件的时候，执行一次prerotate脚本和postrotate脚本。</td>
</tr>
<tr>
<td>prerotate/endscript</td>
<td>在轮替之前执行之间的命令，prerotate与endscript成对出现。</td>
</tr>
<tr>
<td>postrotate/endscript</td>
<td>在轮替之后执行之间的命令，postrotate与endscript成对出现。</td>
</tr>
<tr>
<td>olddir</td>
<td>将轮替的文件移至指定目录下</td>
</tr>
<tr>
<td>missingok</td>
<td>如果日志文件不存在，继续进行下一个操作，不报错</td>
</tr>
</tbody>
</table>
<h3 id="切割日志生效时间"><a href="#切割日志生效时间" class="headerlink" title="切割日志生效时间"></a>切割日志生效时间</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@xor-paasjobworker ~]# cat /etc/anacrontab </span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/anacrontab: configuration file <span class="keyword">for</span> anacron</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> See anacron(8) and anacrontab(5) <span class="keyword">for</span> details.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"><span class="meta">#</span><span class="bash"> the maximal random delay added to the base delay of the <span class="built_in">jobs</span></span></span><br><span class="line">RANDOM_DELAY=45   # 随机延迟时间是45分钟</span><br><span class="line"><span class="meta">#</span><span class="bash"> the <span class="built_in">jobs</span> will be started during the following hours only</span></span><br><span class="line">START_HOURS_RANGE=3-22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生效时间范围是3点到22点</span></span><br><span class="line"><span class="meta">#</span><span class="bash">period <span class="keyword">in</span> days   delay <span class="keyword">in</span> minutes   job-identifier   <span class="built_in">command</span></span></span><br><span class="line">1       5       cron.daily              nice run-parts /etc/cron.daily</span><br><span class="line">7       25      cron.weekly             nice run-parts /etc/cron.weekly</span><br><span class="line">@monthly 45     cron.monthly            nice run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@RBO1-POSTER3 ~]# yum install -y logrotate</span><br><span class="line">[root@RBO1-POSTER3 ~]# systemctl start rsyslog</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装好logrotate后要启动rsyslog</span></span><br><span class="line">[root@RBO1-POSTER3 ~]# vim /etc/logrotate.d/nginx</span><br><span class="line">/var/log/nginx/*.log &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义一个对nginx的<span class="built_in">log</span>日志进行切割的脚本，上面是日志的地址，如果有多个路径可以使用空格或换行来分隔</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        daily			<span class="comment"># 这里注释的意义不大，因为如果不配置，也会使用logrotate.conf的默认配置</span></span></span><br><span class="line">        size = 50M			# 50M切割一次</span><br><span class="line">        missingok			# 如果日志文件不存在，继续进行下一个操作，不报错</span><br><span class="line">        rotate 5			# 保留5个日志文件，这并不包括本身的日志文件，只是切割后的日志文件</span><br><span class="line"><span class="meta">#</span><span class="bash">        compress</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        delaycompress</span></span><br><span class="line">        notifempty</span><br><span class="line"><span class="meta">#</span><span class="bash">        create 640 nginx adm</span></span><br><span class="line">        sharedscripts</span><br><span class="line">        postrotate</span><br><span class="line">                if [ -f /var/run/nginx.pid ]; then</span><br><span class="line">                        kill -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">                fi</span><br><span class="line">        endscript</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个脚本的功能应该是先判断nginx.pid文件是否存在，如果存在证明nginx服务启动了，之后让nginx向新的日志文件中写入日志，<span class="built_in">kill</span>发送-USR1信号给nginx的pid。信号的具体作用没弄明白。</span></span><br><span class="line">&#125;</span><br><span class="line">[root@RBO1-POSTER3 ~]# /usr/sbin/logrotate --force /etc/logrotate.d/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是强制执行一次脚本，使用logrotate命令加--force选项，最后指定要执行的脚本。也可以使用短选项-f，再配以-v选项显示详细信息</span></span><br><span class="line">[root@RBO1-POSTER3 ~]# ll /var/log/nginx/</span><br><span class="line">总用量 427804</span><br><span class="line">-rw-r--r--. 1 nginx root  34053285 4月   4 10:47 access.log</span><br><span class="line">-rw-r--r--. 1 nginx root  42083626 4月   4 10:00 access.log.1</span><br><span class="line">-rw-r--r--. 1 nginx root  39990852 4月   4 09:00 access.log.2</span><br><span class="line">-rw-r-----. 1 nginx root 276662461 4月   3 14:21 access.log-20190403</span><br><span class="line">-rw-r--r--. 1 nginx root  26968952 4月   4 08:00 access.log.3</span><br><span class="line">-rw-r--r--. 1 nginx root  12106704 4月   4 07:00 access.log.4</span><br><span class="line">-rw-r--r--. 1 nginx root   3937887 4月   4 06:00 access.log.5</span><br><span class="line">-rw-r--r--. 1 nginx root     14267 4月   4 10:47 error.log</span><br><span class="line">-rw-r--r--. 1 nginx root      5876 4月   4 09:56 error.log.1</span><br><span class="line">-rw-r--r--. 1 nginx root      3470 4月   4 08:45 error.log.2</span><br><span class="line">-rw-r-----. 1 root  root   2184157 4月   3 08:35 error.log-20190403</span><br><span class="line">-rw-r--r--. 1 nginx root      2762 4月   4 07:54 error.log.3</span><br><span class="line">-rw-r--r--. 1 nginx root       338 4月   4 06:51 error.log.4</span><br><span class="line">-rw-r--r--. 1 nginx root       337 4月   4 05:33 error.log.5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 强制执行多次后发现，会有一个以日志命名的日志，这是logrotate脚本正常执行的结果，以数字结尾的日志共有5个，这是强制执行脚本后产生的，还有一个本身的日志。所以强制执行脚本后，也不会按配置文件中定义的只保留5个轮替日志文件，正常产生的轮替日志是不会被删除的。另外，如果需要按小时执行轮替就需要使用crontab定时任务，logrotate最小只支持按天轮替。</span></span><br><span class="line"></span><br><span class="line">[root@RBO1-POSTER3 ~]# crontab -e</span><br><span class="line">*/60 * * * * /usr/sbin/logrotate --force /etc/logrotate.d/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每60分钟执行一次，这与按每小时执行是不一样的。</span></span><br><span class="line"></span><br><span class="line">[root@xor-paasjobadmin ~]# logrotate -d /etc/logrotate.d/nginx </span><br><span class="line">reading config file /etc/logrotate.d/nginx</span><br><span class="line">Allocating hash table for state file, size 15360 B</span><br><span class="line"></span><br><span class="line">Handling 1 logs</span><br><span class="line"></span><br><span class="line">rotating pattern: /xor/data2/log/nginx/*log  after 1 days (30 rotations)</span><br><span class="line">empty log files are not rotated, old logs are removed</span><br><span class="line">considering log /xor/data2/log/nginx/4k_access.log</span><br><span class="line">  log does not need rotating (log has been rotated at 2019-6-20 12:0, that is not day ago yet)</span><br><span class="line">considering log /xor/data2/log/nginx/4k_error.log</span><br><span class="line">  log does not need rotating (log has been rotated at 2019-6-20 12:0, that is not day ago yet)</span><br><span class="line">not running postrotate script, since no logs were rotated</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用‘-d’选项以预演方式运行logrotate。要进行验证，不用实际轮循任何日志文件，可以模拟演练日志轮循并显示其输出。</span></span><br><span class="line"></span><br><span class="line">[root@xor-paasjobadmin ~]# cat /etc/cron.daily/</span><br><span class="line">logrotate    man-db.cron  mlocate      </span><br><span class="line">[root@xor-paasjobadmin ~]# cat /etc/cron.daily/logrotate </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf</span><br><span class="line">EXITVALUE=$?</span><br><span class="line">if [ $EXITVALUE != 0 ]; then</span><br><span class="line">    /usr/bin/logger -t logrotate "ALERT exited abnormally with [$EXITVALUE]"</span><br><span class="line">fi</span><br><span class="line">exit 0</span><br><span class="line"><span class="meta">#</span><span class="bash">  logrotate定时任务。logrotate需要的cron任务应该在安装时就自动创建了</span></span><br></pre></td></tr></table></figure>
<h4 id="在指定时间切割"><a href="#在指定时间切割" class="headerlink" title="在指定时间切割"></a>在指定时间切割</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 日志转储流程</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> crond服务加载/etc/cron.d/0hourly ---&gt;在每小时的01分执行/etc/cron.hourly/0anacron脚本 ---&gt;执行anacron ---&gt;根据/etc/anacrontab的配置执行/etc/cron.daily，/etc/cron.weekly，/etc/cron.monthly ---&gt;执行/etc/cron.daily/下的logrotate脚本 ---&gt;执行logrotate ---&gt;根据/etc/logrotate.conf配置执行脚本/etc/logrotate.d/nginx ---&gt;转储nginx日志成功</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义每天00点00分转储varnish日志</span></span><br><span class="line">---------</span><br><span class="line">  方法一</span><br><span class="line">---------</span><br><span class="line">vim /etc/anacrontab</span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/anacrontab: configuration file <span class="keyword">for</span> anacron</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> See anacron(8) and anacrontab(5) <span class="keyword">for</span> details.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"><span class="meta">#</span><span class="bash"> the maximal random delay added to the base delay of the <span class="built_in">jobs</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">RANDOM_DELAY=45</span></span><br><span class="line">RANDOM_DELAY=0     # 表示延迟为0分钟</span><br><span class="line"><span class="meta">#</span><span class="bash"> the <span class="built_in">jobs</span> will be started during the following hours only</span></span><br><span class="line"><span class="meta">#</span><span class="bash">START_HOURS_RANGE=3-22</span></span><br><span class="line">START_HOURS_RANGE=0-22     # 执行从0点到22点</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">period <span class="keyword">in</span> days   delay <span class="keyword">in</span> minutes   job-identifier   <span class="built_in">command</span></span></span><br><span class="line">1       0       cron.daily              nice run-parts /etc/cron.daily    # 延迟为0分钟</span><br><span class="line">7       25      cron.weekly             nice run-parts /etc/cron.weekly</span><br><span class="line">@monthly 45     cron.monthly            nice run-parts /etc/cron.monthly</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改红字部分</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> period <span class="keyword">in</span> days 是表示1天、7天、1个月执行一次</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> delay <span class="keyword">in</span> minutes 是延迟的分钟数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> nice设置优先级为10，范围为-20（最高优先级）到19（最低优先级）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> run-parts 是一个脚本，表示会执行它后面目录里的脚本</span></span><br><span class="line"></span><br><span class="line">vim /etc/cron.d/0hourly</span><br><span class="line"><span class="meta">#</span><span class="bash"> Run the hourly <span class="built_in">jobs</span></span></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line">00 * * * * root run-parts /etc/cron.hourly</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改红字部分，表示每小时的每0分钟开始执行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种方法会影响到 /etc/cron.daily，/etc/cron.weekly，/etc/cron.monthly 下所有脚本的自动执行时间</span></span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">  方法二</span><br><span class="line">---------</span><br><span class="line">mkdir -p /etc/logrotate.daily.0</span><br><span class="line">mv /etc/logrotate.d/varnish /etc/logrotate.daily.0/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个目录，将varnish的logrotate任务放入，这样此目录中的任务就不受logrotate的配置文件控制了</span></span><br><span class="line">crontab -e</span><br><span class="line">00 00 * * * /usr/sbin/logrotate -f /etc/logrotate.daily.0/varnish &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过定时任务来执行这个logrotate任务。</span></span><br><span class="line">vim /etc/logrotate.daily.0/varnish</span><br><span class="line">/xor/data2/log/varnish/varnishncsa.log &#123;</span><br><span class="line">	daily</span><br><span class="line">	rotate 30</span><br><span class="line">	compress</span><br><span class="line">	delaycompress</span><br><span class="line">	missingok</span><br><span class="line">	postrotate</span><br><span class="line">		/bin/kill -HUP `cat /var/run/varnishncsa.pid /run/varnishncsa/varnishncsa.pid 2&gt;/dev/null` 2&gt; /dev/null || true</span><br><span class="line">	endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/03/NFS配置使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/03/NFS配置使用/" itemprop="url">
                  NFS配置使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-04-03 14:53:41 / 修改時間：17:53:23" itemprop="dateCreated datePublished" datetime="2019-04-03T14:53:41+08:00">2019-04-03</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><blockquote>
<p>ext3、ext2等文件系統工作在內核空間，任何程序只要能夠執行都工作在用戶空間，如mke2fs命令工作在用戶空間，NFS是文件系統，工作在內核空間；內核空間中的程序只有內核自我能夠管理。</p>
<p>向磁盤讀寫數據要通過內核調用也叫函數調用，如read()，write()，函數執行要經過一個過程，所以函數調用又叫過程調用；一般本地應用程序實現某個操作的時候都是通過本地的過程調用來完成的，叫作local procedure call，就是本地的兩個程序或程序與內核之間調用函數完成某種功能的過程；作爲程序員，如果想與某個程序交互，只要某個程序提供函數就可以交互了；</p>
<p>LPC：本地過程調用，local procedure call</p>
<p>RPC：遠程過程調用，Remote procedure call</p>
<p>客戶端與遠程服務器端通過一個RPC客戶端（RPC客戶端叫stub：存根客戶端）與服務器端（運行的是RPC server）聯系，實現數據的讀取，RPC服務器端監聽的套接字是隨機的。linux提供rpc服務的程序叫Portmap，監聽在111/tcp, 111/udp端口。</p>
<p>RPC（框架）是一種編程技術，可以簡化分布式應用程序的開發。从RPC的客戶端向RPC的服務器端發起通信，RPC服務器端再將用戶請求真正轉給客戶端真正請求的服務器端。c –&gt; rpc c –&gt; rpc s –&gt; s</p>
<p>NFS Client →  NFS Server</p>
<p>RPC通信既可基於二進制也可基於文本格式進行數據交換，基於文本格式比較常見的叫XMLRPC，之後又發展出SOAP（Simple Object Access Protocol）簡單對象訪問協議。</p>
<p>RPC是一種協議或編程技術，連接兩臺主機，像一臺主機一樣實現數據交換。</p>
<p>將遠程的設備掛載到本地時，在本地才叫NFS系統。NFS也是一種協議，現在用NFSv3，NFSv4版本，服務器端只能驗證IP不能驗證用戶名</p>
</blockquote>
<h4 id="NFS對服務器來講有兩個組件"><a href="#NFS對服務器來講有兩個組件" class="headerlink" title="NFS對服務器來講有兩個組件"></a>NFS對服務器來講有兩個組件</h4><blockquote>
<p>服務器端：nfs-utils，安裝此軟件包就可配置爲服務器端了。</p>
<p>因爲NFS是基於RPC運行的，所以要確保RPC在linux上的服務portmap已經啓動。portmap是監聽在111/tcp, 111/udp端口的。還可以使用rpcinfo -p來查看一臺主機上的所有rpc進程所監聽的端口號，如：rpcinfo -p localhost，會查到有很多端口監聽，這些是NFS啓動時向RPC請求的端口，nfs會啓動三個進程：nfsd(nfs的主服務)，mountd（接受客戶端掛載請求的）, quotad（限定客戶端在本地只能使用多大磁盤空間的）；nfsd監聽在2049/tcp端口，這是注冊使用的；mountd，quotad會改變端口，是半隨機的端口，是RPC服務幫助選取的，因爲是RPC隨機選取的，所以叫半隨機的端口，可能使用其他服務的端口，所以最好配置一個固定端口給這兩個服務，默認是使用隨機端口。nfslock是分布式文件鎖，當一臺主機在讀取NFS磁盤數據時，要先加鎖，這樣其他主機就不能讀取磁盤數據了，避免磁盤崩潰。NFS配置文件/etc/exports，在此配置文件中定義共享哪個文件系統，哪些可以使用文件系統，讓其可被掛載到本地像使用本地磁盤一樣使用。</p>
</blockquote>
<h4 id="NFS工作流程"><a href="#NFS工作流程" class="headerlink" title="NFS工作流程"></a>NFS工作流程</h4><blockquote>
<p>對於NFSv3來講，客戶端先去聯系服務器上的portmap（RPC服務器），RPC服務器會告訴客戶端rpc.mountd所監聽的端口號，當這個端口號回傳給客戶端以後，客戶端會重新連接rpc.mountd，rpc.mountd返回給用戶一個初始化文件句柄或叫訪問令牌，也就是在配置文件中定義的IP地址訪問時才會發給令牌，這時客戶端來找nfsd，nfsd監聽在2049端口上。這時就能訪問了。</p>
<p>讓mountd和quotad等進程監聽在固定端口，編輯配置文件/etc/sysconfig/nfs，其中有MOUNTD_PORT=<strong><em>一項，定義好端口號即可。QUOTAD_PORT=</em></strong>也一樣。LOCKD_TCPPORT=<strong><em>,  LOCKD_UDPPORT=</em></strong>是啓動鎖進程要監聽的端口。</p>
</blockquote>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@webdav ~]# yum install -y nfs-utils</span><br><span class="line">[root@webdav ~]# netstat -tlnp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1/systemd           </span><br><span class="line">tcp        0      0 0.0.0.0:20048           0.0.0.0:*               LISTEN      97455/rpc.mountd          </span><br><span class="line">tcp        0      0 0.0.0.0:43326           0.0.0.0:*               LISTEN      -                   </span><br><span class="line">tcp        0      0 0.0.0.0:2049            0.0.0.0:*               LISTEN      -                   </span><br><span class="line">tcp        0      0 0.0.0.0:42758           0.0.0.0:*               LISTEN      97452/rpc.statd   </span><br><span class="line">[root@webdav ~]# mkdir /shared</span><br><span class="line">[root@webdav ~]# vim /etc/exports</span><br><span class="line">/shared       192.168.2.0/24(ro) 192.168.1.0/24(rw)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件中每一行包含一個共享出去的文件系統以及哪些客戶端可使用此文件系統；每個客戶端後必須跟一個小括號，小括號中定義了客戶端訪問此文件系統時所具有的屬性</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /path/to/somedir共享哪個目錄，可以是獨立的分區或目錄，建議使用獨立分區，之後是客戶端列表CLIENT_LIST，多個客戶列表之間用空格分隔。每個客戶端後面必須跟一個小括號，裏面定義了此客戶訪問特性，如訪問權限等。如：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 172.16.0.0/16(ro,async) 192.16.0.0/24(rw,sync)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> async異步寫入，sync同步寫入，ro只讀，rw讀寫。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客戶端可以是單個主機用FQDN或IP定義都可以；也可以用通配符，如*.example.com；也可以是IP/netmask的方式</span></span><br><span class="line">[root@webdav ~]# exportfs -r</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此命令重新导出</span></span><br><span class="line">[root@webdav ~]# showmount -e 192.168.2.128</span><br><span class="line">Export list for 192.168.2.128:</span><br><span class="line">192.168.1.0/24,192.168.2.0/24</span><br><span class="line"><span class="meta">#</span><span class="bash"> -e表示顯示共享了哪些目錄，也可以選程主機上使用此命令查看某主機共享了哪些目錄</span></span><br><span class="line"></span><br><span class="line">=================</span><br><span class="line">   debian系统挂载</span><br><span class="line">=================</span><br><span class="line">⚡ root@ruopu64  ~  apt install nfs-common</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 安装包，如果不安装此包，挂载时会提示<span class="string">"mount: /mnt: bad option; for several filesystems (e.g. nfs, cifs) you might need a /sbin/mount.&lt;type&gt; helper program."</span>。</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> 如果debian是服务端，要安装 nfs-kernel-server包</span></span><br><span class="line">⚡ root@ruopu64  ~  mount -t nfs 192.168.2.128:/shared /mnt</span><br><span class="line">⚡ root@ruopu64  ~  df -h</span><br><span class="line">文件系统                      容量  已用  可用 已用% 挂载点</span><br><span class="line">...</span><br><span class="line">192.168.2.128:/shared          17G  1.3G   16G    8% /mnt</span><br></pre></td></tr></table></figure>
<h4 id="showmount命令"><a href="#showmount命令" class="headerlink" title="showmount命令"></a>showmount命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">showmount -e NFS_SERVER</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看NFS服務器“導出”的各文件系統，導出就是共享的意思</span></span><br><span class="line">showmount -a NFS_SERVER</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看NFS服務器所有被掛載的文件系統及其客戶端對應列表</span></span><br><span class="line">showmount -d NFS_SERVER</span><br><span class="line"><span class="meta">#</span><span class="bash"> 顯示NFS服務器所有導出的文件系統中被客戶端掛載了的文件系統列表</span></span><br></pre></td></tr></table></figure>
<h4 id="exportfs命令"><a href="#exportfs命令" class="headerlink" title="exportfs命令"></a>exportfs命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-a：跟-r或-u選項同時使用，表示重新掛載所有文件系統或取消導出所有文件系統</span><br><span class="line">-r：重新導出</span><br><span class="line">-u：取消導出</span><br><span class="line">-v：顯示詳細信息</span><br><span class="line">exportfs -rav：不必重啓服務，重新導出</span><br></pre></td></tr></table></figure>
<h4 id="设置访问权限"><a href="#设置访问权限" class="headerlink" title="设置访问权限"></a>设置访问权限</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">========</span><br><span class="line">   server</span><br><span class="line">========</span><br><span class="line">[root@webdav ~]# useradd hadoop</span><br><span class="line">[root@webdav ~]# id hadoop</span><br><span class="line">uid=1000(hadoop) gid=1000(hadoop) 组=1000(hadoop)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看用户与组ID</span></span><br><span class="line">[root@webdav ~]# setfacl -m u:hadoop:rwx /shared/</span><br><span class="line">[root@webdav ~]# su - hadoop</span><br><span class="line">[hadoop@webdav ~]$ cd /shared/</span><br><span class="line">[hadoop@webdav shared]$ touch a.hadoop</span><br><span class="line">[hadoop@webdav shared]$ ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r-- 1 hadoop hadoop 0 Apr  3 16:24 a.hadoop</span><br><span class="line"></span><br><span class="line">========</span><br><span class="line">   client</span><br><span class="line">========</span><br><span class="line">[root@primary ~]# groupadd -g 1000 openstack</span><br><span class="line">[root@primary ~]# useradd -g 1000 -u 1000 openstack</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建用户与组ID与服务器端一样的用户，只是用户名不同</span></span><br><span class="line">[root@primary ~]# mount -t nfs 192.168.2.128:/shared /mnt</span><br><span class="line">[root@primary ~]# ll /mnt</span><br><span class="line">总用量 0</span><br><span class="line">-rw-rw-r-- 1 openstack openstack 0 4月   3 2019 a.hadoop</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在客户端挂载NFS系统后，因为用户与组ID与服务器端一样，所以用户和组都变成了openstack</span></span><br><span class="line"></span><br><span class="line">========</span><br><span class="line">   server</span><br><span class="line">========</span><br><span class="line">[hadoop@webdav shared]$ exit</span><br><span class="line">logout</span><br><span class="line">[root@webdav ~]# vim /etc/exports</span><br><span class="line">/shared       192.168.2.0/24(rw) 192.168.1.0/24(rw)</span><br><span class="line">[root@webdav ~]# exportfs -ra</span><br><span class="line"></span><br><span class="line">========</span><br><span class="line">   client</span><br><span class="line">========</span><br><span class="line">[root@primary ~]# su - openstack</span><br><span class="line">[openstack@primary ~]$ cd /mnt</span><br><span class="line">[openstack@primary mnt]$ ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r-- 1 openstack openstack 0 Apr  3  2019 a.hadoop</span><br><span class="line">[openstack@primary mnt]$ touch b.openstack</span><br><span class="line">[openstack@primary mnt]$ ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r-- 1 openstack openstack 0 Apr  3  2019 a.hadoop</span><br><span class="line">-rw-rw-r-- 1 openstack openstack 0 Apr  3  2019 b.openstack</span><br><span class="line"></span><br><span class="line">========</span><br><span class="line">   server</span><br><span class="line">========</span><br><span class="line">[root@webdav ~]# ll /shared/</span><br><span class="line">总用量 0</span><br><span class="line">-rw-rw-r-- 1 hadoop hadoop 0 4月   3 16:24 a.hadoop</span><br><span class="line">-rw-rw-r-- 1 hadoop hadoop 0 4月   3 16:41 b.openstack</span><br><span class="line"></span><br><span class="line">========</span><br><span class="line">   client</span><br><span class="line">========</span><br><span class="line">[openstack@primary mnt]$ exit</span><br><span class="line">logout</span><br><span class="line">[root@primary ~]# rm /mnt/b.openstack </span><br><span class="line">rm：是否删除普通空文件 "/mnt/b.openstack"？y</span><br><span class="line">rm: 无法删除"/mnt/b.openstack": 权限不够</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這時是不能刪除的，root用戶是不能操作遠程主機上的文件的。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">========</span><br><span class="line">   server</span><br><span class="line">========</span><br><span class="line">[root@webdav ~]# vim /etc/exports</span><br><span class="line">/shared       192.168.2.0/24(rw,no_root_squash) 192.168.1.0/24(rw)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可用选项如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> no_root_squash：任何主機以root掛載此目錄都將是管理員了，这样root就可以删除远程文件了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> root_squash：將root用戶映射爲來賓賬號，這是默認功能，不加也會執行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> all_squash：無論是誰都轉換爲來賓帳號。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> anonuid, anongid：指定映射的來賓賬號的UID和GID</span></span><br><span class="line">[root@webdav ~]# exportfs -ra</span><br><span class="line"></span><br><span class="line">========</span><br><span class="line">   client</span><br><span class="line">========</span><br><span class="line">[root@primary ~]# umount /mnt</span><br><span class="line">[root@primary ~]# mount -t nfs 192.168.2.128:/shared /mnt</span><br><span class="line">[root@primary ~]# rm -rf /mnt/b.openstack</span><br><span class="line">[root@primary ~]# ll /mnt</span><br><span class="line">总用量 0</span><br><span class="line">-rw-rw-r-- 1 openstack openstack 0 4月   3 2019 a.hadoop</span><br><span class="line"><span class="meta">#</span><span class="bash"> 文件被删除了</span></span><br><span class="line">[root@primary ~]# vim /etc/fstab </span><br><span class="line">192.168.2.128:/shared   /mnt                    nfs     defaults,_rnetdev       0 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> mount的選項中有_rnetdev，表示如果主機不在或無法掛載就跳過</span></span><br><span class="line">[root@primary ~]# umount /mnt</span><br><span class="line">[root@primary ~]# mount -a</span><br><span class="line">[root@primary ~]# df -h</span><br><span class="line">Filesystem            Size  Used Avail Use% Mounted on</span><br><span class="line">192.168.2.128:/shared                       17G  1.3G   16G   8% /mnt</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/02/tmux使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/02/tmux使用/" itemprop="url">
                  tmux使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-04-02 13:47:08 / 修改時間：15:13:06" itemprop="dateCreated datePublished" datetime="2019-04-02T13:47:08+08:00">2019-04-02</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><blockquote>
<p>tmux采用C/S模型构建，输入tmux命令就相当于开启了一个服务器，此时默认将新建一个会话，然后会话中默认新建一个窗口，窗口中默认新建一个面板。会话、窗口、面板之间的联系如下： </p>
<p>一个tmux session（会话）可以包含多个window（窗口），窗口默认充满会话界面，因此这些窗口中可以运行相关性不大的任务。 </p>
<p>一个window又可以包含多个pane（面板），窗口下的面板，都处于同一界面下，这些面板适合运行相关性高的任务，以便同时观察到它们的运行情况。 </p>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">⚡ ⚙ root@ruopu64  ~  apt install tmux</span><br></pre></td></tr></table></figure>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="新建会话"><a href="#新建会话" class="headerlink" title="新建会话"></a>新建会话</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">⚡ root@ruopu64  ~  tmux</span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建会话后，在屏幕的下方会有提示，如：<span class="string">"[0] 0:zsh*        "</span><span class="built_in">test</span><span class="string">" 13:51 02-4月-19"</span></span></span><br><span class="line"> ⚡ root@ruopu64  ~  exit</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 退出会话</span></span><br><span class="line">  ⚡ root@ruopu64  ~  tmux new -s abc</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 创建一个叫做abc的会话，提示信息：<span class="string">"[abc] 0:zsh*      "</span><span class="built_in">test</span><span class="string">" 13:53 02-4月-19"</span></span></span><br></pre></td></tr></table></figure>
<h4 id="断开当前会话"><a href="#断开当前会话" class="headerlink" title="断开当前会话"></a>断开当前会话</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">⚡ root@ruopu64  ~  tmux detach</span><br><span class="line"><span class="meta">#</span><span class="bash"> 断开会话，下次还可继续操作。会话会在后台运行</span></span><br><span class="line">也可以使用快捷键Ctrl + b松开，再按d</span><br></pre></td></tr></table></figure>
<h4 id="进入断开的会话"><a href="#进入断开的会话" class="headerlink" title="进入断开的会话"></a>进入断开的会话</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">✘ ⚡ root@ruopu64  ~  tmux a -t abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入名称为abc的会话</span></span><br><span class="line"> ⚡ root@ruopu64  ~  tmux attach-session</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 进入第一个会话，可以将attach-session简写为a或at</span></span><br></pre></td></tr></table></figure>
<h4 id="查看会话"><a href="#查看会话" class="headerlink" title="查看会话"></a>查看会话</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">⚡ root@ruopu64  ~  tmux list-sessions </span><br><span class="line">1: 1 windows (created Tue Apr  2 13:55:52 2019) [70x21]</span><br><span class="line">2: 1 windows (created Tue Apr  2 13:56:05 2019) [70x21]</span><br><span class="line">abc: 1 windows (created Tue Apr  2 13:52:59 2019) [70x21]</span><br><span class="line"> ⚡ root@ruopu64  ~  tmux ls</span><br><span class="line">1: 1 windows (created Tue Apr  2 13:55:52 2019) [70x21]</span><br><span class="line">2: 1 windows (created Tue Apr  2 13:56:05 2019) [70x21]</span><br><span class="line">abc: 1 windows (created Tue Apr  2 13:52:59 2019) [70x21]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 两条命令是一样的，只是将list-sessions简写为了ls</span></span><br></pre></td></tr></table></figure>
<h4 id="关闭会话"><a href="#关闭会话" class="headerlink" title="关闭会话"></a>关闭会话</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">⚡ root@ruopu64  ~  tmux kill-session -t 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭名称为2的会话</span></span><br><span class="line"> ⚡ root@ruopu64  ~  tmux kill-session </span><br><span class="line"><span class="meta"> #</span><span class="bash"> 关闭所有会话</span></span><br></pre></td></tr></table></figure>
<h4 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h4><blockquote>
<p>快捷键需要使用Ctrl+b激活控制台，再按下面的按键操作</p>
</blockquote>
<h5 id="系统操作"><a href="#系统操作" class="headerlink" title="系统操作"></a>系统操作</h5><table>
<thead>
<tr>
<th>?</th>
<th>列出所有快捷键；按q返回</th>
</tr>
</thead>
<tbody>
<tr>
<td>d</td>
<td>脱离当前会话；这样可以暂时返回Shell界面，输入tmux attach能够重新进入之前的会话</td>
</tr>
<tr>
<td>D</td>
<td>选择要脱离的会话；在同时开启了多个会话时使用</td>
</tr>
<tr>
<td>Ctrl+z</td>
<td>挂起当前会话</td>
</tr>
<tr>
<td>r</td>
<td>强制重绘未脱离的会话</td>
</tr>
<tr>
<td>s</td>
<td>列出所有会话，选择并切换会话；在同时开启了多个会话时使用</td>
</tr>
<tr>
<td>:</td>
<td>进入命令行模式；此时可以输入支持的命令，例如kill-server可以关闭服务器</td>
</tr>
<tr>
<td>[</td>
<td>进入复制模式；此时的操作与vi/emacs相同，按q/Esc退出</td>
</tr>
<tr>
<td>~</td>
<td>列出提示信息缓存；其中包含了之前tmux返回的各种提示信息</td>
</tr>
<tr>
<td>:new&lt;回车&gt;</td>
<td>启动新会话</td>
</tr>
<tr>
<td>$</td>
<td>重命名当前会话</td>
</tr>
</tbody>
</table>
<h5 id="窗口操作"><a href="#窗口操作" class="headerlink" title="窗口操作"></a>窗口操作</h5><table>
<thead>
<tr>
<th>c</th>
<th>创建新窗口</th>
</tr>
</thead>
<tbody>
<tr>
<td>&amp;</td>
<td>关闭当前窗口</td>
</tr>
<tr>
<td>数字键0~9</td>
<td>切换至指定窗口</td>
</tr>
<tr>
<td>p</td>
<td>切换至上一窗口</td>
</tr>
<tr>
<td>n</td>
<td>切换至下一窗口</td>
</tr>
<tr>
<td>l</td>
<td>在前后两个窗口间互相切换</td>
</tr>
<tr>
<td>w</td>
<td>通过窗口列表切换窗口</td>
</tr>
<tr>
<td>,</td>
<td>重命名当前窗口；这样便于识别</td>
</tr>
<tr>
<td>.</td>
<td>修改当前窗口编号；相当于窗口重新排序</td>
</tr>
<tr>
<td>f</td>
<td>在所有窗口中查找指定文本</td>
</tr>
</tbody>
</table>
<h5 id="面板操作"><a href="#面板操作" class="headerlink" title="面板操作"></a>面板操作</h5><table>
<thead>
<tr>
<th>”</th>
<th>将当前面板平分为上下两块</th>
</tr>
</thead>
<tbody>
<tr>
<td>%</td>
<td>将当前面板平分为左右两块</td>
</tr>
<tr>
<td>x</td>
<td>关闭当前面板</td>
</tr>
<tr>
<td>!</td>
<td>将当前面板置于新窗口；即新建一个窗口，其中仅包含当前面板</td>
</tr>
<tr>
<td>Ctrl+方向键</td>
<td>以1个单元格为单位移动边缘以调整当前面板大小</td>
</tr>
<tr>
<td>Alt+方向键</td>
<td>以5个单元格为单位移动边缘以调整当前面板大小</td>
</tr>
<tr>
<td>Space</td>
<td>在预置的面板布局中循环切换；依次包括even-horizontal、even-vertical、main-horizontal、main-vertical、tiled</td>
</tr>
<tr>
<td>q</td>
<td>显示面板编号</td>
</tr>
<tr>
<td>o</td>
<td>在当前窗口中选择下一面板</td>
</tr>
<tr>
<td>方向键</td>
<td>移动光标以选择面板</td>
</tr>
<tr>
<td>{</td>
<td>向前置换当前面板</td>
</tr>
<tr>
<td>}</td>
<td>向后置换当前面板</td>
</tr>
<tr>
<td>Alt+o</td>
<td>逆时针旋转当前窗口的面板</td>
</tr>
<tr>
<td>Ctrl+o</td>
<td>顺时针旋转当前窗口的面板</td>
</tr>
</tbody>
</table>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/29/集群概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/29/集群概念/" itemprop="url">
                  集群概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-03-29 14:44:46 / 修改時間：17:30:10" itemprop="dateCreated datePublished" datetime="2019-03-29T14:44:46+08:00">2019-03-29</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Cluster/" itemprop="url" rel="index"><span itemprop="name">Cluster</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/images/cluster/架构.png" alt=""></p>
<h3 id="消息交换和基础结构层"><a href="#消息交换和基础结构层" class="headerlink" title="消息交换和基础结构层"></a>消息交换和基础结构层</h3><blockquote>
<p>Messaging and Infrastructure Layer：这一层也被称为心跳层，这一层主要包含了如发送心跳信息和集群中各种事务信息 </p>
<p>Membership Layer：也叫CCM层，用来计算整个集群中的节点状态信息的大图景，以及同步这个信息给集群中的所有节点，如集群中有几个节点，可以投几票等信息。还有组织集群拓朴的组件，所以它可以拥有整个集群的全局视图。 </p>
</blockquote>
<h3 id="资源分配层"><a href="#资源分配层" class="headerlink" title="资源分配层"></a>资源分配层</h3><blockquote>
<ul>
<li>CRM：资源分配层所采取的每个动作都是通过CRM来实现的，所以它是基础核心层，在每个节点上，CRM负责生成一个CIB，使每个节点都能了解整个集群的所有配置状态等。CRM会在集群中选举出一个节点当作DC，DC负责维持主CIB文档，所有对CIB的修改都应该通过DC来实现，而后由DC同步给其他节点，对CIB的读写都应该通过主CIB，也就是DC上的CIB，不能修改非DC的CIB，因为非DC的CIB是不会同步的。在一个集群中DC是唯一的，而且能做集群范围的修改操作及其他所有操作都是由DC来做出的。CIB是一个位于内存中的（也会同步到磁盘中），XML格式的，保存了集群每个条目的相关信息，包括集群状态，节点成员关系，定义的资源，及资源的关系等，如果要修改CIB的话可以使用各种客户端工具，如cibadmin这样的命令行工具或heartbeat GUI这样的图形化工具。DC还拥有PE和TE两个组件，一旦DC要做一个集群全局范围的修改，Policy Engine将用于实现计算集群的下一个状态，如当某一个节点离去了，此时位于这个节点上的所有资源应该被转移，之后运行在哪个节点就要由DC来决策，决策后还要修改CIB文档，PE还要将状态变化保存到CIB中，DC所做出的决策，如约束，是否爆头等都是由PE计算得出的，之后由TE负责执行。由TE将PE的决策发放给每个CRM，各CRM收到信息后，将指令发送给LRM，LRM将指令发给RA去执行。RA是脚本，可以执行基本的三个操作，start/stop/monitor </li>
</ul>
</blockquote>
<h4 id="群集资源管理器-CRM"><a href="#群集资源管理器-CRM" class="headerlink" title="群集资源管理器 (CRM)"></a>群集资源管理器 (CRM)</h4><blockquote>
<p>在资源分配层中执行的每个操作都要经过群集资源管理器。如果资源分配层的其他组件（或更高层中的组件）需要通讯，则它们通过本地 CRM 进行。在每个节点上，CRM 都会维护群集信息库 (CIB)</p>
</blockquote>
<h4 id="群集信息库-CIB"><a href="#群集信息库-CIB" class="headerlink" title="群集信息库 (CIB)"></a>群集信息库 (CIB)</h4><blockquote>
<p>群集信息库是整个群集配置和当前状态在内存中的 XML 表示。它包含所有群集选项、节点、资源、约束及其之间的关系的定义。CIB 还将更新同步到所有群集节点。群集中有一个主 CIB，由指定协调器 (DC)进行维护。所有其他节点都包含 CIB 复本。</p>
</blockquote>
<h4 id="指定协调器-DC"><a href="#指定协调器-DC" class="headerlink" title="指定协调器 (DC)"></a>指定协调器 (DC)</h4><blockquote>
<p>群集中的一个 CRM 会被选为 DC。DC 是群集中唯一可以决定需要在整个群集执行更改（例如节点屏蔽或资源移动）的实体。DC 同时也是用于保存 CIB 主副本的节点。所有其他节点都从当前 DC 获取他们的配置和资源分配信息。DC 是在成员资格更改后从群集的所有节点中选出的。</p>
</blockquote>
<h4 id="策略引擎-PE"><a href="#策略引擎-PE" class="headerlink" title="策略引擎 (PE)"></a>策略引擎 (PE)</h4><blockquote>
<p>只要指定协调程序需要进行群集范围的更改（对新 CIB 作出反应），策略引擎就会根据群集的当前状态和配置计算其下一个状态。PE 还生成一个转换图，包含用于达到下一个群集状态的（资源）操作和依赖性的列表。PE 始终在 DC 上运行。</p>
</blockquote>
<h4 id="本地资源管理器-LRM"><a href="#本地资源管理器-LRM" class="headerlink" title="本地资源管理器 (LRM)"></a>本地资源管理器 (LRM)</h4><blockquote>
<p>LRM一般由CRM提供，代表 CRM 调用本地资源代理。因此它可以执行启动/停止/监视操作并将结果报告给 CRM。LRM 是其本地节点上所有资源相关信息的权威来源。</p>
</blockquote>
<h3 id="资源层"><a href="#资源层" class="headerlink" title="资源层"></a>资源层</h3><blockquote>
<p>最高层是资源层。资源层包括一个或多个资源代理 (RA)。资源代理是已写入的用来启动、停止和监视某种服务（资源）的程序（通常是shell脚本）。资源代理仅由 LRM 调用。第三方可将他们自己的代理放在文件系统中定义的位置，这样就为各自的软件提供了现成群集集成。</p>
<p>Resource Layer：这里是一堆脚本ocf格式或lsb格式，建议使用ocf格式 </p>
</blockquote>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><blockquote>
<p>群集最多可包含 32 个 Linux 服务器。如果群集内的一台服务器发生故障，则群集内的任何其他服务器均可重启动此服务器上的资源（应用程序、服务、IP 地址和文件系统）。</p>
<p>集群中应该有奇数个节点，如果是偶数，应该引入仲裁设备，集群中的节点通过心跳信息通告自己的健康状态，而不是探测其他主机，这意味着每个节点上都要运行一个应用程序，这些应用程序在固定的IP地址和端口上工作，通常因为是一对多的通信关系，因此是通过多播的方式向多播域内发送心跳信息和集群事务信息，其他主机看到这个信息就知道这个主机是在线的，这种功能的实现的层次称为message layer，message layer不但能传送心跳，还能传送集群事务信息，比如：如果集群发生分裂的话，失去联系并不具备法定票数的主机会被杀死。这就是集群事务内的决策信息。任何应用要想实现高可用，就要调用message layer提供的多播模式传递心跳信息和集群事务信息完成集群内部资源运行的决策，但不是所有应用都有这种能力，这就需要由CRM集群资源管理器实现，它向上可以为不具备高可用能力的服务提供高可用性，让其可以利用message layer完成高可用。向下，它利用message layer传递过来的各节点的心跳和集群事务信息，形成一个大的决策图景，从而决策都由CRM决定。因为各种资源的启动方式各有不同，为了避免这种麻烦，在CRM之上又加入了一个层次，叫LRM本地资源管理器。本地资源管理器一般都是由集群资源管理器提供的，本地资源不能做出一个资源应该如何启动与关闭，而要借助资源代理RA来实现，这是第四个层次。在每个节点上都有众多的RA，它是帮助启动关闭监控资源的脚本 。</p>
</blockquote>
<h4 id="资源类型"><a href="#资源类型" class="headerlink" title="资源类型"></a>资源类型</h4><blockquote>
<ul>
<li>Primitive：主资源，只能运行于集群内的某单个节点；只能启动一份，也称作native </li>
<li>Group：组资源，这是一个容器类资源，它可以包含一个或多个资源，这些资源可通过“组”这个资源统一进行调度 </li>
<li>Clone：克隆资源，可以在同一个集群内的多个节点运行多份克隆； </li>
<li>Master/slave：主从资源，在同一集群内部于两个节点运行两份资源，其中一个为主一个为从 </li>
</ul>
</blockquote>
<h4 id="资源的约束的关系"><a href="#资源的约束的关系" class="headerlink" title="资源的约束的关系"></a>资源的约束的关系</h4><blockquote>
<ul>
<li>location：位置约束，定义资源对节点的倾向性；用数值表示，从负无穷到正无穷 </li>
<li>colocation：排列约束，定义资源彼此间“在一起”的倾向性；从负无穷到正无穷</li>
<li>分组：也能实现将多个资源绑定在一起；但不能让资源不在一起 </li>
<li>Order：顺序约束，定义资源在同一个节点上启动时的先后顺序； </li>
</ul>
<p>运行在哪个节点，是在资源管理器的接口上进行配置，配置有三：1.这个资源更倾向运行在哪个节点上；2.这个资源更倾向与哪个资源运行在一起，注意：一个资源不能称之为服务，比如构建一个高可用的web集群，需要IP地址，进程，页面文件等，所以高可用服务与高可用资源是两回事。高可用服务可能包括多个高可用资源。一个高可用集群中的高可用资源可能有多个，而且要分类在一起才能构建成一个服务，比如，要启动三个资源，IP在第一个节点上，进程在第二个节点上，页面文件在第三个节点上，这是没用的，因为它们要同进退的。所以哪些资源要运行在一起，不能分开。这叫资源的排列约束。这主要是定义资源在一起的倾向性的。3. 如果多个资源必须运行在同一个节点上，并提供同一个服务工作，那是否有先后次序关系呢？是否要先启动一个再启动一个。比如：是先挂载页面文件还是先启动web进程。这就是次序约束。 </p>
</blockquote>
<blockquote>
<p>参考：</p>
<p><a href="https://www.suse.com/zh-cn/documentation/sle_ha/singlehtml/book_sleha/book_sleha.html#idm140043812445408" target="_blank" rel="noopener">SUSE Linux Enterprise High Availability Extension 11 SP4 高可用性指南</a></p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/29/corosync&pacemaker集群部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/29/corosync&pacemaker集群部署/" itemprop="url">
                  corosync&pacemaker集群部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-03-29 14:16:07" itemprop="dateCreated datePublished" datetime="2019-03-29T14:16:07+08:00">2019-03-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-04-04 10:33:08" itemprop="dateModified" datetime="2019-04-04T10:33:08+08:00">2019-04-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Cluster/" itemprop="url" rel="index"><span itemprop="name">Cluster</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="OpenAIS"><a href="#OpenAIS" class="headerlink" title="OpenAIS"></a>OpenAIS</h4><blockquote>
<p>OpenAIS是基于SA Forum 标准的集群框架的应用程序接口规范。OpenAIS提供一种集群模式，这个模式包括集群框架，集群成员管理，通信方式，集群监测等，能够为集群软件或工具提供满足 AIS标准的集群接口，但是它没有集群资源管理功能，不能独立形成一个集群。OpenAIS组件包括AMF，CLM，CKPT，EVT，LCK，MSG，TMR，CPG，EVS等，因OpenAIS分支不同，组件略有不同。OpenAIS主要包含三个分支：Picacho，Whitetank，Wilson。Wilson是最新的，比较稳定的版本是从openais 1.0.0到openais1.1.4。Whitetank现在是主流分支版本，比较稳定的版本是openais0.80到openais0.86。Picacho第一代的OpenAIS的分支，比较稳定的版本是openais0.70和openais0.71。现在比较常用的是Whitetank和Wilson，两者之间有很多不同。OpenAIS从Whitetank升级到Wilson版本后，组件变化很大，Wilson把Openais核心架构组件独立出来放在Corosync（Corosync是一个集群管理引擎）里面。Whitetank包含的组件有AMF，CLM，CKPT，EVT，LCK ，MSG，CPG，CFG，EVS，aisparser，VSF_ykd，bojdb等。而Wilson只含有AMF，CLM，CKPT，LCK, MSG，EVT，TMR（TMR，Whitetank里面没有），这些都是AIS组件。其他核心组件被放到了Corosync内。Wilson被当做Corosync的一个插件。</p>
</blockquote>
<h4 id="corosync"><a href="#corosync" class="headerlink" title="corosync"></a>corosync</h4><blockquote>
<p>Corosync是OpenAIS发展到Wilson版本后衍生出来的开放性集群引擎工程。可以说Corosync是OpenAIS工程的一部分。OpenAIS从openais0.90开始独立成两部分，一个是Corosync；另一个是AIS标准接口Wilson。Corosync包含OpenAIS的核心框架用来对Wilson的标准接口的使用、管理。它为商用的或开源性的集群提供集群执行框架。Corosync执行高可用应用程序的通信组系统，它有以下特征： </p>
<ul>
<li>一个封闭的程序组（A closed process group communication model）通信模式，这个模式提供一种虚拟的同步方式来保证能够复制服务器的状态。 </li>
<li>一个简单可用性管理组件（A simple availability manager），这个管理组件可以重新启动应用程序的进程当它失败后。 </li>
<li>一个配置和内存数据的统计（A configuration and statistics <a href="http://en.wikipedia.org/wiki/in-memory_database" target="_blank" rel="noopener">in-memory database</a>），内存数据能够被设置，回复，接受通知的更改信息。 </li>
<li>一个定额的系统（A quorum  system），定额完成或者丢失时通知应用程序。 </li>
</ul>
</blockquote>
<h4 id="cman"><a href="#cman" class="headerlink" title="cman"></a>cman</h4><blockquote>
<p>CMAN是红帽RHCS套件的核心部分，CCS是CMAN集群配置系统，配置cluster.conf，而cluster.conf其实就是openais的配置文件，通过CCS映射到openais。 </p>
</blockquote>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><blockquote>
<p>AIS就是一个通用的应用程序编程接口，OpenAIS是AIS的子项目，标准的集群框架的应用程序接口规范，而corosync是OpenAIS是具体实现。</p>
</blockquote>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="基本实现"><a href="#基本实现" class="headerlink" title="基本实现"></a>基本实现</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">===========================================================================================</span><br><span class="line">环境：</span><br><span class="line">准备三台主机，地址：192.168.2.132（primary, node1）、192.168.2.133（secondary, node2）。192.168.2.128（node3）提供NFS服务。</span><br><span class="line">===========================================================================================</span><br><span class="line">----------------</span><br><span class="line">   node1&amp;2</span><br><span class="line">----------------</span><br><span class="line">[root@primary ~]# ntpdate ntp.aliyun.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步时间</span></span><br><span class="line">[root@primary ~]# ssh-keygen -t rsa -P ''</span><br><span class="line">[root@primary ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub 192.168.2.133</span><br><span class="line"><span class="meta">#</span><span class="bash"> 让两节点使用密钥通信</span></span><br><span class="line">[root@primary ~]# yum install -y corosync pacemaker</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装两个包</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node1</span><br><span class="line">-------------</span><br><span class="line">[root@primary ~]# cd /etc/corosync/</span><br><span class="line">[root@primary corosync]# cp corosync.conf.example</span><br><span class="line">corosync.conf.example       corosync.conf.example.udpu  </span><br><span class="line">[root@primary corosync]# cp corosync.conf.example corosync.conf</span><br><span class="line">[root@primary corosync]# vim corosync.conf</span><br><span class="line">compatibility: whitetank</span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否兼容whitetank </span></span><br><span class="line">totem &#123;</span><br><span class="line">	version: 2</span><br><span class="line">	secauth: on</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 是否打开安装认证，不让其他主机加入，打开此功能后需要使用corosync-keygen生成密钥 </span></span><br><span class="line">	threads: 0</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 工作时的线程数，0表示基于进程模式工作</span></span><br><span class="line">	interface &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 定义多个节点之间通过哪个接口，基于哪个多播地址，监听什么端口完成多播通信 </span></span><br><span class="line">		ringnumber: 0</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 环数目，一般为0，类似TTL值 </span></span><br><span class="line">		bindnetaddr: 192.168.2.0</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 这通常是要绑定到的接口的*网络*地址，也就是本机所在的网络。这样可以确保您可以跨所有集群节点使用此配置文件的相同实例，而无需修改此选项。 </span></span><br><span class="line">		mcastaddr: 239.165.134.13</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 多播地址</span></span><br><span class="line">		mcastport: 5405</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 多播监听端口 </span></span><br><span class="line">		ttl: 1</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">logging &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定日志系统</span></span><br><span class="line">	fileline: off</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 是否记录fileline </span></span><br><span class="line">	to_stderr: no</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 是否发往标准错误输出，一般不发送</span></span><br><span class="line">	to_logfile: yes</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 是否记录到日志文件中</span></span><br><span class="line">	logfile: /var/log/cluster/corosync.log</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 日志位置 </span></span><br><span class="line">	to_syslog: no</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 也发往syslog一份，一般记录一份<span class="built_in">log</span>即可，所以这里关闭了此功能 </span></span><br><span class="line">	debug: off</span><br><span class="line">	timestamp: on</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 是否在日志中打开时间戳功能，如果是on，会影响系统性能 </span></span><br><span class="line">	logger_subsys &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 是否记录子系统，记录AMF，这是OpenAIS的子组件</span></span><br><span class="line">		subsys: AMF</span><br><span class="line">		debug: off</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">service &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入此段，以插件形式运行pacemaker</span></span><br><span class="line">	ver: 0</span><br><span class="line">	name: pacemaker</span><br><span class="line">	use_mgmtd: yes</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 此项可有可无 </span></span><br><span class="line">&#125;</span><br><span class="line">aisexec &#123;</span><br><span class="line">	user: root</span><br><span class="line">	group:	root</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 以root用户身份运行，此项可有可无 </span></span><br><span class="line">&#125;</span><br><span class="line">[root@primary corosync]# ip link show</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">2: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:83:af:ca brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看网卡是否支持MULTICAST</span></span><br><span class="line">[root@primary corosync]# corosync-keygen </span><br><span class="line">Corosync Cluster Engine Authentication key generator.</span><br><span class="line">Gathering 1024 bits for key from /dev/random.</span><br><span class="line">Press keys on your keyboard to generate entropy.</span><br><span class="line">Writing corosync key to /etc/corosync/authkey.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从随机数中生成密钥，需要1024个字符，可能不够，如果不够，可以下载大文件产生IO数，使熵池中生成随机数</span></span><br><span class="line">[root@primary corosync]# ll </span><br><span class="line">总用量 32</span><br><span class="line">-rw-r--r-- 1 root root 5384 7月  20 2011 amf.conf.example</span><br><span class="line">-r-------- 1 root root  128 4月   2 15:47 authkey</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成了authkey文件，权限400</span></span><br><span class="line">[root@primary corosync]# scp authkey corosync.conf 192.168.2.133:/etc/corosync/</span><br><span class="line">[root@primary corosync]# service corosync start; ssh 192.168.2.133 'service corosync start'</span><br><span class="line">Starting Corosync Cluster Engine (corosync):               [  OK  ]</span><br><span class="line">Starting Corosync Cluster Engine (corosync): [  OK  ]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动两个节点的corosync服务</span></span><br><span class="line">[root@primary corosync]# ss -tlun</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听了5405多播端口</span></span><br><span class="line">[root@primary corosync]# tail -f /var/log/cluster/corosync.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看日志中是否有报错信息</span></span><br><span class="line">[root@primary corosync]# grep -e "Corosync Cluster Engine" -e "configuration file" /var/log/cluster/corosync.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看两个节点中是否有两条信息，如果有就证明启动成功了</span></span><br><span class="line">[root@primary corosync]# grep TOTEM /var/log/cluster/corosync.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看初始化成员节点通知是否正常发出，应该可以查到内容</span></span><br><span class="line">[root@primary corosync]# grep ERROR: /var/log/cluster/corosync.log | grep –v unpack_resources</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="comment"># 检查启动过程中是否有错误产生，错误信息表示packmaker不久之后将不再作为corosync的插件运行，因此，建议使用cman作为集群基础架构服务，此处可安全忽略。 </span></span></span><br><span class="line">[root@primary corosync]# grep pcmk_startup /var/log/cluster/corosync.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果有信息说明启动完成</span></span><br></pre></td></tr></table></figure>
<h4 id="使用crmsh配置pacemaker"><a href="#使用crmsh配置pacemaker" class="headerlink" title="使用crmsh配置pacemaker"></a>使用crmsh配置pacemaker</h4><blockquote>
<p>crmsh工具在集群中的任一节点上安装均可，不需要每个节点都安装</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@primary corosync]# cd /etc/yum.repos.d/</span><br><span class="line">[root@primary yum.repos.d]# wget http://download.opensuse.org/repositories/network:/ha-clustering:/Stable/CentOS_CentOS-6/network:ha-clustering:Stable.repo</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载opensuse的源，因为crmsh工具是opensuse提供的</span></span><br><span class="line">[root@primary yum.repos.d]# yum install -y crmsh pssh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装，连接速度很慢</span></span><br><span class="line">[root@primary yum.repos.d]# crm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入crm模式</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> status</span></span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 16:03:21 2019</span><br><span class="line">Last change: Tue Apr  2 15:51:08 2019 by hacluster via crmd on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">0 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">No resources</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看状态，也可以直接使用crm status命令。可以看到DC是主机名为primary的节点，Online: [ primary secondary ]表示有两台主机都在线。</span></span><br></pre></td></tr></table></figure>
<h5 id="configure配置集群"><a href="#configure配置集群" class="headerlink" title="configure配置集群"></a>configure配置集群</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@primary ~]# crm </span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> configure</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在子命令中使用此命令，表示配置集群模式 </span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> <span class="built_in">help</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看configure的帮助</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> show</span></span><br><span class="line">node primary</span><br><span class="line">node secondary</span><br><span class="line">property cib-bootstrap-options: \</span><br><span class="line">	have-watchdog=false \</span><br><span class="line">	dc-version=1.1.18-3.el6-bfe4e80420 \</span><br><span class="line">	cluster-infrastructure="classic openais (with plugin)" \</span><br><span class="line">	expected-quorum-votes=2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是configure中的子命令，显示当前集群配置信息，实际配置文件是XML格式的。显示的property表示集群的全局属性，全局属性是配置集群的基本特性的 </span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> show xml</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样就可以看到xml格式的配置文件</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> property </span></span><br><span class="line">batch-limit=                   enable-startup-probes=         node-health-strategy=          stonith-enabled= </span><br><span class="line">cluster-delay=                 have-watchdog=                 node-health-yellow=            stonith-max-attempts= </span><br><span class="line">cluster-ipc-limit=             is-managed-default=            pe-error-series-max=           stonith-timeout= </span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行此命令后，再按两次Tab键，可以看到可以配置的全局属性。stonity-enabled=表示是否必须配置stonith设备，默认为是。</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> property stonith-enabled=</span></span><br><span class="line">stonith-enabled (boolean, [true]): </span><br><span class="line">    Failed nodes are STONITH'd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 按两次Tab键后可以看到默认的值是True </span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> property stonith-enabled=<span class="literal">false</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用stonith</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 校验配置是否有错，如果没错，不会显示任何信息</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> show</span></span><br><span class="line">node primary</span><br><span class="line">node secondary</span><br><span class="line">property cib-bootstrap-options: \</span><br><span class="line">	have-watchdog=false \</span><br><span class="line">	dc-version=1.1.18-3.el6-bfe4e80420 \</span><br><span class="line">	cluster-infrastructure="classic openais (with plugin)" \</span><br><span class="line">	expected-quorum-votes=2 \</span><br><span class="line">	stonith-enabled=false</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再查看，多了stonith-enabled=<span class="literal">false</span>一项</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交，这样才能生效。因为上面的配置都是在内存中完成的。</span></span><br></pre></td></tr></table></figure>
<h5 id="node"><a href="#node" class="headerlink" title="node"></a>node</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> node</span></span><br><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> ls</span></span><br><span class="line">..               help             fence            </span><br><span class="line">show             attribute        back             </span><br><span class="line">cd               ready            status-attr      </span><br><span class="line">quit             end              utilization      </span><br><span class="line">exit             ls               maintenance      </span><br><span class="line">online           bye              ?                </span><br><span class="line">status           clearstate       standby          </span><br><span class="line">list             up               server           </span><br><span class="line">delete           </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看可用的命令</span></span><br><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> show</span></span><br><span class="line">primary: normal</span><br><span class="line">secondary: normal</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示当前在线节点，都是normal状态</span></span><br><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> standby</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 把当前节点设置为备用状态 </span></span><br><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> show</span></span><br><span class="line">primary: normal</span><br><span class="line">	standby=on</span><br><span class="line">secondary: normal</span><br><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> online</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 再让节点上线</span></span><br><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> status</span></span><br><span class="line">&lt;nodes&gt;</span><br><span class="line">  &lt;node id="primary" uname="primary"&gt;</span><br><span class="line">    &lt;instance_attributes id="nodes-primary"&gt;</span><br><span class="line">      &lt;nvpair id="nodes-primary-standby" name="standby" value="off"/&gt;</span><br><span class="line">    &lt;/instance_attributes&gt;</span><br><span class="line">  &lt;/node&gt;</span><br><span class="line">  &lt;node id="secondary" uname="secondary"/&gt;</span><br><span class="line">&lt;/nodes&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前节点信息</span></span><br></pre></td></tr></table></figure>
<h5 id="resource"><a href="#resource" class="headerlink" title="resource"></a>resource</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> resource</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> <span class="built_in">help</span></span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> status</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看资源状态</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> stop resource-name</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止资源</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> start resource-name</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动资源</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> restart resource-name</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启资源</span></span><br></pre></td></tr></table></figure>
<h5 id="ra资源代理"><a href="#ra资源代理" class="headerlink" title="ra资源代理"></a>ra资源代理</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> ra </span></span><br><span class="line"><span class="meta">crm(live)ra#</span><span class="bash"> ls</span></span><br><span class="line">..               info             quit             </span><br><span class="line">end              help             providers        </span><br><span class="line">up               list             cd               </span><br><span class="line">classes          meta             ls               </span><br><span class="line">back             exit             validate         </span><br><span class="line">bye              ?                </span><br><span class="line"><span class="meta">crm(live)ra#</span><span class="bash"> classes</span></span><br><span class="line">lsb</span><br><span class="line">ocf / .isolation heartbeat linbit pacemaker</span><br><span class="line">service</span><br><span class="line">stonith</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示资源代理模式 </span></span><br><span class="line"><span class="meta">crm(live)ra#</span><span class="bash"> list lsb</span></span><br><span class="line">abrt-ccpp                abrt-oops                abrtd                    acpid                    atd</span><br><span class="line">auditd                   autofs                   blk-availability         bmc-snmp-proxy           certmonger</span><br><span class="line">cgconfig                 cgred                    cman                     corosync                 corosync-notifyd</span><br><span class="line">cpuspeed                 crond                    cups                     drbd                     exchange-bmc-os-info</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看lsb中有哪些资源代理可用</span></span><br><span class="line"><span class="meta">crm(live)ra#</span><span class="bash"> list ocf heartbeat</span></span><br><span class="line">CTDB              Delay             Dummy             Filesystem        IPaddr            IPaddr2           IPsrcaddr</span><br><span class="line">LVM               MailTo            Route             SendArp           Squid             VirtualDomain     Xinetd</span><br><span class="line"><span class="meta">crm(live)ra#</span><span class="bash"> list ocf pacemaker</span></span><br><span class="line">ClusterMon    Dummy         HealthCPU     HealthSMART   Stateful      SysInfo       SystemHealth  attribute     ifspeed</span><br><span class="line">ping          pingd         remote  </span><br><span class="line"><span class="meta">crm(live)ra#</span><span class="bash"> list service</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> service与lsb是一样的</span></span><br><span class="line"><span class="meta">crm(live)ra#</span><span class="bash"> list stonith</span></span><br><span class="line"><span class="meta">crm(live)ra#</span><span class="bash"> <span class="built_in">help</span> info</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  info可以查看帮助信息</span></span><br><span class="line"><span class="meta">crm(live)ra#</span><span class="bash"> info ocf:heartbeat:IPaddr</span></span><br></pre></td></tr></table></figure>
<h5 id="配置资源primitive"><a href="#配置资源primitive" class="headerlink" title="配置资源primitive"></a>配置资源primitive</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">-------------</span><br><span class="line">   node1</span><br><span class="line">-------------</span><br><span class="line"><span class="meta">crm(live)ra#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> configure</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> primitive webip ocf:heartbeat:IPaddr params ip=192.168.2.100 nic=eth1 cidr_netmask=24</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> webip是资源名称，ocf:heartbeat:IPaddr是资源代理，params 用来指明参数，IP地址，网卡，掩码。</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> status</span></span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 16:26:40 2019</span><br><span class="line">Last change: Tue Apr  2 16:26:27 2019 by root via cibadmin on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">1 resource configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到webip资源添加到了节点1上</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> <span class="built_in">exit</span></span></span><br><span class="line">bye</span><br><span class="line">[root@primary ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:83:af:ca brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.2.132/24 brd 192.168.2.255 scope global eth1</span><br><span class="line">    inet 192.168.2.100/24 brd 192.168.2.255 scope global secondary eth1</span><br><span class="line">    inet6 fe80::20c:29ff:fe83:afca/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看看到添加了一个IP</span></span><br><span class="line">[root@primary ~]# crm node standby</span><br><span class="line"><span class="meta">#</span><span class="bash"> 要将哪个节点转为备节点，就在哪个节点上执行此命令</span></span><br><span class="line">[root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 16:30:38 2019</span><br><span class="line">Last change: Tue Apr  2 16:30:34 2019 by root via crm_attribute on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">1 resource configured</span><br><span class="line"></span><br><span class="line">Node primary: standby</span><br><span class="line">Online: [ secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started secondary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看状态，online的就只有node2了</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node2</span><br><span class="line">-------------</span><br><span class="line">[root@secondary ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:af:e1:97 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.2.133/24 brd 192.168.2.255 scope global eth1</span><br><span class="line">    inet 192.168.2.100/24 brd 192.168.2.255 scope global secondary eth1</span><br><span class="line">    inet6 fe80::20c:29ff:feaf:e197/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到ip地址转到node2了</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node1</span><br><span class="line">-------------</span><br><span class="line">[root@primary ~]# crm node online</span><br><span class="line"><span class="meta">#</span><span class="bash"> 让节点1上线</span></span><br><span class="line">[root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 16:32:28 2019</span><br><span class="line">Last change: Tue Apr  2 16:32:25 2019 by root via crm_attribute on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">1 resource configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started secondary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 资源没有转回</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node2</span><br><span class="line">-------------</span><br><span class="line">[root@secondary ~]# service corosync stop</span><br><span class="line">Signaling Corosync Cluster Engine (corosync) to terminate: [  OK  ]</span><br><span class="line">Waiting for corosync services to unload:.                  [  OK  ]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停掉节点2的服务，看资源是转到节点1上</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node1</span><br><span class="line">-------------</span><br><span class="line">[root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition WITHOUT quorum</span><br><span class="line">Last updated: Tue Apr  2 16:34:22 2019</span><br><span class="line">Last change: Tue Apr  2 16:32:25 2019 by root via crm_attribute on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">1 resource configured</span><br><span class="line"></span><br><span class="line">Online: [ primary ]</span><br><span class="line">OFFLINE: [ secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Stopped</span><br><span class="line"><span class="meta">#</span><span class="bash"> 看资源是否转移，显示资源没有启动，因为一个服务停止了，所以只有一个节点在线，未超过半数，并且资源默认是关闭的，所以资源未启动 </span></span><br><span class="line">[root@primary ~]# crm configure</span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> property no-quorum-policy=ignore</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置没有法定票数时怎么办，设置为ignore</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> <span class="built_in">exit</span></span></span><br><span class="line">bye</span><br><span class="line">[root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition WITHOUT quorum</span><br><span class="line">Last updated: Tue Apr  2 16:36:29 2019</span><br><span class="line">Last change: Tue Apr  2 16:35:58 2019 by root via cibadmin on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">1 resource configured</span><br><span class="line"></span><br><span class="line">Online: [ primary ]</span><br><span class="line">OFFLINE: [ secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以看到资源启动了</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node2</span><br><span class="line">-------------</span><br><span class="line">[root@secondary ~]# service corosync start</span><br><span class="line">Starting Corosync Cluster Engine (corosync): </span><br><span class="line">                                                           [  OK  ]</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node1</span><br><span class="line">-------------</span><br><span class="line">[root@primary ~]# crm resource</span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> status webip</span></span><br><span class="line">resource webip is running on: primary </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看资源状态，显示资源在primary上</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> migrate webip secondary</span></span><br><span class="line">INFO: Move constraint created for webip to secondary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 转移资源 到secondary上，secondary是主机名</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> status webip</span></span><br><span class="line">resource webip is running on: secondary </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示资源在secondary上</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> stop webip</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止资源 </span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> status webip</span></span><br><span class="line">resource webip is NOT running</span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> start webip</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动资源 </span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> status webip</span></span><br><span class="line">resource webip is running on: secondary </span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> status </span></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看所有资源</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> unmigrate webip</span></span><br><span class="line">INFO: Removed migration constraints for webip</span><br><span class="line"><span class="meta">#</span><span class="bash"> 转回到原来的节点</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> status webip</span></span><br><span class="line">resource webip is running on: secondary </span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为没有倾向性，所以没有转移</span></span><br></pre></td></tr></table></figure>
<h5 id="高可用web"><a href="#高可用web" class="headerlink" title="高可用web"></a>高可用web</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br></pre></td><td class="code"><pre><span class="line">----------------</span><br><span class="line">   node1&amp;2</span><br><span class="line">----------------</span><br><span class="line">[root@primary ~]# yum install -y httpd</span><br><span class="line">[root@primary ~]# vim /var/www/html/index.html</span><br><span class="line">node1:primary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提供网页文件，另一台内容为node2:secondary</span></span><br><span class="line">[root@primary ~]# service httpd start</span><br><span class="line">[root@primary ~]# curl 192.168.2.132</span><br><span class="line">node1:primary</span><br><span class="line">[root@primary ~]# curl 192.168.2.133</span><br><span class="line">node2:secondary</span><br><span class="line">[root@secondary ~]# service httpd stop</span><br><span class="line">[root@secondary ~]# chkconfig httpd off</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为要高可用此资源，所以不可以让服务自动启动</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node1</span><br><span class="line">-------------</span><br><span class="line">[root@primary ~]# crm configure      </span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> primitive webserver lsb:httpd</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加资源</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node2</span><br><span class="line">-------------</span><br><span class="line">[root@secondary ~]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> web服务在节点2上启动了</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node1</span><br><span class="line">-------------</span><br><span class="line">[root@primary ~]# crm resource</span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> show</span></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started</span><br><span class="line"> webserver	(lsb:httpd):	Started</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看资源是启动的</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> stop webserver</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止资源</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> show</span></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started</span><br><span class="line"> webserver	(lsb:httpd):	Stopped (disabled)</span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> start webserver</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 再启动</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> show</span></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started</span><br><span class="line"> webserver	(lsb:httpd):	Started</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时资源还是在节点2上启动</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> node</span></span><br><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> standby secondary</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 让节点2成为备用节点</span></span><br><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> status</span></span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 17:10:10 2019</span><br><span class="line">Last change: Tue Apr  2 17:08:47 2019 by root via crm_attribute on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Node secondary: standby</span><br><span class="line">Online: [ primary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line"> webserver	(lsb:httpd):	Started primary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时两个资源都在节点1上运行了</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> node online secondary</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 让节点2上线</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> status</span></span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 17:11:16 2019</span><br><span class="line">Last change: Tue Apr  2 17:11:08 2019 by root via crm_attribute on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line"> webserver	(lsb:httpd):	Started secondary</span><br><span class="line"><span class="meta"> #</span><span class="bash"> web资源又转移到了节点2上</span></span><br><span class="line"> </span><br><span class="line"> ==========================================================================================</span><br><span class="line"> 使用资源组的方式，让资源在同一个节点运行</span><br><span class="line"> ==========================================================================================</span><br><span class="line"><span class="meta"> crm(live)configure#</span><span class="bash"> group webservice webip webserver</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义一个组叫webservice，组内有两个资源</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> <span class="built_in">exit</span></span></span><br><span class="line">bye</span><br><span class="line">[root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 17:14:15 2019</span><br><span class="line">Last change: Tue Apr  2 17:13:22 2019 by root via cibadmin on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> Resource Group: webservice</span><br><span class="line">     webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line">     webserver	(lsb:httpd):	Started primary</span><br><span class="line"><span class="meta">#</span><span class="bash"> web资源又转移到节点1上了</span></span><br><span class="line">[root@primary ~]# crm configure</span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> edit</span></span><br><span class="line">node primary \</span><br><span class="line">        attributes standby=off</span><br><span class="line">node secondary \</span><br><span class="line">        attributes standby=off</span><br><span class="line">primitive webip IPaddr \</span><br><span class="line">        params ip=192.168.2.100 nic=eth1 cidr_netmask=24 \</span><br><span class="line">        meta target-role=Started</span><br><span class="line">primitive webserver lsb:httpd \</span><br><span class="line">        meta target-role=Started</span><br><span class="line">group webservice webip webserver</span><br><span class="line">property cib-bootstrap-options: \</span><br><span class="line">        have-watchdog=false \</span><br><span class="line">        dc-version=1.1.18-3.el6-bfe4e80420 \</span><br><span class="line">        cluster-infrastructure="classic openais (with plugin)" \</span><br><span class="line">        expected-quorum-votes=2 \</span><br><span class="line">        stonith-enabled=false \</span><br><span class="line">        no-quorum-policy=ignore</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编辑配置文件</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> status</span></span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 17:18:54 2019</span><br><span class="line">Last change: Tue Apr  2 17:18:36 2019 by root via cibadmin on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> Resource Group: webservice</span><br><span class="line">     webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line">     webserver	(lsb:httpd):	Started primary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到两个资源在一个资源组中</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> configure delete webservice</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除资源组，并不会报错，资源组马上被删除了</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> status</span></span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 17:19:12 2019</span><br><span class="line">Last change: Tue Apr  2 17:19:10 2019 by root via cibadmin on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line"> webserver	(lsb:httpd):	Started secondary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 资源组没有了</span></span><br><span class="line">==========================================================================================</span><br><span class="line">定义排列约束，即将资源绑定在一起</span><br><span class="line">==========================================================================================</span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> configure</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> colocation webserver_with_webip inf: webserver webip</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> colocation定义排列约束，webserver_with_webip是自定义名称，inf表示定义分数，冒号后没有东西表示无穷大，这样两个资源就永远在一起了 </span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line">[root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 17:26:39 2019</span><br><span class="line">Last change: Tue Apr  2 17:26:35 2019 by root via cibadmin on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line"> webserver	(lsb:httpd):	Started primary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交后，两个资源就都在节点1上运行了</span></span><br><span class="line">==========================================================================================</span><br><span class="line">定义顺序约束，即资源的启动顺序。定义位置约束，即让资源倾向在哪个节点上运行。</span><br><span class="line">==========================================================================================</span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> order webip_before_webserver Mandatory: webip webserver</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义顺序约束，先启动webip再启动webserver </span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> location webip_on_node2 webip 50: secondary</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义位置约束，让webip资源尽量在节点2上运行 </span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line">[root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 17:51:11 2019</span><br><span class="line">Last change: Tue Apr  2 17:50:50 2019 by root via cibadmin on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started secondary</span><br><span class="line"> webserver	(lsb:httpd):	Started secondary</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 提交后，资源都转到节点2运行了</span></span><br><span class="line"> </span><br><span class="line"><span class="meta"> crm(live)configure#</span><span class="bash"> delete webip_on_node2 </span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> show</span></span><br><span class="line">node primary \</span><br><span class="line">	attributes standby=off</span><br><span class="line">node secondary \</span><br><span class="line">	attributes standby=off</span><br><span class="line">primitive webip IPaddr \</span><br><span class="line">	params ip=192.168.2.100 nic=eth1 cidr_netmask=24 \</span><br><span class="line">	meta target-role=Started</span><br><span class="line">primitive webserver lsb:httpd \</span><br><span class="line">	meta target-role=Started</span><br><span class="line">order webip_before_webserver Mandatory: webip webserver</span><br><span class="line">colocation webserver_with_webip inf: webserver webip</span><br><span class="line">property cib-bootstrap-options: \</span><br><span class="line">	have-watchdog=false \</span><br><span class="line">	dc-version=1.1.18-3.el6-bfe4e80420 \</span><br><span class="line">	cluster-infrastructure="classic openais (with plugin)" \</span><br><span class="line">	expected-quorum-votes=2 \</span><br><span class="line">	stonith-enabled=false \</span><br><span class="line">	no-quorum-policy=ignore</span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> location webip_on_node2 webip rule 50: <span class="comment">#uname eq secondary</span></span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> standby secondary</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 让节点2成为备用节点</span></span><br><span class="line">[root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 17:55:23 2019</span><br><span class="line">Last change: Tue Apr  2 17:55:07 2019 by root via crm_attribute on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Node secondary: standby</span><br><span class="line">Online: [ primary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line"> webserver	(lsb:httpd):	Started primary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时资源会转移到节点1</span></span><br><span class="line"><span class="meta">crm(live)node#</span><span class="bash"> online secondary</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 节点2上线</span></span><br><span class="line">[root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 17:55:38 2019</span><br><span class="line">Last change: Tue Apr  2 17:55:34 2019 by root via crm_attribute on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started secondary</span><br><span class="line"> webserver	(lsb:httpd):	Started secondary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 资源又转回到节点2</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> rsc_defaults resource-stickiness=50</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置资源指黏性值，默认是0。之前的命令property default-resource-stickiness=50 已经不能使用了</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> node standby secondary</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 节点2下线</span></span><br><span class="line">[root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 18:10:12 2019</span><br><span class="line">Last change: Tue Apr  2 18:07:48 2019 by root via crm_attribute on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Node secondary: standby</span><br><span class="line">Online: [ primary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line"> webserver	(lsb:httpd):	Started primary</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 资源到节点1</span></span><br><span class="line"><span class="meta"> crm(live)#</span><span class="bash"> node online secondary</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> 节点2上线</span></span><br><span class="line"> [root@primary ~]# crm status</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 18:11:19 2019</span><br><span class="line">Last change: Tue Apr  2 18:10:41 2019 by root via crm_attribute on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line"> webserver	(lsb:httpd):	Started primary</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 资源不再转移，与设置资源黏性有关</span></span><br><span class="line"> [root@primary ~]# killall httpd</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 停止web服务</span></span><br><span class="line"><span class="meta"> crm(live)#</span><span class="bash"> status</span></span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Tue Apr  2 18:12:49 2019</span><br><span class="line">Last change: Tue Apr  2 18:10:41 2019 by root via crm_attribute on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">2 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line"> webserver	(lsb:httpd):	Started primary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认只高可用节点，资源停掉也不会关心，还是显示资源在节点1上运行</span></span><br><span class="line"></span><br><span class="line">===========================================================================================</span><br><span class="line">配置高可用web资源，设置监控</span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> resource</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> stop webserver</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> stop webip</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止资源</span></span><br><span class="line"><span class="meta">crm(live)resource#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> configure edit</span></span><br><span class="line">node primary \</span><br><span class="line">        attributes standby=off</span><br><span class="line">node secondary \</span><br><span class="line">        attributes standby=off</span><br><span class="line">property cib-bootstrap-options: \</span><br><span class="line">        have-watchdog=false \</span><br><span class="line">        dc-version=1.1.18-3.el6-bfe4e80420 \</span><br><span class="line">        cluster-infrastructure="classic openais (with plugin)" \</span><br><span class="line">        expected-quorum-votes=2 \</span><br><span class="line">        stonith-enabled=false \</span><br><span class="line">        no-quorum-policy=ignore</span><br><span class="line">rsc_defaults rsc-options: \</span><br><span class="line">        resource-stickiness=50</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除上面定义的资源，下面重新定义</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> primitive webip ocf:heartbeat:IPaddr params ip=192.168.2.100 nic=eth1 cidr_netmask=24 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义资源</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> monitor webip 10s:20s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 单独定义monitor，后面是interval和timeout的时间</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> primitive webserver lsb:httpd op monitor interval=10s timeout=20s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以将定义资源与监控在一起定义。一定要用op才能使用monitor命令。monitor表示监控，interval=10s timeout=20s是监控的轮询时间和超时时间，有了监控，就可以在资源停止时进行转移了 </span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> group webservice webip webserver</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line">[root@primary ~]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 现在服务运行在节点1上</span></span><br><span class="line">[root@primary ~]# killall httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止web服务</span></span><br><span class="line">[root@primary ~]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 10秒后，web服务会再次启动</span></span><br><span class="line">[root@primary ~]# yum install -y epel-release</span><br><span class="line">[root@primary ~]# yum install -y nginx</span><br><span class="line">[root@primary ~]# killall httpd</span><br><span class="line">[root@primary ~]# service nginx start</span><br><span class="line">Starting nginx:                                            [  OK  ]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止httpd服务，并启动nginx服务，为了不让httpd服务在节点1启动。看资源是否会转移到节点2上</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node2</span><br><span class="line">-------------</span><br><span class="line">[root@secondary ~]# ss -tln</span><br><span class="line">[root@secondary ~]# ip a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务与地址都转到了节点2上</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node3</span><br><span class="line">-------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此节点提供NFS服务</span></span><br><span class="line">[root@webdav ~]# yum install -y nfs-utils nginx</span><br><span class="line">[root@webdav ~]# systemctl start nfs</span><br><span class="line">[root@webdav ~]# mkdir /shared</span><br><span class="line">[root@webdav ~]# vim /shared/index.html</span><br><span class="line">test page</span><br><span class="line">[root@webdav ~]# vim /etc/exports</span><br><span class="line">/shared       192.168.2.0/24(rw,no_root_squash) 192.168.1.0/24(rw)</span><br><span class="line">[root@webdav ~]# exportfs -ra</span><br><span class="line">[root@webdav ~]# showmount -e 192.168.2.128</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">   node1</span><br><span class="line">-------------</span><br><span class="line">[root@primary ~]# crm configure</span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> primitive webstore ocf:heartbeat:Filesystem params device=<span class="string">"192.168.2.128:/shared"</span> directory=<span class="string">"/var/www/html"</span> fstype=<span class="string">"nfs"</span> op monitor interval=20s timeout=40s op start timeout=60s op stop timeout=60s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义一个存储资源，提供NFS地址与挂载地址、文件系统类型。最后设置监控。</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> edit</span></span><br><span class="line">group webservice webip webserver webstore</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将资源加入组</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">crm(live)configure#</span><span class="bash"> commit</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> status</span></span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: secondary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Wed Apr  3 04:58:49 2019</span><br><span class="line">Last change: Wed Apr  3 04:57:53 2019 by hacluster via cibadmin on secondary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">3 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary ]</span><br><span class="line">OFFLINE: [ secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> Resource Group: webservice</span><br><span class="line">     webip	(ocf::heartbeat:IPaddr):	Started primary</span><br><span class="line">     webserver	(lsb:httpd):	Stopped</span><br><span class="line">     webstore	(ocf::heartbeat:Filesystem):	Stopped</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为实验不是一起做的，提供NFS服务是第二次接着做，所以忘记上一次为什么资源会停止了，新加入的服务也停止了，使用节点上线与启动资源的命令也没有反应。所以下面准备重新启动服务</span></span><br><span class="line">[root@primary ~]# service corosync status</span><br><span class="line">corosync (pid  46159) is running...</span><br><span class="line">[root@primary ~]# kill -9 46159</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为停止服务非常 慢，所以使用<span class="built_in">kill</span>杀死服务，两个节点都重新启动服务</span></span><br><span class="line">[root@primary ~]# service corosync start</span><br><span class="line">[root@primary ~]# crm </span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> status</span></span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: NONE</span><br><span class="line">Last updated: Wed Apr  3 05:02:40 2019</span><br><span class="line">Last change: Wed Apr  3 04:57:53 2019 by hacluster via cibadmin on secondary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">3 resources configured</span><br><span class="line"></span><br><span class="line">OFFLINE: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> Resource Group: webservice</span><br><span class="line">     webip	(ocf::heartbeat:IPaddr):	Stopped</span><br><span class="line">     webserver	(lsb:httpd):	Stopped</span><br><span class="line">     webstore	(ocf::heartbeat:Filesystem):	Stopped</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动服务后，资源还是停止状态</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> resource start webservice</span></span><br><span class="line"><span class="meta">crm(live)#</span><span class="bash"> status</span></span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: primary (version 1.1.18-3.el6-bfe4e80420) - partition with quorum</span><br><span class="line">Last updated: Wed Apr  3 05:03:07 2019</span><br><span class="line">Last change: Wed Apr  3 05:03:03 2019 by root via cibadmin on primary</span><br><span class="line"></span><br><span class="line">2 nodes configured (2 expected votes)</span><br><span class="line">3 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ primary secondary ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> Resource Group: webservice</span><br><span class="line">     webip	(ocf::heartbeat:IPaddr):	Started secondary</span><br><span class="line">     webserver	(lsb:httpd):	Started secondary</span><br><span class="line">     webstore	(ocf::heartbeat:Filesystem):	Started secondary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动资源后正常了</span></span><br><span class="line">访问192.168.2.100，可以看到test page的字样证明成功了。</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止节点2后，资源无法转移，后发现是在节点1上启动了nginx服务，停止nginx服务后仍然无法启动webserver资源。未找到原因，删除webserver资源重新添加后正常。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/29/drbd基本配置使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/29/drbd基本配置使用/" itemprop="url">
                  drbd基本配置使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-03-29 10:57:21 / 修改時間：14:10:56" itemprop="dateCreated datePublished" datetime="2019-03-29T10:57:21+08:00">2019-03-29</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Cluster/" itemprop="url" rel="index"><span itemprop="name">Cluster</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><blockquote>
<p>DRBD即Distributed Relicated Block Device：分布式磁盘块设备， 可以解决磁盘单点故障。一般情况下只支持两个节点。 </p>
<p>一般情况下文件写入磁盘的步骤是：写操作 –&gt; 文件系统 –&gt; 内存缓存中 –&gt; 磁盘调度器 –&gt; 磁盘驱动器 –&gt; 写入磁盘。而DRBD的工作机制如上图所示，数据经过buffer cache后有内核中的DRBD模块通过tcp/ip协议栈经过网卡和对方建立数据同步。 </p>
</blockquote>
<p><img src="/images/drbd/工作流程.png" alt=""></p>
<h4 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h4><blockquote>
<ol>
<li><p>主从模型</p>
<p>master/slave模型，在某一时刻只允许有一个主节点。主节点的作用是可以挂载使用，写入数据等；从节点只作为主节点的镜像，是主节点的备份。 </p>
</li>
<li><p>主主模型</p>
<p>dula primary模型，2个节点都可以当做主节点来挂载使用。需要配合集群文件系统使用，通过分布式文件锁管理器避免同时写一个文件造成文件系统损坏的问题。</p>
</li>
</ol>
</blockquote>
<h4 id="复制模型"><a href="#复制模型" class="headerlink" title="复制模型"></a>复制模型</h4><blockquote>
<ol>
<li>A协议：异步复制（asynchronous），写操作到本机网卡时即认为成功，性能好，数据可靠性差。 </li>
<li>B协议：半同步复制（semi sync），写操作到达备节点网卡即认为成功，数据可靠性介于A和C之间。 </li>
<li>C协议：同步复制（ sync），备用节点写入磁盘即认为成功，性能差，数据可靠性高。也是drbd默认使用的复制协议 </li>
</ol>
</blockquote>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">===========================================================================================</span><br><span class="line">环境：</span><br><span class="line">主机两台，操作系统CentOS6.6，内核2.6.32-504.el6.x86_64。地址：192.168.2.132、192.168.2.133</span><br><span class="line">安装与配置在两个节点上是一样的</span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash"> 两台主机均按如下方法操作</span></span><br><span class="line">[root@primary drbd]# rpm -ivh drbd84-utils-8.9.2-1.el6.elrepo.x86_64.rpm kmod-drbd84-8.4.6-1.el6.elrepo.x86_64.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装包取自生产环境。drbd84-utils-8.9.1-1.el6.elrepo包提供配置文件与工具，komd-drbd84-8.4.6-504.el6.x86_64.rpm包提供内核模块。注意两个包要一起安装，不然可能不会添加设备</span></span><br><span class="line">[root@template ~]# ls /dev/d</span><br><span class="line">disk/   dm-1    drbd1   drbd11  drbd13  drbd15  drbd3   drbd5   drbd7   drbd9   dvdrw   </span><br><span class="line">dm-0    drbd0   drbd10  drbd12  drbd14  drbd2   drbd4   drbd6   drbd8   dvd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装软件后可以看到添加了很多以drbd开头的设备</span></span><br><span class="line">[root@primary ~]# fdisk /dev/sdb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在两个分区上提供大小一致的分区</span></span><br><span class="line">[root@primary ~]# ntpdate ntp1.aliyun.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步时间</span></span><br><span class="line">[root@primary ~]# partprobe /dev/sdb</span><br><span class="line">[root@primary drbd]# vim /etc/sysconfig/network</span><br><span class="line">NETWORKING=yes</span><br><span class="line">HOSTNAME=primary</span><br><span class="line">[root@primary drbd]# hostname primary</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改主机名</span></span><br><span class="line">[root@primary drbd]# ssh-keygen -t rsa -P ''</span><br><span class="line">[root@primary drbd]# ssh-copy-id -i ~/.ssh/id_rsa.pub 192.168.2.133</span><br><span class="line"><span class="meta">#</span><span class="bash"> 密钥通信</span></span><br><span class="line">[root@primary drbd]# vim /etc/hosts</span><br><span class="line">192.168.2.132 primary</span><br><span class="line">192.168.2.133 secondary</span><br><span class="line">[root@primary drbd]# scp drbd84-utils-8.9.2-1.el6.elrepo.x86_64.rpm kmod-drbd84-8.4.6-1.el6.elrepo.x86_64.rpm secondary:/root</span><br></pre></td></tr></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">[root@primary ~]# cd /etc/drbd.d</span><br><span class="line">[root@primary drbd.d]# vim global_common.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此配置文件提供全局配置，及多个drbd设备相同的配置 </span></span><br><span class="line">global &#123;</span><br><span class="line">	usage-count no;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 是否加入改进计划 </span></span><br><span class="line">&#125;</span><br><span class="line">common &#123;</span><br><span class="line">	handlers &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	startup &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	options &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	disk &#123;</span><br><span class="line">		on-io-error detach;</span><br><span class="line"><span class="meta">		#</span><span class="bash"> IO出问题时，就将节点卸载 </span></span><br><span class="line">	&#125;</span><br><span class="line">	net &#123;</span><br><span class="line">		cram-hmac-alg "sha1";</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 使用的算法 </span></span><br><span class="line">		shared-secret "mydrbdshared123";</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 共享密钥，建议用随机数生成 </span></span><br><span class="line">	&#125;</span><br><span class="line">	syncer &#123;</span><br><span class="line">		rate 500M;</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 同步速率</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> glocal：全局属性，定义drbd自己的工作特性。common：通用属性，定义多组drbd设备通用特性 </span></span><br><span class="line"></span><br><span class="line">[root@primary drbd.d]# vim mystore.res</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此文件为自建文件</span></span><br><span class="line">resource mystore &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 首先定义公共配置，这一段可以被下面的多段使用 </span></span><br><span class="line">    device /dev/drdb0;</span><br><span class="line">    # 定义设备</span><br><span class="line">    disk /dev/sdb1;</span><br><span class="line">    # 定义磁盘，定义这两项就让磁盘与设备关联了？</span><br><span class="line">    meta-disk internal;</span><br><span class="line">     # 在自己的dev内部构建使用</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面定义单个节点的属性 </span></span><br><span class="line">    on primary &#123;</span><br><span class="line">        address 192.168.2.132:7789;</span><br><span class="line">    &#125;</span><br><span class="line">    on secondary &#123;</span><br><span class="line">        address 192.168.2.132:7789;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@primary drbd.d]# drbdadm create-md mystore</span><br><span class="line">initializing activity log</span><br><span class="line">NOT initializing bitmap</span><br><span class="line">Writing meta data...</span><br><span class="line">New drbd meta data block successfully created.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化资源，mystore是资源名，是在mystore.res文件中定义的。在两个节点上分别执行 </span></span><br><span class="line">[root@primary drbd.d]# drbdadm create-md mystore</span><br><span class="line">initializing activity log</span><br><span class="line">NOT initializing bitmap</span><br><span class="line">Writing meta data...</span><br><span class="line">New drbd meta data block successfully created.</span><br><span class="line">[root@primary drbd.d]# service drbd start</span><br><span class="line">Starting DRBD resources: [</span><br><span class="line">     create res: mystore</span><br><span class="line">   prepare disk: mystore</span><br><span class="line">    adjust disk: mystore</span><br><span class="line">     adjust net: mystore</span><br><span class="line">]</span><br><span class="line">....</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动一个节点后，它会等待另一个节点也启动此服务，这时两个节点才会一起启动服务</span></span><br><span class="line">[root@primary drbd.d]# cat /proc/drbd</span><br><span class="line">version: 8.4.6 (api:1/proto:86-101)</span><br><span class="line">GIT-hash: 833d830e0152d1e457fa7856e71e11248ccf3f70 build by phil@Build64R6, 2015-04-09 14:35:00</span><br><span class="line"> 0: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----</span><br><span class="line">    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:3140544</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看运行状态，现在两个都是Secondary，没有同步 </span></span><br><span class="line">[root@primary drbd.d]# drbd-overview </span><br><span class="line"> 0:mystore/0  Connected Secondary/Secondary Inconsistent/Inconsistent </span><br><span class="line"><span class="meta"> #</span><span class="bash"> 使用此命令也可以</span></span><br><span class="line"> [root@primary drbd.d]# drbdadm primary --force mystore</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 设置节点1为主节点</span></span><br><span class="line"> [root@primary drbd.d]# cat /proc/drbd </span><br><span class="line">version: 8.4.6 (api:1/proto:86-101)</span><br><span class="line">GIT-hash: 833d830e0152d1e457fa7856e71e11248ccf3f70 build by phil@Build64R6, 2015-04-09 14:35:00</span><br><span class="line"> 0: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----</span><br><span class="line">    ns:1067676 nr:0 dw:0 dr:1069720 al:0 bm:0 lo:0 pe:2 ua:2 ap:0 ep:1 wo:f oos:2074560</span><br><span class="line">	[=====&gt;..............] sync'ed: 34.1% (2074560/3140544)K</span><br><span class="line">	finish: 0:00:52 speed: 39,708 (39,480) K/sec</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 显示同步过程，有两种状态，primary和secondary，主和从，左边为自己的状态右边是对方的状态 </span></span><br><span class="line">[root@primary drbd.d]# cat /proc/drbd </span><br><span class="line">version: 8.4.6 (api:1/proto:86-101)</span><br><span class="line">GIT-hash: 833d830e0152d1e457fa7856e71e11248ccf3f70 build by phil@Build64R6, 2015-04-09 14:35:00</span><br><span class="line"> 0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:3140544 nr:0 dw:0 dr:3141208 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步完成，这是状态为Primary/Secondary </span></span><br><span class="line">[root@primary drbd.d]# mke2fs -t ext4 /dev/drbd0</span><br><span class="line">mke2fs 1.41.12 (17-May-2010)</span><br><span class="line">文件系统标签=</span><br><span class="line">操作系统:Linux</span><br><span class="line">块大小=4096 (log=2)</span><br><span class="line">分块大小=4096 (log=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">196608 inodes, 785136 blocks</span><br><span class="line">39256 blocks (5.00%) reserved for the super user</span><br><span class="line">第一个数据块=0</span><br><span class="line">Maximum filesystem blocks=805306368</span><br><span class="line">24 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">8192 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">	32768, 98304, 163840, 229376, 294912</span><br><span class="line"></span><br><span class="line">正在写入inode表: 完成                            </span><br><span class="line">Creating journal (16384 blocks): 完成</span><br><span class="line">Writing superblocks and filesystem accounting information: 完成</span><br><span class="line"></span><br><span class="line">This filesystem will be automatically checked every 26 mounts or</span><br><span class="line">180 days, whichever comes first.  Use tune2fs -c or -i to override.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在主节点格式化磁盘，从节点也会自动格式化，因为是按位同步的</span></span><br></pre></td></tr></table></figure>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">=========</span><br><span class="line">    node1   </span><br><span class="line">=========</span><br><span class="line">[root@primary drbd.d]# mount /dev/drbd0 /mnt</span><br><span class="line">[root@primary drbd.d]# ls /mnt</span><br><span class="line">lost+found</span><br><span class="line">[root@primary drbd.d]# cd /mnt</span><br><span class="line">[root@primary mnt]# cp /etc/issue ./</span><br><span class="line">[root@primary mnt]# ls</span><br><span class="line">issue  lost+found</span><br><span class="line">[root@primary mnt]# cd</span><br><span class="line">[root@primary ~]# umount /mnt</span><br><span class="line">[root@primary ~]# drbdadm secondary mystore</span><br><span class="line"><span class="meta">#</span><span class="bash"> 把自己切换为从节点</span></span><br><span class="line">[root@primary ~]# cat /proc/drbd</span><br><span class="line">version: 8.4.6 (api:1/proto:86-101)</span><br><span class="line">GIT-hash: 833d830e0152d1e457fa7856e71e11248ccf3f70 build by phil@Build64R6, 2015-04-09 14:35:00</span><br><span class="line"> 0: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:3256316 nr:0 dw:115772 dr:3141925 al:31 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 状态都是从节点</span></span><br><span class="line"></span><br><span class="line">=========</span><br><span class="line">    node2    </span><br><span class="line">=========</span><br><span class="line">[root@secondary drbd.d]# drbdadm primary mystore</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在哪个节点执行此命令就是切换哪个节点的状态，这里将备用节点切换为主节点</span></span><br><span class="line">[root@secondary drbd.d]# cat /proc/drbd</span><br><span class="line">version: 8.4.6 (api:1/proto:86-101)</span><br><span class="line">GIT-hash: 833d830e0152d1e457fa7856e71e11248ccf3f70 build by phil@Build64R6, 2015-04-09 14:35:00</span><br><span class="line"> 0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:0 nr:3256316 dw:3256316 dr:664 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line">[root@secondary drbd.d]# mount /dev/drbd0 /mnt</span><br><span class="line">[root@secondary drbd.d]# ls /mnt</span><br><span class="line">issue  lost+found</span><br><span class="line">[root@secondary drbd.d]# vim /mnt/issue</span><br><span class="line">abcabc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入一些内容</span></span><br><span class="line">[root@secondary drbd.d]# umount /mnt</span><br><span class="line">[root@secondary drbd.d]# drbdadm secondary mystore</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要切换状态，备用状态是不能被挂载</span></span><br><span class="line"></span><br><span class="line">=========</span><br><span class="line">    node1   </span><br><span class="line">=========</span><br><span class="line">[root@primary ~]# mount /dev/drbd0 /mnt</span><br><span class="line">mount: you must specify the filesystem type</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备用状态是不能被挂载的</span></span><br><span class="line">[root@primary ~]# drbdadm primary mystore</span><br><span class="line">[root@primary ~]# mount /dev/drbd0 /mnt</span><br><span class="line">[root@primary ~]# cat /mnt/issue </span><br><span class="line">CentOS release 6.6 (Final)</span><br><span class="line">Kernel \r on an \m</span><br><span class="line"></span><br><span class="line">abcabc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内容也被改变了</span></span><br><span class="line">[root@primary ~]# service drbd status</span><br><span class="line">drbd driver loaded OK; device status:</span><br><span class="line">version: 8.4.6 (api:1/proto:86-101)</span><br><span class="line">GIT-hash: 833d830e0152d1e457fa7856e71e11248ccf3f70 build by phil@Build64R6, 2015-04-09 14:35:00</span><br><span class="line">m:res      cs         ro                 ds                 p  mounted  fstype</span><br><span class="line">0:mystore  Connected  Primary/Secondary  UpToDate/UpToDate  C  /mnt     ext4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看状态，UpToDate/UpToDate 表示已经同步</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/26/python基础学习-语句/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/26/python基础学习-语句/" itemprop="url">
                  python基础学习-语句
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-03-26 16:34:05" itemprop="dateCreated datePublished" datetime="2019-03-26T16:34:05+08:00">2019-03-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-09-23 11:34:30" itemprop="dateModified" datetime="2019-09-23T11:34:30+08:00">2019-09-23</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="print"><a href="#print" class="headerlink" title="print"></a>print</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">'Age:'</span>, <span class="number">42</span>)</span><br><span class="line">Age: <span class="number">42</span></span><br><span class="line"><span class="comment"># 可同时打印多个表达式，条件是用逗号分隔它们</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>name = <span class="string">'Gumby'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>salutation = <span class="string">'Mr.'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>greeting = <span class="string">'Hello,'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(greeting, salutation, name)</span><br><span class="line">Hello, Mr. Gumby</span><br><span class="line"></span><br><span class="line">print(greeting + <span class="string">','</span>, salutation, name)</span><br><span class="line"><span class="comment"># 如果字符串变量greeting不包含逗号，可使用此方法添加，记得一定要有加号，不然会在greeting与逗号间加入一个空格</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">"I"</span>, <span class="string">"wish"</span>, <span class="string">"to"</span>, <span class="string">"register"</span>, <span class="string">"a"</span>, <span class="string">"complaint"</span>, sep=<span class="string">"_"</span>)</span><br><span class="line">I_wish_to_register_a_complaint</span><br><span class="line"><span class="comment"># 自定义分隔符</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'Hello,'</span>, end=<span class="string">''</span>)</span><br><span class="line">print(<span class="string">'world!'</span>)</span><br><span class="line">Hello,world!</span><br><span class="line"><span class="comment"># 还可自定义结束字符串，以替换默认的换行符。上面将结束字符串指定为空字符串，所以Hello和world会打印在一行。</span></span><br></pre></td></tr></table></figure>
<h3 id="import"><a href="#import" class="headerlink" title="import"></a>import</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> somemodule</span><br><span class="line"><span class="keyword">from</span> somemodule <span class="keyword">import</span> somefunction</span><br><span class="line"><span class="keyword">from</span> somemodule <span class="keyword">import</span> somefunction, anotherfunction, yetanotherfunction</span><br><span class="line"><span class="keyword">from</span> somemodule <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># 从模块导入。仅当你确定要导入模块中的一切时，采用使用最后一种方式</span></span><br><span class="line"></span><br><span class="line">module1.open(...)</span><br><span class="line">module2.open(...)</span><br><span class="line"><span class="comment"># 有两个模块，它们都包含函数open，可使用第一种方式导入这两个模块，使用此种方式调用open函数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> math <span class="keyword">as</span> foobar</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>foobar.sqrt(<span class="number">4</span>)</span><br><span class="line"><span class="number">2.0</span></span><br><span class="line"><span class="comment"># 导入整个模块并在语句末尾添加as子句指定别名。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> math <span class="keyword">import</span> sqrt <span class="keyword">as</span> foobar</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>foobar(<span class="number">4</span>)</span><br><span class="line"><span class="number">2.0</span></span><br><span class="line"><span class="comment"># 导入特定函数并给它指定别名，这是给sqrt起的别名叫foobar</span></span><br></pre></td></tr></table></figure>
<h3 id="赋值"><a href="#赋值" class="headerlink" title="赋值"></a>赋值</h3><h4 id="序列解包"><a href="#序列解包" class="headerlink" title="序列解包"></a>序列解包</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x, y, z = <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(x, y, z)</span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">3</span></span><br><span class="line"><span class="comment"># 同时(并行)给多个变量赋值</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x, y = y, x</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(x, y, z)</span><br><span class="line"><span class="number">2</span> <span class="number">1</span> <span class="number">3</span></span><br><span class="line"><span class="comment"># 这种方式还可交换多个变量的值</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>values = <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>values</span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x, y, z = values</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="comment"># 这里执行的操作称为序列解包(或可迭代对象解包)：将一个序列(或任何可迭代对象)解包，并将得到的值存储到一系列变量中。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>scoundrel = &#123;<span class="string">'name'</span>: <span class="string">'Robin'</span>, <span class="string">'girlfriend'</span>: <span class="string">'Marion'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>key, value = scoundrel.popitem()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>key</span><br><span class="line"><span class="string">'girlfriend'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>value</span><br><span class="line"><span class="string">'Marion'</span></span><br><span class="line"><span class="comment"># 从字典中随便获取(或删除)一个键值对，可使用方法popitem，它随便获取一个键值对并以元组的方式返回。接下来，可直接将返回的元组解包到两个变量中。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x, y, z = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">ValueError: need more than <span class="number">2</span> values to unpack</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x, y, z = <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">ValueError: too many values to unpack</span><br><span class="line"><span class="comment"># 要解包的序列包含的元素个数必须与你在等号左边列出的目标个数相同</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a, b, *rest = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rest</span><br><span class="line">[<span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="comment"># 可使用星号运算符(*)来收集多余的值，这样无需确保值和变量的个数相同</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>name = <span class="string">"Albus Percival Wulfric Brian Dumbledore"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>first, *middle, last = name.split()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>middle</span><br><span class="line">[<span class="string">'Percival'</span>, <span class="string">'Wulfric'</span>, <span class="string">'Brian'</span>]</span><br><span class="line"><span class="comment"># 还可将带星号的变量放在其他位置。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a, *b, c = <span class="string">"abc"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a, b, c</span><br><span class="line">(<span class="string">'a'</span>, [<span class="string">'b'</span>], <span class="string">'c'</span>)</span><br><span class="line"><span class="comment"># 赋值语句的右边可以是任何类型的序列，但带星号的变量最终包含的总是一个列表。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/26/python基础学习-字典/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/26/python基础学习-字典/" itemprop="url">
                  python基础学习-字典
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-03-26 09:36:23 / 修改時間：16:30:36" itemprop="dateCreated datePublished" datetime="2019-03-26T09:36:23+08:00">2019-03-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><blockquote>
<p>映射(mapping)是一种可通过名称来访问其各个值的数据结构。字典是Python中唯一的内置映射类型，其中的值不按顺序排列，而是存储在键下。键可能是数、字符串或元组。</p>
<p>字典(日常生活中的字典和Python字典)旨在让你能够轻松地找到特定的单词(键)，以获悉其定义(值) 。</p>
<p>Python字典的用途：</p>
<ul>
<li>表示棋盘的状态，其中每个键都是由坐标组成的元组；</li>
<li>存储文件修改时间，其中的键为文件名；</li>
<li>数字电话/地址簿。</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>names = [<span class="string">'Alice'</span>, <span class="string">'Beth'</span>, <span class="string">'Cecil'</span>, <span class="string">'Dee-Dee'</span>, <span class="string">'Earl'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>numbers = [<span class="string">'2341'</span>, <span class="string">'9102'</span>, <span class="string">'3158'</span>, <span class="string">'0142'</span>, <span class="string">'5551'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>numbers[names.index(<span class="string">'Cecil'</span>)]</span><br><span class="line"><span class="string">'3158'</span></span><br><span class="line"><span class="comment"># 这可行，但不太实用。</span></span><br></pre></td></tr></table></figure>
<h3 id="创建与使用"><a href="#创建与使用" class="headerlink" title="创建与使用"></a>创建与使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">phonebook = &#123;<span class="string">'Alice'</span>: <span class="string">'2341'</span>, <span class="string">'Beth'</span>: <span class="string">'9102'</span>, <span class="string">'Cecil'</span>: <span class="string">'3258'</span>&#125;</span><br><span class="line"><span class="comment"># 字典由键及其相应的值组成，这种键值对称为项(item)。这里键为名字，而值为电话号码。每个键与其值之间都用冒号(:)分隔，项之间用逗号分隔，而整个字典放在花括号内。空字典(没有任何项)用两个花括号表示。</span></span><br><span class="line"><span class="comment">#  在字典(以及其他映射类型)中，键必须是独一无二的，而字典中的值无需如此。</span></span><br></pre></td></tr></table></figure>
<h4 id="dict函数（创建字典）"><a href="#dict函数（创建字典）" class="headerlink" title="dict函数（创建字典）"></a>dict函数（创建字典）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>items = [(<span class="string">'name'</span>, <span class="string">'Gumby'</span>), (<span class="string">'age'</span>, <span class="number">42</span>)]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = dict(items)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">'age'</span>: <span class="number">42</span>, <span class="string">'name'</span>: <span class="string">'Gumby'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'name'</span>]</span><br><span class="line"><span class="string">'Gumby'</span></span><br><span class="line"><span class="comment"># 使用函数dict从其他映射(如其他字典)或键值对序列创建字典。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = dict(name=<span class="string">'Gumby'</span>, age=<span class="number">42</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">'age'</span>: <span class="number">42</span>, <span class="string">'name'</span>: <span class="string">'Gumby'</span>&#125;</span><br><span class="line"><span class="comment"># 使用关键字实参来调用这个函数</span></span><br><span class="line"><span class="comment"># 也可使用一个映射实参来调用它，这将创建一个字典，其中包含指定映射中的所有项。像函数list、tuple和 str 一样，如果调用这个函数时没有提供任何实参，将返回一个空字典。从映射创建字典时，如果该映射也是字典(毕竟字典是Python中唯一的内置映射类型)，可不使用函数dict，而是使用字典方法copy</span></span><br><span class="line"><span class="comment"># 与list、tuple和str一样，dict其实根本就不是函数，而是一个类。</span></span><br></pre></td></tr></table></figure>
<h4 id="基本的字典操作"><a href="#基本的字典操作" class="headerlink" title="基本的字典操作"></a>基本的字典操作</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">len(d)</span><br><span class="line"><span class="comment"># 返回字典d 包含的项(键值对)数。</span></span><br><span class="line">d[k]</span><br><span class="line"><span class="comment"># 返回与键k相关联的值。</span></span><br><span class="line">d[k] = v</span><br><span class="line"><span class="comment"># 将值v关联到键k。</span></span><br><span class="line"><span class="keyword">del</span> d[k]</span><br><span class="line"><span class="comment"># 删除键为k的项。</span></span><br><span class="line">k <span class="keyword">in</span> d</span><br><span class="line"><span class="comment"># 检查字典d 是否包含键为k的项。</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>键的类型：字典中的键可以是整数，但并非必须是整数。字典中的键可以是任何不可变的类型，如浮点数(实数) 、字符串或元组。</li>
<li>自动添加：即便是字典中原本没有的键，也可以给它赋值，这将在字典中创建一个新项。然而，如果不使用append或其他类似的方法，就不能给列表中没有的元素赋值。</li>
<li>成员资格：表达式k in d(其中d 是一个字典)查找的是键而不是值，而表达式v in l(其中l是一个列表)查找的是值而不是索引。这看似不太一致，但你习惯后就会觉得相当自然。毕竟如果字典包含指定的键，检查相应的值就很容易。</li>
</ul>
<p>相比于检查列表是否包含指定的值，检查字典是否包含指定的键的效率更高。数据结构越大，效率差距就越大。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = []</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x[<span class="number">42</span>] = <span class="string">'Foobar'</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File "&lt;stdin&gt;", line 1, in ?</span><br><span class="line">IndexError: list assignment index out of range</span><br><span class="line"><span class="comment"># 将字符串'Foobar'赋给一个空列表中索引为42的元素。这是不可以的，因为没有这样的元素。要让这种操作可行，初始化x时，必须使用[None] * 43之类的代码，而不能使用[]。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = &#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x[<span class="number">42</span>] = <span class="string">'Foobar'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x</span><br><span class="line">&#123;<span class="number">42</span>: <span class="string">'Foobar'</span>&#125;</span><br><span class="line"><span class="comment"># 将'Foobar'赋给一个空字典的键42，这样做一点问题都没有</span></span><br><span class="line"></span><br><span class="line">people = &#123;</span><br><span class="line">    <span class="string">'Alice'</span>: &#123;</span><br><span class="line">            <span class="string">'phone'</span>: <span class="string">'2341'</span>,</span><br><span class="line">            <span class="string">'addr'</span>: <span class="string">'Foo drive 23'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'Beth'</span>: &#123;</span><br><span class="line">            <span class="string">'phone'</span>: <span class="string">'9102'</span>,</span><br><span class="line">            <span class="string">'addr'</span>: <span class="string">'Bar street 42'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'Cecil'</span>: &#123;</span><br><span class="line">            <span class="string">'phone'</span>: <span class="string">'3158'</span>,</span><br><span class="line">            <span class="string">'addr'</span>: <span class="string">'Baz avenue 90'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 一个将人名用作键的字典。每个人都用一个字典表示，字典包含键'phone'和'addr'，它们分别与电话号码和地址相关联</span></span><br><span class="line"></span><br><span class="line">labels = &#123;</span><br><span class="line"><span class="string">'phone'</span>: <span class="string">'phone number'</span>,</span><br><span class="line"><span class="string">'addr'</span>: <span class="string">'address'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 电话号码和地址的描述性标签，供打印输出时使用</span></span><br><span class="line"></span><br><span class="line">name = input(<span class="string">'Name: '</span>)</span><br><span class="line"></span><br><span class="line">request = input(<span class="string">'Phone number (p) or address (a)? '</span>)</span><br><span class="line"><span class="comment"># 要查找电话号码还是地址?</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> request == <span class="string">'p'</span>: key = <span class="string">'phone'</span></span><br><span class="line"><span class="keyword">if</span> request == <span class="string">'a'</span>: key = <span class="string">'addr'</span></span><br><span class="line"><span class="comment"># 判断输入的是电话还是地址，如果是电话，key='phone'；如果是地址，key = 'addr'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> name <span class="keyword">in</span> people: print(<span class="string">"&#123;&#125;'s &#123;&#125; is &#123;&#125;."</span>.format(name, labels[key], people[name][key]))</span><br><span class="line"><span class="comment"># 仅当名字是字典包含的键时才打印信息，打印的格式为某人的电话或地址是什么，format指定三个值对应前面的三个中括号，第一个值是用户输入的name；第二个值是key，key可以是phone或addr，在labels字典中查找对应的电话号码或地址；第三个值是使用name和key的值在people字典中查找对应的值。</span></span><br><span class="line">这个程序的运行情况类似于下面这样:</span><br><span class="line">Name: Beth</span><br><span class="line">Phone number (p) or address (a)? p</span><br><span class="line">Beth<span class="string">'s phone number is 9102.</span></span><br></pre></td></tr></table></figure>
<h4 id="将字符串格式设置功能用于字典"><a href="#将字符串格式设置功能用于字典" class="headerlink" title="将字符串格式设置功能用于字典"></a>将字符串格式设置功能用于字典</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; phonebook</span><br><span class="line">&#123;<span class="string">'Beth'</span>: <span class="string">'9102'</span>, <span class="string">'Alice'</span>: <span class="string">'2341'</span>, <span class="string">'Cecil'</span>: <span class="string">'3258'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">"Cecil's phone number is &#123;Cecil&#125;."</span>.format_map(phonebook)</span><br><span class="line"><span class="string">"Cecil's phone number is 3258."</span></span><br><span class="line"><span class="comment"># 可在字典中包含各种信息，这样只需在格式字符串中提取所需的信息即可。使用format_map来指出你将通过一个映射来提供所需的信息。可使用字符串格式设置功能来设置值的格式，这些值是作为命名或非命名参数提供给方法format的。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>template = <span class="string">'''&lt;html&gt;</span></span><br><span class="line"><span class="string"><span class="meta">... </span>&lt;head&gt;&lt;title&gt;&#123;title&#125;&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string"><span class="meta">... </span>&lt;body&gt;</span></span><br><span class="line"><span class="string"><span class="meta">... </span>&lt;h1&gt;&#123;title&#125;&lt;/h1&gt;</span></span><br><span class="line"><span class="string"><span class="meta">... </span>&lt;p&gt;&#123;text&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string"><span class="meta">... </span>&lt;/body&gt;'''</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = &#123;<span class="string">'title'</span>: <span class="string">'My Home Page'</span>, <span class="string">'text'</span>: <span class="string">'Welcome to my home page!'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(template.format_map(data))</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;My Home Page&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;My Home Page&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;Welcome to my home page!&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"><span class="comment"># 将data字典的值代入template中。像这样使用字典时，可指定任意数量的转换说明符，条件是所有的字段名都是包含在字典中的键。</span></span><br></pre></td></tr></table></figure>
<h4 id="字典方法"><a href="#字典方法" class="headerlink" title="字典方法"></a>字典方法</h4><h5 id="clear（删除所有字典项）"><a href="#clear（删除所有字典项）" class="headerlink" title="clear（删除所有字典项）"></a>clear（删除所有字典项）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'name'</span>] = <span class="string">'Gumby'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'age'</span>] = <span class="number">42</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">'age'</span>: <span class="number">42</span>, <span class="string">'name'</span>: <span class="string">'Gumby'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>returned_value = d.clear()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(returned_value)</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line"><span class="comment"># 这种操作是就地执行的(就像list.sort一样)，因此什么都不返回(或者说返回None)。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = &#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y = x</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x[<span class="string">'key'</span>] = <span class="string">'value'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y</span><br><span class="line">&#123;<span class="string">'key'</span>: <span class="string">'value'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = &#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y</span><br><span class="line">&#123;<span class="string">'key'</span>: <span class="string">'value'</span>&#125;</span><br><span class="line"><span class="comment"># x和y最初都指向同一个字典。通过将一个空字典赋给x来“清空”它。这对y没有任何影响，它依然指向原来的字典。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = &#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y = x</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x[<span class="string">'key'</span>] = <span class="string">'value'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y</span><br><span class="line">&#123;<span class="string">'key'</span>: <span class="string">'value'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x.clear()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y</span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="comment"># 要删除原来字典的所有元素，必须使用clear。如果这样做， y也将是空的</span></span><br></pre></td></tr></table></figure>
<h5 id="copy（返回一个新字典）"><a href="#copy（返回一个新字典）" class="headerlink" title="copy（返回一个新字典）"></a>copy（返回一个新字典）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法copy返回一个新字典，其包含的键值对与原来的字典相同(这个方法执行的是浅复制，因为值本身是原件，而非副本)。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = &#123;<span class="string">'username'</span>: <span class="string">'admin'</span>, <span class="string">'machines'</span>: [<span class="string">'foo'</span>, <span class="string">'bar'</span>, <span class="string">'baz'</span>]&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y = x.copy()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y[<span class="string">'username'</span>] = <span class="string">'mlh'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y[<span class="string">'machines'</span>].remove(<span class="string">'bar'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y</span><br><span class="line">&#123;<span class="string">'username'</span>: <span class="string">'mlh'</span>, <span class="string">'machines'</span>: [<span class="string">'foo'</span>, <span class="string">'baz'</span>]&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x</span><br><span class="line">&#123;<span class="string">'username'</span>: <span class="string">'admin'</span>, <span class="string">'machines'</span>: [<span class="string">'foo'</span>, <span class="string">'baz'</span>]&#125;</span><br><span class="line"><span class="comment"># 当替换副本中的值时，原件不受影响。然而，如果修改副本中的值(就地修改而不是替换)，原件也将发生变化，因为原件指向的也是被修改的值</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> copy <span class="keyword">import</span> deepcopy</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'names'</span>] = [<span class="string">'Alfred'</span>, <span class="string">'Bertrand'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = d.copy()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dc = deepcopy(d)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'names'</span>].append(<span class="string">'Clive'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c</span><br><span class="line">&#123;<span class="string">'names'</span>: [<span class="string">'Alfred'</span>, <span class="string">'Bertrand'</span>, <span class="string">'Clive'</span>]&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dc</span><br><span class="line">&#123;<span class="string">'names'</span>: [<span class="string">'Alfred'</span>, <span class="string">'Bertrand'</span>]&#125;</span><br><span class="line"><span class="comment"># 深复制，即同时复制值及其包含的所有值，等等。为此，可使用模块copy中的函数deepcopy。c和dc的值都是从d复制过来的，只是c是浅复制，dc是深复制，在d中追加值后，c的值也有变化，dc没有。</span></span><br></pre></td></tr></table></figure>
<h5 id="fromkeys（创建新字典）"><a href="#fromkeys（创建新字典）" class="headerlink" title="fromkeys（创建新字典）"></a>fromkeys（创建新字典）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fromkeys创建一个新字典，其中包含指定的键，且每个键对应的值都是None。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>&#123;&#125;.fromkeys([<span class="string">'name'</span>, <span class="string">'age'</span>])</span><br><span class="line">&#123;<span class="string">'age'</span>: <span class="keyword">None</span>, <span class="string">'name'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"><span class="comment"># 首先创建了一个空字典，再对其调用方法fromkeys来创建另一个字典，这显得有点多余。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dict.fromkeys([<span class="string">'name'</span>, <span class="string">'age'</span>])</span><br><span class="line">&#123;<span class="string">'age'</span>: <span class="keyword">None</span>, <span class="string">'name'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"><span class="comment"># 直接对dict调用方法fromkeys。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dict.fromkeys([<span class="string">'name'</span>, <span class="string">'age'</span>], <span class="string">'(unknown)'</span>)</span><br><span class="line">&#123;<span class="string">'age'</span>: <span class="string">'(unknown)'</span>, <span class="string">'name'</span>: <span class="string">'(unknown)'</span>&#125;</span><br><span class="line"><span class="comment"># 不使用默认值None，可提供特定的值。</span></span><br></pre></td></tr></table></figure>
<h5 id="get（访问字典项）"><a href="#get（访问字典项）" class="headerlink" title="get（访问字典项）"></a>get（访问字典项）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法get为访问字典项提供了宽松的环境。通常，如果你试图访问字典中没有的项，将引发错误。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(d[<span class="string">'name'</span>])</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File "&lt;stdin&gt;", line 1, in ?</span><br><span class="line">KeyError: <span class="string">'name'</span></span><br><span class="line"><span class="comment"># 访问没有的项，报错。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(d.get(<span class="string">'name'</span>))</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line"><span class="comment"># 使用get方法访问没有的项，不会报错。而是返回None。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.get(<span class="string">'name'</span>, <span class="string">'N/A'</span>)</span><br><span class="line"><span class="string">'N/A'</span></span><br><span class="line"><span class="comment"># 可指定“默认”值，这样将返回你指定的值而不是None。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'name'</span>] = <span class="string">'Eric'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.get(<span class="string">'name'</span>)</span><br><span class="line"><span class="string">'Eric'</span></span><br><span class="line"><span class="comment"># 如果字典包含指定的键，get的作用将与普通字典查找相同。</span></span><br><span class="line"></span><br><span class="line">people = &#123;</span><br><span class="line">    <span class="string">'Alice'</span>: &#123;</span><br><span class="line">            <span class="string">'phone'</span>: <span class="string">'2341'</span>,</span><br><span class="line">            <span class="string">'addr'</span>: <span class="string">'Foo drive 23'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'Beth'</span>: &#123;</span><br><span class="line">            <span class="string">'phone'</span>: <span class="string">'9102'</span>,</span><br><span class="line">            <span class="string">'addr'</span>: <span class="string">'Bar street 42'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'Cecil'</span>: &#123;</span><br><span class="line">            <span class="string">'phone'</span>: <span class="string">'3158'</span>,</span><br><span class="line">            <span class="string">'addr'</span>: <span class="string">'Baz avenue 90'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">labels = &#123;</span><br><span class="line"><span class="string">'phone'</span>: <span class="string">'phone number'</span>,</span><br><span class="line"><span class="string">'addr'</span>: <span class="string">'address'</span></span><br><span class="line">&#125;</span><br><span class="line">name = input(<span class="string">'Name: '</span>)</span><br><span class="line"></span><br><span class="line">request = input(<span class="string">'Phone number (p) or address (a)? '</span>)</span><br><span class="line"></span><br><span class="line">key = request </span><br><span class="line"><span class="keyword">if</span> request == <span class="string">'p'</span>: key = <span class="string">'phone'</span></span><br><span class="line"><span class="keyword">if</span> request == <span class="string">'a'</span>: key = <span class="string">'addr'</span></span><br><span class="line"></span><br><span class="line">person = people.get(name, &#123;&#125;)</span><br><span class="line">label = labels.get(key, key)</span><br><span class="line">result = person.get(key, <span class="string">'not available'</span>)</span><br><span class="line">print(<span class="string">"&#123;&#125;'s &#123;&#125; is &#123;&#125;."</span>.format(name, label, result))</span><br><span class="line"><span class="comment"># 使用了方法get来访问“数据库”条目</span></span><br><span class="line">下面是这个程序的运行情况。</span><br><span class="line">Name: Gumby</span><br><span class="line">Phone number (p) or address (a)? batting average</span><br><span class="line">Gumby<span class="string">'s batting average is not available.</span></span><br></pre></td></tr></table></figure>
<h5 id="items（返回列表）"><a href="#items（返回列表）" class="headerlink" title="items（返回列表）"></a>items（返回列表）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法items返回一个包含所有字典项的列表，其中每个元素都为(key, value)的形式。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">'title'</span>: <span class="string">'Python Web Site'</span>, <span class="string">'url'</span>: <span class="string">'http://www.python.org'</span>, <span class="string">'spam'</span>: <span class="number">0</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.items()</span><br><span class="line">dict_items([(<span class="string">'url'</span>, <span class="string">'http://www.python.org'</span>), (<span class="string">'spam'</span>, <span class="number">0</span>), (<span class="string">'title'</span>, <span class="string">'Python Web Site'</span>)])</span><br><span class="line"><span class="comment"># 字典项在列表中的排列顺序不确定。返回值属于一种名为字典视图的特殊类型。字典视图可用于迭代</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it = d.items()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>len(it)</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>(<span class="string">'spam'</span>, <span class="number">0</span>) <span class="keyword">in</span> it</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="comment"># 还可确定其长度以及对其执行成员资格检查。如下 ：</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'spam'</span>] = <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>(<span class="string">'spam'</span>, <span class="number">0</span>) <span class="keyword">in</span> it</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'spam'</span>] = <span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>(<span class="string">'spam'</span>, <span class="number">0</span>) <span class="keyword">in</span> it</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="comment"># 视图的一个优点是不复制，它们始终是底层字典的反映，即便你修改了底层字典亦如此</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(d.items())</span><br><span class="line">[(<span class="string">'spam'</span>, <span class="number">0</span>), (<span class="string">'title'</span>, <span class="string">'Python Web Site'</span>), (<span class="string">'url'</span>, <span class="string">'http://www.python.org'</span>)]</span><br><span class="line"><span class="comment"># 将字典项复制到列表中</span></span><br></pre></td></tr></table></figure>
<h5 id="keys（返回字典视图）"><a href="#keys（返回字典视图）" class="headerlink" title="keys（返回字典视图）"></a>keys（返回字典视图）</h5><blockquote>
<p>方法keys返回一个字典视图，其中包含指定字典中的键。</p>
</blockquote>
<h5 id="pop（删除键值对）"><a href="#pop（删除键值对）" class="headerlink" title="pop（删除键值对）"></a>pop（删除键值对）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法pop可用于获取与指定键相关联的值，并将该键值对从字典中删除。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">'x'</span>: <span class="number">1</span>, <span class="string">'y'</span>: <span class="number">2</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.pop(<span class="string">'x'</span>)</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">'y'</span>: <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>
<h5 id="popitem-（删除随机键值对）"><a href="#popitem-（删除随机键值对）" class="headerlink" title="popitem （删除随机键值对）"></a>popitem （删除随机键值对）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法popitem类似于list.pop ，但 list.pop弹出列表中的最后一个元素，而popitem随机地弹出一个字典项，因为字典项的顺序是不确定的，没有“最后一个元素”的概念。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">'url'</span>: <span class="string">'http://www.python.org'</span>, <span class="string">'spam'</span>: <span class="number">0</span>, <span class="string">'title'</span>: <span class="string">'Python Web Site'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.popitem()</span><br><span class="line">(<span class="string">'url'</span>, <span class="string">'http://www.python.org'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">'spam'</span>: <span class="number">0</span>, <span class="string">'title'</span>: <span class="string">'Python Web Site'</span>&#125;</span><br><span class="line"><span class="comment"># 虽然popitem 类似于列表方法pop，但字典没有与append(它在列表末尾添加一个元素)对应的方法。这是因为字典是无序的，类似的方法毫无意义。</span></span><br></pre></td></tr></table></figure>
<h5 id="setdefault（获取关联的值）"><a href="#setdefault（获取关联的值）" class="headerlink" title="setdefault（获取关联的值）"></a>setdefault（获取关联的值）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法setdefault 有点像 get，因为它也获取与指定键相关联的值，但除此之外，setdefault还在字典不包含指定的键时，在字典中添加指定的键值对。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.setdefault(<span class="string">'name'</span>, <span class="string">'N/A'</span>)</span><br><span class="line"><span class="string">'N/A'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'N/A'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'name'</span>] = <span class="string">'Gumby'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.setdefault(<span class="string">'name'</span>, <span class="string">'N/A'</span>)  <span class="comment"># 这里不加'N/A'也可以，N/A是默认值，没有值就返回此值？</span></span><br><span class="line"><span class="string">'Gumby'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'Gumby'</span>&#125;</span><br><span class="line"><span class="comment"># 指定的键不存在时， setdefault返回指定的值并相应地更新字典。如果指定的键存在，就返回其值，并保持字典不变。与 get一样，值是可选的；如果没有指定，默认为None 。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(d.setdefault(<span class="string">'name'</span>))</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="keyword">None</span>&#125;</span><br></pre></td></tr></table></figure>
<h5 id="update（更新字典）"><a href="#update（更新字典）" class="headerlink" title="update（更新字典）"></a>update（更新字典）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法update使用一个字典中的项来更新另一个字典。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;</span><br><span class="line"><span class="meta">... </span><span class="string">'title'</span>: <span class="string">'Python Web Site'</span>,</span><br><span class="line"><span class="meta">... </span><span class="string">'url'</span>: <span class="string">'http://www.python.org'</span>,</span><br><span class="line"><span class="meta">... </span><span class="string">'changed'</span>: <span class="string">'Mar 14 22:09:15 MET 2016'</span></span><br><span class="line"><span class="meta">... </span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = &#123;<span class="string">'title'</span>: <span class="string">'Python Language Website'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.update(x)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">'url'</span>: <span class="string">'http://www.python.org'</span>, <span class="string">'changed'</span>:</span><br><span class="line"><span class="string">'Mar 14 22:09:15 MET 2016'</span>, <span class="string">'title'</span>: <span class="string">'Python Language Website'</span>&#125;</span><br><span class="line"><span class="comment"># 对于通过参数提供的字典，将其项添加到当前字典中。如果当前字典包含键相同的项，就替换它。</span></span><br></pre></td></tr></table></figure>
<h5 id="values（返回字典视图）"><a href="#values（返回字典视图）" class="headerlink" title="values（返回字典视图）"></a>values（返回字典视图）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法values返回一个由字典中的值组成的字典视图。不同于方法keys，方法 values返回的视图可能包含重复的值。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="number">2</span>] = <span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="number">3</span>] = <span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="number">4</span>] = <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.values()</span><br><span class="line">dict_values([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>])</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">155</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">120</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
