<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/5/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/24/rsyslog服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/24/rsyslog服务/" itemprop="url">
                  rsyslog服务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-24 17:31:29" itemprop="dateCreated datePublished" datetime="2020-03-24T17:31:29+08:00">2020-03-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/rsyslog/" itemprop="url" rel="index"><span itemprop="name">rsyslog</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>Linux日志机制的核心是<a href="http://www.rsyslog.com/" target="_blank" rel="noopener">rsyslog</a>守护进程，该服务负责监听Linux下的日志信息，并把日志信息追加到对应的日志文件中，一般在/var/log目录下。它还可以把日志信息通过网络协议发送到另一台Linux服务器上。</p>
<p>rsyslog的主程序为rsyslogd，配置文件路径为 /etc/rsyslog.conf，服务脚本/etc/rc.d/init.d/rsyslog</p>
<p>rsyslog的特性包括：</p>
<ul>
<li>多线程；</li>
<li>支持UDP，TCP，SSL，TLS，RELP；</li>
<li>支持使用MySQL，PGSQL，Oralce实现日志存储；</li>
<li>强大的过滤器，可实现过滤日志信息中任何部分</li>
<li>自定义输出格式</li>
</ul>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">### MODULES ####</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The imjournal module bellow is now used as a message <span class="built_in">source</span> instead of imuxsock.</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ModLoad imuxsock <span class="comment"># provides support for local system logging (e.g. via logger command)</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">ModLoad imjournal <span class="comment"># provides access to the systemd journal</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="variable">$ModLoad</span> imklog <span class="comment"># reads kernel messages (the same are read from journald)</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="variable">$ModLoad</span> immark  <span class="comment"># provides --MARK-- message capability</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Provides UDP syslog reception</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ModLoad imudp</span></span><br><span class="line"><span class="meta">$</span><span class="bash">UDPServerRun 514</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Provides TCP syslog reception</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ModLoad imtcp</span></span><br><span class="line"><span class="meta">$</span><span class="bash">InputTCPServerRun 514</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果需要将rsyslog配置成服务，需要打开udp或tcp的模块加载与监听端口，也可以全部打开。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">### GLOBAL DIRECTIVES ####</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Where to place auxiliary files</span></span><br><span class="line"><span class="meta">$</span><span class="bash">WorkDirectory /var/lib/rsyslog</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Use default timestamp format</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> File syncing capability is disabled by default. This feature is usually not required,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> not useful and an extreme performance hit</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="variable">$ActionFileEnableSync</span> on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Include all config files <span class="keyword">in</span> /etc/rsyslog.d/</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IncludeConfig /etc/rsyslog.d/*.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Turn off message reception via <span class="built_in">local</span> <span class="built_in">log</span> socket;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">local</span> messages are retrieved through imjournal now.</span></span><br><span class="line"><span class="meta">$</span><span class="bash">OmitLocalLogging on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> File to store the position <span class="keyword">in</span> the journal</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IMJournalStateFile imjournal.state</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">### RULES ####</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Log all kernel messages to the console.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Logging much <span class="keyword">else</span> clutters up the screen.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">kern.*                                                 /dev/console</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Log anything (except mail) of level info or higher.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Don<span class="string">'t log private authentication messages!</span></span></span><br><span class="line">*.info;mail.none;authpriv.none;cron.none                /var/log/messages</span><br><span class="line"><span class="meta">#</span><span class="bash"> 所有facility的info级别，但不包括mail;authpriv;cron，因为这三个facility的级别是none</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The authpriv file has restricted access.</span></span><br><span class="line">authpriv.*                                              /var/log/secure</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Log all the mail messages <span class="keyword">in</span> one place.</span></span><br><span class="line">mail.*                                                  -/var/log/maillog</span><br><span class="line"><span class="meta">#</span><span class="bash"> Log cron stuff</span></span><br><span class="line">cron.*                                                  /var/log/cron</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Everybody gets emergency messages</span></span><br><span class="line">*.emerg                                                 :omusrmsg:*</span><br><span class="line"><span class="meta">#</span><span class="bash"> :omusrmsg:*表示将所有emerg级别的日志通知给所有登录用户</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Save news errors of level crit and higher <span class="keyword">in</span> a special file.</span></span><br><span class="line">uucp,news.crit                                          /var/log/spooler</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这表示uucp.crit和news.crit，因为都是crit级别，所以前面将facility写在一起用逗号分隔</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Save boot messages also to boot.log</span></span><br><span class="line">local7.*                                                /var/log/boot.log</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件共分为三段，第一段MODULES是加载模块的， 第二段GLOBAL DIRECTIVES是全局配置，第三段RULES是针对具体的设置与级别将日志保存到哪里。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第三段RULES的配置格式为：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> facility.priority   target</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 其中facility表示设施，是日志生成器，或叫日志收集管道，它从功能或程序上对日志进行分类，包括：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> auth, authpriv, cron, daemon, kern, lpr, mail, mark, news, security, user, uucp, </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> local0-local7, syslog。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> priority表示日志级别，包括：debug, info, notice, warn(warning), err(error),  </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> crit(critical), alert, emerg(要死了, panic)。指定级别方法：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> *：所有级别；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> none：没有级别，不记录；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> priority：此级别及更高级别的日志信息都记录；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> =priority：此级别。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target表示保存的路径，指定方法有：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 文件路径：记录于指定的日志文件中，通常应该在/var/<span class="built_in">log</span>/目录下。文件路径前的<span class="string">"-"</span>表示异步写入；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户：将日志通知给指定用户；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> *：所有用户；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志服务器：@host；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> host：必须要监听在tcp或udp协议514端口上提供服务；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 管道： |COMMAND</span></span><br><span class="line"></span><br><span class="line">dmesg</span><br><span class="line">cat /var/log/dmesg</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这两条命令是一样的，查看系统启动时的日志。dmesg是一个显示内核缓冲区系统控制信息的工具</span></span><br></pre></td></tr></table></figure>
<h3 id="日志格式"><a href="#日志格式" class="headerlink" title="日志格式"></a>日志格式</h3><p>文件记录时日志的格式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mar 25 09:11:26 localhost sshd[15000]: Accepted password for root from 192.168.1.17 port 55624 ssh2</span><br><span class="line">Mar 25 09:11:28 localhost sshd[15000]: error: no more sessions</span><br><span class="line">Mar 25 09:11:28 localhost sshd[15000]: error: no more sessions</span><br></pre></td></tr></table></figure>
<p>事件产生的日期时间    主机    进程（pid）：事件内容</p>
<p>有些日志记录二进制格式，如/var/log/wtmp, /var/log/btmp</p>
<p>/var/log/wtmp：当前系统上成功登录的日志；查看方法：last</p>
<p>/var/log/btmp：当前系统上失败的登录尝试；查看方法：lastb        </p>
<p>lastlog命令：显示当前系统每一个用户最近一次的登录时间</p>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><h4 id="配置sshd日志输出"><a href="#配置sshd日志输出" class="headerlink" title="配置sshd日志输出"></a>配置sshd日志输出</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ssh/sshd_config </span><br><span class="line"><span class="meta">#</span><span class="bash">SyslogFacility AUTHPRIV</span></span><br><span class="line">SyslogFacility local2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注释上面一条，添加下面一条，自定义日志级别为local2</span></span><br><span class="line">systemctl restart sshd</span><br><span class="line"></span><br><span class="line">vim /etc/rsyslog.conf </span><br><span class="line">local2.*                                     /var/log/sshd.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在第三段配置上添加</span></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line"></span><br><span class="line">再次登录，之后就可以查看到日志了</span><br><span class="line">cat /var/log/sshd.log </span><br><span class="line">Mar 25 09:11:26 localhost sshd[15000]: Accepted password for root from 192.168.1.17 port 55624 ssh2</span><br><span class="line">Mar 25 09:11:28 localhost sshd[15000]: error: no more sessions</span><br><span class="line">Mar 25 09:11:28 localhost sshd[15000]: error: no more sessions</span><br></pre></td></tr></table></figure>
<h4 id="配置rsyslog服务"><a href="#配置rsyslog服务" class="headerlink" title="配置rsyslog服务"></a>配置rsyslog服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyslog.conf </span><br><span class="line"><span class="meta">#</span><span class="bash"> Provides UDP syslog reception</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ModLoad imudp</span></span><br><span class="line"><span class="meta">$</span><span class="bash">UDPServerRun 514</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Provides TCP syslog reception</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ModLoad imtcp</span></span><br><span class="line"><span class="meta">$</span><span class="bash">InputTCPServerRun 514</span></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">ss -tlun</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 换另一台主机</span></span><br><span class="line">vim /etc/rsyslog.conf</span><br><span class="line">*.info;mail.none;authpriv.none;cron.none         @192.168.1.8</span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">在这台主机上运行yum安装一个软件包，再到192.168.1.8的主机上看一下messages日志中是否有记录</span><br></pre></td></tr></table></figure>
<h4 id="将日志保存到mysql中并安装一个日志展示工具"><a href="#将日志保存到mysql中并安装一个日志展示工具" class="headerlink" title="将日志保存到mysql中并安装一个日志展示工具"></a>将日志保存到mysql中并安装一个日志展示工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">wget -i -c http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">yum -y install mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">yum -y install mysql-community-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装mysql5.7</span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">skip_name_resolve = ON</span><br><span class="line">innodb_file_per_table = ON</span><br><span class="line">systemctl start mysqld</span><br><span class="line">yum install rsyslog-mysql </span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是rsyslog连接mysql时用的驱动</span></span><br><span class="line">less /usr/share/doc/rsyslog-mysql-5.8.10/createDB.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是安装rsyslog-mysql后生成的，查看一下这个sql脚本中要在mysql中创建的数据库名称是什么</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line">GRANT ALL ON Syslog.* TO 'syslog'@'192.168.%.%' IDENTIFIED BY 'syslogpass';</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加一个授权，Syslog是上面查看到的数据库名称</span></span><br><span class="line">FLUSH PRIVILEGES；</span><br><span class="line">mysql -usyslog -psyslogpass -h192.168.1.8</span><br><span class="line">mysql -usyslog -h192.168.1.8 -p &lt; /usr/share/doc/rsyslog-mysql-5.8.10/createDB.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入数据库</span></span><br><span class="line">mysql -usyslog -psyslogpass -h192.168.1.8</span><br><span class="line">SHOW DATABASES;</span><br><span class="line">USE Syslog</span><br><span class="line">SHOW TABLES;</span><br><span class="line">vim /etc/rsyslog.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###### MODULES #######</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">ModLoad ommysql   <span class="comment"># 表示加载模块。om表示输出，im表示输入</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在第一段配置中加入这句</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">####### RULES ###########</span></span></span><br><span class="line">*.info;mail.none;authpriv.none;cron.none     :ommysql:192.168.1.8,Syslog,syslog,syslogpass</span><br><span class="line"><span class="meta">#</span><span class="bash"> 后面的target表示，使用ommysql这个模块或发往ommysql这个输出过滤器，之后是mysql的地址，再之后是</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据库名称，以哪个用户名连接，连接的密码是什么</span></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">再次使用yum安装一个程序包测试，再看mysql中是否有记录</span><br><span class="line"></span><br><span class="line">mysql -uroot -p</span><br><span class="line">SELECT COUNT(*) FROM SystemEvents;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里有三条记录</span></span><br><span class="line">SELECT COUNT(*) FROM SystemEventsProperties;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里没有记录</span></span><br><span class="line">SELECT * FROM SystemEvents\G</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面安装展示工具loganalyzer</span></span><br><span class="line">yum install httpd php php-mysql php-gd</span><br><span class="line"><span class="meta">#</span><span class="bash"> php-gd是一个绘图的工具</span></span><br><span class="line">vim /var/www/html/index.php   # 编写一个php文件，测试是否连接远程mysql</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="meta">	$</span><span class="bash">conn = mysql_connect(<span class="string">'192.168.1.8'</span>,<span class="string">'syslog'</span>,<span class="string">'syslogpass'</span>);</span></span><br><span class="line">	if ($conn)</span><br><span class="line">		echo "OK";</span><br><span class="line">	else</span><br><span class="line">		echo "Failure";</span><br><span class="line">?&gt;</span><br><span class="line">systemctl start httpd</span><br><span class="line">访问192.168.1.8</span><br><span class="line">下载loganalyzer-3.6.5.tar.gz</span><br><span class="line">tar xf loganalyzer-3.6.5.tar.gz</span><br><span class="line">cp /loganalyzer-3.6.5/src /var/www/html/loganalyzer</span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们主要使用src目录中的文件</span></span><br><span class="line">cp /loganalyzer-3.6.5/contrib/* /var/www/html/loganalyzer</span><br><span class="line"><span class="meta">#</span><span class="bash"> contrib目录下的脚本也需要</span></span><br><span class="line">cd /var/www/html/loganalyzer</span><br><span class="line">chmod +x *.sh</span><br><span class="line">./configure.sh</span><br><span class="line">./secure.sh</span><br><span class="line">chmod 666 config.php   # 如果没有此文件，使用此命令也会创建这个文件</span><br><span class="line">访问192.168.1.8/loganalyzer/install.php，进入安装，在第七步时要选择Source Type，选择MYSQL Native，之后输出数据库的信息</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/11/nginx日志记录请求响应时间/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/11/nginx日志记录请求响应时间/" itemprop="url">
                  nginx日志记录请求响应时间
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-11 15:25:53" itemprop="dateCreated datePublished" datetime="2020-03-11T15:25:53+08:00">2020-03-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="修改日志格式"><a href="#修改日志格式" class="headerlink" title="修改日志格式"></a>修改日志格式</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    log_format  timed_combined  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      '"$http_user_agent" "$http_x_forwarded_for" '</span><br><span class="line">                        '$request_time $upstream_response_time';</span><br><span class="line">                        </span><br><span class="line">    server &#123;</span><br><span class="line">        access_log  /var/log/nginx/ipcdn.log  timed_combined;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>几个时间变量的解释</p>
<ul>
<li>$request_time – Full request time, starting when NGINX reads the first byte from the client and ending when NGINX sends the last byte of the response body</li>
<li>$upstream_connect_time – Time spent establishing a connection with an upstream server</li>
<li>$upstream_header_time – Time between establishing a connection to an upstream server and receiving the first byte of the response header</li>
<li>$upstream_response_time – – Time between establishing a connection to an upstream server and receiving the last byte of the response body</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/11/python基础学习-转：玩转可迭代对象迭代器生成器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/11/python基础学习-转：玩转可迭代对象迭代器生成器/" itemprop="url">
                  python基础学习-转：玩转可迭代对象迭代器生成器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-11 08:58:33" itemprop="dateCreated datePublished" datetime="2020-03-11T08:58:33+08:00">2020-03-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="转：玩转可迭代对象迭代器生成器"><a href="#转：玩转可迭代对象迭代器生成器" class="headerlink" title="转：玩转可迭代对象迭代器生成器"></a>转：玩转可迭代对象迭代器生成器</h2><p>原创 wayne老师 <a href="javascript:void(0" target="_blank" rel="noopener">马哥Linux运维</a>;)   <a href="https://mp.weixin.qq.com/s/nFSuMQxyEvJ1IxcxIgs29Q" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/nFSuMQxyEvJ1IxcxIgs29Q</a></p>
<p><img src="/images/python迭代/可迭代对象、迭代器与生成器2.png" alt=""></p>
<p>在Python中，经常可以看到可迭代对象、迭代器、生成器，如何得到一个可迭代对象，如何把它变成迭代器，如何得到生成器，它们到底有什么区别和联系呢？</p>
<p>简单来说，它们的关系如下图</p>
<p>从概念上来说，可迭代对象 &gt; 迭代器 &gt; 生成器。</p>
<h3 id="可迭代对象"><a href="#可迭代对象" class="headerlink" title="可迭代对象"></a>可迭代对象</h3><p>可迭代对象Iterable，可以认为是一个容器，其中有N个元素，可以迭代。</p>
<p>在Python中可以简单的认为，能够使用for循环遍历的，都是可迭代对象。常见的类型由list、tuple、range对象、str、bytes、bytearra、set、dict等。</p>
<h4 id="自定义可迭代对象"><a href="#自定义可迭代对象" class="headerlink" title="自定义可迭代对象"></a>自定义可迭代对象</h4><p>自定义类型，如何变成一个可迭代对象？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIterable</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我还不是一个可迭代对象"</span></span><br><span class="line"></span><br><span class="line">mi = MyIterable()</span><br><span class="line">print(mi)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> mi:</span><br><span class="line">    print(i) <span class="comment"># 抛异常'MyIterable' object is not iterable</span></span><br></pre></td></tr></table></figure>
<p>实现<strong>iter</strong>魔术方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIterable</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'iter~~~~~~~'</span>)</span><br><span class="line"></span><br><span class="line">mi = MyIterable()</span><br><span class="line">print(mi)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> mi:</span><br><span class="line">    print(i) <span class="comment"># 抛异常iter() returned non-iterator of type 'NoneType'</span></span><br></pre></td></tr></table></figure>
<p>可以看到实例mi确实是可迭代对象了，但是返回值是None，所以报错了，看异常提示，<strong>iter</strong>返回一个迭代器才是正确的。</p>
<h3 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h3><p>迭代器Iterator</p>
<ul>
<li>迭代器是一种特殊可迭代对象，一定能迭代</li>
<li>可以使用内建函数next()来获取它的下一个元素</li>
<li>使用next迭代完所有元素后，如果继续获取下一个元素，则抛出StopIteration异常</li>
<li>使用next迭代完所有元素后，不可再次迭代</li>
</ul>
<p>判断是否是迭代器，其实如果可以使用next函数来获取元素的对象，一定是迭代器。</p>
<p>那么，列表是迭代器吗？</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">print(next(a)) # <span class="string">'list'</span> <span class="keyword">object</span> <span class="keyword">is</span> <span class="keyword">not</span> an iterator</span><br></pre></td></tr></table></figure>
<p>列表对象是可迭代对象，但不是迭代器。如何把一个可迭代对象转成迭代器呢？</p>
<ol>
<li>使用内建函数iter</li>
<li>包装成生成器对象</li>
</ol>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"><span class="comment"># print(next(a)) # 'list' object is not an iterator</span></span><br><span class="line">b = iter(a) <span class="comment"># 内建函数iter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">next</span>(b))</span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">next</span>(b))</span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">next</span>(b)) <span class="comment"># StopIteration</span></span><br></pre></td></tr></table></figure>
<p>很多函数都能返回迭代器，例如enumerate</p>
<figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">c = enumerate(a) <span class="meta"># 返回迭代器</span></span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">next</span>(c))</span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">next</span>(c))</span><br><span class="line"><span class="keyword">for</span> x in c: <span class="meta"># 已经迭代完了，没有什么元素可以迭代了</span></span><br><span class="line">    <span class="keyword">print</span>(x)</span><br><span class="line"><span class="keyword">print</span>(<span class="string">'='</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">next</span>(c)) <span class="meta"># StopIteration</span></span><br></pre></td></tr></table></figure>
<h4 id="自定义迭代器对象"><a href="#自定义迭代器对象" class="headerlink" title="自定义迭代器对象"></a>自定义迭代器对象</h4><p>那么，上面MyIterable的例子可以修改如下</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIterable</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.items = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        print(<span class="string">'iter~~~~~~~'</span>)</span><br><span class="line">        <span class="keyword">return</span> iter(<span class="keyword">self</span>.items)</span><br><span class="line"></span><br><span class="line">mi = MyIterable()</span><br><span class="line">print(mi)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="symbol">mi:</span> <span class="comment"># mi可以迭代了</span></span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="symbol">mi:</span> <span class="comment"># 可迭代对象可再次迭代</span></span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line">print(<span class="keyword">next</span>(mi)) <span class="comment"># 不可以使用next，说明mi不是迭代器</span></span><br></pre></td></tr></table></figure>
<p>mi对象成为了可迭代对象，但是它不是迭代器。</p>
<p>如何得到迭代器呢？使用<strong>next</strong>魔术方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIterable</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.items = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">        <span class="keyword">self</span>.count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        print(<span class="string">'iter~~~~~~~'</span>)</span><br><span class="line">        <span class="keyword">return</span> iter(<span class="keyword">self</span>.items)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        print(<span class="string">'next ~~~~'</span>)</span><br><span class="line">        <span class="symbol">try:</span></span><br><span class="line">            count = <span class="keyword">self</span>.count</span><br><span class="line">            n = <span class="keyword">self</span>.items[count]</span><br><span class="line">            <span class="keyword">self</span>.count = count + <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> n</span><br><span class="line">        except <span class="symbol">IndexError:</span></span><br><span class="line">            raise StopIteration</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mi = MyIterable()</span><br><span class="line">print(mi)</span><br><span class="line">print(<span class="keyword">next</span>(mi))</span><br><span class="line">print(<span class="keyword">next</span>(mi))</span><br><span class="line">print(<span class="keyword">next</span>(mi))</span><br><span class="line">print(<span class="keyword">next</span>(mi))</span><br><span class="line">print(<span class="keyword">next</span>(mi))</span><br><span class="line">print(<span class="keyword">next</span>(mi)) <span class="comment"># StopIteration</span></span><br></pre></td></tr></table></figure>
<p>代码再改进一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIterable</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.items = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'iter~~~~~~~'</span>)</span><br><span class="line">        <span class="comment">#return iter(self.items)</span></span><br><span class="line">        <span class="keyword">return</span> self <span class="comment"># 有__iter__我就是可迭代对象，因为有__next__，我自己就是迭代器</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'next ~~~~'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            count = self.count</span><br><span class="line">            n = self.items[count]</span><br><span class="line">            self.count = count + <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mi = MyIterable()</span><br><span class="line">print(mi)</span><br><span class="line">print(next(mi)) <span class="comment"># 迭代器</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> mi: <span class="comment"># mi也是可迭代对象</span></span><br><span class="line">    print(i)</span><br><span class="line">print(<span class="string">'-'</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> mi: <span class="comment"># 已经不能再次迭代</span></span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'-'</span> * <span class="number">30</span>)</span><br><span class="line">print(next(mi)) <span class="comment"># StopIteration</span></span><br></pre></td></tr></table></figure>
<h3 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h3><p>Python中使用2种方式获得生成器对象</p>
<ul>
<li>生成器表达式</li>
<li>生成器函数</li>
</ul>
<p>生成器是特殊的迭代器，但迭代器不一定是生成器。它是Python提供的通过编程方式快速便捷得到迭代器的手段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">g1 = (i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>)) <span class="comment"># 生成器表达式</span></span><br><span class="line">print(g1) <span class="comment"># 生成器对象</span></span><br><span class="line">print(next(g1))</span><br><span class="line">print(next(g1))</span><br><span class="line">print(<span class="string">'='</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">counter</span><span class="params">()</span>:</span> <span class="comment"># 生成器函数</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>, <span class="number">10</span>): <span class="comment"># 可以使用yield from</span></span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line">g2 = counter() <span class="comment"># 生成器函数调用不返回结果，返回一个生成器对象</span></span><br><span class="line">print(g2)</span><br><span class="line">print(next(g2))</span><br><span class="line">print(next(g2))</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Python 3开始，推荐在能使用迭代器的地方，考虑使用迭代器，它是惰性计算对象，不会短时间对内存和CPU造成大的压力。</p>
<p>可以使用生成器表达式非常便利得到一个迭代器，稍微复杂一些可以考虑使用生成器函数获得一个迭代器，如果更加复杂可以使用类来构造。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/08/python基础学习-描述器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/08/python基础学习-描述器/" itemprop="url">
                  python基础学习-描述器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-08 20:23:10" itemprop="dateCreated datePublished" datetime="2020-03-08T20:23:10+08:00">2020-03-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-07-28 17:00:58" itemprop="dateModified" datetime="2020-07-28T17:00:58+08:00">2020-07-28</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="描述器（Descriptors）的表现"><a href="#描述器（Descriptors）的表现" class="headerlink" title="描述器（Descriptors）的表现"></a>描述器（Descriptors）的表现</h3><p>用到3个魔法方法：<code>__get__()</code>、<code>__set__()</code>、<code>__delete__()</code></p>
<p>方法签名如下</p>
<p><code>object.__get__(self, instance, owner)</code></p>
<p><code>object.__set__(self, instance, value)</code></p>
<p><code>object.__delete__(self, instance)</code></p>
<p><code>self</code>指代当前实例，调用者</p>
<p><code>instance</code>是<code>owner</code>的实例</p>
<p><code>owner</code>是属性的所属的类</p>
<p>请思考下面程序的执行流程是什么？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        </span><br><span class="line">print(<span class="string">'-'</span> * <span class="number">20</span>)</span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">A.init</span><br><span class="line">---------------</span><br><span class="line"></span><br><span class="line">print(B.x.a1)</span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">a1</span><br><span class="line"></span><br><span class="line">print(<span class="string">'='</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">===============</span><br><span class="line">B.init</span><br><span class="line"></span><br><span class="line">print(b.x.a1)</span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">a1</span><br></pre></td></tr></table></figure>
<p>可以看出执行的先后顺序吧？</p>
<p>类加载的时候，类变量需要先生成，而类B的x属性是类A的实例，所以类A先初始化，所以打印<code>A.init</code>。</p>
<p>然后执行到打印<code>B.x.a1</code></p>
<p>然后实例化并初始化B的实例b。</p>
<p>打印<code>b.x.a1</code>，会查找类属性<code>b.x</code>，指向A的实例，所以返回A实例的属性a1的值</p>
<p>看懂执行流程了，再看下面的程序，对类A做一些改造。</p>
<p>如果在类A中实现<code>__get__</code>方法，看看变化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">"A.__get__ &#123;&#125; &#123;&#125; &#123;&#125;"</span>.format(self, instance, owner))</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        </span><br><span class="line">print(<span class="string">'-'</span> * <span class="number">20</span>)</span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">A.init</span><br><span class="line">--------------------</span><br><span class="line"></span><br><span class="line">print(B.x)</span><br><span class="line">输出：</span><br><span class="line">A.init</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7f223a2bc9e8</span>&gt; <span class="keyword">None</span> &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">None</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"># <span class="title">print</span><span class="params">(B.x.a1)</span> # 抛异常<span class="title">AttributeError</span>:</span> <span class="string">'NoneType'</span> object has no attribute <span class="string">'a1'</span></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># A.init</span></span><br><span class="line"><span class="comment"># A.__get__ &lt;__main__.A object at 0x7fc411e599e8&gt; None &lt;class '__main__.B'&gt;</span></span><br><span class="line"><span class="comment"># Traceback (most recent call last):</span></span><br><span class="line"><span class="comment">#   File "/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/课上练习.py", line 32, in &lt;module&gt;</span></span><br><span class="line"><span class="comment">#     print(B.x.a1)</span></span><br><span class="line"><span class="comment"># AttributeError: 'NoneType' object has no attribute 'a1'</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'='</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">输出：</span><br><span class="line">A.init</span><br><span class="line">====================</span><br><span class="line">B.init</span><br><span class="line"></span><br><span class="line">print(b.x)</span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">A.__get__&lt;__main__.A object at <span class="number">0x7f223a2bc9e8</span>&gt; &lt;__main__.B object at <span class="number">0x00000000001084E28</span>&gt; &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">None</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"># <span class="title">print</span><span class="params">(b.x.a1)</span> # 抛异常<span class="title">AttributeError</span>:</span> <span class="string">'NoneType'</span> object has no attribute <span class="string">'a1'</span></span><br><span class="line">输出：</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7f36cf3e49e8</span>&gt; &lt;__main__.B object at <span class="number">0x7f36cf2e5400</span>&gt; &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">Traceback</span> <span class="params">(most recent call last)</span>:</span></span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/课上练习.py"</span>, line <span class="number">36</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    print(b.x.a1)</span><br><span class="line">AttributeError: <span class="string">'NoneType'</span> object has no attribute <span class="string">'a1'</span></span><br></pre></td></tr></table></figure>
<p>因为定义了<code>__get__</code>方法，类A就是一个描述器，对类B或者类B的实例的x属性读取，成为对类A的实例的访问，就会调用<code>__get__</code>方法</p>
<p>如何解决上例中访问报错的问题，问题应该来自<code>__get__</code>方法。</p>
<p><code>self</code>, <code>instance</code>, <code>owner</code>这三个参数，是什么意思？</p>
<p><code>&lt;__main__.A object at 0x00000000001084E48&gt; None &lt;class &#39;__main__.B&#39;&gt; None</code></p>
<p><code>&lt;__main__.A object at 0x00000000001084E48&gt; &lt;__main__.B object at 0x00000000001084E28&gt; &lt;class &#39;__main__.B&#39;&gt;</code></p>
<p><code>self</code>都是A的实例</p>
<p><code>owner</code>都是B类</p>
<p><code>instance</code>说明</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- instance为<span class="keyword">None</span>表示是没有B类的实例，对应调用B.x</span><br><span class="line">- instance为&lt;__main__.B object at <span class="number">0x00000000001084E28</span>&gt;表示是B的实例，对应调用B().x或b.x</span><br></pre></td></tr></table></figure>
<p>使用返回值解决。返回<code>self</code>，就是A的实例，该实例有<code>a1</code>属性，返回正常。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">"A.__get__ &#123;&#125; &#123;&#125; &#123;&#125;"</span>.format(self, instance, owner))</span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># 解决返回None的问题</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        </span><br><span class="line">print(<span class="string">'-'</span> * <span class="number">20</span>)</span><br><span class="line">输出：</span><br><span class="line">A.init</span><br><span class="line">--------------------</span><br><span class="line"></span><br><span class="line">print(B.x)</span><br><span class="line">输出：</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7f3d154e59e8</span>&gt; <span class="keyword">None</span> &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f3d154e59e8</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">print</span><span class="params">(B.x.a1)</span></span></span><br><span class="line"><span class="class">输出：</span></span><br><span class="line"><span class="class"><span class="title">A</span>.<span class="title">__get__</span> &lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7feaec9899e8</span>&gt; <span class="title">None</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">a1</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">print</span><span class="params">(<span class="string">'='</span> * <span class="number">20</span>)</span></span></span><br><span class="line">b = B()</span><br><span class="line">输出：</span><br><span class="line">====================</span><br><span class="line">B.init</span><br><span class="line"></span><br><span class="line">print(b.x)</span><br><span class="line">输出：</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7f8e7c866400</span>&gt; &lt;__main__.B object at <span class="number">0x7f8e7c866438</span>&gt; &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f8e7c866400</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">print</span><span class="params">(b.x.a1)</span></span></span><br><span class="line"><span class="class">输出：</span></span><br><span class="line"><span class="class"><span class="title">A</span>.<span class="title">__get__</span> &lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7fd2948d03c8</span>&gt; &lt;<span class="title">__main__</span>.<span class="title">B</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7fd2948d0400</span>&gt; &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">a1</span></span></span><br></pre></td></tr></table></figure>
<p>那么类B的实例属性也可以？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">"A.__get__ &#123;&#125; &#123;&#125; &#123;&#125;"</span>.format(self, instance, owner))</span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># 解决返回None的问题</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        self.b = A()  <span class="comment"># 实例属性也指向一个A的实例</span></span><br><span class="line">        </span><br><span class="line">print(<span class="string">'-'</span> * <span class="number">20</span>)</span><br><span class="line">print(B.x)</span><br><span class="line">print(B.x.a1)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'='</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(b.x)</span><br><span class="line">print(b.x.a1)</span><br><span class="line"></span><br><span class="line">print(b.b)   <span class="comment"># 并没有触发__get__，从输出可以看出访问实例属性没有触发__get__方法</span></span><br><span class="line">输出：</span><br><span class="line">&lt;__main__.A object at <span class="number">0x7fa1cac11470</span>&gt;</span><br></pre></td></tr></table></figure>
<p>从运行结果可以看出，只有类属性是类的实例才行。</p>
<h3 id="描述器定义"><a href="#描述器定义" class="headerlink" title="描述器定义"></a>描述器定义</h3><p>Python中，一个类实现了<code>__get__</code>、<code>__set__</code>、<code>__delete__</code>三个方法中的任何一个方法，就是描述器。</p>
<p>如果仅实现了<code>__get__</code>，就是<strong>非数据描述符 non-data descriptor</strong>；</p>
<p>同时实现了<code>__get__</code>、<code>__set__</code>就是<strong>数据描述符 data descriptor</strong>。</p>
<p>如果一个类的类属性设置为描述器，那么它被称为<code>owner</code>属主。</p>
<h3 id="属性的访问顺序"><a href="#属性的访问顺序" class="headerlink" title="属性的访问顺序"></a>属性的访问顺序</h3><p>为上例中的类B增加实例属性x</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">"A.__get__ &#123;&#125; &#123;&#125; &#123;&#125;"</span>.format(self, instance, owner))</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        self.x = <span class="string">'b.x'</span>  <span class="comment"># 增加实例属性x</span></span><br><span class="line">        </span><br><span class="line">print(<span class="string">'-'</span> * <span class="number">20</span>)</span><br><span class="line">print(B.x)</span><br><span class="line">print(B.x.a1)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'='</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(b.x)</span><br><span class="line">print(b.x.a1)  <span class="comment"># AttributeError: 'str' object has no attribute 'a1'</span></span><br><span class="line">输出：</span><br><span class="line">A.init</span><br><span class="line">--------------------</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7f4f710fe470</span>&gt; <span class="keyword">None</span> &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f4f710fe470</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">A</span>.<span class="title">__get__</span> &lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f4f710fe470</span>&gt; <span class="title">None</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">a1</span></span></span><br><span class="line">====================</span><br><span class="line">B.init</span><br><span class="line">b.x</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/课上练习.py"</span>, line <span class="number">62</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    print(b.x.a1)</span><br><span class="line">AttributeError: <span class="string">'str'</span> object has no attribute <span class="string">'a1'</span></span><br></pre></td></tr></table></figure>
<p><code>b.x</code>访问到了实例的属性，而不是描述器。</p>
<p>继续修改代码，为类A增加<code>__set__</code>方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">"A.__get__ &#123;&#125; &#123;&#125; &#123;&#125;"</span>.format(self, instance, owner))</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        print(<span class="string">'A.__set__ &#123;&#125; &#123;&#125; &#123;&#125;'</span>.format(self, instance, value))</span><br><span class="line">        self.data = value</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        self.x = <span class="string">'b.x'</span>  <span class="comment"># 增加实例属性x</span></span><br><span class="line">        </span><br><span class="line">print(<span class="string">'-'</span> * <span class="number">20</span>)</span><br><span class="line">print(B.x)</span><br><span class="line">print(B.x.a1)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'='</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(b.x)</span><br><span class="line">print(b.x.a1)  <span class="comment"># 返回a1</span></span><br><span class="line">输出：</span><br><span class="line">A.init</span><br><span class="line">--------------------</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7f26fd55a470</span>&gt; <span class="keyword">None</span> &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f26fd55a470</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">A</span>.<span class="title">__get__</span> &lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f26fd55a470</span>&gt; <span class="title">None</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">a1</span></span></span><br><span class="line">====================</span><br><span class="line">B.init</span><br><span class="line">A.__set__ &lt;__main__.A object at <span class="number">0x7f26fd55a470</span>&gt; &lt;__main__.B object at <span class="number">0x7f26fd55a4a8</span>&gt; b.x</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7f26fd55a470</span>&gt; &lt;__main__.B object at <span class="number">0x7f26fd55a4a8</span>&gt; &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f26fd55a470</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">A</span>.<span class="title">__get__</span> &lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f26fd55a470</span>&gt; &lt;<span class="title">__main__</span>.<span class="title">B</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f26fd55a4a8</span>&gt; &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">a1</span></span></span><br></pre></td></tr></table></figure>
<p>返回变成了a1，访问到了描述器的数据。</p>
<p>属性查找顺序</p>
<p>实例的<code>__dict__</code>优先于非数据描述器</p>
<p>数据描述器优先于实例的<code>__dict__</code></p>
<p><code>__delete__</code>方法有同样的效果，有了这个方法，就是数据描述器。</p>
<p>尝试着增加下面的代码，看看字典的变化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b.x = <span class="number">500</span></span><br><span class="line">输出：</span><br><span class="line">A.__set__ &lt;__main__.A object at <span class="number">0x7f737eee9470</span>&gt; &lt;__main__.B object at <span class="number">0x7f737eee94a8</span>&gt; <span class="number">500</span></span><br><span class="line"></span><br><span class="line">B.x = <span class="number">600</span></span><br><span class="line"><span class="comment"># b.x = 500，这是调用数据描述器的__set__方法，或调用非数据描述器的实例属性覆盖</span></span><br><span class="line"><span class="comment"># B.x = 600，赋值即定义，这是覆盖类属性。</span></span><br></pre></td></tr></table></figure>
<h3 id="本质（进阶）"><a href="#本质（进阶）" class="headerlink" title="本质（进阶）"></a>本质（进阶）</h3><p>Python真的会做的这么复杂吗，再来一套属性查找顺序规则？看看非数据描述器和数据描述器，类B及其<code>__dict__</code>的变化。</p>
<p>屏蔽和不屏蔽<code>__set__</code>方法，看看变化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(Self)</span>:</span></span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">"A.__get__ &#123;&#125; &#123;&#125; &#123;&#125;"</span>.format(self, instance, owner))</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># def __set__(self, instance, value):</span></span><br><span class="line">    <span class="comment"># 		print('A.__set__ &#123;&#125; &#123;&#125; &#123;&#125;'.format(self, instance, value))</span></span><br><span class="line">    <span class="comment"># 		self.data = value</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        self.x = <span class="string">'b.x'</span>  <span class="comment"># 增加实例属性x</span></span><br><span class="line">        self.y = <span class="string">'b.y'</span></span><br><span class="line">        </span><br><span class="line">print(<span class="string">'-'</span> * <span class="number">20</span>)</span><br><span class="line">print(B.x)</span><br><span class="line">print(B.x.a1)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'='</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(b.x)</span><br><span class="line"><span class="comment"># print(b.x.a1)  # 返回a1</span></span><br><span class="line">print(b.y)</span><br><span class="line">print(<span class="string">'字典'</span>)</span><br><span class="line">print(b.__dict__)</span><br><span class="line">print(B.__dict__)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 屏蔽__set__方法结果如下</span></span><br><span class="line">字典</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="string">'b.x'</span>, <span class="string">'y'</span>: <span class="string">'b.y'</span>&#125;</span><br><span class="line">&#123;<span class="string">'__weakref__'</span>:&lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'B'</span> objects&gt;, <span class="string">'x'</span>: &lt;__main__.A object at <span class="number">0x0000000000824E48</span>&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'B'</span> objects&gt;, <span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function B.__init__ at <span class="number">0x000000000081E620</span>&gt;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不屏蔽__set__方法结果如下</span></span><br><span class="line">&#123;<span class="string">'y'</span>: <span class="string">'b.y'</span>&#125;  <span class="comment"># 因为实例属性与类属性都是x，所以set方法会拦截，y属性只有实例有，所以会加入到实例字典中</span></span><br><span class="line">&#123;<span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'B'</span> objects&gt;, <span class="string">'__init__'</span>: &lt;function B.__init__ at <span class="number">0x0000000000109E6A8</span>&gt;, <span class="string">'x'</span>: &lt;__main__.A object at <span class="number">0x0000000000824E48</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'B'</span> objects&gt;, <span class="string">'__module__'</span>: <span class="string">'__main__'</span>,<span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br></pre></td></tr></table></figure>
<p>原来不是什么<strong>数据描述器</strong>优先级高，而是把实例的属性从<code>__dict__</code>中给去除掉了，造成了该属性如果是数据描述器优先访问的假象。</p>
<p>说到底，属性访问顺序从来就没有变过</p>
<h3 id="Python中的描述器"><a href="#Python中的描述器" class="headerlink" title="Python中的描述器"></a>Python中的描述器</h3><p>描述器在Python中应用非常广泛</p>
<p>Python的方法（包括<code>staticmethod()</code>和<code>classmethod()</code>）都实现为非数据描述器。因此，实例可以重新定义和覆盖方法。这允许单个实例获取与同一类的其他实例不同的行为。</p>
<p><code>property()</code>函数实现为一个数据描述器。因此，实例不能覆盖属性的行为。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(cls)</span>:</span>   <span class="comment"># 非数据描述器</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod   # 非数据描述器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property   # 数据描述器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">z</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getfoo</span><span class="params">(self)</span>:</span>   <span class="comment"># 非数据描述器</span></span><br><span class="line">        <span class="keyword">return</span> self.foo</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>   <span class="comment"># 非数据描述器</span></span><br><span class="line">        self.foo = <span class="number">100</span></span><br><span class="line">        self.bar = <span class="number">200</span></span><br><span class="line">        <span class="comment"># self.z = 300</span></span><br><span class="line">        </span><br><span class="line">a = A()</span><br><span class="line">print(a.__dict__)</span><br><span class="line">print(A.__dict__)</span><br></pre></td></tr></table></figure>
<p>foo、bar都可以在实例中覆盖，但是z不可以。</p>
<h3 id="个人总结"><a href="#个人总结" class="headerlink" title="个人总结"></a>个人总结</h3><ol>
<li>有<code>__get__</code>方法时，如果定义了类属性为描述器，通过类属性访问描述器时，可以触发<code>__get__</code>方法</li>
<li>有<code>__get__</code>方法时，如果定义了类属性为描述器，通过实例访问类属性的描述器时，也可以触发<code>__get__</code>方法</li>
<li>如果只有<code>__get__</code>方法，并且实例中的属性与类属性同名，通过实例访问实例属性时，不会触发<code>__get__</code>方法，只会访问实例的属性</li>
<li><code>__get__</code>方法只是通过类属性访问时才能被触发</li>
<li><code>object.__get__(self, instance, owner)</code>中<code>self</code>表示定义了<code>__get__</code>方法的类，<code>instance</code>是使用描述符的对象的实例，也就是owner的实例，通过类访问时<code>instance</code>是<code>None</code>，通过实例访问时<code>instance</code>是实例所属的类，<code>owner</code>是调用这个描述器的类，就是使用描述符的对象拥有者</li>
<li>有<code>__get__</code>和<code>__set__</code>方法时，当实例属性与类属性同名时，将无法直接给实例属性赋值，如果要给实例属性赋值，要在<code>__set__</code>方法中手动修改实例的字典</li>
<li><code>__set__</code>方法是为了给属性赋值时用的</li>
<li>当有<code>__set__</code>方法时，实例属性与类属性不同名，不影响实例的属性赋值，也就是实例依然有相应的属性值。</li>
<li><code>object.__set__(self, instance, value)</code>方法中self表示定义了这个描述器的类，instance表示使用描述器的对象的实例类，value是要给调用描述器的类赋的值</li>
<li><code>__set__</code>方法没有返回值，<code>__get__</code>方法有返回值</li>
</ol>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><ol>
<li>实现<code>StaticMethod</code>装饰器，完成<code>staticmethod</code>装饰器的功能</li>
<li>实现<code>ClassMethod</code>装饰器，完成<code>classmethod</code>装饰器的功能</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 类staticmethod装饰器</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaticMethod</span>:</span>  <span class="comment"># 怕冲突改名</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self._fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._fn</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @staticMethod</span></span><br><span class="line">    <span class="comment"># stmtd = StaticMethod(stmtd)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stmtd</span><span class="params">()</span>:</span></span><br><span class="line">        print(<span class="string">'static method'</span>)</span><br><span class="line">        </span><br><span class="line">A.stmtd()</span><br><span class="line">A().stmtd()</span><br><span class="line">输出：</span><br><span class="line">static method</span><br><span class="line">static method</span><br><span class="line"><span class="comment"># 通过类或实例都可以访问stmtd属性</span></span><br><span class="line">========================================================</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaticMethod</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span>  <span class="comment"># 这样就可以在作为装饰器时把函数当作fn参数传进来了</span></span><br><span class="line">        print(fn)</span><br><span class="line">        self.fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(self, instance, owner)</span><br><span class="line">        <span class="keyword">return</span> self.fn</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassMethod</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span>  <span class="comment"># 这样就可以在作为装饰器时把函数当作fn参数传进来了</span></span><br><span class="line">        print(fn)</span><br><span class="line">        self.fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(self, instance, owner)</span><br><span class="line">        <span class="comment"># return self.fn(owner)</span></span><br><span class="line">        <span class="keyword">return</span> partial(self.fn, owner)  <span class="comment"># 这样做只会返回固定的类名称</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span>   </span><br><span class="line"><span class="meta">    @StaticMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span> <span class="comment"># foo = StaticMethod(foo),原来的foo在上面的__init__方法中</span></span><br><span class="line">        print(<span class="string">'static'</span>)</span><br><span class="line">    <span class="comment"># 这里做完了，就相当于foo = StaticMethod(foo)。未来要用A.foo的方法调用</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @ClassMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(cls)</span>:</span>  <span class="comment"># 设置这个函数就是打印类的名称</span></span><br><span class="line">        print(cls.__name__)</span><br><span class="line">    </span><br><span class="line">f = A.foo  <span class="comment"># 这一句触发了__get__方法</span></span><br><span class="line">print(f)</span><br><span class="line">f()</span><br><span class="line"></span><br><span class="line">f = A.bar</span><br><span class="line">print(f)</span><br><span class="line"><span class="comment"># f(A)  # 这相当于A.bar(A)。我们的目是A.bar()</span></span><br><span class="line">f()   <span class="comment"># 返回是None类型，因为def bar(cls)没有返回值，可以打印出类型是A</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="comment"># 类classmethod装饰器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassMethod</span>:</span>  <span class="comment"># 怕冲突改名</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self._fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        ret = self._fn(owner)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @ClassMethod</span></span><br><span class="line">    <span class="comment"># clsmtd = ClassMethod(clsmtd)</span></span><br><span class="line">    <span class="comment"># 调用A.clsmtd() 或者 A().clsmtd()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clsmtd</span><span class="params">(cls)</span>:</span></span><br><span class="line">        print(cls.__name__)</span><br><span class="line">print(A.__dict__)</span><br><span class="line">A.clsmtd</span><br><span class="line">A.clsmtd()</span><br></pre></td></tr></table></figure>
<p><code>A.clsmtd()</code>的意思就是<code>None()</code>，一定报错。怎么修改？</p>
<p><code>A.clsmtd()</code>其实就应该是<code>A.clsmtd(cls)()</code>，应该怎么处理？</p>
<p><code>A.clsmeth = A.clsmtd(cls)</code></p>
<p>应该用<code>partial</code>函数</p>
<p>partial是偏函数，把函数部分的参数固定一下，相当于为部分的参数添加了一个固定的默认值，形成一个新的函数并返回；用于创建一个偏函数，将默认参数包装一个可调用对象，返回结果也是可调用对象。</p>
<p>从partial生成的新函数，是对原函数的封装；偏函数可以固定住原函数的部分参数，从而在调用时更简单。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="comment"># 类classmethod装饰器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassMethod</span>:</span>   <span class="comment"># 怕冲突改名</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self._fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, cls)</span>:</span></span><br><span class="line">        ret = partial(self._fn, cls)  <span class="comment"># 使用partial函数把下面的clsmtd属性的cls参数固定住</span></span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @ClassMethod</span></span><br><span class="line">    <span class="comment"># clsmtd = ClassMethod(clsmtd)</span></span><br><span class="line">    <span class="comment"># 调用A.clsmtd() 或者 A().clsmtd()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clsmtd</span><span class="params">(cls)</span>:</span></span><br><span class="line">        print(cls.__name__)</span><br><span class="line">        </span><br><span class="line">print(A.__dict__)</span><br><span class="line">print(A.clsmtd)</span><br><span class="line">A.clsmtd()</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>对实例的数据进行校验</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name:str, age:int)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br></pre></td></tr></table></figure>
<p>对上面的类的实例的属性name、age进行数据校验</p>
<p>思路</p>
<ol>
<li>写函数，在<code>__init__</code>中先检查，如果不合格，直接抛异常</li>
<li>装饰器，使用<code>inspect</code>模块完成</li>
<li>描述器</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写函数检查</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name:str, age:int)</span>:</span></span><br><span class="line">        params = ((name, str),(age, int))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.checkdata(params):</span><br><span class="line">            <span class="keyword">raise</span> TypeError()</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkdata</span><span class="params">(self, params)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> p, t <span class="keyword">in</span> params:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> isinstance(p, t):</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        </span><br><span class="line">p = Person(<span class="string">'tom'</span>, <span class="number">20</span>)</span><br><span class="line">print(p.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'tom'</span>, <span class="string">'age'</span>: <span class="number">20</span>&#125;</span><br><span class="line"></span><br><span class="line">p = Person(<span class="string">'tom'</span>, <span class="string">'20'</span>)</span><br><span class="line">输出：</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">34</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    p = Person(<span class="string">'tom'</span>, <span class="string">'20'</span>)</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">21</span>, <span class="keyword">in</span> __init__</span><br><span class="line">    <span class="keyword">raise</span> TypeError()</span><br><span class="line">TypeError</span><br></pre></td></tr></table></figure>
<p>这种方法耦合度太高。</p>
<p>装饰器的方式，前面写过类似的，这里不再赘述。</p>
<p>描述器方式</p>
<p>需要使用数据描述器，写入实例属性的时候做检查</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typed</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, type)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.type = type</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> instance.__dict__[self.name]</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, self.type):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(value)</span><br><span class="line">        instance.__dict__[self.name] = value</span><br><span class="line"><span class="comment"># __set__方法不需要返回值，在下面实例化Typed()的过程中，将名称和类型传入Typed()，这时在__init__初始化后</span></span><br><span class="line"><span class="comment"># 会被__set__拦截，对数据与类型进行检查，如果数据不属于类型，就报错。否则就操作调用描述器的类的实例的字典，</span></span><br><span class="line"><span class="comment"># 将实例名称与值加入实例字典</span></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    name = Typed(<span class="string">'name'</span>, str)  <span class="comment"># 不优雅</span></span><br><span class="line">    age = Typed(<span class="string">'age'</span>, int)  <span class="comment"># 不优雅</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name:str, age:int)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">p = Person(<span class="string">'tom'</span>, <span class="number">20</span>)</span><br><span class="line">print(<span class="string">"p:&#123;&#125;, Person:&#123;&#125;"</span>.format(p.__dict__, Person.__dict__))</span><br><span class="line">输出：</span><br><span class="line">p:&#123;<span class="string">'name'</span>: <span class="string">'tom'</span>, <span class="string">'age'</span>: <span class="number">20</span>&#125;, Person:&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'name'</span>: &lt;__main__.Typed object at <span class="number">0x7f80696ff128</span>&gt;, <span class="string">'age'</span>: &lt;__main__.Typed object at <span class="number">0x7f80696ff470</span>&gt;, <span class="string">'__init__'</span>: &lt;function Person.__init__ at <span class="number">0x7f806974dae8</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">        </span><br><span class="line">p = Person(<span class="string">'tom'</span>, <span class="string">'20'</span>)</span><br><span class="line">输出：</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">62</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    p = Person(<span class="string">'tom'</span>, <span class="string">'20'</span>)</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">60</span>, <span class="keyword">in</span> __init__</span><br><span class="line">    self.age = age</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">51</span>, <span class="keyword">in</span> __set__</span><br><span class="line">    <span class="keyword">raise</span> TypeError(value)</span><br><span class="line">TypeError: <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>代码看似不错，但是有硬编码（所谓硬编码，hardcode，就是把一个本来应该（可以）写到配置信息中的信息直接在程序代码中写死了。在计算机程序或文本编辑中，hardcode(这个词比hard code用起来要频繁一些)是指将可变变量用一个固定值来代替的方法。），能否直接获取形参类型，使用<code>inspect</code>模块</p>
<p>先做个实验</p>
<p><code>params = inspect.signature(Person).parameters</code></p>
<p>看看返回什么结果</p>
<p>完整代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typed</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, type)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.type = type</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> instance.__dict__[self.name]</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, self.type):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(value)</span><br><span class="line">        instance.__dict__[self.name] = value</span><br><span class="line">        </span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">typeassert</span><span class="params">(cls)</span>:</span></span><br><span class="line">    params = inspect.signature(cls).parameters</span><br><span class="line"><span class="comment"># 使用inspect.signature(cls)拿到cls的参数，再用parameters将参数变为有序字典</span></span><br><span class="line">    print(<span class="number">1</span>, <span class="string">"params:&#123;&#125;"</span>.format(params))</span><br><span class="line">    <span class="keyword">for</span> name,param <span class="keyword">in</span> params.items():</span><br><span class="line">        print(<span class="number">2</span>, <span class="string">"name:&#123;&#125;, param:&#123;&#125;"</span>.format(param.name, param.annotation))</span><br><span class="line">        print(<span class="number">3</span>, <span class="string">"params.items:&#123;&#125;"</span>.format(params.items()))</span><br><span class="line"><span class="comment"># annotation是注解，也就是def __init__(self, name:str, age:int):中的str和int部分</span></span><br><span class="line">        <span class="keyword">if</span> param.annotation != param.empty:  <span class="comment"># 注入类属性，如果参数的注解不是空的</span></span><br><span class="line">            setattr(cls, name, Typed(name, param.annotation))</span><br><span class="line"><span class="comment"># 给cls添加name属性，属性的值是Typed(name, param.annotation)，用Typed()来检查传参是否合理</span></span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="comment"># 用typeassert()函数来代替上面的name = Typed('name', str)方法，但Person类初始化中一定要定义参数的注解</span></span><br><span class="line"><span class="comment"># 这样typeassert()才能拿到Person类的注解并进行传参的判断是否符合要求</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@typeassert</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="comment"># name = Typed('name', str)  # 装饰器注入</span></span><br><span class="line">    <span class="comment"># age = Typed('age', int)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name:str, age:int)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; is &#123;&#125;"</span>.format(self.name, self.age)</span><br><span class="line">    </span><br><span class="line">p = Person(<span class="string">'tom'</span>, <span class="string">'20'</span>)</span><br><span class="line">输出：</span><br><span class="line">OrderedDict([(<span class="string">'name'</span>, &lt;Parameter <span class="string">"name: str"</span>&gt;), (<span class="string">'age'</span>, &lt;Parameter <span class="string">"age: int"</span>&gt;)])</span><br><span class="line">name &lt;<span class="class"><span class="keyword">class</span> '<span class="title">str</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">age</span> &lt;<span class="title">class</span> '<span class="title">int</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">Traceback</span> <span class="params">(most recent call last)</span>:</span></span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">95</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    p = Person(<span class="string">'tom'</span>, <span class="string">'20'</span>)</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">90</span>, <span class="keyword">in</span> __init__</span><br><span class="line">    self.age = age</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">72</span>, <span class="keyword">in</span> __set__</span><br><span class="line">    <span class="keyword">raise</span> TypeError(value)</span><br><span class="line">TypeError: <span class="number">20</span></span><br><span class="line">    </span><br><span class="line">p = Person(<span class="string">'tom'</span>, <span class="number">20</span>)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span> params:OrderedDict([(<span class="string">'name'</span>, &lt;Parameter <span class="string">"name: str"</span>&gt;), (<span class="string">'age'</span>, &lt;Parameter <span class="string">"age: int"</span>&gt;)])</span><br><span class="line"><span class="number">2</span> name:name, param:&lt;<span class="class"><span class="keyword">class</span> '<span class="title">str</span>'&gt;</span></span><br><span class="line"><span class="class">3 <span class="title">params</span>.<span class="title">items</span>:</span>odict_items([(<span class="string">'name'</span>, &lt;Parameter <span class="string">"name: str"</span>&gt;), (<span class="string">'age'</span>, &lt;Parameter <span class="string">"age: int"</span>&gt;)])</span><br><span class="line"><span class="number">2</span> name:age, param:&lt;<span class="class"><span class="keyword">class</span> '<span class="title">int</span>'&gt;</span></span><br><span class="line"><span class="class">3 <span class="title">params</span>.<span class="title">items</span>:</span>odict_items([(<span class="string">'name'</span>, &lt;Parameter <span class="string">"name: str"</span>&gt;), (<span class="string">'age'</span>, &lt;Parameter <span class="string">"age: int"</span>&gt;)])</span><br><span class="line"></span><br><span class="line">print(p)</span><br><span class="line">输出：</span><br><span class="line">tom <span class="keyword">is</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>可以把上面的函数装饰器改为类装饰器，如何写？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typed</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, type)</span>:</span></span><br><span class="line">        self.type = type</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        print(<span class="string">'T.set'</span>, self, instance, value)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, self.type):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(value)</span><br><span class="line">            </span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TypeAssert</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,cls)</span>:</span></span><br><span class="line">        self.cls = cls  <span class="comment"># 记录着被包装的Person类</span></span><br><span class="line">        params = inspect.signature(self.cls).parameters</span><br><span class="line">        print(params)</span><br><span class="line">        <span class="keyword">for</span> name,param <span class="keyword">in</span> params.items():</span><br><span class="line">            print(name, param.annotation)</span><br><span class="line">            <span class="keyword">if</span> param.annotation != param.empty:</span><br><span class="line">                setattr(self.cls, name, Typed(param.annotation))  <span class="comment"># 注入类属性</span></span><br><span class="line">        print(self.cls.__dict__)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, name, age)</span>:</span></span><br><span class="line">        p = self.cls(name, age)   <span class="comment"># 重新构建一个新的Person对象</span></span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    </span><br><span class="line"><span class="meta">@TypeAssert</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span>  <span class="comment"># Person = TypeAssert(Person)</span></span><br><span class="line">    <span class="comment"># name = Typed(str)</span></span><br><span class="line">    <span class="comment"># age = Typed(int)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name:str, age:int)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">p1 = Person(<span class="string">'tom'</span>, <span class="number">18</span>)</span><br><span class="line">输出：</span><br><span class="line">OrderedDict([(<span class="string">'name'</span>, &lt;Parameter <span class="string">"name: str"</span>&gt;), (<span class="string">'age'</span>, &lt;Parameter <span class="string">"age: int"</span>&gt;)])</span><br><span class="line">name &lt;<span class="class"><span class="keyword">class</span> '<span class="title">str</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">age</span> &lt;<span class="title">class</span> '<span class="title">int</span>'&gt;</span></span><br><span class="line">&#123;'__module__': '__main__', '__init__': &lt;function Person.__init__ at 0x7f8f406122f0&gt;, '__dict__': &lt;attribute '__dict__' of 'Person' objects&gt;, '__weakref__': &lt;attribute '__weakref__' of 'Person' objects&gt;, '__doc__': None, 'name': &lt;__main__.Typed object at 0x7f8f40675550&gt;, 'age': &lt;__main__.Typed object at 0x7f8f40675588&gt;&#125;</span><br><span class="line">T.set &lt;__main__.Typed object at <span class="number">0x7f8f40675550</span>&gt; &lt;__main__.Person object at <span class="number">0x7f8f406754e0</span>&gt; tom</span><br><span class="line">T.set &lt;__main__.Typed object at <span class="number">0x7f8f40675588</span>&gt; &lt;__main__.Person object at <span class="number">0x7f8f406754e0</span>&gt; <span class="number">18</span></span><br><span class="line"></span><br><span class="line">print(id(p1))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">140668704855376</span></span><br><span class="line"></span><br><span class="line">p2 = Person(<span class="string">'tom'</span>, <span class="number">20</span>)</span><br><span class="line">输出：</span><br><span class="line">T.set &lt;__main__.Typed object at <span class="number">0x7fe71c590630</span>&gt; &lt;__main__.Person object at <span class="number">0x7fe71c5a8208</span>&gt; tom</span><br><span class="line">T.set &lt;__main__.Typed object at <span class="number">0x7fe71c590668</span>&gt; &lt;__main__.Person object at <span class="number">0x7fe71c5a8208</span>&gt; <span class="number">20</span></span><br><span class="line"></span><br><span class="line">print(id(p2))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">140285132751368</span></span><br><span class="line"></span><br><span class="line">p3 = Person(<span class="string">'tom'</span>, <span class="string">'20'</span>)</span><br><span class="line">输出：</span><br><span class="line">T.set &lt;__main__.Typed object at <span class="number">0x7fa3c8ad55c0</span>&gt; &lt;__main__.Person object at <span class="number">0x7fa3c8ad5550</span>&gt; tom</span><br><span class="line">T.set &lt;__main__.Typed object at <span class="number">0x7fa3c8ad55f8</span>&gt; &lt;__main__.Person object at <span class="number">0x7fa3c8ad5550</span>&gt; <span class="number">20</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">140</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    p3 = Person(<span class="string">'tom'</span>, <span class="string">'20'</span>)</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">125</span>, <span class="keyword">in</span> __call__</span><br><span class="line">    p = self.cls(name, age)  <span class="comment"># 重新构建一个新的Person对象</span></span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">134</span>, <span class="keyword">in</span> __init__</span><br><span class="line">    self.age = age</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/描述器/练习：对实例的数据进行校验.py"</span>, line <span class="number">109</span>, <span class="keyword">in</span> __set__</span><br><span class="line">    <span class="keyword">raise</span> ValueError(value)</span><br><span class="line">ValueError: <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>有一个无序序列[37, 99, 73, 48, 47, 40, 40, 25, 99, 51]，请先排序并打印输出。</p>
<p>分别尝试插入20、40、41到这个序列中合适的位置，保证其有序。</p>
<p>思路</p>
<p>排序后二分查找到适当位置插入数值。</p>
<p>排序使用sorted解决，假设升序输出。</p>
<p>查找插入点，使用二分查找完成。</p>
<p>假设全长为n，首先在大致的中点元素开始和待插入数比较，如果大则和右边的区域的中点继续比较，如果小则和左边的区域的中点进行比较，以此类推。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insert_sort</span><span class="params">(orderlist, i)</span>:</span></span><br><span class="line">    ret = orderlist[:]</span><br><span class="line">    low = <span class="number">0</span>  <span class="comment"># 索引最小值</span></span><br><span class="line">    high = len(orderlist) - <span class="number">1</span>  <span class="comment"># 索引最大值</span></span><br><span class="line">    <span class="keyword">while</span> low &lt; high:  <span class="comment"># 0 &lt; 9</span></span><br><span class="line">        mid = (low + high) // <span class="number">2</span>  <span class="comment"># 4</span></span><br><span class="line">        <span class="keyword">if</span> orderlist[mid] &lt; i:  <span class="comment"># 如果列表中中间部分的数字小于i，最小索引值就改成中间索引值加1</span></span><br><span class="line">            low = mid + <span class="number">1</span>  <span class="comment"># 说明i大，右边，限制下限</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid   <span class="comment"># 说明i不大于，左边，限制上限</span></span><br><span class="line"><span class="comment"># 以[25, 37, 40, 40, 47, 48, 51, 73, 99, 99]为例，第一次插入的是40，第一次进入循环时与47相比，</span></span><br><span class="line"><span class="comment"># high = mid，high = 4，第二次进入循环与索引值为2的40相比，还是high = mid，high = 2；第三次进入循环时</span></span><br><span class="line"><span class="comment"># 与37相比，这时符合orderlist[mid] &lt; i，low = mid + 1，这时low是 1 + 1 = 2，high也是2，不会再次进入</span></span><br><span class="line"><span class="comment"># 循环了，打印low的值2，ret.insert(2, i)。</span></span><br><span class="line">    print(low)   <span class="comment"># low为插入点</span></span><br><span class="line">    ret.insert(low, i)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">lst = [<span class="number">37</span>, <span class="number">99</span>, <span class="number">73</span>, <span class="number">48</span>, <span class="number">47</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">25</span>, <span class="number">99</span>, <span class="number">51</span>]</span><br><span class="line">newlst = sorted(lst)  <span class="comment"># [25, 37, 40, 40, 47, 48, 51, 73, 99, 99]</span></span><br><span class="line">r = newlst</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> (<span class="number">40</span>, <span class="number">20</span>, <span class="number">41</span>):</span><br><span class="line">    r = insert_sort(r, x)</span><br><span class="line">    print(<span class="number">3</span>, <span class="string">"r:&#123;&#125;"</span>.format(r))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">3</span> r:[<span class="number">25</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>]</span><br><span class="line"><span class="number">3</span> r:[<span class="number">20</span>, <span class="number">25</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>]</span><br><span class="line"><span class="number">3</span> r:[<span class="number">20</span>, <span class="number">25</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>]</span><br></pre></td></tr></table></figure>
<p>上面代码看似不错，请测试插入100。</p>
<p>问题来了，100插入的位置不对，为什么？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insert_sort</span><span class="params">(orderlist, i)</span>:</span></span><br><span class="line">    ret = orderlist[:]</span><br><span class="line">    low = <span class="number">0</span></span><br><span class="line">    high = len(orderlist)  <span class="comment"># 去掉减1，插入就正常了</span></span><br><span class="line">    <span class="keyword">while</span> low &lt; high:</span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> orderlist[mid] &lt; i:</span><br><span class="line">            low = mid + <span class="number">1</span> <span class="comment"># 说明i大，右边，限制下限</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid   <span class="comment"># 说明i不大于，左边，限制上限</span></span><br><span class="line">    print(<span class="number">2</span>, <span class="string">"low:&#123;&#125;"</span>.format(low))</span><br><span class="line">    ret.insert(low, i)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">lst = [<span class="number">37</span>, <span class="number">99</span>, <span class="number">73</span>, <span class="number">48</span>, <span class="number">47</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">25</span>, <span class="number">99</span>, <span class="number">51</span>]</span><br><span class="line">newlst = sorted(lst)</span><br><span class="line">r = newlst</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> (<span class="number">40</span>, <span class="number">20</span>, <span class="number">41</span>, <span class="number">100</span>):</span><br><span class="line">    r = insert_sort(r, x)</span><br><span class="line">    print(<span class="number">3</span>, <span class="string">"r:&#123;&#125;"</span>.format(r))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">2</span> low:<span class="number">2</span></span><br><span class="line"><span class="number">3</span> r:[<span class="number">25</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>]</span><br><span class="line"><span class="number">2</span> low:<span class="number">0</span></span><br><span class="line"><span class="number">3</span> r:[<span class="number">20</span>, <span class="number">25</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>]</span><br><span class="line"><span class="number">2</span> low:<span class="number">6</span></span><br><span class="line"><span class="number">3</span> r:[<span class="number">20</span>, <span class="number">25</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>]</span><br><span class="line"><span class="number">2</span> low:<span class="number">13</span></span><br><span class="line"><span class="number">3</span> r:[<span class="number">20</span>, <span class="number">25</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>, <span class="number">100</span>]</span><br></pre></td></tr></table></figure>
<p><code>high = len(orderlist)</code>，去掉减1不影响整除2，但影响下一行判断。</p>
<p><code>while low &lt; high</code>这一句<code>low</code>索引可以取到<code>length-1</code>了。原来只能取到<code>length-2</code>，所以一旦插入元素到尾部就出现问题了。</p>
<p>算法的核心，就是折半至重合为止。</p>
<h3 id="二分"><a href="#二分" class="headerlink" title="二分"></a>二分</h3><p>二分前提是有序，否则不可以二分。</p>
<p>二分查找算法的时间复杂度O(log n)</p>
<h3 id="bisect模块"><a href="#bisect模块" class="headerlink" title="bisect模块"></a>bisect模块</h3><p>Bisect模块提供的函数有：</p>
<ul>
<li><p><code>bisect.bisect_left(a, x, lo=0, hi=len(a)):</code></p>
<p>查找在有序列表a中插入x的index。lo和hi用于指定列表的区间，默认是使用整个列表。如果x已经存在，在其左边插入。返回值为index。从大到小</p>
</li>
<li><p><code>bisect.bisect_right(a, x, lo=0, hi=len(a))</code>或<code>bisect.bisect(a, x, lo=0, hi=len(a))</code></p>
<p>和<code>bisect_left</code>类似，但如果x已经存在，在其右边插入。从小到大</p>
</li>
<li><p><code>bisect.insort_left(a, x, lo=0, hi=len(a))</code></p>
<p>在有序列表a中插入x。等同于<code>a.insert(bisect.bisect_left(a, x, lo, hi), x)</code>。</p>
</li>
<li><p><code>bisect.insort_right(a, x, lo=0, hi=len(a))</code>或者<code>bisect.insort(a, x, lo=0, hi=len(a))</code></p>
<p>和<code>insort_left</code>函数类似，但如果x已经存在，在其右边插入。</p>
</li>
</ul>
<p>函数可以分2类：</p>
<p><code>bisect</code>系，用于查找index</p>
<p><code>Insort</code>系，用于实际插入</p>
<p>默认重复时从右边插入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bisect</span><br><span class="line"></span><br><span class="line">lst = [<span class="number">37</span>, <span class="number">99</span>, <span class="number">73</span>, <span class="number">48</span>, <span class="number">47</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">25</span>, <span class="number">99</span>, <span class="number">51</span>, <span class="number">100</span>]</span><br><span class="line"></span><br><span class="line">newlst = sorted(lst)  <span class="comment"># 升序</span></span><br><span class="line">print(newlst)  <span class="comment"># [25, 37, 40, 40, 47, 48, 51, 73, 99, 99, 100]</span></span><br><span class="line">print(list(enumerate(newlst)))</span><br><span class="line">输出：</span><br><span class="line">[<span class="number">25</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>, <span class="number">100</span>]</span><br><span class="line">[(<span class="number">0</span>, <span class="number">25</span>), (<span class="number">1</span>, <span class="number">37</span>), (<span class="number">2</span>, <span class="number">40</span>), (<span class="number">3</span>, <span class="number">40</span>), (<span class="number">4</span>, <span class="number">47</span>), (<span class="number">5</span>, <span class="number">48</span>), (<span class="number">6</span>, <span class="number">51</span>), (<span class="number">7</span>, <span class="number">73</span>), (<span class="number">8</span>, <span class="number">99</span>), (<span class="number">9</span>, <span class="number">99</span>), (<span class="number">10</span>, <span class="number">100</span>)]</span><br><span class="line"></span><br><span class="line">print(<span class="number">20</span>, bisect.bisect(newlst, <span class="number">20</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">20</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">print(<span class="number">30</span>, bisect.bisect(newlst, <span class="number">30</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">30</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">print(<span class="number">40</span>, bisect.bisect(newlst, <span class="number">40</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">40</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">print(<span class="number">20</span>, bisect.bisect_left(newlst, <span class="number">20</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">20</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">print(<span class="number">30</span>, bisect.bisect_left(newlst, <span class="number">30</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">30</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">print(<span class="number">40</span>, bisect.bisect_left(newlst, <span class="number">40</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">40</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> (<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">100</span>):</span><br><span class="line">    bisect.insort_left(newlst, x)</span><br><span class="line">    print(newlst)</span><br><span class="line">输出：</span><br><span class="line">[<span class="number">20</span>, <span class="number">25</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>, <span class="number">100</span>]</span><br><span class="line">[<span class="number">20</span>, <span class="number">25</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>, <span class="number">100</span>]</span><br><span class="line">[<span class="number">20</span>, <span class="number">25</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>, <span class="number">100</span>]</span><br><span class="line">[<span class="number">20</span>, <span class="number">25</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">99</span>, <span class="number">99</span>, <span class="number">100</span>, <span class="number">100</span>]</span><br></pre></td></tr></table></figure>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>判断学生成绩，成绩等级A-E，其中，90分以上为A，80-89为B，70-79为C，60-69为D，60分以下为E</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bisect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_grade</span><span class="params">(score)</span>:</span>  <span class="comment"># score就是传入的分数</span></span><br><span class="line">    breakpoints = [<span class="number">60</span>, <span class="number">70</span>, <span class="number">80</span>, <span class="number">90</span>]</span><br><span class="line">    grades = <span class="string">'EDCBA'</span></span><br><span class="line">    print(<span class="string">'index:&#123;&#125;'</span>.format(bisect.bisect(breakpoints, score)))</span><br><span class="line">    <span class="keyword">return</span> grades[bisect.bisect(breakpoints, score)]</span><br><span class="line"><span class="comment"># 返回bisect.bisect(breakpoints, score)是拿分数在breakpoints列表中查找索引值并返回，再使用索引值在grades中找对应的数据并返回</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> (<span class="number">91</span>, <span class="number">82</span>, <span class="number">77</span>, <span class="number">65</span>, <span class="number">50</span>, <span class="number">60</span>, <span class="number">70</span>):</span><br><span class="line">    print(<span class="string">'&#123;&#125; =&gt; &#123;&#125;'</span>.format(x, get_grade(x)))</span><br><span class="line">    </span><br><span class="line">输出：</span><br><span class="line">index:<span class="number">4</span></span><br><span class="line">91 =&gt; A</span><br><span class="line">index:<span class="number">3</span></span><br><span class="line">82 =&gt; B</span><br><span class="line">index:<span class="number">2</span></span><br><span class="line">77 =&gt; C</span><br><span class="line">index:<span class="number">1</span></span><br><span class="line">65 =&gt; D</span><br><span class="line">index:<span class="number">0</span></span><br><span class="line">50 =&gt; E</span><br><span class="line">index:<span class="number">1</span></span><br><span class="line">60 =&gt; D</span><br><span class="line">index:<span class="number">2</span></span><br><span class="line">70 =&gt; C</span><br></pre></td></tr></table></figure>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>将前面的链表，封装成容器</p>
<p>要求：</p>
<ol>
<li>提供<code>__getitem__</code>、<code>__iter__</code>、<code>__setitem__</code>方法</li>
<li>使用一个列表，辅助完成上面的方法</li>
<li>进阶：不使用列表，完成上面的方法</li>
</ol>
<p>进阶题</p>
<p>实现类property装饰器，类名称为Property。</p>
<p>基本结构如下，是一个数据描述器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Property</span>:</span>  <span class="comment"># 数据描述器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self._data = data</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @Property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._data</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @data.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self._data = value</span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="comment"># 讲解</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleNode</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, val, next=None, prev=None)</span>:</span>  </span><br><span class="line">        self.val = val</span><br><span class="line">        self.next = next   </span><br><span class="line">        self.prev = prev</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.val)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#    def __str__(self):</span></span><br><span class="line"><span class="comment">#        return str(self.val)  # __repr__和__str__都是为了打印使用</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="comment"># self.nodes = []   # 创建一个容器，放上面的元素。不能用set，有可能去重，另外set是无序的。对不需要插入的列表来说，</span></span><br><span class="line">    <span class="comment"># 检索方便，所以使用了列表。但是插入、remove不合适</span></span><br><span class="line">        self.head = <span class="keyword">None</span></span><br><span class="line">        self.tail = <span class="keyword">None</span></span><br><span class="line"><span class="comment"># 这里没有设计self.size是因为这个数据在多线程的情况下不会太准确  </span></span><br><span class="line">		self.size = <span class="number">0</span></span><br><span class="line">    	self.items = []  <span class="comment"># 我们是希望借助列表的查询能力</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">def</span> <span class="title">append</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        node = SingleNode(item)  <span class="comment"># 当前新增的数字</span></span><br><span class="line">        <span class="keyword">if</span> self.head <span class="keyword">is</span> <span class="keyword">None</span>:  </span><br><span class="line"><span class="comment"># 加第一个元素时才会到这里</span></span><br><span class="line">            self.head = node  <span class="comment"># 如果第一个元素是None，那么就把头设置为node</span></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 大于1个元素时进入这里</span></span><br><span class="line">            self.tail.next = node   <span class="comment"># 原来的尾部指向自己</span></span><br><span class="line">            node.prev = self.tail  <span class="comment"># 前一个指向尾部</span></span><br><span class="line"><span class="comment"># prev属性实际在node实例上，所以要改node实例，而不是self.prev。每次调用append方法时都要用到node实例，所以从第二次进来就要让</span></span><br><span class="line"><span class="comment"># 实例知道node的前一个数字是谁。</span></span><br><span class="line">        self.tail = node  <span class="comment"># 最后把自己修正成尾部</span></span><br><span class="line">		self.items.append(node)   <span class="comment"># 直接使用列表的append方法</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, index, item)</span>:</span>  <span class="comment"># 这只能实现从头或尾追加</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Wrong Index &#123;&#125;'</span>.format(index))</span><br><span class="line">        current = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">for</span> i,node <span class="keyword">in</span> enumerate(self.iternodes()):</span><br><span class="line">            <span class="keyword">if</span> i == index:</span><br><span class="line">                current = node</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 这里就是要用enumerate函数来确定index及其对应的值，最后赋值给current</span></span><br><span class="line">        <span class="keyword">if</span> current <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.append(item)</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line"><span class="comment"># 这里返回的是None，真正返回的内容已经在append方法中返回了。</span></span><br><span class="line"><span class="comment"># 什么情况下current会等于None？</span></span><br><span class="line">        prev = current.prev</span><br><span class="line">        node = SingleNode(val)</span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># 头部插入</span></span><br><span class="line">            self.head = node   <span class="comment"># 这就是在设置插入到头部了</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prev.next = node</span><br><span class="line">            node.prev = prev</span><br><span class="line">            </span><br><span class="line">        node.next = current</span><br><span class="line">        current.prev = node</span><br><span class="line">        </span><br><span class="line">        self.items.insert(index, node)</span><br><span class="line">       </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span>  <span class="comment"># 从尾部弹出一个</span></span><br><span class="line">        <span class="keyword">if</span> self.tail <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># 如果尾部是None，就抛异常。 == 0</span></span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Empty'</span>)</span><br><span class="line">        node = self.tail</span><br><span class="line">        item = node.item</span><br><span class="line">        prev = node.prev</span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># ==1。判断上面定义的tail和prev是否符合条件</span></span><br><span class="line">            self.head = <span class="keyword">None</span>   <span class="comment"># 如果前一个是None，就表示头是None，否则前一个应该有值</span></span><br><span class="line">            self.tail = <span class="keyword">None</span>   <span class="comment">#  头是None，就表示尾也是None。</span></span><br><span class="line"><span class="comment"># 当符合这个条件时就证明只有最后一个值了。再调用pop方法时头和尾就应该是None了。</span></span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># &gt; 1</span></span><br><span class="line">            self.tail = prev</span><br><span class="line">            prev.next = <span class="keyword">None</span></span><br><span class="line"><span class="comment"># 符合这个条件时，就是大小1个元素的时候，弹出一个元素后，尾部就应该变成尾部的前一个元素，前一个元素的下一个元素（也就是尾部）就应该变成None了，因为被弹出了。</span></span><br><span class="line">		self.items.pop()  <span class="comment"># 默认是-1，从最后一个弹出。元素数量已经在上面判断了</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.tail <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Empty'</span>)</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Wrong Index &#123;&#125;'</span>.format(index))</span><br><span class="line">            </span><br><span class="line">        current = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">for</span> i,node <span class="keyword">in</span> enumerate(self.iternodes()):</span><br><span class="line">            <span class="keyword">if</span> i == index:</span><br><span class="line">                current = node</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> current <span class="keyword">is</span> <span class="keyword">None</span>:   <span class="comment"># Not Found</span></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Wrong Index &#123;&#125;. Out of boundary'</span>.format(index))</span><br><span class="line">        </span><br><span class="line">        prev = current.prev</span><br><span class="line">        next = current.next</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">and</span> next <span class="keyword">is</span> <span class="keyword">None</span>: <span class="comment"># only on node</span></span><br><span class="line">            self.head = <span class="keyword">None</span></span><br><span class="line">            self.tail = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">elif</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.head = next</span><br><span class="line">            next.prev = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">elif</span> next <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.tail = prev</span><br><span class="line">            prev.next = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prev.next = next</span><br><span class="line">            next.prev = prev</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">del</span> current</span><br><span class="line">        self.items.pop(index)</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">iternodes</span><span class="params">(self, reverse=False)</span>:</span>  <span class="comment"># 暂时只能实现单向。iter表示生成器</span></span><br><span class="line">        current = self.tail <span class="keyword">if</span> reverse <span class="keyword">else</span> self.head</span><br><span class="line">        <span class="keyword">while</span> current:      </span><br><span class="line">            <span class="keyword">yield</span> current</span><br><span class="line">            current = current.prev <span class="keyword">if</span> reverse <span class="keyword">else</span> current.next</span><br><span class="line">            </span><br><span class="line">    <span class="comment"># 下面实现容器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.items)</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.items[index]  <span class="comment"># node</span></span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, index, value)</span>:</span></span><br><span class="line">        node = self[index]</span><br><span class="line">        node.item = value</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.iternodes()</span><br><span class="line">    </span><br><span class="line">test = LinkedList()</span><br><span class="line">print(test.__dict__)</span><br><span class="line">test.append(<span class="number">123</span>)</span><br><span class="line">print(test.append(<span class="number">233</span>))</span><br><span class="line">print(test.__dict__)</span><br><span class="line">print(test.items)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'head'</span>: <span class="keyword">None</span>, <span class="string">'tail'</span>: <span class="keyword">None</span>, <span class="string">'size'</span>: <span class="number">0</span>, <span class="string">'items'</span>: []&#125;</span><br><span class="line">&lt;__main__.LinkedList object at <span class="number">0x7f4f780374a8</span>&gt;</span><br><span class="line">&#123;<span class="string">'head'</span>: <span class="number">123</span>, <span class="string">'tail'</span>: <span class="number">233</span>, <span class="string">'size'</span>: <span class="number">0</span>, <span class="string">'items'</span>: [<span class="number">123</span>, <span class="number">233</span>]&#125;</span><br><span class="line">[<span class="number">123</span>, <span class="number">233</span>]</span><br><span class="line">==========================================================================================</span><br><span class="line"><span class="comment"># 同学实现</span></span><br><span class="line"><span class="string">"""节点类"""</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, data, prev=None, next=None)</span>:</span></span><br><span class="line">        self.data = data</span><br><span class="line">        self.prev = prev</span><br><span class="line">        self.next = next</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> repr(self.data)</span><br><span class="line"></span><br><span class="line"><span class="string">"""容器"""</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.head = <span class="keyword">None</span></span><br><span class="line">        self.tail = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"""获取长度"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        prev = self.head</span><br><span class="line">        length = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> prev:</span><br><span class="line">            length += <span class="number">1</span></span><br><span class="line">            prev = prev.next</span><br><span class="line">        <span class="keyword">return</span> length</span><br><span class="line"></span><br><span class="line">    <span class="string">"""追加节点"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        node = Node(item)</span><br><span class="line">        <span class="keyword">if</span> self.head <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.head = node</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.tail.next = node</span><br><span class="line">            node.prev = self.tail</span><br><span class="line">        self.tail = node</span><br><span class="line"></span><br><span class="line">    <span class="string">"""获取节点"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        index = index <span class="keyword">if</span> index &gt;= <span class="number">0</span> <span class="keyword">else</span> len(self) + index  <span class="comment"># 支持负索引</span></span><br><span class="line">        <span class="keyword">if</span> len(self) &lt; index:  <span class="comment"># 超界返回None</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        prev = self.head</span><br><span class="line">        <span class="keyword">while</span> index:</span><br><span class="line">            prev = prev.next</span><br><span class="line">            index -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> prev</span><br><span class="line"></span><br><span class="line">    <span class="string">"""插入节点"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, index, data)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        1. index 插入节点位置包括正负数</span></span><br><span class="line"><span class="string">        2. 找到index-1 --&gt; prev_node的节点</span></span><br><span class="line"><span class="string">        3. prev_node.next --&gt; node</span></span><br><span class="line"><span class="string">           node.next --&gt; prev_node.next.next</span></span><br><span class="line"><span class="string">        4. head</span></span><br><span class="line"><span class="string">        :param index</span></span><br><span class="line"><span class="string">        :param data</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        node = Node(data)</span><br><span class="line">        <span class="keyword">if</span> abs(index + <span class="number">1</span>) &gt; len(self):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        index = index <span class="keyword">if</span> index &gt;= <span class="number">0</span> <span class="keyword">else</span> len(self) + index + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">            node.nex = self.head</span><br><span class="line">            self.head = node</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            pre = self.__getitem__(index - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> pre:</span><br><span class="line">                nex = pre.nex</span><br><span class="line">                pre.nex = node</span><br><span class="line">                node.nex = nex</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">return</span> node</span><br><span class="line"></span><br><span class="line">    <span class="string">"""修改节点"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        node = self.__getitem__(key)</span><br><span class="line">        <span class="keyword">if</span> node:</span><br><span class="line">            node.data = value</span><br><span class="line">        <span class="keyword">return</span> node</span><br><span class="line"></span><br><span class="line">    <span class="string">"""迭代节点"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> iter(self.__iternodes())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iternodes</span><span class="params">(self, reverse=False)</span>:</span></span><br><span class="line">        current = self.tail <span class="keyword">if</span> reverse <span class="keyword">else</span> self.head</span><br><span class="line">        <span class="keyword">while</span> current:</span><br><span class="line">            <span class="keyword">yield</span> current</span><br><span class="line">            current = current.prev <span class="keyword">if</span> reverse <span class="keyword">else</span> current.next</span><br><span class="line"></span><br><span class="line">    <span class="string">"""迭代节点"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> ll.__iternodes():</span><br><span class="line">            print(i)</span><br><span class="line"></span><br><span class="line">    <span class="string">"""反转节点"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reversed</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> ll.__iternodes(reverse=<span class="keyword">True</span>):</span><br><span class="line">            print(i)</span><br><span class="line"></span><br><span class="line">    <span class="string">"""删除某个元素"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delete__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        f = index <span class="keyword">if</span> index &gt; <span class="number">0</span> <span class="keyword">else</span> abs(index + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> len(self) &lt;= f:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        prev = self.head</span><br><span class="line">        index = index <span class="keyword">if</span> index &gt;= <span class="number">0</span> <span class="keyword">else</span> len(self) + index</span><br><span class="line">        prep = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">while</span> index:</span><br><span class="line">            prep = prev</span><br><span class="line">            prev = prev.next</span><br><span class="line">            index -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> prep:</span><br><span class="line">            self.head = prev.next</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prep.next = prev.next</span><br><span class="line">        <span class="keyword">return</span> prev.data</span><br><span class="line"></span><br><span class="line">ll = LinkedList()</span><br><span class="line">ll.append(<span class="number">1</span>)</span><br><span class="line">ll.append(<span class="number">11</span>)</span><br><span class="line">ll.append(<span class="number">111</span>)</span><br><span class="line">ll.append(<span class="number">1111</span>)</span><br><span class="line">ll.append(<span class="number">11111</span>)</span><br><span class="line">ll.show()</span><br><span class="line">ll.reversed()</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">111</span></span><br><span class="line"><span class="number">1111</span></span><br><span class="line"><span class="number">11111</span></span><br><span class="line"><span class="number">11111</span></span><br><span class="line"><span class="number">1111</span></span><br><span class="line"><span class="number">111</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="comment"># 老师实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleNode</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, item, prev=None, next=None)</span>:</span></span><br><span class="line">        self.item = item</span><br><span class="line">        self.next = next</span><br><span class="line">        self.prev = prev</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> repr(self.item)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.head = <span class="keyword">None</span></span><br><span class="line">        self.tail = <span class="keyword">None</span></span><br><span class="line">        self.size = <span class="number">0</span>   <span class="comment"># 增加或减少时就开始计数</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.size</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        node = SingleNode(item)  <span class="comment"># 追加</span></span><br><span class="line">        <span class="keyword">if</span> self.head <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.head = node</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.tail.next = node</span><br><span class="line">            node.prev = self.tail</span><br><span class="line">        self.tail = node</span><br><span class="line"></span><br><span class="line">        self.size += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, index, item)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span>  ValueError(<span class="string">'Wrong Index &#123;&#125;'</span>.format(index))</span><br><span class="line">        current = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">for</span> i, node <span class="keyword">in</span> enumerate(self.iternodes()):</span><br><span class="line">            <span class="keyword">if</span> i == index:</span><br><span class="line">                current = node</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 没找到索引，就是超界了，可以直接抛出异常，也可以转成尾部追加</span></span><br><span class="line">        <span class="keyword">if</span> current <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.append(item)  <span class="comment"># 链表为空也可以加入</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># 找到了</span></span><br><span class="line">        node = SingleNode(item)</span><br><span class="line">        prev = current.prev</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># head node</span></span><br><span class="line">            self.head = node</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prev.next = node</span><br><span class="line">            node.prev = prev</span><br><span class="line"></span><br><span class="line">        node.next = current</span><br><span class="line">        current.prev = node</span><br><span class="line"></span><br><span class="line">        self.size += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.tail <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Empty'</span>)</span><br><span class="line">        node = self.tail</span><br><span class="line">        item = node.item</span><br><span class="line">        prev = node.prev</span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.head = <span class="keyword">None</span></span><br><span class="line">            self.tail = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prev.next = <span class="keyword">None</span></span><br><span class="line">            self.tail = prev</span><br><span class="line"></span><br><span class="line">        self.size -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.tail <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Empty'</span>)</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Wrong Index &#123;&#125;'</span>.format(index))</span><br><span class="line"></span><br><span class="line">        current = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">for</span> i, node <span class="keyword">in</span> enumerate(self.iternodes()):</span><br><span class="line">            <span class="keyword">if</span> i == index:</span><br><span class="line">                current = node</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> current <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># Not Found</span></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Wrong Index &#123;&#125; out of boundary'</span>.format(index))</span><br><span class="line"></span><br><span class="line">        prev = current.prev</span><br><span class="line">        next = current.next</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">and</span> next <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># only one node</span></span><br><span class="line">            self.head = <span class="keyword">None</span></span><br><span class="line">            self.tail = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">elif</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.head = next</span><br><span class="line">            next.prev = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">elif</span> next <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.tail = prev</span><br><span class="line">            prev.next = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prev.next = next</span><br><span class="line">            next.prev = prev</span><br><span class="line"></span><br><span class="line">        <span class="keyword">del</span> current</span><br><span class="line">        self.size -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">iternodes</span><span class="params">(self, reverse=False)</span>:</span></span><br><span class="line">        current = self.tail <span class="keyword">if</span> reverse <span class="keyword">else</span> self.head</span><br><span class="line">        <span class="keyword">while</span> current:</span><br><span class="line">            <span class="keyword">yield</span> current</span><br><span class="line">            current = current.prev <span class="keyword">if</span> reverse <span class="keyword">else</span> current.next</span><br><span class="line"></span><br><span class="line">    __iter__ = iternodes</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self[key].item = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i,node <span class="keyword">in</span> enumerate(self.iternodes(<span class="keyword">False</span> <span class="keyword">if</span> index &gt;= <span class="number">0</span> <span class="keyword">else</span> <span class="keyword">True</span>), <span class="number">0</span> <span class="keyword">if</span> index &gt;= <span class="number">0</span> <span class="keyword">else</span> <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> i == abs(index):</span><br><span class="line">                <span class="keyword">return</span> node</span><br><span class="line"></span><br><span class="line">abc = LinkedList()</span><br><span class="line">abc.append(<span class="number">123</span>)</span><br><span class="line">abc.append(<span class="number">234</span>)</span><br><span class="line">abc.append(<span class="number">345</span>)</span><br></pre></td></tr></table></figure>
<h3 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h3><p>描述器</p>
<p>用到了<code>__get__()</code>、<code>__set__()</code>、<code>__delete__()</code>三个方法中的一个创建的类就叫描述器。描述器与类属性有关</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()  <span class="comment"># B类被扫描完就会生成A实例</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        self.x = <span class="number">100</span></span><br><span class="line">    </span><br><span class="line">print(B.x.a1)</span><br><span class="line"></span><br><span class="line">b = B()</span><br><span class="line">print(B.x.a1)</span><br><span class="line"><span class="comment"># print(b.x.a1)  # 这会报异常，因为b.x是从实例的dict拿的，b.x是100，100没有a1属性</span></span><br><span class="line">print(b.x)</span><br><span class="line">输出：</span><br><span class="line">A.init</span><br><span class="line">a1</span><br><span class="line">B.init</span><br><span class="line">a1</span><br><span class="line"><span class="number">100</span></span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">'A.__get__'</span>,self, instance, owner)</span><br><span class="line">        <span class="keyword">return</span> self   <span class="comment"># 这里返回self，下面就可以使用b.x.a1了</span></span><br><span class="line"><span class="comment"># 加入__get__方法，现调用A类时，就会被这个方法拦截</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()  <span class="comment"># B类被扫描完就会生成A实例</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        <span class="comment"># self.x = 100</span></span><br><span class="line">        self.x = A()</span><br><span class="line">    </span><br><span class="line">print(B.x.a1) <span class="comment"># 如果上面的__get__方法没有return，会报错：AttributeError: 'NoneType' object has no attribute 'a1'</span></span><br><span class="line">print(B.x)  <span class="comment"># 这里打印的是None，因为__get__方法没有return，所以上面一句等于是在找None.a1，所以会报错。</span></span><br><span class="line">输出：</span><br><span class="line">A.init</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7fd61853da90</span>&gt; <span class="keyword">None</span> &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"># 第一段就是<span class="title">__get__</span>方法中的<span class="title">self</span>，第二段的<span class="title">None</span>是<span class="title">instance</span>的值，第三段是<span class="title">owner</span>，<span class="title">owner</span>表示描述器被谁用到</span></span><br><span class="line"><span class="class"># 了，用它来当做属性，<span class="title">owner</span>是类。当你通过一个属性去访问的时候，如果这个属性刚好是另一个类的实例，而且这个类</span></span><br><span class="line"><span class="class"># 又实现了描述器三个方法中的一个的话，那它就是描述器。也就是通过属性要访问描述器。当创建的描述器使用<span class="title">__get__</span></span></span><br><span class="line"><span class="class"># 方法时，第一个拿到的是它自己<span class="title">self</span>，还能拿到这个描述器属主相关的类型信息<span class="title">owner</span>，和属主相关的实例<span class="title">instance</span></span></span><br><span class="line"><span class="class"><span class="title">a1</span></span></span><br><span class="line"><span class="class"># 上面三行是<span class="title">print</span><span class="params">(B.x.a1)</span>输出的，下面是<span class="title">print</span><span class="params">(B.x)</span>输出的</span></span><br><span class="line"><span class="class"><span class="title">A</span>.<span class="title">__get__</span> &lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7fd61853da90</span>&gt; <span class="title">None</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7fd61853da90</span>&gt;  # 这是<span class="title">__get__</span>方法中<span class="title">return</span> <span class="title">self</span>的输出</span></span><br><span class="line"><span class="class"></span></span><br><span class="line">b = B()</span><br><span class="line">输出：</span><br><span class="line">A.init  <span class="comment"># 这是B类的x属性输出的</span></span><br><span class="line">B.init  <span class="comment"># 这是实例化B类时的输出</span></span><br><span class="line">A.init  <span class="comment"># 这是实例化B类时self.x的输出</span></span><br><span class="line"></span><br><span class="line">print(B.x.a1)  <span class="comment"># 如果__get__方法没有return，这里还是会报错，因为B.x返回的是None，None没有a1属性</span></span><br><span class="line">输出：</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7f4d58791a90</span>&gt; <span class="keyword">None</span> &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">a1</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">print</span><span class="params">(B.x)</span></span></span><br><span class="line"><span class="class"># <span class="title">print</span><span class="params">(b.x.a1)</span>  # 这会报异常，因为<span class="title">b</span>.<span class="title">x</span>是从实例的<span class="title">dict</span>拿的，<span class="title">b</span>.<span class="title">x</span>是100，100没有<span class="title">a1</span>属性</span></span><br><span class="line"><span class="class">输出：</span></span><br><span class="line"><span class="class"><span class="title">A</span>.<span class="title">__get__</span> &lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f3e353ffa90</span>&gt; <span class="title">None</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f3e353ffa90</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">print</span><span class="params">(b.x)</span></span></span><br><span class="line"><span class="class">输出：</span></span><br><span class="line"><span class="class"><span class="title">A</span>.<span class="title">__get__</span> &lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7fbc1a70ca90</span>&gt; &lt;<span class="title">__main__</span>.<span class="title">B</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7fbc1a738f40</span>&gt; &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7fbc1a70ca90</span>&gt;</span></span><br><span class="line"># 在B类初始化的设置中如果没有设置self.x = A()，就会使b实例访问B类的x属性，这时因为使用了b.x调用描述器，这时的instance有值了，查看b实例的字典中是没有x属性的</span><br><span class="line">&lt;__main__.A object at <span class="number">0x7f99d1059f70</span>&gt;</span><br><span class="line"><span class="comment"># 如果B类初始化的设置中使用了self.x = A()，当使用b.x时就是调用实例的x属性，就不会触发__get__方法。查看b实例的字典中有x属性。当使用实例调用x属性时，输出的instance就有值了</span></span><br><span class="line"></span><br><span class="line">当一个类的类属性等于另一个类的实例的时候，且被等于的这个类实现了三种方法中的一种，也就是被等于的类是描述器的</span><br><span class="line">话。如果通过类属性可以访问（可以是实例调用类属性），它就会触发get方法。如果是通过实例的属性访问它，就不会触</span><br><span class="line">发get方法。可以看一下上面B.x会触发，b.x不会触发。也就是，实例可以访问类属性，但类属性不会加到实例字典中，这</span><br><span class="line">符合字典的搜索顺序</span><br><span class="line">只有__get__是非数据描述器，有__get__和__set__是数据描述器。一定要作为人家的类属性访问</span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">'A.__get__'</span>,self, instance, owner)</span><br><span class="line">        <span class="keyword">return</span> self   <span class="comment"># 这里返回self，下面就可以使用b.x.a1了</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">'A.__set__'</span>, self, instance, value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()  <span class="comment"># B类被扫描完就会生成A实例</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        <span class="comment"># self.x = 100</span></span><br><span class="line">        self.x = A()</span><br><span class="line">        </span><br><span class="line">print(B.x)</span><br><span class="line">输出：</span><br><span class="line">A.init</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7f76206a1a90</span>&gt; <span class="keyword">None</span> &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f76206a1a90</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">print</span><span class="params">(B.x.a1)</span></span></span><br><span class="line"><span class="class">输出：</span></span><br><span class="line"><span class="class"><span class="title">A</span>.<span class="title">__get__</span> &lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f9b2ce55a90</span>&gt; <span class="title">None</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">a1</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line">b = B()</span><br><span class="line">输出：</span><br><span class="line">B.init</span><br><span class="line">A.init</span><br><span class="line">A.__set__ &lt;__main__.A object at <span class="number">0x7f67678a6a90</span>&gt; &lt;__main__.B object at <span class="number">0x7f67678c0490</span>&gt; &lt;__main__.A object at <span class="number">0x7f67678c0970</span>&gt;</span><br><span class="line"></span><br><span class="line">print(B.x)</span><br><span class="line">输出：</span><br><span class="line">A.__get__ &lt;__main__.A object at <span class="number">0x7f63a5c5da90</span>&gt; <span class="keyword">None</span> &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f63a5c5da90</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">print</span><span class="params">(b.x.a1)</span></span></span><br><span class="line"><span class="class">输出：</span></span><br><span class="line"><span class="class"><span class="title">A</span>.<span class="title">__get__</span> &lt;<span class="title">__main__</span>.<span class="title">A</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7fa23c0d8a90</span>&gt; &lt;<span class="title">__main__</span>.<span class="title">B</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7fa23c104fd0</span>&gt; &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">B</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">a1</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">print</span><span class="params">(b.__dict__)</span></span></span><br><span class="line"><span class="class">输出：</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="comment"># 可以看到，加入__set__方法后，b实例的字典中就没有x属性了，尽管在B类初始化时定义了x属性。如果没有定义__set__方法，b实例会有一个x属性。</span></span><br><span class="line"></span><br><span class="line">print(B.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'x'</span>: &lt;__main__.A object at <span class="number">0x7f626a321a90</span>&gt;, <span class="string">'__init__'</span>: &lt;function B.__init__ at <span class="number">0x7f626a2bd700</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'B'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'B'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"><span class="comment"># 当一个类的类属性是数据描述器的话（如上面的B类），对这个类的实例属性的操作，相当于操作类属性。如果是非数据</span></span><br><span class="line"><span class="comment"># 描述器，就是操作实例属性。也就是说数据描述器只能操作类属性。property()是数据描述器。建议少用类来操作属</span></span><br><span class="line"><span class="comment"># 性，要用实例来操作，也就是多使用非数据描述器。类中的所有方法都是非数据描述器</span></span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.init'</span>)</span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">'A.__get__'</span>,self, instance, owner)</span><br><span class="line">        <span class="keyword">return</span> self   <span class="comment"># 这里返回self，下面就可以使用b.x.a1了</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">'A.__set__'</span>, self, instance, value)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.init'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clsmtd</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stmtd</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age</span><br><span class="line">    </span><br><span class="line">print(B.__dict__)</span><br><span class="line">输出：</span><br><span class="line">A.init</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'x'</span>: &lt;__main__.A object at <span class="number">0x7f201e79ea90</span>&gt;, <span class="string">'__init__'</span>: &lt;function B.__init__ at <span class="number">0x7f201e73a700</span>&gt;, <span class="string">'clsmtd'</span>: &lt;classmethod object at <span class="number">0x7f201e7caf40</span>&gt;, <span class="string">'stmtd'</span>: &lt;staticmethod object at <span class="number">0x7f201e8001c0</span>&gt;, <span class="string">'age'</span>: &lt;property object at <span class="number">0x7f201e73f770</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'B'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'B'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"><span class="comment"># 'clsmtd': &lt;classmethod object at 0x7f201e7caf40&gt;这样的输出表示是描述器</span></span><br><span class="line"></span><br><span class="line">B().age = <span class="number">500</span></span><br></pre></td></tr></table></figure>
<p>练习</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 实现`StaticMethod`装饰器，完成`staticmethod`装饰器的功能</span><br><span class="line"><span class="number">2.</span> 实现`ClassMethod`装饰器，完成`classmethod`装饰器的功能</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaticMethod</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        print(fn)</span><br><span class="line">        self.fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(self, instance, owner)</span><br><span class="line">        <span class="keyword">return</span> self.fn</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassMethod</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        print(fn)</span><br><span class="line">        self.fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(self, instance, owner)</span><br><span class="line">        <span class="comment"># return self.fn(owner)  # 这样会返回异常，因为self.fn(owner)返回的是None</span></span><br><span class="line">        <span class="keyword">return</span> partial(self.fn, owner)  <span class="comment"># 这样就不会报错了</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @StaticMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span>  <span class="comment"># 因为foo = StaticMethod(foo)，所以A类的foo属性是StaticMethod类的实例，所以触发了StaticMethod类中的__get__方法</span></span><br><span class="line">        print(<span class="string">'static'</span>)</span><br><span class="line">    <span class="comment"># 上面三行代码实际等于foo = StaticMethod()这一行代码</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @ClassMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(cls)</span>:</span></span><br><span class="line">        print(cls.__name__)</span><br><span class="line">    </span><br><span class="line">A.foo()  <span class="comment"># 未来是要这样用的，先要拿到A.foo，然后才能使用A.foo()，也可以像下面这样</span></span><br><span class="line">f = A.foo  <span class="comment"># 调用A.foo时，后面的foo指向一个描述器，因为foo = StaticMethod(foo)，foo是StaticMethod的参数，因为在访问StaticMethod，所以会调用__get__方法</span></span><br><span class="line">print(f)  <span class="comment"># 结果显示A.foo触发了__get__方法</span></span><br><span class="line">输出：</span><br><span class="line">&lt;function A.foo at <span class="number">0x7f7af2ed9b70</span>&gt;</span><br><span class="line">&lt;function A.bar at <span class="number">0x7f7af2ed9c80</span>&gt;  <span class="comment"># 这两行是初始化中print(fn)输出的</span></span><br><span class="line">&lt;__main__.StaticMethod object at <span class="number">0x000000000000A745F8</span>&gt; <span class="keyword">None</span> &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">A</span>'&gt;</span></span><br><span class="line"><span class="class"># 结果说明触发了<span class="title">__get__</span>方法，第一段表示<span class="title">__get__</span>方法中的<span class="title">self</span>是<span class="title">StaticMethod</span>的实例；第二段因为没有实例，所以</span></span><br><span class="line"><span class="class"># 会返回<span class="title">None</span>；第三段的<span class="title">owner</span>是<span class="title">A</span>类。如果想返回的东西加括号就能用，上面的<span class="title">__get__</span>方法要返回<span class="title">self</span>.<span class="title">fn</span>，<span class="title">self</span>.<span class="title">fn</span></span></span><br><span class="line"><span class="class"># 保存着原来的<span class="title">foo</span>，被原封不动的返回来了，所以原来的<span class="title">foo</span>加括号是可以的</span></span><br><span class="line"><span class="class"><span class="title">static</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">StaticMethod</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x000000000000A745F8</span>&gt; <span class="title">None</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">A</span>'&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">f</span><span class="params">()</span></span></span><br><span class="line"><span class="class">输出：</span></span><br><span class="line"><span class="class"><span class="title">static</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line">f = A.bar</span><br><span class="line">输出：</span><br><span class="line">&lt;__main__.ClassMethod object at <span class="number">0x7f957abe04a8</span>&gt; <span class="keyword">None</span> &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">A</span>'&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">print</span><span class="params">(f)</span></span></span><br><span class="line"><span class="class">输出：</span></span><br><span class="line"><span class="class"><span class="title">functools</span>.<span class="title">partial</span><span class="params">(&lt;function A.bar at <span class="number">0x7f1f281d8c80</span>&gt;, &lt;class <span class="string">'__main__.A'</span>&gt;)</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">f</span><span class="params">(A)</span>  # 这等价于<span class="title">A</span>.<span class="title">bar</span><span class="params">(A)</span></span></span><br><span class="line"><span class="class">输出：</span></span><br><span class="line"><span class="class"><span class="title">TypeError</span>:</span> bar() takes <span class="number">1</span> positional argument but <span class="number">2</span> were given</span><br><span class="line"><span class="comment"># A.bar()只需要1个参数，这里却给了2个，所以报错</span></span><br><span class="line"></span><br><span class="line">f()</span><br><span class="line">输出：</span><br><span class="line">A</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name:str, age:int)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.checkdata(((<span class="string">'name'</span>,str),(<span class="string">'age'</span>,int))):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">raise</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkdata</span><span class="params">(self,)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> data, tp <span class="keyword">in</span> params:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> isinstance(data, tp):</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">            </span><br><span class="line">===============================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typed</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, type)</span>:</span></span><br><span class="line">        self.type = type</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        print(<span class="string">'T.set'</span>, self, instance, value)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, self.type):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(value)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    name = Typed(str)</span><br><span class="line">    age = Typed(int)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name:str, age:int)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">p1 = Person(<span class="string">'tom'</span>, <span class="number">18</span>)</span><br><span class="line">===============================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typed</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, type)</span>:</span></span><br><span class="line">        self.type = type</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        print(<span class="string">'T.set'</span>, self, instance, value)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, self.type):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TypeAssert</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cls)</span>:</span></span><br><span class="line">        self.cls = cls</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        params = inspect.signature(self.cls).parameters      </span><br><span class="line">		print(params)  <span class="comment"># 输出：(name:str, age:int)</span></span><br><span class="line">		<span class="keyword">for</span> name,param <span class="keyword">in</span> params.items():</span><br><span class="line">    		print(name, param.annotation)</span><br><span class="line">            <span class="keyword">if</span> param.annotation != param.empty:</span><br><span class="line">                setattr(self.cls, name, Typed(param.annotation))</span><br><span class="line">      </span><br><span class="line"><span class="meta">@TypeAssert    </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span>   <span class="comment"># Person = TypeAssert(Person)</span></span><br><span class="line">    <span class="comment"># name = Typed(str)</span></span><br><span class="line">    <span class="comment"># age = Typed(int)</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name:str, age:int)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">     </span><br><span class="line">p1 = Person(<span class="string">'tom'</span>, <span class="number">18</span>)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/python基础学习-魔术方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/python基础学习-魔术方法/" itemprop="url">
                  python基础学习-魔术方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-07 19:53:00" itemprop="dateCreated datePublished" datetime="2020-03-07T19:53:00+08:00">2020-03-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-07-28 14:38:04" itemprop="dateModified" datetime="2020-07-28T14:38:04+08:00">2020-07-28</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="特殊属性"><a href="#特殊属性" class="headerlink" title="特殊属性"></a>特殊属性</h3><table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__name__</code></td>
<td>类、函数、方法等的名字</td>
</tr>
<tr>
<td><code>__module__</code></td>
<td>类定义所在的模块名</td>
</tr>
<tr>
<td><code>__class__</code></td>
<td>对象或类所属的类</td>
</tr>
<tr>
<td><code>__bases__</code></td>
<td>类的基类的元组，顺序为它们在基类列表中出现的顺序</td>
</tr>
<tr>
<td><code>__doc__</code></td>
<td>类、函数的文档字符串，如果没有定义则为None</td>
</tr>
<tr>
<td><code>__mro__</code></td>
<td>类的<code>mro</code>, <code>class.mro()</code>返回的结果保存在<code>__mro__</code>中</td>
</tr>
<tr>
<td><code>__dict__</code></td>
<td>类或实例的属性，可写的字典</td>
</tr>
</tbody>
</table>
<h3 id="查看属性"><a href="#查看属性" class="headerlink" title="查看属性"></a>查看属性</h3><table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__dir__</code></td>
<td>返回类或者对象的所有成员名称列表。<code>dir()</code>函数就是调用<code>__dir__()</code>。如果提供<code>__dir__()</code>，则返回属性的列表，否则会尽量从<code>__dict__</code>属性中收集信息。</td>
</tr>
</tbody>
</table>
<p>如果<code>dir([obj])</code>参数<code>obj</code>包含方法<code>__dir__()</code>，该方法将被调用。如果参数<code>obj</code>不包含<code>__dir__()</code>，该方法将最大限度地收集参数信息。</p>
<p><code>dir()</code>对于不同类型的对象具有不同的行为：</p>
<p>如果对象是模块对象，返回的列表包含模块的属性名。</p>
<p>如果对象是类型或者类对象，返回的列表包含类的属性名，及它的基类的属性名。</p>
<p>否则，返回列表包含对象的属性名，它的类的属性名和类的基类的属性名。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># animal.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    x = <span class="number">123</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self._name = name</span><br><span class="line">        self.__age = <span class="number">10</span></span><br><span class="line">        self.weight = <span class="number">20</span></span><br><span class="line">print(<span class="string">'animal Module\'s names = &#123;&#125;'</span>.format(dir()))   <span class="comment"># 模块的属性</span></span><br><span class="line">输出：</span><br><span class="line">animal Module<span class="string">'s names = ['</span>Animal<span class="string">', '</span>__builtins__<span class="string">', '</span>__cached__<span class="string">', '</span>__doc__<span class="string">', '</span>__file__<span class="string">', '</span>__loader__<span class="string">', '</span>__name__<span class="string">', '</span>__package__<span class="string">', '</span>__spec__<span class="string">']</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat.py</span></span><br><span class="line"><span class="string">import animal</span></span><br><span class="line"><span class="string">from animal import Animal</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">class Cat(Animal):</span></span><br><span class="line"><span class="string">    x = '</span>cat<span class="string">'</span></span><br><span class="line"><span class="string">    y = '</span>abcd<span class="string">'</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">class Dog(Animal):</span></span><br><span class="line"><span class="string">    def __dir__(self):</span></span><br><span class="line"><span class="string">        return ['</span>dog<span class="string">']   # 必须返回可迭代对象</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">print('</span>------------<span class="string">')</span></span><br><span class="line"><span class="string">print('</span>Current Module\<span class="string">'s names = &#123;&#125;'</span>.format(dir()))   <span class="comment"># 模块名词空间内的属性</span></span><br><span class="line">输出：</span><br><span class="line">animal Module<span class="string">'s names = ['</span>Animal<span class="string">', '</span>__builtins__<span class="string">', '</span>__cached__<span class="string">', '</span>__doc__<span class="string">', '</span>__file__<span class="string">', '</span>__loader__<span class="string">', '</span>__name__<span class="string">', '</span>__package__<span class="string">', '</span>__spec__<span class="string">']</span></span><br><span class="line"><span class="string"># 因为导入了animal模块，所以这里又打印了一次，就是执行的animal模块中最后一行的print()语句</span></span><br><span class="line"><span class="string">-----------------------------------</span></span><br><span class="line"><span class="string">Current Module'</span>s name = [<span class="string">'Animal'</span>, <span class="string">'Cat'</span>, <span class="string">'Dog'</span>, <span class="string">'__annotations__'</span>, <span class="string">'__builtins__'</span>, <span class="string">'__cached__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__file__'</span>, <span class="string">'__loader__'</span>, <span class="string">'__name__'</span>, <span class="string">'__package__'</span>, <span class="string">'__spec__'</span>, <span class="string">'animal'</span>]</span><br><span class="line"></span><br><span class="line">print(<span class="string">'animal Module\'s names = &#123;&#125;'</span>.format(dir(animal)))   <span class="comment"># 指定模块名词空间内的属性</span></span><br><span class="line">输出：</span><br><span class="line">animal Module<span class="string">'s names = ['</span>Animal<span class="string">', '</span>__builtins__<span class="string">', '</span>__cached__<span class="string">', '</span>__doc__<span class="string">', '</span>__file__<span class="string">', '</span>__loader__<span class="string">', '</span>__name__<span class="string">', '</span>__package__<span class="string">', '</span>__spec__<span class="string">']</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print("object'</span>s __dict__    = &#123;&#125;<span class="string">".format(sorted(object.__dict__.keys()))) # object的字典</span></span><br><span class="line"><span class="string">输出：</span></span><br><span class="line"><span class="string">object's __dict__ = ['__class__', '__delattr__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__']</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print("</span>Animal<span class="string">'s dir() = &#123;&#125;".format(dir(Animal))) # 类Animal的dir()</span></span><br><span class="line"><span class="string">输出：</span></span><br><span class="line"><span class="string">Animal'</span>s dir() = [<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>, <span class="string">'x'</span>]</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Cat's dir()    = &#123;&#125;"</span>.format(dir(Cat)))   <span class="comment"># 类Cat的dir()</span></span><br><span class="line">输出：</span><br><span class="line">Cat<span class="string">'s dir() = ['</span>__class__<span class="string">', '</span>__delattr__<span class="string">', '</span>__dict__<span class="string">', '</span>__dir__<span class="string">', '</span>__doc__<span class="string">', '</span>__eq__<span class="string">', '</span>__format__<span class="string">', '</span>__ge__<span class="string">', '</span>__getattribute__<span class="string">', '</span>__gt__<span class="string">', '</span>__hash__<span class="string">', '</span>__init__<span class="string">', '</span>__init_subclass__<span class="string">', '</span>__le__<span class="string">', '</span>__lt__<span class="string">', '</span>__module__<span class="string">', '</span>__ne__<span class="string">', '</span>__new__<span class="string">', '</span>__reduce__<span class="string">', '</span>__reduce_ex__<span class="string">', '</span>__repr__<span class="string">', '</span>__setattr__<span class="string">', '</span>__sizeof__<span class="string">', '</span>__str__<span class="string">', '</span>__subclasshook__<span class="string">', '</span>__weakref__<span class="string">', '</span>x<span class="string">', '</span>y<span class="string">']</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print('</span>~~~~~~~~~~~~~~~~<span class="string">')</span></span><br><span class="line"><span class="string">tom = Cat('</span>tome<span class="string">')</span></span><br><span class="line"><span class="string">print(sorted(dir(tom))) # 实例tom的属性、Cat类及所有祖先类的类属性</span></span><br><span class="line"><span class="string">输出：</span></span><br><span class="line"><span class="string">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><br><span class="line"><span class="string">['</span>_Animal__age<span class="string">', '</span>__class__<span class="string">', '</span>__delattr__<span class="string">', '</span>__dict__<span class="string">', '</span>__dir__<span class="string">', '</span>__doc__<span class="string">', '</span>__eq__<span class="string">', '</span>__format__<span class="string">', '</span>__ge__<span class="string">', '</span>__getattribute__<span class="string">', '</span>__gt__<span class="string">', '</span>__hash__<span class="string">', '</span>__init__<span class="string">', '</span>__init_subclass__<span class="string">', '</span>__le__<span class="string">', '</span>__lt__<span class="string">', '</span>__module__<span class="string">', '</span>__ne__<span class="string">', '</span>__new__<span class="string">', '</span>__reduce__<span class="string">', '</span>__reduce_ex__<span class="string">', '</span>__repr__<span class="string">', '</span>__setattr__<span class="string">', '</span>__sizeof__<span class="string">', '</span>__str__<span class="string">', '</span>__subclasshook__<span class="string">', '</span>__weakref__<span class="string">', '</span>_name<span class="string">', '</span>weight<span class="string">', '</span>x<span class="string">', '</span>y<span class="string">']</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print(sorted(tom.__dir__()))   # 同上</span></span><br><span class="line"><span class="string"># dir()的等价，近似如下，__dict__字典中几乎包括了所有属性</span></span><br><span class="line"><span class="string">输出：</span></span><br><span class="line"><span class="string">['</span>_Animal__age<span class="string">', '</span>__class__<span class="string">', '</span>__delattr__<span class="string">', '</span>__dict__<span class="string">', '</span>__dir__<span class="string">', '</span>__doc__<span class="string">', '</span>__eq__<span class="string">', '</span>__format__<span class="string">', '</span>__ge__<span class="string">', '</span>__getattribute__<span class="string">', '</span>__gt__<span class="string">', '</span>__hash__<span class="string">', '</span>__init__<span class="string">', '</span>__init_subclass__<span class="string">', '</span>__le__<span class="string">', '</span>__lt__<span class="string">', '</span>__module__<span class="string">', '</span>__ne__<span class="string">', '</span>__new__<span class="string">', '</span>__reduce__<span class="string">', '</span>__reduce_ex__<span class="string">', '</span>__repr__<span class="string">', '</span>__setattr__<span class="string">', '</span>__sizeof__<span class="string">', '</span>__str__<span class="string">', '</span>__subclasshook__<span class="string">', '</span>__weakref__<span class="string">', '</span>_name<span class="string">', '</span>weight<span class="string">', '</span>x<span class="string">', '</span>y<span class="string">']</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print(sorted(set(tom.__dict__.keys()) | set(Cat.__dict__.keys()) | set(object.__dict__.keys())))</span></span><br><span class="line"><span class="string">输出：</span></span><br><span class="line"><span class="string">['</span>_Animal__age<span class="string">', '</span>__class__<span class="string">', '</span>__delattr__<span class="string">', '</span>__dir__<span class="string">', '</span>__doc__<span class="string">', '</span>__eq__<span class="string">', '</span>__format__<span class="string">', '</span>__ge__<span class="string">', '</span>__getattribute__<span class="string">', '</span>__gt__<span class="string">', '</span>__hash__<span class="string">', '</span>__init__<span class="string">', '</span>__init_subclass__<span class="string">', '</span>__le__<span class="string">', '</span>__lt__<span class="string">', '</span>__module__<span class="string">', '</span>__ne__<span class="string">', '</span>__new__<span class="string">', '</span>__reduce__<span class="string">', '</span>__reduce_ex__<span class="string">', '</span>__repr__<span class="string">', '</span>__setattr__<span class="string">', '</span>__sizeof__<span class="string">', '</span>__str__<span class="string">', '</span>__subclasshook__<span class="string">', '</span>_name<span class="string">', '</span>weight<span class="string">', '</span>x<span class="string">', '</span>y<span class="string">']</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print("Dog'</span>s dir = &#123;&#125;<span class="string">".format(dir(Dog)))</span></span><br><span class="line"><span class="string">输出：</span></span><br><span class="line"><span class="string">Dog's dir = ['__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__', 'x']</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">dog = Dog('snoppy')</span></span><br><span class="line"><span class="string">print(dir(dog))</span></span><br><span class="line"><span class="string">输出：</span></span><br><span class="line"><span class="string">['dog']</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print(dog.__dict__)</span></span><br><span class="line"><span class="string"># 执行结果</span></span><br><span class="line"><span class="string">&#123;'_name': 'snoppy', '_Animal__age': 10, 'weight': 20&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法 ***"></a>魔术方法 ***</h3><ul>
<li>分类<ul>
<li>创建、初始化与销毁<ul>
<li><code>__init__</code>与<code>__del__</code></li>
</ul>
</li>
<li>hash</li>
<li>bool</li>
<li>可视化</li>
<li>运算符重载</li>
<li>容器和大小</li>
<li>可调用对象</li>
<li>上下文管理</li>
<li>反射</li>
<li>描述器</li>
<li>其他杂项</li>
</ul>
</li>
</ul>
<h3 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h3><table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__hash__</code></td>
<td>内建函数<code>hash()</code>调用的返回值，返回一个整数。如果定义了这个方法，该类的实例就可hash。</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line">    </span><br><span class="line">print(hash(A(<span class="string">'tom'</span>)))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span>  <span class="comment"># 调用了__hash__方法</span></span><br><span class="line"></span><br><span class="line">print(A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>))</span><br><span class="line">输出：</span><br><span class="line">tom tom</span><br><span class="line"></span><br><span class="line">print([A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>)])</span><br><span class="line">输出：</span><br><span class="line">[tom, tom]</span><br><span class="line"></span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">s = &#123;A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>)&#125;   <span class="comment"># set</span></span><br><span class="line">print(s)   <span class="comment"># 去重了吗，没有</span></span><br><span class="line">输出：</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">&#123;tom, tom&#125;</span><br><span class="line"></span><br><span class="line">print(&#123;tuple(<span class="string">'t'</span>), tuple(<span class="string">'t'</span>)&#125;)</span><br><span class="line">输出：</span><br><span class="line">&#123;(<span class="string">'t'</span>,)&#125;</span><br><span class="line"></span><br><span class="line">print(&#123;(<span class="string">'tom'</span>,), (<span class="string">'tom'</span>,)&#125;)</span><br><span class="line">输出：</span><br><span class="line">&#123;(<span class="string">'tom'</span>,)&#125;</span><br><span class="line"></span><br><span class="line">print(&#123;<span class="string">'tom'</span>, <span class="string">'tom'</span>&#125;)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'tom'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>上例中<code>set</code>为什么不能剔除相同的<code>key</code>？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span>   <span class="comment"># 这个函数作用？</span></span><br><span class="line">        <span class="keyword">return</span> self.name == other.name</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line">    </span><br><span class="line">print(hash(A(<span class="string">'tom'</span>)))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line">print((A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>)))</span><br><span class="line">输出：</span><br><span class="line">tom tom</span><br><span class="line"></span><br><span class="line">print([A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>)])</span><br><span class="line">输出：</span><br><span class="line">[tom, tom]</span><br><span class="line"></span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">s = &#123;A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>)&#125;   <span class="comment"># set</span></span><br><span class="line">print(s)</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">&#123;tom&#125;</span><br><span class="line"></span><br><span class="line">print(&#123;tuple(<span class="string">'t'</span>), tuple(<span class="string">'t'</span>)&#125;)</span><br><span class="line">输出：</span><br><span class="line">&#123;(<span class="string">'t'</span>,)&#125;</span><br><span class="line"></span><br><span class="line">print(&#123;(<span class="string">'tom'</span>,), (<span class="string">'tom'</span>,)&#125;)</span><br><span class="line">输出：</span><br><span class="line">&#123;(<span class="string">'tom'</span>,)&#125;</span><br><span class="line"></span><br><span class="line">print(&#123;<span class="string">'tom'</span>, <span class="string">'tom'</span>&#125;)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'tom'</span>&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__eq__</code></td>
<td>对应<code>==</code>操作符，判断2个对象是否相等，返回<code>bool</code>值</td>
</tr>
</tbody>
</table>
<p><code>__hash__</code>方法只是返回一个hash值作为<code>set</code>的<code>key</code>，但是<code>去重</code>，还需要<code>__eq__</code>来判断两个对象是否相等。</p>
<p>hash值相等，只是hash冲突，不能说明两个对象是相等的。</p>
<p>因此，一般来说提供<code>__hash__</code>方法是为了作为<code>set</code>或者<code>dict</code>的<code>key</code>，所以<code>去重</code>要同时提供<code>__eq__</code>方法。</p>
<p>不可hash对象<code>isinstance(p1, collections.Hashable)</code>一定为False。</p>
<p><code>去重</code>需要提供<code>__eq__</code>方法。</p>
<p>思考：</p>
<p>list类实例为什么不可hash？</p>
<p>练习</p>
<p>设计二维坐标类Point，使其成为可hash类型，并比较2个坐标的实例是否相等？</p>
<p>list类实例为什么不可hash</p>
<p>源码中有一句<code>__hash__ = None</code>，也就是如果调用<code>__hash__()</code>相当于调用<code>None()</code>，一定报错。所有类都继承自<code>object</code>，而这个类是具有<code>__hash__()</code>方法的，如果一个类不能被hash，就把<code>__hash__</code>设置为<code>None</code>。</p>
<p>练习参考</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Hashable</span><br><span class="line"><span class="comment"># python3.7中要用from collections.abc import Hashable</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> hash((self.x, self.y))</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        print(<span class="string">'*'</span>*<span class="number">100</span>)</span><br><span class="line">        print(self.x, self.y, other.x, other.y)</span><br><span class="line"><span class="comment"># 调用这个方法时，如print(p1 == p2)，这里的p1就是self，p2就是other</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">p2 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(hash(p1))</span><br><span class="line">print(hash(p2))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">3713084879518070856</span></span><br><span class="line"><span class="number">3713084879518070856</span></span><br><span class="line"></span><br><span class="line">print(p1 <span class="keyword">is</span> p2)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">print(p1 == p2)   <span class="comment"># True使用__eq__</span></span><br><span class="line">输出：</span><br><span class="line">*******************************************************************************************</span><br><span class="line"><span class="number">4</span> <span class="number">5</span> <span class="number">4</span> <span class="number">5</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">print(hex(id(p1)), hex(id(p2)))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">0x7f1849e63400</span> <span class="number">0x7f1849e63438</span></span><br><span class="line"></span><br><span class="line">print(set((p1, p2)))</span><br><span class="line">输出：</span><br><span class="line">*******************************************************************************************</span><br><span class="line"><span class="number">4</span> <span class="number">5</span> <span class="number">4</span> <span class="number">5</span></span><br><span class="line">&#123;&lt;__main__.Point object at <span class="number">0x7f24f76af400</span>&gt;&#125;</span><br><span class="line"></span><br><span class="line">print(isinstance(p1, Hashable))</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<h3 id="bool"><a href="#bool" class="headerlink" title="bool"></a>bool</h3><table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__bool__</code></td>
<td>内建函数<code>bool()</code>，或者对象放在逻辑表达式的位置，调用这个函数返回布尔值。没有定义<code>__bool__()</code>，就找<code>__len__()</code>返回长度，非0为真。如果<code>__len__()</code>也没有定义，那么所有实例都返回真。</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 因为没有定义bool或len方法，所以返回全为真</span></span><br><span class="line">print(bool(A()))</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> A():  </span><br><span class="line">    print(<span class="string">'Real A'</span>)</span><br><span class="line">输出：</span><br><span class="line">Real A</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bool__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    </span><br><span class="line">print(bool(B))</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">print(bool(B()))</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> B():</span><br><span class="line">    print(<span class="string">'Real B'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>  <span class="comment"># return 0 就是 return False</span></span><br><span class="line">    </span><br><span class="line">print(bool(C()))</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> C():</span><br><span class="line">    print(<span class="string">'Real C'</span>)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<h3 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h3><table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__repr__</code></td>
<td>内建函数<code>repr()</code>对一个对象获取字符串表达。调用<code>__repr__</code>方法返回字符串表达，如果<code>__repr__</code>也没有定义，就直接返回<code>object</code>的定义就是显示内存地址信息</td>
</tr>
<tr>
<td><code>__str__</code></td>
<td><code>str()</code>函数、内建函数<code>format()</code>、<code>print()</code>函数调用，需要返回对象的字符串表达。如果没有定义，就去调用<code>__repr__</code>方法返回字符串表达，如果<code>__repr__</code>没有定义，就直接返回对象的内存地址信息</td>
</tr>
<tr>
<td><code>__bytes__</code></td>
<td><code>bytes()</code>函数调用，返回一个对象的<code>bytes</code>表达，即返回<code>bytes</code>对象</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'repr: &#123;&#125;,&#123;&#125;'</span>.format(self.name, self.age)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'str: &#123;&#125;,&#123;&#125;'</span>.format(self.name, self.age)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bytes__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># return "&#123;&#125; is &#123;&#125;".format(self.name, self.age).encode()</span></span><br><span class="line">        <span class="keyword">import</span> json</span><br><span class="line">        <span class="keyword">return</span> json.dumps(self.__dict__).encode()</span><br><span class="line">    </span><br><span class="line">print(A(<span class="string">'tom'</span>))   <span class="comment"># print函数使用__str__</span></span><br><span class="line">输出：</span><br><span class="line">str: tom,<span class="number">18</span></span><br><span class="line">    </span><br><span class="line">print([A(<span class="string">'tom'</span>)])   <span class="comment"># []使用__str__，但其内部使用__repr__</span></span><br><span class="line">输出：</span><br><span class="line">[repr: tom,<span class="number">18</span>]</span><br><span class="line"></span><br><span class="line">print(([str(A(<span class="string">'tom'</span>))]))   <span class="comment"># []使用__str__，str()函数也使用__str__</span></span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'str: tom,18'</span>]</span><br><span class="line"></span><br><span class="line">print(<span class="string">'str:a,1'</span>)   <span class="comment"># 字符串直接输出没有引号</span></span><br><span class="line">输出：</span><br><span class="line">str:a,<span class="number">1</span></span><br><span class="line">    </span><br><span class="line">s = <span class="string">'1'</span></span><br><span class="line">print(s)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line">print([<span class="string">'a'</span>],(s,))   <span class="comment"># 字符串在基本数据类型内部输出有引号</span></span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'a'</span>] (<span class="string">'1'</span>,)</span><br><span class="line"></span><br><span class="line">print(&#123;s, <span class="string">'a'</span>&#125;)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'1'</span>, <span class="string">'a'</span>&#125;</span><br><span class="line"></span><br><span class="line">print(bytes(A(<span class="string">'tom'</span>)))</span><br><span class="line">输出：</span><br><span class="line"><span class="string">b'tom is 18'</span></span><br></pre></td></tr></table></figure>
<h3 id="运算符重载"><a href="#运算符重载" class="headerlink" title="运算符重载"></a>运算符重载</h3><p><code>operator</code>模块提供以下的特殊方法，可以将类的实例使用下面的操作符来操作</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>特殊方法</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt;, &lt;=, ==, &gt;, &gt;=, !=</td>
<td><code>__lt__</code>, <code>__le__</code>, <code>__eq__</code>, <code>__gt__</code>, <code>__ge__</code>, <code>__ne__</code></td>
<td>比较运算符</td>
</tr>
<tr>
<td>+, -, *, /, %, //, **, divmod</td>
<td><code>__add__</code>, <code>__sub__</code>, <code>__mul__</code>, <code>__truediv__</code>, <code>__mod__</code>, <code>__floordiv__</code>, <code>__pow__</code>, <code>__divmod__</code></td>
<td>算术运算符，移位、位运算也有对应的方法</td>
</tr>
<tr>
<td>+=, -=, *=, /=, %=, //=, **=</td>
<td><code>__iadd__</code>, <code>__isub__</code>, <code>__imul__</code>, <code>__itruediv__</code>, <code>__imod__</code>, <code>__ifloordiv__</code>, <code>__ipow__</code></td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age - other.age</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__isub__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> A(self.name, self - other)</span><br><span class="line">    </span><br><span class="line">tom = A(<span class="string">'tom'</span>)</span><br><span class="line">jerry = A(<span class="string">'jerry'</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">print(tom - jerry)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">2</span></span><br><span class="line"></span><br><span class="line">print(jerry - tom, jerry.__sub__(tom))  <span class="comment"># 这两种方法是一个意思</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">-2</span> <span class="number">-2</span></span><br><span class="line"></span><br><span class="line">print(id(tom))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">139892835034168</span></span><br><span class="line"></span><br><span class="line">tom -= jerry</span><br><span class="line">print(tom.age, id(tom))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">2</span> <span class="number">139875563156648</span></span><br><span class="line"><span class="comment"># tom -= jerry后tom.age变了，tom的内存地址也变了</span></span><br></pre></td></tr></table></figure>
<p>练习：</p>
<p>完成<code>Point</code>类设计，实现判断点相等的方法，并完成向量的加法。</p>
<p>在直角坐标系里面，定义原点为向量的起点。两个向量的和与差的坐标分别等于这两个向量相应坐标的和与差，若向量的表示为<code>(x,y)</code>形式，<code>A(X1, Y1) B(X2, Y2)</code>，则<code>A+B=(X1+X2, Y1+Y2), A-B=(X1-X2, Y1-Y2)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Point(self.x + other.x, self.y + other.y)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (self.x + other.x, self.y + other.y)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;Point: &#123;&#125;,&#123;&#125;'</span>.format(self.x, self.y)</span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">p2 = Point(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">points = (p1, p2)</span><br><span class="line">print(points)</span><br><span class="line">输出：</span><br><span class="line">(&lt;__main__.Point object at <span class="number">0x7f95e7e52438</span>&gt;, &lt;__main__.Point object at <span class="number">0x7f95e7e52470</span>&gt;)</span><br><span class="line"></span><br><span class="line">print(points[<span class="number">0</span>].add(points[<span class="number">1</span>]))  <span class="comment"># add方法就是运算符重载</span></span><br><span class="line">输出：</span><br><span class="line">(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line"><span class="comment"># points[0]和points[1]都是&lt;Point: 1,1&gt;</span></span><br><span class="line">print(points[<span class="number">0</span>] + points[<span class="number">1</span>])  <span class="comment"># 这个方法与print(points[0].add(points[1]))是一个意思，但输出时调用的方法是__str__方法，所以输出与print(points[0].add(points[1]))不太一样</span></span><br><span class="line">输出：</span><br><span class="line">&lt;Point: <span class="number">2</span>,<span class="number">2</span>&gt;</span><br><span class="line">    </span><br><span class="line">print(p1 == p2)  <span class="comment"># 因为比较的是数值，所以返回True，如果是p1 is p2，返回的就是False了</span></span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<h4 id="运算符重载应用场景"><a href="#运算符重载应用场景" class="headerlink" title="运算符重载应用场景"></a>运算符重载应用场景</h4><p>往往是用面向对象实现的类，需要做大量的运算，而运算符是这种运算在数学上最常见的表达方式。例如，上例中的对<code>+</code>进行了运算符重载，实现了<code>Point</code>类的二元操作，重新定义为<code>Point + Point</code>。</p>
<p>提供运算符重载，比直接提供加法方法要更加适合该领域内使用者的习惯。</p>
<p><code>int</code>类，几乎实现了所有操作符，可以作为参考。</p>
<h3 id="functools-total-ordering-装饰器"><a href="#functools-total-ordering-装饰器" class="headerlink" title="@functools.total_ordering 装饰器"></a>@functools.total_ordering 装饰器</h3><p><code>__lt__</code>, <code>__le__</code>, <code>__eq__</code>, <code>__gt__</code>, <code>__ge__</code>是比较大小必须实现的方法，但是全部写完太麻烦，使用<a href="mailto:`@functools.tota" target="_blank" rel="noopener">`@functools.tota</a>l_ordering`装饰器就可以大大简化代码。</p>
<p>但是要求<code>__eq__</code>必须实现，其它方法<code>__lt__</code>, <code>__le__</code>, <code>__gt__</code>, <code>__ge__</code>实现其一</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> total_ordering</span><br><span class="line"></span><br><span class="line"><span class="meta">@total_ordering</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age == other.age</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age &gt; other.age</span><br><span class="line">    </span><br><span class="line">tom = Person(<span class="string">'tom'</span>, <span class="number">20</span>)</span><br><span class="line">jerry = Person(<span class="string">'jerry'</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">print(tom &gt; jerry)</span><br><span class="line">print(tom &lt; jerry)</span><br><span class="line">print(tom &gt;= jerry)</span><br><span class="line">print(tom &lt;= jerry)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>上例中大大简化代码，但是一般来说比较实现等于或者小于方法也就够了，其它可以不实现，所以这个装饰器只是看着很美好，且可能会带来性能问题，建议需要什么方法就自己创建，少用这个装饰器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age == other.age</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age &gt; other.age</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__ge__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age &gt;= other.age</span><br><span class="line">    </span><br><span class="line">tom = Person(<span class="string">'tom'</span>, <span class="number">20</span>)</span><br><span class="line">jerry = Person(<span class="string">'jerry'</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">print(tom &gt; jerry)</span><br><span class="line">print(tom &lt; jerry)</span><br><span class="line">print(tom &gt;= jerry)</span><br><span class="line">print(tom &lt;= jerry)</span><br><span class="line">print(tom == jerry)</span><br><span class="line">print(tom != jerry)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<h3 id="容器相关方法"><a href="#容器相关方法" class="headerlink" title="容器相关方法"></a>容器相关方法</h3><table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__len__</code></td>
<td>内建函数<code>len()</code>，返回对象的长度（&gt;=0的整数），如果把对象当做容器类型看，就如同list或者dict。<code>bool()</code>函数调用的时候，如果没有<code>__bool__()</code>方法，则会看<code>__len__()</code>方法是否存在，存在返回非0为真</td>
</tr>
<tr>
<td><code>__iter__</code></td>
<td>迭代容器时调用，返回一个新的迭代器对象</td>
</tr>
<tr>
<td><code>__contains__</code></td>
<td><code>in</code>成员运算符，没有实现，就调用<code>__iter__</code>方法遍历</td>
</tr>
<tr>
<td><code>__getitem__</code></td>
<td>实现<code>self[key]</code>访问。序列对象，<code>key</code>接受整数为索引，或者切片。对于set和dict，key为hashable。key不存在引发KeyError异常</td>
</tr>
<tr>
<td><code>__setitem__</code></td>
<td>和<code>__getitem__</code>的访问类似，是设置值的方法</td>
</tr>
<tr>
<td><code>__missing__</code></td>
<td>字典或其子类使用<code>__getitem__()</code>调用时，key不存在执行该方法</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(dict)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__missing__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        print(<span class="string">'Missing key :'</span>, key)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">a = A()</span><br><span class="line">print(a[<span class="string">'k'</span>])</span><br><span class="line">输出：</span><br><span class="line">Missing key : k</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>思考</p>
<p>为什么空字典、空字符串、空元组、空集合、空列表等可以等效为False？</p>
<p>练习</p>
<p>将购物车类改造成方便操作的容器类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cart</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.items = []</span><br><span class="line"><span class="comment"># 在初始化时自定义self.items = []，这样就定义了一个列表，之后用self.items就可以打印整个列表，self.items.append()可以向列表中添加内容。     </span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">additem</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        self.items.append(item)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> iter(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span>   <span class="comment"># 索引访问</span></span><br><span class="line">        <span class="keyword">return</span> self.items[index]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span>   <span class="comment"># 索引赋值</span></span><br><span class="line">        self.items[key] = value</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span> <span class="comment"># +</span></span><br><span class="line">        self.items.append(other)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">cart = Cart()</span><br><span class="line">cart.additem(<span class="number">1</span>)</span><br><span class="line">cart.additem(<span class="string">'abc'</span>)</span><br><span class="line">cart.additem(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 长度、bool</span></span><br><span class="line">print(len(cart))</span><br><span class="line">print(bool(cart))</span><br><span class="line">print(cart)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line">[<span class="number">1</span>, <span class="string">'abc'</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 迭代</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> cart:</span><br><span class="line">    print(x)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line">abc</span><br><span class="line"><span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># in</span></span><br><span class="line">print(<span class="number">3</span> <span class="keyword">in</span> cart)</span><br><span class="line">print(<span class="number">2</span> <span class="keyword">in</span> cart)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引操作</span></span><br><span class="line">print(cart[<span class="number">1</span>])</span><br><span class="line">cart[<span class="number">1</span>] = <span class="string">'xyz'</span></span><br><span class="line">print(cart)</span><br><span class="line">输出：</span><br><span class="line">abc</span><br><span class="line">[<span class="number">1</span>, <span class="string">'xyz'</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链式编程实现加法</span></span><br><span class="line">print(cart + <span class="number">4</span> + <span class="number">5</span> + <span class="number">6</span>)</span><br><span class="line">print(cart.__add__(<span class="number">17</span>).__add__(<span class="number">18</span>))</span><br><span class="line">输出：</span><br><span class="line">[<span class="number">1</span>, <span class="string">'xyz'</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">[<span class="number">1</span>, <span class="string">'xyz'</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">17</span>, <span class="number">18</span>]</span><br></pre></td></tr></table></figure>
<h3 id="可调用对象"><a href="#可调用对象" class="headerlink" title="可调用对象"></a>可调用对象</h3><p>Python中一切皆对象，函数也不例外。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(foo.__module__, foo.__name__)</span><br><span class="line">    </span><br><span class="line">foo()</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">foo.__call__()</span><br><span class="line">输出：</span><br><span class="line">__main__ foo</span><br><span class="line">__main__ foo</span><br></pre></td></tr></table></figure>
<p>函数即对象，对象<code>foo</code>加上<code>()</code>，就是调用对象的<code>__call__()</code>方法</p>
<p>可调用对象</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__call__</code></td>
<td>类中定义一个该方法，实例就可以像函数一样调用</td>
</tr>
</tbody>
</table>
<p>可调用对象：定义一个类，并实例化得到其实例，将实例像函数一样调用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;Point &#123;&#125;:&#123;&#125;&gt;"</span>.format(self.x, self.y)</span><br><span class="line">    </span><br><span class="line">p = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p)</span><br><span class="line">print(p())</span><br><span class="line">输出：</span><br><span class="line">&lt;__main__.Point object at <span class="number">0x7fd3b9770a90</span>&gt;</span><br><span class="line">&lt;Point <span class="number">4</span>:<span class="number">5</span>&gt;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Adder</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">        ret = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> args:</span><br><span class="line">            ret += x</span><br><span class="line">        self.ret = ret  <span class="comment"># 这一条是给adder.ret使用的</span></span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    </span><br><span class="line">adder = Adder()</span><br><span class="line">print(adder(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line">print(adder.ret)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">15</span></span><br></pre></td></tr></table></figure>
<p>练习：</p>
<p>定义一个斐波那契数列的类，方便调用，计算第n项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fib</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.items = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">'Wrong Index'</span>)</span><br><span class="line">        <span class="keyword">if</span> index &lt; len(self.items):</span><br><span class="line">            <span class="keyword">return</span> self.items[index]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>, index+<span class="number">1</span>):</span><br><span class="line">            self.items.append(self.items[i<span class="number">-1</span>] + self.items[i<span class="number">-2</span>])</span><br><span class="line">     	<span class="keyword">return</span> self.items[index]</span><br><span class="line">    </span><br><span class="line">print(Fib()(<span class="number">100</span>))</span><br></pre></td></tr></table></figure>
<p>上例中，增加迭代的方法、返回容器长度、支持索引的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fib</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.items = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self[index]</span><br><span class="line"><span class="comment"># 当使用fib(5)，这样调用时，会调用call方法，之后会返回self[index]，self[index]会调用getitem方法，返回</span></span><br><span class="line"><span class="comment"># 实际的数字。也就是说，使用fib(5)时，返回self[index]，这会再次调用__getitem__方法，返回</span></span><br><span class="line"><span class="comment"># self.items[index]，所以使用fib(5)实际返回的是self.items[index]对应的数字</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> iter(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">'Wrong Index'</span>)</span><br><span class="line">        <span class="keyword">if</span> index &lt; len(self.items):</span><br><span class="line">            <span class="keyword">return</span> self.items[index]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(self), index+<span class="number">1</span>):</span><br><span class="line">            self.items.append(self.items[i<span class="number">-1</span>] + self.items[i<span class="number">-2</span>])</span><br><span class="line">        <span class="keyword">return</span> self.items[index]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.items)</span><br><span class="line">    </span><br><span class="line">    __repr__ = __str__</span><br><span class="line">    </span><br><span class="line">fib = Fib()  <span class="comment"># 实例化时就有了items属性，所以下面迭代fib时，调用的是__iter__方法，返回的是iter(self.items)</span></span><br><span class="line">print(fib(<span class="number">5</span>), len(fib))   <span class="comment"># 全部计算</span></span><br><span class="line">print(fib(<span class="number">10</span>), len(fib))   <span class="comment"># 部分计算</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> fib:</span><br><span class="line">    print(x)</span><br><span class="line">print(fib[<span class="number">5</span>], fib[<span class="number">6</span>])  <span class="comment"># 索引访问 ，不计算。使用索引直接调用__getitem__方法，计算出索引位置的值。</span></span><br></pre></td></tr></table></figure>
<p>可以看出使用类来实现斐波那契数列也是非常好的实现，还可以缓存数据，便于检索。</p>
<h3 id="上下文管理"><a href="#上下文管理" class="headerlink" title="上下文管理"></a>上下文管理</h3><p>文件IO操作可以对文件对象使用上下文管理，使用<code>with...as</code>语法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'test'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>依照上例写一个自己的类，实现上下文管理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> p:   <span class="comment">#  AttributeError: __exit__</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>提示属性错误，没有<code>__exit__</code>，看来需要这个属性</p>
<h3 id="上下文管理对象"><a href="#上下文管理对象" class="headerlink" title="上下文管理对象"></a>上下文管理对象</h3><p>当一个对象同时实现了<code>__enter__()</code>和<code>__exit__()</code>方法，它就属于上下文管理的对象</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__enter__</code></td>
<td>进入与此对象相关的上下文 。如果存在该方法，<code>with</code>语法会把该方法的返回值绑定到<code>as</code>子句中指定的变量上</td>
</tr>
<tr>
<td><code>__exit__</code></td>
<td>退出与此对象相关的上下文</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> f:</span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">enter</span><br><span class="line">do sth</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p>实例化对象的时候，并不会调用<code>enter</code>，进入<code>with</code>语句块应用<code>__enter__</code>方法，然后执行语句体，最后离开<code>with</code>语句块的时候，调用<code>__exit__</code>方法。</p>
<p><code>with</code>可以开启一个上下文运行环境，在执行前做一些准备工作，执行后做一些收尾工作。</p>
<h3 id="上下文管理的安全性"><a href="#上下文管理的安全性" class="headerlink" title="上下文管理的安全性"></a>上下文管理的安全性</h3><p>看看异常对上下文的影响</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">'error'</span>)</span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br><span class="line">    </span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">enter</span><br><span class="line">exit</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/魔术方法/上下文管理课上练习.py"</span>, line <span class="number">25</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">'error'</span>)</span><br><span class="line">Exception: error</span><br></pre></td></tr></table></figure>
<p>可以看出在<code>enter</code>和<code>exit</code>照样执行，上下文管理是安全的。</p>
<p>极端的例子</p>
<p>调用<code>sys.exit()</code>，它会退出当前解释器。</p>
<p>打开Python解释器，在里面敲入<code>sys.exit()</code>，窗口直接关闭了。也就是说碰到这一句，Python运行环境直接退出了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> f:</span><br><span class="line">    sys.exit(<span class="number">-100</span>)</span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br><span class="line">    </span><br><span class="line">print(<span class="string">'outer'</span>)</span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">enter</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p>从执行结果来看，依然执行了<code>__exit__</code>函数，哪怕是退出Python运行环境。</p>
<p>说明<strong>上下文管理很安全</strong></p>
<h3 id="with语句"><a href="#with语句" class="headerlink" title="with语句"></a>with语句</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:</span><br><span class="line">    print(p == f)  <span class="comment"># 为什么不相等</span></span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">enter</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line">do sth.</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p>问题在于<code>__enter__</code>方法上，它将自己的返回值赋给<code>f</code>。修改上例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:</span><br><span class="line">    print(p == f)</span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">enter</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line">do sth.</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p><code>__enter__</code>方法返回值就是上下文中使用的对象，<code>with</code>语法会把它的返回值赋给<code>as</code>子句的变量。</p>
<h3 id="enter-方法和-exit-方法的参数"><a href="#enter-方法和-exit-方法的参数" class="headerlink" title="__enter__方法和__exit__方法的参数"></a><code>__enter__</code>方法和<code>__exit__</code>方法的参数</h3><p><code>__enter__</code>方法没有其他参数。</p>
<p><code>__exit__</code>方法有3个参数：</p>
<p><code>__exit__(self, exc_type, exc_value, traceback)</code></p>
<p>这三个参数都与异常有关。</p>
<p>如果该上下文退出时没有异常，这3个参数都为None。</p>
<p>如果有异常，参数意义如下</p>
<p><code>exc_type</code>，异常类型</p>
<p><code>exc_value</code>，异常的值</p>
<p><code>traceback</code>，异常的追踪信息</p>
<p><code>__exit__</code>方法返回一个等效True的值，则压制异常；否则，继续抛出异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(exc_type)</span><br><span class="line">        print(exc_val)</span><br><span class="line">        print(exc_tb)</span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"abc"</span></span><br><span class="line">    </span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">'New Error'</span>)  </span><br><span class="line"><span class="comment"># 如果不加raise这句，__exit__中的三个属性的返回值将都是None。</span></span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br><span class="line">    </span><br><span class="line">print(<span class="string">'outer'</span>)</span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">enter</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">Exception</span>'&gt;  # 异常类型</span></span><br><span class="line"><span class="class"><span class="title">New</span> <span class="title">Error</span>  # 异常的值</span></span><br><span class="line"><span class="class">&lt;<span class="title">traceback</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f8171ce62c0</span>&gt;  # 异常的追踪信息</span></span><br><span class="line"><span class="class"><span class="title">exit</span></span></span><br><span class="line"><span class="class"><span class="title">outer</span></span></span><br></pre></td></tr></table></figure>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p>为加法函数计时</p>
<p>方法1，使用装饰器显示该函数的执行时长</p>
<p>方法2，使用上下文管理方法来显示该函数的执行时长</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
<p>装饰器实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeit</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">'&#123;&#125; took &#123;&#125;s'</span>.format(fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@timeit</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span>   <span class="comment"># timeit(add)</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">输出：</span><br><span class="line">add took <span class="number">2.002056</span>s</span><br><span class="line"><span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>上下文实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeit</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">'&#123;&#125; took &#123;&#125;s'</span>.format(fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@timeit</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self.fn</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">"&#123;&#125; took &#123;&#125;s"</span>.format(self.fn.__name__, delta))</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> Timeit(add) <span class="keyword">as</span> fn:</span><br><span class="line">    print(fn(<span class="number">4</span>, <span class="number">6</span>))</span><br><span class="line">    <span class="comment"># print(add(4, 7))</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">11</span></span><br><span class="line">add took <span class="number">2.001579</span>s</span><br></pre></td></tr></table></figure>
<p>另一种实现，使用可调用对象实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeit</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">'&#123;&#125; took &#123;&#125;s'</span>.format(fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@timeit</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">"&#123;&#125; took &#123;&#125;s"</span>.format(self.fn.__name__, delta))</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        print(x, y)</span><br><span class="line">        <span class="keyword">return</span> self.fn(x, y)  </span><br><span class="line"><span class="comment"># 这里的fn指的就是传入的函数，如下面的add函数，x和y是传给函数的参数，返回的self.fn(x,y)实际就是函数的返回</span></span><br><span class="line"><span class="comment"># 值。比如下面的with语句中，将Timeit(add)的结果传给了timeitobj，下面的Timeit(add)就等于__call__方法中</span></span><br><span class="line"><span class="comment"># 返回的self.fn，也就等于timeitobj，所以下面可以直接使用timeitobj(5,6)，返回结果就是self.fn(x,y)，也</span></span><br><span class="line"><span class="comment"># 就是add函数返回的return x + y</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> Timeit(add) <span class="keyword">as</span> timeitobj:</span><br><span class="line">    print(timeitobj(<span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line"><span class="comment"># 因为使用了上下文管理，所以可以这样使用，如果使用abc = Timeit(add)，通过类调用函数就要用abc.fn(5,6)了</span></span><br><span class="line"><span class="comment"># timeitobj的属性字典里有&#123;'fn': &lt;function add at 0x7f30b02cbae8&gt;, 'start': datetime.datetime(2020, 7, 22, 8, 34, 57, 490422)&#125;</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">5</span> <span class="number">6</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line">add took <span class="number">2.001707</span>s</span><br><span class="line"><span class="comment"># 这里会先执行__enter__，再执行__call__，最后执行__exit__。</span></span><br></pre></td></tr></table></figure>
<p>根据上面的代码，能不能把类当做装饰器用？类装饰器？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeIt</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># 这里返回的self是给下面的__call__使用的？</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        self.delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">'&#123;&#125; took &#123;&#125;s. context'</span>.format(self.fn.__name__, self.delta))</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        ret = self.fn(*args, **kwargs)</span><br><span class="line">        self.delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">'&#123;&#125; took &#123;&#125;s. call'</span>.format(self.fn.__name__, self.delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"><span class="comment"># 因为是将类做成装饰器，而不是像上面一样使用上下文管理，所以不会执行__enter__与__exit__方法，所以在这两个</span></span><br><span class="line"><span class="comment"># 方法中定义的self.start和self.delta也不会生效。所以要在__call__方法中重新定义self.start和self.delta方法    </span></span><br><span class="line"><span class="meta">@TimeIt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="string">"""This is add function."""</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">输出：</span><br><span class="line">add took <span class="number">2.001804</span>s. call</span><br><span class="line"></span><br><span class="line">print(add.__doc__)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">None</span>  <span class="comment"># add中的说明文档没有保存下来</span></span><br></pre></td></tr></table></figure>
<p>思考</p>
<p>如何解决文档字符串问题？</p>
<p>方法一</p>
<p>直接修改<code>__doc__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeIt</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn=None)</span>:</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        <span class="comment"># 把函数对象的文档字符串赋给类</span></span><br><span class="line">        self.__doc__ = fn.__doc__</span><br></pre></td></tr></table></figure>
<p>方法二</p>
<p>使用<code>functools.wraps</code>函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps, update_wrapper</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="string">"""This is A Class"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        <span class="comment"># 把函数对象的文档字符串赋给类</span></span><br><span class="line">        <span class="comment"># self.__doc__ = fn.__doc__  # 这是第一种保存被装饰函数的说明文档的方法</span></span><br><span class="line">        <span class="comment"># update_wrapper(self, fn)  # 这是第二种保存被装饰函数的说明文档的方法</span></span><br><span class="line">        wraps(fn)(self)  <span class="comment"># 这还是第二种保存被装饰函数的说明文档的方法，使用这个方法与update_wrapper的效果是一样的</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">"&#123;&#125; took &#123;&#125;s. context"</span>.format(self.fn.__name__, delta))</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        ret = self.fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">"&#123;&#125; took &#123;&#125;s. call"</span>.format(self.fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Timeit</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="string">"""This is add function."""</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">10</span>, <span class="number">5</span>))</span><br><span class="line">print(add.__doc__)</span><br><span class="line">print(Timeit(add).__doc__)</span><br><span class="line">输出：</span><br><span class="line">add took <span class="number">2.002079</span>s. call</span><br><span class="line"><span class="number">15</span></span><br><span class="line">This <span class="keyword">is</span> add function.</span><br><span class="line">This <span class="keyword">is</span> add function.</span><br></pre></td></tr></table></figure>
<p>上面的类即可以用在上下文管理，又可以用做装饰器</p>
<h3 id="上下文应用场景"><a href="#上下文应用场景" class="headerlink" title="上下文应用场景"></a>上下文应用场景</h3><ol>
<li><p>增强功能</p>
<p>在代码执行的前后增加代码，以增强其功能。类似装饰器的功能。</p>
</li>
<li><p>资源管理</p>
<p>打开了资源需要关闭，例如文件对象、网络连接、数据库连接等</p>
</li>
<li><p>权限验证</p>
<p>在执行代码之前，做权限的验证，在<code>__enter__</code>中处理</p>
</li>
</ol>
<h3 id="contextlib-contextmanager"><a href="#contextlib-contextmanager" class="headerlink" title="contextlib.contextmanager"></a>contextlib.contextmanager</h3><p><code>contextlib.contextmanager</code></p>
<p>它是一个装饰器实现上下文管理，装饰一个函数，而不用像类一样实现<code>__enter__</code>和<code>__exit__</code>方法。</p>
<p>对下面的函数有要求，必须有<code>yield</code>，也就是这个函数必须返回一个生成器，且只有<code>yield</code>一个值。也就是这个装饰器接收一个生成器对象作为参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'enter'</span>)   <span class="comment"># 相当于__enter__()</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="comment"># yield 5，yield的值只能有一个，作为__enter__方法的返回值</span></span><br><span class="line">    print(<span class="string">'exit'</span>)  <span class="comment"># 相当于__exit__()</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> foo() <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># raise Exception()  # 加入此条代码，就不会执行上面的print('exit')了</span></span><br><span class="line">    print(f)</span><br><span class="line">输出：</span><br><span class="line">enter</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p><code>f</code>接收<code>yield</code>语句的返回值</p>
<p>上面的程序看似不错，但是，增加一个异常试一试，发现不能保证<code>exit</code>的执行，怎么办？</p>
<p>增加<code>try finally</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'enter'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span>   <span class="comment"># yield 5，yield的值只能有一个，作为__enter__方法的返回值</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> foo() <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">raise</span> Exception()</span><br><span class="line">    print(f)</span><br><span class="line">输出：</span><br><span class="line">enter</span><br><span class="line">exit</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/魔术方法/上下文管理课上练习.py"</span>, line <span class="number">100</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="keyword">raise</span> Exception()</span><br><span class="line">Exception</span><br></pre></td></tr></table></figure>
<p>上例这么做有什么意义呢？</p>
<p>当<code>yield</code>发生处为生成器函数增加了上下文管理。这是为函数增加上下文机制的方式。</p>
<ul>
<li>把<code>yield</code>之前的当做<code>__enter__</code>方法执行</li>
<li>把<code>yield</code>之后的当做<code>__exit__</code>方法执行</li>
<li>把<code>yield</code>的值作为<code>__enter__</code>的返回值</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span>   <span class="comment"># 为生成器函数增加了上下文管理</span></span><br><span class="line">    start = datetime.datetime.now()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> x + y  <span class="comment"># yield 5，yield的值只能有一个，作为__enter__方法的返回值</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(delta)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> add(<span class="number">4</span>, <span class="number">5</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># raise Exception()</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(f)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">2.002103</span></span><br><span class="line"></span><br><span class="line">加入<span class="keyword">raise</span> Exception()的输出：</span><br><span class="line"><span class="number">1e-05</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/魔术方法/上下文管理课上练习.py"</span>, line <span class="number">117</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="keyword">raise</span> Exception()</span><br><span class="line">Exception</span><br></pre></td></tr></table></figure>
<p>总结</p>
<p>如果业务逻辑简单可以使用函数加<code>contextlib.contextmanager</code>装饰器方式，如果业务复杂，用类的方式加<code>__enter__</code>和<code>__exit__</code>方法方便。</p>
<h3 id="反射概述"><a href="#反射概述" class="headerlink" title="反射概述"></a>反射概述</h3><p>运行时，区别于编译时，指的是程序被加载到内存中执行的时候。</p>
<p>反射，reflection，指的是运行时获取类型定义信息。</p>
<p>一个对象能够在运行时，像照镜子一样，反射出其类型信息。</p>
<p>简单说，在Python中，能够通过一个对象，找出其<code>type</code>、<code>class</code>、<code>attribute</code>或<code>method</code>的能力，称为反射或者自省。</p>
<p>具有反射能力的函数有：<code>type()</code>、<code>isinstance()</code>、<code>callable()</code>、<code>dir()</code>、<code>getattr()</code></p>
<h3 id="反射相关的函数和方法"><a href="#反射相关的函数和方法" class="headerlink" title="反射相关的函数和方法"></a>反射相关的函数和方法</h3><p>需求</p>
<p>有一个Point类，查看它实例的属性，并修改它。动态为实例增加属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Point(&#123;&#125;, &#123;&#125;)"</span>.format(self.x, self.y)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line">        </span><br><span class="line">p = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p)</span><br><span class="line">输出：</span><br><span class="line">Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">print(p.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">p.__dict__[<span class="string">'y'</span>] = <span class="number">16</span></span><br><span class="line">print(p.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">16</span>&#125;</span><br><span class="line"></span><br><span class="line">p.z = <span class="number">10</span></span><br><span class="line">print(p.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">16</span>, <span class="string">'z'</span>: <span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line">print(dir(p))  <span class="comment"># ordered list</span></span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>, <span class="string">'show'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]</span><br><span class="line"></span><br><span class="line">print(sorted(p.__dir__())) <span class="comment"># list</span></span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>, <span class="string">'show'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]</span><br></pre></td></tr></table></figure>
<p>上例通过属性字典<code>__dict__</code>来访问对象的属性，本质上也是利用的反射的能力。<code>dir()</code>是有序字典的</p>
<p>但是，上面的例子中，访问的方式不优雅，Python提供了内置的函数。</p>
<table>
<thead>
<tr>
<th>内建函数</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getattr(object,name[,default])</code></td>
<td>通过name返回object的属性值。当属性不存在，将使用default返回，如果没有default，则抛出AttributeError。name必须为字符串</td>
</tr>
<tr>
<td><code>setattr(object,name,value)</code></td>
<td>object的属性存在，则覆盖，不存在，新增</td>
</tr>
<tr>
<td><code>hasattr(object,name)</code></td>
<td>判断对象是否有这个名字的属性，name必须为字符串</td>
</tr>
</tbody>
</table>
<p>用上面的方法来修改上例的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Point(&#123;&#125;, &#123;&#125;)"</span>.format(self.x, self.y)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self)</span><br><span class="line">        </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">p2 = Point(<span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">print(repr(p1), repr(p2), sep=<span class="string">'\n'</span>)</span><br><span class="line">输出：</span><br><span class="line">&lt;__main__.Point object at <span class="number">0x7f9a8bf6ea90</span>&gt;</span><br><span class="line">&lt;__main__.Point object at <span class="number">0x7f9a8bf88490</span>&gt;</span><br><span class="line"></span><br><span class="line">print(p1.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">setattr(p1, <span class="string">'y'</span>, <span class="number">16</span>)</span><br><span class="line">setattr(p1, <span class="string">'z'</span>, <span class="number">10</span>)</span><br><span class="line">print(getattr(p1, <span class="string">'__dict__'</span>))</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">16</span>, <span class="string">'z'</span>: <span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态调用方法</span></span><br><span class="line"><span class="keyword">if</span> hasattr(p1, <span class="string">'show'</span>):</span><br><span class="line">    getattr(p1, <span class="string">'show'</span>)()</span><br><span class="line">输出：</span><br><span class="line">Point(<span class="number">4</span>, <span class="number">16</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 动态增加方法</span></span><br><span class="line"><span class="comment"># 为类增加方法</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> hasattr(Point, <span class="string">'add'</span>):</span><br><span class="line">    setattr(Point, <span class="string">'add'</span>, <span class="keyword">lambda</span> self,other: Point(self.x + other.x, self.y + other.y))</span><br><span class="line">    </span><br><span class="line">print(Point.add)</span><br><span class="line">输出：</span><br><span class="line">&lt;function &lt;<span class="keyword">lambda</span>&gt; at <span class="number">0x7f9a8bf0a4c0</span>&gt;</span><br><span class="line"></span><br><span class="line">print(p1.add)</span><br><span class="line">输出：</span><br><span class="line">&lt;bound method &lt;<span class="keyword">lambda</span>&gt; of &lt;__main__.Point object at <span class="number">0x7f9a8bf6ea90</span>&gt;&gt;</span><br><span class="line"></span><br><span class="line">print(p1.add(p2))  <span class="comment"># 绑定</span></span><br><span class="line">输出：</span><br><span class="line">Point(<span class="number">14</span>, <span class="number">26</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为实例增加方法， 未绑定</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> hasattr(p1, <span class="string">'sub'</span>):</span><br><span class="line">    setattr(p1, <span class="string">'sub'</span>, <span class="keyword">lambda</span> self,other: Point(self.x - other.x, self.y - other.y))</span><br><span class="line">    </span><br><span class="line">print(p1.sub(p1, p1))</span><br><span class="line">输出：</span><br><span class="line">Point(<span class="number">0</span>, <span class="number">0</span>)  <span class="comment"># p1减p1，所以都是0</span></span><br><span class="line"></span><br><span class="line">print(p1.sub)</span><br><span class="line">输出：</span><br><span class="line">&lt;function &lt;<span class="keyword">lambda</span>&gt; at <span class="number">0x7f9a8bf0a700</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># add在谁里面，sub在谁里面</span></span><br><span class="line"><span class="comment"># add属性在类的字典里，sub属性在实例的字典里</span></span><br><span class="line">print(p1.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">16</span>, <span class="string">'z'</span>: <span class="number">10</span>, <span class="string">'sub'</span>: &lt;function &lt;<span class="keyword">lambda</span>&gt; at <span class="number">0x7f9a8bf0a700</span>&gt;&#125;</span><br><span class="line"></span><br><span class="line">print(Point.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function Point.__init__ at <span class="number">0x7f9a8bf0a550</span>&gt;, <span class="string">'__str__'</span>: &lt;function Point.__str__ at <span class="number">0x7f9a8bf0a5e0</span>&gt;, <span class="string">'show'</span>: &lt;function Point.show at <span class="number">0x7f9a8bf0a670</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Point'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Point'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'add'</span>: &lt;function &lt;<span class="keyword">lambda</span>&gt; at <span class="number">0x7f9a8bf0a4c0</span>&gt;&#125;</span><br></pre></td></tr></table></figure>
<p>思考</p>
<p>这种动态增加属性的方式和装饰器修饰一个类、Mixin方式的差异？</p>
<p>这种动态增删属性的方式是运行时改变类或者实例的方式，但是装饰器或Mixin都是定义时就决定了，因此反射能力具有更大的灵活性。</p>
<p>练习</p>
<p>命令分发器，通过名称找对应的函数执行。</p>
<p>思路：名称找对象的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._run()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd1</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"I'm cmd1"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd2</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"I'm cmd2"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            cmd = input(<span class="string">'Plz input a command: '</span>).strip()</span><br><span class="line">            <span class="keyword">if</span> cmd == <span class="string">'quit'</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            getattr(self, cmd, <span class="keyword">lambda</span> : print(<span class="string">'Unknown Command &#123;&#125;.'</span>.format(cmd)))()</span><br><span class="line"><span class="comment"># 执行Dispatcher类实例化时就可以执行_run方法，之后通过getattr函数来判断用户输入的命令是否在类中有定义，</span></span><br><span class="line"><span class="comment"># getattr()可以通过name返回object的属性值。当属性不存在，将使用default返回，如果没有default，则抛出</span></span><br><span class="line"><span class="comment"># AttributeError。name必须为字符串。这里判断实例中是否有cmd，这个cmd就是while True中定义的用户输入的命</span></span><br><span class="line"><span class="comment"># 令，如果找到，就返回用户输入的方法名的结果。否则返回Unknown Command &#123;cmd&#125;.最后的括号表示找到用户输入的</span></span><br><span class="line"><span class="comment"># 方法名后，要调用这个方法，打印这个方法的执行结果，如cmd1方法的执行结果</span></span><br><span class="line">Dispatcher()</span><br><span class="line">输出：</span><br><span class="line">Plz input a command: abc</span><br><span class="line">Unknow Command abc.</span><br><span class="line">Plz input a command: cmd1</span><br><span class="line">I<span class="string">'m cmd1</span></span><br><span class="line"><span class="string">Plz input a command: cmd2</span></span><br><span class="line"><span class="string">I'</span>m cmd2</span><br><span class="line">Plz input a command: quit</span><br><span class="line"></span><br><span class="line">Process finished <span class="keyword">with</span> exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>上例中使用<code>getattr</code>方法找到对象的属性的方式，比自己维护一个字典来建立名称和函数之间的关系的方式好多了。</p>
<h3 id="反射相关的魔术方法"><a href="#反射相关的魔术方法" class="headerlink" title="反射相关的魔术方法"></a>反射相关的魔术方法</h3><p><code>__getattr__()</code>、<code>__setattr__()</code>、<code>__delattr__()</code>这三个魔术方法，分别测试</p>
<h4 id="getattr"><a href="#getattr" class="headerlink" title="__getattr__()"></a><code>__getattr__()</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Base)</span>:</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"missing &#123;&#125;."</span>.format(item)</span><br><span class="line">    </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.x)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">4</span></span><br><span class="line"></span><br><span class="line">print(p1.z)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">6</span></span><br><span class="line"></span><br><span class="line">print(p1.n)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line">print(p1.t)   <span class="comment"># missing</span></span><br><span class="line">输出：</span><br><span class="line">missing t.</span><br></pre></td></tr></table></figure>
<p>一个类的属性会按照继承关系找，如果找不到，就会执行<code>__getattr__()</code>方法，如果没有这个方法，就会抛出<code>AttributeError</code>异常表示找不到属性。</p>
<p>查找属性顺序为：</p>
<p><code>instance.__dict__ --&gt; instance.__class__.__dict__ --&gt; 继承的祖先类（直到object）的__dict__ --找不到--&gt; 调用__getattr__()</code></p>
<h4 id="setattr"><a href="#setattr" class="headerlink" title="__setattr__()"></a><code>__setattr__()</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Base)</span>:</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"missing &#123;&#125;"</span>.format(item)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(<span class="string">"setattr &#123;&#125;=&#123;&#125;"</span>.format(key, value))</span><br><span class="line">        </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.x)  <span class="comment"># missing, why</span></span><br><span class="line">输出：</span><br><span class="line">setattr x=<span class="number">4</span></span><br><span class="line">setattr y=<span class="number">5</span></span><br><span class="line">missing x</span><br><span class="line"><span class="comment"># 如果没有__setattr__方法，实例p1的字典中就有x和y，如果有__setattr__()方法，实例p1的字典中就是空的。另</span></span><br><span class="line"><span class="comment"># 外，可以从下面的结果中发现，类属性并没有受到影响，只有实例的属性受到了影响。这就是下面的结论，</span></span><br><span class="line"><span class="comment"># __setattr__()方法，可以拦截对实例属性的增加、修改操作，如果要设置生效，需要自己操作实例的__dict__。上面</span></span><br><span class="line"><span class="comment"># 设置的self.x = x，self.y = y实际也不在实例的字典中，都被__setattr__拦截了，这两个属性也不会在类中。</span></span><br><span class="line"></span><br><span class="line">print(p1.z)</span><br><span class="line">输出：</span><br><span class="line">setattr x=<span class="number">4</span></span><br><span class="line">setattr y=<span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"></span><br><span class="line">print(p1.n)</span><br><span class="line">输出：</span><br><span class="line">setattr x=<span class="number">4</span></span><br><span class="line">setattr y=<span class="number">5</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line">print(p1.t)  <span class="comment"># missing</span></span><br><span class="line">输出：</span><br><span class="line">setattr x=<span class="number">4</span></span><br><span class="line">setattr y=<span class="number">5</span></span><br><span class="line">missing t</span><br><span class="line"></span><br><span class="line">p1.x = <span class="number">50</span></span><br><span class="line">print(p1.__dict__)</span><br><span class="line">输出：</span><br><span class="line">setattr x=<span class="number">4</span></span><br><span class="line">setattr y=<span class="number">5</span></span><br><span class="line">setattr x=<span class="number">50</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">p1.__dict__[<span class="string">'x'</span>] = <span class="number">60</span></span><br><span class="line">print(p1.__dict__)</span><br><span class="line">输出：</span><br><span class="line">setattr x=<span class="number">4</span></span><br><span class="line">setattr y=<span class="number">5</span></span><br><span class="line">setattr x=<span class="number">50</span></span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">60</span>&#125;</span><br><span class="line"></span><br><span class="line">print(p1.x)</span><br><span class="line">输出：</span><br><span class="line">setattr x=<span class="number">4</span></span><br><span class="line">setattr y=<span class="number">5</span></span><br><span class="line">setattr x=<span class="number">50</span></span><br><span class="line"><span class="number">60</span></span><br></pre></td></tr></table></figure>
<p>实例通过<code>.</code>点设置属性，如<code>self.x = x</code>，就会调用<code>__setattr__()</code>，属性要加到实例的<code>__dict__</code>中，就需要自己完成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Base)</span>:</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(Self)</span>:</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"missing &#123;&#125;"</span>.format(item)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(<span class="string">"setattr &#123;&#125;=&#123;&#125;"</span>.format(key, value))</span><br><span class="line">        self.__dict__[key] = value</span><br><span class="line">        </span><br><span class="line">p1 = Point(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">print(p1.__dict__)</span><br><span class="line">输出：</span><br><span class="line">setattr x=<span class="number">4</span></span><br><span class="line">setattr y=<span class="number">5</span></span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">print(dir(Point))</span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattr__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>, <span class="string">'n'</span>, <span class="string">'show'</span>, <span class="string">'z'</span>]</span><br></pre></td></tr></table></figure>
<p><code>__setattr__()</code>方法，可以拦截对实例属性的增加、修改操作，如果要设置生效，需要自己操作实例的<code>__dict__</code>。</p>
<h4 id="delattr"><a href="#delattr" class="headerlink" title="__delattr__()"></a><code>__delattr__()</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    z = <span class="number">5</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'Can not del &#123;&#125;'</span>.format(item))</span><br><span class="line">        </span><br><span class="line">p = Point(<span class="number">14</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">del</span> p.x</span><br><span class="line">输出：</span><br><span class="line">Can <span class="keyword">not</span> <span class="keyword">del</span> x</span><br><span class="line"></span><br><span class="line">p.z = <span class="number">15</span></span><br><span class="line"><span class="keyword">del</span> p.z</span><br><span class="line">输出：</span><br><span class="line">Can <span class="keyword">not</span> <span class="keyword">del</span> z</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> p.z</span><br><span class="line">输出：</span><br><span class="line">Can <span class="keyword">not</span> <span class="keyword">del</span> z</span><br><span class="line"></span><br><span class="line">print(Point.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'z'</span>: <span class="number">5</span>, <span class="string">'__init__'</span>: &lt;function Point.__init__ at <span class="number">0x7fd9b68c51e0</span>&gt;, <span class="string">'__delattr__'</span>: &lt;function Point.__delattr__ at <span class="number">0x7fd9b6908ae8</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Point'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Point'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"></span><br><span class="line">print(p.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">14</span>, <span class="string">'y'</span>: <span class="number">5</span>, <span class="string">'z'</span>: <span class="number">15</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> Point.z</span><br><span class="line">print(Point.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function Point.__init__ at <span class="number">0x7f63e99271e0</span>&gt;, <span class="string">'__delattr__'</span>: &lt;function Point.__delattr__ at <span class="number">0x7f63e996aae8</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Point'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Point'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br></pre></td></tr></table></figure>
<p>可以阻止通过实例删除属性的操作。但是通过类依然可以删除属性。</p>
<h4 id="getattribute"><a href="#getattribute" class="headerlink" title="__getattribute__()"></a><code>__getattribute__()</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Base)</span>:</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"missing &#123;&#125;"</span>.format(item)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">    </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.__dict__)</span><br><span class="line">输出：</span><br><span class="line">__dict__</span><br><span class="line"></span><br><span class="line">print(p1.x)</span><br><span class="line">输出：</span><br><span class="line">x</span><br><span class="line"></span><br><span class="line">print(p1.z)</span><br><span class="line">输出：</span><br><span class="line">z</span><br><span class="line"></span><br><span class="line">print(p1.n)</span><br><span class="line">输出：</span><br><span class="line">n</span><br><span class="line"></span><br><span class="line">print(p1.t)</span><br><span class="line">输出：</span><br><span class="line">t</span><br><span class="line"></span><br><span class="line">print(Point.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'z'</span>: <span class="number">6</span>, <span class="string">'__init__'</span>: &lt;function Point.__init__ at <span class="number">0x7f5a59e181e0</span>&gt;, <span class="string">'__getattr__'</span>: &lt;function Point.__getattr__ at <span class="number">0x7f5a59e5bae8</span>&gt;, <span class="string">'__getattribute__'</span>: &lt;function Point.__getattribute__ at <span class="number">0x7f5a59e5bea0</span>&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"></span><br><span class="line">print(Point.z)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure>
<p>实例的所有的属性访问，第一个都会调用<code>__getattribute__</code>方法，它阻止了属性的查找，该方法应该返回（计算后的）值或者抛出一个<code>AttributeError</code>异常。</p>
<p>它的return值将作为属性查找的结果。如果抛出<code>AttributeError</code>异常，则会直接调用<code>__getattr__</code>方法，因为表示属性没有找到。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Base)</span>:</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"missing &#123;&#125;"</span>.format(item)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="comment"># raise AttributeError("Not Found")</span></span><br><span class="line">        <span class="comment"># pass</span></span><br><span class="line">        <span class="comment"># return self.__dict__[item]</span></span><br><span class="line">        <span class="keyword">return</span> object.__getattribute__(self, item)</span><br><span class="line">    </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">print(p1.x)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">4</span></span><br><span class="line"></span><br><span class="line">print(p1.z)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">6</span></span><br><span class="line"></span><br><span class="line">print(p1.n)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line">print(p1.t)</span><br><span class="line">输出：</span><br><span class="line">missing t</span><br><span class="line"></span><br><span class="line">print(Point.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'z'</span>: <span class="number">6</span>, <span class="string">'__init__'</span>: &lt;function Point.__init__ at <span class="number">0x7f3399c211e0</span>&gt;, <span class="string">'__getattr__'</span>: &lt;function Point.__getattr__ at <span class="number">0x7f3399c64ae8</span>&gt;, <span class="string">'__getattribute__'</span>: &lt;function Point.__getattribute__ at <span class="number">0x7f3399c64ea0</span>&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"></span><br><span class="line">print(Point.z)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure>
<p><code>__getattribute__</code>方法中为了避免在该方法中无限的递归，它的实现应该永远调用基类的同名方法以访问需要的任何属性，例如<code>object.__getattribute__(self, name)</code>。</p>
<p>注意，除非你明确地知道<code>__getattribute__</code>方法用来做什么，否则不要使用它。</p>
<p>总结</p>
<table>
<thead>
<tr>
<th>魔术方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__getattr__()</code></td>
<td>当通过搜索实例、实例的类及祖先类查不到属性，就会调用此方法</td>
</tr>
<tr>
<td><code>__setattr__()</code></td>
<td>通过<code>.</code>访问实例属性，进行增加、修改都要调用它</td>
</tr>
<tr>
<td><code>__delattr__()</code></td>
<td>当通过实例来删除属性时调用此方法</td>
</tr>
<tr>
<td><code>__getattribute__</code></td>
<td>实例所有的属性调用都从这个方法开始</td>
</tr>
</tbody>
</table>
<p>属性查找顺序：</p>
<p><code>实例调用__getattribute__() -&gt; instance.__dict__ -&gt; instance.__class__.__dict__ -&gt; 继承的祖先类（直到object）的__dict__ -&gt; 调用__getattr__()</code></p>
<h3 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">python的名词空间指模块或作用域</span><br><span class="line"></span><br><span class="line">dir()</span><br><span class="line"><span class="comment"># 收集当前模块的信息</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> test2</span><br><span class="line">print(dir(test2))</span><br><span class="line"><span class="comment"># 导入test2模块或叫导入名词空间。收集test2信息。这时test模块中会多一个test2。import就是导入名词空间的</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(x)</span>:</span></span><br><span class="line">    y = <span class="number">1</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(dir(foo))  <span class="comment"># 指定对foo进行搜集，可以看到foo继承的函数的所有属性</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    X = <span class="number">123</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.y = <span class="number">5</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">print(sorted(dir(A)))</span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'X'</span>, <span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>]</span><br><span class="line"></span><br><span class="line">print(sorted(A.__dict__))</span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'X'</span>, <span class="string">'__dict__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__init__'</span>, <span class="string">'__module__'</span>, <span class="string">'__weakref__'</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__dir__</span><span class="params">(self)</span>:</span>  <span class="comment"># 因为有self，所以会影响实例的dir。</span></span><br><span class="line"><span class="comment"># 在类里看方法的第一位置参数是谁那就是谁的，这里是self所以影响的是实例</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'abcdef'</span>]</span><br><span class="line"></span><br><span class="line">print(<span class="string">'B = '</span>, sorted(dir(B)))</span><br><span class="line">输出：</span><br><span class="line">B =  [<span class="string">'X'</span>, <span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>]</span><br><span class="line"></span><br><span class="line">print(sorted(B.__dict__))</span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__module__'</span>]</span><br><span class="line"></span><br><span class="line">b = B()</span><br><span class="line">print(sorted(dir(b)))</span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'abcdef'</span>]</span><br><span class="line"></span><br><span class="line">print(sorted(b.__dict__))</span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'y'</span>]</span><br><span class="line"></span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">print(sorted(set(b.__dict__.keys()) | set(b.__class__.__dict__.keys()) | set(object.__dict__)))</span><br><span class="line"><span class="comment"># 自己凑一个。dir()显示的信息都是实例自己和类的属性，还有object类的属性。用set是为了去重。</span></span><br><span class="line">输出：</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'y'</span>]</span><br></pre></td></tr></table></figure>
<p>hash</p>
<p>用hash就是为了O1的时间复杂度。缓存的目的是再查，缓冲是为了匹配生产者与消费者的速度</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Hashable</span><br><span class="line"><span class="comment"># 3.8.2版本中如果没有collections模块，要用pip3 install collections-extended，使用时要用</span></span><br><span class="line"><span class="comment"># from _collections_abc import Hashable或用from collections.abc import Hashable，不然会提示:</span></span><br><span class="line"><span class="comment"># "DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' </span></span><br><span class="line"><span class="comment"># is deprecated since Python 3.3, and in 3.9 it will stop working"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    X = <span class="number">123</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, y)</span>:</span></span><br><span class="line">        self.y = y</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span><span class="params">(self)</span>:</span>  <span class="comment"># hash冲突。两个对象在一个hash的计算空间中，可能算出的两个key是一样的</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>   <span class="comment"># 这里只能用整型，不能用字符串</span></span><br><span class="line"><span class="comment">#    __hash__ = None</span></span><br><span class="line"><span class="comment"># 如果实例再调用hash就是在调用__hash__这个方法，这个方法就等于None，相当于调用None()。这时调用时会提示是不可hash类型。</span></span><br><span class="line"><span class="comment"># 不可hash类型就是这样实现的。</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="comment"># return True  </span></span><br><span class="line"><span class="comment"># 这样定义，不管什么情况都认为两个实例相等，这时不管初始化时放什么值都相等了。如果把这里改成False，下面的显示</span></span><br><span class="line"><span class="comment"># 结果也会是去重的，可能是set()先用了一个is来判断，之后再调用__eq__。也就是set先判断内存地址是否相同，相同就去重</span></span><br><span class="line">    	<span class="keyword">return</span> self.y == other.y   <span class="comment"># 应该这样写，而不是简单的True或False</span></span><br><span class="line"><span class="comment"># 当前的实例对象self和另一个实例对象other把y拿出来比较数据属性是否相同</span></span><br><span class="line"><span class="comment"># self.y == other.y叫二元操作符，self.y叫对象，==是操作符，相当于self.y对象在调用__eq__方法，而后面的</span></span><br><span class="line"><span class="comment"># other.y做为other参数。self.y是什么类型就调用什么类型的__eq__方法，而不是这里定义的__eq__方法，比如这里</span></span><br><span class="line"><span class="comment"># 初始化时定义了self.y = 'y'，那么self.y就会调用字符串的__eq__方法。这里要看自己的逻辑，如果初始化定义了</span></span><br><span class="line"><span class="comment"># 两个属性，这里可以判断一个属性相等就可以了，也可以判断两个属性相等才行，如：</span></span><br><span class="line"><span class="comment"># return self.y == other.y and self.x == other.x</span></span><br><span class="line"><span class="comment"># 用取模算法去理解hash算法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hash(o)  # 相当于调用o.__hash__()，None是不能调用的，所以o是不能调用的</span></span><br><span class="line"><span class="comment"># o.__hash__()</span></span><br><span class="line">print(hash(A(<span class="number">5</span>))) <span class="comment"># hash要对里面的对象调用hash的方法</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line">lst = [A(<span class="number">4</span>), A(<span class="number">5</span>)]  <span class="comment"># 因为A()是不可迭代类型，所以不能用list()，而用这种中括号包起来的方法创建列表</span></span><br><span class="line">print(lst)</span><br><span class="line">输出：</span><br><span class="line">[&lt;__main__.A object at <span class="number">0x7fdbcee517b8</span>&gt;, &lt;__main__.A object at <span class="number">0x7fdbcee519b0</span>&gt;]</span><br><span class="line"></span><br><span class="line">s = set(lst)</span><br><span class="line">print(len(s))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">2</span></span><br><span class="line"></span><br><span class="line">print(s)  <span class="comment"># 如果两个A的实例传入同样的值，这里只会打印一个hash值，因为set去重了</span></span><br><span class="line">输出：</span><br><span class="line">&#123;&lt;__main__.A object at <span class="number">0x7f93d0f8f9b0</span>&gt;, &lt;__main__.A object at <span class="number">0x7f93d0f8f9e8</span>&gt;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> s:</span><br><span class="line">    print(hash(x))</span><br><span class="line"><span class="comment"># 显示hash值是相等的，都是1。所以仅用hash值不能验证两个实例是否相等。所以要用__eq__。</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">*** 可hash和去重是两个概念，可hash只是是否支持hash，能否给一个hash值。相等才会去重</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x % <span class="number">3</span>   <span class="comment"># 取模hash，有可能重复</span></span><br><span class="line"></span><br><span class="line">print(isinstance(A(<span class="number">4</span>), Hashable)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>eq</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a == b  <span class="comment"># 相当于下面。这就是二元操作符如何等价到一个方法</span></span><br><span class="line">a.__equal__(b)  <span class="comment"># b就是__eq__(self, other)中的other，a就是self，这是在调用a的__equal__方法</span></span><br></pre></td></tr></table></figure>
<p>练习</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设计二维坐标类Point，使其成为可hash类型，并比较2个坐标的实例是否相等？</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> hash((self.x, self.y))</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self <span class="keyword">is</span> other:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">p = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">p2 = Point(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">print(p)</span><br><span class="line">输出：</span><br><span class="line">&lt;__main__.Point object at <span class="number">0x7eff88c40400</span>&gt;</span><br><span class="line"></span><br><span class="line">print(p == p1)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">print(p == p2)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">print(p.__eq__(p1))</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">print(p.__eq__(p2))</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>bool</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self <span class="keyword">is</span> other:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>  <span class="comment"># 这里不能返回小于0的数</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bool_</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"><span class="comment"># 先找对象方法中是否定义了bool，如果没有再看是否有len，如果都没有定义，返回True。如果定义了，方法返回什么就</span></span><br><span class="line"><span class="comment"># 返回什么 ，如上面__bool__中返回的是False。容器内一般都不实现bool方法，而用len方法  </span></span><br><span class="line">print(bool(Point(<span class="number">4</span>, <span class="number">5</span>)))</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>可视化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self <span class="keyword">is</span> other:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(<span class="number">123</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(<span class="string">'abc'</span>)</span><br><span class="line"><span class="comment"># python默认使用repr对每个元素求打印，如果定义了str，就要用str对对象做强制转换。所以下面打印单个元素时都会</span></span><br><span class="line"><span class="comment"># 调用str方法，包括使用for循环时，也是一个个打印。在打印lst时调用了repr。如果不是直接使用print或format直</span></span><br><span class="line"><span class="comment"># 接对函数起作用的话（下面是直接对实例起作用），就要用repr。否则使用str。也就是，如果print()直接作用于对</span></span><br><span class="line"><span class="comment"># 象（实例），就会强行调用对象的str方法，包括for循环也是直接作用于对象。但使用print(lst)时就要调用repr了，</span></span><br><span class="line"><span class="comment"># 因为print并不是直接作用到对象上，而是作用到列表上。所以可以将repr和str的返回值写成一样的</span></span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)  </span><br><span class="line">p2 = Point(<span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">print(p1)   <span class="comment"># __str__等效于print方法</span></span><br><span class="line">输出：</span><br><span class="line">abc</span><br><span class="line"></span><br><span class="line">lst = [p1, p2]   </span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> lst:   <span class="comment"># for循环也会调用__str__方法</span></span><br><span class="line">    print(x)</span><br><span class="line">输出：</span><br><span class="line">abc</span><br><span class="line">abc</span><br><span class="line"></span><br><span class="line">print(*lst)   <span class="comment"># 这相当于强行str了</span></span><br><span class="line">输出：</span><br><span class="line">abc abc</span><br><span class="line"></span><br><span class="line">print(list(map(str, lst)))  <span class="comment"># map后是一个可迭代对象，所以返回的是地址。这也是强行str的方法</span></span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'abc'</span>, <span class="string">'abc'</span>]</span><br><span class="line"></span><br><span class="line">print(lst)  <span class="comment"># lst列表里还有print，print是找lst的print方法，lst里的元素不会这样处理。相当于元素没有直接</span></span><br><span class="line"><span class="comment"># 被print打印出来。因为这是lst内部的元素，它要调用对象的另一种表达方法__repr__。如果不是用str()强制转换，</span></span><br><span class="line"><span class="comment"># 或用format、print()直接对对象起作用的话，那就要用__repr__，这是python内部所使用的，默认会用内建函数</span></span><br><span class="line"><span class="comment"># __repr__来对每个元素求打印，也就是所谓的字符串输出。所以print()如果直接作用于对象，那就强行调用对象的</span></span><br><span class="line"><span class="comment"># str，所以返回abc，for循环也是一个个元素拿出来，对于每个元素来讲，就是直接用print来打印，所以还是调用</span></span><br><span class="line"><span class="comment"># __str__。但这里打印lst时相当于打印[p1, p2]，但print不知道[p1, p2]是什么，所以就尝试调用__repr__，因</span></span><br><span class="line"><span class="comment"># 为并不是print函数直接作用在[p1, p2]上面的，所以打印的是123。</span></span><br><span class="line"><span class="comment"># 实际就是内建的几个函数，它直接作用在对象上，这样就会调用对象的str。如果并不直接作用在元素或对象上，就会调用它的repr方法 </span></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">123</span>, <span class="number">123</span>]</span><br></pre></td></tr></table></figure>
<p>运算符重载</p>
<p>运算符重载可以提高类的可用性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span><span class="params">(self, other)</span>:</span>  <span class="comment"># 减法</span></span><br><span class="line">        <span class="comment"># self.x = self.x - other.x</span></span><br><span class="line">        <span class="comment"># return self  </span></span><br><span class="line"><span class="comment"># 这是就地修改，下面是new一个新的。所以如果使用两次p1 - p2，第一次和第二次的得数是不一样的</span></span><br><span class="line">        <span class="keyword">return</span> A(self.x - other.x)   <span class="comment"># 这一行相当于上面两行代码，使用这种方法就不会出现上面两行代码</span></span><br><span class="line"><span class="comment"># 的问题，使用两次p1 - p2的结果是一样的。这里也可以直接返回self.x - other.x。一般应该返回自己本身，所以这</span></span><br><span class="line"><span class="comment"># 里返回数值不太合适，要用A()包装一下。只是要返回实例本身，要实现__str__方法才能打印出数值。具体打印出的是什</span></span><br><span class="line"><span class="comment"># 么内容要看__str__方法是如何定义的。</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__ne__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x != other.x</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x &lt; other.x  <span class="comment"># 实现一个方法就行了，知道了小于，就知道大于和等于了</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.x)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iadd__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        self.x = self.x + other.x</span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># 这样就不用new了，像下面的语句一样。</span></span><br><span class="line">      <span class="comment">#  return A(self.x + other.x)</span></span><br><span class="line">        </span><br><span class="line">    __repr__ = __str__    </span><br><span class="line">    </span><br><span class="line">a1 = A(<span class="number">4</span>)</span><br><span class="line">a2 = A(<span class="number">10</span>)</span><br><span class="line">a3 = A(<span class="number">6</span>)</span><br><span class="line">print(a1 - a2)</span><br><span class="line">print(a1.__sub__(a2))  <span class="comment"># 这条等价于上面一条</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">-6</span></span><br><span class="line"><span class="number">-6</span></span><br><span class="line"></span><br><span class="line">print(a1 == a2)</span><br><span class="line">print(a1 != a2)   <span class="comment"># 这里要使用什么符号，在类中就要定义什么方法，如这里使用不等，那么在类中也要定义__ne__方法</span></span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">lst = [a1, a2, a3]</span><br><span class="line">print(sorted(lst))</span><br><span class="line">输出：</span><br><span class="line">[<span class="number">4</span>, <span class="number">6</span>, <span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">print(list(reversed(sorted(lst))))</span><br><span class="line"><span class="comment"># 因为reversed反向排序后还是一个可迭代对象，所以要再包一层list。可以去掉sorted，这样就会直接反转，但没有排序。</span></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">10</span>, <span class="number">6</span>, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">a1 += a2</span><br><span class="line">print(a1)</span><br><span class="line"><span class="comment"># 可以通过查看int的源码，查看大部分运算符方法的使用方法</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">14</span></span><br><span class="line">============================================================================================</span><br><span class="line"><span class="comment"># 测试一下返回self如何打印</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span>              </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span></span></span><br><span class="line">        self.x = x    </span><br><span class="line">        self.y = y    </span><br><span class="line">                      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__show__</span><span class="params">(self)</span></span></span><br><span class="line"><span class="function">        <span class="title">print</span><span class="params">(<span class="string">'self &#123;&#125; &#123;&#125;'</span>.format<span class="params">(self.x, self.y)</span>)</span></span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">self</span>    # 这里如果不返回<span class="title">self</span>，下面打印时就会输出<span class="title">None</span>。这里返回<span class="title">self</span>后，下面调用<span class="title">__str__</span>方法，输出<span class="title">self</span>的两个值</span></span><br><span class="line"><span class="function">                      </span></span><br><span class="line"><span class="function">    <span class="title">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&#123;&#125; &#123;&#125;'</span>.format(self.x, self.y)</span><br><span class="line">                      </span><br><span class="line">    __repr__ = __str__</span><br><span class="line">                      </span><br><span class="line">p = A(<span class="number">3</span>, <span class="number">54</span>)          </span><br><span class="line">print(p.__show__())   </span><br><span class="line">输出：</span><br><span class="line">self <span class="number">3</span> <span class="number">54</span></span><br><span class="line"><span class="number">3</span> <span class="number">54</span></span><br></pre></td></tr></table></figure>
<p>练习</p>
<p>完成<code>Point</code>类设计，实现判断点相等的方法，并完成向量的加法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 答案1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        tmpx = self.x + other.x</span><br><span class="line">        tmpy = self.y + other.y</span><br><span class="line">        <span class="keyword">return</span> Point(tmpx, tmpy)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;Point: &#123;&#125;,&#123;&#125;&gt;'</span>.format(self.x, self.y)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;Point: &#123;&#125;,&#123;&#125;&gt;'</span>.format(self.x, self.y)</span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">p2 = Point(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">points = (p1, p2)</span><br><span class="line">print(points)</span><br><span class="line">print(points[<span class="number">0</span>] + points[<span class="number">1</span>])</span><br><span class="line">print(p1 == p2)</span><br><span class="line">输出：</span><br><span class="line">(&lt;Point: <span class="number">1</span>,<span class="number">1</span>&gt;, &lt;Point: <span class="number">1</span>,<span class="number">1</span>&gt;)</span><br><span class="line">&lt;Point: <span class="number">2</span>,<span class="number">2</span>&gt;</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>容器相关方法</p>
<p>练习</p>
<p>将购物车类改造成方便操作的容器类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, **kwargs)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self._spec = kwargs</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; = &#123;&#125;"</span>.format(self.name, self._spec.values())</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cart</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.items = []  <span class="comment"># 添加容器，购物车。可以在初始化时就把物品放进来，也可以在初始化后，有了容器再把物品放进来</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">additem</span><span class="params">(self, item)</span>:</span>  <span class="comment"># 这种方法与下面的__add__方法的作用是一样的，这种方法就是可以直接调用，下面的方法可以使用+号</span></span><br><span class="line">        self.items.append(item)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span>  <span class="comment"># 此方法对应加号，所以叫运算符重载</span></span><br><span class="line">        print(other)</span><br><span class="line">        <span class="keyword">if</span> isinstance(other, Item):</span><br><span class="line">        	self.items.append(other)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"><span class="comment"># 返回self，如果用self再加一个数字，那么self会跟着变化</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, item)</span>:</span>  <span class="comment"># 这里的item送进来什么就打印什么。是index</span></span><br><span class="line">        <span class="keyword">return</span> self.items[item]   <span class="comment"># item就是index，所以可以实现cart[1]这样的调用，超出会报异常。所以也可以把item改成index</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(key, value)</span><br><span class="line">        self.items[key] = value   <span class="comment"># 如果实例是列表，必须在已有的key上修改</span></span><br><span class="line">        <span class="comment"># self[key] = value  </span></span><br><span class="line"><span class="comment"># 这样写就递归了，因为这里的返回值就是__getitem__方法的返回值，__getitem__方法显示的</span></span><br><span class="line"><span class="comment"># self.items[item]就是value，那么这里也就成了value等于value。但有些场景可以用这种方法</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span>  <span class="comment"># __iter__方法要求返回一个迭代器</span></span><br><span class="line"><span class="comment"># 迭代的目的是把实例变成可迭代对象  </span></span><br><span class="line">		<span class="keyword">return</span> iter(self.items)  <span class="comment"># 使用iter()将实例变成迭代器</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__missing__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        print(<span class="string">"key ="</span>+key) <span class="comment"># 上面的__getitem__中的item如果超界的话，这里这样写是拦不住的。因为__missing__只是用在字典和set上的</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.items)</span><br><span class="line">    </span><br><span class="line">cart = Cart()</span><br><span class="line">print(len(cart + <span class="number">2</span> + <span class="number">3</span> + <span class="number">4</span> + <span class="number">5</span>))  <span class="comment"># 连加就是链式编程</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="comment"># 因为__add__方法中的if isinstance(other, Item)有问题，所以这里输出是0。加法中用的数字也没有加到列表中</span></span><br><span class="line">cart.__add__(<span class="number">2</span>).__add__(<span class="number">3</span>)  <span class="comment"># 这等价于上面的cart + 2 + 3 + 4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> cart:   <span class="comment"># cart如果不是迭代器iterator是不行的。因为for循环本质上是调用next()函数</span></span><br><span class="line">    print(x)  <span class="comment"># __iter__方法将实例变成了可迭代对象</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> cart.items:  </span><br><span class="line"><span class="comment"># 这样也可以实现上面的for循环的效果，但要如何包装需要自己考虑但这样写就把cart里面的东西暴露给用户，所以这样</span></span><br><span class="line"><span class="comment"># 写不好。所以我们要把它包装成容器就要包装的彻底，对一个容器来讲最重要的方法就是迭代了。</span></span><br><span class="line">    print(x)</span><br><span class="line">    </span><br><span class="line">print(cart[<span class="number">1</span>])</span><br><span class="line">输出：</span><br><span class="line"><span class="number">3</span></span><br><span class="line"></span><br><span class="line">cart[<span class="number">500</span>] = <span class="number">500</span>  <span class="comment"># 查看__setitem__的反馈。输出：IndexError: list assignment index out of range</span></span><br><span class="line">cart[<span class="number">3</span>] = <span class="number">500</span></span><br><span class="line">print(cart[<span class="number">3</span>])</span><br><span class="line">输出：</span><br><span class="line"><span class="number">500</span></span><br></pre></td></tr></table></figure>
<p>实现一个字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDict</span><span class="params">(dict)</span>:</span>  <span class="comment"># 直接继承</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>可调用对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">foo()  <span class="comment"># 加括号是调用，如果调用，一定要是可调用对象</span></span><br><span class="line">print(foo.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">print(foo.__call__)  <span class="comment"># 打印的是地址</span></span><br><span class="line">输出：</span><br><span class="line">&lt;method-wrapper <span class="string">'__call__'</span> of function object at <span class="number">0x7fef5030f1e0</span>&gt;</span><br><span class="line"></span><br><span class="line">print(dir(foo))  <span class="comment"># 如果是一个可调用对象，就应该有__call__这个魔术方法。因为函数是一个可调用对象，所以有这个魔术方法</span></span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'__annotations__'</span>, <span class="string">'__call__'</span>, <span class="string">'__class__'</span>, <span class="string">'__closure__'</span>, <span class="string">'__code__'</span>, <span class="string">'__defaults__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__get__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__globals__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__kwdefaults__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__name__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__qualname__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(x)</span>:</span></span><br><span class="line">    print(x)</span><br><span class="line">foo(<span class="number">5</span>)  <span class="comment"># 加括号是调用，如果调用，一定要是可调用对象</span></span><br><span class="line">print(foo.__dict__)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">5</span></span><br><span class="line">&#123;&#125;  <span class="comment"># 函数没有__dict__</span></span><br><span class="line"></span><br><span class="line">print(foo.__call__(<span class="number">5</span>))  </span><br><span class="line"><span class="comment"># 如果送进去一个5，相当于foo对象被调用了，并且把参数送进去了。这等价于foo(5)</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">print(dir(foo))</span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'__annotations__'</span>, <span class="string">'__call__'</span>, <span class="string">'__class__'</span>, <span class="string">'__closure__'</span>, <span class="string">'__code__'</span>, <span class="string">'__defaults__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__get__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__globals__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__kwdefaults__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__name__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__qualname__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">A()()</span><br><span class="line"><span class="comment"># 第一个括号是__init__实例化使用的，第二个括号是调用这个实例。这等价于a = A(), a()</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">5</span></span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">a(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>练习</p>
<p>定义一个斐波那契数列</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 答案1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fib</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.lst = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>]  <span class="comment"># 这是一种缓存的思想</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.lst)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> x &lt; len(self.lst):</span><br><span class="line">            <span class="keyword">return</span> self.lst</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, x):  <span class="comment"># 这里最好把2改成活动的</span></span><br><span class="line">            self.lst.append(self.lst[i<span class="number">-1</span>] + self.lst[i])</span><br><span class="line">        <span class="keyword">return</span> self.lst</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:  <span class="comment"># 这里认为不知道斐波那契数列的长度，所以不支持负索引</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; len(self):</span><br><span class="line">        	<span class="keyword">return</span> self.lst[index]</span><br><span class="line">        <span class="keyword">return</span> self(index)</span><br><span class="line">    </span><br><span class="line">a = Fib()</span><br><span class="line">print(a(<span class="number">6</span>))</span><br><span class="line">输出：</span><br><span class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">print(a(<span class="number">5</span>))</span><br><span class="line">print(a(<span class="number">4</span>))</span><br><span class="line">print(a(<span class="number">10</span>))</span><br><span class="line"><span class="comment"># a的调用不能连续使用，只能使用一个，也就是上面的print(a(4))这样的调用只能使用一个，如果使用多个，输出是错</span></span><br><span class="line"><span class="comment"># 误的，原因？因为第一次使用a(4)时，会执行__call__方法，这时会原地修改self.lst这个列表，这时的结果是</span></span><br><span class="line"><span class="comment"># [0, 1, 1, 2, 3]。再次执行a(10)时，还会执行__call__，所以第二次执行a(10)的结果是</span></span><br><span class="line"><span class="comment"># [0, 1, 1, 2, 3, 2, 3, 5, 5, 5, 8, 10, 10]这样的，又会从2开始向后计算值了</span></span><br><span class="line">print(a.lst)</span><br><span class="line">print(a[<span class="number">3</span>])</span><br><span class="line">输出：</span><br><span class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">增加迭代的方法、返回容器长度的方法</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> iter(self.lst)</span><br></pre></td></tr></table></figure>
<p>上下文管理</p>
<p>通过上下文管理，我们可以只管打开，其他的不用关心，python解释器会为我们做，python会做一些自动化操作。你这段代理的上文和下文就是上下文</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># with open ('test') as f:</span></span><br><span class="line"><span class="comment">#    pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span>   <span class="comment"># 使用上下文管理__enter__方法也是必须的。这个方法是进去了帮我做的事情</span></span><br><span class="line">        print(<span class="string">'enter'</span>+self.__class__.__name__)</span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># 在这个语境下应该返回self，这样p和f就一样了。__enter__方法最后return的应该是一个文件对象类型。open()方法返回的实例也应该有上下文，返回一个文件对象类型</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span>  </span><br><span class="line">    <span class="comment"># 在上下文中使用类实例化时会提示类中要有__exit__方法。这个方法是离开的时候帮忙做的事情</span></span><br><span class="line">    	print(<span class="string">'Exit'</span>+self.__class__.__name__)</span><br><span class="line"> <span class="comment">#  __enter__和__exit__是实例的方法，没有实例也不会被调用</span></span><br><span class="line">		print(exc_type)   <span class="comment"># 这一句会打印raise的类型</span></span><br><span class="line">    	print(exc_val)   <span class="comment"># 这是异常类型的值 </span></span><br><span class="line">        print(exc_tb)   <span class="comment"># 执行这三条语句时还是用raise。这一句会打印traceback。这三行只在抛异常时才会有，如果没有异常，会返回None</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>  <span class="comment"># 这里的return的返回值可以决定异常是否向外抛出，这里如果返回True，就是这个方法里面管，外面可以正常执行，不会看到异常。如果返回一个等效False的，就会把异常抛出去，在外面可以看到。</span></span><br><span class="line">    </span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># with Point() as f:  # Point后面要有括号，不能直接使用。也就是类被实例化后才能使用</span></span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:   <span class="comment"># 这里会看实例p的__enter__有没有返回值，如果没有，默认会返回None，再把这个返回值给f，所以p和f是绝对不相等的</span></span><br><span class="line">   <span class="comment"># raise Exception('Error') # 有了这个raise，下面的语句就执行不到了。添加这句后，还是会执行__exit__方法的。下面也会抛异常</span></span><br><span class="line">    sys.exit()  </span><br><span class="line"><span class="comment"># 这句表示结束当前程序，使用这句，而不用上面的raise，还是会执行完__exit__结束，但下面的print()语句就不会执</span></span><br><span class="line"><span class="comment"># 行了，有此句时就会执行上面__exit__中的三个方法，没有此句时上面__exit__中的三个方法就不会执行</span></span><br><span class="line">    print(f == p)</span><br><span class="line">    print(f <span class="keyword">is</span> p)</span><br><span class="line"><span class="comment"># 这里会按Point类中定义的__enter__和__exit__方法做事情</span></span><br><span class="line"><span class="comment"># 打开文件的时候叫文件对象，文件对象内一定实现了__enter__和__exit__方法，在__enter__时一定维护了一个文件</span></span><br><span class="line"><span class="comment"># 对象，当离开with语句块时with语句块自动调用__exit__方法把资源彻底施放掉。一些预加载预处理的工作可以交给with来做</span></span><br><span class="line">	print(p)</span><br><span class="line">    print(f)</span><br><span class="line">    </span><br><span class="line">print(<span class="string">'outer'</span>)</span><br><span class="line"></span><br><span class="line">没有sys.exit()时的输出：</span><br><span class="line">init</span><br><span class="line">enterPoint</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line">&lt;__main__.Point object at <span class="number">0x7efe8a61f4a8</span>&gt;</span><br><span class="line">&lt;__main__.Point object at <span class="number">0x7efe8a61f4a8</span>&gt;</span><br><span class="line">ExitPoint</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line"><span class="keyword">None</span></span><br><span class="line"><span class="keyword">None</span></span><br><span class="line">outer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">有sys.exit()时的输出：</span><br><span class="line">init</span><br><span class="line">enterPoint</span><br><span class="line">ExitPoint</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">SystemExit</span>'&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;<span class="title">traceback</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f4e04b63f48</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">outer</span></span></span><br><span class="line"><span class="class"># 抛出的异常中的<span class="title">traceback</span>是追踪在堆栈中的执行过程，<span class="title">traceback</span>打印的就是<span class="title">exc_tb</span>部分的内容，它在堆栈上追踪了整个异常调度过程，它也会显示异常抛出的内容，在第几行出了问题</span></span><br></pre></td></tr></table></figure>
<p>练习</p>
<p>为加法函数计时</p>
<ol>
<li>使用装饰器显示该函数的执行时长</li>
<li>使用上下文管理显示该函数的执行时长</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magedu</span><span class="params">(fn)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        time_start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        print(time_start - datetime.datetime.now())</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wapper</span><br><span class="line"><span class="meta">@magedu # add = magedu(add)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">40</span>, <span class="number">50</span>)</span><br><span class="line">============================================================</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">      </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeIt</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(delta)</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> TimeIt() <span class="keyword">as</span> f:</span><br><span class="line">	add(<span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line"><span class="comment"># 这样执行可以保证add函数在f的__enter__与__exit__方法之间执行。</span></span><br><span class="line">============================================================</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps      </span><br><span class="line">      </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeIt</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self._fn = fn</span><br><span class="line">        <span class="comment"># self.__doc__ = self._fn.__doc__</span></span><br><span class="line">        <span class="comment"># self.__name__ = self._fn.__name__</span></span><br><span class="line">        <span class="comment"># 加上这两条就可以调用add的doc和name方法了</span></span><br><span class="line">        wraps(fn)(self)  <span class="comment"># 这一句就是上面的两句</span></span><br><span class="line">      </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="comment"># return self</span></span><br><span class="line">        <span class="keyword">return</span> self._fn</span><br><span class="line"><span class="comment"># 如果下面要使用with TimeIt(add) as foo这种方式，返回self是不行的，需要返回self._fn，这等于在初始化时送进去的是什么，这里就返回什么</span></span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'__call__'</span>)</span><br><span class="line">       <span class="comment">#  return self._fn(*args, **kwargs)</span></span><br><span class="line"><span class="comment"># 如果要在上下文中使用self()这种方式，可以这样写。要什么就送回去什么</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = self._fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">"dec &#123;&#125; took &#123;&#125;"</span>.format(self._fn.__name__, delta)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">"context &#123;&#125; took &#123;&#125;"</span>.format(self._fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">      </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)  # a = wraps(fn)  ;  a(wrapper)  ;  @a</span></span><br><span class="line">              <span class="comment">#     @wraps(fn)(wrapper)，源是fn，目标是wrapper</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">"dec &#123;&#125; took &#123;&#125;"</span>.format(fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="comment"># @logger</span></span><br><span class="line"><span class="meta">@TimeIt   # 这样使用类装饰器，这样就不需要函数装饰器了。类装饰器需要__call__方法，它可以把一个东西模拟成一个函数，像函数一样调用</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span>  <span class="comment"># add = TimeIt(add)</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"> <span class="comment">#   print(x + y)  加上可以把执行结果看的更明显</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">              </span><br><span class="line">print(add(<span class="number">10</span>, <span class="number">11</span>))  </span><br><span class="line">输出：</span><br><span class="line">__call__</span><br><span class="line">dec add took <span class="number">2.002072</span></span><br><span class="line"><span class="number">21</span>      </span><br><span class="line">              </span><br><span class="line">print(add.__doc__)  <span class="comment"># add现在已经被包装成一个可调用对象，这个对象是就是TimeIt的实例，实例调用__name__是调不出来的</span></span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line">              </span><br><span class="line">print(add.__name__)</span><br><span class="line">输出：</span><br><span class="line">add</span><br><span class="line">              </span><br><span class="line">print(add.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'_fn'</span>: &lt;function add at <span class="number">0x7f5acfe641e0</span>&gt;, <span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__name__'</span>: <span class="string">'add'</span>, <span class="string">'__qualname__'</span>: <span class="string">'add'</span>, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'__annotations__'</span>: &#123;&#125;, <span class="string">'__wrapped__'</span>: &lt;function add at <span class="number">0x7f5acfe641e0</span>&gt;&#125;</span><br><span class="line">              </span><br><span class="line">print(type(add))</span><br><span class="line">输出：</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">TimeIt</span>'&gt;</span></span><br><span class="line"><span class="class">              </span></span><br><span class="line"><span class="class"><span class="title">with</span> <span class="title">TimeIt</span><span class="params">(add)</span> <span class="title">as</span> <span class="title">f</span>:</span>  <span class="comment"># 这里的add是装饰器装饰过的</span></span><br><span class="line">	add(<span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line"><span class="comment"># 使用装饰器后，add就有了__call__属性，add()就会调用__call__方法。这个方法把装饰器和上下文管理的方法都执行了</span></span><br><span class="line">有@TimeIt的输出结果：</span><br><span class="line">enter</span><br><span class="line">__call__</span><br><span class="line">dec add took <span class="number">2.00211</span></span><br><span class="line">exit</span><br><span class="line">context add took <span class="number">2.002252</span></span><br><span class="line"></span><br><span class="line">没有@TimeIt的输出结果：</span><br><span class="line"><span class="comment"># 没有装饰器时只会按上下文管理执行</span></span><br><span class="line">enter</span><br><span class="line">exit</span><br><span class="line">context add took <span class="number">2.002158</span></span><br><span class="line">              </span><br><span class="line"><span class="keyword">with</span> TimeIt(add) <span class="keyword">as</span> foo:</span><br><span class="line">	foo(<span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line"><span class="comment"># 根据代码中初始化的定义，使用上下文管理后，foo就成了被装饰的函数，所以可以使用foo(5, 6)</span></span><br></pre></td></tr></table></figure>
<p>contextlib.contextmanager</p>
<p>yield返回单值，如yield x,y就是返回单值，x,y也是单值，是被封装后的单值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'enter'</span>)  <span class="comment"># 这只是类似__enter__()，但并不是，只是模拟</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span>,<span class="number">5</span>  <span class="comment"># 这样会输出一个元组</span></span><br><span class="line">    print(<span class="string">'exit'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> foo() <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	<span class="keyword">raise</span> Exception</span><br><span class="line">    <span class="comment"># 加入raise后，上面的foo函数是执行不到yield的</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        print(<span class="string">'exit'</span>)   <span class="comment"># 如果要执行到这句，就要用这种方式</span></span><br><span class="line">    print(f)</span><br><span class="line">输出</span><br><span class="line">enter</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line">exit</span><br><span class="line"><span class="comment"># 输出把None加在了中间。foo函数生成器拿到后第一次做next()的话，执行到yield就停了，print('exit')不会被打</span></span><br><span class="line"><span class="comment"># 印，做第二次next()时才会打印，然后整个函数就return了，也就是print('exit')后面相当于有一句return，只是</span></span><br><span class="line"><span class="comment"># 没写出来。try是核心逻辑，finally是要做的清理工作。</span></span><br></pre></td></tr></table></figure>
<p>total_ordering</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> total_ordering</span><br><span class="line"><span class="comment"># 这个方法可以做所有的比较，这是一个装饰器。但一定要定义eq方法，其他的要使用</span></span><br><span class="line"><span class="comment"># 一个一般用lt方法</span></span><br><span class="line"><span class="meta">@total_ordering</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x &lt; other.x</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x</span><br><span class="line">    </span><br><span class="line">print(A(<span class="number">5</span>) &gt;= A(<span class="number">6</span>))</span><br><span class="line">print(A(<span class="number">5</span>) &gt; A(<span class="number">6</span>))</span><br><span class="line">print(A(<span class="number">5</span>) &lt;= A(<span class="number">6</span>))</span><br><span class="line">print(A(<span class="number">5</span>) == A(<span class="number">6</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>反射</p>
<p>理解反射先要理解什么是编译时什么是运行时，python是动态语言，更多的表现是在运行时，运行时指解释器加载代码后是什么状态，它更多的在意在执行的过程中是什么情况，执行过程中就是加载到内存中了。</p>
<p>反射指在运行时，它能够通过对象找到对象相关的类型信息，类型信息指我是什么类型，我有什么属性，因为有些类型在方法上，所以就要在运行时在类上找到他类型相关的所有信息。找信息与反射的关系是从它自身反射出了它的所有类型信息，这个过程就叫反射，通过这种机制，就可以在运行时掌握所有类型信息。一个对象可以在运行时反射出自己与类型相关的所有信息，这就是反射机制。反射也称为自省</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.x = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">setattr(A, <span class="string">'y'</span>, <span class="number">10</span>)   <span class="comment"># 给A类加一个y属性，值是10。属性必须是字符串，下面打印类的属性就可以看到了。这与实例无关</span></span><br><span class="line">print(A.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function A.__init__ at <span class="number">0x7f1f915491e0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'A'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'A'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'y'</span>: <span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line">print(a.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">print(getattr(a, <span class="string">'x'</span>))  <span class="comment"># 使用getattr方法取a实例的x属性的值</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">5</span></span><br><span class="line"></span><br><span class="line">print(getattr(a, <span class="string">'y'</span>))  <span class="comment"># 这样可以取到类上的属性值，这也是先找自己的dict，如果没有就找父类的dict</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">10</span></span><br><span class="line"></span><br><span class="line">print(getattr(a, <span class="string">'yy'</span>, <span class="number">100</span>))  <span class="comment"># 这样是找不到的，所以给了一个缺省值100</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> hasattr(a, <span class="string">'z'</span>):</span><br><span class="line">    print(getattr(a, <span class="string">'z'</span>))</span><br><span class="line"><span class="comment"># 什么都不会输出</span></span><br><span class="line"></span><br><span class="line">setattr(a, <span class="string">'y'</span>, <span class="number">1000</span>)   <span class="comment"># 这相当于给a.y赋值，会覆盖上面的setattr(A, 'y', 10) </span></span><br><span class="line">print(A.__dict__)  <span class="comment"># 查找顺序还是自己优先，然后是父类，之后是祖先类</span></span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function A.__init__ at <span class="number">0x7f299adc11e0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'A'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'A'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'y'</span>: <span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line">print(a.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">5</span>, <span class="string">'y'</span>: <span class="number">1000</span>&#125;</span><br><span class="line"></span><br><span class="line">print(getattr(a, <span class="string">'y'</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1000</span></span><br><span class="line"></span><br><span class="line">print(getattr(A, <span class="string">'y'</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">10</span></span><br><span class="line"></span><br><span class="line">setattr(a, <span class="string">'mtd'</span>, <span class="keyword">lambda</span> self: <span class="number">1</span>)  <span class="comment"># mtd属性是加到实例上了</span></span><br><span class="line">print(A.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function A.__init__ at <span class="number">0x7f41e87dd1e0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'A'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'A'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'y'</span>: <span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line">print(a.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">5</span>, <span class="string">'y'</span>: <span class="number">1000</span>, <span class="string">'mtd'</span>: &lt;function &lt;<span class="keyword">lambda</span>&gt; at <span class="number">0x7f41e88f21e0</span>&gt;&#125;</span><br><span class="line"></span><br><span class="line">a.mtd()  <span class="comment"># 这里会显示mtd有问题，因为是编译时加进去的，所以不用管。这样当执行到mtd时会去找lambda函数，之后</span></span><br><span class="line"><span class="comment"># 返回1。这看似没有问题，但执行时会提示缺少self，没有把实例放到第一个参数上。如果把上面改成</span></span><br><span class="line"><span class="comment"># setattr(A, 'mtd', lambda self: 1)，再执行a.mtd()就没问题了，但这是把属性加到类上了。在类里定义会和实</span></span><br><span class="line"><span class="comment"># 例绑定</span></span><br><span class="line"><span class="comment"># 方法可以放在实例上，只是定义时没法写进去，因为定义时还没有实例，但运行时实例就可以存在，这样就可以在实例的字</span></span><br><span class="line"><span class="comment"># 典里写上key和value，只是没有绑定。推荐加到类上。上面如果不想报错，又添加到实例上，可以写成a.mtd(a)</span></span><br><span class="line">输出：</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/面向对象/魔术方法/反射课上练习.py"</span>, line <span class="number">223</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    a.mtd()</span><br><span class="line">TypeError: &lt;<span class="keyword">lambda</span>&gt;() missing <span class="number">1</span> required positional argument: <span class="string">'self'</span></span><br></pre></td></tr></table></figure>
<p>在运行时需要添加属性，就需要上面的方法了。装饰器和Mixin是在编译期要定义好的，不能动态改变</p>
<p>练习</p>
<p>命令分发器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">    cmds = &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(cmd, fn)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(cmd, str):</span><br><span class="line">        	cmds[cmd] = fn</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'error'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        	cmd = input(<span class="string">"plz input command: "</span>)</span><br><span class="line">            <span class="keyword">if</span> cmd.strip() == <span class="string">'quit'</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            cmds.get(cmd.strip(), defaultfn)()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">defaultfn</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> reg, run</span><br><span class="line"></span><br><span class="line">reg,run = dispatcher()</span><br><span class="line">reg(<span class="string">'cmd1'</span>, <span class="keyword">lambda</span> : <span class="number">1</span>)</span><br><span class="line">reg(<span class="string">'cmd2'</span>, <span class="keyword">lambda</span> : <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">run()</span><br><span class="line">============================================================================================</span><br><span class="line">把上面的分发器函数改成类</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd1</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'cmd1'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(self, cmd, fn)</span>:</span>  <span class="comment"># 注册函数</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(cmd, str):</span><br><span class="line">            setattr(type(self), cmd, fn)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'error'</span>)</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span>  <span class="comment"># 执行入口</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            cmd = input(<span class="string">"plz input command: "</span>)</span><br><span class="line">            <span class="keyword">if</span> cmd.strip() == <span class="string">'quit'</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            getattr(self, cmd.strip(), self.defaultfn)()</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">defaultfn</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'default'</span>)</span><br><span class="line">        </span><br><span class="line">dis = dispatcher()</span><br><span class="line"></span><br><span class="line">dis.reg(<span class="string">'cmd2'</span>, <span class="keyword">lambda</span> self: print(<span class="number">2</span>))</span><br><span class="line">dis.reg(<span class="string">'cmd3'</span>, <span class="keyword">lambda</span> self: print(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">dis.run()</span><br><span class="line">输出：</span><br><span class="line">plz input command : abc</span><br><span class="line">default</span><br><span class="line">plz input command : cmd2</span><br><span class="line"><span class="number">2</span></span><br><span class="line">plz input command : cmd3</span><br><span class="line"><span class="number">3</span></span><br><span class="line">plz input command : quit</span><br></pre></td></tr></table></figure>
<p>反射相关的魔术方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'__getattr__'</span>, item)</span><br><span class="line">        </span><br><span class="line">print(A(<span class="number">10</span>).x)</span><br><span class="line">print(A(<span class="number">10</span>).y)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">10</span></span><br><span class="line">__getattr__ y</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line"><span class="comment"># 一个类的属性会按照继承关系找，如果找不到，就会执行__getattr__()方法，如果没有这个方法，就会抛出AttributeError异常表示找不到属性。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找属性顺序为：</span></span><br><span class="line"><span class="comment"># instance.__dict__ --&gt; instance.__class__.__dict__ --&gt; 继承的祖先类（直到object）的__dict__ --找不到--&gt; 调用__getattr__() </span></span><br><span class="line">============================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(Base)</span>:</span></span><br><span class="line">    m = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'__getattr__'</span>, item)</span><br><span class="line">        <span class="comment"># self.__dict__[item]  = # 找不到给一个缺省值 </span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(key, value)</span><br><span class="line"><span class="comment"># 当设置一个属性的时候，这个setattr方法是一定会被触发的，但是究竟放不放到里面去就是我们的事了   </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'delattr'</span>)   <span class="comment"># 删除实例属性</span></span><br><span class="line"><span class="comment"># setattr和delattr是不论是否找到了属性，都会被触发。一般delete都是删除自己有的属性，setattr有没有没关</span></span><br><span class="line"><span class="comment"># 系，都可以加进来，如果没有getattr方法，找不到，应该抛异常的，但是如果有getattr方法，找不到时getattr方法</span></span><br><span class="line"><span class="comment"># 就会拦一道，有了这个拦截，异常就没有了。</span></span><br><span class="line">a = A(<span class="number">10</span>)</span><br><span class="line">输出：</span><br><span class="line">x <span class="number">10</span>  <span class="comment"># 触发了__setattr__方法</span></span><br><span class="line"></span><br><span class="line">a.x = <span class="number">100</span></span><br><span class="line">输出：</span><br><span class="line">x <span class="number">100</span></span><br><span class="line"></span><br><span class="line">a.m = <span class="number">200</span></span><br><span class="line">输出：</span><br><span class="line">m <span class="number">200</span></span><br><span class="line"><span class="comment"># 给实例属性赋值也会触发__setattr__方法，但是是否加入实例中需要我们自己决定，也就是给实例属性赋值时会被__setattr__方法拦截</span></span><br><span class="line"></span><br><span class="line">print(a.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">print(A.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'m'</span>: <span class="number">6</span>, <span class="string">'__init__'</span>: &lt;function A.__init__ at <span class="number">0x7f767639f1e0</span>&gt;, <span class="string">'__getattr__'</span>: &lt;function A.__getattr__ at <span class="number">0x7f76763e2ae8</span>&gt;, <span class="string">'__setattr__'</span>: &lt;function A.__setattr__ at <span class="number">0x7f76763e2ea0</span>&gt;, <span class="string">'__delattr__'</span>: &lt;function A.__delattr__ at <span class="number">0x7f767638bae8</span>&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"></span><br><span class="line">a.y</span><br><span class="line">输出：</span><br><span class="line">__getattr__ y  <span class="comment"># 触发__getattr__方法，这是在实例和类字典中都找不到时，最后要执行__getattr__方法，所以会打印__getattr__ y和下面的__getattr__ z</span></span><br><span class="line"></span><br><span class="line">a.z</span><br><span class="line">输出：</span><br><span class="line">__getattr__ z</span><br><span class="line"></span><br><span class="line">a.m</span><br><span class="line">a.n  <span class="comment"># 这是测试__getattr__方法，这两条都没有输出。证明没有触发__getattr__方法，也就是找到了a.m和a.n</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> a.x</span><br><span class="line">输出：</span><br><span class="line">delattr</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> a.m  <span class="comment"># 通过实例可以访问到的属性都可以删除</span></span><br><span class="line">输出：</span><br><span class="line">delattr</span><br></pre></td></tr></table></figure>
<p><code>__getattribute__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(Base)</span>:</span></span><br><span class="line">    m = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span><span class="params">(self, item)</span>:</span>  <span class="comment"># 这个方法会最先执行，但一般不用</span></span><br><span class="line">        print(<span class="string">'__getattribute__'</span>, item)</span><br><span class="line"><span class="comment"># get的意思就是拿回来，回去是靠return的，这些get方法一个return都没有，get方法一般就是把什么东西给人家送回</span></span><br><span class="line"><span class="comment"># 去，但这里没有return，所以返回的是None。__getattr__方法是在翻了一遍字典没有翻到时执行的。</span></span><br><span class="line"><span class="comment"># __getattribute__是还没到字典去就起作用了，在找字典前，__getattribute__会拦住并执行一次</span></span><br><span class="line">		<span class="comment"># raise AttributeError(item)  # 这会跳过翻字典的过程，下面的getattr也会执行一次</span></span><br><span class="line">    	<span class="comment"># return self.__dict__[item]  # 这会产生递归调用，出现问题</span></span><br><span class="line">        <span class="keyword">return</span> object.__getattribute__(self, item)   <span class="comment"># 这样做是没必要的</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'__getattr__'</span>, item)</span><br><span class="line">        <span class="comment"># self.__dict__[item]  = # 找不到给一个缺省值 </span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(key, value)</span><br><span class="line"><span class="comment"># 当设置一个属性的时候，这个setattr方法是一定会被触发的，但是究竟放不放到里面去就是我们的事了   </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'delattr'</span>)  </span><br><span class="line">        </span><br><span class="line">a = A(<span class="number">10</span>)</span><br><span class="line">print(a.x)  <span class="comment"># 这里getattribute调用了</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/python基础学习-多继承/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/python基础学习-多继承/" itemprop="url">
                  python基础学习-多继承
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-07 15:32:39" itemprop="dateCreated datePublished" datetime="2020-03-07T15:32:39+08:00">2020-03-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-07-29 10:01:38" itemprop="dateModified" datetime="2020-07-29T10:01:38+08:00">2020-07-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Python不同版本的类"><a href="#Python不同版本的类" class="headerlink" title="Python不同版本的类"></a>Python不同版本的类</h3><p>Python2.2之前是没有共同的祖先的，之后，引入<code>object</code>类，它是所有类的共同祖先类<code>object</code>。</p>
<p>Python2中为了兼容，分为古典类（旧式类）和新式类。</p>
<p>Python3中全部都是新式类</p>
<p>新式类都是继承自<code>object</code>的，新式类可以使用<code>super</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以下代码在Python2.x中运行</span></span><br><span class="line"><span class="comment"># 古典类（旧式类）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新式类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(object)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(dir(A))</span><br><span class="line">print(dir(B))</span><br><span class="line">print(A.__bases__)</span><br><span class="line">print(B.__bases__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 古典类</span></span><br><span class="line">a = A()</span><br><span class="line">print(a.__class__)</span><br><span class="line">print(type(a))   <span class="comment"># &lt;type 'instance'&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新式类</span></span><br><span class="line">b = B()</span><br><span class="line">print(b.__class__)</span><br><span class="line">print(type(b))</span><br></pre></td></tr></table></figure>
<h3 id="多继承"><a href="#多继承" class="headerlink" title="多继承"></a>多继承</h3><p>OCP原则：多用“继承”、少修改</p>
<p>继承的用途：增加基类、实现多态</p>
<p>多态</p>
<p>在面向对象中，父类、子类通过继承联系在一起，如果可以通过一套方法，就可以实现不同表现，就是多态。</p>
<p>一个类继承自多个类就是多继承，它将具有多个类的特征。</p>
<h3 id="多继承弊端"><a href="#多继承弊端" class="headerlink" title="多继承弊端"></a>多继承弊端</h3><p>多继承很好的模拟了世界，因为事物很少是单一继承，但是舍弃简单，必然引入复杂性，带来了冲突。</p>
<p>如同一个孩子继承了来自父母双方的特征。那么到底眼睛像爸爸还是妈妈呢？孩子究竟该像谁多一点呢？</p>
<p>多继承的实现会导致编译器设计的复杂度增加，所以现在很多语言也舍弃了类的多继承。</p>
<p>C++支持多继承；Java舍弃了多继承。</p>
<p>Java中，一个类可以实现多个接口，一个接口也可以继承多个接口。Java的接口很纯粹，只是方法的声明，继承者必须实现这些方法，就具有了这些能力，就能干什么。</p>
<p>多继承可能会带来二义性，例如，猫和狗都继承自动物类，现在如果一个类多继承了猫和狗类，猫和狗都有<code>shout</code>方法，子类究竟继承谁的<code>shout</code>呢？</p>
<p>解决方案</p>
<p>实现多继承的语言，要解决二义性，深度优先或者广度优先。</p>
<h3 id="Python多继承实现"><a href="#Python多继承实现" class="headerlink" title="Python多继承实现"></a>Python多继承实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassName</span><span class="params">(基类列表)</span>:</span></span><br><span class="line">    类体</span><br></pre></td></tr></table></figure>
<p><img src="/images/python多继承/python多继承1.png" alt=""></p>
<p>左图是多继承，右图是单一继承</p>
<p>多继承带来路径选择问题，究竟继承哪个父类的特征呢</p>
<p>Python使用MRO(method resolution order)解决基类搜索顺序问题。</p>
<ul>
<li><p>历史原因，MRO有三个搜索算法：</p>
<ul>
<li><p>经典算法，按照定义从左到右，深度优先策略。2.2之前</p>
<p>左图的MRO是MyClass,D,B,A,C,A</p>
</li>
<li><p>新式类算法，经典算法的升级，重复的只保留最后一个。2.2</p>
<p>左图的MRO是MyClass,D,B,C,A,object</p>
</li>
<li><p>C3算法，在类被创建出来的时候，就计算出一个MRO有序列表。2.3之后，Python3唯一支持的算法</p>
<p>左图中的MRO是MyClass,D,B,C,A,object的列表</p>
<p>C3算法解决多继承的二义性</p>
</li>
</ul>
</li>
</ul>
<h3 id="多继承的缺点"><a href="#多继承的缺点" class="headerlink" title="多继承的缺点"></a>多继承的缺点</h3><p>当类很多，继承复杂的情况下，继承路径太多，很难说清什么样的继承路径。</p>
<p>Python语法是允许多继承，但Python代码是解释执行，只有执行到的时候，才发现错误。</p>
<p>团队协作开发，如果引入多继承，那代码将不可控。</p>
<p>不管编程语言是否支持多继承，都应当避免多继承。</p>
<p>Python的面向对象，我们看到的太灵活了，太开放了，所以要团队守规矩。</p>
<h3 id="Mixin"><a href="#Mixin" class="headerlink" title="Mixin"></a>Mixin</h3><p>类有下面的继承关系</p>
<p><img src="/images/python多继承/python多继承2.png" alt=""></p>
<p>文档Document类是其他所有文档类的抽象基类；</p>
<p>Word、Pdf是Document的子类。</p>
<p>需求：为Document子类提供打印能力</p>
<p>思路：</p>
<ol>
<li>在Document中提供print方法</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"><span class="comment"># raise是手动设置异常的方法。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span></span><br><span class="line">=====================================================================================</span><br><span class="line"><span class="keyword">raise</span> 语句的基本语法格式为：</span><br><span class="line"><span class="keyword">raise</span> [exceptionName [(reason)]]</span><br><span class="line"><span class="comment"># 用 [] 括起来的为可选参数，其作用是指定抛出的异常名称，以及异常信息的相关描述。如果可选参数全部省</span></span><br><span class="line"><span class="comment"># 略，则 raise 会把当前错误原样抛出；如果仅省略 (reason)，则在抛出异常时，将不附带任何的异常描述信</span></span><br><span class="line"><span class="comment"># 息。</span></span><br><span class="line"><span class="comment"># raise 语句有如下三种常用的用法：</span></span><br><span class="line"><span class="comment"># raise：单独一个 raise。该语句引发当前上下文中捕获的异常（比如在 except 块中），或默认引发</span></span><br><span class="line"><span class="comment"># RuntimeError 异常。</span></span><br><span class="line"><span class="comment"># raise 异常类名称：raise 后带一个异常类名称，表示引发执行类型的异常。</span></span><br><span class="line"><span class="comment"># raise 异常类名称(描述信息)：在引发指定类型的异常的同时，附带异常的描述信息。</span></span><br><span class="line"><span class="comment"># 引用：http://c.biancheng.net/view/2360.html</span></span><br><span class="line">=====================================================================================</span><br></pre></td></tr></table></figure>
<p>基类提供的方法不应该具体实现，因为它未必适合子类的打印，子类中需要覆盖重写。</p>
<p><code>print</code>算是一种能力–打印功能，不是所有的<code>Document</code>的子类都需要的，所以，从这个角度出发，有点问题。</p>
<ol start="2">
<li>需要打印的子类上增加</li>
</ol>
<p>如果在现有子类上直接增加，违反了OCP的原则，所以应该继承后增加，因此有下图</p>
<p><img src="/images/python多继承/python多继承3.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Printable</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.content)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span>   <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableWord</span><span class="params">(Printable, Word)</span>:</span> <span class="keyword">pass</span></span><br><span class="line">print(PrintableWord.__dict__)</span><br><span class="line">print(PrintableWord.mro())</span><br><span class="line"></span><br><span class="line">pw = PrintableWord(<span class="string">'test string'</span>)</span><br><span class="line">pw.print()</span><br><span class="line">print(pw.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">[&lt;class '__main__.PrintableWord'&gt;, &lt;class '__main__.Printable'&gt;, &lt;class '__main__.Word'&gt;, &lt;class '__main__.Document'&gt;, &lt;class 'object'&gt;]</span><br><span class="line">test string</span><br><span class="line">&#123;<span class="string">'content'</span>: <span class="string">'test string'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>看似不错，如果还需要提供其他能力，如何继承？</p>
<p>应用于网络，文档应该具备序列化的能力，类上就应该实现序列化。</p>
<p>可序列化还可能分为使用pickle、json、messagepack等。</p>
<p>这个时候发现，类可能太多了，继承的方式不是很好了。</p>
<p>功能太多，A类需要某几样功能，B类需要另几样功能，很繁琐。</p>
<ol start="3">
<li>装饰器</li>
</ol>
<p>用装饰器增强一个类，把功能给类附加上去，哪个类需要，就装饰它</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printable</span><span class="params">(cls)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_print</span><span class="params">(self)</span>:</span>  <span class="comment"># 这里self表示送进来的实例，比如下面的pw实例</span></span><br><span class="line">        print(self.content, <span class="string">'装饰器'</span>)</span><br><span class="line">    cls.<span class="keyword">print</span> = _print  <span class="comment"># 赋值即定义，给类加一个属性</span></span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span> <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@printable  # 先继承，后装饰</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableWord</span><span class="params">(Word)</span>:</span> <span class="keyword">pass</span></span><br><span class="line">print(PrintableWord.__dict__)</span><br><span class="line">print(PrintableWord.mro())</span><br><span class="line"></span><br><span class="line">pw = PrintableWord(<span class="string">'test string'</span>)</span><br><span class="line">pw.print()</span><br><span class="line"></span><br><span class="line"><span class="meta">@printable</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintablePdf</span><span class="params">(Word)</span>:</span> <span class="keyword">pass</span></span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'print'</span>: &lt;function printable.&lt;locals&gt;._print at <span class="number">0x7f1114f72550</span>&gt;&#125;</span><br><span class="line"><span class="comment"># 这里PrintableWord类多了一个print属性</span></span><br><span class="line">[&lt;class '__main__.PrintableWord'&gt;, &lt;class '__main__.Word'&gt;, &lt;class '__main__.Document'&gt;, &lt;class 'object'&gt;]</span><br><span class="line">test string 装饰器</span><br></pre></td></tr></table></figure>
<p>优点：</p>
<p>简单方便，在需要的地方动态增加，直接使用装饰器</p>
<ol start="4">
<li>Mixin</li>
</ol>
<p>先看代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span>   <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableMixin</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.content, <span class="string">'Mixin'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableWord</span><span class="params">(PrintableMixin, Word)</span>:</span> <span class="keyword">pass</span></span><br><span class="line">print(PrintableWord.__dict__)</span><br><span class="line">print(PrintableWord.mro())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printable</span><span class="params">(cls)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.content, <span class="string">'装饰器'</span>)</span><br><span class="line">    cls.<span class="keyword">print</span> = _print</span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"></span><br><span class="line"><span class="meta">@printable</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintablePdf</span><span class="params">(Word)</span>:</span> <span class="keyword">pass</span></span><br><span class="line">print(PrintablePdf.__dict__)</span><br><span class="line">print(PrintablePdf.mro())</span><br></pre></td></tr></table></figure>
<p>Mixin就是其它类混合进来，同时带来了类的属性和方法</p>
<p>这里看来Mixin类和装饰器效果一样，也没有什么特别的。但是Mixin是类，就可以继承。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span>   <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span> <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(DOcument)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 第三方库，不允许修改</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableMixin</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.content, <span class="string">'Mixin'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableWord</span><span class="params">(PrintableMixin, Word)</span>:</span> <span class="keyword">pass</span></span><br><span class="line">print(PrintableWord.__dict__)</span><br><span class="line">print(PrintableWord.mro())</span><br><span class="line"></span><br><span class="line">pw = PrintableWord(<span class="string">'test string'</span>)</span><br><span class="line">pw.print()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperPrintableMixin</span><span class="params">(PrintableMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'~'</span> * <span class="number">20</span>)   <span class="comment"># 打印增强</span></span><br><span class="line">        super().print()</span><br><span class="line">        print(<span class="string">'~'</span> * <span class="number">20</span>)   <span class="comment"># 打印增强</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># PrintableMixin类的继承</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperPrintablePdf</span><span class="params">(SuperPrintableMixin, Pdf)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(SuperPrintablePdf.__dict__)</span><br><span class="line">print(SuperPrintablePdf.mro())</span><br><span class="line"></span><br><span class="line">spp = SuperPrintablePdf(<span class="string">'super print pdf'</span>)</span><br><span class="line">spp.print()</span><br></pre></td></tr></table></figure>
<h3 id="Mixin类"><a href="#Mixin类" class="headerlink" title="Mixin类"></a>Mixin类</h3><p>Mixin本质上就是多继承实现的</p>
<p>Mixin体现的是一种组合的设计模式。</p>
<p>在面向对象的设计中，一个复杂的类，往往需要很多功能，而这些功能有来自不同的类提供，这就需要很多的类组合在一起。</p>
<p>从设计模式的角度来说，多组合，少继承。</p>
<p>Mixin类的使用原则</p>
<ul>
<li>Mixin类中不应该显式的出现<code>__init__</code>初始化方法</li>
<li>Mixin类通常不能独立工作，因为它是准备混入别的类中的部分功能实现</li>
<li>Mixin类的祖先类也应是Mixin类</li>
</ul>
<p>使用时，Mixin类通常在继承列表的第一个位置，例如<code>class PrintableWord(PrintableMixin, Word): pass</code></p>
<p>Mixin类和装饰器</p>
<p>这两种方式都可以使用，看个人喜好</p>
<p>如果还需要继承就得使用Mixin类的方式。</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><ol>
<li>Shape基类，要求所有子类都必须提供面积的计算，子类有三角形、矩形、圆。</li>
<li>上题圆类的数据可序列化</li>
</ol>
<p>参考</p>
<ol>
<li>Shape基类，要求所有子类都必须提供面积的计算，子类有三角形、矩形、圆。</li>
</ol>
<p>思路</p>
<p>既然是基类，那么就应该有一个东西大家共同继承是最好的。都需要计算面积，面积可以是一个属性，也可以是一个方法。属性有两种东西，一种是真正的属性，一种是property装饰的属性，装饰的属性就是个方法。计算面积本来就是个动作，每一个子类都应该继承父类这个动作，至少应该实现一个求面积的方法，如何让这个动作像个属性暴露给别人，一调用就出来呢，这就需要装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span>:</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">'基类未实现'</span>)</span><br><span class="line"><span class="comment"># 在父类中如果定义了一种规范，所有子类遵照这种规范。通过这种方式，要求子类的area必须实现，如果子类不实现，别</span></span><br><span class="line"><span class="comment"># 人在调用子类时一定会抛异常。在父类中定义一个统一的方法或属性，子类可以直接继承，如果防止别人调用父类的方法或</span></span><br><span class="line"><span class="comment"># 属性呢，如果是属性可以给None，如果是方法可以使用raise Not...抛异常</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Triangle</span><span class="params">(Shape)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, a, b, c)</span>:</span></span><br><span class="line">        self.a = a</span><br><span class="line">        self.b = b</span><br><span class="line">        self.c = c</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line">        p = (self.a+self.b+self.c)/<span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> math.sqrt(p*(p-self.a)*(p-self.b)*(p-self.c))</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span><span class="params">(Shape)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, width, height)</span>:</span></span><br><span class="line"><span class="comment"># 子类需要使用__init__时，就算父类是一个空实现，也要用super。如果父类实现的不好，子类使用__init__时会有黄</span></span><br><span class="line"><span class="comment"># 底的提示。可以将父类的__init__取消，直接定义一个area方法，但父类的area方法好像写什么都不合适。但父类应该</span></span><br><span class="line"><span class="comment"># 提供一个模板给子类看，提示一个求面积的公式给大家看。之后再在子类中定义同名方法覆盖父类的方法。如果要添加文</span></span><br><span class="line"><span class="comment"># 档，最好使用双引号，如""" xxx """</span></span><br><span class="line">        self.width = width</span><br><span class="line">        self.height = height</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.width * self.height</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span><span class="params">(Shape)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, radius)</span>:</span></span><br><span class="line">        self.d = radius * <span class="number">2</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> math.pi * self.d * self.d * <span class="number">0.25</span></span><br><span class="line">    </span><br><span class="line">shapes = [Triangle(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>), Rectangle(<span class="number">3</span>,<span class="number">4</span>), Circle(<span class="number">4</span>)]</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> shapes:</span><br><span class="line">    print(<span class="string">'The area of &#123;&#125; = &#123;&#125;'</span>.format(s.__class__.__name__, s.area))</span><br><span class="line">输出：</span><br><span class="line">The area of Triangle = <span class="number">6.0</span></span><br><span class="line">The area of Rectangle = <span class="number">12</span></span><br><span class="line">The area of Circle = <span class="number">50.26548245743669</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>圆类的数据可序列化</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 建议用装饰器再实现一遍</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> msgpack</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializableMixin</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dumps</span><span class="params">(self, t=<span class="string">'json'</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> t == <span class="string">'json'</span>:</span><br><span class="line">            <span class="keyword">return</span> json.dumps(self.__dict__)</span><br><span class="line">        <span class="keyword">elif</span> t == <span class="string">'msgpack'</span>:</span><br><span class="line">            <span class="keyword">return</span> msgpack.packb(self.__dict__)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> NotImplementedError(<span class="string">'没有实现的序列化'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializableCircleMixin</span><span class="params">(SerializableMixin, Circle)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">scm = SerializableCircleMixin(<span class="number">4</span>)</span><br><span class="line">print(scm.area)</span><br><span class="line">s = scm.dumps(<span class="string">'msgpack'</span>)</span><br><span class="line">print(s)</span><br><span class="line">s = scm.dumps(<span class="string">'json'</span>)</span><br><span class="line">print(s)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="string">b'\x81\xa1d\x08'</span></span><br><span class="line">&#123;<span class="string">"d"</span>: <span class="number">8</span>&#125;</span><br><span class="line">=========================================================================================</span><br><span class="line"><span class="comment"># 个人尝试了两种装饰器方法</span></span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> msgpack</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span>:</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">'基类未实现'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">SerializableCircle</span><span class="params">(cls)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.t == <span class="string">'json'</span>:</span><br><span class="line">            <span class="keyword">return</span> json.dumps(self.__dict__)</span><br><span class="line">        <span class="keyword">elif</span> self.t == <span class="string">'msgpack'</span>:</span><br><span class="line">            <span class="keyword">return</span> msgpack.packb(self.__dict__)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> NotImplementedError(<span class="string">'没有实现的序列化'</span>)</span><br><span class="line">        <span class="comment"># print('OKOKOKOK')</span></span><br><span class="line">    cls.xulei = wrapper</span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"></span><br><span class="line"><span class="meta">@SerializableCircle</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span><span class="params">(Shape)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, radius,t=<span class="string">'json'</span>)</span>:</span></span><br><span class="line">        self.d = radius * <span class="number">2</span></span><br><span class="line">        self.t = t</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> math.pi * self.d * self.d * <span class="number">0.25</span></span><br><span class="line"></span><br><span class="line">scm = Circle(<span class="number">5</span>)</span><br><span class="line">print(scm.xulei())</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">"d"</span>: <span class="number">10</span>, <span class="string">"t"</span>: <span class="string">"json"</span>&#125;</span><br><span class="line"><span class="comment"># 这样写的问题是，将t也加入到了序列化中，这样好像不太合理</span></span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> msgpack</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span>:</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">'基类未实现'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">SerializableCircle</span><span class="params">(cls)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(self,t=<span class="string">'json'</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> t == <span class="string">'json'</span>:</span><br><span class="line">            <span class="keyword">return</span> json.dumps(self.__dict__)</span><br><span class="line">        <span class="keyword">elif</span> t == <span class="string">'msgpack'</span>:</span><br><span class="line">            <span class="keyword">return</span> msgpack.packb(self.__dict__)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> NotImplementedError(<span class="string">'没有实现的序列化'</span>)</span><br><span class="line">    cls.xulei = wrapper  </span><br><span class="line"><span class="comment"># cls.xulei就是wrapper，所以调用时要向cls.xulei()中传入参数t的值，否则就使用默认值</span></span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"></span><br><span class="line"><span class="meta">@SerializableCircle</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span><span class="params">(Shape)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, radius)</span>:</span></span><br><span class="line">        self.d = radius * <span class="number">2</span></span><br><span class="line">        <span class="comment"># self.t = t</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> math.pi * self.d * self.d * <span class="number">0.25</span></span><br><span class="line"></span><br><span class="line">scm = Circle(<span class="number">5</span>)</span><br><span class="line">print(scm.xulei(<span class="string">'msgpack'</span>))</span><br><span class="line">print(scm.xulei())</span><br><span class="line">输出：</span><br><span class="line"><span class="string">b'\x81\xa1d\n'</span></span><br><span class="line">&#123;<span class="string">"d"</span>: <span class="number">10</span>&#125;</span><br><span class="line"><span class="comment"># 这种写装饰器似乎比上面要好一些</span></span><br></pre></td></tr></table></figure>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>用面向对象实现LinkedList链表</p>
<p>单向链表实现<code>append</code>、<code>iternodes</code>方法</p>
<p>双向链表实现<code>append</code>、<code>pop</code>、<code>insert</code>、<code>remove</code>、<code>iternodes</code>方法</p>
<p><img src="/images/python多继承/python多继承4.png" alt=""></p>
<p>参考</p>
<p>对于链表来说，每一个结点是一个独立的对象，结点自己知道内容是什么，下一跳是什么。而链表则是一个容器，它内部装着一个个结点对象。所以，建议设计2个类，一个结点Node类，一个链表LinkedList类。</p>
<p>将链表的整体看作一个对象，是一个容器，容器中间放的是相同的，只是实例不同而已。实例有两个属性，一个是插入的内容，一个是内容指向</p>
<h4 id="单向链表1"><a href="#单向链表1" class="headerlink" title="单向链表1"></a>单向链表1</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 笔记</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleNode</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    代表一个节点，存储节点Node</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, val, next=None)</span>:</span>   </span><br><span class="line"><span class="comment"># 这是向类中放数据的过程，value是一个值，就代表上图中的一个个数字。如5、7。next只作为形参，想给值也可以。</span></span><br><span class="line"><span class="comment"># next不会与next方法冲突，因为这个next只在这个作用域中生效，global中的next已经被这个next覆盖掉了。函数</span></span><br><span class="line"><span class="comment"># 加载时在栈上，用完就会消失。下面的self.next更不会冲突，因为有self作为限定。链表是有序的，不能乱。但在内</span></span><br><span class="line"><span class="comment"># 存上不一定是连续的，所以不能像列表一样移位。</span></span><br><span class="line">        self.val = val</span><br><span class="line">        self.next =  next   </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.val)</span><br><span class="line"></span><br><span class="line">    __repr__ = __str__</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    容器类，按某种方式存储一个个节点</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.nodes = []   <span class="comment"># 创建一个容器，放上面的元素。不能用set，有可能去重。另外set是无序的</span></span><br><span class="line">        self.head = <span class="keyword">None</span></span><br><span class="line">        self.tail = <span class="keyword">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, val)</span>:</span></span><br><span class="line"><span class="comment"># 这个方法的逻辑是，有一个节点，它是SingleNode的实例。之后看一下自己有多少个元素，这里有一个head和tail，</span></span><br><span class="line"><span class="comment"># 这两个属性中保存的应该是SingleNode的实例，如果当前的尾部是None，说明也没有头部，如果有一个元素，尾部一定</span></span><br><span class="line"><span class="comment"># 会指向这个元素而不是None。如果是None，就给头部加一个元素node，第一个元素即是头也是尾。之后再把这个node</span></span><br><span class="line"><span class="comment"># 加到容器中，同时把尾部修正为当前node。这是第一种情况，容器中还没有元素。第二次进来，就知道当前的尾部是谁</span></span><br><span class="line"><span class="comment"># 了，这时就不执行if语句了，这时头部就定死了不会动了。直接将node追加到容器中，因为是第二个元素了，所以尾部</span></span><br><span class="line"><span class="comment"># 还要修正为当前的node。这时元素间还没有关系，所以要用prev.next修正一下</span></span><br><span class="line">        node = SingleNode(val)</span><br><span class="line"><span class="comment"># SingleNode(val)是将SingleNode实例化的过程，将val放进去，就会返回self.val和self.next，这时的</span></span><br><span class="line"><span class="comment"># self.next就指向None，也就是向链表尾部追加一个数字，这个数字就是self.val，下一个也就是self.next指向的是None。</span></span><br><span class="line">		prev = self.tail</span><br><span class="line"><span class="comment"># 这是前一个node</span></span><br><span class="line">	<span class="comment">#	prev.next = node  # ?，如果tail就是None，那么一进来就是None了，所在要做判断。</span></span><br><span class="line">    	<span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:  </span><br><span class="line"><span class="comment"># 如果前一个是None，一定是在尾部，并且是空的。如果尾部是空的，头也会是空的。如果有一个元素，尾部也不应该是空</span></span><br><span class="line"><span class="comment"># 的，所以这种情况就给self.head赋值node，也就是把头的数据改成node。如果prev不是None时，下面会先把</span></span><br><span class="line"><span class="comment"># prev.next赋值为node，也就是把前一个的下一个赋值为当前节点，下面还会把self.tail也赋值为node，也就是把</span></span><br><span class="line"><span class="comment"># 尾部也改成node。</span></span><br><span class="line">            self.head = node</span><br><span class="line"><span class="comment"># 这表示上一个节点的下一个就是我们现在要插入的。这也是当前节点</span></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 这段代码中，else这个判断可以没有，prev.next也没有用到</span></span><br><span class="line">        	prev.next = node</span><br><span class="line"><span class="comment"># 只有一个节点时是没有next的，只有prev不是None时才要将元素间建立关联。所以这句不能放在if语句外面</span></span><br><span class="line">        self.nodes.append(node)</span><br><span class="line"><span class="comment"># 把节点追加到列表中，但前面和后面的节点还没有关联，所以要在初始化时加self.head和self.tail。因为有追加，</span></span><br><span class="line"><span class="comment"># 所以要加self.tail，不然每次追加都要从头开始算</span></span><br><span class="line">        self.tail = node</span><br><span class="line"><span class="comment"># tail无论什么情况都应该是node，也就是无论是否为空，tail也应该是最新的node，这是将尾部设置为当前节点。</span></span><br><span class="line"></span><br><span class="line">a = LinkedList()</span><br><span class="line">a.append(<span class="number">3</span>)</span><br><span class="line">print(a)</span><br><span class="line">print(a.nodes)</span><br><span class="line">输出：</span><br><span class="line">&lt;__main__.LinkedList object at <span class="number">0x7ff960e6be50</span>&gt;</span><br><span class="line"><span class="comment"># 这里打印的是a实例的内存地址，注意观察打印内容，是LinkedList类的地址，下面中括号中的SingleNode类的地址。</span></span><br><span class="line">[&lt;__main__.SingleNode object at <span class="number">0x7f57cad638b0</span>&gt;]</span><br><span class="line"><span class="comment"># 使用a.nodes打印成这样就是因为在SingleNode类中没有实现打印功能，定义了__repr__方法后就可以打印为[3]了。</span></span><br><span class="line"><span class="comment"># 这里实例化的a就是链表这个容器，我们要打印容器中的内容，还要在定义内容的地方实现打印。所以用</span></span><br><span class="line"><span class="comment"># print(a.nodes)只会打印内存地址，要打印出内容，需要在SingleNode中定义__repr__方法</span></span><br><span class="line">====================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleNode</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    代表一个节点，存储节点Node</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, val, next=None, prev=None)</span>:</span>   </span><br><span class="line"><span class="comment"># 这是向类中放数据的过程，value是一个值，就代表上图中的一个个数字。如5、7。next只作为形参，想给值也可以。</span></span><br><span class="line"><span class="comment"># next不会与next方法冲突，因为这个next只在这个作用域中生效，global中的next已经被这个next覆盖掉了。函数</span></span><br><span class="line"><span class="comment"># 加载时在栈上，用完就会消失。下面的self.next更不会冲突，因为有self作为限定。链表是有序的，不能乱。但在内</span></span><br><span class="line"><span class="comment"># 存上不一定是连续的，所以不能像列表一样做位运算。</span></span><br><span class="line">        self.val = val</span><br><span class="line">        self.next = next   </span><br><span class="line">        self.prev = prev  <span class="comment"># 定义next和prev实际在这段代码中并没有起到什么作用</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.val)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.val)  <span class="comment"># __repr__和__str__都是为了打印使用</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    容器类，按某种方式存储一个个节点</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.nodes = []   <span class="comment"># 创建一个容器，放上面的元素。不能用set，有可能去重。另外set是无序的</span></span><br><span class="line"><span class="comment"># 对不需要插入的列表来说，检索方便，所以使用了列表。但是插入、remove不合适</span></span><br><span class="line">        self.head = <span class="keyword">None</span></span><br><span class="line">        self.tail = <span class="keyword">None</span></span><br><span class="line"><span class="comment"># 这里没有设计self.size是因为这个数据在多线程的情况下不会太准确  </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.nodes)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, val)</span>:</span></span><br><span class="line"><span class="comment"># 这个方法的逻辑是，有一个节点，它是SingleNode的实例。之后看一下自己有多少个元素，这里有一个head和tail，</span></span><br><span class="line"><span class="comment"># 这两个属性中保存的应该是SingleNode的实例，如果当前的尾部是None，说明也没有头部，如果有一个元素，尾部一定</span></span><br><span class="line"><span class="comment"># 会指向这个元素而不是None。如果是None，就给头部加一个元素node，第一个元素即是头也是尾。之后再把这个node</span></span><br><span class="line"><span class="comment"># 加到容器中，同时把尾部修正为当前node。这是第一种情况，容器中还没有元素。第二次进来，就知道当前的尾部是谁</span></span><br><span class="line"><span class="comment"># 了，这时就不执行if语句了，这时头部就定死了不会动了。直接将node追加到容器中，因为是第二个元素了，所以尾部</span></span><br><span class="line"><span class="comment"># 还要修正为当前的node。这时元素间还没有关系，所以要用prev.next修正一下</span></span><br><span class="line">        node = SingleNode(val)</span><br><span class="line"><span class="comment"># SingleNode(val)是将SingleNode实例化的过程，将val放进去，就会返回self.val和self.next，这时的</span></span><br><span class="line"><span class="comment"># self.next就指向None，也就是向链表尾部追加一个数字，这个数字就是self.val，下一个也就是self.next指向的是None。</span></span><br><span class="line">		prev = self.tail</span><br><span class="line"><span class="comment"># 这是前一个node。prev来自于self.tail，而self.tail和self.head都来自于SingleNode类，所以prev也就有了</span></span><br><span class="line"><span class="comment"># SingleNode类的初始化方法</span></span><br><span class="line">	<span class="comment">#	prev.next = node  # ?，如果tail就是None，那么一进来就是None了，所在要做判断。</span></span><br><span class="line">    	<span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:  </span><br><span class="line"><span class="comment"># 如果前一个是None，一定是在尾部，并且是空的。如果尾部是空的，头也会是空的。如果有一个元素，尾部也不应该是空的</span></span><br><span class="line">            self.head = node</span><br><span class="line"><span class="comment"># 这表示上一个节点的下一个就是我们现在要插入的。这也是当前节点</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prev.next = node</span><br><span class="line"><span class="comment"># 只有一个节点时是没有next的，只有prev不是None时才要将元素间建立关联。所以这句不能放在if语句外面</span></span><br><span class="line">        self.nodes.append(node)   </span><br><span class="line"><span class="comment"># 把节点追加到列表中，但前面和后面的节点还没有关联，所以要在初始化时加self.head和self.tail。因为有追加，</span></span><br><span class="line"><span class="comment"># 所以要加self.tail，不然会次追加都要从头开始算</span></span><br><span class="line">        self.tail = node</span><br><span class="line"><span class="comment"># tail无论什么情况都应该是node，也就是无论是否为空，tail也应该是最新的node，这是将尾部设置为当前节点。</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">iternodes</span><span class="params">(self, reverse=False)</span>:</span>  <span class="comment"># 暂时只能实现单向。iter表示生成器</span></span><br><span class="line">        current = self.head   <span class="comment"># 这是头部的元素</span></span><br><span class="line">        <span class="keyword">while</span> current:        <span class="comment"># 空元素是进不来的</span></span><br><span class="line">            <span class="keyword">yield</span> current</span><br><span class="line">            current = current.next</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.nodes[item]</span><br><span class="line">    </span><br><span class="line">ll = LinkedList()</span><br><span class="line">node = SingleNode(<span class="number">5</span>)</span><br><span class="line"><span class="comment"># ll.append(5) 这里用ll.append(node)还是ll.append(5)追加数据是一样的，因为SingleNode里返回的就是self.val？</span></span><br><span class="line">ll.append(node)</span><br><span class="line">node = SingleNode(<span class="number">7</span>)</span><br><span class="line">ll.append(node)</span><br><span class="line">print(<span class="string">'ll:&#123;&#125;'</span>.format(ll.__dict__))</span><br><span class="line">print(<span class="string">'node:&#123;&#125;'</span>.format(node.__dict__))</span><br><span class="line">输出：</span><br><span class="line">ll:&#123;<span class="string">'nodes'</span>: [<span class="number">5</span>, <span class="number">7</span>], <span class="string">'head'</span>: <span class="number">5</span>, <span class="string">'tail'</span>: <span class="number">7</span>&#125;</span><br><span class="line">node:&#123;<span class="string">'val'</span>: <span class="number">7</span>, <span class="string">'next'</span>: <span class="keyword">None</span>, <span class="string">'prev'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> ll.iternodes():</span><br><span class="line">    print(node)</span><br><span class="line"><span class="comment"># 测试发现iternodes里实际只有两个值，一个最大值一个最小值，有问题    </span></span><br><span class="line">print(ll[<span class="number">1</span>])  <span class="comment"># 使用两种方法取数据</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line">====================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleNode</span>:</span>   <span class="comment"># 节点保存内容和下一跳</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, item, next=None)</span>:</span></span><br><span class="line">        self.item = item</span><br><span class="line">        self.next = next</span><br><span class="line"><span class="comment"># 这里并不在乎前一个是什么，只关注下一个是什么，到iternodes方法中直接将current定位在头部，之后找下一个就可以了</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> repr(self.item)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.head = <span class="keyword">None</span></span><br><span class="line">        self.tail = <span class="keyword">None</span>    <span class="comment"># 思考tail属性的作用</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        node = SingleNode(item)</span><br><span class="line">        <span class="keyword">if</span> self.head <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.head = node   <span class="comment"># 设置开头结点，以后不变</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.tail.next = node   <span class="comment"># 当前最后一个结点关联下一跳</span></span><br><span class="line"><span class="comment"># 看下面单向链表2中的解释</span></span><br><span class="line">        self.tail = node   <span class="comment"># 更新结尾结点</span></span><br><span class="line">        <span class="keyword">return</span> self </span><br><span class="line"><span class="comment"># 这里返回self，下面就可以使用ll.append(1).append(2)的方式追加了，不然只能使用ll.append(1)这种方式</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">iternodes</span><span class="params">(self)</span>:</span></span><br><span class="line">        current = self.head  <span class="comment"># 只有self.head才能看到其下一个是谁，也就是self.head.next是谁</span></span><br><span class="line">        <span class="keyword">while</span> current:</span><br><span class="line">            <span class="keyword">yield</span> current</span><br><span class="line">            current = current.next  </span><br><span class="line"><span class="comment"># 这里current.next又是另一个实例了，实例中记录着当前的值与下一个值</span></span><br><span class="line">            </span><br><span class="line">ll = LinkedList()</span><br><span class="line">ll.append(<span class="string">'abc'</span>)</span><br><span class="line">ll.append(<span class="number">1</span>).append(<span class="number">2</span>)</span><br><span class="line">ll.append(<span class="string">'def'</span>)</span><br><span class="line"></span><br><span class="line">print(ll.head, ll.tail)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> ll.iternodes():</span><br><span class="line">    print(item)</span><br><span class="line">输出：</span><br><span class="line"><span class="string">'abc'</span> <span class="string">'def'</span></span><br><span class="line"><span class="string">'abc'</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="string">'def'</span></span><br></pre></td></tr></table></figure>
<h4 id="单向链表2"><a href="#单向链表2" class="headerlink" title="单向链表2"></a>单向链表2</h4><p>借助列表实现，列表实现只是比上面的代码在LinkedList初始化方法中多了一个列表，另外多加了一个getitem方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleNode</span>:</span>   <span class="comment"># 节点保存内容和下一跳</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, item, next=None)</span>:</span></span><br><span class="line">        self.item = item</span><br><span class="line">        self.next = next</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> repr(self.item)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.head = <span class="keyword">None</span></span><br><span class="line">        self.tail = <span class="keyword">None</span></span><br><span class="line">        self.items = []   <span class="comment"># 为什么在单向链表中使用list？</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        node = SingleNode(item)</span><br><span class="line">        <span class="keyword">if</span> self.head <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.head = node   <span class="comment"># 设置开头结点，以后不变</span></span><br><span class="line">            <span class="comment"># print(self.head.__dict__, a)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.tail.next = node   <span class="comment"># 当前最后一个结点关联下一跳</span></span><br><span class="line"><span class="comment"># 这里的self.tail和self.head实际就是SingleNode类的实例，因为使用下面三种方法可以看出，self.tail和</span></span><br><span class="line"><span class="comment"># self.head的字典中都有item和next属性，而self的字典中有head, tail, items三个属性，而没有item和next属</span></span><br><span class="line"><span class="comment"># 性。证明self是LinkedList类的实例。在没有给self.head和self.tail赋值node前，这两个元素是没有item和next属性的。</span></span><br><span class="line">			<span class="comment"># print(self.tail.__dict__, 1)</span></span><br><span class="line">            <span class="comment"># print(self.head.__dict__, 2)</span></span><br><span class="line">            <span class="comment"># print(self.__dict__, 3)</span></span><br><span class="line">            <span class="comment"># print(self.tail.__dict__, id(self.tail.__dict__), 'b')  </span></span><br><span class="line"><span class="comment"># 加入这一行可以看的更清楚，每次不同实例的字典中都记录着当前值与下一个关联的值</span></span><br><span class="line">            <span class="comment"># 输出：</span></span><br><span class="line">            <span class="comment"># &#123;'item': 'abc', 'next': 1&#125; b</span></span><br><span class="line">			<span class="comment"># &#123;'item': 1, 'next': 2&#125; b</span></span><br><span class="line">			<span class="comment"># &#123;'item': 2, 'next': 'def'&#125; b</span></span><br><span class="line">        self.tail = node   </span><br><span class="line"><span class="comment"># 更新结尾结点。实际是否是从这里进行一个新的赋值的？上面的self.tail.next是追加的值。所以这里看到的next的值</span></span><br><span class="line"><span class="comment"># 都是None。看print打印出来的结果应该是这样的。每一次进来时都会给self.tail.next赋一个值，之后就会给</span></span><br><span class="line"><span class="comment"># self.tail赋一个新值了，这会覆盖之前item的值。在print中加入id(self.tail.__dict__)后，可以看出确实如此</span></span><br><span class="line"><span class="comment"># 这样，下面的current.next也就知道下一个关联的值是谁了</span></span><br><span class="line">        <span class="comment"># print(self.tail.__dict__, id(self.tail.__dict__), c)</span></span><br><span class="line">    	<span class="comment"># 输出：</span></span><br><span class="line">        <span class="comment"># &#123;'item': 'abc', 'next': None&#125; 140026473788328 c</span></span><br><span class="line">        <span class="comment"># &#123;'item': 'abc', 'next': 1&#125; 140026473788328 b</span></span><br><span class="line">        <span class="comment"># &#123;'item': 1, 'next': None&#125; 140026473787608 c</span></span><br><span class="line">        <span class="comment"># &#123;'item': 1, 'next': 2&#125; 140026473787608 b</span></span><br><span class="line">        <span class="comment"># &#123;'item': 2, 'next': None&#125; 140026473700088 c</span></span><br><span class="line">        <span class="comment"># &#123;'item': 2, 'next': 'def'&#125; 140026473700088 b</span></span><br><span class="line">        <span class="comment"># &#123;'item': 'def', 'next': None&#125; 140026475075120 c</span></span><br><span class="line">        self.items.append(node)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">iternodes</span><span class="params">(self)</span>:</span></span><br><span class="line">        current = self.head</span><br><span class="line"><span class="comment"># 如果不使用append方法，self.head就不会有值，所以这里一定是使用过append方法后，才能正常输出，否则current</span></span><br><span class="line"><span class="comment"># 只会等于None。赋值以后，current也就拥有了item和next属性。先是用SingleNode(item)赋值给node，再把node</span></span><br><span class="line"><span class="comment"># 赋值给self.head，现在又把self.head赋值给current。但current的值是一个个得到的，先得到abc，并输出</span></span><br><span class="line">        <span class="keyword">while</span> current:</span><br><span class="line">            <span class="keyword">yield</span> current</span><br><span class="line">            current = current.next</span><br><span class="line"><span class="comment"># current中只有一个值，要用next方法指向下一个来修正current到下一个值</span></span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getitem</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.items[index]</span><br><span class="line">    </span><br><span class="line">ll = LinkedList()</span><br><span class="line">ll.append(<span class="string">'abc'</span>)</span><br><span class="line">ll.append(<span class="number">1</span>).append(<span class="number">2</span>)</span><br><span class="line">ll.append(<span class="string">'def'</span>)</span><br><span class="line"></span><br><span class="line">print(ll.head, ll.tail)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> ll.iternodes():</span><br><span class="line">    print(item)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(ll.items)):</span><br><span class="line">    print(ll.getitem(i))</span><br><span class="line">输出：</span><br><span class="line"><span class="string">'abc'</span> <span class="string">'def'</span></span><br><span class="line"><span class="string">'abc'</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="string">'def'</span></span><br><span class="line"><span class="string">'abc'</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="string">'def'</span></span><br></pre></td></tr></table></figure>
<p>为什么在单向链表中使用list？</p>
<p>因为只有结点自己知道下一跳是谁，想直接访问某一个结点只能遍历。</p>
<p>借助列表就可以方便的随机访问某一个结点了</p>
<h4 id="双向链表"><a href="#双向链表" class="headerlink" title="双向链表"></a>双向链表</h4><p>实现单向链表没有实现的<code>pop</code>、<code>remove</code>、<code>insert</code>方法</p>
<p>个人感觉，链表需要注意的有几点：</p>
<ol>
<li>定义两个类，一个是链表类，一个是节点类。节点类主要是为了记录每一个节点当前值及当前值前一个和后一个值，有了这三个值，就知道当前节点与节点两边的值的关系了。链表类主要记录链表的头和尾的值</li>
<li>如果添加的是添加或插入的功能，就要注意先把要加入的值变成节点类的实例，之后就可以确定这个节点及与节点相关的前后两个值了，之后还要考虑将节点加入链表后，是在头部、尾部还是中间部分，这需要调整链表头或尾部的值</li>
<li>如果添加的是删除方法，就要注意传入的索引值对应的数据，如果是pop方法，直接从尾部删除就可以了，之后调整相关节点的关闭值，还需要调整链表的尾部的值。如果是remove方法，就需要考虑删除的索引对应的数据，之后如何调整节点相关联的值，链表的头或尾部的值。</li>
<li>所谓把链表容器化，就是需要加入<code>__len__</code>、<code>__setitem__</code>、<code>__getitem__</code>、<code>__iter__</code>这些方法</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 笔记</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleNode</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    代表一个节点，存储节点Node</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, val, next=None, prev=None)</span>:</span>  </span><br><span class="line">        self.val = val</span><br><span class="line">        self.next = next   </span><br><span class="line">        self.prev = prev</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.val)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.val)  <span class="comment"># __repr__和__str__都是为了打印使用</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    容器类，按某种方式存储一个个节点</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="comment"># self.nodes = []   # 创建一个容器，放上面的元素。不能用set，有可能去重，另外set是无序的。对不需要插入的列表来说，</span></span><br><span class="line">    <span class="comment"># 检索方便，所以使用了列表。但是插入、remove不合适</span></span><br><span class="line">        self.head = <span class="keyword">None</span></span><br><span class="line">        self.tail = <span class="keyword">None</span></span><br><span class="line"><span class="comment"># 这里没有设计self.size是因为这个数据在多线程的情况下不会太准确  </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, val)</span>:</span></span><br><span class="line">        node = SingleNode(val)  <span class="comment"># 当前新增的数字</span></span><br><span class="line">        <span class="keyword">if</span> self.head <span class="keyword">is</span> <span class="keyword">None</span>:  </span><br><span class="line"><span class="comment"># 加第一个元素时才会到这里</span></span><br><span class="line">            self.head = node  <span class="comment"># 如果第一个元素是None，那么就把头设置为node</span></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 大于1个元素时进入这里</span></span><br><span class="line">            self.tail.next = node   <span class="comment"># 原来的尾部指向自己</span></span><br><span class="line">            node.prev = self.tail  <span class="comment"># 前一个指向尾部</span></span><br><span class="line"><span class="comment"># prev属性实际在node实例上，所以要改node实例，而不是self.prev。每次调用append方法时都要用到node实例，所以从第二次进来就要让</span></span><br><span class="line"><span class="comment"># 实例知道node的前一个数字是谁。</span></span><br><span class="line">        self.tail = node  <span class="comment"># 最后把自己修正成尾部</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">iternodes</span><span class="params">(self, reverse=False)</span>:</span>  <span class="comment"># 暂时只能实现单向。iter表示生成器</span></span><br><span class="line">        current = self.tail <span class="keyword">if</span> reverse <span class="keyword">else</span> self.head</span><br><span class="line">        <span class="keyword">while</span> current:      </span><br><span class="line">            <span class="keyword">yield</span> current</span><br><span class="line">            current = current.prev <span class="keyword">if</span> reverse <span class="keyword">else</span> current.next</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span>  <span class="comment"># 从尾部弹出一个</span></span><br><span class="line">        <span class="keyword">if</span> self.tail <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># 如果尾部是None，就抛异常。 == 0 一个数据也没有</span></span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Empty'</span>)</span><br><span class="line">        tail = self.tail  <span class="comment"># 如果self.tail有值，在这里进行处理，首先重新赋值</span></span><br><span class="line">        prev = tail.prev</span><br><span class="line">       <span class="comment">#  next = tail.next # None， 尾部的下一个一定是None</span></span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># ==1，有一个数据。判断上面定义的tail和prev是否符合条件</span></span><br><span class="line">            self.head = <span class="keyword">None</span>   <span class="comment"># 如果前一个是None，就表示头是None，否则前一个应该有值</span></span><br><span class="line">            self.tail = <span class="keyword">None</span>   <span class="comment">#  头是None，就表示尾也是None。</span></span><br><span class="line"><span class="comment"># 当符合这个条件时就证明只有最后一个值了。再调用pop方法后头和尾就应该是None了。最后返回tail.val</span></span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># &gt; 1，大于一个数据</span></span><br><span class="line">            self.tail = prev</span><br><span class="line">            prev.next = <span class="keyword">None</span></span><br><span class="line"><span class="comment"># 符合这个条件时，就是大于1个元素的时候，弹出一个元素后，尾部就应该变成之前尾部的前一个元素，前一个元素的下</span></span><br><span class="line"><span class="comment"># 一个元素（也就是之前的尾部）就应该变成None了，因为被弹出了。</span></span><br><span class="line">        <span class="keyword">return</span> tail.val</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getitem</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span>   <span class="comment"># 不支持负索引</span></span><br><span class="line">        current = <span class="keyword">None</span>   <span class="comment"># 初始化一个current。</span></span><br><span class="line">        <span class="keyword">for</span> i,node <span class="keyword">in</span> enumerate(self.iternodes()):</span><br><span class="line">            <span class="keyword">if</span> i == index:  </span><br><span class="line">                current = node   <span class="comment"># 如果i等于index时，将i对应的node赋值给current，之后跳出整个循环</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 因为没有使用列表，所以要用这样的循环处理，先创建一个current变量，再使用循环找到用户要找的值并赋值给</span></span><br><span class="line"><span class="comment"># current变量，最后返回这个current</span></span><br><span class="line">        <span class="keyword">if</span> current <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:   </span><br><span class="line"><span class="comment"># 判断上面的循环结果，看current是否为None，如果不为None就返回current本身。这是上面已经给current赋值后要做的判断</span></span><br><span class="line">            <span class="keyword">return</span> current</span><br><span class="line"><span class="comment"># 这里似乎不应该会出现current等于None的情况，如果index小于0,会在第一个if条件判断处拦截，index大于等于0</span></span><br><span class="line"><span class="comment"># 时会在下面的for循环拦截并重新给current赋值，所以不应该会有current等于None的情况？</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, index, val)</span>:</span>  <span class="comment"># 这只能实现从头或尾追加</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Error'</span>)</span><br><span class="line">        </span><br><span class="line">        current = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">for</span> i,node <span class="keyword">in</span> enumerate(self.iternodes()):</span><br><span class="line">            <span class="keyword">if</span> i == index:</span><br><span class="line">                current = node</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 这里就是要用enumerate函数来确定index及其对应的值，最后赋值给current</span></span><br><span class="line">        <span class="keyword">if</span> current <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.append(val)</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line"><span class="comment"># 这里返回的是None，真正返回的内容已经在append方法中返回了。</span></span><br><span class="line"><span class="comment"># 什么情况下current会等于None？如果用户输入的索引值不存在，current会不会是None？</span></span><br><span class="line">        prev = current.prev</span><br><span class="line">        next = current.next</span><br><span class="line">        node = SingleNode(val)</span><br><span class="line"><span class="comment"># 上面的所有代码处理指定位置插入，如果找不到索引就会在尾部追加。如果直接使用这个方法就会进行尾部追加，这样就</span></span><br><span class="line"><span class="comment"># 会调用到append方法，并使用实例具有SingleNode类中的初始化属性prev, next, val，也就是这里的</span></span><br><span class="line"><span class="comment"># current.prev，current.next。如果之前已经使用过append这样的方法加入数据，那么调用insert方法时实例就</span></span><br><span class="line"><span class="comment"># 已经有这样的属性了。</span></span><br><span class="line"><span class="comment"># 这里把前一个，后一个，和当前的值都重新赋值保存下来，到目前为止，这里确定了4个值，current是用户要插入的位置上现在的值，prev是要插入的位置上的前一个值。下面再进行判断从哪插入。如果头部是None，就插入到头部</span></span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># 头部插入</span></span><br><span class="line">            self.head = node   <span class="comment"># 这就是在设置插入到头部了</span></span><br><span class="line">            node.next = current  <span class="comment"># 因为上面的node是从SingleNode(val)刚刚生成，所以next这个属性是None，所以这里不改self.head的next，而改node.next，下面再改current的prev，这样就将属性数据都回到了self.head上了，也就是self.head的next, prev都有数据了</span></span><br><span class="line">            current.prev = node  <span class="comment"># 插入到头部后，再整理一下关系。头部的下一个是current，current的前一个是node</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            node.prev = prev  <span class="comment"># 如果前一个不是None，那么前一个就是current.prev</span></span><br><span class="line">            node.next = current</span><br><span class="line">            current.prev = node </span><br><span class="line"></span><br><span class="line">ll = LinkedList()</span><br><span class="line">node = SingleNode(<span class="string">'abc'</span>)</span><br><span class="line">ll.append(node)</span><br><span class="line">node = SingleNode(<span class="number">1</span>)</span><br><span class="line">ll.append(node)</span><br><span class="line">node = SingleNode(<span class="number">2</span>)</span><br><span class="line">ll.append(node)</span><br><span class="line">node = SingleNode(<span class="number">3</span>)</span><br><span class="line">ll.append(node)</span><br><span class="line">node = SingleNode(<span class="number">4</span>)</span><br><span class="line">ll.append(node)</span><br><span class="line">node = SingleNode(<span class="number">5</span>)</span><br><span class="line">ll.append(node)</span><br><span class="line">node = SingleNode(<span class="number">6</span>)</span><br><span class="line">ll.append(node)</span><br><span class="line">node = SingleNode(<span class="string">'def'</span>)</span><br><span class="line">ll.append(node)</span><br><span class="line"></span><br><span class="line">ll.insert(<span class="number">6</span>, <span class="number">6</span>)</span><br><span class="line">ll.insert(<span class="number">7</span>, <span class="number">7</span>)</span><br><span class="line">ll.insert(<span class="number">0</span>, <span class="string">'123'</span>)</span><br><span class="line">ll.insert(<span class="number">1</span>, <span class="string">'456'</span>)  <span class="comment"># 在中间插入是无效的，但与pop方法结合时又是起作用的。</span></span><br><span class="line">ll.insert(<span class="number">30</span>, <span class="string">'abcdefg'</span>)</span><br><span class="line"></span><br><span class="line">ll.pop()</span><br><span class="line">ll.pop()</span><br><span class="line">ll.pop()</span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> ll.iternodes(<span class="keyword">True</span>):</span><br><span class="line">    print(node)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">abc</span><br><span class="line"><span class="number">456</span></span><br><span class="line"><span class="number">123</span></span><br><span class="line">====================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleNode</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, item, prev=None, next=None)</span>:</span></span><br><span class="line">        self.item = item</span><br><span class="line">        self.next = next</span><br><span class="line">        self.prev = prev   <span class="comment"># 增加上一跳</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># return repr(self.item)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"(&#123;&#125; &lt;== &#123;&#125; ==&gt; &#123;&#125;)"</span>.format(self.prev.item <span class="keyword">if</span> self.prev <span class="keyword">else</span> <span class="keyword">None</span>, self.item, self.next.item <span class="keyword">if</span> self.next <span class="keyword">else</span> <span class="keyword">None</span>)</span><br><span class="line"><span class="comment"># 打印时有三个值，第一个是前一个值，第二个是当前值，第三个是后一个值。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.head = <span class="keyword">None</span></span><br><span class="line">        self.tail = <span class="keyword">None</span></span><br><span class="line">        self.size = <span class="number">0</span>   <span class="comment"># 以后实现</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        node = SingleNode(item)</span><br><span class="line">        <span class="keyword">if</span> self.head <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.head = node</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.tail.next = node  <span class="comment"># 当前最后一个结点关联下一跳</span></span><br><span class="line">            node.prev = self.tail   <span class="comment"># 前后关联</span></span><br><span class="line">        self.tail = node   <span class="comment"># 更新结尾结点</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"><span class="comment"># 第一次调用append方法后，self.tail和self.head都被赋值为node。第二次进入时，就等于在给SingleNode</span></span><br><span class="line"><span class="comment"># 的实例属性next和prev赋值。当打印时，因为数据是SingleNode类的，所以要在SingleNode类中实现打印方</span></span><br><span class="line"><span class="comment"># 法，LinkedList类只是提供了不同的方法。</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, index, item)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:   <span class="comment"># 不接受负数</span></span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">'Not negative index &#123;&#125;'</span>.format(index))</span><br><span class="line">            </span><br><span class="line">        current = <span class="keyword">None</span>  <span class="comment"># current是当前的值</span></span><br><span class="line">        <span class="keyword">for</span> i, node <span class="keyword">in</span> enumerate(self.iternodes()):</span><br><span class="line">            <span class="keyword">if</span> i == index:   <span class="comment"># 找到了</span></span><br><span class="line">                current = node</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:   <span class="comment"># 没有break，尾部追加</span></span><br><span class="line">            self.append(item)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"><span class="comment"># for循环的意思是通过用i与用户提供的index比对，如果一样就说明这里用户要找的值，也就是current(当前值)的</span></span><br><span class="line"><span class="comment"># 值，之后就break跳出循环，不会再执行else语句，直接执行下面的语句。如果没有找到，这应该是第一次加入值或索引</span></span><br><span class="line"><span class="comment"># 超过了现有的范围（如下面的ll.insert(20, 'def'），这时就会执行到else语句，这会调用append方法追加数据，</span></span><br><span class="line"><span class="comment"># 之后就直播返回了，不会再执行下面的语句。 </span></span><br><span class="line">        <span class="comment"># break，找到了</span></span><br><span class="line">        node = SingleNode(item)</span><br><span class="line">        prev = current.prev</span><br><span class="line">        next = current</span><br><span class="line"><span class="comment"># 当找到以后，这里就会给node，prev，next重新赋值，这三个变量分别代表要插入的值，前一个和后一个值，上面</span></span><br><span class="line"><span class="comment"># 的current是用户指定的值，我们是要在这个值的前面插入值。下面进行判断，如果prev是空，说是current就是</span></span><br><span class="line"><span class="comment"># 头部了，这样就要在头部前面插入，所以将头部调整为node。否则，前一个的下一个就是当前插入的node，插入后</span></span><br><span class="line"><span class="comment"># 当前的node的前一个就是current.prev，current已经在上面的for循环中赋值成了node。最后，将新插入的值</span></span><br><span class="line"><span class="comment"># 的下一个调整为current，也就是next，再将next的前一个调整为新插入的node</span></span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># 首部</span></span><br><span class="line">            self.head = node</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prev.next = node  <span class="comment"># 这个prev是上面</span></span><br><span class="line">            node.prev = prev</span><br><span class="line">        node.next = next</span><br><span class="line">        next.prev = node</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">if</span> self.tail <span class="keyword">is</span> <span class="keyword">None</span>:   <span class="comment"># 空</span></span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Empty'</span>)</span><br><span class="line">            </span><br><span class="line">        node = self.tail</span><br><span class="line">        item = node.item</span><br><span class="line">        prev = node.prev</span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span>: <span class="comment"># only one node</span></span><br><span class="line">            self.head = <span class="keyword">None</span></span><br><span class="line">            self.tail = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prev.next = <span class="keyword">None</span></span><br><span class="line">            self.tail = prev</span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(self, index)</span>:</span></span><br><span class="line"><span class="comment"># remove方法的逻辑与insert方法的差不多，先判断容器是否为空或用户输入的索引值不符合要求。之后找到用户输</span></span><br><span class="line"><span class="comment"># 入的索引对应的值并赋值给current上，再设置current的前一个和后一个值。判断四种情况，如果前一个和后一个</span></span><br><span class="line"><span class="comment"># 都是None，那么删除后，将头和尾都设置成None，说明删除的已经是最后一个值了。如果前一个是None，说明删除</span></span><br><span class="line"><span class="comment"># 的就是头，删除后将头调整为下一个next，就是头变成了next，下一个的前一个就成了None。如果下一个next是</span></span><br><span class="line"><span class="comment"># None，说明已经在尾部了，删除后将尾部调整为前一个prev，前一个的下一个调整为None。最后如果不符合前面说</span></span><br><span class="line"><span class="comment"># 的三种情况，说明在中间，删除后将前一个的下一个调整为下一个next，下一个的前一个调整为前一个。最后删除用</span></span><br><span class="line"><span class="comment"># 户指定的current的值。</span></span><br><span class="line">        <span class="keyword">if</span> self.tail <span class="keyword">is</span> <span class="keyword">None</span>: <span class="comment"># 空</span></span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Empty'</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:  <span class="comment"># 不接受负数</span></span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">'Not negative index &#123;&#125;'</span>.format(index))</span><br><span class="line">            </span><br><span class="line">        current = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">for</span> i, node <span class="keyword">in</span> enumerate(self.iternodes()):</span><br><span class="line">            <span class="keyword">if</span> i == index:</span><br><span class="line">                current = node</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:   <span class="comment"># Not Found</span></span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">'Wrong index &#123;&#125;'</span>.format(index))</span><br><span class="line">            </span><br><span class="line">        prev = current.prev</span><br><span class="line">        next = current.next</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4种情况</span></span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">and</span> next <span class="keyword">is</span> <span class="keyword">None</span>: <span class="comment"># only one node</span></span><br><span class="line">            self.head = <span class="keyword">None</span></span><br><span class="line">            self.tail = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">elif</span> prev <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># 头部</span></span><br><span class="line">            self.head = next</span><br><span class="line">            next.prev = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">elif</span> next <span class="keyword">is</span> <span class="keyword">None</span>: <span class="comment"># 尾部</span></span><br><span class="line">            self.tail = prev</span><br><span class="line">            prev.next = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># 在中间</span></span><br><span class="line">            prev.next = next</span><br><span class="line">            next.prev = prev</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">del</span> current</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">iternodes</span><span class="params">(self, reverse=False)</span>:</span></span><br><span class="line">        current = self.tail <span class="keyword">if</span> reverse <span class="keyword">else</span> self.head</span><br><span class="line">        <span class="keyword">while</span> current:</span><br><span class="line">            <span class="keyword">yield</span> current</span><br><span class="line">            current = current.prev <span class="keyword">if</span> reverse <span class="keyword">else</span> current.next</span><br><span class="line">            </span><br><span class="line">ll = LinkedList()</span><br><span class="line">ll.append(<span class="string">'abc'</span>)</span><br><span class="line">ll.append(<span class="number">1</span>)</span><br><span class="line">ll.append(<span class="number">2</span>)</span><br><span class="line">ll.append(<span class="number">3</span>)</span><br><span class="line">ll.append(<span class="number">4</span>)</span><br><span class="line">ll.append(<span class="number">5</span>)</span><br><span class="line">ll.append(<span class="string">'def'</span>)</span><br><span class="line">print(ll.head, ll.tail)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> ll.iternodes(<span class="keyword">True</span>):</span><br><span class="line">    print(x)</span><br><span class="line">    </span><br><span class="line">print(<span class="string">'============'</span>)</span><br><span class="line"></span><br><span class="line">ll.remove(<span class="number">6</span>)</span><br><span class="line">ll.remove(<span class="number">5</span>)</span><br><span class="line">ll.remove(<span class="number">0</span>)  <span class="comment"># 从头部删除需要注意，原本索引为1的元素，在删除头部后就会变成索引为0。</span></span><br><span class="line">ll.remove(<span class="number">1</span>)  <span class="comment"># 在删除了索引为0的元素后，这里删除索引为1的元素的值实际是2而不是1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> ll.iternodes():</span><br><span class="line">    print(x)</span><br><span class="line">    </span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line"></span><br><span class="line">ll.insert(<span class="number">3</span>, <span class="number">5</span>)</span><br><span class="line">ll.insert(<span class="number">20</span>, <span class="string">'def'</span>)</span><br><span class="line">ll.insert(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">ll.insert(<span class="number">0</span>, <span class="string">'abc'</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> ll.iternodes():</span><br><span class="line">    print(x)</span><br><span class="line">输出：</span><br><span class="line">(None &lt;== abc ==&gt; 1) (5 &lt;== def ==&gt; None)</span><br><span class="line">(5 &lt;== def ==&gt; None)</span><br><span class="line">(4 &lt;== 5 ==&gt; def)</span><br><span class="line">(3 &lt;== 4 ==&gt; 5)</span><br><span class="line">(2 &lt;== 3 ==&gt; 4)</span><br><span class="line">(1 &lt;== 2 ==&gt; 3)</span><br><span class="line">(abc &lt;== 1 ==&gt; 2)</span><br><span class="line">(None &lt;== abc ==&gt; 1)</span><br><span class="line">=========================================</span><br><span class="line">(None &lt;== 1 ==&gt; 3)</span><br><span class="line">(1 &lt;== 3 ==&gt; 4)</span><br><span class="line">(3 &lt;== 4 ==&gt; None)</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">(None &lt;== abc ==&gt; 1)</span><br><span class="line">(abc &lt;== 1 ==&gt; 2)</span><br><span class="line">(1 &lt;== 2 ==&gt; 3)</span><br><span class="line">(2 &lt;== 3 ==&gt; 4)</span><br><span class="line">(3 &lt;== 4 ==&gt; 5)</span><br><span class="line">(4 &lt;== 5 ==&gt; def)</span><br><span class="line">(5 &lt;== def ==&gt; None)</span><br></pre></td></tr></table></figure>
<h3 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h3><p>Minxi</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.content)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableWord</span><span class="params">(Word)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Word print &#123;&#125;'</span>.format(self.content))</span><br><span class="line"><span class="comment"># 如果Word是第三方提供的或很庞大，只是觉得它的print方法打印的不好，这时可以将Word类继承下来，只写一</span></span><br><span class="line"><span class="comment"># 个print方法覆盖Word的同名方法，也就是临时增加一个打印功能。实例是实现这个功能的实例</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(Document)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(Word.mro())</span></span><br><span class="line"><span class="comment"># word = Word('test\nabc')</span></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># [&lt;class '__main__.Word'&gt;, &lt;class '__main__.Document'&gt;, &lt;class 'object'&gt;]</span></span><br><span class="line"><span class="comment"># 先找Word类，再找父类，最后找祖先类</span></span><br><span class="line">print(PrintableWord.mro())</span><br><span class="line">word = PrintableWord(<span class="string">'test\nabc'</span>)</span><br><span class="line">print(word.__dict)</span><br><span class="line">输出：</span><br><span class="line">[&lt;class '__main__.PrintableWord'&gt;, &lt;class '__main__.Word'&gt;, &lt;class '__main__.Document'&gt;, &lt;class 'object'&gt;]</span><br><span class="line">&#123;<span class="string">'content'</span>: <span class="string">'test\nabc'</span>&#125;</span><br><span class="line"></span><br><span class="line">==================================================================================</span><br><span class="line">装饰器</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.content)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 这样写表示第三方库，不动</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def print(self):</span></span><br><span class="line"><span class="comment">#     print('Word print &#123;&#125;'.format(self.content))	</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printable</span><span class="params">(cls)</span>:</span></span><br><span class="line">    cls.<span class="keyword">print</span> = <span class="keyword">lambda</span> self: print(self.content)</span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="comment"># PrintableWord是类对象作为参数传到printable函数中当作cls，这个cls是可以被动态地增加类属性的，</span></span><br><span class="line"><span class="comment"># 类属性是增加在这个类对象的dict上的，也就是类的dict上的。这个属性对应的是一个lambda函数。这个</span></span><br><span class="line"><span class="comment"># lambda函数就是上面的print方法的功能。当我们调用print的时候就应该是已经实例化后调用了，所以这时</span></span><br><span class="line"><span class="comment"># 调用类方法时就会动态增加一个类属性，这时实例也被当作self传入到lambda函数了。这种方法必须会</span></span><br><span class="line"><span class="meta">@printable   </span></span><br><span class="line"><span class="comment"># 要让哪个类打印，就给他一个打印的功能，这是一个函数。先写等价式：</span></span><br><span class="line"><span class="comment"># PrintableWord=printable(PrintableWord)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableWord</span><span class="params">(Word)</span>:</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(Document)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(PrintableWord.__dict__)  <span class="comment"># 查看是否有print方法</span></span><br><span class="line"><span class="comment"># a = PrintableWord('abc')  # 这时a有print和</span></span><br><span class="line"><span class="comment"># a.print()</span></span><br><span class="line">输出：</span><br><span class="line">=================================================================================</span><br><span class="line"><span class="comment"># Mixin</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableMixin</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'~~~~~~~~~~~'</span>)</span><br><span class="line">        print(<span class="string">'&#123;&#125;'</span>.format(self.content))</span><br><span class="line"><span class="comment"># Mixin与装饰器函数写的都差不多，但Mixin是类，有类的三种特征     </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.content)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printable</span><span class="params">(cls)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'~~~~~~~~~~~'</span>)</span><br><span class="line">        print(<span class="string">'&#123;&#125;'</span>.format(self.content))</span><br><span class="line">    cls.<span class="keyword">print</span> = _print</span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 这样写表示第三方库，不动</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@printable</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableWord</span><span class="params">(Word)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(Document)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintablePdf</span><span class="params">(PrintableMixin, Pdf)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 这个类继承自PrintableMixin和Pdf，PrintableMixin继承自object，Pdf继承自Document，</span></span><br><span class="line"><span class="comment"># Document继承自object。执行的查找使用c3算法，深度优先。Mixin一般都放在最前面，因为Mixin是我们</span></span><br><span class="line"><span class="comment"># 要混进来的方法，所以需要先执行。Mixin混进来是为了覆盖原有的方法</span></span><br><span class="line"></span><br><span class="line">print(PrintablePdf.mro())</span><br><span class="line">word = PrintablePdf(<span class="string">'test\nabc'</span>)</span><br><span class="line">print(word.__dict__)</span><br><span class="line"></span><br><span class="line">word.print()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/python基础学习-类的继承/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/python基础学习-类的继承/" itemprop="url">
                  python基础学习-类的继承
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-07 13:59:23" itemprop="dateCreated datePublished" datetime="2020-03-07T13:59:23+08:00">2020-03-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-07-15 15:05:37" itemprop="dateModified" datetime="2020-07-15T15:05:37+08:00">2020-07-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>面向对象三要素之一，继承inherritance</p>
<p>人类和猫类都继承自动物类。</p>
<p>个体继承自父母，继承了父母的一部分特征，但也可以有自己的个性。</p>
<p>在面向对象的世界中，从父类继承，就可以直接拥有父类的属性和方法，这样可以减少代码、多复用。子类可以定义自己的属性和方法。</p>
<p>看一个不用继承的例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shout</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Animal shouts'</span>)</span><br><span class="line">        </span><br><span class="line">a = Animal()</span><br><span class="line">a.shout()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shout</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Cat shouts'</span>)</span><br><span class="line"></span><br><span class="line">c = Cat()</span><br><span class="line">c.shout()</span><br></pre></td></tr></table></figure>
<p>上面的2个类虽然有关系，但是定义时并没有建立这种关系，而是各自完成定义。</p>
<p>动物类和猫类都有吃，但是它们的吃有区别，所以分别定义。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self._name = name</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shout</span><span class="params">(self)</span>:</span>   <span class="comment"># 一个通用的吃方法</span></span><br><span class="line">        print(<span class="string">'&#123;&#125; shouts'</span>.format(self.__class__.__name__))</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._name</span><br><span class="line">    </span><br><span class="line">a = Animal(<span class="string">'monster'</span>)</span><br><span class="line">a.shout()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">cat = Cat(<span class="string">'garfield'</span>)</span><br><span class="line">cat.shout()</span><br><span class="line">print(cat.name)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">dog = Dog(<span class="string">'ahuang'</span>)</span><br><span class="line">dog.shout()</span><br><span class="line">print(dog.name)</span><br><span class="line">输出：</span><br><span class="line">Animal shouts</span><br><span class="line">Cat shouts</span><br><span class="line">garfield</span><br><span class="line">Dog shouts</span><br><span class="line">ahuang</span><br></pre></td></tr></table></figure>
<p>上例可以看出，通过继承，猫类、狗类不用写代码，直接继承了父类的属性和方法。</p>
<p><strong>继承</strong></p>
<p><code>class Cat(Animal)</code>这种形式就是从父类继承，括号中写上继承的类的列表。</p>
<p>继承可以让子类从父类获取特征（属性和方法）</p>
<p><strong>父类</strong></p>
<p><code>Animal</code>就是<code>Cat</code>的父类，也称为基类、超类。</p>
<p><strong>子类</strong></p>
<p><code>Cat</code>就是<code>Animal</code>的子类，也称为派生类。</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>格式如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> 子类名<span class="params">(基类<span class="number">1</span>[,基类<span class="number">2</span>,...])</span>:</span></span><br><span class="line">    语句块</span><br></pre></td></tr></table></figure>
<p>如果类定义时，没有基类列表，等同于继承自<code>object</code>。在Python3中，<code>object</code>类是所有对象的根基类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>注意，上例在Python2中，两种写法是不同的。</p>
<p>Python支持多继承，继承也可以多级。</p>
<p>查看继承的特殊属性和方法有</p>
<table>
<thead>
<tr>
<th>特殊属性和方法</th>
<th>含义</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__base__</code></td>
<td>类的基类</td>
<td></td>
</tr>
<tr>
<td><code>__bases__</code></td>
<td>类的基类元组</td>
<td></td>
</tr>
<tr>
<td><code>__mro__</code></td>
<td>显示方法查找顺序，基类的元组</td>
<td></td>
</tr>
<tr>
<td><code>mro()</code>方法</td>
<td>同上</td>
<td><code>int.mro()</code></td>
</tr>
<tr>
<td><code>__subclasses__()</code></td>
<td>类的子类列表</td>
<td><code>int.__subclasses__()</code></td>
</tr>
</tbody>
</table>
<h3 id="继承中的访问控制"><a href="#继承中的访问控制" class="headerlink" title="继承中的访问控制"></a>继承中的访问控制</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    __COUNT = <span class="number">100</span></span><br><span class="line">    HEIGHT = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, age, weight, height)</span>:</span></span><br><span class="line">        self.__COUNT += <span class="number">1</span></span><br><span class="line">        self.age = age</span><br><span class="line">        self.__weight = weight</span><br><span class="line">        self.HEIGHT = height</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'&#123;&#125; eat'</span>.format(self.__class__.__name__))</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getweight</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.__weight)</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">showcount1</span><span class="params">(cls)</span>:</span></span><br><span class="line">        print(cls.__COUNT)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__showcount2</span><span class="params">(cls)</span>:</span></span><br><span class="line">        print(cls.__COUNT)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">showcount3</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.__COUNT)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    NAME = <span class="string">'CAT'</span></span><br><span class="line">    __COUNT = <span class="number">200</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># c = Cat()   # __init__函数参数错误，缺省参数</span></span><br><span class="line">c = Cat(<span class="number">3</span>, <span class="number">5</span>, <span class="number">15</span>)</span><br><span class="line">c.eat()</span><br><span class="line">输出：</span><br><span class="line">Cat eat</span><br><span class="line">print(c.HEIGHT)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">15</span>  <span class="comment"># c在实例化时传入了参数15，所以这里是15。HEIGHT是父类的初始化属性</span></span><br><span class="line"><span class="comment"># print(c.__COUNT)   # Cat类私有的不可访问</span></span><br><span class="line"><span class="comment"># c.__showweight()   # 父类私有的不可访问</span></span><br><span class="line">c.showcount1()</span><br><span class="line">输出：</span><br><span class="line"><span class="number">100</span>  <span class="comment"># 这是类属性__COUNT，和实例无关，所以是父类中定义的100</span></span><br><span class="line"><span class="comment"># c.__showcount2()   # 父类私有的不可访问</span></span><br><span class="line">c.showcount3()</span><br><span class="line">输出：</span><br><span class="line"><span class="number">101</span>  <span class="comment"># showcount3()是在父类中定义的，初始化也在父类中，所以要用父类的类变量__COUNT加1，就是实例的属性self.__COUNT，所以是101</span></span><br><span class="line">print(c.NAME)</span><br><span class="line">输出：</span><br><span class="line">CAT  <span class="comment"># 这是在Cat类中定义的，也就是打印c所属类的NAME变量的值，如果c所属类中没有NAME变量，就会找其父类中是否有这个变量，如果有，就返回这个变量的值</span></span><br><span class="line">print(<span class="string">"&#123;&#125;"</span>.format(Animal.__dict__))</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'_Animal__COUNT'</span>: <span class="number">100</span>, <span class="string">'HEIGHT'</span>: <span class="number">0</span>, <span class="string">'__init__'</span>: &lt;function Animal.__init__ at <span class="number">0x7fca758b75e0</span>&gt;, <span class="string">'eat'</span>: &lt;function Animal.eat at <span class="number">0x7fca758b7670</span>&gt;, <span class="string">'_Animal__getweight'</span>: &lt;function Animal.__getweight at <span class="number">0x7fca758b7700</span>&gt;, <span class="string">'showcount1'</span>: &lt;classmethod object at <span class="number">0x7fca7591aa90</span>&gt;, <span class="string">'_Animal__showcount2'</span>: &lt;classmethod object at <span class="number">0x7fca7593f5b0</span>&gt;, <span class="string">'showcount3'</span>: &lt;function Animal.showcount3 at <span class="number">0x7fca758b78b0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Animal'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Animal'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">print(<span class="string">"&#123;&#125;"</span>.format(Cat.__dict__))</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'NAME'</span>: <span class="string">'CAT'</span>, <span class="string">'_Cat__COUNT'</span>: <span class="number">200</span>, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"><span class="comment"># Cat类中只有NAME和_Cat__COUNT两个变量，因为__COUNT与父类中的变量同名，这又是私有变量，所以加上了_Cat，</span></span><br><span class="line"><span class="comment"># 以示区分。实际上无论是否重名，都会加上类的名字_Cat，因为是私有属性，所以才会加上类的名字。正常变量或保护变</span></span><br><span class="line"><span class="comment"># 量都不会在前面加类名。</span></span><br><span class="line">print(c.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'_Animal__COUNT'</span>: <span class="number">101</span>, <span class="string">'age'</span>: <span class="number">3</span>, <span class="string">'_Animal__weight'</span>: <span class="number">5</span>, <span class="string">'HEIGHT'</span>: <span class="number">15</span>&#125;</span><br><span class="line"><span class="comment"># c实例中有父类中定义的初始化时应有的属性</span></span><br><span class="line">print(c.__class__.mro())</span><br><span class="line">输出：</span><br><span class="line">[&lt;class '__main__.Cat'&gt;, &lt;class '__main__.Animal'&gt;, &lt;class 'object'&gt;]</span><br><span class="line"><span class="comment"># 查找顺序是Cat -&gt; Animal -&gt; object</span></span><br></pre></td></tr></table></figure>
<p>从父类继承，自己没有的，就可以到父类中找。</p>
<p>私有的都是不可以访问的，但是本质上依然是改了名称放在这个属性所在的类<code>__dict__</code>中了。知道这个新名称就可以直接找到这个隐藏的变量，这是个黑魔法技巧，慎用。</p>
<p>总结</p>
<p>继承时，公有的，子类和实例都可以随意访问；私有成员被隐藏，子类和实例不可直接访问，私有变量所在的类内的方法中可以访问这个私有变量。也就是只有类内的方法可以访问类内的私有变量，但类方法不可以调用实例的私有属性，因为实例可能不存在，或没有属性。私有变量或属性就是名称前面有两个下划线的，私有的实例属性就在实例中用，如果是私有的类属性，可以在类方法和实例方法中使用。公有的大家都可以用，私有的除了它自己谁都不能用。继承的，公开的，是祖先的、父类的就是我的，我实例化后是我自己，我在实例化后把这些实例属性都放到自己的字典中了，类的方法存一份就够了，所以不需要也拿过来，这些是放在类的字典中的</p>
<p>Python通过自己一套实现，实现和其它语言一样的面向对象的继承机制。</p>
<p>属性查找顺序</p>
<p>实例的<code>__dict__</code> -&gt; 类<code>__dict__</code>如果有继承 -&gt; 父类<code>__dict__</code></p>
<p>如果搜索这些地方后没有找到就会抛异常，先找到就立即返回了。</p>
<h3 id="方法的重写、覆盖override"><a href="#方法的重写、覆盖override" class="headerlink" title="方法的重写、覆盖override"></a>方法的重写、覆盖override</h3> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shout</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Animal shouts'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="comment"># 覆盖了父类方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shout</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'miao'</span>)</span><br><span class="line">        </span><br><span class="line">a = Animal()</span><br><span class="line">a.shout()</span><br><span class="line">输出：</span><br><span class="line">Animal shouts</span><br><span class="line">c = Cat()</span><br><span class="line">c.shout()</span><br><span class="line">输出：</span><br><span class="line">miao</span><br><span class="line">print(a.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;&#125;</span><br><span class="line">print(c.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;&#125;  <span class="comment"># a和c两个实例的dict中没有任何属性</span></span><br><span class="line">print(Animal.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'shout'</span>: &lt;function Animal.shout at <span class="number">0x7f2d8609f5e0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Animal'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Animal'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">print(Cat.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'shout'</span>: &lt;function Cat.shout at <span class="number">0x7f2d8609f670</span>&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;  <span class="comment"># Cat和Animal两个类的dict中都有shout方法，但各是各的，不冲突</span></span><br></pre></td></tr></table></figure>
<p>Cat中能否覆盖自己的方法吗？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shout</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Animal shout'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="comment"># 覆盖了父类方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shout</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'miao'</span>)</span><br><span class="line">    <span class="comment"># 覆盖了自身的方法，显式调用了父类的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shout</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(super())</span><br><span class="line">        print(super(Cat, self))</span><br><span class="line">        super().shout()</span><br><span class="line">        super(Cat, self).shout()   <span class="comment"># 等价于super()</span></span><br><span class="line">        self.__class__.__base__.shout(self)   <span class="comment"># 不推荐</span></span><br><span class="line">        </span><br><span class="line">a = Animal()</span><br><span class="line">a.shout()</span><br><span class="line">输出：</span><br><span class="line">Animal shout</span><br><span class="line">c = Cat()</span><br><span class="line">c.shout()</span><br><span class="line">输出：</span><br><span class="line">&lt;super: &lt;class 'Cat'&gt;, &lt;Cat object&gt;&gt;</span><br><span class="line">&lt;super: &lt;class 'Cat'&gt;, &lt;Cat object&gt;&gt;</span><br><span class="line">Animal shout</span><br><span class="line">Animal shout</span><br><span class="line">Animal shout</span><br><span class="line">print(a.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;&#125;</span><br><span class="line">print(c.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;&#125;</span><br><span class="line">print(Animal.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'shout'</span>: &lt;function Animal.shout at <span class="number">0x7f08af1425e0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Animal'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Animal'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">print(Cat.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'shout'</span>: &lt;function Cat.shout at <span class="number">0x7f08af142700</span>&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br></pre></td></tr></table></figure>
<p><code>super()</code>可以访问到父类的属性，其具体原理后面再说。</p>
<p>那对于类方法和静态方法呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">class_method</span><span class="params">(cls)</span>:</span></span><br><span class="line">        print(<span class="string">'class_method_animal'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">static_method</span><span class="params">()</span>:</span></span><br><span class="line">        print(<span class="string">'static_method_animal'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">class_method</span><span class="params">(cls)</span>:</span></span><br><span class="line">        print(<span class="string">'class_method_cat'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">static_method</span><span class="params">()</span>:</span></span><br><span class="line">        print(<span class="string">'static_method_cat'</span>)</span><br><span class="line">        </span><br><span class="line">c = Cat()</span><br><span class="line">c.class_method()</span><br><span class="line">输出：</span><br><span class="line">class_method_cat</span><br><span class="line"></span><br><span class="line">c.static_method()</span><br><span class="line">输出：</span><br><span class="line">static_method_cat</span><br></pre></td></tr></table></figure>
<p>这些方法都可以覆盖，原理都一样，属性字典的搜索顺序。</p>
<h3 id="继承中的初始化"><a href="#继承中的初始化" class="headerlink" title="继承中的初始化"></a>继承中的初始化</h3><p>先看下面一段代码，有没有问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, a)</span>:</span></span><br><span class="line">        self.a = a</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, b, c)</span>:</span></span><br><span class="line">        self.b = b</span><br><span class="line">        self.c = c</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">printv</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.b)</span><br><span class="line">        print(self.a)   <span class="comment"># 出错吗。实例在B类中初始化，与父类A没有关系，所以也没有a属性</span></span><br><span class="line">        </span><br><span class="line">f = B(<span class="number">200</span>, <span class="number">200</span>)</span><br><span class="line">print(f.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'b'</span>: <span class="number">200</span>, <span class="string">'c'</span>: <span class="number">200</span>&#125;</span><br><span class="line">print(f.__class__.__bases__)</span><br><span class="line">输出：</span><br><span class="line">(&lt;class '__main__.A'&gt;,)</span><br><span class="line">f.printv()</span><br><span class="line">输出：</span><br><span class="line"><span class="number">200</span></span><br></pre></td></tr></table></figure>
<p>上例代码可知：</p>
<p>如果类B定义时声明继承自类A，则在类B中<code>__bases__</code>中是可以看到类A。</p>
<p>但是这和是否调用类A的构造方法是两回事。</p>
<p>如果B中调用了A的构造方法，就可以拥有父类的属性了。如何理解这一句话呢？</p>
<p>观察B的实例f的<code>__dict__</code>中的属性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, a, d=<span class="number">10</span>)</span>:</span></span><br><span class="line">        self.a = a</span><br><span class="line">        self.__d = d</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, b, c)</span>:</span></span><br><span class="line">        A.__init__(self, b + c, b - c)  <span class="comment"># 调用A类的__init__属性，并传入参数</span></span><br><span class="line">        self.b = b</span><br><span class="line">        self.c = c</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">printv</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.b)</span><br><span class="line">        print(self.a)</span><br><span class="line">        </span><br><span class="line">f = B(<span class="number">200</span>, <span class="number">300</span>)</span><br><span class="line">print(f.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'a'</span>: <span class="number">500</span>, <span class="string">'_A__d'</span>: <span class="number">-100</span>, <span class="string">'b'</span>: <span class="number">200</span>, <span class="string">'c'</span>: <span class="number">300</span>&#125;</span><br><span class="line"><span class="comment"># 这里因为基类A中定义的a属性是普通属性，所以在B类继承时可以直接使用。__d是私有属性，所以在这里不能直接使用，名称也变成了_A__d。</span></span><br><span class="line">print(f.__class__.__bases__)</span><br><span class="line">输出：</span><br><span class="line">(&lt;class '__main__.A'&gt;,)</span><br><span class="line">f.printv()</span><br><span class="line">输出：</span><br><span class="line"><span class="number">200</span></span><br><span class="line"><span class="number">500</span></span><br></pre></td></tr></table></figure>
<p>作为好的习惯，如果父类定义了<code>__init__</code>方法，你就该在子类的<code>__init__</code>中调用它。</p>
<p>那子类什么时候自动调用父类的<code>__init__</code>方法呢？</p>
<p>示例1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        self.__a2 = <span class="string">'a2'</span></span><br><span class="line">        print(<span class="string">'A init'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">b = B()</span><br><span class="line">print(b.__dict__)</span><br><span class="line">输出：</span><br><span class="line">A init</span><br><span class="line">&#123;<span class="string">'a1'</span>: <span class="string">'a1'</span>, <span class="string">'_A__a2'</span>: <span class="string">'a2'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>B实例的初始化会自动调用基类A的<code>__init__</code>方法</p>
<p>示例2</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        self.__a2 = <span class="string">'a2'</span></span><br><span class="line">        print(<span class="string">'A init'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.b1 = <span class="string">'b1'</span></span><br><span class="line">        print(<span class="string">'B init'</span>)</span><br><span class="line">        </span><br><span class="line">b = B()</span><br><span class="line">print(b.__dict__)</span><br><span class="line">输出：</span><br><span class="line">B init</span><br><span class="line">&#123;<span class="string">'b1'</span>: <span class="string">'b1'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>B实例的初始化<code>__init__</code>方法不会自动调用父类的初始化<code>__init__</code>方法，需要手动调用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.a1 = <span class="string">'a1'</span></span><br><span class="line">        self.__a2 = <span class="string">'a2'</span></span><br><span class="line">        print(<span class="string">'A init'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.b1 = <span class="string">'b1'</span></span><br><span class="line">        print(<span class="string">'B init'</span>)</span><br><span class="line">        A.__init__(self)</span><br><span class="line">        </span><br><span class="line">b = B()</span><br><span class="line">print(b.__dict__)</span><br><span class="line">输出：</span><br><span class="line">B init</span><br><span class="line">A init</span><br><span class="line">&#123;<span class="string">'b1'</span>: <span class="string">'b1'</span>, <span class="string">'a1'</span>: <span class="string">'a1'</span>, <span class="string">'_A__a2'</span>: <span class="string">'a2'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>如何正确初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, age)</span>:</span></span><br><span class="line">        print(<span class="string">'Animal init'</span>)</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.age)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, age, weight)</span>:</span></span><br><span class="line">        print(<span class="string">'Cat init'</span>)</span><br><span class="line">        self.age = age + <span class="number">1</span></span><br><span class="line">        self.weight = weight</span><br><span class="line">        </span><br><span class="line">c = Cat(<span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line">c.show()</span><br><span class="line">输出：</span><br><span class="line">Cat init</span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure>
<p>上例我们前面都分析过，不会调用父类的<code>__init__</code>方法的，这就会导致没有实现继承效果。所以在子类的<code>__init__</code>方法中，应该显式调用父类的<code>__init__</code>方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, age)</span>:</span></span><br><span class="line">        print(<span class="string">'Animal init'</span>)</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.age)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, age, weight)</span>:</span></span><br><span class="line">        <span class="comment"># 调用父类的__init__方法的顺序决定着show方法的结果</span></span><br><span class="line">        super().__init__(age)</span><br><span class="line">        print(<span class="string">'Cat init'</span>)</span><br><span class="line">        self.age = age + <span class="number">1</span></span><br><span class="line">        self.weight = weight</span><br><span class="line">        <span class="comment"># super().__init__(age)</span></span><br><span class="line">        </span><br><span class="line">c = Cat(<span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line">c.show()</span><br><span class="line">输出：</span><br><span class="line">Animal init</span><br><span class="line">Cat init</span><br><span class="line"><span class="number">11</span> <span class="comment"># 如果把继承父类的初始化属性放在子类初始化的最下面，这里显示就是10</span></span><br></pre></td></tr></table></figure>
<p>注意，调用父类的<code>__init__</code>方法，出现在不同的位置，可能导致出现不同的结果。</p>
<p>那么，直接将上例中所有的实例属性改成私有变量呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, age)</span>:</span></span><br><span class="line">        print(<span class="string">'Animal init'</span>)</span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.__age)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, age, weight)</span>:</span></span><br><span class="line">        <span class="comment"># 调用父类的__init__方法的顺序决定着show方法的结果</span></span><br><span class="line">        super().__init__(age)</span><br><span class="line">        print(<span class="string">'Cat init'</span>)</span><br><span class="line">        self.__age = age + <span class="number">1</span></span><br><span class="line">        self.__weight = weight</span><br><span class="line">        <span class="comment"># super().__init__(age)</span></span><br><span class="line">        </span><br><span class="line">c = Cat(<span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line">c.show()</span><br><span class="line">输出：</span><br><span class="line">Animal init</span><br><span class="line">Cat init</span><br><span class="line"><span class="number">10</span></span><br><span class="line">print(c.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'_Animal__age'</span>: <span class="number">10</span>, <span class="string">'_Cat__age'</span>: <span class="number">11</span>, <span class="string">'_Cat__weight'</span>: <span class="number">5</span>&#125;</span><br></pre></td></tr></table></figure>
<p>上例中打印10，原因看<code>__dict__</code>就知道了。因为父类<code>Animal</code>的<code>show</code>方法中<code>__age</code>会被解释为<code>_Animal__age</code>，因此显示的是10，而不是11。</p>
<p>这样的设计不好，<code>Cat</code>的实例<code>c</code>应该显示自己的属性值更好。</p>
<p><strong>解决的办法：一个原则，自己的私有属性，就该自己的方法读取和修改，不要借助其他类的方法，即使是父类或者派生类的方法。</strong></p>
<h3 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h3><p><code>__mro__</code>非常重要，它会保存方法的查找顺序</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">int.__subclasses__()   <span class="comment"># 看子类列表</span></span><br><span class="line">int.__bases__   <span class="comment"># 看祖先类</span></span><br><span class="line">int.__base__</span><br><span class="line">int.mro()   <span class="comment"># 自己是谁，继承自谁</span></span><br><span class="line">输出：</span><br><span class="line">[&lt;<span class="class"><span class="keyword">class</span> '<span class="title">bool</span>'&gt;]</span></span><br><span class="line"><span class="class"><span class="params">(&lt;class <span class="string">'object'</span>&gt;,)</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">object</span>'&gt;</span></span><br><span class="line">[&lt;class 'int'&gt;, &lt;class 'object'&gt;]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    x = <span class="number">123</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self._name = name</span><br><span class="line">        self.__age = <span class="number">10</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._name</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shout</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Animal shout'</span>)</span><br><span class="line">       <span class="comment"># return self.__age   </span></span><br><span class="line"><span class="comment"># 这只会访问到Animal类中的__age私有变量。如果在Cat类中也有这一句，并且Cat类中也初始化了一个__age</span></span><br><span class="line"><span class="comment"># 私有变量，那么在调用Cat的__age变量时，访问的就是Cat类的私有变量，与Animal类无关。从类的字典中也</span></span><br><span class="line"><span class="comment"># 可以看到私有变量的名称是不一样的，会分为是哪个类的私有变量。也就是不同的类中的方法只能访问自己类的</span></span><br><span class="line"><span class="comment"># 私有变量  </span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clsmtd</span><span class="params">(cls)</span>:</span></span><br><span class="line">        print(cls, cls.__name__)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    x = <span class="string">'cat'</span></span><br><span class="line">    <span class="comment"># 这里要在Cat类上做一些事情</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">	<span class="comment">#  Animal.__init__(self, name)  </span></span><br><span class="line"><span class="comment"># 有了这一句就会有三个属性，两个是父类的，一个是子类自己的，不然就会报错，说找不到_name属性，因为下</span></span><br><span class="line"><span class="comment"># 面实例中使用了tom.name，这是调用了父类的name方法</span></span><br><span class="line">        <span class="comment"># self.catname = name  </span></span><br><span class="line"><span class="comment"># 这样做的问题是没有调用父类的方法，它覆盖了父类的_name属性。也就是_Animal__age这个属性是属于</span></span><br><span class="line"><span class="comment"># Animal类的，下面只创建了一个tom实例，所以要给tom实例创建属性，就要继承父类的属性，所以在</span></span><br><span class="line"><span class="comment"># tom.__dict__中可以看到这个属性。_Animal__age是Animal类中定义的实例属性，所以它要找一个实例放</span></span><br><span class="line"><span class="comment"># 进去，虽然tom是Garfield类的实例，但是祖先的特征只能放在这个实例上，这是实例的初始化函数，在类的</span></span><br><span class="line"><span class="comment"># 属性__dict__中是找不到的</span></span><br><span class="line"><span class="comment"># 如果要多份，要放在实例属性上。如果只要一份，要放在类属性上，比如方法。只要一份的就是通用的，多份的</span></span><br><span class="line"><span class="comment"># 就是个性化的</span></span><br><span class="line">		super().__init__(name)  </span><br><span class="line"><span class="comment"># 根据下面所说的super()的使用方法，这里也可以写成这样，代替上面的写法。这样写self会直接传过去，因</span></span><br><span class="line"><span class="comment"># 为绑定了self，但name还要加上，新式类推荐使用这种写法</span></span><br><span class="line">		self._name = <span class="string">"Cat"</span>+name</span><br><span class="line"><span class="comment"># 这里送进来的是tom实例，实例给了Animal的初始化方法，初始化self._name = name。这里的</span></span><br><span class="line"><span class="comment"># self._name = "Cat"+name是又保留了一份_name属性，因为都是_name属性，所以这里的属性就覆盖了父类的</span></span><br><span class="line"><span class="comment"># _name属性，这就是子类覆盖父类的方法，显示是name: Cattom。如果把Animal.__init__和self._name两个方法</span></span><br><span class="line"><span class="comment"># 颠倒位置，那么结果实例还是要保留父类的_name属性，这是执行顺序。</span></span><br><span class="line"><span class="comment"># Animal.__init__()就是一个函数调用，还可以写成Animal.__init__(self, 'abc')。当子类要初始化时，就要</span></span><br><span class="line"><span class="comment"># 调用一下父类的初始化方法，如果不调用父类的初始化方法，就会在子类初始化时覆盖父类的方法。如果是__age这种隐</span></span><br><span class="line"><span class="comment"># 藏属性，就只是子类的，不会覆盖父类的。</span></span><br><span class="line">		self.__age = <span class="number">20</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shout</span><span class="params">(self)</span>:</span>  <span class="comment"># override。Cat类的这个方法会覆盖父类的同名方法</span></span><br><span class="line">       <span class="comment"># print('miao')</span></span><br><span class="line">    	super().shout()  </span><br><span class="line"><span class="comment"># 虽然覆盖了父类的方法，但是这里又调用了父类的方法。这里的方法的实现是调用父类的方法。这样下面的</span></span><br><span class="line"><span class="comment"># Garfield就也可以使用这个方法了，因为Garfield会继承这个方法，这个方法又调用了自己父类的这个方</span></span><br><span class="line"><span class="comment"># 法.super().shout()就等价于Animal.shout()。super()就是用来访问祖先类的</span></span><br><span class="line">        super(Cat, self).shout()  </span><br><span class="line"><span class="comment"># 也可以这样写，不过没必要这样写。这里的意思指在当前实例的类型中找Cat，也就是在类型的字典中找Cat，</span></span><br><span class="line"><span class="comment"># 找到后再找Cat的父类。这里的self实例只能是自己的或子类的实例化，一定不能是父类的实例化</span></span><br><span class="line">        print(<span class="string">'Cat shout'</span>)  </span><br><span class="line"><span class="comment"># 下面Garfield在调用这个shout方法时会先打印Animal shout再打印Cat shout</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clsmtd</span><span class="params">(cls)</span>:</span></span><br><span class="line">        print(cls, cls.__name__)</span><br><span class="line">       </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Garfield</span><span class="params">(Cat)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersiaCat</span><span class="params">(Cat)</span>:</span></span><br><span class="line">    <span class="comment"># def __init__(self):</span></span><br><span class="line">    <span class="comment">#		self.eyes = 'Blue'</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Dog run'</span>)</span><br><span class="line">        </span><br><span class="line">tom = Garfield(<span class="string">'tom'</span>)</span><br><span class="line">print(tom.name)</span><br><span class="line">输出：</span><br><span class="line">Cattom</span><br><span class="line"></span><br><span class="line">print(tom.shout())</span><br><span class="line">输出：</span><br><span class="line">Animal shout</span><br><span class="line">Animal shout</span><br><span class="line">Cat shout</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line"><span class="comment"># 上面都是Cat类中的shout方法输出的内容</span></span><br><span class="line">print(tom.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'_name'</span>: <span class="string">'Cattom'</span>, <span class="string">'_Animal__age'</span>: <span class="number">10</span>, <span class="string">'_Cat__age'</span>: <span class="number">20</span>&#125;</span><br><span class="line"></span><br><span class="line">print(Garfield.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"><span class="comment"># Garfield类因为用了pass，所以这里什么也没有</span></span><br><span class="line"></span><br><span class="line">print(Cat.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'x'</span>: <span class="string">'cat'</span>, <span class="string">'__init__'</span>: &lt;function Cat.__init__ at <span class="number">0x7fe43de66c80</span>&gt;, <span class="string">'shout'</span>: &lt;function Cat.shout at <span class="number">0x7fe43de66e18</span>&gt;, <span class="string">'clsmtd'</span>: &lt;classmethod object at <span class="number">0x7fe43de186a0</span>&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"><span class="comment"># x是Cat类本身的属性，但它并没有到Garfield类上去，虽然Garfield类继承自Cat类。</span></span><br><span class="line"><span class="comment"># 执行时会先看是不是自己实例的属性，如果不是，再看是不是属于当前类的，当前类没有再看祖先类有没有，如</span></span><br><span class="line"><span class="comment"># 果祖先没有，再看祖先的祖先有没有</span></span><br><span class="line"><span class="comment"># 隐藏改的名字是谁有就改谁的名字，也就是按照查找顺序，在这条继承链上查找，谁有就改谁的名字</span></span><br><span class="line"></span><br><span class="line">print(Animal.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'x'</span>: <span class="number">123</span>, <span class="string">'__init__'</span>: &lt;function Animal.__init__ at <span class="number">0x7f627caf6ae8</span>&gt;, <span class="string">'name'</span>: &lt;property object at <span class="number">0x7f627cb890e8</span>&gt;, <span class="string">'shout'</span>: &lt;function Animal.shout at <span class="number">0x7f627ca9fae8</span>&gt;, <span class="string">'clsmtd'</span>: &lt;classmethod object at <span class="number">0x7f627ca51630</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Animal'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Animal'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"><span class="comment"># 这里实例化首先使用new产生一个实例，这时要调用Cat类，把tom传给self，之后把实例传给</span></span><br><span class="line"><span class="comment"># Animal.__init__(self, name)中的self，再转到Animal类中的初始化执行，把_name和__age两个属性</span></span><br><span class="line"><span class="comment"># 给tom实例，接着执行self.catname = name，把第三个属性给tom实例。但是如果Cat类和属性要是与</span></span><br><span class="line"><span class="comment"># Animal类的属性都叫_name</span></span><br><span class="line"></span><br><span class="line">print(tom.clsmtd())</span><br><span class="line">输出：</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">Garfield</span>'&gt; <span class="title">Garfield</span></span></span><br><span class="line"><span class="class"><span class="title">None</span></span></span><br><span class="line"><span class="class"># 输出：&lt;<span class="title">class</span> '<span class="title">test3</span>.<span class="title">Garfield</span>'&gt; <span class="title">Garfield</span>，查看字典，在两个类属性中都有这个<span class="title">clsmtd</span>方法，在调</span></span><br><span class="line"><span class="class"># 用时会先调用<span class="title">Garfield</span>的父类，这里在<span class="title">Cat</span>中就可以找到<span class="title">clsmtd</span>，这时等于是<span class="title">tom</span>.<span class="title">__class__</span>传进了<span class="title">clsmtd</span>中，这</span></span><br><span class="line"><span class="class"># 时<span class="title">tom</span>的类是<span class="title">Garfield</span>，所以打印的也就是<span class="title">tom</span>所属类自己的名字了，虽然定义是在<span class="title">Cat</span>类中，但使用了类方法，传进去</span></span><br><span class="line"><span class="class"># 的是什么就应该打印什么。这与在哪个类上定义没关系，也就是找的时候找这个父类，但传的参数是自己。所以这里就算</span></span><br><span class="line"><span class="class"># 调用的是<span class="title">Animal</span>类，打印的结果也应该是一样的。这种东西就是<span class="title">python</span>中的多态</span></span><br><span class="line"><span class="class"></span></span><br><span class="line">dog = Dog('ahuang')</span><br><span class="line">dog.shout()</span><br><span class="line">print(<span class="string">'dog.x'</span>, dog.x)</span><br><span class="line">print(<span class="string">'dog'</span>, dog.__dict__)</span><br><span class="line">print(<span class="string">'dog.mro=&#123;&#125;'</span>.format(dog.__class__.__mro__)) </span><br><span class="line"><span class="comment"># 实例没有__mro__属性，类才有，这里打印的是继承链</span></span><br><span class="line">print(<span class="string">'dog.bases=&#123;&#125;'</span>.format(dog.__class__.__bases__)) </span><br><span class="line"><span class="comment"># bases才是真正的继承</span></span><br><span class="line">输出：</span><br><span class="line">Animal shout</span><br><span class="line"><span class="number">123</span></span><br><span class="line">&#123;<span class="string">'_name'</span>: <span class="string">'ahuang'</span>, <span class="string">'_Animal__age'</span>: <span class="number">10</span>&#125;</span><br><span class="line">(&lt;class '__main__.Dog'&gt;, &lt;class '__main__.Animal'&gt;, &lt;class 'object'&gt;)</span><br><span class="line">(&lt;class '__main__.Animal'&gt;,)</span><br></pre></td></tr></table></figure>
<p>加下划线和不加下划线的都是公有的，包括特殊的，在类上都继承下来，父类的就是你的，python为了实现做了一个查找的动作，对使用者来说可以不管这些。父类的就是我的，拿来就可以用。传的self就是自己，所以调父类的方法发现打印的self是自己，方法有一份就可以了，因为是不同的实例。</p>
<p>在子类中初始化时，要调用父类的初始化方法，不然就会覆盖父类的初始化方法（这里指<code>__init__</code>方法），但有一些方法也是不需要继承的。子类的<code>__init__</code>方法中的属性如果与父类中的重复，会覆盖父类中的属性。另外，私有属性是自己的，不会继承。如果子类不做初始化或初始化没有重名，就会继承父类的初始化方法。所以最好显式地调用父类的初始化方法。私有变量如果与父类中的有冲突，并把调用这个变量的方法重新在子类中再写一次，因为私有变量是不会互相覆盖的。要覆盖就不要用私有变量。父类和祖先类的，除了私有的，都是我的。所以传进去的self，class也是自己的，显示的也是自己的，私有变量除外。</p>
<p>Minxi</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.content)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableWord</span><span class="params">(Word)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Word print &#123;&#125;'</span>.format(self.content))</span><br><span class="line"><span class="comment"># 如果Word是第三方提供的或很庞大，只是觉得它的print方法打印的不好，这时可以将Word类继承下来，只写一</span></span><br><span class="line"><span class="comment"># 个print方法覆盖Word的同名方法，也就是临时增加一个打印功能。实例是实现这个功能的实例</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(Document)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(Word.mro())</span></span><br><span class="line"><span class="comment"># word = Word('test\nabc')</span></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># [&lt;class '__main__.Word'&gt;, &lt;class '__main__.Document'&gt;, &lt;class 'object'&gt;]</span></span><br><span class="line"><span class="comment"># 先找Word类，再找父类，最后找祖先类</span></span><br><span class="line">print(PrintableWord.mro())</span><br><span class="line">输出：</span><br><span class="line">[&lt;class '__main__.PrintableWord'&gt;, &lt;class '__main__.Word'&gt;, &lt;class '__main__.Document'&gt;, &lt;class 'object'&gt;]</span><br><span class="line"></span><br><span class="line">word = PrintableWord(<span class="string">'test\nabc'</span>)</span><br><span class="line">print(word.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'content'</span>: <span class="string">'test\nabc'</span>&#125;</span><br><span class="line">==================================================================================</span><br><span class="line">装饰器</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.content)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 这样写表示第三方库，不动</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def print(self):</span></span><br><span class="line"><span class="comment">#     print('Word print &#123;&#125;'.format(self.content))	</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printable</span><span class="params">(cls)</span>:</span></span><br><span class="line">    cls.<span class="keyword">print</span> = <span class="keyword">lambda</span> self: print(self.content)</span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="comment"># PrintableWord是类对象作为参数传到printable函数中当作cls，这个cls是可以被动态地增加类属性的，</span></span><br><span class="line"><span class="comment"># 类属性是增加在这个类对象的dict上的，也就是类的dict上的。这个属性对应的是一个lambda函数。这个</span></span><br><span class="line"><span class="comment"># lambda函数就是上面的print方法的功能。当我们调用print的时候就应该是已经实例化后调用了，所以这时</span></span><br><span class="line"><span class="comment"># 调用类方法时就会动态增加一个类属性，这时实例也被当作self传入到lambda函数了。这种方法必须会</span></span><br><span class="line"><span class="meta">@printable   </span></span><br><span class="line"><span class="comment"># 要让哪个类打印，就给他一个打印的功能，这是一个函数。先写等价式：</span></span><br><span class="line"><span class="comment"># PrintableWord=printable(PrintableWord)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableWord</span><span class="params">(Word)</span>:</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(Document)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(PrintableWord.__dict__)  <span class="comment"># 查看是否有print方法</span></span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function PrintableWord.__init__ at <span class="number">0x7f10fe61aae8</span>&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'print'</span>: &lt;function printable.&lt;locals&gt;.&lt;<span class="keyword">lambda</span>&gt; at <span class="number">0x7f10fe671ea0</span>&gt;&#125;</span><br><span class="line"><span class="comment"># a = PrintableWord('abc')  # 这时a有print和</span></span><br><span class="line"><span class="comment"># a.print()</span></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># abc</span></span><br><span class="line">=================================================================================</span><br><span class="line"><span class="comment"># Mixin</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableMixin</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'~~~~~~~~~~~'</span>)</span><br><span class="line">        print(<span class="string">'&#123;&#125;'</span>.format(self.content))</span><br><span class="line"><span class="comment"># Mixin与装饰器函数写的都差不多，但Mixin是类，有类的三种特征     </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        self.content = content</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.content)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printable</span><span class="params">(cls)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_print</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'~~~~~~~~~~~'</span>)</span><br><span class="line">        print(<span class="string">'&#123;&#125;'</span>.format(self.content))</span><br><span class="line">    cls.<span class="keyword">print</span> = _print</span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Word</span><span class="params">(Document)</span>:</span> <span class="keyword">pass</span>   <span class="comment"># 这样写表示第三方库，不动</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@printable</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintableWord</span><span class="params">(Word)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pdf</span><span class="params">(Document)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintablePdf</span><span class="params">(PrintableMixin, Pdf)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 这个类继承自PrintableMixin和Pdf，PrintableMixin继承自object，Pdf继承自Document，</span></span><br><span class="line"><span class="comment"># Document继承自object。执行的查找使用c3算法，深度优先。Mixin一般都放在最前面，因为Mixin是我们</span></span><br><span class="line"><span class="comment"># 要混进来的方法，所以需要先执行。Mixin混进来是为了覆盖原有的方法</span></span><br><span class="line"></span><br><span class="line">print(PrintablePdf.mro())</span><br><span class="line">输出：</span><br><span class="line">[&lt;class '__main__.PrintablePdf'&gt;, &lt;class '__main__.PrintableMixin'&gt;, &lt;class '__main__.Pdf'&gt;, &lt;class '__main__.Document'&gt;, &lt;class 'object'&gt;]</span><br><span class="line"></span><br><span class="line">word = PrintablePdf(<span class="string">'test\nabc'</span>)</span><br><span class="line">print(word.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'content'</span>: <span class="string">'test\nabc'</span>&#125;</span><br><span class="line"></span><br><span class="line">word.print()  <span class="comment"># 这里调用的print()方法是在Document类中定义的。PrintableMixin中定义的是_print方法，调用时也要用word._print()调用</span></span><br><span class="line">输出：</span><br><span class="line">test</span><br><span class="line">abc</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/05/python基础学习-面向对象(重要)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/05/python基础学习-面向对象(重要)/" itemprop="url">
                  python基础学习-面向对象(重要)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-05 20:36:18" itemprop="dateCreated datePublished" datetime="2020-03-05T20:36:18+08:00">2020-03-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-07-14 16:18:18" itemprop="dateModified" datetime="2020-07-14T16:18:18+08:00">2020-07-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="语言的分类"><a href="#语言的分类" class="headerlink" title="语言的分类"></a>语言的分类</h3><p>面向机器</p>
<p>抽象成机器指令，机器容易理解</p>
<p>代表：汇编语言</p>
<p>面向过程</p>
<p>做一件事情，排出个步骤，第一步干什么，第二步干什么，如果出现情况A，做什么处理，如果出现了情况B，做什么处理。</p>
<p>问题规模小，可以步骤化，按部就班处理。</p>
<p>代表：C语言</p>
<p>面向对象OOP</p>
<p>随着计算机需要解决的问题的规模扩大，情况越来越复杂。需要很多人、很多部门协作，面向过程编程不太适合了。</p>
<p>代表：C++、Java、Python等</p>
<h3 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h3><p>什么是面向对象呢？</p>
<p>一种认识世界、分析世界的方法论。将万事万物抽象为类。</p>
<p>类<code>class</code></p>
<p>类是抽象的概念，是万事万物的抽象，是一类事物的共同特征的集合。</p>
<p>用计算机语言来描述类，就是属性和方法的集合。</p>
<p>对象<code>instance</code>、<code>object</code></p>
<p>对象是类的具象，是一个实例。</p>
<p>对于我们每个人这个个体，都是抽象概念人类的不同的实例。</p>
<p>举例：</p>
<p>你吃鱼</p>
<p>你，就是对象；鱼，也是对象；吃就是动作</p>
<p>你是具体的人，是具体的对象。你属于人类，人类是个抽象的概念，是无数具体的个体的抽象。鱼，也是具体的对象，就是你吃的这一条具体的鱼。这条鱼属于鱼类，是无数的鱼抽象出来的概念。</p>
<p>吃，是动作，也是操作，也是方法，这个吃是你的动作，也就是人类具有的方法。如果反过来，鱼吃人。吃就是鱼类的动作了。</p>
<p>吃，这个动作，很多动物都具有的动作，人类和鱼类都属于动物类，而动物类是抽象的概念，是动物都有吃的动作，但是吃法不同而已。</p>
<p>你驾驶车，这个车也是车类的具体的对象（实例），驾驶这个动作是鱼类不具有的，是人类具有的方法。</p>
<p>属性，它是对象状态的抽象，用数据结构来描述。</p>
<p>操作，它是对象行为的抽象，用操作名和实现该操作的方法来描述</p>
<p>每个人都有名字、身高、体重等信息，这些信息是个人的属性，但是，这些信息不能保存在人类中，因为它是抽象的概念，不能保留具体的值。</p>
<p>而人类的实例，是具体的人，他可以存储这些具体的属性，而且可以不同人有不同的属性。</p>
<p>哲学</p>
<p>一切皆对象</p>
<p>对象是数据和操作的封装</p>
<p>对象是独立的，但是对象之间可以相互作用（这对应的是人吃鱼的例子，<strong><em>动作把这两个对象关联起来</em></strong> ）</p>
<p>目前OOP是最接近人类认知的编程范式</p>
<h3 id="面向对象三要素"><a href="#面向对象三要素" class="headerlink" title="面向对象三要素"></a>面向对象三要素</h3><ol>
<li>封装<ul>
<li>组装：将数据和操作组装到一起。</li>
<li>隐藏数据：对外只暴露一些接口，通过接口访问对象。比如驾驶员使用汽车，不需要了解汽车的构造细节，只需要知道使用什么部件怎么驾驶就行，踩了油门就能跑，可以不了解后面的机动原理。</li>
</ul>
</li>
<li>继承<ul>
<li>多复用，继承来的就不用自己写了</li>
<li>多继承少修改，OCP（Open-closed Principle），使用继承来改变，来体现个性</li>
</ul>
</li>
<li>多态<ul>
<li>面向对象编程最灵活的地方，动态绑定</li>
</ul>
</li>
</ol>
<p>人类就是封装：</p>
<p>人类继承自动物类，孩子继承父母特征。分为单一继承、多继承；</p>
<p>多态，继承自动物类的人类、猫类的操作“吃”不同</p>
<h3 id="Python的类"><a href="#Python的类" class="headerlink" title="Python的类"></a>Python的类</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassName</span>:</span></span><br><span class="line">    语句块</span><br></pre></td></tr></table></figure>
<ol>
<li>必须使用<code>class</code>关键字</li>
<li>类名必须是用大驼峰命名</li>
<li>类定义完成后，就产生了一个类对象，绑定到了标识符<code>ClassName</code>上</li>
</ol>
<p>举例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="string">"""A example class"""</span>   <span class="comment"># 文档字符串</span></span><br><span class="line">    x = <span class="string">'abc'</span>  <span class="comment"># 类属性，不是对象的属性，对象的属性指的是类的实例的属性</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span>  <span class="comment"># 类属性foo，也是方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'My Class'</span></span><br><span class="line">    </span><br><span class="line">print(MyClass.x)</span><br><span class="line">print(MyClass.foo)</span><br><span class="line">print(MyClass.__doc__)</span><br><span class="line">输出：</span><br><span class="line">abc</span><br><span class="line">&lt;function MyClass.foo at <span class="number">0x7f235932f1e0</span>&gt;</span><br><span class="line">A example <span class="class"><span class="keyword">class</span></span></span><br></pre></td></tr></table></figure>
<h3 id="类对象及类属性"><a href="#类对象及类属性" class="headerlink" title="类对象及类属性"></a>类对象及类属性</h3><ul>
<li>类对象，类的定义就会生成一个类对象</li>
<li>类的属性，类定义中的变量和类中定义的方法都是类的属性</li>
<li>类变量，上例中<code>x</code>是类<code>MyClass</code>的变量</li>
</ul>
<p><code>MyClass</code>中，<code>x</code>、<code>foo</code>都是类的属性，<code>__doc__</code>也是类的属性</p>
<p><code>foo</code>方法是类的属性，如同<code>吃</code>是人类的方法，但是每一个具体的人才能吃东西，也就是说<code>吃</code>是人的实例才能调用的方法</p>
<p><code>foo</code>是方法对象<code>method</code>，不是普通的函数对象<code>function</code>了，它一般要求至少有一个参数。第一个参数可以是<code>self</code>（<code>self</code>只是个惯用标识符，可以换名字），这个参数位置就留给了<code>self</code>。</p>
<p><code>self</code>指代当前实例本身</p>
<p>问题</p>
<p>上例中，类是谁？实例是谁？</p>
<h4 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a>实例化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = MyClass()  <span class="comment"># 实例化</span></span><br></pre></td></tr></table></figure>
<p>使用上面的语法，在类对象名称后面加上一个括号，就调用类的实例化方法，完成实例化。实例化就真正创建一个该类的对象（实例）。例如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tom = Person()</span><br><span class="line">jerry = Person()</span><br></pre></td></tr></table></figure>
<p>上面的<code>tom</code>、<code>jerry</code>都是<code>Person</code>类的实例，通过实例化生成了2个实例。</p>
<p>每次实例化后获得的实例，是不同的实例，即使是使用同样的参数实例化，也得到不一样的对象。</p>
<p>Python类实例化后，会自动调用 <code>__init__</code>方法。这个方法第一个参数必须留给<code>self</code>，其它参数随意。</p>
<h4 id="init-方法"><a href="#init-方法" class="headerlink" title="__init__方法"></a><code>__init__</code>方法</h4><p><code>MyClass()</code>实际上调用的是<code>__init__(self)</code>方法，可以不定义，如果没有定义会在实例化后隐式调用。</p>
<p>作用：对实例进行初始化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class MyClass:</span><br><span class="line">def __init__(self):</span><br><span class="line">	print('init')</span><br><span class="line">	</span><br><span class="line">print(MyClass)   # 不会调用</span><br><span class="line">print(MyClass())   # 调用__init__</span><br><span class="line">a = MyClass()   # 调用__init__</span><br></pre></td></tr></table></figure>
<p>初始化函数可以有多个参数，请注意第一个位置必须是self，例如<code>__init__(self, name, age)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">showage</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'&#123;&#125; is &#123;&#125;'</span>.format(self.name, self.age))</span><br><span class="line">        </span><br><span class="line">tom = Person(<span class="string">'Tom'</span>, <span class="number">20</span>)   <span class="comment"># 实例化</span></span><br><span class="line">jerry = Person(<span class="string">'Je'</span>, <span class="number">25</span>)</span><br><span class="line">print(tom.name, jerry.age)</span><br><span class="line">jerry.age += <span class="number">1</span></span><br><span class="line">print(jerry.age)</span><br><span class="line">jerry.showage()</span><br><span class="line">输出：</span><br><span class="line">Tom <span class="number">25</span></span><br><span class="line"><span class="number">26</span></span><br><span class="line">Jerry <span class="keyword">is</span> <span class="number">26</span></span><br></pre></td></tr></table></figure>
<p>注意：<code>__init__()</code>方法不能有返回值，也就是只能是None</p>
<h4 id="实例对象instance"><a href="#实例对象instance" class="headerlink" title="实例对象instance"></a>实例对象<code>instance</code></h4><p>类实例化后一定会获得一个对象，就是实例对象</p>
<p>上例中的<code>tom</code>、<code>jerry</code>就是<code>Person</code>类的实例</p>
<p><code>__init__</code>方法的第一参数<code>self</code>就是指代某一个实例。</p>
<p>类实例化后，得到一个实例对象（实例对象也可以说成类的对象），实例对象会绑定方法，调用方法时采用<code>jerry.showage()</code>的方式。但是函数签名是<code>showage(self)</code>，少传一个参数<code>self</code>吗？</p>
<p>这个<code>self</code>就是<code>jerry</code>，Python会把方法的调用者作为第一参数<code>self</code>的实参传入。</p>
<p><code>self.name</code>就是<code>jerry</code>对象的<code>name</code>，<code>name</code>是保存在了<code>jerry</code>对象上，而不是<code>Person</code>类上。所以，称为实例变量。</p>
<h4 id="self"><a href="#self" class="headerlink" title="self"></a><code>self</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'self in init = &#123;&#125;'</span>.format(id(self)))</span><br><span class="line">        </span><br><span class="line">c = MyClass()   <span class="comment"># 会调用__init__</span></span><br><span class="line">print(<span class="string">'c = &#123;&#125;'</span>.format(id(c)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印结果为</span></span><br><span class="line">self <span class="keyword">in</span> init = <span class="number">139837178141328</span></span><br><span class="line">c = <span class="number">139837178141328</span></span><br></pre></td></tr></table></figure>
<p>上例说明，<code>self</code>就是调用者，就是<code>c</code>对应的实例对象。</p>
<p><code>self</code>这个名字只是一个惯例，它可以修改，但是请不要修改，否则影响代码的可读性</p>
<p>看打印的结果，思考一下执行的顺序，为什么？</p>
<h3 id="实例变量和类变量"><a href="#实例变量和类变量" class="headerlink" title="实例变量和类变量"></a>实例变量和类变量</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    age = <span class="number">3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        </span><br><span class="line"><span class="comment"># tom = Person('Tom', 20)</span></span><br><span class="line">tom = Person(<span class="string">'Tom'</span>)   <span class="comment"># 实例化、初始化</span></span><br><span class="line">jerry = Person(<span class="string">'Jerry'</span>)</span><br><span class="line"></span><br><span class="line">print(tom.name, tom.age)</span><br><span class="line">print(jerry.name, jerry.age)</span><br><span class="line">print(Person.age)</span><br><span class="line"><span class="comment"># print(Person.name)</span></span><br><span class="line">Person.age = <span class="number">30</span></span><br><span class="line">print(Person.age, tom.age, jerry.age)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">Tom <span class="number">3</span></span><br><span class="line">Jerry <span class="number">3</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">30</span> <span class="number">30</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>
<p>实例变量是每一个实例自己的变量，是自己独有的；类变量是类的变量，是类的所有实例共享的属性和方法</p>
<table>
<thead>
<tr>
<th>特殊属性</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__name__</code></td>
<td>对象名</td>
</tr>
<tr>
<td><code>__class__</code></td>
<td>对象的类型</td>
</tr>
<tr>
<td><code>__dict__</code></td>
<td>对象的属性的字典</td>
</tr>
<tr>
<td><code>__qualname__</code></td>
<td>类的限定名</td>
</tr>
</tbody>
</table>
<p>注意：</p>
<p>Python中每一种对象都拥有不同的属性。函数、类都是对象，类的实例也是对象。</p>
<p>举例</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    age = <span class="number">3</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        </span><br><span class="line">print(<span class="string">'---------class------------'</span>)</span><br><span class="line">print(Person.__class__)</span><br><span class="line">print(sorted(Person.__dict__.items()), end=<span class="string">'\n\n'</span>)   <span class="comment"># 属性字典</span></span><br><span class="line"></span><br><span class="line">tom = Person(<span class="string">'Tom'</span>)</span><br><span class="line">print(<span class="string">'----------instance tom-----------'</span>)</span><br><span class="line">print(tom.__class__)</span><br><span class="line">print(sorted(tom.__dict__.items()), end=<span class="string">'\n\n'</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"-------------tom's class--------------"</span>)</span><br><span class="line">print(tom.__class__.__name__)</span><br><span class="line">print(sorted(tom.__class__.__dict__.items()), end=<span class="string">'\n\n'</span>)</span><br><span class="line">输出：</span><br><span class="line">---------<span class="class"><span class="keyword">class</span>-------------</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">type</span>'&gt;</span></span><br><span class="line">[('__dict__', &lt;attribute '__dict__' of 'Person' objects&gt;), ('__doc__', None), ('__init__', &lt;function Person.__init__ at 0x7f8b8f126550&gt;), ('__module__', '__main__'), ('__weakref__', &lt;attribute '__weakref__' of 'Person' objects&gt;), ('age', 3)]</span><br><span class="line"></span><br><span class="line">----------instance tom------------------</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">Person</span>'&gt;</span></span><br><span class="line"><span class="class">[<span class="params">(<span class="string">'name'</span>, <span class="string">'Tom'</span>)</span>]  # 实例的字典</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">--------------------<span class="title">tom</span>'<span class="title">s</span> <span class="title">class</span>----------------------</span></span><br><span class="line"><span class="class"><span class="title">Person</span></span></span><br><span class="line">[('__dict__', &lt;attribute '__dict__' of 'Person' objects&gt;), ('__doc__', None), ('__init__', &lt;function Person.__init__ at 0x7f8b8f126550&gt;), ('__module__', '__main__'), ('__weakref__', &lt;attribute '__weakref__' of 'Person' objects&gt;), ('age', 3)]  # 类的字典</span><br></pre></td></tr></table></figure>
<p>上例中，可以看到类属性保存在类的<code>__dict__</code>中，实例属性保存在实例的<code>__dict__</code>中，如果从实例访问类的属性，就需要借助<code>__class__</code>找到所属的类</p>
<p>有了上面知识，再看下面的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    age = <span class="number">3</span></span><br><span class="line">    height = <span class="number">170</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">tom = Person(<span class="string">'Tom'</span>)   <span class="comment"># 实例化、初始化</span></span><br><span class="line">jerry = Person(<span class="string">'Jerry'</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">Person.age = <span class="number">30</span></span><br><span class="line">print(Person.age, tom.age, jerry.age)   <span class="comment"># 输出什么结果</span></span><br><span class="line"></span><br><span class="line">print(Person.height, tom.height, jerry.height)   <span class="comment"># 输出什么结果</span></span><br><span class="line">jerry.height = <span class="number">175</span></span><br><span class="line">print(Person.height, tom.height, jerry.height)   <span class="comment"># 输出什么结果</span></span><br><span class="line"></span><br><span class="line">tom.height += <span class="number">10</span></span><br><span class="line">print(Person.height, tom.height, jerry.height)   <span class="comment"># 输出什么结果</span></span><br><span class="line"></span><br><span class="line">Person.height += <span class="number">15</span></span><br><span class="line">print(Person.height, tom.height, jerry.height)   <span class="comment"># 输出什么结果</span></span><br><span class="line"></span><br><span class="line">Person.weight += <span class="number">70</span></span><br><span class="line">print(Person.weight, tom.weight, jerry.weight)   <span class="comment"># 输出什么结果</span></span><br><span class="line"></span><br><span class="line">print(tom.__dict__[<span class="string">'height'</span>])</span><br><span class="line">print(tom.__dict__[<span class="string">'weight'</span>])   <span class="comment"># 可以吗</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">30</span> <span class="number">18</span> <span class="number">20</span></span><br><span class="line"><span class="number">170</span> <span class="number">170</span> <span class="number">170</span></span><br><span class="line"><span class="number">170</span> <span class="number">170</span> <span class="number">175</span></span><br><span class="line"><span class="number">170</span> <span class="number">180</span> <span class="number">175</span></span><br><span class="line"><span class="number">185</span> <span class="number">180</span> <span class="number">175</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/面向对象.py"</span>, line <span class="number">91</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    Person.weight += <span class="number">70</span></span><br><span class="line">AttributeError: type object <span class="string">'Person'</span> has no attribute <span class="string">'weight</span></span><br></pre></td></tr></table></figure>
<p>总结</p>
<p>是类的，也是这个类所有实例的，类的实例都可以访问到；是实例的，就是这个实例自己的，通过类访问不到。</p>
<p>类变量是属于类的变量，这个类的所有实例可以共享这个变量。</p>
<p>实例可以动态的给自己增加一个属性。<code>实例.__dict__[变量名]</code>和<code>实例.变量名</code>都可以访问到。</p>
<p>实例的同名变量会隐藏这个类变量，或者说是覆盖了这个类变量。这就像上例中用<code>jerry.height = 175</code>，这样就用jerry的<code>height</code>覆盖了类中的<code>height</code>的值</p>
<p>实例属性的查找顺序</p>
<p>指的是实例使用<code>.</code>来访问属性，会先找自己的<code>__dict__</code>，如果没有，然后通过属性<code>__class__</code>找到自己的类，再去类的<code>__dict__</code>中找</p>
<p>注意，如果实例使用<code>__dict_[变量名]</code>访问变量，将不会按照上面的查找顺序找变量了，这是指明使用字典的key查找，不是属性查找。</p>
<p>一般来说，类变量使用全大写来命名</p>
<h3 id="装饰一个类"><a href="#装饰一个类" class="headerlink" title="装饰一个类"></a>装饰一个类</h3><p>回顾，什么是高阶函数？什么是装饰器函数？</p>
<p>思考，如何装饰一个类？</p>
<p>需求，为一个类通过装饰，增加一些类属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加类变量</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_name</span><span class="params">(name, cls)</span>:</span></span><br><span class="line">    cls.NAME = name   <span class="comment"># 动态增加类属性</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 改进成装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_name</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(cls)</span>:</span></span><br><span class="line">        cls.NAME = name</span><br><span class="line">        <span class="keyword">return</span> cls</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@add_name('Tom')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    AGE = <span class="number">3</span></span><br><span class="line">    </span><br><span class="line">print(Person.NAME,Person.__dict__)</span><br><span class="line">输出：</span><br><span class="line">Tom &#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'AGE'</span>: <span class="number">3</span>, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'NAME'</span>: <span class="string">'Tom'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>之所以能够装饰，本质上是给类对象（cls）动态的添加了一个属性（cls.NAME），而Person这个标识符指向这个类对象。</p>
<h3 id="类方法和静态方法"><a href="#类方法和静态方法" class="headerlink" title="类方法和静态方法"></a>类方法和静态方法</h3><p>前面的例子中定义的<code>__init__</code>等方法，这些方法本身都是类的属性，第一个参数必须是<code>self</code>，而<code>self</code>必须指向一个对象，也就是类必须实例化之后，由实例来调用这个方法。</p>
<h4 id="普通函数"><a href="#普通函数" class="headerlink" title="普通函数"></a>普通函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">normal_method</span><span class="params">()</span>:</span>   <span class="comment"># 可以吗？</span></span><br><span class="line">        print(<span class="string">'normal'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 如何调用</span></span><br><span class="line">Person.normal_method()   <span class="comment"># 可以吗？</span></span><br><span class="line">Person().normal_method()   <span class="comment"># 可以吗？这里传报错的原因是，在定义的类中并没有self，Person()表示实例化，所以实例并没有normal_method方法，所以报错</span></span><br><span class="line"></span><br><span class="line">print(Person.__dict__)</span><br><span class="line">输出：</span><br><span class="line">normal</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/面向对象.py"</span>, line <span class="number">117</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    Person().normal_method()</span><br><span class="line">TypeError: normal_method() takes <span class="number">0</span> positional arguments but <span class="number">1</span> was given</span><br></pre></td></tr></table></figure>
<p><code>Person.normal_method()</code></p>
<p>可以，因为这个方法只是被Person这个名词空间管理的一个普通的方法，<code>normal_method</code>只是<code>Person</code>的一个属性而已。</p>
<p>由于<code>normal_method</code>在定义的时候没有指定<code>self</code>，所以不能完成实例对象的绑定，不能用<code>Person().normal_method()</code>调用。</p>
<p>注意：虽然语法是对的，但是，没有人这么用，也就是说禁止这么写</p>
<h4 id="类方法"><a href="#类方法" class="headerlink" title="类方法"></a>类方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">class_method</span><span class="params">(cls)</span>:</span>   <span class="comment"># cls是什么</span></span><br><span class="line">        print(<span class="string">'class = &#123;0.__name__&#125;(&#123;0&#125;)'</span>.format(cls))</span><br><span class="line"><span class="comment"># cls就是类对象，类对象就是0，所以可以调用0.__name__。(&#123;0&#125;)中，括号是字符串，也就是打印一个括号，&#123;0&#125;是占位符，占位符显示类对象打印出来的一长串东西</span></span><br><span class="line">        cls.HEIGHT = <span class="number">170</span></span><br><span class="line">        </span><br><span class="line">Person.class_method()</span><br><span class="line">print(Person.__dict__)</span><br><span class="line">输出：</span><br><span class="line">class = Person(&lt;class '__main__.Person'&gt;)</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'class_method'</span>: &lt;classmethod object at <span class="number">0x7fc4283d1a90</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'HEIGHT'</span>: <span class="number">170</span>&#125;</span><br></pre></td></tr></table></figure>
<p>类方法</p>
<ol>
<li><p>在类定义中，使用<code>@classmethod</code>装饰器修饰的方法</p>
</li>
<li><p>必须至少有一个参数，且第一个参数留给了<code>cls</code>，<code>cls</code>指代调用者即类对象自身</p>
</li>
<li><p><code>cls</code>这个标识符可以是任意合法名称，但是为了易读，请不要修改</p>
</li>
<li><p>通过<code>cls</code>可以直接操作类的属性</p>
<p>注意：无法通过<code>cls</code>操作类的实例。为什么？</p>
</li>
</ol>
<p>类方法，类似于C++、Java中的静态方法</p>
<h4 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">class_method</span><span class="params">(cls)</span>:</span>   <span class="comment"># cls是什么</span></span><br><span class="line">        print(<span class="string">'class = &#123;0.__name__&#125;(&#123;0&#125;)'</span>.format(cls))</span><br><span class="line">        cls.HEIGHT = <span class="number">170</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">static_methd</span><span class="params">()</span>:</span></span><br><span class="line">        print(Person.HEIGHT)</span><br><span class="line">        </span><br><span class="line">Person.class_method()</span><br><span class="line">Person.static_methd()</span><br><span class="line">print(Person.__dict__)</span><br><span class="line">输出：</span><br><span class="line">class = Person(&lt;class '__main__.Person'&gt;)</span><br><span class="line"><span class="number">170</span></span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'class_method'</span>: &lt;classmethod object at <span class="number">0x7f4247ddda90</span>&gt;, <span class="string">'static_methd'</span>: &lt;staticmethod object at <span class="number">0x7f4247df75b0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'HEIGHT'</span>: <span class="number">170</span>&#125;</span><br></pre></td></tr></table></figure>
<p>静态方法</p>
<ol>
<li><p>在类定义中，使用@staticmethod装饰器修饰的方法</p>
</li>
<li><p>调用时，不会隐式的传入参数</p>
<p>静态方法，只是表明这个方法属于这个名词空间。函数归在一起，方便组织管理。</p>
</li>
</ol>
<h4 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h4><p>类可以定义这么多种方法，究竟如何调用它们？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">normal_method</span><span class="params">()</span>:</span></span><br><span class="line">        print(<span class="string">'normal'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"&#123;&#125;'s method"</span>.format(self))</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">class_method</span><span class="params">(cls)</span>:</span>   <span class="comment"># cls是什么</span></span><br><span class="line">        print(<span class="string">'class = &#123;0.__name__&#125;(&#123;0&#125;)'</span>.format(cls))</span><br><span class="line">        cls.HEIGHT = <span class="number">170</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">static_methd</span><span class="params">()</span>:</span></span><br><span class="line">        print(Person.HEIGHT)</span><br><span class="line">        </span><br><span class="line">print(<span class="string">'~~~~~~类访问'</span>)</span><br><span class="line">print(<span class="number">1</span>, Person.normal_method())   <span class="comment"># 可以吗</span></span><br><span class="line"><span class="comment"># print(2, Person.method())   # 可以吗。这里不可以，因为这是实例的方法</span></span><br><span class="line">print(<span class="number">3</span>, Person.class_method())   <span class="comment"># 可以吗</span></span><br><span class="line">print(<span class="number">4</span>, Person.static_methd)   <span class="comment"># 可以吗</span></span><br><span class="line">print(Person.__dict__)</span><br><span class="line">print(<span class="string">'~~~~~~实例访问'</span>)</span><br><span class="line">print(<span class="string">'tom-----'</span>)</span><br><span class="line">tom = Person()</span><br><span class="line"><span class="comment"># print(1, tom.normal_method())   # 可以吗。这里不可以，因为normal_method不是实例的方法</span></span><br><span class="line">print(<span class="number">2</span>, tom.method())   <span class="comment"># 可以吗</span></span><br><span class="line">print(<span class="number">3</span>, tom.class_method())   <span class="comment"># 可以吗</span></span><br><span class="line">print(<span class="number">4</span>, tom.static_methd())   <span class="comment"># 可以吗</span></span><br><span class="line">print(<span class="string">'jerry-----'</span>)</span><br><span class="line">jerry = Person()</span><br><span class="line"><span class="comment"># print(1, jerry.normal_method())   # 可以吗。这里不可以，因为normal_method不是实例的方法</span></span><br><span class="line">print(<span class="number">2</span>, jerry.method())   <span class="comment"># 可以吗</span></span><br><span class="line">print(<span class="number">3</span>, jerry.class_method())   <span class="comment"># 可以吗</span></span><br><span class="line">print(<span class="number">4</span>, jerry.static_methd())   <span class="comment">#  可以吗</span></span><br><span class="line">输出：</span><br><span class="line">~~~~~~~~~~类访问</span><br><span class="line">normal</span><br><span class="line"><span class="number">1</span> <span class="keyword">None</span></span><br><span class="line">class = Person(&lt;class '__main__.Person'&gt;)</span><br><span class="line"><span class="number">3</span> <span class="keyword">None</span></span><br><span class="line"><span class="number">170</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">None</span></span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'normal_method'</span>: &lt;function Person.normal_method at <span class="number">0x7fe2e6af1550</span>&gt;, <span class="string">'method'</span>: &lt;function Person.method at <span class="number">0x7fe2e6af15e0</span>&gt;, <span class="string">'class_method'</span>: &lt;classmethod object at <span class="number">0x7fe2e6b54a90</span>&gt;, <span class="string">'static_method'</span>: &lt;staticmethod object at <span class="number">0x7fe2e6b795b0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'HEIGHT'</span>: <span class="number">170</span>&#125;</span><br><span class="line">~~~~~~~~~~实例访问</span><br><span class="line">tom------------</span><br><span class="line">&lt;__main__.Person object at <span class="number">0x7fe2e6b6e8b0</span>&gt;<span class="string">'s method</span></span><br><span class="line"><span class="string">2 None</span></span><br><span class="line"><span class="string">class = Person(&lt;class '</span>__main__.Person<span class="string">'&gt;)</span></span><br><span class="line"><span class="string">3 None</span></span><br><span class="line"><span class="string">170</span></span><br><span class="line"><span class="string">4 None</span></span><br><span class="line"><span class="string">jerry-----------</span></span><br><span class="line"><span class="string">&lt;__main__.Person object at 0x7fe2e6bb7580&gt;'</span>s method</span><br><span class="line"><span class="number">2</span> <span class="keyword">None</span></span><br><span class="line">class = Person(&lt;class '__main__.Person'&gt;)</span><br><span class="line"><span class="number">3</span> <span class="keyword">None</span></span><br><span class="line"><span class="number">170</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">None</span></span><br><span class="line"><span class="comment"># 这是先执行类方法中的print函数，再执行调用的print函数，所以会先输出170再输出4 None</span></span><br></pre></td></tr></table></figure>
<p>类几乎可以调用所有内部定义的方法，但是调用<code>普通的方法</code>时会报错，原因是第一参数必须是类的实例。</p>
<p>实例也几乎可以调用所有的方法，<code>普通的函数</code>的调用一般不可能出现，因为不允许这么定义。</p>
<p>总结：</p>
<p>类除了普通方法都可以调用，普通方法需要对象的实例作为第一参数。</p>
<p>实例可以调用所有类中定义的方法（包括类方法、静态方法），普通方法传入实例自身，静态方法和类方法需要找到实例的类。</p>
<h3 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h3><h4 id="私有（Private）属性"><a href="#私有（Private）属性" class="headerlink" title="私有（Private）属性"></a>私有（Private）属性</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">growup</span><span class="params">(self, i=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt; <span class="number">150</span>:   <span class="comment"># 控制逻辑</span></span><br><span class="line">            self.age += i</span><br><span class="line">            </span><br><span class="line">p1 = Person(<span class="string">'tom'</span>)</span><br><span class="line">p1.growup(<span class="number">20</span>)   <span class="comment"># 正常的范围</span></span><br><span class="line">print(p1.age)</span><br><span class="line">p1.age = <span class="number">160</span>   <span class="comment"># 超过了范围，并绕过了控制逻辑</span></span><br><span class="line">print(p1.age)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">38</span></span><br><span class="line"><span class="number">160</span></span><br></pre></td></tr></table></figure>
<p>上例，本来是想通过方法控制属性，但是由于属性在外部可以访问，或者说可见，就可以直接绕过方法，直接修改这个属性。</p>
<p>Python提供了私有属性可以解决这个问题</p>
<p>私有属性</p>
<p>使用双下划线开头的属性名，就是私有属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">growup</span><span class="params">(self, i=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt; <span class="number">150</span>:   <span class="comment"># 控制逻辑</span></span><br><span class="line">            self.__age += i</span><br><span class="line">            </span><br><span class="line">p1 = Person(<span class="string">'tom'</span>)</span><br><span class="line">p1.growup(<span class="number">20</span>)   <span class="comment"># 正常的范围</span></span><br><span class="line">print(p1.__age)   <span class="comment"># 可以吗。不可以，会报错</span></span><br></pre></td></tr></table></figure>
<p>通过实验可以看出，外部已经访问不到<code>__age</code>了，<code>age</code>根本就没有定义，更是访问不到。那么，如何访问这个私有变量<code>__age</code>呢？</p>
<p>使用方法来访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">growup</span><span class="params">(self, i=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt; <span class="number">150</span>:   <span class="comment"># 控制逻辑</span></span><br><span class="line">            self.__age += i</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getage</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__age</span><br><span class="line">    </span><br><span class="line">print(Person(<span class="string">'tom'</span>).getage())</span><br><span class="line">输出：</span><br><span class="line"><span class="number">18</span></span><br></pre></td></tr></table></figure>
<h4 id="私有变量的本质"><a href="#私有变量的本质" class="headerlink" title="私有变量的本质"></a>私有变量的本质</h4><p>外部访问不到，能够动态增加一个<code>__age</code>呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">growup</span><span class="params">(self, i=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt; <span class="number">150</span>:   <span class="comment"># 控制逻辑</span></span><br><span class="line">            self.__age += i</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getage</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__age</span><br><span class="line">    </span><br><span class="line">p1 = Person(<span class="string">'tom'</span>)</span><br><span class="line">p1.growup(<span class="number">20</span>)   <span class="comment"># 正常的范围</span></span><br><span class="line"><span class="comment"># print(p1.__age)   # 访问不到</span></span><br><span class="line">p1.__age = <span class="number">28</span></span><br><span class="line">print(p1.__age)</span><br><span class="line">print(p1.getage())</span><br><span class="line"><span class="comment"># 为什么年龄不一样？__age没有覆盖吗？</span></span><br><span class="line">print(p1.__dict__)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">28</span></span><br><span class="line"><span class="number">38</span></span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'Tom'</span>, <span class="string">'_Person__age'</span>: <span class="number">38</span>, <span class="string">'__age'</span>: <span class="number">28</span>&#125;</span><br></pre></td></tr></table></figure>
<p>秘密都在<code>__dict__</code>中，里面是<code>{&#39;__age&#39;:28,&#39;_Person_age&#39;:38,&#39;name&#39;:&#39;tom&#39;}</code></p>
<p>私有变量的本质：</p>
<p>类定义的时候，如果声明一个实例变量的时候，使用双下划线，Python解释器会将其改名，转换名称为<code>_类名_变量名</code>的名称，所以用原来的名字访问不到了。</p>
<p>知道了这个名字，能否直接修改呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">growup</span><span class="params">(self, i=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt; <span class="number">150</span>:</span><br><span class="line">            self.__age += i</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getage</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__age</span><br><span class="line">    </span><br><span class="line">p1 = Person(<span class="string">'tom'</span>)</span><br><span class="line">p1.growup(<span class="number">20</span>)   <span class="comment"># 正常的范围</span></span><br><span class="line"><span class="comment"># print(p1.__age)</span></span><br><span class="line">p1.__age = <span class="number">28</span></span><br><span class="line">print(p1.__age)</span><br><span class="line">print(p1.getage())</span><br><span class="line"><span class="comment"># 为什么年龄不一样？__age没覆盖吗？</span></span><br><span class="line">print(p1.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接修改私有变量</span></span><br><span class="line">p1._Person__age = <span class="number">15</span></span><br><span class="line">print(p1.getage())</span><br><span class="line">print(p1.__dict__)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">15</span></span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'Tom'</span>, <span class="string">'_Person__age'</span>: <span class="number">15</span>, <span class="string">'__age'</span>: <span class="number">28</span>&#125;</span><br></pre></td></tr></table></figure>
<p>从上例可以看出，知道了私有变量的新名称，就可以直接从外部访问到，并可以修改它。</p>
<h4 id="保护变量"><a href="#保护变量" class="headerlink" title="保护变量"></a>保护变量</h4><p>在变量名前使用一个下划线，称为保护变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self._age = age</span><br><span class="line">        </span><br><span class="line">tom = Person(<span class="string">'Tom'</span>)</span><br><span class="line">print(tom._age)</span><br><span class="line">print(tom.__dict__)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">18</span></span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'Tom'</span>, <span class="string">'_age'</span>: <span class="number">18</span>&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，这个<code>_age</code>属性根本就没有改变名称，和普通的属性一样，解释器不做任何特殊处理。这只是开发者共同的约定，看见这种变量，就如同私有变量，不要直接使用。</p>
<h4 id="私有方法"><a href="#私有方法" class="headerlink" title="私有方法"></a>私有方法</h4><p>参照保护变量、私有变量，使用单下划线、双下划线命名方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self._age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_getname</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getage</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._age</span><br><span class="line">    </span><br><span class="line">tom = Person(<span class="string">'Tom'</span>)</span><br><span class="line">print(tom._getname())   <span class="comment"># _getname没改名</span></span><br><span class="line">print(tom.__getage())   <span class="comment"># 无此属性</span></span><br><span class="line">print(tom.__dict__)</span><br><span class="line">print(tom.__class__.__dict__)</span><br><span class="line">print(tom._Person__getage())   <span class="comment"># __getage改名了</span></span><br><span class="line">输出：</span><br><span class="line">Tom</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'Tom'</span>, <span class="string">'_age'</span>: <span class="number">18</span>&#125;</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function Person.__init__ at <span class="number">0x7fa7d0a34550</span>&gt;, <span class="string">'_getname'</span>: &lt;function Person._getname at <span class="number">0x7fa7d0a345e0</span>&gt;, <span class="string">'_Person__getage'</span>: &lt;function Person.__getage at <span class="number">0x7fa7d0a34670</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"><span class="number">18</span></span><br></pre></td></tr></table></figure>
<h4 id="私有方法的本质"><a href="#私有方法的本质" class="headerlink" title="私有方法的本质"></a>私有方法的本质</h4><p>单下划线的方法只是开发者之间的约定，解释器不做任何改变。</p>
<p>双下划线的方法，是私有方法，解释器会改名，改名策略和私有变量相同，<code>_类名__方法名</code>。方法变量都在类的<code>__dict__</code>中可以找到。</p>
<h4 id="私有成员的总结"><a href="#私有成员的总结" class="headerlink" title="私有成员的总结"></a>私有成员的总结</h4><p>在Python中使用<code>_</code>单下划线或者<code>__</code>双下划线来标识一个成员被保护或者被私有化隐藏起来。但是，不管使用什么样的访问控制，都不能真正的阻止用户修改类的成员。Python中没有绝对的安全的保护成员或者私有成员。</p>
<p>因此，前导的下划线只是一种警告或者提醒，请遵守这个约定。除非真有必要，不要修改或者使用保护成员或者私有成员，更不要修改它们。</p>
<h3 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h3><p>可以通过修改或者替换类的成员。使用者调用的方式没有改变，但是，类提供的功能可能已经改变了。</p>
<p>猴子补丁（Monkey Patch）：</p>
<p>在运行时，对属性、方法、函数等进行动态替换。</p>
<p>其目的往往是为了通过替换、修改来增强、扩展原有代码的能力。</p>
<p>黑魔法，慎用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test1.py</span></span><br><span class="line"><span class="keyword">from</span> test2 <span class="keyword">import</span> Person</span><br><span class="line"><span class="keyword">from</span> test3 <span class="keyword">import</span> get_score</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">monkeypatch4Person</span><span class="params">()</span>:</span></span><br><span class="line">    Person.get_score = get_score</span><br><span class="line"><span class="comment"># 用test3.py中的get_score替换test2.py中的同名方法    </span></span><br><span class="line">monkeypatch4Person()   <span class="comment"># 打补丁</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    print(Person().get_score())</span><br><span class="line">  </span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'Person'</span>, <span class="string">'English'</span>: <span class="number">88</span>, <span class="string">'Chinese'</span>: <span class="number">90</span>, <span class="string">'History'</span>: <span class="number">85</span>&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># test2.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_score</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># connect to mysql</span></span><br><span class="line">        ret = &#123;<span class="string">'English'</span>:<span class="number">78</span>, <span class="string">'Chinese'</span>:<span class="number">86</span>, <span class="string">'History'</span>:<span class="number">82</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    </span><br><span class="line"><span class="comment"># test3.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_score</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> dict(name=self.__class__.__name__,English=<span class="number">88</span>, Chinese=<span class="number">90</span>, History=<span class="number">85</span>)</span><br></pre></td></tr></table></figure>
<p>上例中，假设<code>Person</code>类<code>get_score</code>方法是从数据库拿数据，但是测试的时候，不方便。</p>
<p>使用猴子补丁，替换了<code>get_score</code>方法，返回模拟的数据。</p>
<h3 id="属性装饰器"><a href="#属性装饰器" class="headerlink" title="属性装饰器"></a>属性装饰器</h3><p>一般好的设计是：把实例的属性保护起来，不让外部直接访问，外部使用<code>getter</code>读取属性和<code>setter</code>方法设置属性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__age</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_age</span><span class="params">(self, age)</span>:</span></span><br><span class="line">        self.__age = age  <span class="comment"># 通过设置与初始化同名的属性覆盖初始化的属性</span></span><br><span class="line">        </span><br><span class="line">tom = Person(<span class="string">'Tom'</span>)</span><br><span class="line">print(tom.age())</span><br><span class="line">tom.set_age(<span class="number">20</span>)</span><br><span class="line">print(tom.age()) </span><br><span class="line">输出：</span><br><span class="line"><span class="number">18</span></span><br><span class="line"><span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>通过<code>age</code>和<code>set_age</code>方法操作属性。</p>
<p>有没有简单的方式呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__age</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @age.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self, age)</span>:</span></span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @age.deleter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># del self.__age</span></span><br><span class="line">        print(<span class="string">'del'</span>)</span><br><span class="line">        </span><br><span class="line">tom = Person(<span class="string">'Tom'</span>)</span><br><span class="line">print(tom.age)</span><br><span class="line">tom.age = <span class="number">20</span></span><br><span class="line">print(tom.age)</span><br><span class="line"><span class="keyword">del</span> tom.age   <span class="comment"># 使用del调用上面定义的@age.deleter下的方法</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">18</span></span><br><span class="line"><span class="number">20</span></span><br><span class="line"><span class="keyword">del</span></span><br></pre></td></tr></table></figure>
<p>特别注意：使用<code>property</code>装饰器的时候这三个方法同名，如上例中的age方法</p>
<p><code>property</code>装饰器</p>
<p>下面跟的函数名就是以后的属性名，属性名指的就是方法名称。它就是<code>getter</code>。这个必须有，有了它至少是只读属性</p>
<p><code>setter</code>装饰器</p>
<p>与属性名同名，且接收2个参数，第一个是<code>self</code>，第二个是将要赋值的值。有了它，属性可写</p>
<p><code>deleter</code>装饰器</p>
<p>可以控制是否删除属性。很少用。</p>
<p><code>property</code>装饰器必须在前，<code>setter</code>、<code>deleter</code>装饰器在后。</p>
<p><code>property</code>装饰器能通过简单的方式，把对方法的操作变成对属性的访问，并起到了一定隐藏效果</p>
<p>其它的写法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getage</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__age</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setage</span><span class="params">(self, age)</span>:</span></span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delage</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># del self.__age</span></span><br><span class="line">        print(<span class="string">'del'</span>)</span><br><span class="line">        </span><br><span class="line">    age = property(getage, setage, delage, <span class="string">'age property'</span>)</span><br><span class="line">    </span><br><span class="line">tom = Person(<span class="string">'Tom'</span>)</span><br><span class="line">print(tom.age)</span><br><span class="line">tom.age = <span class="number">20</span></span><br><span class="line">print(tom.age)</span><br><span class="line"><span class="keyword">del</span> tom.age</span><br><span class="line">输出：</span><br><span class="line"><span class="number">18</span></span><br><span class="line"><span class="number">20</span></span><br><span class="line"><span class="keyword">del</span></span><br></pre></td></tr></table></figure>
<p>还可以如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line">    age = property(<span class="keyword">lambda</span> self:self.__age)</span><br><span class="line">    </span><br><span class="line">tom = Person(<span class="string">'Tom'</span>)</span><br><span class="line">print(tom.age)</span><br></pre></td></tr></table></figure>
<h3 id="对象的销毁"><a href="#对象的销毁" class="headerlink" title="对象的销毁"></a>对象的销毁</h3><p>类中可以定义<code>__del__</code>方法，称为析构函数（方法）。</p>
<p>作用：销毁类的实例的时候调用，以释放占用的资源。其中就放些清理资源的代码，比如释放连接。</p>
<p>注意这个方法不能引起对象的真正销毁，只是对象销毁的时候会自动调用它。</p>
<p>使用<code>del</code>语句删除实例，引用计数减1。当引用计数为0时，会自动调用<code>__del__</code>方法。</p>
<p>由于Python实现了垃圾回收机制，不能确定对象何时执行垃圾回收。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.__age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'delete &#123;&#125;'</span>.format(self.name))</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    tom = Person(<span class="string">'tom'</span>)</span><br><span class="line">    tom.__del__()</span><br><span class="line">    tom.__del__()</span><br><span class="line">    tom.__del__()</span><br><span class="line">    tom.__del__()</span><br><span class="line">    print(<span class="string">'=========start========='</span>)</span><br><span class="line">    tom2 = tom</span><br><span class="line">    tom3 = tom2</span><br><span class="line">    print(<span class="number">1</span>, <span class="string">'del'</span>)</span><br><span class="line">    <span class="keyword">del</span> tom</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    </span><br><span class="line">    print(<span class="number">2</span>, <span class="string">'del'</span>)</span><br><span class="line">    <span class="keyword">del</span> tom2</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">'~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">del</span> tom3   <span class="comment"># 注释一下看看效果</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">'================end'</span>)</span><br><span class="line">    </span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>由于垃圾回收对象销毁时，才会真正清理对象，还会在之前自动调用<code>__del__</code>方法，除非你明确知道自己的目的，建议不要手动调用这个方法。</p>
<h3 id="方法重载（overload）"><a href="#方法重载（overload）" class="headerlink" title="方法重载（overload）"></a>方法重载（overload）</h3><p>在其他面向对象的高级语言中，都有重载的概念。</p>
<p>所谓重载，就是同一个方法名，但是参数数量、类型不一样，就是同一个方法的重载。</p>
<p>Python没有重载！</p>
<p>Python不需要重载！</p>
<p>Python中，方法（函数）定义中，形参非常灵活，不需要指定类型（就算指定了也只是一个说明而非约束），参数个数也不固定（可变参数）。一个函数的定义可以实现很多种不同形式实参的调用。所以Python不需要方法重载。</p>
<p>或者说Python本身就实现了其它语言的重载。</p>
<h3 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h3><p>面向对象的三要素之一，封装Encapsulation</p>
<p>封装</p>
<p>将数据和操作组织到类中，即属性和方法</p>
<p>将数据隐藏起来，给使用者提供操作（方法）。使用者通过操作就可以获取或者修改数据。</p>
<p><code>getter</code>和<code>setter</code>。</p>
<p>通过访问控制，暴露适当的数据和操作给用户，该隐藏的隐藏起来，例如保护成员或私有成员。</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><ol>
<li>随机整数生成类</li>
</ol>
<p>可以指定一批生成的个数，可以指定数值的范围，可以调整每批生成数字的个数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 常规实现如下</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 普通类实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomGen</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    1. 解决随机数边界问题</span></span><br><span class="line"><span class="string">    2. 随机数生成</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start=<span class="number">1</span>, stop=<span class="number">100</span>, count=<span class="number">10</span>)</span>:</span></span><br><span class="line">        self.start = start</span><br><span class="line">        self.stop = stop</span><br><span class="line">        self.count = count</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(self, start=<span class="number">1</span>, stop=<span class="number">100</span>, count=<span class="number">10</span>)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> [random.randint(start, stop) <span class="keyword">for</span> x <span class="keyword">in</span> range(count)]</span><br><span class="line"><span class="comment"># 在__init__与generate中定义的start，stop，count三个属性是没有关系的，可以不在__init__中定义这三个属性</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 2 作为工具类来实现，提供类方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomGen</span>:</span> </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(cls, start=<span class="number">1</span>, stop=<span class="number">100</span>, count=<span class="number">10</span>)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> [random.randint(start, stop) <span class="keyword">for</span> x <span class="keyword">in</span> range(count)]</span><br><span class="line"><span class="comment"># 传参有两种方式，一种是初始化的时候，另一种是随机生成函数的时候。这种类方法就是随机生成时传参，因为用不着初始</span></span><br><span class="line"><span class="comment"># 化了，所以去掉了__init__，因为用不着保留参数，所以用不着对象的了，就可以直接使用类方法。上面的类因为需要初</span></span><br><span class="line"><span class="comment"># 始化，所以参数会被记在实例属性中。如果写成静态方法，还可以取消cls。</span></span><br></pre></td></tr></table></figure>
<p>随机整数生成类，可以指定一批生成的个数，可以指定数值的范围，可以调整每批生成数字的个数。</p>
<p>使用生成器实现，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 笔记</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomGenerator</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, count=<span class="number">10</span>, start=<span class="number">1</span>, stop=<span class="number">100</span>)</span>:</span></span><br><span class="line">        self.count = count</span><br><span class="line">        self.start = start</span><br><span class="line">        self.stop = stop</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.count):</span><br><span class="line">            <span class="keyword">yield</span> random.randint(self.start, self.stop)</span><br><span class="line">            </span><br><span class="line">rg = RandomGenerator()</span><br><span class="line">gen = rg.generate()   <span class="comment"># 因为rg.generate()是生成器，所以要给一个变量</span></span><br><span class="line">print(next(gen))   <span class="comment"># 这样只能打印一个随机数</span></span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> enumerate(gen):  <span class="comment"># 打印所有的随机数，可以用这个方法</span></span><br><span class="line">    print(i,v)</span><br><span class="line">====================================================================================</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomGenerator</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, count=<span class="number">10</span>, start=<span class="number">1</span>, stop=<span class="number">100</span>)</span>:</span></span><br><span class="line">        self.count = count</span><br><span class="line">        self.start = start</span><br><span class="line">        self.stop = stop</span><br><span class="line">        self._gen = self._generate()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_generate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">yield</span> random.randint(self.start, self.stop)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> [next(self._gen) <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.count)]</span><br><span class="line"></span><br><span class="line">rg = RandomGenerator(<span class="number">20</span>,<span class="number">1</span>,<span class="number">1000</span>)</span><br><span class="line">print(rg.generate())</span><br><span class="line">====================================================================================</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomGenerator</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, count=<span class="number">10</span>, start=<span class="number">1</span>, stop=<span class="number">100</span>)</span>:</span></span><br><span class="line">        self.count = count</span><br><span class="line">        self.start = start</span><br><span class="line">        self.stop = stop</span><br><span class="line">        self._gen = self._generate()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_generate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">yield</span> [random.randint(self.start, self.stop) <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.count)]</span><br><span class="line"><span class="comment"># 这一行会一次性生成一批数据，数据的数量根据self.count的数量决定的，self.count是通过下面的generate中的</span></span><br><span class="line"><span class="comment"># count传入的。实际就是看实例的dict中保存的count是什么，如果generate中没有定义count，那么实例的dict中</span></span><br><span class="line"><span class="comment"># 保存的就是初始化的count，如果generate中定义了count，就会覆盖初始化的count。</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(self,count)</span>:</span></span><br><span class="line">        self.count = count   </span><br><span class="line"><span class="comment"># 因为要向_generate方法中传入count的数据，使用这个count控制打印的个数。如果这里不写count参数，那么就要由</span></span><br><span class="line"><span class="comment"># 初始化处决定count的数量。初始化的地方如果设置了count的值，也可以控制打印的数量，只是不太合逻辑。这里这样</span></span><br><span class="line"><span class="comment"># 写是在改变实例的属性，所以当上面的生成器再执行到self.count时，就会被改变了</span></span><br><span class="line">        <span class="keyword">return</span> next(self._gen)  <span class="comment"># 这一步的next()是找生成器对象要数据，生成器对象self._gen会去找生成器_generate()，这时就会把这里的self.count传入到生成器中</span></span><br><span class="line"></span><br><span class="line">rg = RandomGenerator()</span><br><span class="line">print(rg.generate(<span class="number">5</span>))</span><br><span class="line">====================================================================================</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用生成器实现 1</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomGenerator</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start=<span class="number">1</span>, stop=<span class="number">100</span>, patch=<span class="number">10</span>)</span>:</span></span><br><span class="line">        self.start = start</span><br><span class="line">        self.stop = stop</span><br><span class="line">        self.patch = patch</span><br><span class="line">        self._gen = self._generate()  </span><br><span class="line"><span class="comment"># 在这里定义是因为这个生成器对象只需要创建一次。_generate()在创建的时候如果不存在，会到类上找这个方法。而</span></span><br><span class="line"><span class="comment"># 且这句放在最后是最安全的，因为要先把参数都赋值才能执行_generate方法，按顺序执行，最后把这句放在最后。在生</span></span><br><span class="line"><span class="comment"># 成实例时，调用_generate方法时会返回一个生成器对象，并把结果给self._gen，只是还没有用。之后用</span></span><br><span class="line"><span class="comment"># generate()方法就可以操作这个生成器对象了</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_generate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">yield</span> random.randint(self.start, self.stop)</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(self, count=<span class="number">0</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> count &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> [next(self._gen) <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.patch)]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> [next(self._gen) <span class="keyword">for</span> _ <span class="keyword">in</span> range(count)]</span><br><span class="line">        </span><br><span class="line">a = RandomGenerator()</span><br><span class="line">print(a.generate())</span><br><span class="line">print(a.generate(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成器另一种实现</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomGenerator</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start=<span class="number">1</span>, stop=<span class="number">100</span>, patch=<span class="number">10</span>)</span>:</span></span><br><span class="line">        self.start = start</span><br><span class="line">        self.stop = stop</span><br><span class="line">        self.patch = patch</span><br><span class="line">        self._gen = self._generate()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_generate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">yield</span> [random.randint(self.start, self.stop) <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.patch)]</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(self, count=<span class="number">0</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">            self.patch = count</span><br><span class="line">        <span class="keyword">return</span> next(self._gen)</span><br><span class="line">    </span><br><span class="line">a = RandomGenerator()</span><br><span class="line">print(a.generate())</span><br><span class="line">print(a.generate(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用property</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomGenerator</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start=<span class="number">1</span>, stop=<span class="number">100</span>, patch=<span class="number">10</span>)</span>:</span></span><br><span class="line">        self.start = start</span><br><span class="line">        self.stop = stop</span><br><span class="line">        self.patch = patch</span><br><span class="line">        self._gen = self._generate()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_generate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">yield</span> [random.randint(self.start, self.stop) <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.patch)]</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> next(self._gen)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#    @property</span></span><br><span class="line"><span class="comment">#    def patch(self):  </span></span><br><span class="line"><span class="comment"># 这里定义的方法名称与初始化的名称一样，是为了覆盖初始化的数据。因为这里的调用就是self.patch，和初始化中的</span></span><br><span class="line"><span class="comment"># 一样。方法的返回值self._patch才是实例dict中保存的内容，实例dict中不会保存patch。这里就是利用相同的调用</span></span><br><span class="line"><span class="comment"># 方法，用return的属性覆盖了原来的属性，_patch是自定义的，可以是任何值。也可以写成</span></span><br><span class="line"><span class="comment"># def abc(self): return self.patch，这样也可以改变初始化的patch值，也就是return的属性与初始化的属性</span></span><br><span class="line"><span class="comment"># 是一样的也可以。</span></span><br><span class="line"><span class="comment">#        return self._patch</span></span><br><span class="line">    <span class="comment"># 返回值中必须用_patch，或者说不能和这个方法本身的名字重复，不然就会变成递归调用，无法执行。</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#    @patch.setter</span></span><br><span class="line"><span class="comment">#    def patch(self, value):</span></span><br><span class="line"><span class="comment">#        self._patch = value</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># 按照课上讲授的方法，还是应该写成下面这样。方法名称是自定义的，而返回的属性是上面定义过的，修改的也是上面定义过的属性</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_patch</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.patch</span><br><span class="line"></span><br><span class="line"><span class="meta">    @_patch.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_patch</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self.patch = value</span><br><span class="line">        </span><br><span class="line">a = RandomGenerator()</span><br><span class="line">print(a.generate())</span><br><span class="line">a.patch = <span class="number">5</span></span><br><span class="line">print(a.generate())</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>打印坐标</li>
</ol>
<p>使用上题中的类，随机生成20个数字，两两配对形成二维坐标系的坐标，把这些坐标组织起来，并打印输出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 笔记</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomGen</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randmGen</span><span class="params">(cls,start=<span class="number">1</span>,stop=<span class="number">100</span>,count=<span class="number">20</span>)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">return</span> [random.randint(start,stop) <span class="keyword">for</span> _ <span class="keyword">in</span> range(count)]</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&#123;&#125;:&#123;&#125;'</span>.format(self.x, self.y)</span><br><span class="line"><span class="comment"># 在使用强制类型转换时就会用到__str__()，如果想打印，python内部机制是用__repr__</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span>  <span class="comment"># __repr__是将数据表现成什么样子，不然下面的print方法打印的是地址，而不是数据</span></span><br><span class="line">        retrun <span class="string">'&#123;&#125;:&#123;&#125;'</span>.format(self.x, self.y)</span><br><span class="line"><span class="comment"># 因为下面是将列表解析式给了lst1，然后在打印时print会迭代列表中的内容打印出来，但Point是自定义的类，print不知道怎么打印，所以会打印地址。所以要用这个__repr__方法说明打印的格式</span></span><br><span class="line"></span><br><span class="line">lst1 = [Point(x,y) <span class="keyword">for</span> x,y <span class="keyword">in</span> zip(RandomGen.randmGen(<span class="number">10</span>),RandomGen.randmGen(<span class="number">10</span>))]</span><br><span class="line">print(lst1)  <span class="comment"># 使用这种方法打印时，上面的Point类就需要加入__str__或__repr__方法，不然会打印成：</span></span><br><span class="line"><span class="comment"># [&lt;__main__.Point object at 0x7f27abfbfa90&gt;, &lt;__main__.Point object at 0x7f27abfbfb38&gt;, &lt;__main__.Point object at 0x7f27abfc27f0&gt;, &lt;__main__.Point object at 0x7f27abfc27b8&gt;, ...]</span></span><br><span class="line"><span class="comment"># points = [Point(*v) for v in zip(RandomGenerator(10).generate(),RandomGenerator(10).generate())] 这样也可以</span></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> lst1:  <span class="comment">#也可以这样打印，因为lst1是Point的对象，所以有两个值</span></span><br><span class="line">    print(p.x, p.y)  <span class="comment"># 如果没有使用__str__或__repr__时，可以使用这种方法打印</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">11</span> <span class="number">93</span></span><br><span class="line"><span class="number">17</span> <span class="number">82</span></span><br><span class="line"><span class="number">43</span> <span class="number">98</span></span><br><span class="line"><span class="number">80</span> <span class="number">25</span></span><br><span class="line"><span class="meta">... </span>...</span><br><span class="line">====================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">points = [Point(x,y) <span class="keyword">for</span> x,y <span class="keyword">in</span> zip(RandomGenerator(<span class="number">10</span>).generate(),RandomGenerator(<span class="number">10</span>).generate())]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> points:</span><br><span class="line">    print(<span class="string">'&#123;&#125;:&#123;&#125;'</span>.format(p.x, p.y))</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>车辆信息</li>
</ol>
<p>记录车的品牌mark、颜色color、价格price、速度speed等特征，并实现增加车辆信息、显示全部车辆信息的功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 笔记</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, mark, speed, color, price)</span>:</span></span><br><span class="line">        self.mark = mark</span><br><span class="line">        self.speed = speed</span><br><span class="line">        self.color = color</span><br><span class="line">        self.price = price</span><br><span class="line">    <span class="comment"># 如果要修改车辆信息，最后在Car中定义方法，因为数据在哪方法就在哪  </span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;'</span>.format(self.mark,self.speed,self.color,self.price)</span><br><span class="line"><span class="comment"># 这里如果加入这两行，下面打印的内容就不再是内存地址了。四个值会被当作一个整体加入到下面的列表中</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CarInfo</span>:</span></span><br><span class="line">   <span class="comment"># lst = []   # 把信息的组合放在列表中</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.lst = []   <span class="comment"># 因为是实例的，所以要加self。在实例化后才有这个列表</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addcar</span><span class="params">(self, car:Car)</span>:</span></span><br><span class="line">        self.lst.append(car)  <span class="comment"># 把car的属性信息放到列表中</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getall</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="comment"># 数据在哪方法就在哪，因为方法是用来操作数据的。所以这里要遍历信息，要把放法加在信息上。</span></span><br><span class="line">		<span class="keyword">return</span> self.lst  <span class="comment"># 打印格式用format</span></span><br><span class="line"><span class="comment">#		return '&#123;&#125;/&#123;&#125;/&#123;&#125;/&#123;&#125;'.format(car.mark,car.price,car.color,car.speed)</span></span><br><span class="line"><span class="comment"># 改成这样就可以看到上面添加的内容了，但这与lst列表已经没关系了，所以还是应该在加入列表前就把格式处理好</span></span><br><span class="line"></span><br><span class="line">ci = CarInfo()</span><br><span class="line">car = Car(<span class="string">'audi'</span>, <span class="number">400</span>, <span class="string">'red'</span>, <span class="number">100</span>)   <span class="comment"># 颜色最好定义成数字，不然输入会混乱</span></span><br><span class="line">ci.addcar(car)</span><br><span class="line">ci.getall()</span><br><span class="line">====================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span>:</span>   <span class="comment"># 记录单一车辆</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, mark, speed, color, price)</span>:</span></span><br><span class="line">        self.mark = mark</span><br><span class="line">        self.speed = speed</span><br><span class="line">        self.color = color</span><br><span class="line">        self.price = price</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CarInfo</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.info = []</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addcar</span><span class="params">(self, car:Car)</span>:</span></span><br><span class="line">        self.info.append(car)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getall</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.info</span><br><span class="line">    </span><br><span class="line">ci = CarInfo()</span><br><span class="line">car = Car(<span class="string">'audi'</span>, <span class="number">400</span>, <span class="string">'red'</span>, <span class="number">100</span>)</span><br><span class="line">ci.addcar(car)</span><br><span class="line"></span><br><span class="line">ci.getall()   <span class="comment"># 返回所有数据，此时再实现格式打印</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>实现温度的处理</li>
</ol>
<p><img src="/images/python面向对象/实现温度处理.png" alt=""></p>
<p>思路</p>
<p>假定一般情况下，使用摄氏度为单位，传入温度值。</p>
<p>如果不给定摄氏度，一定会把温度值转换到摄氏度。</p>
<p>温度转换方法可以使用实例的方法，也可以使用类方法，使用类方法的原因是，为了不创建对象，就可以直接进行温度转换计算，这个类设计像个温度工具类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 笔记</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Temperature</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, t, unit=<span class="string">'c'</span>)</span>:</span></span><br><span class="line">        self._c = <span class="keyword">None</span></span><br><span class="line">        self._f = <span class="keyword">None</span></span><br><span class="line">        self._k = <span class="keyword">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> unit == <span class="string">'k'</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">elif</span> unit == <span class="string">'f'</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._c = t</span><br><span class="line">            </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">c</span><span class="params">(self)</span>:</span>    <span class="comment"># 摄氏度</span></span><br><span class="line">        <span class="keyword">return</span> self._c</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">k</span><span class="params">(self)</span>:</span>   <span class="comment"># 开氏温度</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(self)</span>:</span>   <span class="comment"># 华氏温度</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 温度转换</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">c2f</span><span class="params">(cls, c)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">9</span>*c/<span class="number">5</span> + <span class="number">32</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">f2c</span><span class="params">(cls, f)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span>*(f<span class="number">-32</span>)/<span class="number">9</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">c2k</span><span class="params">(cls, c)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> c + <span class="number">273.15</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">k2c</span><span class="params">(cls, k)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> k - <span class="number">273.15</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">f2k</span><span class="params">(cls, f)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.c2k(cls.f2c(f))</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">k2f</span><span class="params">(cls, k)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.c2f(cls.k2c(k))</span><br></pre></td></tr></table></figure>
<p>进一步完善未完成代码，如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Temperature</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, t, unit=<span class="string">'c'</span>)</span>:</span></span><br><span class="line">        self._c = <span class="keyword">None</span></span><br><span class="line">        self._f = <span class="keyword">None</span></span><br><span class="line">        self._k = <span class="keyword">None</span></span><br><span class="line">   </span><br><span class="line">        <span class="keyword">if</span> unit == <span class="string">'k'</span>:</span><br><span class="line">            self._k = t</span><br><span class="line">            self._c = self.k2c(t)</span><br><span class="line">        <span class="keyword">elif</span> unit == <span class="string">'f'</span>:</span><br><span class="line">            self._f = t</span><br><span class="line">            self._c = self.f2c(t)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._c = t</span><br><span class="line"> <span class="comment">#     开始只有报错温度，其他两个是空的           </span></span><br><span class="line"><span class="meta">    @property      # 因为只为了转换，所以只提供只读属性，不提供写的</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">c</span><span class="params">(self)</span>:</span>    <span class="comment"># 摄氏度</span></span><br><span class="line">        <span class="keyword">return</span> self._c</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">k</span><span class="params">(self)</span>:</span>   <span class="comment"># 开氏温度。这里要开氏温度，初始化一定能保证摄氏温度是有的，所以这里把摄氏温度转成开氏温度就可以了。开氏温度计算好了就不用再计算了</span></span><br><span class="line">        <span class="keyword">if</span> self._k <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self._k = self.c2k(self._c)</span><br><span class="line">        <span class="keyword">return</span> self._k</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(self)</span>:</span>   <span class="comment"># 华氏温度，这里一样要计算华氏温度，这是为了节约计算资源</span></span><br><span class="line">        <span class="keyword">if</span> self._f <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self._f = self.c2f(self._c)</span><br><span class="line">        <span class="keyword">return</span> self._f</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 温度转换</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">c2f</span><span class="params">(cls, c)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">9</span>*c/<span class="number">5</span> + <span class="number">32</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">f2c</span><span class="params">(cls, f)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span>*(f<span class="number">-32</span>)/<span class="number">9</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">c2k</span><span class="params">(cls, c)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> c + <span class="number">273.15</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">k2c</span><span class="params">(cls, k)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> k - <span class="number">273.15</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">f2k</span><span class="params">(cls, f)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.c2k(cls.f2c(f))</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">k2f</span><span class="params">(cls, k)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.c2f(cls.k2c(k))</span><br><span class="line">    </span><br><span class="line">print(Temperature.c2f(<span class="number">40</span>))</span><br><span class="line">print(Temperature.c2k(<span class="number">40</span>))</span><br><span class="line">print(Temperature.f2c(<span class="number">104.0</span>))</span><br><span class="line">print(Temperature.k2c(<span class="number">313.15</span>))</span><br><span class="line">print(Temperature.k2f(<span class="number">313.15</span>))</span><br><span class="line">print(Temperature.f2k(<span class="number">104</span>))</span><br><span class="line"><span class="comment"># 上面这些print都是工具，下面两个是当属性装饰器来用，设计应该是这样的。</span></span><br><span class="line">t = Temperature(<span class="number">37</span>)</span><br><span class="line">print(t.c, t.k, t.f)</span><br><span class="line"></span><br><span class="line">t = Temperature(<span class="number">300</span>, <span class="string">'k'</span>)</span><br><span class="line">print(t.c, t.k, t.f)</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>模拟购物车购物</li>
</ol>
<p>思路</p>
<p>购物车购物，分解得到两个对象<code>购物车</code>、<code>物品</code>，一个操作<code>购买</code>。</p>
<p>购买不是购物车的行为，其实是人的行为，但是对于购物车来说就是<code>增加add</code>。</p>
<p>商品有很多种类，商品的属性多种多样，怎么解决？</p>
<p>购物车可以加入很多不同的商品，如何实现？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拿到需求先区分出对象有哪些，这是一个抽象类的过程。之后分析类之间是如何作用的，每个类自身有什么特点。如果是工</span></span><br><span class="line"><span class="comment"># 具，就可以写成类方法或静态方法，与实例无关。如果要为用户保存一些数据进来，并且实例可能发生变化，这时就要做成</span></span><br><span class="line"><span class="comment"># 实例属性</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Color</span>:</span></span><br><span class="line">    RED = <span class="number">0</span>   <span class="comment"># 计算机喜欢用数字，所以这里这样定义，用衣使用时就用x.RED就可以了</span></span><br><span class="line">    BLUE = <span class="number">1</span></span><br><span class="line">    GREEN = <span class="number">2</span></span><br><span class="line">    GOLDEN = <span class="number">3</span></span><br><span class="line">    BLACK = <span class="number">4</span></span><br><span class="line">    OTHER = <span class="number">1000</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>:</span>  <span class="comment"># Item在电商中指商品</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **kwargs)</span>:</span>   <span class="comment"># 商品名和价格应该给位置参数，这两个是必须的，所以要写成位置参数</span></span><br><span class="line">        self.__spec = kwargs</span><br><span class="line"><span class="comment"># 实例属性不确定，不知道传入的dict中是否有其他的，所以定义一个__spec把传进来的属性保存起来。实例中一些配置信息就和商品信息混起来了，所以这时就提出一个_spec变量</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(sorted(self.__spec.items()))</span><br><span class="line"><span class="comment"># 这是在商品中就要把添加的值改成可以看明白的形式，如果不要这个__repr__方法，那么下面添加后，打印出的列表就会</span></span><br><span class="line"><span class="comment"># 是：[&lt;__main__.Item object at 0x7fc54d4627f0&gt;, &lt;__main__.Item object at 0x7fc54d462828&gt;]</span></span><br><span class="line"><span class="comment"># 这里需要使用sorted()方法，不然结果会变成</span></span><br><span class="line"><span class="comment"># [dict_items([('mark', 'audi'), ('speed', 400), ('color', 'red'), ('price', 100)])]这样，</span></span><br><span class="line"><span class="comment"># 多了一个dict_items()</span></span><br><span class="line"><span class="comment"># 测试发现__repr__和__str__方法的return都要是str类型，不然调用时会报错。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cart</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>   <span class="comment"># 容器最好也实例化</span></span><br><span class="line">        self.items = []</span><br><span class="line"><span class="comment"># 购物车就是一个容器，如何把容器弄的像一个字典一样，一个办法是从字典继承。另一个是如何把items暴露出去给别人用</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">additem</span><span class="params">(self, item:Item)</span>:</span>  <span class="comment"># 这里加商品</span></span><br><span class="line">        self.items.append(item)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getallitems</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.items</span><br><span class="line">    </span><br><span class="line">mycart = Cart()</span><br><span class="line">myphone = Item(mark=<span class="string">'Huawei'</span>, color=Color.GOLDEN, memory=<span class="string">'4G'</span>)</span><br><span class="line">mycart.additem(myphone)</span><br><span class="line"></span><br><span class="line">mycar = Item(mark=<span class="string">'Red Flag'</span>, color=Color.BLACK, year=<span class="number">2017</span>)</span><br><span class="line">mycart.additem(mycar)</span><br><span class="line"></span><br><span class="line">print(mycart.getallitems())</span><br></pre></td></tr></table></figure>
<p>注意，以上代码只是一个非常简单的一个实现，生产环境实现购物车的增删改查，要考虑很多。</p>
<h3 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h3><p>一切皆对象，如果都是对象，拿到的都是内存地址，都是引用，创建多个abc，内存中只会有一个abc，其他都是引用。创建列表时都会再次创建新列表，不要把列表放在函数中，函数多次调用会创建多个列表，如果只想要一份的话，就把列表放到函数外面</p>
<p>抽象是数据与动作的集合，对计算机来说数据称为属性，动作称为方法，有些地方把方法也叫函数。对象是抽象出来为实体服务的，如果拿出来对应就只能对应群体中的一个个体，这个个体就具有你所说的属性和方法，但属性可能是空白，因为虽然具体化了，但还没有把数据传给它。属性就是状态，状态就是数据，它是对象状态的抽象，因为属性最后放在类里面，而类是个抽象概念，所以属性也是个抽象概念。保存属性用数据结构。操作是个动作，这就是方法，实际上就是函数</p>
<p>写类时先想清楚有几个对象，然后把最核心的动作和数据抽象出来就行了。类定义完成后，这个类对象就产生了，类本身也是对象，这里区分一下类对象和类的对象，类对象指这是一个类，这个类本身也是个对象；类的对象指的是类的实例，实体。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="string">"""A example class"""</span>   <span class="comment"># 文档字符串</span></span><br><span class="line">    x = <span class="string">'abc'</span>  <span class="comment"># 类属性，不是对象的属性，对象的属性指的是类的实例的属性</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span>  </span><br><span class="line">		<span class="keyword">return</span> <span class="string">"MyClass foo"</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">print(MyClass.x)</span><br><span class="line">print(MyClass.foo)</span><br><span class="line">print(MyClass.__doc__)</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="string">"""this is a class"""</span></span><br><span class="line">    x = <span class="number">123</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(id(self))</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">	    <span class="comment"># print(self.x)  </span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># 类属性foo，也是方法。foo是个标识符，在定义一个函数后，这个函数标识符会对应到一个创建出来的函数对象上，也</span></span><br><span class="line"><span class="comment"># 就是foo这个标识符会对应到一个函数对象上。foo这个标识符是属于MyClass类的属性，只是这个属性是个标识符，并</span></span><br><span class="line"><span class="comment"># 对应到了一个函数对象上，这个函数对象在类中叫方法。也就是这个标识符对应到一个方法上去了，并且它也是属性。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># self是参数，下面print(MyClass.foo)中没有调用参数，没有传实参，所以可以打印出来。</span></span><br><span class="line"><span class="comment"># print(MyClass.foo)打印的是函数对象或叫方法对象，并没有调用它，如果要调用时foo()括号中就不能是类类型，也就是不能是self本身，调用时参数要用类的实例，如果写成print(MyClass.foo())就是错的了，但去掉print(self.x)中的.x，在pycham中可以执行，如果使用print(MyClass.foo(1))，那么1就会被传入到类中，并调用1.x，因为1没有x属性，所以会报错。print(MyClass.foo)就是调用类类型</span></span><br><span class="line">        </span><br><span class="line">print(MyClass)</span><br><span class="line">print(MyClass.__name__)</span><br><span class="line">print(MyClass.x)   <span class="comment"># 通过类的名称找到自己的属性，x是MyClass的属性。.点表示找下面成员的</span></span><br><span class="line">print(MyClass.foo)   <span class="comment"># 这并不是调用foo，而是找MyClass这个类中的标识符foo，这个标识符对应一个方法，这个</span></span><br><span class="line"><span class="comment"># 方法是个函数，这个函数本身也是对象，所以对象一定有内存地址，下面显示的就是对象和内存地址。x也是对象，只是</span></span><br><span class="line"><span class="comment"># 它是一个常量123，常量是固定放在一个位置的，只是对高级语言来说，如数字、字符串等，能显示就显示内容，不会显</span></span><br><span class="line"><span class="comment"># 示内存地址。如果要查看常量的内存地址，用id()查看。可以在类中找到foo，说明这个标识是属于类的，这个标识符指</span></span><br><span class="line"><span class="comment"># 向的方法也就属于这个类。定义完的类，本身就是个对象，这就是类对象。类也是个实体，它是类类型的对象，也就是类</span></span><br><span class="line"><span class="comment"># 的类型就是类类型。因为标识符指向了一个方法，这个方法在内存中已经生成了，所以我们可以看到内存地址</span></span><br><span class="line">print(MyClass.__doc__)  </span><br><span class="line">print(type(MyClass))   <span class="comment"># 类的类型是类类型，也就是type类型。MyClass是type的实例</span></span><br><span class="line">输出：</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">MyClass</span>'&gt;   </span></span><br><span class="line"><span class="class"># <span class="title">__main__</span>表示模块，这个类就是在这个<span class="title">__main__</span>模块中运行的。也就是当前<span class="title">Python</span>环境中运行</span></span><br><span class="line"><span class="class"><span class="title">MyClass</span>   # 打印<span class="title">MyClass</span>类的名字</span></span><br><span class="line"><span class="class">123</span></span><br><span class="line"><span class="class">&lt;<span class="title">function</span> <span class="title">MyClass</span>.<span class="title">foo</span> <span class="title">at</span> 0<span class="title">x7f8e81eec550</span>&gt;  # <span class="title">print</span><span class="params">(MyClass.foo)</span>输出结果</span></span><br><span class="line"><span class="class"><span class="title">this</span> <span class="title">is</span> <span class="title">a</span> <span class="title">class</span>   # 打印类中的文档</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">type</span>'&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">x</span>是<span class="title">MyClass</span>的变量，<span class="title">foo</span>也可以是<span class="title">MyClass</span>的变量，类的变量和类的属性指的是一个意思，所以<span class="title">x</span>和<span class="title">foo</span>也是<span class="title">MyClass</span>的属性，变量才能绑定到方法上。实际都是属于类的标识符，如果不属于类，就不能用类来调用它们、访问它们</span></span><br><span class="line"><span class="class">类里面的函数方法不能叫<span class="title">function</span>，在<span class="title">Python</span>中叫<span class="title">method</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">print</span><span class="params">(<span class="string">'下面就是实例的东西了'</span>)</span></span></span><br><span class="line">a = MyClass()   </span><br><span class="line"><span class="comment"># 实例化，初始化。实例化表示从人类变成了人，初始化表示给人数据，如名字等，为对象赋一些基本特征，也就是赋初值</span></span><br><span class="line"><span class="comment"># 的过程。实例化后就可以拿到一个具体的对象或实例了，之后就可以把这个实例赋给一个标识符或变量了，这个变量（在</span></span><br><span class="line"><span class="comment"># 这里就是a）对应着内存中的一个地址，那个地址放了实例化后的对象</span></span><br><span class="line">print(a.foo())</span><br><span class="line">print(a.x)   <span class="comment"># 实例也可以拿类属性 </span></span><br><span class="line">print(a.foo)</span><br><span class="line">print(<span class="string">'=============='</span>)</span><br><span class="line">print(id(a))</span><br><span class="line">输出：</span><br><span class="line">下面就是实例的东西了</span><br><span class="line"><span class="number">139819469043120</span></span><br><span class="line"><span class="number">123</span>   <span class="comment"># 这是print(self.x)打印出来的</span></span><br><span class="line">&lt;__main__.MyClass object at <span class="number">0x7fd39a48c5b0</span>&gt;  <span class="comment"># a.foo()输出内容</span></span><br><span class="line"><span class="number">123</span></span><br><span class="line">&lt;bound method MyClass.foo of &lt;__main__.MyClass object at <span class="number">0x7fd39a48c5b0</span>&gt;&gt;   </span><br><span class="line"><span class="comment"># print(a.foo)输出结果，这里显示的是MyClass，这是MyClass对象地址，MyClass的对象就是a，这个是a的地址。</span></span><br><span class="line"><span class="comment"># 上面print(MyClass.foo)打印的是函数对象地址。这里MyClass.foo的地址并没有打印。这里的bound表示把foo()</span></span><br><span class="line"><span class="comment"># 这个方法绑定给了a这个实例了。原来的标识符定义在类上，现在有个具体的对象出来了，就把这个方法绑定给这个对</span></span><br><span class="line"><span class="comment"># 象，这样foo()方法第一个默认的self参数就不用写了，a.foo()就相当于把a当参数传给了MyClass中foo(self)的</span></span><br><span class="line"><span class="comment"># self</span></span><br><span class="line">==============</span><br><span class="line"><span class="number">139819469043120</span></span><br><span class="line"></span><br><span class="line">***</span><br><span class="line">方法是属于类的属性，但是类的实例是对象，对象可以调用这个方法。常用的方法如下</span><br><span class="line">print(MyClass.x)</span><br><span class="line">a = MyClass()</span><br><span class="line">print(a.foo())</span><br><span class="line">print(a.x)  </span><br><span class="line">***</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="string">"""this is a class"""</span></span><br><span class="line">    x = <span class="number">123</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>   <span class="comment"># 初始化</span></span><br><span class="line">        <span class="comment"># pass   # 默认是空语句，什么都不做。下面就是不使用</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"foo = &#123;&#125;"</span>.format(self.x)</span><br><span class="line">    </span><br><span class="line">a = MyClass()   </span><br><span class="line"><span class="comment"># 实例化，初始化。这是先用new方法构建出一个实例，这个实例是裸着的，这就需要初始化</span></span><br><span class="line">print(a.foo())</span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">foo = <span class="number">123</span></span><br><span class="line">=====================================================</span><br><span class="line">__init__(self)方法指的就是构造器或构造方法或初始化方法，初始化的发生时机在类的构建完发生，发生之后就不会再初始化了，也不会再构建了，除非再新建一个对象出来。</span><br><span class="line">=====================================================</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="comment"># pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.name = <span class="string">'tom'</span>   <span class="comment"># self指的就是当前创建的实例本身，这样定义，所有实例的name都将是tom</span></span><br><span class="line">    </span><br><span class="line">a = Person()</span><br><span class="line">b = Person()</span><br><span class="line">print(a.name, b.name)</span><br><span class="line">输出：</span><br><span class="line">tom tom</span><br><span class="line">==================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="comment"># pass</span></span><br><span class="line">    x = <span class="string">'abc'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">    </span><br><span class="line">a = Person(<span class="string">'tom'</span>)</span><br><span class="line">b = Person(<span class="string">'jerry'</span>)</span><br><span class="line">print(a.name, b.name)</span><br><span class="line">print(a.x, b.x)   <span class="comment"># 类是共用的，x是常量，不会变</span></span><br><span class="line">输出：</span><br><span class="line">tom jerry</span><br><span class="line">abc abc</span><br><span class="line">====================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="comment"># pass</span></span><br><span class="line">    x = <span class="string">'abc'</span>   <span class="comment"># 这是类的属性或叫类属性</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name   </span><br><span class="line"><span class="comment"># 这是对象的属性或叫实例属性。以self开头的就是实例的。self的问题就是不判断传入的类型</span></span><br><span class="line">    </span><br><span class="line">a = Person(<span class="string">'tom'</span>)</span><br><span class="line">b = Person(<span class="string">'tom'</span>)</span><br><span class="line"><span class="comment"># print(a.name, b.name)</span></span><br><span class="line"><span class="comment"># print(a.x, b.x) </span></span><br><span class="line">print(a == b)  <span class="comment"># 这是两个不同的对象，这是两个不同的变量</span></span><br><span class="line">print(a <span class="keyword">is</span> b)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line">====================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="comment"># pass</span></span><br><span class="line">    x = <span class="string">'abc'</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.y = age   </span><br><span class="line"><span class="comment"># y是实例的属性，实例的属性可以换位置，属性也是变量名，将它对应到age上，调用时用y就可以了，属性名与调用时的</span></span><br><span class="line"><span class="comment"># 名称要一样，上面的__init__()的括号中只是函数的定义，这里的self.y中的y才是要调用的变量名。self.y是一个</span></span><br><span class="line"><span class="comment"># 限定，y是self的实例变量</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self, x, y)</span>:</span> </span><br><span class="line"><span class="comment"># 这里也可以加参数，这里的x和y与上面定义的x没有关系，也与self.y没有关系，这是传入的参数。</span></span><br><span class="line"><span class="comment"># 对于一个方法来讲，它处理的数据可以与这个类本身没有关系，可以与当前实例也没有关系。self.x就叫与当前实例有</span></span><br><span class="line"><span class="comment"># 关系。上面定义的x和y与当前类和实例都没有关系。因为当前实例没有这个东西，只是对这个东西进行加工处理。这就像</span></span><br><span class="line"><span class="comment"># method函数，送进去一个值可以返回一个绝对值，这个返回的值与method没有关系，不属于它的类也不属于它的实例，</span></span><br><span class="line"><span class="comment"># 它只是对数据进行了加工处理 </span></span><br><span class="line">        print(self.name, self.y)  <span class="comment"># 这是一种形式上的调用，要用实参来替换</span></span><br><span class="line">    	self.y = x   <span class="comment"># 这就是将初始化中的self.y改成了传入的x的值</span></span><br><span class="line">        Person.x = x   <span class="comment"># 改变Person类的x属性的值</span></span><br><span class="line">    </span><br><span class="line">a = Person(<span class="string">'tom'</span>)</span><br><span class="line">b = Person(<span class="string">'tom'</span>, <span class="number">20</span>)</span><br><span class="line">print(a.y, b.y)</span><br><span class="line">a.show(<span class="number">100</span>, <span class="string">'a'</span>)  <span class="comment"># 可以发现，这里调用show()方法传入的y值是'a'，但这个y的值与self.y是没有关系的，self.y值的变化是因为show()方法中有self.y = x</span></span><br><span class="line">b.show(<span class="number">200</span>, <span class="string">'b'</span>)</span><br><span class="line">print(Person.x)</span><br><span class="line">a.y = <span class="number">200</span>   <span class="comment"># 外部修改类内部的变量</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">18</span> <span class="number">20</span></span><br><span class="line">tom <span class="number">18</span></span><br><span class="line">tom <span class="number">20</span></span><br><span class="line"><span class="number">200</span></span><br></pre></td></tr></table></figure>
<p>实例叫instance</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="comment"># pass</span></span><br><span class="line">    x = <span class="string">'abc'</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.y = age   </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self, x, y)</span>:</span> </span><br><span class="line">        print(self.name, self.y)  </span><br><span class="line">    	self.y = x   </span><br><span class="line">        Person.x = x  </span><br><span class="line">    </span><br><span class="line">a = Person(<span class="string">'tom'</span>)</span><br><span class="line">b = Person(<span class="string">'jerry'</span>, <span class="number">20</span>)</span><br><span class="line">print(a.__class__, b.__class__)</span><br><span class="line">print(a.__class__.__qualname__, a.__class__.__name__)   </span><br><span class="line"><span class="comment"># __qualname__是限定名，限定名是类才会有的东西。在类的实例上是调用不到的。类是类类型的实例，也就是说这是类</span></span><br><span class="line"><span class="comment"># 类型的属性。__name__也一样。文件的名称就是模块的名称，如test.py，上面是在__main__模块中运行的，这里省掉</span></span><br><span class="line"><span class="comment"># 了。__qualname__限定名不等于__name__，它们是有差异的</span></span><br><span class="line">print(isinstance(a, a.__class__))   <span class="comment"># 查看a是不是a.__class__类型。b也是这种类型</span></span><br><span class="line">print(int.__class__)  <span class="comment"># int本身也是个类型</span></span><br><span class="line">print(isinstance(b, int.__class__))</span><br><span class="line">print(Person.__dict__)  <span class="comment"># 打印类的属性，类中定义的都是类的属性</span></span><br><span class="line">print(a.__dict__)  </span><br><span class="line"><span class="comment"># 打印对象属性。对象上没有方法，对象方法没必要定义在对象里，因为大家的操作是一样的，所以定义在了类里，只是数据</span></span><br><span class="line"><span class="comment"># 不一样了。函数（方法）只有一份，只是参数不一样了。所以方法属于类属性。这个字典中的show是一个function，如</span></span><br><span class="line"><span class="comment"># 果再加一个括号就可以调用了</span></span><br><span class="line">print(b.__dict__)  <span class="comment"># 对于对象来说，自己拥有一个字典，存着自己的数据，这叫个性化</span></span><br><span class="line">print(a.__dict__[<span class="string">'name'</span>])</span><br><span class="line">输出：</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">Person</span>'&gt; &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">Person</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">Person</span> <span class="title">Person</span>  </span></span><br><span class="line"><span class="class"><span class="title">True</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">type</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">False</span></span></span><br><span class="line">&#123;'__module__': '__main__', 'x': 'abc', '__init__': &lt;function Person.__init__ at 0x7fdc1d2d3550&gt;, 'show': &lt;function Person.show at 0x7fdc1d2d35e0&gt;, '__dict__': &lt;attribute '__dict__' of 'Person' objects&gt;, '__weakref__': &lt;attribute '__weakref__' of 'Person' objects&gt;, '__doc__': None&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'tom'</span>, <span class="string">'y'</span>: <span class="number">18</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'jerry'</span>, <span class="string">'y'</span>: <span class="number">20</span>&#125;</span><br><span class="line">tom</span><br><span class="line">================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    age = <span class="number">3</span></span><br><span class="line">    height = <span class="number">170</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">tom = Person(<span class="string">'tom'</span>)</span><br><span class="line">jerry = Person(<span class="string">'jerry'</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">Person.age = <span class="number">30</span>   <span class="comment"># 这是一种限定，限定在Person类中使用age这个变量</span></span><br><span class="line">print(<span class="number">1</span>, Person.age, tom.age, jerry.age)</span><br><span class="line">print(<span class="number">2</span>, Person.__dict__, tom.__dict__, jerry.__dict__, sep=<span class="string">'\n'</span>)</span><br><span class="line">print(<span class="number">3</span>, Person.height, tom.height, jerry.height)</span><br><span class="line">Person.height += <span class="number">20</span></span><br><span class="line">print(<span class="number">4</span>, Person.height, tom.height, jerry.height)</span><br><span class="line">print(<span class="number">5</span>, Person.__dict__, tom.__dict__, jerry.__dict__, sep=<span class="string">'\n'</span>)</span><br><span class="line"><span class="comment"># 到目前为止tom和jerry中还没有新key</span></span><br><span class="line">tom.height = <span class="number">168</span>   <span class="comment"># 赋值即定义，在这个实例上定义一个height</span></span><br><span class="line">print(<span class="number">6</span>, Person.height, tom.height, jerry.height)</span><br><span class="line">print(<span class="number">7</span>, Person.__dict__, tom.__dict__, jerry.__dict__, sep=<span class="string">'\n'</span>)</span><br><span class="line"><span class="comment"># 这时tom中添加了一个新key</span></span><br><span class="line">jerry.height += <span class="number">30</span>   <span class="comment"># 开始jerry没有height，它会到Person中拿这个属性再加上30。这样定义破坏了封装</span></span><br><span class="line">print(<span class="number">8</span>, Person.height, tom.height, jerry.height)</span><br><span class="line"><span class="comment"># 先查找自己的字典，自己的字典没有就到类字典中找，如果还是没有就报找不到。如果自己有就不找类的了。</span></span><br><span class="line"><span class="comment"># 先找自己再找自己的类</span></span><br><span class="line">print(<span class="number">9</span>, Person.__dict__, tom.__dict__, jerry.__dict__, sep=<span class="string">'\n'</span>)</span><br><span class="line"><span class="comment"># jerry现在也有了新key</span></span><br><span class="line">Person.weight = <span class="number">70</span>   <span class="comment"># 在类上添加一个新属性</span></span><br><span class="line">print(<span class="number">10</span>, Person.weight, tom.weight, jerry.weight)</span><br><span class="line"></span><br><span class="line">print(<span class="number">11</span>, Person.__dict__[<span class="string">'weight'</span>])  <span class="comment"># 这没问题，可以找到</span></span><br><span class="line"><span class="comment"># print(12, tom.__dict__['weight'])  # 这样不行，会报找不到key</span></span><br><span class="line"><span class="comment"># 实例使用.点来访问属性，会先找自己的__dict__，如果没有，然后通过属性__class__找到自己的类，再去类的__dict__中找。</span></span><br><span class="line"><span class="comment"># 注意，如果实例使用__dict_[变量名]访问变量，将不会按照上面的查找顺序找变量了，这是指明使用字典的key查找，不是属性查找。</span></span><br><span class="line">print(<span class="number">13</span>, tom.weight)  <span class="comment"># 这样没问题，会到类里找</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tom.__class__.__dict__ 等价于 Person.__dict__</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span> <span class="number">30</span> <span class="number">18</span> <span class="number">20</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'age'</span>: <span class="number">30</span>, <span class="string">'height'</span>: <span class="number">170</span>, <span class="string">'__init__'</span>: &lt;function Person.__init__ at <span class="number">0x7f0425d6c1e0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'tom'</span>, <span class="string">'age'</span>: <span class="number">18</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'jerry'</span>, <span class="string">'age'</span>: <span class="number">20</span>&#125;</span><br><span class="line"><span class="number">3</span> <span class="number">170</span> <span class="number">170</span> <span class="number">170</span></span><br><span class="line"><span class="number">4</span> <span class="number">190</span> <span class="number">190</span> <span class="number">190</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'age'</span>: <span class="number">30</span>, <span class="string">'height'</span>: <span class="number">190</span>, <span class="string">'__init__'</span>: &lt;function Person.__init__ at <span class="number">0x7f0425d6c1e0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'tom'</span>, <span class="string">'age'</span>: <span class="number">18</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'jerry'</span>, <span class="string">'age'</span>: <span class="number">20</span>&#125;</span><br><span class="line"><span class="number">6</span> <span class="number">190</span> <span class="number">168</span> <span class="number">190</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'age'</span>: <span class="number">30</span>, <span class="string">'height'</span>: <span class="number">190</span>, <span class="string">'__init__'</span>: &lt;function Person.__init__ at <span class="number">0x7f0425d6c1e0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'tom'</span>, <span class="string">'age'</span>: <span class="number">18</span>, <span class="string">'height'</span>: <span class="number">168</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'jerry'</span>, <span class="string">'age'</span>: <span class="number">20</span>&#125;</span><br><span class="line"><span class="number">8</span> <span class="number">190</span> <span class="number">168</span> <span class="number">220</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'age'</span>: <span class="number">30</span>, <span class="string">'height'</span>: <span class="number">190</span>, <span class="string">'__init__'</span>: &lt;function Person.__init__ at <span class="number">0x7f0425d6c1e0</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'tom'</span>, <span class="string">'age'</span>: <span class="number">18</span>, <span class="string">'height'</span>: <span class="number">168</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'jerry'</span>, <span class="string">'age'</span>: <span class="number">20</span>, <span class="string">'height'</span>: <span class="number">220</span>&#125;</span><br><span class="line"><span class="number">10</span> <span class="number">70</span> <span class="number">70</span> <span class="number">70</span></span><br><span class="line"><span class="number">11</span> <span class="number">70</span></span><br><span class="line"><span class="number">13</span> <span class="number">70</span></span><br></pre></td></tr></table></figure>
<p>装饰一个类，这和类装饰器不同，类装饰器是指一个类就是装饰别人的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 装饰器有嵌套函数，嵌套函数与高阶函数有关，形参或返回值是函数就是高阶函数</span></span><br><span class="line"><span class="comment"># def setnameproperty(cls, name):</span></span><br><span class="line"><span class="comment">#     cls.NAME = name  </span></span><br><span class="line"><span class="comment"># 装饰器从这个函数得来</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setnameproperty</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(cls)</span>:</span></span><br><span class="line">        cls.NAME = name   <span class="comment"># 这里动态增加了一个类属性并赋值为'MY CLASS'</span></span><br><span class="line">        <span class="keyword">return</span> cls  </span><br><span class="line"><span class="comment"># 这里要返回cls是因为MyClass = wrapper(cls)，MyClass被当作cls传入到wrapper中，所以要返回，得到</span></span><br><span class="line"><span class="comment"># MyClass = cls，如果不返回，就成了MyClass = None。如果像上面定义的setnameproperty(cls, name)，就不</span></span><br><span class="line"><span class="comment"># 需要返回了，因为直接就改了</span></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@setnameproperty('MY CLASS')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span>  </span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(MyClass.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'MyClass'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'MyClass'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'NAME'</span>: <span class="string">'MY CLASS'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入装饰器@setnameproperty('MY CLASS')后，其下面如果是类的话，它会把标识符抽（上例中是MyClass）取出</span></span><br><span class="line"><span class="comment"># 来，这个标识符指向了一个对象，不管这个对象是类对象还是函数对象，拿来后就放到这个装饰器函数中，它会先对装饰器</span></span><br><span class="line"><span class="comment"># 函数求值，也就是setnameproperty('MY CLASS')，将'MY CLASS'当作name参数传入函数，这会返回wrapper函</span></span><br><span class="line"><span class="comment"># 数，也就是说@setnameproperty('MY CLASS')等于@wrapper，这就是语法糖了。这个语法糖会把他下面的函数抽取</span></span><br><span class="line"><span class="comment"># 出来当作参数，这也是唯一参数，这个语法糖只能接受一个参数。@wrapper会把它下面函数的标识符MyClass拿到，放到</span></span><br><span class="line"><span class="comment"># wrapper函数中当作cls传入，再给MyClass添加功能后，再返回去。返回的MyClass类还是原来的类</span></span><br></pre></td></tr></table></figure>
<p>类方法与静态方法</p>
<p>类的方法什么时候用？像datetime一样，没有这个对象，但你又想用某种方法来构造这个对象，但你又不想用<code>__new__</code>，因为<code>__new__</code>比较局限，它是用构造器来构造的。可以从时间戳或字符串构造一个datetime，这就需要写几个类方法，类方法中都会return一个datetime对象。datetime类方法，从什么东西来构建一个对象，这个datetime对象现在还不存在，因为不存在，所以应该写一个类方法，这是在类上调用，再构造出一个新的datetime对象出来，因为拿到时间字符串时还不能说时间对象就存在了，要用时间字符串解析过之后返回一个datetime，造一个datetime出来，这个方法是类的</p>
<p>类方法的调用可以在类上进行 (例如 <code>C.f()</code>) 也可以在实例上进行 (例如 <code>C().f()</code>)。 其所属类以外的类实例会被忽略。 如果类方法在其所属类的派生类上调用，则该派生类对象会被作为隐含的第一个参数被传入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="string">"""this is a class"""</span></span><br><span class="line">    x = <span class="number">123</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>   <span class="comment"># 初始化</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"foo = &#123;&#125;"</span>.format(self.x)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span>   <span class="comment"># 不建议这样使用</span></span><br><span class="line">        print(<span class="string">'bar'</span>)</span><br><span class="line">        </span><br><span class="line">a = MyClass()  <span class="comment"># 实例化，初始化</span></span><br><span class="line">print(a.foo())</span><br><span class="line"></span><br><span class="line">MyClass.bar()</span><br><span class="line">print(MyClass.__dict__)</span><br><span class="line">a.bar()   <span class="comment"># 这会报错。因为bar并不是实例的方法，而是类的方法，但一般不会这样用</span></span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">foo = <span class="number">123</span></span><br><span class="line">bar</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__doc__'</span>: <span class="string">'this is a class'</span>, <span class="string">'x'</span>: <span class="number">123</span>, <span class="string">'__init__'</span>: &lt;function MyClass.__init__ at <span class="number">0x7fc1540c7550</span>&gt;, <span class="string">'foo'</span>: &lt;function MyClass.foo at <span class="number">0x7fc1540c75e0</span>&gt;, <span class="string">'bar'</span>: &lt;function MyClass.bar at <span class="number">0x7fc1540c7670</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'MyClass'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'MyClass'</span> objects&gt;&#125; </span><br><span class="line"><span class="comment"># 这里bar和foo都是function</span></span><br><span class="line">=====================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="string">"""this is a class"""</span></span><br><span class="line">    xxx = <span class="string">'XXX'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"foo"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span>   <span class="comment"># 不建议这样使用</span></span><br><span class="line">        print(<span class="string">'bar'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @classmethod   </span></span><br><span class="line"><span class="comment"># 类方法，当调用这个方法时，会将类的名称当第一个参数给cls。类方法与普通方法的区别，如果用了这个装饰器，它下面</span></span><br><span class="line"><span class="comment"># 的第一个参数就不再是实例本身了，而是实例对应的类本身了。它是属于这个类的。如下面</span></span><br><span class="line"><span class="comment"># def clsmtd(cls, *, a)中的就是cls了，而不是self</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clsmtd</span><span class="params">(cls, *, a)</span>:</span>   </span><br><span class="line"><span class="comment"># cls是自动加上的，这是第一位置参数，不能变。有类就可以调用类方法</span></span><br><span class="line">        print(<span class="string">'&#123;&#125;.xxx=&#123;&#125;'</span>.format(cls.__name__, cls.xxx))</span><br><span class="line"><span class="comment"># 在这里不能直接调用实例的属性</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @staticmethod   </span></span><br><span class="line"><span class="comment"># 静态方法。这和上面的bar()方法差不多，如果要用这种方法，建议使用这种静态方法。</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">staticmtd</span><span class="params">(x)</span>:</span>   <span class="comment"># 这样定义可以，不会传第一个位置参数，但还是可以有参数</span></span><br><span class="line">        print(<span class="string">'static'</span>)</span><br><span class="line">        MyClass   <span class="comment"># 要在静态方法里取类，就用这种方法</span></span><br><span class="line">        </span><br><span class="line">a = MyClass()  <span class="comment"># 实例化，初始化</span></span><br><span class="line">a.foo()</span><br><span class="line"></span><br><span class="line">MyClass.bar()</span><br><span class="line">print(MyClass.__dict__)</span><br><span class="line">MyClass.clsmtd(a=<span class="number">123</span>)</span><br><span class="line">a.clsmtd(a=<span class="number">234</span>)   <span class="comment"># a.__class__.clsmtd()</span></span><br><span class="line"><span class="comment"># 因为a实例中没有clsmtd，所以会到类中找。这相当于传入一个a.__class__给cls。这条等价于</span></span><br><span class="line"><span class="comment"># a.__class__.clsmtd()</span></span><br><span class="line">MyClass.staticmtd(<span class="number">5</span>)</span><br><span class="line">a.staticmtd(x=<span class="number">5</span>)  <span class="comment"># 这样是可以调用的，不会传第一个位置参数</span></span><br><span class="line">MyClass.clsmtd(a=MyClass())  <span class="comment"># 一般不会这样做</span></span><br><span class="line">MyClass().clsmtd(a=<span class="number">1</span>)  <span class="comment"># MyClass()表示实例化出一个对象，只是没有名字 </span></span><br><span class="line">输出：</span><br><span class="line">foo</span><br><span class="line">bar</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__doc__'</span>: <span class="string">'this is a class'</span>, <span class="string">'xxx'</span>: <span class="string">'XXX'</span>, <span class="string">'foo'</span>: &lt;function MyClass.foo at <span class="number">0x7f10e5f7e550</span>&gt;, <span class="string">'bar'</span>: &lt;function MyClass.bar at <span class="number">0x7f10e5f7e5e0</span>&gt;, <span class="string">'clsmtd'</span>: &lt;classmethod object at <span class="number">0x7f10e5fe1a90</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'MyClass'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'MyClass'</span> objects&gt;&#125;</span><br><span class="line">MyClass.xxx=XXX</span><br><span class="line">MyClass.xxx=XXX</span><br><span class="line">static</span><br><span class="line">static</span><br><span class="line">MyClass.xxx=XXX</span><br></pre></td></tr></table></figure>
<p>类方法使用举例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考：https://zhuanlan.zhihu.com/p/35643573</span></span><br><span class="line"><span class="comment"># @classmethod的好处是以后在重构类的时候不需要修改构造函数，只要额外添加你要处理的函数，然后使用</span></span><br><span class="line"><span class="comment"># @classmethod即可。以下为使用方法，在已写好初始类的情况下，想给初始类再新添功能，不需要改初始类，只要在下</span></span><br><span class="line"><span class="comment"># 一个类内部新写一个方法，方法用@classmethod装饰一下即可。</span></span><br><span class="line"><span class="comment"># 初始类：</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Data_test</span><span class="params">(object)</span>:</span></span><br><span class="line">    day=<span class="number">0</span></span><br><span class="line">    month=<span class="number">0</span></span><br><span class="line">    year=<span class="number">0</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,year=<span class="number">0</span>,month=<span class="number">0</span>,day=<span class="number">0</span>)</span>:</span></span><br><span class="line">        self.day=day</span><br><span class="line">        self.month=month</span><br><span class="line">        self.year=year</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">out_date</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"year :"</span></span><br><span class="line">        <span class="keyword">print</span> self.year</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"month :"</span></span><br><span class="line">        <span class="keyword">print</span> self.month</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"day :"</span></span><br><span class="line">        <span class="keyword">print</span> self.day</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增功能：</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Str2IntParam</span><span class="params">(Data_test)</span>:</span>  <span class="comment"># 这是一个新的接口</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_date</span><span class="params">(cls, string_date)</span>:</span></span><br><span class="line">        <span class="comment">#这里第一个参数是cls， 表示调用当前的类名</span></span><br><span class="line">        year,month,day=map(int,string_date.split(<span class="string">'-'</span>))</span><br><span class="line">        date1=cls(year,month,day)</span><br><span class="line">        <span class="comment">#返回的是一个初始化后的类</span></span><br><span class="line">        <span class="keyword">return</span> date1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用：</span></span><br><span class="line">r = Str2IntParam.get_date(<span class="string">"2016-8-1"</span>)  <span class="comment"># 在调用类方法的同时，也完成了实例的初始化</span></span><br><span class="line">r.out_date()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line">year :</span><br><span class="line"><span class="number">2016</span></span><br><span class="line">month :</span><br><span class="line"><span class="number">8</span></span><br><span class="line">day :</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>访问控制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.__age = age  <span class="comment"># 在前面加两个下划线就把对象属性隐藏了。后面有下划线说明是特殊方法</span></span><br><span class="line">        <span class="comment"># 因为是实例属性，所以只有在实例中才能找到</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">growup</span><span class="params">(self, incr=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt; incr &lt; <span class="number">150</span>:</span><br><span class="line">            self.__age += incr</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getage</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__age  <span class="comment"># 内部可以访问隐藏属性</span></span><br><span class="line">    </span><br><span class="line">tom = Person(<span class="string">'tom'</span>)</span><br><span class="line">tom.growup(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># print(tom.age)  # 因为是隐藏属性，所以这里访问不了__age属性</span></span><br><span class="line">print(tom.getage())  <span class="comment"># 这样就可以访问隐藏属性了</span></span><br><span class="line">print(Person.__dict__)</span><br><span class="line">print(tom.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代码不要写成下面这样的方式</span></span><br><span class="line">tom._Person__age = <span class="number">200</span>  <span class="comment"># 这时类中的检查函数就没用了，还是可以改隐藏属性的值</span></span><br><span class="line">print(tom.getage())</span><br><span class="line"></span><br><span class="line">tom.age = <span class="number">300</span>   <span class="comment"># 这样是新增一个属性，与类中的__age没有关系</span></span><br><span class="line">print(tom.getage())</span><br><span class="line">print(tom.age)</span><br><span class="line"></span><br><span class="line">print(tom.__dict__)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">20</span></span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function Person.__init__ at <span class="number">0x7f88d8859550</span>&gt;, <span class="string">'growup'</span>: &lt;function Person.growup at <span class="number">0x7f88d88595e0</span>&gt;, <span class="string">'getage'</span>: &lt;function Person.getage at <span class="number">0x7f88d8859670</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'tom'</span>, <span class="string">'_Person__age'</span>: <span class="number">20</span>&#125;  <span class="comment"># 这里可以看到隐藏的属性__age是改了名字</span></span><br><span class="line"><span class="number">200</span></span><br><span class="line"><span class="number">200</span></span><br><span class="line"><span class="number">300</span></span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'tom'</span>, <span class="string">'_Person__age'</span>: <span class="number">200</span>, <span class="string">'age'</span>: <span class="number">300</span>&#125;</span><br></pre></td></tr></table></figure>
<p>保护变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self._name = name  <span class="comment"># 在变量名前使用一个下划线，称为保护变量</span></span><br><span class="line">        self.__age = age </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__growup</span><span class="params">(self, incr=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt; incr &lt; <span class="number">150</span>:</span><br><span class="line">            self.__age += incr</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getage</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__age  <span class="comment"># 内部可以访问隐藏属性</span></span><br><span class="line">    </span><br><span class="line">tom = Person(<span class="string">'tom'</span>)</span><br><span class="line"><span class="comment"># tom.growup(2)</span></span><br><span class="line">print(Person.__dict__)  <span class="comment"># 查看是否有__growup方法，也变成了_Person__growup</span></span><br><span class="line">print(tom.getage())  </span><br><span class="line">tom._name = <span class="string">'jerry'</span>   <span class="comment"># 可以改变保护变量的值，还可以打印，不会被改名</span></span><br><span class="line">print(tom._name)</span><br><span class="line"><span class="comment"># print(Person.__dict__)</span></span><br><span class="line">print(tom.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function Person.__init__ at <span class="number">0x7fbb17fca550</span>&gt;, <span class="string">'_Person__growup'</span>: &lt;function Person.__growup at <span class="number">0x7fbb17fca5e0</span>&gt;, <span class="string">'getage'</span>: &lt;function Person.getage at <span class="number">0x7fbb17fca670</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Person'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line"><span class="number">18</span></span><br><span class="line">jerry</span><br><span class="line">&#123;<span class="string">'_name'</span>: <span class="string">'jerry'</span>, <span class="string">'_Person__age'</span>: <span class="number">20</span>&#125;</span><br><span class="line"><span class="comment"># 保护变量是Python开发者的共同约定，它不属于解释器管理，所以可以改变。但约定是不要改变。方法有自己的作用域，</span></span><br><span class="line"><span class="comment"># 类也有自己的作用域。从外面无法访问里面的东西，所以要加类名或实例名，称为限定名</span></span><br></pre></td></tr></table></figure>
<p>猴子补丁</p>
<p>解释器运行时才会执行动态替换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在test2模块中定义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span>  <span class="title">__init__</span><span class="params">(self, chinese, english, history)</span>:</span></span><br><span class="line">        self. chinese = chinese</span><br><span class="line">        self.eng = english</span><br><span class="line">        self.his = history</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getscore</span><span class="params">(self)</span>:</span>   <span class="comment"># 取成绩</span></span><br><span class="line">        <span class="keyword">return</span> (self.chinese, self.eng, self.his)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># stu = Person()</span></span><br><span class="line"><span class="comment"># stu.getscore()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 换另一个模块test3修改上面的类</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getscrore</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> dict(chi=self.chinese, eng=self.eng, his=self.his)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再换一个模块test1，运行用</span></span><br><span class="line"><span class="keyword">from</span> test3 <span class="keyword">import</span> getscrore   <span class="comment"># 把补丁导入</span></span><br><span class="line"><span class="keyword">from</span> test2 <span class="keyword">import</span> Person</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">monkeypatch4Person</span><span class="params">()</span>:</span>   <span class="comment"># 一般不会只写下面一行，需要定义一个函数，使用时调用</span></span><br><span class="line">	Person.getscore = getscrore   </span><br><span class="line"><span class="comment"># 把Person类中的getscore方法替换为getscrore方法。前面要替换的方法要与类相关，或与对象相关，现在是要对</span></span><br><span class="line"><span class="comment"># Person类改变属性，如果不是对类改变属性是没有必要的，因为方法是定义在类上的，在类的dict里面。对象的dict里</span></span><br><span class="line"><span class="comment"># 看到的只有自己的数据。这样定义后，当student1调用getscore时，相当于调用getscrore</span></span><br><span class="line"></span><br><span class="line">student1 = Person(<span class="number">80</span>, <span class="number">90</span>, <span class="number">88</span>)</span><br><span class="line">print(student1.getscore())</span><br><span class="line"></span><br><span class="line">monkeypatch4Person()</span><br><span class="line">student2 = Person(<span class="number">88</span>, <span class="number">99</span>, <span class="number">100</span>)  <span class="comment"># 只有student2才会是打了补丁的</span></span><br><span class="line">print(student2.getscore())</span><br><span class="line">输出：</span><br><span class="line">(<span class="number">80</span>, <span class="number">90</span>, <span class="number">88</span>)</span><br><span class="line">(<span class="string">'his'</span>: <span class="number">88</span>, <span class="string">'chi'</span>: <span class="number">80</span>, <span class="string">'eng'</span>: <span class="number">90</span>)   <span class="comment"># 这是打了补丁后的输出</span></span><br></pre></td></tr></table></figure>
<p>属性装饰器与对象的销毁</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 属性装饰器是为了隐藏实例属性，所以暴露另一个方法来操作隐藏的属性</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, chinese, english, history)</span>:</span></span><br><span class="line">        self._chinese = chinese</span><br><span class="line">        self._eng = english</span><br><span class="line">        self.__his = history</span><br><span class="line"><span class="comment"># 实例的属性是私有的，所以最好隐藏，如果想给别人用，要用def的方法把方法暴露给别人    </span></span><br><span class="line"><span class="comment"># 在写一个类的初始化函数的时候，就应该对未来的实例的属性，应该加上下划线或双下划线。因为这些属性是私有的，如果</span></span><br><span class="line"><span class="comment"># 想把这些属性给别人用，请暴露出方法给别人用。有下划线就表示不想被直接使用，所以要用一个方法把它暴露出去</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gethis</span><span class="params">(self)</span>:</span>   <span class="comment"># 取历史成绩。这是__his这个属性的getter</span></span><br><span class="line">        <span class="keyword">return</span> self.__his</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sethis</span><span class="params">(self, value)</span>:</span>   <span class="comment"># 修改历史成绩</span></span><br><span class="line">        self.__his = value</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># def geteng(self):   </span></span><br><span class="line"><span class="comment"># 这只有一个getter属性，这被称为只读属性。上面的属性可以读写。只能写不能读的属性一般没什么用，最少应该可读。</span></span><br><span class="line">    <span class="comment">#    retrun self._eng</span></span><br><span class="line">         </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">seteng</span><span class="params">(self, v)</span>:</span> <span class="comment"># setter</span></span><br><span class="line">        self._eng = v  <span class="comment"># 这里根据下面的property做调整</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property   # 属性装饰器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">chinese</span><span class="params">(self)</span>:</span> </span><br><span class="line"><span class="comment"># 加了属性装饰器，这个方法就可以当一个变量用或属性用。只读属性。这里的方法叫什么名字，下面的setter和deleter</span></span><br><span class="line"><span class="comment"># 也要叫什么名字。定义这个函数就是为了隐藏_chinese属性，使用chinese方法。当访问chinese方法时，就会返回self._chinese的属性值</span></span><br><span class="line">        <span class="keyword">return</span> self._chinese  </span><br><span class="line"><span class="comment"># 看到return就应该想到是否可以改成匿名函数lambda</span></span><br><span class="line"><span class="comment"># 这个装饰器可以把它下面的方法变成一个像属性的东西让你来访问它，就是在使用方法时不用加括号了，这就相当于在调用</span></span><br><span class="line"><span class="comment"># 这个方法，调用这个方法后它就会把这个方法的返回值返回回来给print函数用。这就相当于上面的geteng方法。</span></span><br><span class="line"><span class="meta">	@chinese.setter  </span></span><br><span class="line"><span class="comment"># 这个意思是把下面的方法作为chinese的setter，setter就是set的那个东西，它就是一个属性的设置器，chinese指</span></span><br><span class="line"><span class="comment"># 的是上面@property下面定义的chinese方法。写属性。当赋值时，解释器知道是要调用setter的，调用setter时就会</span></span><br><span class="line"><span class="comment"># 把值当value传入，这样就改变了self._chinese的值</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">chinese</span><span class="params">(self, value)</span>:</span>  <span class="comment"># set需要两个参数</span></span><br><span class="line">        self._chinese = value</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @chinese.deleter   # 删除，少用</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">chinese</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="comment"># del self._chinese</span></span><br><span class="line">    	print(<span class="string">'del chinese'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 下面是另一种方式的属性装饰器</span></span><br><span class="line">    eng = property(<span class="keyword">lambda</span> self:self._eng, seteng)  </span><br><span class="line"><span class="comment"># 括号里只需要函数名就可以了，定义了seteng后，下面就可以给eng赋值了</span></span><br><span class="line">    </span><br><span class="line">student1 = Person(<span class="number">80</span>,<span class="number">90</span>,<span class="number">88</span>)</span><br><span class="line">print(student1.gethis())  <span class="comment"># 在外面不要直接拿实例的属性，而是使用一个方法</span></span><br><span class="line">print(student1.chinese)  <span class="comment"># 把一个方法当属性来用</span></span><br><span class="line">student1.chinese = <span class="number">100</span></span><br><span class="line">print(student1.chinese)</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> student1.chinese</span><br><span class="line"></span><br><span class="line">print(student1.eng)  <span class="comment"># 调用eng方法</span></span><br><span class="line">student1.eng = <span class="number">110</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/05/阿里云直播服务使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/05/阿里云直播服务使用/" itemprop="url">
                  阿里云直播服务使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-05 13:47:49" itemprop="dateCreated datePublished" datetime="2020-03-05T13:47:49+08:00">2020-03-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="时移（回看）功能"><a href="#时移（回看）功能" class="headerlink" title="时移（回看）功能"></a>时移（回看）功能</h4><ol>
<li>start和end组合，会有开始跟结束，但不能控制进度条，这种组合是直播的方式，ts列表不全。</li>
</ol>
<p>例：<a href="https://gehua-edu-broadcast.beijingcloud.com.cn/app-ghedu/stream-ghedu.m3u8?auth_key=1591973719-0-0-0870ae5e5e1fee09537732fec10c7d0b&amp;aliyunols=on&amp;lhs_start_human_s_8=20200304213010&amp;lhs_end_human_s_8=20200304213510" target="_blank" rel="noopener">https://gehua-edu-broadcast.beijingcloud.com.cn/app-ghedu/stream-ghedu.m3u8?auth_key=1591973719-0-0-0870ae5e5e1fee09537732fec10c7d0b&amp;aliyunols=on&amp;lhs_start_human_s_8=20200304213010&amp;lhs_end_human_s_8=20200304213510</a></p>
<ol start="2">
<li>offset向前偏移，会直到直播结束</li>
</ol>
<p>例：<a href="https://gehua-edu-broadcast.beijingcloud.com.cn/app-ghedu/stream-ghedu.m3u8?auth_key=1591973719-0-0-0870ae5e5e1fee09537732fec10c7d0b&amp;aliyunols=on&amp;lhs_offset_unix_s_0=60" target="_blank" rel="noopener">https://gehua-edu-broadcast.beijingcloud.com.cn/app-ghedu/stream-ghedu.m3u8?auth_key=1591973719-0-0-0870ae5e5e1fee09537732fec10c7d0b&amp;aliyunols=on&amp;lhs_offset_unix_s_0=60</a></p>
<p>这个是相对时间的位移，表示从当前时刻前60s开始播放。</p>
<ol start="3">
<li>只有start，也会到直播结束。</li>
</ol>
<p>例：<a href="https://gehua-edu-broadcast.beijingcloud.com.cn/app-ghedu/stream-ghedu.m3u8?auth_key=1591973719-0-0-0870ae5e5e1fee09537732fec10c7d0b&amp;aliyunols=on&amp;lhs_start_human_s_8=20200304231510" target="_blank" rel="noopener">https://gehua-edu-broadcast.beijingcloud.com.cn/app-ghedu/stream-ghedu.m3u8?auth_key=1591973719-0-0-0870ae5e5e1fee09537732fec10c7d0b&amp;aliyunols=on&amp;lhs_start_human_s_8=20200304231510</a></p>
<p>这个是绝对时间的位移，表示从20200304231510时刻开始播放。</p>
<ol start="4">
<li>不要live的话，可以选择start和vodend组合。这会返回完整的ts列表的</li>
</ol>
<p>例：<a href="https://gehua-edu-broadcast.beijingcloud.com.cn/app-ghedu/stream-ghedu.m3u8?auth_key=1591973719-0-0-0870ae5e5e1fee09537732fec10c7d0b&amp;aliyunols=on&amp;lhs_start_human_s_8=20200304231610&amp;lhs_vodend_human_s_8=20200304231810" target="_blank" rel="noopener">https://gehua-edu-broadcast.beijingcloud.com.cn/app-ghedu/stream-ghedu.m3u8?auth_key=1591973719-0-0-0870ae5e5e1fee09537732fec10c7d0b&amp;aliyunols=on&amp;lhs_start_human_s_8=20200304231610&amp;lhs_vodend_human_s_8=20200304231810</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/03/阿里云ECS主机使用curl命令访问URL异常/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/03/阿里云ECS主机使用curl命令访问URL异常/" itemprop="url">
                  阿里云ECS主机使用curl命令访问URL异常
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-03 19:39:24" itemprop="dateCreated datePublished" datetime="2020-03-03T19:39:24+08:00">2020-03-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>用户使用阿里云ECS主机，通过阿里NAT服务联网，当使用<code>curl --location --request GET &#39;http://chygdxw.cn/gehua/2020/02/19/C7C4F31F-B4DD-41DE-9964-2EF967FFA7C9_SDV_0.mp4&#39;</code>会提示：Recv failure: Connection reset by peer。使用一台绑定弹性公网IP的主机访问正常</p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>阿里帮助解决，原因为：对端（指服务端）有发送分片报文，SNAT（指阿里NAT服务）是不支持IP分片包的，因为没法对他进行五元组（指源IP、源端口、协议、目标IP、目标端口）的分类，映射到session上，EIP没有session，所以会有问题。NAT网关的SNAT不支持IP分片。需要服务端发送完整的报文。分片报文是到目标才进行重组，但是经过snat，后端有多个ECS，无法到达准确的ECS。所谓分片就是将一个报文分片成2个或多个报文发送。比较明显的特点是分片的报文的源目端口是缺少的，只有在最后一个分片上才有源目端口</p>
<p><img src="/images/ali分片报文发送/分片报文发送1.png" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">260</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">183</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
