<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/26/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/26/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/18/阿里云RDS数据库备份下载/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/18/阿里云RDS数据库备份下载/" itemprop="url">
                  阿里云RDS数据库备份下载
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-18 10:20:56" itemprop="dateCreated datePublished" datetime="2018-09-18T10:20:56+08:00">2018-09-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-21 10:54:58" itemprop="dateModified" datetime="2018-11-21T10:54:58+08:00">2018-11-21</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>下载RDS数据备份或日志备份</p>
<ol>
<li>登录RDS管理控制台</li>
<li>选择目标实例所在地域。</li>
<li>单击目标实例的ID，进入基本信息页面</li>
<li>在左侧导航栏中，选择备份恢复，进入备份恢复页面</li>
<li>选择数据备份标签页</li>
<li>选择查询的时间范围，然后单击查询。</li>
<li>在数据备份列表中，找到要下载的数据备份，并单击其对应的下载</li>
<li>在实例备份文件下载窗口，单击复制外网地址，获取数据备份文件外网下载地址。这里可以直接下载到本地，也可以通过内网或外网地址下载</li>
<li>登录云服务器ECS</li>
<li>下载数据备份文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -c '&lt;数据备份文件内网或外网下载地址&gt;' -O &lt;自定义文件名&gt;.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash">-c：启用断点续传模式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-O：将下载的结果保存为指定的文件（建议使用URL中包含的文件名）。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">说明：若提示显示100%进度，则表示文件下载完成。</span></span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/mysql备份与还原/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/17/mysql备份与还原/" itemprop="url">
                  mysql备份与还原
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-17 14:08:03" itemprop="dateCreated datePublished" datetime="2018-09-17T14:08:03+08:00">2018-09-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><blockquote>
<p>備份：副本</p>
<p>如果在RAID1或RAID10上，是保證硬件損壞而不會業務中止，所以與mysql的備份無關，因其無法避免邏輯上的破壞</p>
<ul>
<li><p>備份類型：</p>
<p>比如文件有50G，我們用CP復制的是時間點不一致的數據文件，所以不可以。服務器停了再復制是可以的，但服務器是不能停的。</p>
<ul>
<li>熱備份（在線備份）：讀寫不受影響</li>
<li>溫備份：能讀不能寫，僅可以執行讀操作</li>
<li>冷備份：離線備份，讀寫操作均不能進行</li>
</ul>
</li>
</ul>
<ul>
<li><p>物理備份和邏輯備份</p>
<ul>
<li>物理備份：復制數據文件</li>
<li>邏輯備份：將數據導出至文本文件中</li>
</ul>
<p>物理與邏輯備份可以热備、溫備或冷備份</p>
</li>
</ul>
<ul>
<li><p>完全備份、增量備份和差異備份</p>
<ul>
<li>完全備份：備份全部數據（可以是某個庫的某個單獨數據的全部備份）</li>
<li>增量備份：僅備份上次完全或增量備份以後變化的數據</li>
<li>差異備份：僅備份上次完全備份以來變化的數據</li>
</ul>
<p>差異備份與增量備份的區別是，增量備份在備份時每次都是和前一次比較，備份那些不同的數據，而恢復時是先恢復完全備份再按時間點恢復每次的增量備份；差異備份是先完全備份，之後每天都和完全備份比較，備份那些增長的數據，在恢復時先恢復完全備份，再恢復最後一天的差異備份即可。差異備份的數據量要比增量備份的數據量大很多</p>
<p>備份策略是完全加差異或完全加增量。可使用物理或邏輯方式進行完全、增量或差異備份，可以自由組合</p>
<p>還原，最好經常測試還原數據功能。要有還原方案</p>
</li>
<li><p>備份什麼？</p>
</li>
</ul>
<p>​        數據、配置文件、日志（二進制日志、事務日志）</p>
<ul>
<li><p>熱備份</p>
<ul>
<li><p>MyISAM幾乎不可能熱備。可使用邏輯卷的快照備份，但最好是溫備份，以共享方式鎖定MyISAM中的所有表</p>
</li>
<li><p>InnoDB：可以熱備不影響進程，但會影響服務器性能。有專門熱備工具：xtrabackup, mysqldump</p>
</li>
</ul>
<p>可把Mysql做成從服務器，需要備份時把從服務器停下來備份，之後再啟動與主服務器同步</p>
<ul>
<li><p>物理備份：速度快，不用再借助mysql服務器做任何事</p>
</li>
<li><p>邏輯備份：需要mysql服務器進程參與，速度慢，可能會丟失浮點數精度。可以方便使用文本處理工具直接對其處理、可移植性強</p>
</li>
</ul>
</li>
<li><p>備份策略：</p>
<ul>
<li><p>完全+增量           </p>
</li>
<li><p>完全+差異</p>
</li>
</ul>
</li>
<li><p>選擇多長時間備份一次取決於兩點</p>
<ol>
<li><p>數據變化的頻度和變化量；</p>
</li>
<li><p>能夠忍受的還原時長；完全備份是物理還是邏輯方式取決於我們自己的需要，增量備份使用哪種方式也一樣</p>
</li>
</ol>
</li>
<li><p>mysql備份工具</p>
<ul>
<li><p>mysqldump：邏輯備份工具、MyISAM（溫）、InnoDB（熱備份）</p>
</li>
<li><p>mysqlhotcopy：物理備份工具，是溫備工具實際是冷備份</p>
</li>
</ul>
</li>
<li><p>文件系統工具</p>
<ul>
<li><p>cp：只能冷備份</p>
</li>
<li><p>lvm：借助邏輯卷的快照功能，可實現幾乎熱備</p>
</li>
</ul>
</li>
</ul>
<p>​           mysql&gt; FLUSH TABLES</p>
<p>​           mysql&gt; LOCK TABLES</p>
<p>​           創建快照：釋放鎖，而後復制數據</p>
<ul>
<li><p>第三組工具</p>
<ul>
<li><p>ibbackup：商業工具</p>
</li>
<li><p>xtrabackup：開源工具</p>
</li>
</ul>
</li>
<li><p>mysqldump：邏輯備份</p>
<ul>
<li><p>mysqldump（完全備份）+ 二進制日志</p>
</li>
<li><p>完全 + 增量</p>
</li>
</ul>
</li>
<li><p>邏輯備份缺點</p>
<ol>
<li>可能使浮點數據丟失精度</li>
<li>備份出的數據更佔用存儲空間，壓縮後可大大節省空間</li>
<li>不適合對大數據庫做完全備份</li>
</ol>
</li>
</ul>
<p>​       </p>
<ul>
<li><p>對InnoDB做熱備，不建議用溫備份</p>
<p>就算執行了FLUSH TABLES WITH READ LOCK;，如果此時有其他執行程序的話，這個加鎖過程可能要等很長時間，就算鎖上了背後可能還有寫操作，mysql後台每隔一段時間會將事務日志中的數據同步到事務文件中，後台可能還在寫，這時要等待事務日志同步到數據文件中，用命令SHOW ENGINE INNODB STATUS;可查看InnoDB的存儲狀態，所以建議熱備。</p>
<p>MVCC多版本並發控制，如果事務隔離級別是REPEATABLE-READ時，這也是默認級別，–single-transaction會啟動一個大事務，直到我們完成備份，這樣意味著在整個讀取過程中我們讀取的數據都是一致的，就算有人改了，我們看到的也是原來的數據，這就是能做熱備的原因</p>
</li>
</ul>
<ul>
<li><p>幾乎熱備：LVM</p>
<p>snapshot快照：LVM在熱備上是這樣提供技術手段的，我們可對邏輯卷創建快照，快照完成以後，在執行快照那一刻，以後所有變化的數據，通過快照路徑來訪問的話都不會改變的，所以快照的訪問路徑，就是讓數據停留在了過去快照創建的那一刻，任何此後改變了的數據，在改變之前，先把他們復制到快照上然後再改變原始數據所以我們通過快照去訪問的時候，訪問到的都是原始數據，這就是邏輯卷備份，我們在執行快照的那一刻，將整個數據庫鎖定，執行讀鎖，只要能施加上鎖，立即對數據所在的卷創建一個快照，接著並立即釋放那個鎖，而後我們通過快照卷將數據復制出來就能完成備份了。於是我們就有個前提：</p>
<ol>
<li>數據文件要在邏輯卷上</li>
<li>此邏輯卷所在卷組必須有足夠空間使用快照卷，備份數據要放在快照卷上，快照卷主要是用來備份，備份後就沒用了，可以估計一下數據，如果數據備份要三小時，三小時的數據變化量是100M，我們創建一個500M的快照卷就可以了，如果超出快照卷大小，數據會崩潰的，所以我們要給出足夠的預估</li>
<li>數據文件和事務日志要在同一個邏輯卷上（如果使用快照卷做備份的話事務日志與數據文件一定要在一個卷上，因為我們創建的快照，如果事務日志與數據文件不在同一個卷上，那我們就在給兩個卷各做一個快照，但兩個卷的時間點未必一致，事務日志的主要目的是為了向事務存儲引擎提供ACID功能的，如果時間點不一致的話，是不能拿來執行數據恢復的。事務日志結合數據文件一起完成數據管理，用戶的寫操作是先寫到事務日志中，再由事務日志一點點與數據文件同步。所以我們在創建快照時，我們執行的命令會鎖定所有表，其他用戶不能向這裡寫，但這不意味著數據文件與日志已經統一了，事務日志中的某些語句在後台仍在向數據文件中寫，如果我們把他們放在不同的卷上分別進行快照，快照的時間點有可能不一致，那事務日志就無法向數據文件同步數據。所以一定要放在同一個卷上。如果事務日志正在與數據文件同步，這時我們做一快照，這個快照的備份文件是可以用的，但mysql會做一個內部的修復，在mysql服務器看來這就是一個服務器發生崩潰需要還原的版本。同理，如果我們想執行那些未完成的操作繼續執行的話，還要依賴二進制日志。就算我們使用邏輯卷做了一次完全的物理備份，將來做即時點還原仍然依賴於二進制日志）這裏指的是InnoDB，不包括MyISAM</li>
</ol>
</li>
</ul>
</blockquote>
<h1 id="mysqldump"><a href="#mysqldump" class="headerlink" title="mysqldump"></a>mysqldump</h1><h2 id="mysqldump备份恢复"><a href="#mysqldump备份恢复" class="headerlink" title="mysqldump备份恢复"></a>mysqldump备份恢复</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">备份</span><br><span class="line">vim /etc/my.cnf.d/server.cnf</span><br><span class="line">    [mysqld]</span><br><span class="line">    log_bin = mysql_bin</span><br><span class="line"><span class="meta">#</span><span class="bash">开启二进制日志</span></span><br><span class="line">vim /root/.my.cnf</span><br><span class="line">	[client]</span><br><span class="line">    user = 'root'</span><br><span class="line">    password = 'centos'</span><br><span class="line">    host = 'localhost'</span><br><span class="line"><span class="meta">#</span><span class="bash">实现免用户名密码登录</span></span><br><span class="line">mysql -uroot -p &lt; /root/jiaowu.sql</span><br><span class="line"><span class="meta">#</span><span class="bash">将jiaowu.sql文件导入到数据库中</span></span><br><span class="line">mysql</span><br><span class="line">SHOW DATABASES;</span><br><span class="line"><span class="meta">#</span><span class="bash">有jiaowu库了</span></span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看二进制日志位置</span></span><br><span class="line">FLUSH TABLES WITH READ LOCK;</span><br><span class="line"><span class="meta">#</span><span class="bash">再打开一个终端执行此命令，刷新表並且以只讀的方式鎖定所有表，這時再備分</span></span><br><span class="line">mysqldump -uroot -p jiaowu &gt; /tmp/jiaowu.sql</span><br><span class="line"><span class="meta">#</span><span class="bash">导出jiaowu库</span></span><br><span class="line">FLUSH LOGS;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line"><span class="meta">#</span><span class="bash">備份完成後立即釋放鎖</span></span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看二进制日志位置，只取滾動後新建的日志</span></span><br><span class="line"></span><br><span class="line">恢复</span><br><span class="line">DROP DATABASE jiaowu;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 刪除jiaowu庫</span></span><br><span class="line">CREATE DATABASE studb;</span><br><span class="line">mysql studb &lt; /tmp/jiaowu.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将数据库导入</span></span><br></pre></td></tr></table></figure>
<h2 id="mysqldump命令选项"><a href="#mysqldump命令选项" class="headerlink" title="mysqldump命令选项"></a>mysqldump命令选项</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p jiaowu &gt; /root/jiaowu-`date +%F-%H-%M-%S`.sql           </span><br><span class="line"><span class="meta">#</span><span class="bash">備份</span></span><br><span class="line">mysqldump -uroot -p --master-data=2 jiaowu &gt; /root/jiaowu-`date +%F-%H-%M-%S`.sql</span><br><span class="line"><span class="meta">#</span><span class="bash">用了第二條命令會在備份的文件中有CHANGE MASTER TO NASTER_LOG_FILE=`mysql-bin.000008, MASTER_LOG_POS=107`指明現在的日志名稱及位置</span></span><br><span class="line">mysqldump -uroot -p --lock-all-tables --flush-logs --all-databases &gt; /root/all.sql  </span><br><span class="line"><span class="meta">#</span><span class="bash">因為不是所有庫都是InnoDB引擎的，所以要用--lock-all-tables選項，之後備份所有庫，還可以加上--master-data=2選項</span></span><br><span class="line">mysqldump -uroot -p --lock-all-tables --flush-logs --all-databases --master-data=2 &gt; /root/all.sql</span><br><span class="line">less /root/all.sql         </span><br><span class="line"><span class="meta">#</span><span class="bash">查看</span></span><br><span class="line">=======================================================================================</span><br><span class="line">mysqldump</span><br><span class="line">    --master-data=n	    n=&#123;0、1、2&#125;</span><br><span class="line">        0表示不記錄二進制日志文件记录位置</span><br><span class="line">        1表示以CHNAGER MASTER TO的方式記錄位置，可用於恢復後直接啟動從服務器</span><br><span class="line">        2表示以CHNAGER MASTER TO的方式記錄位置，但默認被注釋了</span><br><span class="line">    --lock-all-tables：備份前鎖定所有表</span><br><span class="line">    --flush-logs：備份前鎖完表執行日志滾動             flush滾動</span><br><span class="line">    #如果指定庫中的表類型均為InnoDB，可使用--single-transaction啟動熱備，這時就不用鎖定表了--lock-all-tables，這個過程可能很長</span><br><span class="line">    * 備份多個庫</span><br><span class="line">    --all-databases：備份所有庫</span><br><span class="line">    --databases DB_NAME,DB_NAME,…：備份指定庫              </span><br><span class="line">    #這兩個命令由於備份不只一個數據庫，所以會自動創建create databases命令，還原前就不用手動再指定庫了</span><br><span class="line">    --events：備份事件</span><br><span class="line">    --routines：備份存儲過程存儲函數</span><br><span class="line">    --triggers：備份觸發器</span><br></pre></td></tr></table></figure>
<h2 id="備份及即時點還原"><a href="#備份及即時點還原" class="headerlink" title="備份及即時點還原"></a>備份及即時點還原</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">備份及即時點還原</span><br><span class="line">備份策略：每周完全+每日增量</span><br><span class="line">    完全備份：mysqldump</span><br><span class="line">    增量備份：備份二進制日志文件（先flush logs）</span><br><span class="line">    </span><br><span class="line">步骤：</span><br><span class="line">1. 做全量备份</span><br><span class="line">2. 删除现有二进制日志之前的所有日志</span><br><span class="line">3. 删除某表中的一些行，以便下面测试</span><br><span class="line">4. 滚动日志</span><br><span class="line">5. 复制滚动前二进制日志到其他路径或将滚动前二进制日志转为sql文件保存到其他目录，实现增量备份</span><br><span class="line">6. 在删除了行的表中插入新行</span><br><span class="line">7. 将滚动后的日志（也是现在的日志）复制到其他路径</span><br><span class="line">8. 删除数据目录中的所有文件</span><br><span class="line">9. 停止、启动服务器，实现数据初始</span><br><span class="line">10. 修改root密码</span><br><span class="line">11. 导入全量备份的sql文件</span><br><span class="line">12. 导入增量备份的sql文件</span><br><span class="line">13. 将最新的日志文件转为sql文件并导入，实现即时点还原。</span><br><span class="line">14. 这里全量备份不存在对应的二进制日志，因为被删除了。删除后仅剩一个二进制日志，这个日志就是增量备份的日志。之后做其他操作后又滚动过一次日志，也就是最新的日志。这个过程涉及两个日志和一个全量备份的sql文件。</span><br><span class="line"></span><br><span class="line">* 完全备份</span><br><span class="line">mysqldump -uroot -p --master-data=2 --flush-logs --all-databases --lock-all-tables &gt; /root/alldatabases.sql</span><br><span class="line">mysql</span><br><span class="line"><span class="meta">#</span><span class="bash">建議在刪除備份前的二進制日志前先將其備份一份，可能以後有用。</span></span><br><span class="line">less /root/ alldatabases.sql</span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line">PURGE BINARY LOGS TO 'mysql_bin.000011'; </span><br><span class="line"><span class="meta">#</span><span class="bash">purge[pə:dʒ]：清除。刪除二進制文件，這是為了避免空間被佔滿，这是删除最后的mysql_bin.000011之前的所有二进制日志</span></span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;</span><br><span class="line">DELETE FROM tutors WHERE Age&gt;80;            </span><br><span class="line"><span class="meta">#</span><span class="bash">刪除一些数据</span></span><br><span class="line"></span><br><span class="line">* 下面做增量備份</span><br><span class="line">mysql</span><br><span class="line">FLUSH LOGS;         </span><br><span class="line"><span class="meta">#</span><span class="bash">滾動</span></span><br><span class="line">quit        </span><br><span class="line"><span class="meta">#</span><span class="bash">退出mysql</span></span><br><span class="line">cd /mydata/data              </span><br><span class="line"><span class="meta">#</span><span class="bash">到數據目錄中</span></span><br><span class="line">cp mysql-bin.000011 /root/          </span><br><span class="line"><span class="meta">#</span><span class="bash">因之前已經滾動了日志，所以倒數第二個就是我們要增量備份的日志，將其拷貝到root目錄即可。</span></span><br><span class="line">或</span><br><span class="line">mysqlbinlog mysql-bin.000011 &gt; /root/mon-incremental.sql           </span><br><span class="line"><span class="meta">#</span><span class="bash">這種方式的增量備份更好一些</span></span><br><span class="line">mysql</span><br><span class="line">use studb;</span><br><span class="line">INSERT INTO tutors (Tname) Values (‘stu123’);</span><br><span class="line">退出</span><br><span class="line">* 模擬刪除了數據庫，而不能刪二進制日志</span><br><span class="line">cp mysql-bin.000012 /root           </span><br><span class="line"><span class="meta">#</span><span class="bash">將二進制日志拷出去</span></span><br><span class="line">rm -rf ./*        </span><br><span class="line"><span class="meta">#</span><span class="bash">刪除數據目錄中的所有文件</span></span><br><span class="line">service mysqld stop        </span><br><span class="line"><span class="meta">#</span><span class="bash">現在無法停止mysql</span></span><br><span class="line">killall mysqld              </span><br><span class="line"><span class="meta">#</span><span class="bash">殺死mysql進程</span></span><br><span class="line">cd /usr/local/mysql/            </span><br><span class="line"><span class="meta">#</span><span class="bash">到此目錄初始化mysql</span></span><br><span class="line">scripts/mysql_install_db --user=mysql --datadir=/mydata/data         </span><br><span class="line"><span class="meta">#</span><span class="bash">初始化，这是编译安装的。如果是yum安装的可以直接启动，就会初始化</span></span><br><span class="line">service mysqld start        </span><br><span class="line"><span class="meta">#</span><span class="bash">啟動mysql</span></span><br><span class="line">mysql</span><br><span class="line">UPDATE mysql.user SET PASSWORD=PASSWORD('centos') WHERE User='root';</span><br><span class="line"><span class="meta">#</span><span class="bash">设置root的密码。或执行mysql_secure_installation</span></span><br><span class="line">mysql -uroot -p &lt; alldatabases.sql            </span><br><span class="line"><span class="meta">#</span><span class="bash">還原完全備份</span></span><br><span class="line">mysql</span><br><span class="line">mysql -uroot -p</span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;</span><br><span class="line">退出             </span><br><span class="line"><span class="meta">#</span><span class="bash">這一過程是為了驗證增量備份恢復後的變化</span></span><br><span class="line">mysql -uroot -p &lt; mon-incremental.sql          </span><br><span class="line"><span class="meta">#</span><span class="bash">恢復增量備份</span></span><br><span class="line">mysql -uroot -p         </span><br><span class="line"><span class="meta">#</span><span class="bash">進入</span></span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;             </span><br><span class="line"><span class="meta">#</span><span class="bash">查看證明有變化</span></span><br><span class="line">退出</span><br><span class="line">mysqlbinlog mysql-bin.000012 &gt; temp.sql    </span><br><span class="line"><span class="meta">#</span><span class="bash">把日志文件導出為.sql文件</span></span><br><span class="line">mysql -uroot -p &lt; temp.sql           </span><br><span class="line"><span class="meta">#</span><span class="bash">即時點還原。</span></span><br><span class="line">或</span><br><span class="line">mysqlbinlog mysql-bin.000012 | mysql -uroot -p         </span><br><span class="line"><span class="meta">#</span><span class="bash">這樣一條命令即可實現即時點還原</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">上面這樣的試驗只適合在數據量小的時候，如果大的話，mysqldump備份會很慢。視頻中要求寫一個mysql完全備份腳本，增量備份寫成另一個腳本，盡量使用變量定義保存位置，使用日期保存備份的文件名稱。還可用腳本還原</span></span><br></pre></td></tr></table></figure>
<h1 id="xtrabackup"><a href="#xtrabackup" class="headerlink" title="xtrabackup"></a>xtrabackup</h1><h2 id="完全备份与恢复"><a href="#完全备份与恢复" class="headerlink" title="完全备份与恢复"></a>完全备份与恢复</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">* 安装</span><br><span class="line">wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.9/binary/redhat/7/x86_64/Percona-XtraBackup-2.4.9-ra467167cdd4-el7-x86_64-bundle.tar</span><br><span class="line">＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝</span><br><span class="line">* rpm包安装</span><br><span class="line">	* CentOS6</span><br><span class="line">yum install http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm</span><br><span class="line">yum list|grep percona</span><br><span class="line">yum install percona-xtrabackup</span><br><span class="line">	* CentOS7</span><br><span class="line">yum install http://www.percona.com/downloads/percona-release/redhat/0.1-6/percona-release-0.1-6.noarch.rpm</span><br><span class="line">yum list|grep percona</span><br><span class="line">yum install percona-xtrabackup-24</span><br><span class="line"><span class="meta">#</span><span class="bash">阿里云建议MySQL5.6及之前的版本需要安装 Percona XtraBackup 2.3。MySQL5.7版本需要安装 Percona XtraBackup 2.4。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Percona XtraBackup 2.3地址：https://www.percona.com/doc/percona-xtrabackup/2.3/installation/yum_repo.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Percona XtraBackup 2.4地址：https://www.percona.com/doc/percona-xtrabackup/2.4/installation/yum_repo.html</span></span><br><span class="line">========================================================</span><br><span class="line">innobackupex --help</span><br><span class="line">innobackupex --user=DBUSER --password=DBUSERPASS /path/to/BACKUP-DIR/(保存位置)</span><br><span class="line"><span class="meta">#</span><span class="bash">完全備份。innobackupex是一個腳本，在裡面封裝了一些命令行工具，--user=DBUSER --password=DBUSERPASS是連接服務器要用的帳號密碼。服務器可指定，如--host=localhost，這裡被省略了，因為一般都是在本機上進行備份。/path/to/BACKUP-DIR/指要保存的位置。備份的用戶要有權限，如果要使用一個最小權限的用戶進行備份，則可基於如下命令創建此類用戶。可以創建一個專門備份的用戶，或用管理員也可以</span></span><br><span class="line">========================================================</span><br><span class="line">* 授权</span><br><span class="line">mysql</span><br><span class="line">MariaDB [(none)]&gt; CREATE USER 'bkpuser'@'localhost' IDENTIFIED BY 'centos';</span><br><span class="line"><span class="meta">#</span><span class="bash">创建用户</span></span><br><span class="line">MariaDB [(none)]&gt; REVOKE ALL PRIVILEGES,GRANT OPTION FROM 'bkpuser'@'localhost';</span><br><span class="line"><span class="meta">#</span><span class="bash">取消用户所有权限与授权权限</span></span><br><span class="line">MariaDB [(none)]&gt; GRANT RELOAD,LOCK TABLES,REPLICATION CLIENT ON *.* TO 'bkpuser'@'localhost';</span><br><span class="line"><span class="meta">#</span><span class="bash">只需要RELOAD, LOCK TABLES, REPLICATION CLIENT這三個權限就可備份了</span></span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line">MariaDB [(none)]&gt; SHOW GRANTS;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看当前用户的授权。grant[grɑ:nt]：授权。</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW GRANTS FOR bkpuser@localhost;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看指定用户的授权</span></span><br><span class="line">* 备份</span><br><span class="line">innobackupex --user=root /backup          </span><br><span class="line"><span class="meta">#</span><span class="bash">備份數據庫，backup目录是自动创建的。因为在/root/.my.cnf文件中写明了用户名和密码，所以这里的密碼是空，所以省略了，服務器是本機。另外，備份時需要mysql服務器是啟動狀態。備份好後在/backup下有一個以當前時間命名的目錄。使用上面的bkpuser用户备份时会提示有授权问题，也就是缺少某些权限，待解决</span></span><br><span class="line">cd /backup/2016-12-09_22-17-27           </span><br><span class="line"><span class="meta">#</span><span class="bash"> 目錄中的內容如下:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> jiaowu、mysql、<span class="built_in">test</span>、mydb等是數據庫，ibdata1是表空間文件，backup-my.cnf是服務器的配置文件， 備份好以後可以看到備份好的文件中有一個xtrabackup_binlog_info文件，這是二進制日志信息的文件，可用cat打開，裏面是備份這一刻的二進制文件名與相應的號碼。xtrabackup_binary中有在備份時使用了哪個命令進行的備份的信息，視頻中顯示的是xtrabackup 55，测试时没有这个文件。xtrabackup_logfile文件是data數據文件，不能用cat打開；xtrabackup_checkpoints文件裡有備份類型及從哪個邏輯版本號開始的備份，其中to_lsn指的是InnoDB的每一個數據塊InnoDB存儲引擎的數據要存儲在磁盤上，它是存儲數據塊的，每一個數據塊都有一個日志序列號，InnoDB會在內部維持着當前每一數據塊的日志序列號，如果這個塊上的數據發生了改變，這個號碼會加1,下一次可以根據這個號碼做增量備份。如果某一個塊的號碼發生了改變，可以將某一個塊備份一下。這就是可以對InnoDB存儲引擎做增量備份的原因；這裏的信息顯示從0號開始，到1637454結束，下一次就從1637454開始</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 這些備份的數據備份完以後是不能直接恢復的，因為備份的數據中有些事務可能只提交了一半，為了避免mysql啟動的修復過程，我們要對備份出來的文件做一些准備工作，然後才能恢復。准備工作包括：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    1.將已經提交的事務同步到數據文件，從日志文件同步到數據文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    2.將尚未提交的事務做回滾</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    用--apply-log選項可完成上面的兩項</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> innobackupex --apply-log /backup/*****         </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最後的路徑是我們備份的數據的路徑。這樣就會完成上面提到的兩項工作，不做這項工作的話恢復後mysql是啟動不了的</span></span><br><span class="line">* 测试恢复</span><br><span class="line">mysql</span><br><span class="line">MariaDB [(none)]&gt; use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0005');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0006');</span><br><span class="line"><span class="meta">#</span><span class="bash">插入两条数据</span></span><br><span class="line">MariaDB [jiaowu]&gt; FLUSH LOGS;</span><br><span class="line"><span class="meta">#</span><span class="bash">做這步是因為備份當前使用的二進制日志會報錯，所以才滾動一次</span></span><br><span class="line">cp /var/lib/mysql/mysql_bin.000003 /root</span><br><span class="line"><span class="meta">#</span><span class="bash">复制滚动前的日志到其他路径，以备数据恢复时使用</span></span><br><span class="line">systemctl stop mariadb</span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line">innobackupex --copy-back /backup/2018-09-19_11-06-30</span><br><span class="line"><span class="meta">#</span><span class="bash">恢复数据。/恢復時用--copy-back選項，這樣就可以了。這時的數據文件存儲位置（/var/lib/mysql/）一定要是空的，不然會報錯</span></span><br><span class="line">cd /var/lib/mysql/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql/</span><br><span class="line"><span class="meta">#</span><span class="bash">修改数据目录中文件的属主属组为mysql</span></span><br><span class="line">systemctl start mariadb</span><br><span class="line"><span class="meta">#</span><span class="bash">启动报错，无法启动。提示：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:48 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:48 [Note] /usr/libexec/mysqld (mysqld 5.5.60-MariaDB) starting as process 8893 ..</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: The InnoDB memory heap is disabled</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Mutexes and rw_locks use GCC atomic builtins</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Compressed tables use zlib 1.2.7</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Using Linux native AIO</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Initializing buffer pool, size = 2.0G</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:50 InnoDB: Completed initialization of buffer pool</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:51 InnoDB: highest supported file format is Barracuda.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: No valid checkpoint found.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: If you are attempting downgrade from MySQL 5.7.9 or later,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: please refer to http://dev.mysql.com/doc/refman/5.5/en/upgrading-downgrading.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: If this error appears when you are creating an InnoDB database,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: the problem may be that during an earlier attempt you managed</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: to create the InnoDB data files, but <span class="built_in">log</span> file creation failed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: If that is the <span class="keyword">case</span>, please refer to</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: http://dev.mysql.com/doc/refman/5.5/en/error-creating-innodb.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Plugin <span class="string">'InnoDB'</span> init <span class="keyword">function</span> returned error.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Plugin <span class="string">'InnoDB'</span> registration as a STORAGE ENGINE failed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [Note] Plugin <span class="string">'FEEDBACK'</span> is disabled.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Unknown/unsupported storage engine: InnoDB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Aborting</span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">	[mysqld]</span><br><span class="line">	innodb_force_recovery=6</span><br><span class="line">	log_bin = mysql_bin</span><br><span class="line"><span class="meta">#</span><span class="bash">加入上面一行后，就可以启动了。启动后可以取消这个选项。也可能是没有开启二进制日志的原因，所以可以加入log_bin = mysql_bin。测试发现，加入开启二进制日志后，就不需要innodb_force_recovery选项了，另外，使用innodb_force_recovery启动后，进入数据库是不能操作的，需要将innodb_force_recovery注释后，再重启才能操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">innodb_force_recovery可以设置为1-6,大的数字包含前面所有数字的影响。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1. (SRV_FORCE_IGNORE_CORRUPT):忽略检查到的corrupt页。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2. (SRV_FORCE_NO_BACKGROUND):阻止主线程的运行，如主线程需要执行full purge操作，会导致crash。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">3. (SRV_FORCE_NO_TRX_UNDO):不执行事务回滚操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">4. (SRV_FORCE_NO_IBUF_MERGE):不执行插入缓冲的合并操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">5. (SRV_FORCE_NO_UNDO_LOG_SCAN):不查看重做日志，InnoDB存储引擎会将未提交的事务视为已提交。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">6. (SRV_FORCE_NO_LOG_REDO):不执行前滚的操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">参考：https://www.jb51.net/article/66951.htm</span></span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; SHOW DATABASES;</span><br><span class="line">MariaDB [jiaowu]&gt; USE jiaowu;</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">這時是沒有後來加的00006和000005的，要把剛才備份的二進制日志導入即可</span></span><br><span class="line">mysqlbinlog /root/mysql-bin.000003 &gt; /tmp/abc.sql</span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; SET sql_log_bin=0;</span><br><span class="line"><span class="meta">#</span><span class="bash">临时关闭二进制日志</span></span><br><span class="line">MariaDB [jiaowu]&gt; SOURCE /tmp/abc.sql;</span><br><span class="line"><span class="meta">#</span><span class="bash">导入滚动后的二进制日志生成的sql文件，因为stu00005和00006是在完全备份后加入的</span></span><br><span class="line">MariaDB [jiaowu]&gt; SET sql_log_bin=1;</span><br><span class="line"><span class="meta">#</span><span class="bash">开启二进制日志</span></span><br><span class="line">MariaDB [jiaowu]&gt; USE jiaowu;</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">现在有刚加入的00006和000005的信息了</span></span><br></pre></td></tr></table></figure>
<h2 id="增量备份"><a href="#增量备份" class="headerlink" title="增量备份"></a>增量备份</h2><p>xtrabackup支持對innodb做增量備份，對MyISAM不支持，對MyISAM如果有就做完全備份；MyISAM適合讀多寫少的情況</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0007');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0008');</span><br><span class="line"><span class="meta">#</span><span class="bash">加入两条数据</span></span><br><span class="line">innobackupex --user=root /backup    </span><br><span class="line"><span class="meta">#</span><span class="bash">恢復過一次後必須再重新做一次完全備份，因爲當前的數據庫沒有完全備份</span></span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0009');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu00010');</span><br><span class="line">innobackupex --incremental /backup --incremental-basedir=/backup/2018-09-19_16-04-31/</span><br><span class="line"><span class="meta">#</span><span class="bash">先要指定增量備份的保存位置/backup，--incremental-basedir是指定完全備份的保存位置，它會針對完全備份以後的數據做備份，備份後保存在/backup目錄下。這是第一次增量備份。如果是再一次增量備份時，--incremental-basedir應該指向上一次的增量備份所在的目錄；如果數據庫再次損壞且沒有數據增長，用完全和增量備份就能恢復，如果有數據增長就要再加上二進制日志才能恢復。</span></span><br><span class="line">mysql</span><br><span class="line">use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu00011');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu00012');</span><br><span class="line">innobackupex --incremental /backup --incremental-basedir=/backup/2018-09-19_16-05-33/</span><br><span class="line"><span class="meta">#</span><span class="bash">最後指定的是上一次的增量備份位置,2018-09-19_16-05-33是上一次備份後的目錄。如果之前未做過增量備份，就要指向完全備份</span></span><br><span class="line">innobackupex --apply-log --redo-only /backup/2018-09-19_16-04-34/</span><br><span class="line"><span class="meta">#</span><span class="bash">/如果有增量備份，這裡一定要指定--redo-only選項；2018-09-19_16-04-34是第一次完全備份；有增量備份的時候我們在實現提交的情況時，只執行redo不要執行endo。这里一定要用--apply-log选项，实现1.將已經提交的事務同步到數據文件，從日志文件同步到數據文件；2.將尚未提交的事務做回滾。不然下面的命令是不能执行的。</span></span><br><span class="line">innobackupex --apply-log --redo-only /backup/2018-09-19_16-04-34/ --incremental-dir=/backup/2018-09-19_16-05-33/</span><br><span class="line"><span class="meta">#</span><span class="bash">在准備第一次增量備份時要將完全備份寫在前面，還要將增量備份位置寫在最後，用--incremental-dir選項。这是将第一次增量备份合并到完全备份</span></span><br><span class="line">innobackupex --apply-log --redo-only /backup/2018-09-19_16-04-34/ --incremental-dir=/backup/2018-09-19_16-06-15</span><br><span class="line"><span class="meta">#</span><span class="bash">這是第二次增量備份，還是前面寫完全備份位置，後面是第二次增量備份的位置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">之後的還原只需要還原完全備份即可，因為此時所有的提交操作都已合並到完全備份上去了，所以在還原時兩個增量備份就用不上了</span></span><br><span class="line">systemctl stop mariadb</span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line">innobackupex --copy-back /backup/2018-09-19_16-04-34/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql/</span><br><span class="line">systemctl start mariadb</span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">这里有上面插入的所有数据</span></span><br></pre></td></tr></table></figure>
<h2 id="導入或導出單張表，前提是每表一個表空間才可以"><a href="#導入或導出單張表，前提是每表一個表空間才可以" class="headerlink" title="導入或導出單張表，前提是每表一個表空間才可以"></a>導入或導出單張表，前提是每表一個表空間才可以</h2><p>&emsp;&emsp;默認情況下，InnoDB表不能通過直接復制表文件的方式在mysql服務器之間進行移植，即便使用了innodb_file_per_table選項。而使用xtrabackup工具可以實現此種功能，不過，此時需要導出表的mysql服務器啟用了innodb_file_per_table選項（嚴格來說，是要導出的表在其創建之前，mysql服務器就啟用了innodb_file_per_table選項），並且導入表的服務器同時啟用了innodb_file_per_table和innodb_expand_import選項</p>
<ol>
<li>導出表</li>
</ol>
<p>導出表是在備份的prepare階段進行的，因此，一旦完全備份完成，就可以在prepare過程中通過–export選項將某表導出了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innobackupex --apply-log --export /path/to/backup</span><br><span class="line"><span class="meta">#</span><span class="bash">此命令會為每個innodb表的表空間創建一個以.exp結尾的文件，這些以.exp結尾的文件則可以用於導入至其它服務器。</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>導入表</li>
</ol>
<p>要在mysql服務器上導入來自於其它服務器的某innodb表，需要先在當前服務器上創建一個跟原表表結構一致的表，而後才能實現將表導入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash">CREATE TABLE mytable (…) ENGINE=InnoDB;</span></span><br></pre></td></tr></table></figure>
<p>然後將此表的表空間刪除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash">ALTER TABLE mydatabase.mytable DISCARD TABLESPACE;</span></span><br></pre></td></tr></table></figure>
<p>接下來，將來自於導出表的服務器的mytable表的mytable.ibd和mytable.exp文件復制到當前服務器的數據目錄，然後使用如下命令將其導入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> ALTER TABLE mydatabase.mytable IMPORT TABLESPACE;</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/nginx功能测试二/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/17/nginx功能测试二/" itemprop="url">
                  nginx功能测试二
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-17 11:10:22" itemprop="dateCreated datePublished" datetime="2018-09-17T11:10:22+08:00">2018-09-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="https"><a href="#https" class="headerlink" title="https"></a>https</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">* 创建CA服务器</span><br><span class="line">cd /etc/pki/CA</span><br><span class="line">(umask 077;openssl genrsa -out private/cakey.pem 2048)</span><br><span class="line">openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 365</span><br><span class="line">touch index.txt serial</span><br><span class="line">echo 01 &gt; serial</span><br><span class="line">* 到web服务器</span><br><span class="line">mkdir /etc/nginx/ssl</span><br><span class="line">cd /etc/nginx/ssl</span><br><span class="line">(umask 077;openssl genrsa -out nginx.key 2048)</span><br><span class="line">openssl req -new -key http.key -out nginx.csr</span><br><span class="line">scp nginx.csr 192.168.1.2:/tmp</span><br><span class="line">* 到CA服务器</span><br><span class="line">openssl ca -in /tmp/nginx.csr -out /etc/pki/CA/certs/nginx.crt -days 365</span><br><span class="line"><span class="meta">#</span><span class="bash">newcerts中的也是证书，是pem格式的</span></span><br><span class="line">scp certs/nginx.crt 192.168.1.3:/etc/nginx/ssl</span><br><span class="line">* 到web服务器</span><br><span class="line">cp conf.d/vhost1.conf conf.d/vhost1_ssl.conf</span><br><span class="line">vim conf.d/vhost1_ssl.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name www.ruopu.com;</span><br><span class="line">        root /data/nginx/vhost1;</span><br><span class="line">        access_log /var/log/nginx/vhost1_ssl_access.log main;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">        #当前虚拟主机使用PEM格式的证书文件</span><br><span class="line">        ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">        #当前虚拟主机上与其证书匹配的私钥文件</span><br><span class="line">        ssl_protocols sslv3 tlsv1 tlsv1.1 tlsv1.2;</span><br><span class="line">        #支持ssl协议版本，默认为后三个</span><br><span class="line">        ssl_session_cache shared:SSL:10m;</span><br><span class="line">        #在各worker之间使用一个共享的缓存。SSL是自定义的名字，1m内存空间可以缓存4000个会话，这里定义10M。</span><br><span class="line">    &#125;    </span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br><span class="line">ss -tln</span><br><span class="line">访问https://www.ruopu.com，将cacert.pem传到主机，这里定义的CA服务器与客户端的主机名是一样的，访问时通过了。</span><br></pre></td></tr></table></figure>
<h1 id="重写"><a href="#重写" class="headerlink" title="重写"></a><strong>重写</strong></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">    server&#123;</span><br><span class="line">    	rewrite /(.*)\.png$ /$1.jpg;</span><br><span class="line">    	#rewrite放在server中，另外放在location或if中也可以。上面配置表示，所有以.png结尾的文件都转成.jpg格式的。括号是为了后面的$1引用，/是根，png前面的点需要转义，后面的.jpg的点不需要转义</span><br><span class="line">    &#125;</span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br><span class="line">访问www.ruopu.com/images/fish.png，这里实际访问的是一个叫fish.jpg的文件，名字一样但格式不同。</span><br><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">    server &#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       server_name www.ruopu.com;</span><br><span class="line">       root /data/nginx/vhost1;</span><br><span class="line">       error_page 404 /notfound.html;</span><br><span class="line">    #   rewrite /(.*)$ https://www.ruopu.com/$1;</span><br><span class="line">       rewrite /(.*)\.png$ https://www.ruopu.com/$1.jpg;</span><br><span class="line">       #用户请求任何内容，都转到https的页面上。但两条不要一起写，如果一起写，在访问www.ruopu.com/images/night.png时会先匹配上面的规则，下面的规则就不会生效了。</span><br><span class="line">       location = /notfound.html &#123;</span><br><span class="line">            root /data/nginx/error_pages;</span><br><span class="line">       &#125;</span><br><span class="line">       location ^~ /images/ &#123;</span><br><span class="line">            alias /data/pictures/;</span><br><span class="line">       &#125;</span><br><span class="line">       location ~* ^/(admin|login) &#123;</span><br><span class="line">            auth_basic "admin area or login url";</span><br><span class="line">            auth_basic_user_file /etc/nginx/.ngxpasswd;</span><br><span class="line">       &#125;</span><br><span class="line">       location /ngxstatus &#123;</span><br><span class="line">            stub_status;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">vim /etc/nginx/conf.d/vhost1_ssl.conf</span><br><span class="line">    server &#123;</span><br><span class="line">       listen 443 ssl;</span><br><span class="line">       server_name www.ruopu.com;</span><br><span class="line">       root /data/nginx/vhost1;</span><br><span class="line">       location ^~ /images/ &#123;</span><br><span class="line">            alias /data/pictures/;</span><br><span class="line">       &#125;</span><br><span class="line">       access_log /var/log/nginx/vhost1_ssl_access.log main;</span><br><span class="line">       ssl on;</span><br><span class="line">       ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">       ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">       ssl_protocols sslv3 tlsv1 tlsv1.1 tlsv1.2;</span><br><span class="line">       ssl_session_cache shared:SSL:10m;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">vhost1_ssl.conf配置文件中也要有与vhost1.conf中相同的配置，这样才能正常访问，这里是定义的别名与vhost1.conf中是一样的，也就是要有相同的访问路径，不然不能正常访问，会有404的错误提示。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">上面的重写要写在监听80端口的server中，不能写在监听在443端口的server中，如果写在监听在443端口的server中，那么请求会无限重定向，最后是无法访问的。监听80端口与监听443端口的两个server中定义的内容应该是一样的。不然访问80端口时能访问的路径被重定向到443端口时就访问不到了。如果想让访问80端口的任何以png结尾的文件，都被重定向到443端口的.jpg文件，那么就要在监听443端口的配置文件中加入 rewrite /(.*)\.png$ /<span class="variable">$1</span>.jpg;，如果在监听80端口的server中定义是不起作用的。这是在要将所有访问的内容都重定向到443端口，并且还要让访问png文件的请求重定向到443端口的jpg文件，这两个条件都存在的情况下需要的配置。但如果只是将访问80端口的以png结尾的文件重定向到443端口的jpg文件的话，只要在监听80端口的server中写入 rewrite /(.*)\.png$ https://www.ruopu.com/<span class="variable">$1</span>.jpg; 就行了。</span></span><br><span class="line">nginx -s reload</span><br><span class="line">访问https://www.ruopu.com/images/night.png，rewrite规则可以写多条，rewrite匹配并重写url后会以新的url地址重新匹配配置文件或重新检查location的规则，如果可以匹配到，就会再重写一遍，直到匹配不到。默认的行为是last，就是重写的url会被重新再匹配一遍规则。还有break、redirect、permanent</span><br><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">    server&#123;</span><br><span class="line">		rewrite /(.*)\.png$ /$1.jpg redirect;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">redirect是重定向，客户端要重新发起请求。如果是permanent就是永久重定向，也需要客户端重新发请求。last和<span class="built_in">break</span>是不需要客户端重新发请求的，只是服务器内部做了转换</span></span><br><span class="line">=======================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash">[flag]：</span></span><br><span class="line">	last：重写完成后停止对当前URI在当前location中后续的其它重写操作，而后对新的URI启动新一轮重写检查；提前重启新一轮循环；</span><br><span class="line">    break：重写完成后停止对当前URI在当前location中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置；结束循环；</span><br><span class="line">    redirect：重写完成后以临时重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求；不能以http://或https://开头；302</span><br><span class="line">    permanent：重写完成后以永久重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求；301</span><br></pre></td></tr></table></figure>
<h1 id="反代"><a href="#反代" class="headerlink" title="反代"></a>反代</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">* 准备三台主机，一台反代，两台web服务，反代服务器的地址有两个，一个外网192.168.1.90，一个内网172.16.0.1。web服务器有两个内网地址，一个172.16.0.2，一个172.16.0.3。设置内网地址，就是将虚拟机网卡改为仅主机，然后设置仅主机的IP地址</span><br><span class="line">yum install httpd mod_ssl</span><br><span class="line">//到web服务器上安装httpd，mod_ssl，并提供主页，最后改为内网网卡并配置地址。改为内网地址172.16.0.2</span><br><span class="line">vim /var/www/html/index.html</span><br><span class="line">	&lt;h1&gt;Real Server 1&lt;/h1&gt;</span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-eno16777736</span><br><span class="line">    IPADDR=172.16.0.2</span><br><span class="line">    NETMASK=255.255.0.0</span><br><span class="line">systemctl start httpd</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">* 到反代服务器</span><br><span class="line">vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">    [nginx]</span><br><span class="line">    name=nginx repository</span><br><span class="line">    baseurl=http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">    gpgcheck=0</span><br><span class="line">    enabled=1</span><br><span class="line">yum install nginx</span><br><span class="line">vim /etc/nginx/conf.d/ruopu.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name www.ruopu.com</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://172.16.0.2:80；</span><br><span class="line">        //这里要看web服务器是基于什么做的虚拟主机，是IP，port还是FQDN，是哪个就在http后输入哪个</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">nginx -t</span><br><span class="line">systemctl start nginx</span><br><span class="line">* 修改客户端hosts文件，让主机可以解析nginx的域名</span><br><span class="line">* 访问测试</span><br><span class="line">* 到web服务器上</span><br><span class="line">tcpdump -i eno16777736 tcp port 80</span><br><span class="line">//监听80端口，看一下请求是否为反代服务器发来的</span><br><span class="line">* 到第二台web服务器上</span><br><span class="line">yum install httpd</span><br><span class="line">改为内网地址172.16.0.3</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">vim /var/www/html/index.html</span><br><span class="line">	&lt;h1&gt;Real Server 2&lt;/h1&gt;</span><br><span class="line">find /usr/share -iname "*.jpg" -exec cp &#123;&#125; /var/www/html \;</span><br><span class="line">//这一次准备将图片文件都反代到这台服务器</span><br><span class="line">systemctl start httpd</span><br><span class="line">* 到反代服务器，加入</span><br><span class="line">vim /etc/nginx/conf.d/ruopu.conf</span><br><span class="line">    location ~* \.(jpg|jpeg|png)$ &#123;</span><br><span class="line">        proxy_pass http://172.16.0.3:80;</span><br><span class="line">    //将访问图片的请求代理到另一台服务器上</span><br><span class="line">    &#125;</span><br><span class="line">* 到客户端访问，如果是访问域名就返回第一台web服务器的内容，如果访问域名/*.jpg就返回第二台服务器的内容。在配置文件中，如果location中用了正则表达式，在proxy_pass指向的地址中的80端口后是不能加斜线/的，如果没用正则表达式，可以加斜线。像上边的第一个location设置，如果80后有斜线，表示将location中的斜线替换成80后的斜线，如果没有斜线，表示将location中的斜线补在80后</span><br><span class="line">* 测试斜线的功能，到反代服务器上</span><br><span class="line">vim /etc/nginx/conf.d/ruopu.com</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name www.ruopu.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">        	root /data/nginx/html;</span><br><span class="line">        &#125;</span><br><span class="line">        location /admin/ &#123;</span><br><span class="line">            proxy_pass http://172.16.0.2:80;</span><br><span class="line">            //这个反代的意思是在172.16.0.2的根目录下找admin目录，下面的反代是在访问以jpg等为后缀名的文件时到172.16.0.3:80的根目录下找</span><br><span class="line">        &#125;</span><br><span class="line">        location ~* \.(jpg|jpeg|png)$ &#123;</span><br><span class="line">        	proxy_pass http://172.16.0.3:80;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //修改配置文件，将admin代理过去</span><br><span class="line">mkdir -pv /data/nginx/html</span><br><span class="line">nginx -s reload</span><br><span class="line">* 到客户端访问www.ruopu.com/admin，提示Not Found，因为web服务器上没有admin目录。但是，如果location /admin/中的80后有斜线，那么访问的就是172.16.0.2的根目录，也就是/var/www/html/index.html文件。也就是，没有斜线，就将/admin补在80后，因为172.16.0.2中没有admin目录，所以提示Not Found。如果有斜线，就表示访问http://172.16.0.2/admin就是在访问172.16.0.2的根目录，/admin/就等于/。</span><br><span class="line">* 到web服务器上</span><br><span class="line">mkdir /var/www/html/admin</span><br><span class="line">vim /var/www/html/admin/index.html</span><br><span class="line">	admin</span><br><span class="line">* 到客户端测试，这时显示admin</span><br><span class="line">* 到反代服务器上加一个斜线</span><br><span class="line">vim /etc/nginx/conf.d/ruopu.com</span><br><span class="line">    server &#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       server_name www.ruopu.com;</span><br><span class="line">       location / &#123;</span><br><span class="line">            root /data/nginx/html;</span><br><span class="line">       &#125;</span><br><span class="line">       location /admin/ &#123;</span><br><span class="line">            proxy_pass http://10.5.5.204:80/;</span><br><span class="line">       &#125;</span><br><span class="line">       location ~* \.(jpg|jpeg|png)$ &#123;</span><br><span class="line">            proxy_pass http://10.5.5.205:80;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br><span class="line">* 到客户端访问www.ruopu.com/admin，这时显示的是Real Server 1，也就是web服务器上html中定义的内容，配置的意思就是，当访问admin时，就替换成web服务器根下的内容。当location中定义的是根时，这个斜线就没有意义了，因为访问的都是根</span><br></pre></td></tr></table></figure>
<h3 id="设置上传大小"><a href="#设置上传大小" class="headerlink" title="设置上传大小"></a>设置上传大小</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line">    http &#123;</span><br><span class="line">        client_max_body_size 8M;</span><br><span class="line">        # 设置上传最大8M</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面设置php上传大小</span></span><br><span class="line">vim /etc/php5/fpm/php.ini</span><br><span class="line">;This sets the maximum amount of memory in bytes that a script is allowed to allocate</span><br><span class="line">memory_limit = 32M</span><br><span class="line"> </span><br><span class="line">;The maximum size of an uploaded file.</span><br><span class="line">upload_max_filesize = 8M</span><br><span class="line"> </span><br><span class="line">;Sets max size of post data allowed. This setting also affects file upload. To upload large files, this value must be larger than upload_max_filesize</span><br><span class="line">post_max_size = 16M</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/14/阿里云数据库连接与设置阿里云RDS字符集/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/14/阿里云数据库连接与设置阿里云RDS字符集/" itemprop="url">
                  阿里云数据库连接与设置阿里云RDS字符集
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-14 13:32:44" itemprop="dateCreated datePublished" datetime="2018-09-14T13:32:44+08:00">2018-09-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-21 10:56:16" itemprop="dateModified" datetime="2018-11-21T10:56:16+08:00">2018-11-21</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="测试数据库连接"><a href="#测试数据库连接" class="headerlink" title="测试数据库连接"></a>测试数据库连接</h1><p>注：阿里云在添加白名单时，如果是内网主机，就选专有网络。因为虚拟机与阿里云RDS都使用的是专有网络。如果用外网连接数据库，就将外网的地址添加到白名单的经典网络。另外，还要注意数据库中的用户应该有从外网地址连接的权限。</p>
<p><img src="/images/aliRDS/设置白名单.jpg" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# traceroute -n -T -p 3306 rm-2zeik6f1smno.mysql.rds.aliyuncs.com</span><br><span class="line">traceroute to rm-2zeiks9o06fas81smno.mysql.rds.aliyuncs.com (0.90.0.18), 30 hops max, 60 byte packets</span><br><span class="line"> 1  * * *</span><br><span class="line"> 2  123.127.52.225  1.151 ms  1.556 ms  1.948 ms</span><br><span class="line"> 3  124.65.151.117  9.099 ms  9.282 ms  9.376 ms</span><br><span class="line"> 4  124.65.226.253  3.983 ms  4.504 ms  4.656 ms</span><br><span class="line"> 5  * * *</span><br><span class="line"> 6  * 61.51.169.69  5.301 ms *</span><br><span class="line"> 7  * * *</span><br><span class="line"> 8  * * *</span><br><span class="line"> 9  123.56.34.25  6.576 ms 101.200.109.133  5.156 ms  4.126 ms</span><br><span class="line">10  * * 123.56.34.89  4.640 ms</span><br><span class="line">11  * * *</span><br><span class="line">12  * * *</span><br><span class="line">13  * * *</span><br><span class="line">14  * * *</span><br><span class="line">15  * * *</span><br><span class="line">16  * * *</span><br><span class="line">17  * * *</span><br><span class="line">18  * * *</span><br><span class="line">19  * * *</span><br><span class="line">20  * * *</span><br><span class="line">21  * * *</span><br><span class="line">22  * * *</span><br><span class="line">23  * * *</span><br><span class="line">24  * * *</span><br><span class="line">25  * * *</span><br><span class="line">26  * * *</span><br><span class="line">27  * * *</span><br><span class="line">28  * * *</span><br><span class="line">29  * * *</span><br><span class="line">30  * * *</span><br><span class="line"><span class="meta">#</span><span class="bash">上述探测数据中，目标端口在第 11 跳之后就没有数据返回。说明相应端口在该节点被阻断。</span></span><br></pre></td></tr></table></figure>
<p>参考：<a href="https://help.aliyun.com/knowledge_detail/40572.html?spm=5176.11065259.1996646101.searchclickresult.4ffa1754h73l7T（能" target="_blank" rel="noopener">https://help.aliyun.com/knowledge_detail/40572.html?spm=5176.11065259.1996646101.searchclickresult.4ffa1754h73l7T（能</a> ping 通但端口不通时端口可用性探测说明）</p>
<h1 id="修改字符集"><a href="#修改字符集" class="headerlink" title="修改字符集"></a>修改字符集</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1. 连接数据库</span><br><span class="line">mysql -hrm-2zeiks9sm.mysql.rds.aliyuncs.com -uroot -p</span><br><span class="line">2. 查看字符集</span><br><span class="line">MySQL [(none)]&gt; show variables like '%char%';</span><br><span class="line">+--------------------------+---------------------------------------+</span><br><span class="line">| Variable_name            | Value                                 |</span><br><span class="line">+--------------------------+---------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                  |</span><br><span class="line">| character_set_connection | utf8                                  |</span><br><span class="line">| character_set_database   | utf8                                  |</span><br><span class="line">| character_set_filesystem | binary                                |</span><br><span class="line">| character_set_results    | utf8                                  |</span><br><span class="line">| character_set_server     | utf8                                  |</span><br><span class="line">| character_set_system     | utf8                                  |</span><br><span class="line">| character_sets_dir       | /u01/mysql57_20180725/share/charsets/ |</span><br><span class="line">+--------------------------+---------------------------------------+</span><br><span class="line">3. 修改字符集</span><br><span class="line">MySQL [echarging]&gt; set character_set_client=utf8mb4;</span><br><span class="line">MySQL [echarging]&gt; set character_set_connection=utf8mb4;</span><br><span class="line">MySQL [echarging]&gt; set character_set_results=utf8mb4;</span><br><span class="line">MySQL [echarging]&gt; set character_set_database=utf8mb4; </span><br><span class="line">MySQL [echarging]&gt; set character_set_server=utf8mb4;</span><br><span class="line">4. 修改character_set_server也可以在阿里云的控制台操作</span><br></pre></td></tr></table></figure>
<p><img src="/images/aliRDS/设置mysql参数1.jpg" alt="打开设置参数"></p>
<p><img src="/images/aliRDS/设置mysql参数2.jpg" alt="找到要修改的项进行修改"></p>
<p><img src="/images/aliRDS/设置mysql参数3.jpg" alt="修改后提交"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/13/阿里云Redis设置公网地址/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/阿里云Redis设置公网地址/" itemprop="url">
                  阿里云Redis设置公网地址
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-13 17:01:09" itemprop="dateCreated datePublished" datetime="2018-09-13T17:01:09+08:00">2018-09-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-21 10:55:05" itemprop="dateModified" datetime="2018-11-21T10:55:05+08:00">2018-11-21</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h1><ol>
<li>在云服务器 ECS Linux 中安装 rinetd</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.boutell.com/rinetd/http/rinetd.tar.gz&amp;&amp;tar -xvf rinetd.tar.gz&amp;&amp;cd rinetd</span><br><span class="line">sed -i 's/65536/65535/g' rinetd.c</span><br><span class="line"><span class="meta">#</span><span class="bash">修改端口范围</span></span><br><span class="line">mkdir /usr/man&amp;&amp;make&amp;&amp;make install</span><br><span class="line"><span class="meta">#</span><span class="bash">安装</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建配置文件 rinetd.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rinetd.conf</span><br><span class="line">	0.0.0.0 6379  r-ab.redis.rds.aliyuncs.com 6379</span><br><span class="line">	logfile /var/log/rinetd.log</span><br><span class="line"><span class="meta">#</span><span class="bash">第一条前半部分是本机监听的地址与端口，后半部分是阿里云Redis的地址与端口</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rinetd</span><br><span class="line">echo rinetd &gt;&gt;/etc/rc.local</span><br><span class="line"><span class="meta">#</span><span class="bash">设置开机启动</span></span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>在阿里云安全组中开放端口</li>
<li>将ESC主机加入阿里云的白名单</li>
<li>连接测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h IP</span><br><span class="line">telnet IP port</span><br><span class="line"><span class="meta">#</span><span class="bash">两种方法都可以，使用telnet连接上之后，使用quit应该可以退出。</span></span><br></pre></td></tr></table></figure>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><blockquote>
<p>rinetd是为在一个Unix和Linux操作系统中为重定向传输控制协议(TCP)连接的一个工具。rinetd是单一过程的服务器，它处理任何数量的连接到在配置文件etc/rinetd中指定的地址/端口对。尽管rinetd使用非闭锁I/O运行作为一个单一过程，它可能重定向很多连接而不对这台机器增加额外的负担。</p>
<p>使用iptables 很容易将TCP 和UDP 端口从<a href="https://baike.baidu.com/item/%E9%98%B2%E7%81%AB%E5%A2%99" target="_blank" rel="noopener">防火墙</a>转发到内部主机上。但是如果您需要将流量从专用地址转发到甚至不在您当前网络上的机器上，又该怎么办呢？可尝试另一个应用层<a href="https://baike.baidu.com/item/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91" target="_blank" rel="noopener">端口转发</a>程序，如rinetd。</p>
<p>这些代码有点古老，但很短小、高效，对于解决这种问题来说是非常完美的。</p>
<p>参考：<a href="https://baike.baidu.com/item/rinted/2590570" target="_blank" rel="noopener">https://baike.baidu.com/item/rinted/2590570</a></p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/13/nginx功能测试一/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/nginx功能测试一/" itemprop="url">
                  nginx功能测试一
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-13 14:55:07" itemprop="dateCreated datePublished" datetime="2018-09-13T14:55:07+08:00">2018-09-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-09-29 16:25:42" itemprop="dateModified" datetime="2018-09-29T16:25:42+08:00">2018-09-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="CPU绑定"><a href="#CPU绑定" class="headerlink" title="CPU绑定"></a>CPU绑定</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ps axo user,comm,pid,psr,pcpu | grep nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">查看进程运行在哪个CPU上，显示的最后一个数字就是指第几颗CPU上。这个命令是查看进程的名称、PID以及CPU的占用率。psr表示绑定内核线程的处理器（如果有）的逻辑处理器号。 对一个进程来说，如果它的线程全都绑定到同一处理器上，那么显示该字段。pcpu表示CPU的占用率。comm表示进程名称。pid表示进程的ID号</span></span><br><span class="line">watch -n.5 'ps axo comm,pid,psr | grep nginx'</span><br><span class="line">yum install httpd-tools</span><br><span class="line">ab -n 100000 -c 100 http://IP/index.html</span><br><span class="line"><span class="meta">#</span><span class="bash">这时可以看到上面监测的绑定CPU数字在变化，因为CPU与进程没有绑定</span></span><br><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">这时在配置文件中加入绑定设置，定义在全局段</span></span><br><span class="line">	worker_cpu_affinity auto;</span><br><span class="line"><span class="meta">	#</span><span class="bash">自动绑定CPU</span></span><br><span class="line">	worker_rlimit_nofile 65536;</span><br><span class="line"><span class="meta">	#</span><span class="bash">如果不加入worker打开文件数量的上限，检查语法时会有报错，提示最多打开1024。定义在全局段</span></span><br><span class="line">	worker_priority -5;</span><br><span class="line"><span class="meta">	#</span><span class="bash">调整优先级</span></span><br><span class="line">watch -n.5 'ps axo comm,pid,psr,ni | grep nginx'</span><br><span class="line"><span class="meta">#</span><span class="bash">可以看到优先级改为了-5</span></span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br><span class="line">vim /etc/hosts</span><br><span class="line">	192.168.1.15 www.ruopu.com</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">ab -n 100000 -c 100 http://IP/index.html</span><br><span class="line"><span class="meta">#</span><span class="bash">这时监测页面的CPU数字是不会变化的，因为已经绑定了，显示的内容中第一个是主控进程，只看后四个即可</span></span><br><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line">    worker_cpu_affinity 1000 0100 0010 0001;</span><br><span class="line">    #绑定第0到3颗CPU，因为CPU是四核的。这时监测页面显示绑定在0－3的CPU上</span><br><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line">    worker_processes 2;</span><br><span class="line">    worker_cpu_affinity 1000 0100;</span><br><span class="line">nginx -s reload</span><br><span class="line"><span class="meta">#</span><span class="bash">再查看监测页面，这里只绑定在2颗CPU上</span></span><br></pre></td></tr></table></figure>
<h1 id="设置访问权限"><a href="#设置访问权限" class="headerlink" title="设置访问权限"></a>设置访问权限</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 80;</span><br><span class="line">		server_name www.ruopu.com;</span><br><span class="line">		root /data/nginx/vhost1;</span><br><span class="line">		location / &#123;</span><br><span class="line">			deny 192.168.1.22;</span><br><span class="line">			allow all;</span><br><span class="line"><span class="meta">#</span><span class="bash">location定义对根及以下的路径的访问拒绝22地址访问，allow也一样，可以用一个地址或一个网段/24或all</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">nginx -s reload</span><br><span class="line">访问IP</span><br><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 80;</span><br><span class="line">		server_name www.ruopu.com;</span><br><span class="line">		root /data/nginx/vhost1;</span><br><span class="line">		location ~* \.(jpg|png) &#123;</span><br><span class="line">			deny 192.168.1.22;</span><br><span class="line">			allow all;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">//对目录中的jpg或png文件，拒绝22地址访问。location中定义的地址是在root定义的地址的下面的路径</span><br><span class="line">nginx -s reload</span><br><span class="line">find /usr/share -iname "*.jpg" -exec cp &#123;&#125; /data/nginx/vhost1 \;</span><br><span class="line">访问测试,www.ruopu.com/morning.jpg</span><br><span class="line">如果location中定义了root，那么以location中的root为准</span><br><span class="line">=====================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash">在一个server中location配置段可存在多个，用于实现从uri到文件系统的路径映射；ngnix会根据用户请求的URI来检查定义的所有location，并找出一个最佳匹配，而后应用其配置；</span></span><br><span class="line"></span><br><span class="line">location [ = | ~ | ~* | ^~ ] uri &#123; ... &#125;</span><br><span class="line">Sets configuration depending on a request URI.</span><br><span class="line">	=：对URI做精确匹配；例如, http://www.magedu.com/, http://www.magedu.com/index.html，如果等于根，那么就只有根被匹配，如果没有等号，那么从根以下的所有路径都匹配。</span><br><span class="line">	location  =  / &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">    ~：对URI做正则表达式模式匹配，区分字符大小写；</span><br><span class="line">    ~*：对URI做正则表达式模式匹配，不区分字符大小写；</span><br><span class="line">    ^~：对URI的左半部分做匹配检查，不区分字符大小写；也就是以什么开头</span><br><span class="line">    不带符号：匹配起始于此uri的所有的url；</span><br><span class="line">    匹配优先级：=, ^~, ～/～*，不带符号；</span><br></pre></td></tr></table></figure>
<h1 id="定义别名"><a href="#定义别名" class="headerlink" title="定义别名"></a>定义别名</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/pictures</span><br><span class="line">cp fish.jpg /data/pictures</span><br><span class="line">vim conf.d/vhost1.conf</span><br><span class="line">	location ^~ /images/ &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash">^~是指以其后设定的内容开头的，但这里没有什么用</span></span><br><span class="line">		root /data/pictures；</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">这时访问www.ruopu.com/images/fish.jpg提示404，上面定义的应该是在pictures中找images目录，然后再找文件。/data/pictures就相当于根，在根下再打开images目录</span></span><br><span class="line">mkdir /data/pictures/images</span><br><span class="line">mv /data/pictures/*.jpg /data/pictures/images</span><br><span class="line">访问www.ruopu.com/images/flower.jpg</span><br><span class="line">vim conf.d/vhost1.conf</span><br><span class="line">    location ^~ /images/ &#123;</span><br><span class="line">	    alias /data/pictures/；</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">将root改为<span class="built_in">alias</span>。别名中的pictures右边的斜线是相对于images右侧的斜线来说的。所以，上面别名/data/pictures/最右边的斜线一定不能少，不然就不能访问到。</span></span><br><span class="line">nginx -s reload</span><br><span class="line">访问www.ruopu.com/images/fish.jpg才有，flower.jpg是访问不到的。因为在pictures中只有fish.jpg文件，没有flower.jpg文件。root是对于左侧的斜线，alias是对于最右侧的斜线来说的。</span><br></pre></td></tr></table></figure>
<h1 id="自定义错误页"><a href="#自定义错误页" class="headerlink" title="自定义错误页"></a>自定义错误页</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">    server &#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       server_name www.ruopu.com;</span><br><span class="line">       root /data/nginx/vhost1;</span><br><span class="line">       location ~* \.(jpg|png) &#123;</span><br><span class="line">       error_page 404 =200 /notfound.html;</span><br><span class="line"><span class="meta">#</span><span class="bash">notfound.html是URL的地址，它的位置是root定义的，因为加了等于200，所以这改变了状态码，在浏览器中按F12时可以看到是200了。测试使用等于200的设置会提示错误的值，原因是在200与其前面的等号中间加了空格，去掉空格就正常了。notfound.html应该是自定义的名字，但定义的名字与location指定的名字，与root定义的目录中的*.html文件的名字，这三个名字要一致，不然访问不了。error_page定义一次即可，这里只是展现了两种方法。</span></span><br><span class="line">       error_page 404 /notfound.html;</span><br><span class="line">       location = /notfound.html &#123;</span><br><span class="line">            root /data/nginx/error_pages;</span><br><span class="line">       &#125;</span><br><span class="line">       location ^~ /images/ &#123;</span><br><span class="line">            alias /data/pictures/;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">mkdir /data/nginx/error_pages</span><br><span class="line">vim /data/nginx/error_pages/notfound.html</span><br><span class="line">	404</span><br><span class="line">nginx -s reload</span><br><span class="line">访问www.ruopu.com/test.html，这是一个不存在的页面</span><br></pre></td></tr></table></figure>
<h1 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd-tools</span><br><span class="line">htpasswd -c -m /etc/nginx/.ngxpasswd tom</span><br><span class="line">htpasswd -m /etc/nginx/.ngxpasswd jerry</span><br><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">    server &#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       server_name www.ruopu.com;</span><br><span class="line">       root /data/nginx/vhost1;</span><br><span class="line">       error_page 404 /notfound.html;</span><br><span class="line">       location = /notfound.html &#123;</span><br><span class="line">            root /data/nginx/error_pages;</span><br><span class="line">       &#125;</span><br><span class="line">       location ^~ /images/ &#123;</span><br><span class="line">            alias /data/pictures/;</span><br><span class="line">       &#125;</span><br><span class="line">       location ~* ^/(admin|login) &#123;</span><br><span class="line">       #~*做正则表达式模式匹配，如果以admin或login开头，就进行认证。当然，这也要求在vhost1中有这个目录才行。</span><br><span class="line">            auth_basic "admin area or login url";</span><br><span class="line">            #使用ngx_http_auth_basic_module模块实现基于用户的访问控制，使用basic机制进行用户认证；"admin area or login url"是一段自定义提示信息。</span><br><span class="line">            auth_basic_user_file /etc/nginx/.ngxpasswd;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">mkdir /data/nginx/vhost1/admin</span><br><span class="line">vim /data/nginx/vhost1/admin/index.html</span><br><span class="line">	admin aera</span><br><span class="line">nginx -s reload</span><br><span class="line">访问www.ruopu.com/admin，如果访问的是www.ruopu.com/login就会失败，因为在vhost1中没有login目录。</span><br></pre></td></tr></table></figure>
<h1 id="状态页"><a href="#状态页" class="headerlink" title="状态页"></a>状态页</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">    location /ngxstatus &#123;</span><br><span class="line">    #这里的ngxstatus也是自定义的名称，定义什么名字，访问时就用什么名字</span><br><span class="line">        stub_status;</span><br><span class="line">        #stub_status是一个系统变量</span><br><span class="line">    &#125;</span><br><span class="line">    #ngxstatus是自定义名称，还可以在其中加认证或allow、deny。location后面定义的是URL名，也是路径名</span><br><span class="line">nginx -s reload</span><br><span class="line">访问www.ruopu.com/ngxstatus。</span><br><span class="line">curl --silent http://www.ruopu.com/ngxstatus | awk '^Active/&#123;print $3&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash">测试此条命令后的awk用法有问题，在^Active上。</span></span><br></pre></td></tr></table></figure>
<h1 id="压缩功能"><a href="#压缩功能" class="headerlink" title="压缩功能"></a><strong>压缩功能</strong></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/nginx.conf    </span><br><span class="line">    http &#123;</span><br><span class="line">        gzip on;</span><br><span class="line">        gzip_min_length 1k;</span><br><span class="line">        #不压缩临界值，大于1K的才压缩，一般不用改</span><br><span class="line">        gzip_buffers 4 16k;</span><br><span class="line">        #支持实现压缩功能时为其配置的缓冲区数量及每个缓存区的大小；</span><br><span class="line">        gzip_comp_level 6;</span><br><span class="line">        #压缩级别，1-10，数字越大压缩的越好，时间也越长</span><br><span class="line">        gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;</span><br><span class="line">        #进行压缩的文件类型，缺啥补啥就行了，JavaScript有两种写法，最好都写上吧，总有人抱怨js文件没有压缩，其实多写一种格式就行了</span><br><span class="line">        gzip_disable "MSIE [1-6]\.";</span><br><span class="line">        #IE6对Gzip不怎么友好，不给它Gzip了</span><br><span class="line">    &#125;                    </span><br><span class="line">nginx -s reload</span><br><span class="line">cp nginx.conf /data/nginx/vhost1/nginx.html</span><br><span class="line">chmod +r /data/nginx/vhost1/nginx.html</span><br><span class="line">curl -I -H "Accept-Encoding: gzip, deflate" "http://www.ruopu.com/images/morning.jpg"</span><br><span class="line"><span class="meta">#</span><span class="bash">如果对访问的内容进行了压缩，在结果中会有Content-Encoding: gzip的字样。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/13/nginx安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/nginx安装/" itemprop="url">
                  nginx安装
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-13 14:44:16" itemprop="dateCreated datePublished" datetime="2018-09-13T14:44:16+08:00">2018-09-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-12 10:45:50" itemprop="dateModified" datetime="2018-10-12T10:45:50+08:00">2018-10-12</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="rpm包安装"><a href="#rpm包安装" class="headerlink" title="rpm包安装"></a>rpm包安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">    [nginx]</span><br><span class="line">    name=nginx repository</span><br><span class="line">    baseurl=http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">    gpgcheck=0</span><br><span class="line">    enabled=1</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##自建repo文件或用以下命令；如果是CentOS6上安装nginx，就将上面源地址中的7改为6就可以了。也可以下载安装http://http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm。另外，在CentOS6上如果要安装nginx，还要将openssl升级到1.0.2版本以上。到https://www.openssl.org/source/openssl-1.0.2h.tar.gz下载，之后编译安装</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##如果提示需要公钥验证，需要执行此命令rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span></span></span><br><span class="line">rpm -ivh https://mirrors.ustc.edu.cn/epel/epel-release-latest-7.noarch.rpm</span><br><span class="line">------------------------------------------------------------------------------------</span><br><span class="line">rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span><br><span class="line">//此命令安装后也会自建一个叫nginx.repo的源</span><br><span class="line">yum repolist</span><br><span class="line">yum info nginx</span><br><span class="line">yum install nginx</span><br><span class="line">------------------------------------------------------------------------------------</span><br><span class="line">yum install epel-release -y</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##也可以用yum安装epel-release包得到epel仓库。也可以安装epel库来安装nginx，这样安装nginx后会自动配置配色方案</span></span></span><br><span class="line"></span><br><span class="line">注：nginx配置文件默认没有配色，使用下面方法解决</span><br><span class="line">mkdir -pv ~/.vim/syntax</span><br><span class="line">cd ~/.vim/syntax</span><br><span class="line">wget http://www.vim.org/scripts/download_script.php?src_id=14376 -O nginx.vim</span><br><span class="line">vim ~/.vim/filetype.vim</span><br><span class="line">	au BufRead,BufNewFile /etc/nginx/* set ft=nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##其中路径为你的nginx.conf文件路径</span></span></span><br></pre></td></tr></table></figure>
<h1 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">yum install zlib-devel pcre-devel</span><br><span class="line">yum groupinstall "开发工具"</span><br><span class="line">tar nginx-1.12.2.tar.gz</span><br><span class="line">cd nginx-1.12.2</span><br><span class="line">./configure --with-pcre --with-zlib</span><br><span class="line">/usr/local/nginx/sbin/nginx     </span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##启动</span></span></span><br><span class="line">/usr/local/nginx/sbin/nginx -s reload    </span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##重启</span></span></span><br><span class="line">/usr/local/nginx/sbin/nginx -s stop    </span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##关闭</span></span></span><br><span class="line">vim /usr/lib/systemd/system/nginx.service</span><br><span class="line">    [Unit]</span><br><span class="line">        Description=Nginx Service</span><br><span class="line">    [Service]</span><br><span class="line">        Type=forking</span><br><span class="line">        PIDFile=/usr/local/nginx/logs/nginx.pid</span><br><span class="line">        ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">        ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">        ExecStop=/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##实现systemd管理nginx</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##这里一定要注意PIDFile的路径，在/usr/local/nginx/conf/nginx.conf配置文件中，默认pid文件放在/usr/local/nginx/logs中，如果写错路径，nginx是无法启动的，报错为：PID file /run/nginx.pid not readable (yet?) after start.</span></span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/13/nginx配置文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/nginx配置文件/" itemprop="url">
                  nginx配置文件说明
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-13 12:45:47" itemprop="dateCreated datePublished" datetime="2018-09-13T12:45:47+08:00">2018-09-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-09-17 09:09:34" itemprop="dateModified" datetime="2018-09-17T09:09:34+08:00">2018-09-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="nginx配置文件"><a href="#nginx配置文件" class="headerlink" title="nginx配置文件"></a>nginx配置文件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件中的include出现了多次，在全局中和http、server中都有</span></span><br><span class="line">	user nginx;</span><br><span class="line"><span class="meta">	#</span><span class="bash">进程以哪个用户的身份运行</span></span><br><span class="line">	worker_proceseese auto;</span><br><span class="line"><span class="meta">	#</span><span class="bash">配置工作进程数的，auto指自动探测主机的物理核心数，并启动与核心数一样的进程数。或输入数字。这里只能是等于或小于物理核心数</span></span><br><span class="line">	error_log	/var/log/nginx/error.log;</span><br><span class="line"><span class="meta">	#</span><span class="bash">错误日志位置</span></span><br><span class="line">	pid		/run/nginx.pid;</span><br><span class="line"><span class="meta">	#</span><span class="bash">进程id</span></span><br><span class="line">	worker_cpu_affinity auto;</span><br><span class="line"><span class="meta">	#</span><span class="bash">自动绑定cpu，如果当前主机只运行nginx就非常有效，如果有其他服务，如mysql，就不要做了</span></span><br><span class="line">	include	/usr/share/nginx/modules/*.conf;</span><br><span class="line"><span class="meta">	#</span><span class="bash">装载需要的模块的位置。模块位置在/usr/share/nginx/modules中，其中的mod-http-geoip.conf是根据IP地址查询其所在的位置的</span></span><br><span class="line">	events&#123;</span><br><span class="line">		use   epoll;             </span><br><span class="line"><span class="meta">		#</span><span class="bash">epoll是多路复用IO(I/O Multiplexing)中的一种方式,但是仅用于linux2.6以上内核,可以大大提高nginx的性能</span></span><br><span class="line">		worker_connections 1024；</span><br><span class="line"><span class="meta">		#</span><span class="bash">配置事件驱动模型的，这里默认是单进程响应1024个请求。worker_proceseese乘以这里的worker_connections就是一共可以并发响应的总数。如果不够可以将1024改大，但不要随便改</span></span><br><span class="line">	&#125;</span><br><span class="line">	http &#123;</span><br><span class="line">		log_format 	main	'$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      		'$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      		'"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"><span class="meta">		#</span><span class="bash">日志格式，main是名称，之后使用的是nginx的内置变量，官方文档中有对变量的解释</span></span><br><span class="line">		access_log	/var/log/nginx/access.log  main;</span><br><span class="line"><span class="meta">		#</span><span class="bash">访问日志位置及格式</span></span><br><span class="line">		sendfile	on;</span><br><span class="line"><span class="meta">		#</span><span class="bash">提升性能的配置，从内核直接响应用户。sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，对于普通应用，必须设为 on,如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，以平衡磁盘与网络I/O处理速度，降低系统的uptime.</span></span><br><span class="line">		tcp_nopush	on;</span><br><span class="line">		tcp_nodelay	on;</span><br><span class="line"><span class="meta">		#</span><span class="bash">也是提升性能的</span></span><br><span class="line">		keepalive_tiomout 65;</span><br><span class="line"><span class="meta">		#</span><span class="bash">保持长连接，超时65秒</span></span><br><span class="line">		types_hash_max_size 2048;</span><br><span class="line"><span class="meta">		#</span><span class="bash">types_hash_max_size 影响散列表的冲突率。types_hash_max_size越大，就会消耗更多的内存，但散列key的冲突率会降低，检索速度就更快。types_hash_max_size越小，消耗的内存就越小，但散列key的冲突率可能上升。</span></span><br><span class="line">		include		/etc/nginx/mime.types;</span><br><span class="line">		default_type	application/octet-stream;</span><br><span class="line"><span class="meta">		#</span><span class="bash">让nginx知道支持哪些类型。设定mime类型,类型由mime.type文件定义</span></span><br><span class="line">		include /etc/nginx/conf.d/*.conf</span><br><span class="line"><span class="meta">		#</span><span class="bash">启动要加载的配置，如虚拟主机</span></span><br><span class="line">        server &#123;</span><br><span class="line">            listen 80 default_server;</span><br><span class="line">            #监听端口，default_server表示默认虚拟主机，如根据主机名访问，如果都不匹配，那么就找第一个虚拟主机。也就是所有匹配不到的虚拟主机，都由默认虚拟主机响应</span><br><span class="line">            listen [::]:80	default_server;</span><br><span class="line">            #这是IPV6的地址</span><br><span class="line">            server_name _;</span><br><span class="line">            #对默认虚拟主机来说，下划线可以匹配所有主机名</span><br><span class="line">            root	/usr/share/nginx/html;</span><br><span class="line">            #定义默认网页和路径的</span><br><span class="line">            location / &#123;</span><br><span class="line">            #location指明个人的配置</span><br><span class="line">            &#125;</span><br><span class="line">            error_page 404 /404.html</span><br><span class="line">                #自定义404错误页是什么</span><br><span class="line">                location = /40x.html &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            error_page 500 502 503 504 /50x.html;</span><br><span class="line">                location = /50x.html &#123;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/12/nginx程序架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/12/nginx程序架构/" itemprop="url">
                  nginx程序架构
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-12 15:32:59" itemprop="dateCreated datePublished" datetime="2018-09-12T15:32:59+08:00">2018-09-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-12 10:46:20" itemprop="dateModified" datetime="2018-10-12T10:46:20+08:00">2018-10-12</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&emsp;&emsp;nginx是一个模块化的、事件驱动的、异步，单线程的、非阻断的服务。nginx启动后会有master与worker进程，master进程只有一个，负责加载和分析配置文件、管理worker进程、平滑升级。worker进程有一个或多个，负责处理并响应用户请求。</p>
<p><img src="http://static.oschina.net/uploads/img/201212/11163331_QmZ1.png" alt=""></p>
<h1 id="worker模型"><a href="#worker模型" class="headerlink" title="worker模型"></a>worker模型</h1><p>&emsp;&emsp;nginx并不为每个连接产生一个进程或线程。工作进程从一个共享的“listen”socket接受新的请求，每个worker内运行循环高效执行。每个worker处理数以千计的连接。在启动时，一组初始的监听套接字被创建。当处理HTTP请求和响应时，worker不断接受，读取和写入到socket。</p>
<p>&emsp;&emsp;nginx的worker代码的运行循环是最复杂的部分。它包括全部的内部调用，并在很大程度上依赖于异步处理任务的想法。异步操作通过模块化，事件通知，广泛使用回调函数和微调定时器实现。总体而言，关键的原则是尽可能的非阻塞。 唯一可以让nginx阻塞的情形是，没有足够的磁盘存储供worker操作。</p>
<p>&emsp;&emsp;由于nginx并不会为每个连接产生新的进程或线程，内存使用在绝大多数情况下是非常保守的，效率非常高。 nginx节省CPU周期，因为没有持续的进程或线程的创建销毁模式。nginx要做的是检查网络和存储的状态，初始化新的连接，将它们添加到运行循环，处理直到完成，此时连接被释放，从运行循环中移除。谨慎使用系统调用和准确实现支持接口，如poll和slab内存分配器相结合，nginx通常达到中度至低CPU占用率，即使在极端恶劣的工作负载环境下。</p>
<p>&emsp;&emsp;由于nginx可以产生数个worker进程处理连接，在多核上扩展性很好。一般情况下，每核一个单独的worker可以充分利用多核架构，并防止线程的波动和锁定。隔离的单线程worker进程没有资源匮乏和资源控制机制。该模型还允许在物理存储设备上的可扩展性，有利于更好的磁盘利用率，避免了磁盘I / O阻塞。所以，一些资源在几个worker之间共享可以更有效的被利用</p>
<p>&emsp;&emsp;在磁盘和CPU的负载模式中，nginx的worker数目应该进行相应的调整。这里有一些基本规则，系统管理员应该根据负载量尝试几种配置。以下的是一般建议内容：如果负载模式是CPU密集的情况下，处理大量的TCP / IP，做SSL，压缩，nginx的worker的数量和CPU核的数量应该相匹配；如果负载主要是磁盘I / O范畴的情况下，从储存提供不同的内容，或繁忙的代理。worker的数量可以是一个半到两个核。与之相反的是，一些工程师选择worker的数量是基于独立存储单元的数量，但这种方法的效率取决于磁盘存储的类型和配置。</p>
<h1 id="Nginx进程的作用"><a href="#Nginx进程的作用" class="headerlink" title="Nginx进程的作用"></a>Nginx进程的作用</h1><p>&emsp;&emsp;nginx在内存中运行多个进程。有一个主进程和多个worker进程。此外，还有一些特殊用途的进程，特别是高速缓存加载器和高速缓存管理器。在nginx的1.x版本中所有的进程都是单线程。所有进程主要使用共享内存的进程间通信机制。主进程以root用户运行。缓存加载器，缓存管理器和worker作为一个非特权用户运行。</p>
<p>&emsp;主进程负责执行以下任务：</p>
<ul>
<li>读取并验证配置</li>
<li>创建，绑定和关闭套接字</li>
<li>启动，终止和维护配置的工作进程数</li>
<li>不中断服务的情况下重新配置</li>
<li>控制不停止服务的二进制升级（如有必要，启动新的二进制程序和回滚）</li>
<li>重新打开日志文件</li>
<li>编译嵌入式的Perl脚本</li>
</ul>
<p>&emsp;&emsp;worker进程接受，处置和处理来自客户端的连接，提供反向代理和过滤功能，做nginx能力范围之内的所有事情。<font color="red">关于监测nginx的实例的动态，系统管理员应该留意worker，因为他们是反映了Web服务器的实际日常操作的进程。</font></p>
<p>&emsp;&emsp;缓存加载器进程负责检查磁盘上的缓存项和使用高速缓存元数据填充Nginx在内存中的数据库。从本质上讲，缓存加载器可以帮助nginx和文件协同工作，一个已经专门分配存储在磁盘上的目录结构。它遍历目录，检查缓存内容，元数据，更新共享内存中的相关条目，当一切都干净并准备投入使用时，它会退出。</p>
<p>&emsp;&emsp;高速缓存管理器主要是负责缓存过期和失效。在正常nginx的操作过程中它驻留在内存中，在失败的情况下，它被主进程重新启动。</p>
<h1 id="Nginx的缓存的简要概述"><a href="#Nginx的缓存的简要概述" class="headerlink" title="Nginx的缓存的简要概述"></a>Nginx的缓存的简要概述</h1><p>&emsp;&emsp;Nginx的缓存是以分层数据存储的形式在一个文件系统中实现的。缓存键是可配置的，不同请求的目的参数可以用来控制哪些参数可以进入高速缓存中。高速缓存键和缓存元数据存储在共享内存段，从而缓存加载器、缓存管理器和worker都可以访问。没有任何文件缓存在内存中，只有操作系统的虚拟文件系统机制方面的优化。每个高速缓存的响应被放置在文件系统上的不同文件。通过nginx的配置指令控制的层次结构（层次和命名的详细信息）。当一个响应被写入到高速缓存的目录结构，路径和文件的文件名是来自代理URL的MD5哈希。</p>
<p>&emsp;&emsp;放置在高速缓存中的内容的过程如下所示：当nginx从上游服务器读取响应，内容首先被写入到高速缓存的目录结构以外的一个临时文件。当nginx完成处理请求时，临时文件重命名，并被移动到缓存目录中。如果临时文件目录代理是在另一个文件系统上，该文件将被复制，因此建议临时文件和缓存目录保持在同一个文件系统。需要显式地清除，从缓存目录结构删除文件是比较安全的。</p>
<h1 id="HTTP请求处理过程"><a href="#HTTP请求处理过程" class="headerlink" title="HTTP请求处理过程"></a>HTTP请求处理过程</h1><ol>
<li>客户端发送HTTP请求。</li>
<li>nginx的核心段根据所配置的location选择合适匹配请求的处理程序。</li>
<li>如果配置要求这样做，负载平衡器为代理挑选一个上游服务器（或“后端”）。</li>
<li>阶段处理程序执行它的工作，并传递每个输出缓冲器到所述第一滤波器。</li>
<li>第一滤波器的输出传递到所述第二过滤器。</li>
<li>第二滤波器的输出到第三个（等等）。</li>
<li>最终的响应被发送到客户端。</li>
</ol>
<p>参考：<a href="https://my.oschina.net/daleshen128/blog/95130" target="_blank" rel="noopener">https://my.oschina.net/daleshen128/blog/95130</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/12/修改tomcat默认页面/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/12/修改tomcat默认页面/" itemprop="url">
                  修改tomcat默认页面
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-12 12:50:03 / 修改時間：13:09:51" itemprop="dateCreated datePublished" datetime="2018-09-12T12:50:03+08:00">2018-09-12</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tomcat/" itemprop="url" rel="index"><span itemprop="name">tomcat</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>修改tomcat的默认页面为自己的主页，再使用nginx反代到tomcat。实现访问域名即可打开主页。</p>
</blockquote>
<ul>
<li>tomcat</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/tomcat/conf/server.xml</span><br><span class="line">	&lt;Host name="localhost"  appBase="webapps"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line">        &lt;Context path="" docBase="echarge" reloadable="true" /&gt;</span><br><span class="line">//在Host下面加入Context一行，设置path为空，这样就不会访问到默认页了。之后用docBase指定主页的路径，这里写echarge表示是在webapps下的echarge目录。reloadable表示是否自动装载。</span><br><span class="line">/usr/local/tomcat/bin/shutdown.sh</span><br><span class="line">/usr/local/tomcat/bin/startup.sh</span><br><span class="line">//此例中已将主机的IP地址解析为域名了，另外tomcat监听在8081端口。这时可以通过"域名:8081"访问到主页了。</span><br></pre></td></tr></table></figure>
<ul>
<li>nginx</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/conf.d/web.conf</span><br><span class="line">	proxy_cache_path /etc/nginx/cache levels=1:2:2 keys_zone=web_cache:10m max_size=2g;</span><br><span class="line">    server&#123;</span><br><span class="line">       server_name web.jdyichong.com;</span><br><span class="line">       index index.html index.htm;</span><br><span class="line">       charset utf-8;</span><br><span class="line">       proxy_cache web_cache;</span><br><span class="line">       proxy_cache_key $request_uri;</span><br><span class="line">       proxy_cache_methods GET HEAD;</span><br><span class="line">       proxy_cache_min_uses 1;</span><br><span class="line">       proxy_cache_valid 200 302 10m;</span><br><span class="line">       proxy_cache_valid 400 1m;</span><br><span class="line">       proxy_cache_use_stale http_502;</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">            proxy_pass http://web.jdyichong.com:8081;</span><br><span class="line">            //这里只要将所有访问都反代到本机的tomcat上即可。</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">//用nginx加入缓存设置，之后反向代理到本机的tomcat上，这样使用域名即可访问到主页了。</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/25/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><span class="page-number current">26</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/27/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">265</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">185</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
