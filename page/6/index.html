<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/6/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/10/python基础学习-argparse模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/10/python基础学习-argparse模块/" itemprop="url">
                  python基础学习-argparse模块
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-10 10:19:41" itemprop="dateCreated datePublished" datetime="2020-01-10T10:19:41+08:00">2020-01-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="argparse模块"><a href="#argparse模块" class="headerlink" title="argparse模块"></a>argparse模块</h3><p>一个可执行文件或者脚本都可以接收参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ls -l /etc</span><br><span class="line"><span class="comment"># /etc 是位置参数</span></span><br><span class="line"><span class="comment"># -l 是短选项</span></span><br></pre></td></tr></table></figure>
<p>如果把这些参数传递给程序呢？</p>
<p>从3.2 开始Python提供了参数分析的模块 <code>argparse</code></p>
<h3 id="参数分类"><a href="#参数分类" class="headerlink" title="参数分类"></a>参数分类</h3><p>参数分为：</p>
<p>位置参数，参数放在那里，就要对应一个参数位置。例如/etc就是对应一个参数位置。</p>
<p>选项参数，必须通过前面是<code>-</code>的短选项或者 <code>--</code>的长选项，然后后面的才算它的参数，当然短选项后面也可以没有参数。</p>
<p>上例中，<code>/etc</code>对应的是位置参数，<code>-l</code>是选项参数。</p>
<p><code>ls -alh src</code></p>
<h3 id="基本解析"><a href="#基本解析" class="headerlink" title="基本解析"></a>基本解析</h3><p>先来一段最简单的程序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser()   <span class="comment"># 一个参数解析器</span></span><br><span class="line">args = parser.parse_args()   <span class="comment"># 分析参数</span></span><br><span class="line">parser.print_help()   <span class="comment"># 打印帮助</span></span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python test.py -h</span><br><span class="line">usage: test1.py [-h]</span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help  show this help message <span class="keyword">and</span> exit</span><br></pre></td></tr></table></figure>
<p>argparse不仅仅做了参数的定义和解析，还自动帮助生成了帮助信息。尤其是usage，可以看到现在定义的参数是否是自己想要的。</p>
<h3 id="解析器的参数"><a href="#解析器的参数" class="headerlink" title="解析器的参数"></a>解析器的参数</h3><table>
<thead>
<tr>
<th>参数名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>prog</td>
<td>程序的名字，缺省使用sys.argv[0]</td>
</tr>
<tr>
<td>add_help</td>
<td>自动为解析器增加 -h 和 –help 选项，默认为True</td>
</tr>
<tr>
<td>description</td>
<td>为程序功能添加描述</td>
</tr>
</tbody>
</table>
<p><code>parser = argparse.ArgumentParser(prog=&#39;ls&#39;,add_help=True,description=&#39;list directory contents&#39;)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ python test.py --help</span><br><span class="line">usage: ls[-h]</span><br><span class="line"></span><br><span class="line">list directory contents</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help show this help message <span class="keyword">and</span> exit</span><br></pre></td></tr></table></figure>
<h3 id="位置参数解析"><a href="#位置参数解析" class="headerlink" title="位置参数解析"></a>位置参数解析</h3><p>ls 基本功能应该解决目录内容的打印。</p>
<p>打印的时候应该指定目录路径，需要位置参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得一个参数解析器</span></span><br><span class="line">parser = argparse.ArgumentParser(prog=<span class="string">'1s'</span>,add_help=<span class="keyword">True</span>,descriptio=<span class="string">'list directory contents'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'path'</span>)</span><br><span class="line">args = parser.parse_args()   <span class="comment"># 分析参数</span></span><br><span class="line"><span class="comment"># 这里需要传给parse_args()一个可迭代对象，查看parse_args()的源码可以看到这个设置</span></span><br><span class="line"><span class="comment"># 通过 parse_args() 方法解析参数。它将检查命令行，把每个参数转换为适当的类型然后调用相应的操作。在大多</span></span><br><span class="line"><span class="comment"># 数情况下，这意味着一个简单的 Namespace 对象将从命令行参数中解析出的属性构建。在脚本中，通常 </span></span><br><span class="line"><span class="comment"># parse_args() 会被不带参数调用，而 ArgumentParser 将自动从 sys.argv 中确定命令行参数。</span></span><br><span class="line"><span class="comment"># 这里Namespace对象构建的就是parser.add_argument()定义的参数是否被引用</span></span><br><span class="line">parser.print_help()   <span class="comment"># 打印帮助</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">usage: ls [-h] path</span><br><span class="line">ls: error: the following arguments are required: path</span><br></pre></td></tr></table></figure>
<p>程序等定义为：</p>
<p><code>ls [-h] path</code></p>
<p>-h 为帮助，可有可无</p>
<p>path为位置参数，必须提供</p>
<h3 id="传参"><a href="#传参" class="headerlink" title="传参"></a>传参</h3><p><code>parse_args(args=None,namespace=None)</code></p>
<p>args 参数列表，一个可迭代对象。内部会把可迭代对象转换成list。如果为None则使用命令行传入参数，非None则使用args参数的可迭代对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得一个参数解析器</span></span><br><span class="line">parser = argparse.ArgumentParser(prog=<span class="string">'ls'</span>,add_help=<span class="keyword">True</span>,description=<span class="string">'list directory contents'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'path'</span>)   <span class="comment"># 位置参数</span></span><br><span class="line"></span><br><span class="line">args = parser.parse_args((<span class="string">'/etc'</span>,))   <span class="comment"># 分析参数，同时传入可迭代的参数</span></span><br><span class="line">print(args)   <span class="comment"># 打印名词空间中收集的参数</span></span><br><span class="line">parser.print_help()   <span class="comment"># 打印帮助</span></span><br><span class="line"></span><br><span class="line">运行结果</span><br><span class="line">Namespace(path=<span class="string">'/etc'</span>)</span><br><span class="line">usage: ls [-h] path</span><br><span class="line">    </span><br><span class="line">list directory contents</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">    path</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help show this help message <span class="keyword">and</span> exit</span><br></pre></td></tr></table></figure>
<p>Namespace(path=’/etc’)里面的path参数存储在了一个Namespace对象内的属性上，可以通过Namespace对象属性来访问，例如args.path</p>
<h3 id="非必须位置参数"><a href="#非必须位置参数" class="headerlink" title="非必须位置参数"></a>非必须位置参数</h3><p>上面的代码必须输入位置参数，否则会报错。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usage: ls [-h] path</span><br><span class="line">ls: error: the following arguments are required: path</span><br></pre></td></tr></table></figure>
<p>但有时候，ls 命令不输入任何路径的话就表示列出当前目录的文件列表。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得一个参数解析器</span></span><br><span class="line">parser = argparse.ArgumentParser(prog=<span class="string">'ls'</span>,add_help=<span class="keyword">True</span>,description=<span class="string">'list directory contents'</span>)</span><br><span class="line"><span class="comment"># prog：默认情况下，ArgumentParser 对象使用 sys.argv[0] 来确定如何在帮助消息中显示程序名称。这一默</span></span><br><span class="line"><span class="comment"># 认值几乎总是可取的，因为它将使帮助消息与从命令行调用此程序的方式相匹配。</span></span><br><span class="line">parser.add_argument(<span class="string">'path'</span>,nargs=<span class="string">'?'</span>,default=<span class="string">'.'</span>,help=<span class="string">"path help"</span>)   </span><br><span class="line"><span class="comment"># 位置参数，可有可无，缺省值，帮助</span></span><br><span class="line"></span><br><span class="line">args = parser.parse_args()   <span class="comment"># 分析参数，同时传入可迭代的参数</span></span><br><span class="line">print(args)   <span class="comment"># 打印名词空间中收集的参数</span></span><br><span class="line">parser.print_help()   <span class="comment"># 打印帮助</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">Namespace(path=<span class="string">'.'</span>)</span><br><span class="line">usage: ls [-h] [path]</span><br><span class="line">    </span><br><span class="line">list directory contents</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  path    path help</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help show this help message <span class="keyword">and</span> exit</span><br></pre></td></tr></table></figure>
<p>可以看出path也变成可选的位置参数，没有提供就使用默认值 <code>.</code>点号表示当前路径。</p>
<ul>
<li>help 表示帮助文档中这个参数的描述</li>
<li>nargs 表示这个参数接收结果参数，?表示可有可无，+表示至少一个，*可以任意个，数字表示必须是指定数目个</li>
<li>default 表示如果不提供该参数，就使用这个值。一般和?、*配合，因为它们都可以不提供位置参数，不提供就是用缺省值</li>
</ul>
<h3 id="选项参数"><a href="#选项参数" class="headerlink" title="选项参数"></a>选项参数</h3><h4 id="l-的实现"><a href="#l-的实现" class="headerlink" title="-l 的实现"></a>-l 的实现</h4><p><code>parser.add_argument(&#39;-l&#39;)</code>就增加了选项参数，参数定义为<code>ls [-h] [-l L] [path]</code>和我们要的形式有一点出入，我们期望的是[-h]，怎么解决？</p>
<p>nargs能够解决吗？</p>
<p><code>parser.add_argument(&#39;-l&#39;,nargs=&#39;?&#39;)</code></p>
<p><code>ls [-h] [-l [L]] [path]</code></p>
<p>L变成了可选，而不是-l</p>
<p>那么，直接把nargs=0，意思就是让这个选项接收0个参数，如下：</p>
<p><code>parser.add_argument(&#39;-l&#39;,nargs=0)</code></p>
<p>结果，抛出异常</p>
<p><img src="/images/python-argparse模块/异常1.png" alt=""></p>
<p>为了这个问题，使用action参数</p>
<p><code>parser.add_argument(&#39;-l&#39;,action=&#39;store_true&#39;)</code></p>
<p>看到命令定义变成了 <code>ls [-h] [-l] [path]</code></p>
<p>提供-l选项，例如：</p>
<p><code>ls -l</code> 得到 <code>Namespace(l=True,path=&#39;.&#39;)</code></p>
<p><code>ls</code> 得到 <code>Namespace(l=False,path=&#39;.&#39;)</code></p>
<p>这样用True、False来判断用户是否提供了该选项</p>
<h4 id="a-的实现"><a href="#a-的实现" class="headerlink" title="-a 的实现"></a>-a 的实现</h4><p><code>parser.add_argument(&#39;-a&#39;,&#39;--all&#39;,action=&#39;store_true&#39;)</code></p>
<p>长短选项可以同时给出。</p>
<h5 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得一个参数解析器</span></span><br><span class="line">parser = argparse.ArgumentParser(prog=<span class="string">'ls'</span>,add_help=<span class="keyword">True</span>,description=<span class="string">'list directory contents'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'path'</span>,nargs=<span class="string">'?'</span>,default=<span class="string">'.'</span>,help=<span class="string">"directory"</span>)  </span><br><span class="line"><span class="comment"># 位置参数，可有可无，缺省值，帮助 </span></span><br><span class="line">parser.add_argument(<span class="string">'-l'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'use a long listing format'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-a'</span>,<span class="string">'--all'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'show all files,do not ignore entries starting with .'</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()  <span class="comment"># 分析参数，同时传入可迭代的参数</span></span><br><span class="line"><span class="comment"># 通过 parse_args() 方法解析参数。它将检查命令行，把每个参数转换为适当的类型然后调用相应的操作。在大多</span></span><br><span class="line"><span class="comment"># 数情况下，这意味着一个简单的 Namespace 对象将从命令行参数中解析出的属性构建。在脚本中，通常 </span></span><br><span class="line"><span class="comment"># parse_args() 会被不带参数调用，而 ArgumentParser 将自动从 sys.argv 中确定命令行参数。</span></span><br><span class="line"><span class="comment"># 这里Namespace对象构建的就是parser.add_argument()定义的参数是否被引用。如使用了-a和-l选项，那么</span></span><br><span class="line"><span class="comment"># namespace()中的all和l就会是True，否则就是False，path就是传入的路径，默认是当前路径，就是点。如果</span></span><br><span class="line"><span class="comment"># parser.add_argument()定义了长短两个选项。如</span></span><br><span class="line"><span class="comment"># parser.add_argument('-a','--all',action='store_true',help='show all files, do not ignore entries starting with .')</span></span><br><span class="line"><span class="comment"># args = parser.parse_args()</span></span><br><span class="line"><span class="comment"># files = listdir(args.path, args.all, args.l, args.human_readable)</span></span><br><span class="line"><span class="comment"># 输出：Namespace(all=True, human_readable=True, l=True, path='/tmp')</span></span><br><span class="line"><span class="comment"># 如果定义了长短选项，要调用长选项，不然会报错</span></span><br><span class="line">print(args) <span class="comment"># 打印名词空间中收集的参数</span></span><br><span class="line"><span class="comment"># args可以调用运行结果中Namespace()中的内容，如all、l、path，调用方法如args.path、args.l、</span></span><br><span class="line"><span class="comment"># args.all。Namespace中显示的内容实际是parser.add_argument()中定义的第一个参数，也就是定义的选</span></span><br><span class="line"><span class="comment"># 项。</span></span><br><span class="line">parser.print_help() <span class="comment"># 打印帮助</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">Namespace(all=<span class="keyword">False</span>, l=<span class="keyword">False</span>, path=<span class="string">'.'</span>)</span><br><span class="line">usage: ls [-h] [-l] [-a] [path]</span><br><span class="line">    </span><br><span class="line">list directory contents</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  path        directory</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help show this help message <span class="keyword">and</span> exit</span><br><span class="line">  -l         use a long listing format</span><br><span class="line">  -a,--all   show all files, do <span class="keyword">not</span> ignore entries starting <span class="keyword">with</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># parser.parse_args('-l -a /tmp'.split()) </span></span><br><span class="line"><span class="comment"># 运行结果需要使用print()打印出来或加到上面的args中，如args = parser.parse_args('-l -a /tmp'.split())</span></span><br><span class="line">Namespace(all=<span class="keyword">True</span>, l=<span class="keyword">True</span>, path=<span class="string">'/tmp'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="ls-业务功能的实现"><a href="#ls-业务功能的实现" class="headerlink" title="ls 业务功能的实现"></a>ls 业务功能的实现</h5><p>到目前为止，已经解决了参数的定义和传参的问题，下面就要解决业务问题：</p>
<ol>
<li>列出所有指定路径的文件，默认是不递归的</li>
<li>-a 显示所有文件，包括隐藏文件</li>
<li>-l 详细列表模式显示</li>
</ol>
<h5 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得一个参数解析器</span></span><br><span class="line">parser = argparse.ArgumentParser(prog=<span class="string">'ls'</span>,add_help=<span class="keyword">True</span>,description=<span class="string">'list directory contents'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'path'</span>,nargs=<span class="string">'?'</span>,default=<span class="string">'.'</span>,help=<span class="string">"directory"</span>)  </span><br><span class="line"><span class="comment"># 位置参数，可有可无，缺省值，帮助 </span></span><br><span class="line">parser.add_argument(<span class="string">'-l'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'use a long listing format'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-a'</span>,<span class="string">'--all'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'show all files,do not ignore entries starting with .'</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()  <span class="comment"># 分析参数，同时传入可迭代的参数</span></span><br><span class="line">print(args) <span class="comment"># 打印名词空间中收集的参数</span></span><br><span class="line">parser.print_help() <span class="comment"># 打印帮助</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listdir</span><span class="params">(path, all=False)</span>:</span></span><br><span class="line">    <span class="string">"""列出本目录文件"""</span></span><br><span class="line">    p = Path(path)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> p.iterdir():</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> all <span class="keyword">and</span> i.name.startswith(<span class="string">'.'</span>): <span class="comment"># 不显示隐藏文件</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">yield</span> i.name</span><br><span class="line">        </span><br><span class="line">print(list(listdir(args.path)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取文件类型</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_getfiletype</span><span class="params">(f:Path)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> f.is_dir():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'d'</span></span><br><span class="line">    <span class="keyword">elif</span> f.is_block_device():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'b'</span></span><br><span class="line">    <span class="keyword">elif</span> f.is_char_device():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'c'</span></span><br><span class="line">    <span class="keyword">elif</span> f.is_socket():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'s'</span></span><br><span class="line">    <span class="keyword">elif</span> f.is_symlink():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'l'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'-'</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># -rw-rw-r-- python python                5 Oct  25  00:07  test4</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listdirdetail</span><span class="params">(path, all=False)</span>:</span></span><br><span class="line">    <span class="string">"""详细列出本目录"""</span></span><br><span class="line">    p = Path(path)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> p.iterdir():</span><br><span class="line"><span class="comment"># iterdir()表示当路径指向一个目录时，产生该路径下的对象的路径，列出子目录。</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> all <span class="keyword">and</span> i.name.startswith(<span class="string">'.'</span>): <span class="comment"># 不显示隐藏文件</span></span><br><span class="line"><span class="comment"># name()是一个表示最后路径组件的字符串，排除了驱动器与根目录，如果存在的话；</span></span><br><span class="line"><span class="comment"># startswith()如果字符串以指定值开头，则该方法返回True，否则返回False。</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># mode 硬链接  属主  属组  字节  时间  name</span></span><br><span class="line">        stat = i.stat()</span><br><span class="line"><span class="comment"># stat()返回此路径的信息（类似于 os.stat()）。结果在每次调用此方法时都重新产生。得到的信息包括路径属性st_mode()等，就像是ls -l看到的输出内容一样</span></span><br><span class="line">        t = _getfiletype(i)</span><br><span class="line">        mode = oct(stat.st_mode)[<span class="number">-3</span>:]</span><br><span class="line"><span class="comment"># 获取权限，转为八进制。oct()的返回结果是字符串，结果如0o664，所以我们要取后三位，就是权限了</span></span><br><span class="line">        atime = datetime.fromtimestamp(stat.st_atime).strftime(<span class="string">'%Y %m %d %H:%M:%S'</span>)</span><br><span class="line">        <span class="comment"># fromtimestamp()返回对应于 POSIX 时间戳例如 time.time() 的返回值的本地日期和时间。</span></span><br><span class="line">        <span class="comment"># st_atime表示文件最后访问时间</span></span><br><span class="line">        <span class="comment"># strftime()用来创建由一个显式格式字符串所控制的表示时间的字符串。</span></span><br><span class="line">        <span class="keyword">yield</span> (t, mode, stat.st_uid, stat.st_gid, stat.st_size, atime, i.name)</span><br><span class="line">        </span><br><span class="line">print(list(listdirdetail(args.path)))</span><br></pre></td></tr></table></figure>
<p>mode 是整数，八进制描述的权限，最终显示为rwx的格式。</p>
<p>方法1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">modelist = [<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>]</span><br><span class="line"><span class="comment"># modelist = list('rwxrwxrwx')，这样也可以</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_getmodestr</span><span class="params">(mode:int)</span>:</span></span><br><span class="line">    m = mode &amp; <span class="number">0o777</span></span><br><span class="line"><span class="comment"># 把上面定义的mode变量与0o777相与</span></span><br><span class="line">    <span class="comment"># print(mode)</span></span><br><span class="line">    <span class="comment"># print(m, bin(m))</span></span><br><span class="line">    mstr = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i,v <span class="keyword">in</span> enumerate(bin(m)[<span class="number">-9</span>:]):</span><br><span class="line">        <span class="keyword">if</span> v == <span class="string">'1'</span>:</span><br><span class="line">            mstr += modelist[i]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mstr += <span class="string">'-'</span></span><br><span class="line">    <span class="keyword">return</span> mstr</span><br></pre></td></tr></table></figure>
<p>方法2：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">modelist = dict(zip(range(<span class="number">9</span>),[<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>]))</span><br><span class="line"><span class="comment"># zip() 函数用于将可迭代的对象作为参数，将对象中对应的元素打包成一个个元组，然后返回由这些元组组成的列表。如果各个迭代器的元素个数不一致，则返回列表长度与最短的对象相同，利用 * 号操作符，可以将元组解压为列表。</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_getmodestr</span><span class="params">(mode:int)</span>:</span></span><br><span class="line">    m = mode &amp; <span class="number">0o777</span></span><br><span class="line">    mstr = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>,<span class="number">-1</span>,<span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">if</span> m &gt;&gt; i &amp; <span class="number">1</span>:</span><br><span class="line">            mstr += modelist[<span class="number">8</span>-i]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mstr += <span class="string">'-'</span></span><br><span class="line">    <span class="keyword">return</span> mstr</span><br></pre></td></tr></table></figure>
<h5 id="合并列出文件函数"><a href="#合并列出文件函数" class="headerlink" title="合并列出文件函数"></a>合并列出文件函数</h5><p>listdirdetail 和listdir几乎一样，重复太多，合并</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得一个参数解析器</span></span><br><span class="line">parser = argparse.ArgumentParser(prog=<span class="string">'ls'</span>,add_help=<span class="keyword">True</span>,description=<span class="string">'list directory contents'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'path'</span>,nargs=<span class="string">'?'</span>,default=<span class="string">'.'</span>,help=<span class="string">"directory"</span>)  </span><br><span class="line"><span class="comment"># 位置参数，可有可无，缺省值，帮助 </span></span><br><span class="line">parser.add_argument(<span class="string">'-l'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'use a long listing format'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-a'</span>,<span class="string">'--all'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'show all files,do not ignore entries starting with .'</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()  <span class="comment"># 分析参数，同时传入可迭代的参数</span></span><br><span class="line">print(args) <span class="comment"># 打印名词空间中收集的参数</span></span><br><span class="line">parser.print_help() <span class="comment"># 打印帮助</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_getfiletype</span><span class="params">(f:Path)</span>:</span></span><br><span class="line"><span class="comment"># 这里的参数定义成f:Path，这样下面就方便调用f的方法。但这不会做强制类型检查</span></span><br><span class="line">    <span class="string">"""获取文件类型"""</span></span><br><span class="line">    <span class="keyword">if</span> f.is_dir():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'d'</span></span><br><span class="line">    <span class="keyword">elif</span> f.is_block_device():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'b'</span></span><br><span class="line">    <span class="keyword">elif</span> f.is_char_device():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'c'</span></span><br><span class="line">    <span class="keyword">elif</span> f.is_socket():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'s'</span></span><br><span class="line">    <span class="keyword">elif</span> f.is_symlink():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'l'</span></span><br><span class="line">    <span class="keyword">elif</span> f.is_fifo():  <span class="comment"># pipe</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'p'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'-'</span></span><br><span class="line">    </span><br><span class="line">modelist = dict(zip(range(<span class="number">9</span>),[<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>]))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_getmodestr</span><span class="params">(mode:int)</span>:</span></span><br><span class="line">    m = mode &amp; <span class="number">0o777</span></span><br><span class="line">    mstr = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>,<span class="number">-1</span>,<span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">if</span> m &gt;&gt; i &amp; <span class="number">1</span>:</span><br><span class="line">            mstr += modelist[<span class="number">8</span>-i]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mstr += <span class="string">'-'</span></span><br><span class="line">    <span class="keyword">return</span> mstr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listdir</span><span class="params">(path, all=False, detail=False)</span>:</span></span><br><span class="line">    <span class="string">"""详细列出本目录"""</span></span><br><span class="line">    p = Path(path)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> p.iterdir():</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> all <span class="keyword">and</span> i.name.startswith(<span class="string">'.'</span>):   <span class="comment"># 不显示隐藏文件</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> detail:</span><br><span class="line">            <span class="keyword">yield</span> (i.name,)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># -rw-rw-r--   1    python    python    5  Oct  25  00:07  test4</span></span><br><span class="line">            <span class="comment"># mode       硬链接  属主        属组     字节 时间             name</span></span><br><span class="line">            stat = i.stat()</span><br><span class="line">            mode = _getfiletype(i) + _getmodestr(stat.st_mode)</span><br><span class="line">            atime = datetime.fromtimestamp(stat.st_atime).strftime(<span class="string">'%Y %m %d %H:%M:%S'</span>)</span><br><span class="line">            <span class="keyword">yield</span> (mode, stat.st_nlink, stat.st_uid, stat.st_gid, stat.st_size, atime, i.name)</span><br><span class="line">            </span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> listdir(args.path,detail=<span class="keyword">True</span>):</span><br><span class="line"><span class="comment"># args.path可以取得args变量定义时传给parser.parse_args()的参数，也就是路径。</span></span><br><span class="line"><span class="comment"># detail默认是False，只显示文件名称。</span></span><br><span class="line">    print(x)</span><br></pre></td></tr></table></figure>
<h5 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h5><p>ls 的显示是把文件名按照升序排序输出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 排序</span></span><br><span class="line">sorted(listdir(args.path, detail=<span class="keyword">True</span>), key=<span class="keyword">lambda</span> x: x[len(x) - <span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<h5 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h5><p>再次重构代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得一个参数解析器</span></span><br><span class="line">parser = argparse.ArgumentParser(prog=<span class="string">'ls'</span>,add_help=<span class="keyword">True</span>,description=<span class="string">'list directory contents'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'path'</span>,nargs=<span class="string">'?'</span>,default=<span class="string">'.'</span>,help=<span class="string">"directory"</span>)  </span><br><span class="line"><span class="comment"># 位置参数，可有可无，缺省值，帮助 </span></span><br><span class="line">parser.add_argument(<span class="string">'-l'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'use a long listing format'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-a'</span>,<span class="string">'--all'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'show all files,do not ignore entries starting with .'</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()  <span class="comment"># 分析参数，同时传入可迭代的参数</span></span><br><span class="line">print(args) <span class="comment"># 打印名词空间中收集的参数</span></span><br><span class="line">parser.print_help() <span class="comment"># 打印帮助</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listdir</span><span class="params">(path, all=False, detail=False)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_getfiletype</span><span class="params">(f:Path)</span>:</span></span><br><span class="line">        <span class="string">"""获取文件类型"""</span></span><br><span class="line">        <span class="keyword">if</span> f.is_dir():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'d'</span></span><br><span class="line">        <span class="keyword">elif</span> f.is_block_device():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'b'</span></span><br><span class="line">        <span class="keyword">elif</span> f.is_char_device():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'c'</span></span><br><span class="line">        <span class="keyword">elif</span> f.is_socket():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'s'</span></span><br><span class="line">        <span class="keyword">elif</span> f.is_symlink():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'l'</span></span><br><span class="line">        <span class="keyword">elif</span> f.is_fifo(): <span class="comment"># pipe</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'p'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'-'</span></span><br><span class="line">        </span><br><span class="line">    modelist = dict(zip(range(<span class="number">9</span>),[<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_getmodestr</span><span class="params">(mode: int)</span>:</span></span><br><span class="line">        m = mode &amp; <span class="number">0o777</span></span><br><span class="line">        mstr = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">            <span class="keyword">if</span> m &gt;&gt; i &amp; <span class="number">1</span>:</span><br><span class="line">                mstr += modelist[<span class="number">8</span> - i]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                mstr += <span class="string">'-'</span></span><br><span class="line">        <span class="keyword">return</span> mstr</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_listdir</span><span class="params">(path, all=False, detail=False)</span>:</span></span><br><span class="line">        <span class="string">"""详细列出本目录"""</span></span><br><span class="line">        p = Path(path)</span><br><span class="line">    	<span class="keyword">for</span> i <span class="keyword">in</span> p.iterdir():</span><br><span class="line">        	<span class="keyword">if</span> <span class="keyword">not</span> all <span class="keyword">and</span> i.name.startswith(<span class="string">'.'</span>):   <span class="comment"># 不显示隐藏文件</span></span><br><span class="line">            	<span class="keyword">continue</span></span><br><span class="line">        	<span class="keyword">if</span> <span class="keyword">not</span> detail:</span><br><span class="line">            	<span class="keyword">yield</span> (i.name,)</span><br><span class="line">        	<span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># -rw-rw-r--   1    python    python    5  Oct  25  00:07  test4</span></span><br><span class="line">                <span class="comment"># mode       硬链接  属主        属组     字节 时间             name</span></span><br><span class="line">                stat = i.stat()</span><br><span class="line">                mode = _getfiletype(i) + _getmodestr(stat.st_mode)</span><br><span class="line">                atime = datetime.fromtimestamp(stat.st_atime).strftime(<span class="string">'%Y %m %d %H:%M:%S'</span>)</span><br><span class="line">                <span class="keyword">yield</span> (mode, stat.st_nlink, stat.st_uid, stat.st_gid, stat.st_size, atime, i.name)</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> sorted(_listdir(path, all, detail), key=<span class="keyword">lambda</span> x: x[len(x) - <span class="number">1</span>])</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	args = parser.parse_args() <span class="comment"># 分析参数，同时传入可迭代的参数</span></span><br><span class="line">	print(args) <span class="comment"># 打印名词空间中收集的参数</span></span><br><span class="line">	parser.print_help() <span class="comment"># 打印帮助</span></span><br><span class="line">	files = listdir(args.path, args.all, args.l)</span><br><span class="line">	print(list(files))</span><br></pre></td></tr></table></figure>
<h4 id="h-的实现"><a href="#h-的实现" class="headerlink" title="-h 的实现"></a>-h 的实现</h4><p>-h, –human-readable，如果-l 存在，-h 有效</p>
<ol>
<li>增加选项参数</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">parser = argparse.ArgumentParser(prog=<span class="string">'ls'</span>,description=<span class="string">'list directory contents'</span>,add_help=<span class="keyword">False</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-h'</span>, <span class="string">'--human-readable'</span>, action=<span class="string">'store_true'</span>, help=<span class="string">'with -l, print sizes in human readable format'</span>)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>增加一个函数，能够解决单位转换的</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_gethuman</span><span class="params">(size: int)</span>:</span></span><br><span class="line">    units = <span class="string">' KMGTP'</span></span><br><span class="line">    depth = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> size&gt;=<span class="number">1000</span>:</span><br><span class="line">        size = size // <span class="number">1000</span></span><br><span class="line">        depth += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&#123;&#125;&#123;&#125;'</span>.format(size, units[depth])</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在-l逻辑部分增加处理</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size = stat.st_size <span class="keyword">if</span> <span class="keyword">not</span> human <span class="keyword">else</span> _gethuman(stat.st_size)</span><br></pre></td></tr></table></figure>
<h5 id="其他的完善"><a href="#其他的完善" class="headerlink" title="其他的完善"></a>其他的完善</h5><p>uid、gid的转换</p>
<p>pwd模块，The password database ，提供访问Linux、Unix的password文件的方式。windows没有。</p>
<p><code>pwd.getpwuid(Path().stat().st_uid).pw_name</code></p>
<p>grp模块，Linux、Unix获取组信息的模块。windows没有</p>
<p><code>grp.getgrgid(Path().stat().st_gid).gr_name</code></p>
<p>pathlib模块，Path().group()或者Path().owner()也可以，本质上它们就是调用pwd模块和grp模块</p>
<p>由于windows不支持，这次可以不加这个uid、gid的转换</p>
<h5 id="代码改进"><a href="#代码改进" class="headerlink" title="代码改进"></a>代码改进</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得一个参数解析器</span></span><br><span class="line">parser = argparse.ArgumentParser(prog=<span class="string">'ls'</span>,description=<span class="string">'list directory contents'</span>,add_help=<span class="keyword">False</span>)</span><br><span class="line">parser.add_argument(<span class="string">'path'</span>,nargs=<span class="string">'?'</span>,default=<span class="string">'.'</span>,help=<span class="string">"directory"</span>)  </span><br><span class="line"><span class="comment"># 位置参数，可有可无，缺省值，帮助 </span></span><br><span class="line">parser.add_argument(<span class="string">'-l'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'use a long listing format'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-a'</span>,<span class="string">'--all'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'show all files,do not ignore entries starting with .'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-h'</span>, <span class="string">'--human-readable'</span>, action=<span class="string">'store_true'</span>, help=<span class="string">'with -l, print sizes in human readable format'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listdir</span><span class="params">(path, all=False, detail=False, human=False)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_getfiletype</span><span class="params">(f:Path)</span>:</span></span><br><span class="line">        <span class="string">"""获取文件类型"""</span></span><br><span class="line">        <span class="keyword">if</span> f.is_dir():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'d'</span></span><br><span class="line">        <span class="keyword">elif</span> f.is_block_device():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'b'</span></span><br><span class="line">        <span class="keyword">elif</span> f.is_char_device():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'c'</span></span><br><span class="line">        <span class="keyword">elif</span> f.is_socket():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'s'</span></span><br><span class="line">        <span class="keyword">elif</span> f.is_symlink():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'l'</span></span><br><span class="line">        <span class="keyword">elif</span> f.is_fifo(): <span class="comment"># pipe</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'p'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'-'</span></span><br><span class="line">        </span><br><span class="line">    modelist = dict(zip(range(<span class="number">9</span>),[<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'r'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_getmodestr</span><span class="params">(mode: int)</span>:</span></span><br><span class="line">        m = mode &amp; <span class="number">0o777</span></span><br><span class="line">        mstr = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">            <span class="keyword">if</span> m &gt;&gt; i &amp; <span class="number">1</span>:</span><br><span class="line">                mstr += modelist[<span class="number">8</span> - i]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                mstr += <span class="string">'-'</span></span><br><span class="line">        <span class="keyword">return</span> mstr</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_gethuman</span><span class="params">(size: int)</span>:</span></span><br><span class="line">        units = <span class="string">' KMGTP'</span></span><br><span class="line">        depth = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> size&gt;=<span class="number">1000</span>:</span><br><span class="line">            size = size // <span class="number">1000</span></span><br><span class="line">            depth += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&#123;&#125;&#123;&#125;'</span>.format(size,units[depth])</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_listdir</span><span class="params">(path, all=False, detail=False)</span>:</span></span><br><span class="line">        <span class="string">"""详细列出本目录"""</span></span><br><span class="line">        p = Path(path)</span><br><span class="line">    	<span class="keyword">for</span> i <span class="keyword">in</span> p.iterdir():</span><br><span class="line">        	<span class="keyword">if</span> <span class="keyword">not</span> all <span class="keyword">and</span> i.name.startswith(<span class="string">'.'</span>):   <span class="comment"># 不显示隐藏文件</span></span><br><span class="line">            	<span class="keyword">continue</span></span><br><span class="line">        	<span class="keyword">if</span> <span class="keyword">not</span> detail:</span><br><span class="line">            	<span class="keyword">yield</span> (i.name,)</span><br><span class="line">        	<span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># -rw-rw-r--   1    python    python    5  Oct  25  00:07  test4</span></span><br><span class="line">                <span class="comment"># mode       硬链接  属主        属组     字节 时间             name</span></span><br><span class="line">                stat = i.stat()</span><br><span class="line">                mode = _getfiletype(i) + _getmodestr(stat.st_mode)</span><br><span class="line">                atime = datetime.fromtimestamp(stat.st_atime).strftime(<span class="string">'%Y %m %d %H:%M:%S'</span>)</span><br><span class="line">                size = str(stat.st_size) <span class="keyword">if</span> <span class="keyword">not</span> human <span class="keyword">else</span> _gethuman(stat.st_size)</span><br><span class="line">                <span class="keyword">yield</span> (mode, stat.st_nlink, stat.st_uid, stat.st_gid, stat.st_size, atime, i.name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 排序            </span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> sorted(_listdir(path, all, detail), key=<span class="keyword">lambda</span> x: x[len(x) - <span class="number">1</span>])</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	args = parser.parse_args() <span class="comment"># 分析参数，同时传入可迭代的参数</span></span><br><span class="line">	print(args) <span class="comment"># 打印名词空间中收集的参数</span></span><br><span class="line">	parser.print_help() <span class="comment"># 打印帮助</span></span><br><span class="line">	files = listdir(args.path, args.all, args.l)</span><br><span class="line">	print(list(files))</span><br></pre></td></tr></table></figure>
<h5 id="改进mode的方法"><a href="#改进mode的方法" class="headerlink" title="改进mode的方法"></a>改进mode的方法</h5><p>使用stat模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> stat</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">stat.filemode(Path().stat().st_mode)</span><br><span class="line"><span class="comment"># stat().st_mode()可以直接取到文件的权限</span></span><br></pre></td></tr></table></figure>
<h5 id="最终代码"><a href="#最终代码" class="headerlink" title="最终代码"></a>最终代码</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">实现ls命令功能，实现-l、-a和--all、-h选项</span><br><span class="line">实现显示路径下的文件列表</span><br><span class="line">-a和--all显示包含开头的文件</span><br><span class="line">-l详细列表显示</span><br><span class="line">-h和-l配合，人性化显示文件大小，例如<span class="number">1</span>K、<span class="number">1</span>G、<span class="number">1</span>T等，可以认为<span class="number">1</span>G=<span class="number">1000</span>M</span><br><span class="line">c字符；d目录；-普通文件；l软链接；b块设备；s socket文件；p pipe文件，即FIFO</span><br><span class="line">-rw-rw-r--   <span class="number">1</span>    python    python    <span class="number">5</span>  Oct  <span class="number">25</span>  <span class="number">00</span>:<span class="number">07</span>  test4</span><br><span class="line">mode       硬链接  属主        属组     字节 时间             name</span><br><span class="line">按照文件名排序输出，可以和ls的顺序不一样，但要求文件名排序</span><br><span class="line">要求详细列表显示时，时间可以按照<span class="string">"年-月-日 时:分:秒"</span>  格式显示</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 导入模块</span><br><span class="line"><span class="number">2.</span> 定义参数</span><br><span class="line"><span class="number">3.</span> 定义函数，逻辑是先定义获取文件大小的子函数；再定义获取文件信息的子函数。获取文件大小的子函数通过与<span class="number">1000</span>整除得到文件大小的单位；获致文件信</span><br><span class="line">息的子函数通过传入的几个参数进行判断，如是否有路径，没有就使用默认的当前路径；all是否为<span class="keyword">False</span>，如果为<span class="keyword">False</span>并且文件是以点开头的文件，就跳出</span><br><span class="line">本轮循环；如果为<span class="keyword">True</span>，就再判断传入的human是否为<span class="keyword">False</span>，如果为<span class="keyword">False</span>就显示文件的名称，如果为<span class="keyword">True</span>就显示文件的详细信息。</span><br><span class="line"><span class="number">4.</span> 最后返回按文件名排序后的结果</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> stat</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得一个参数解析器</span></span><br><span class="line">parser = argparse.ArgumentParser(prog=<span class="string">'ls'</span>,description=<span class="string">'list directory contents'</span>,add_help=<span class="keyword">False</span>)</span><br><span class="line"><span class="comment"># prog：默认情况下，ArgumentParser 对象使用 sys.argv[0] 来确定如何在帮助消息中显示程序名称。这一默</span></span><br><span class="line"><span class="comment"># 认值几乎总是可取的，因为它将使帮助消息与从命令行调用此程序的方式相匹配。</span></span><br><span class="line"><span class="comment"># add_help：默认情况下，ArgumentParser 对象添加一个简单的显示解析器帮助信息的选项。这里设置为False</span></span><br><span class="line"><span class="comment"># 是因为下面还要设置-h选项，如果这里再加一个帮助会报错有重复。</span></span><br><span class="line">parser.add_argument(<span class="string">'path'</span>,nargs=<span class="string">'?'</span>,default=<span class="string">'.'</span>,help=<span class="string">"directory"</span>)  </span><br><span class="line"><span class="comment"># 位置参数，可有可无，缺省值，帮助 </span></span><br><span class="line">parser.add_argument(<span class="string">'-l'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'use a long listing format'</span>)</span><br><span class="line"><span class="comment"># -l选项为了显示非隐藏文件的普通文件 </span></span><br><span class="line">parser.add_argument(<span class="string">'-a'</span>,<span class="string">'--all'</span>,action=<span class="string">'store_true'</span>,help=<span class="string">'show all files,do not ignore entries starting with .'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-h'</span>, <span class="string">'--human-readable'</span>, action=<span class="string">'store_true'</span>, help=<span class="string">'with -l, print sizes in human readable format'</span>)</span><br><span class="line"><span class="comment"># -h选项是为了显示路径名称的详细信息</span></span><br><span class="line"><span class="comment"># 这里虽然定义的是--human-readable，但在Namespace中只能拿到human_readable，如果定义的是</span></span><br><span class="line"><span class="comment"># --human_readable，Namespace中拿到的还是human_readable。拿到的只有下划线连接</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listdir</span><span class="params">(path, all=False, detail=False, human=False)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_gethuman</span><span class="params">(size: int)</span>:</span>  <span class="comment"># 不想被调用的函数就用下划线开头</span></span><br><span class="line">        units = <span class="string">' KMGTP'</span></span><br><span class="line">        depth = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> size&gt;=<span class="number">1000</span>:</span><br><span class="line">            size = size // <span class="number">1000</span></span><br><span class="line">            depth += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&#123;&#125;&#123;&#125;'</span>.format(size,units[depth])</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_listdir</span><span class="params">(path, all=False, detail=False, human=False)</span>:</span></span><br><span class="line">        <span class="string">"""详细列出本目录"""</span></span><br><span class="line">        p = Path(path)</span><br><span class="line">        <span class="comment"># 这时p的类型就不是字符串了，而是pathlib下的一个类型，系统不同，这个类型也不同</span></span><br><span class="line">    	<span class="keyword">for</span> i <span class="keyword">in</span> p.iterdir():</span><br><span class="line">        	<span class="keyword">if</span> <span class="keyword">not</span> all <span class="keyword">and</span> i.name.startswith(<span class="string">'.'</span>):   <span class="comment"># 不显示隐藏文件</span></span><br><span class="line">            	<span class="keyword">continue</span></span><br><span class="line">        	<span class="keyword">if</span> <span class="keyword">not</span> detail:</span><br><span class="line">            	<span class="keyword">yield</span> (i.name,)</span><br><span class="line">        	<span class="keyword">else</span>: <span class="comment"># -l</span></span><br><span class="line">                <span class="comment"># -rw-rw-r--   1    python    python    5  Oct  25  00:07  test4</span></span><br><span class="line">                <span class="comment"># mode       硬链接  属主        属组     字节 时间             name</span></span><br><span class="line">                st = i.stat()</span><br><span class="line">                mode = stat.filemode(st.st_mode)</span><br><span class="line">                <span class="comment"># stat.filemode用于将文件模式转换为 '-rwxrwxrwx' 形式的字符串</span></span><br><span class="line">                <span class="comment"># st.st_mode是得到mode，这是一种inode 保护模式。另外还有ST_UID等。</span></span><br><span class="line">                atime = datetime.fromtimestamp(st.st_atime).strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span><br><span class="line">                size = str(st.st_size) <span class="keyword">if</span> <span class="keyword">not</span> human <span class="keyword">else</span> _gethuman(st.st_size)</span><br><span class="line">                <span class="keyword">yield</span> (mode, st.st_nlink, st.st_uid, st.st_gid, size, atime, i.name)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 排序            </span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> sorted(_listdir(path, all, detail, human), key=<span class="keyword">lambda</span> x: x[len(x) - <span class="number">1</span>])</span><br><span class="line">    <span class="comment"># _listdir()中的参数是从最外层的listdir()函数得到的，所以要与listdir()的参数名一样</span></span><br><span class="line"><span class="comment"># _listdir()的返回值就是待排序的对象，lambda x: x[len(x) - 1]中的x指定就是前面的返回结果，</span></span><br><span class="line"><span class="comment"># len(x)-1就是统计前面返回结果中的元素数减1，再根据这个得数进行排序，也就是根据_listdir返回的最后一个</span></span><br><span class="line"><span class="comment"># 文件名称排序。这里也可以写为key=lambda x: x[-1]</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	args = parser.parse_args() <span class="comment"># 分析参数，同时传入可迭代的参数</span></span><br><span class="line">	print(args) <span class="comment"># 打印名词空间中收集的参数</span></span><br><span class="line">	parser.print_help() <span class="comment"># 打印帮助信息</span></span><br><span class="line">	files = listdir(args.path, args.all, args.l, args.human_readable)</span><br><span class="line"><span class="comment"># 这里调用了args的各种方法，结果都是True。传入listdir函数的参数就是'/tmp',True,True,True</span></span><br><span class="line"><span class="comment"># 另外，这里要将所有参数传入listdir，如listdir(args.path, args.all, args.l, args.human_readable)</span></span><br><span class="line"><span class="comment"># 之后通过外部调用这些参数来决定使用默认值还是传入的值，也就是这里是否有路径，没有就用默认的当前路径，如</span></span><br><span class="line"><span class="comment"># 果使用了参数，就显示为True，否则显示为False。</span></span><br><span class="line"><span class="comment"># 此处以位置参数一一对应将参数传入listdir()函数。这里如果要传入指定的字符要加引号，数字不需要</span></span><br><span class="line">	print(list(files))</span><br><span class="line">    </span><br><span class="line">=======================================================================================</span><br><span class="line">当待排序列表的元素由多字段构成时，我们可以通过sorted(iterable，key，reverse)的参数key来制定我们根据那个字段对列表元素进行排序。</span><br><span class="line">　　key=<span class="keyword">lambda</span> 元素: 元素[字段索引]</span><br><span class="line">　　例如：想对元素第二个字段排序，则</span><br><span class="line">　　key=<span class="keyword">lambda</span> y: y[<span class="number">1</span>] 备注：这里y可以是任意字母，等同key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>]</span><br><span class="line">看几个简单的例子。</span><br><span class="line"></span><br><span class="line">listA = [<span class="number">3</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line">print(sorted(listA))</span><br><span class="line"></span><br><span class="line">listB = [<span class="string">'g'</span>, <span class="string">'e'</span>, <span class="string">'t'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>]</span><br><span class="line">print(sorted(listB))</span><br><span class="line">print(sorted(listB, key=<span class="keyword">lambda</span> y: y[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">listC = [(<span class="string">'e'</span>, <span class="number">4</span>), (<span class="string">'o'</span>, <span class="number">2</span>), (<span class="string">'!'</span>, <span class="number">5</span>), (<span class="string">'v'</span>, <span class="number">3</span>), (<span class="string">'l'</span>, <span class="number">1</span>)]</span><br><span class="line">print(sorted(listC, key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment">#结果一</span></span><br><span class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br><span class="line"><span class="comment">#结果二</span></span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'e'</span>, <span class="string">'g'</span>, <span class="string">'t'</span>]</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'e'</span>, <span class="string">'g'</span>, <span class="string">'t'</span>]</span><br><span class="line"><span class="comment">#结果三</span></span><br><span class="line">[(<span class="string">'l'</span>, <span class="number">1</span>), (<span class="string">'o'</span>, <span class="number">2</span>), (<span class="string">'v'</span>, <span class="number">3</span>), (<span class="string">'e'</span>, <span class="number">4</span>), (<span class="string">'!'</span>, <span class="number">5</span>)]</span><br><span class="line">=======================================================================================</span><br></pre></td></tr></table></figure>
<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python xxx.py -lah</span><br><span class="line">$ python xxx.py /etc/ -lah</span><br></pre></td></tr></table></figure>
<h5 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h5><p>如果要实现ls -lah /etc /tmp /home 怎么实现</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/09/python基础学习-序列化和反序列化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/09/python基础学习-序列化和反序列化/" itemprop="url">
                  python基础学习-序列化和反序列化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-09 16:50:48" itemprop="dateCreated datePublished" datetime="2020-01-09T16:50:48+08:00">2020-01-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="为什么要序列化"><a href="#为什么要序列化" class="headerlink" title="为什么要序列化"></a>为什么要序列化</h3><p>内存中的字典、列表、集合以及各种对象，如何保存到一个文件中？</p>
<p>如果是自己定义的类的实例，如何保存到一个文件中？</p>
<p>如何从文件中读取数据，并让它们在内存中再次变成自己对应的类的实例？</p>
<p>要设计一套协议，按照某种规则，把内存中数据保存到文件中。文件是一个字节序列，所以必须把数据转换成字节序列，输出到文件。这就是序列化。反之，从文件的字节序列恢复到内存，就是反序列化。</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>serialization 序列化</p>
<p>将内存中对象存储下来，把它变成一个个字节。 -&gt; 二进制</p>
<p>deserialization 反序列化</p>
<p>将文件的一个个字节恢复成内存中对象。 &lt;- 二进制</p>
<p>序列化保存到文件就是持久化。</p>
<p>可以将数据序列化后持久化，或者网络传输；也可以将从文件中或者网络接收到的字节序列反序列化。</p>
<p>Python提供了pickle库</p>
<h3 id="pickle库"><a href="#pickle库" class="headerlink" title="pickle库"></a>pickle库</h3><p>Python中的序列化、反序列化模块。</p>
<p>dumps 对象序列化为bytes对象</p>
<p>dump 对象序列化到文件对象，就是存入文件</p>
<p>loads 从bytes对象反序列化</p>
<p>load 对象反序列化，从文件读取数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件序列化和反序列化</span></span><br><span class="line">filename = <span class="string">'o:/set'</span></span><br><span class="line"></span><br><span class="line">d = &#123;<span class="string">'a'</span>:<span class="number">1</span>,<span class="string">'b'</span>:<span class="string">'abc'</span>,<span class="string">'c'</span>:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]&#125;</span><br><span class="line">l = list(<span class="string">'123'</span>)</span><br><span class="line">i = <span class="number">99</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(filename,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(d,f)   <span class="comment"># 格式是把哪些内容写入哪个文件</span></span><br><span class="line">    pickle.dump(l,f)</span><br><span class="line">    pickle.dump(i,f)  <span class="comment"># 这是追加写入的？</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> open(filename,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    print(f.read(),f.seek(<span class="number">0</span>))  <span class="comment"># 读取所有内容，并将指针调整到最开始的位置</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        x = pickle.load(f)   <span class="comment"># 反序列化f中的内容并打印出来</span></span><br><span class="line">        print(type(x),x)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="comment"># 对象序列化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span>:</span></span><br><span class="line">    tttt = <span class="string">'ABC'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'abc'</span>)</span><br><span class="line">        </span><br><span class="line">a1 = AA()</span><br><span class="line"></span><br><span class="line">sr = pickle.dumps(a1)</span><br><span class="line">print(<span class="string">'sr=&#123;&#125;'</span>.format(sr))   <span class="comment"># AA</span></span><br><span class="line"></span><br><span class="line">a2 = pickle.loads(sr)</span><br><span class="line">print(a2.tttt)</span><br><span class="line">a2.show()</span><br></pre></td></tr></table></figure>
<p>上面的例子中，其实就保存了一个类名，因为所有的其他东西都是类定义的东西，是不变的，所以只序列化一个AA类名。反序列化的时候找到类就可以恢复一个对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AAA</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.tttt = <span class="string">'abc'</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 创建AA类的实例</span></span><br><span class="line">a1 = AAA()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化</span></span><br><span class="line">ser = pickle.dumps(a1)</span><br><span class="line">print(<span class="string">'ser=&#123;&#125;'</span>.format(ser))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反序列化</span></span><br><span class="line">a2 = pickle.loads(ser)</span><br><span class="line">print(a2,type(a2))</span><br><span class="line">print(a2.tttt)</span><br><span class="line">print(id(a1),id(a2))</span><br></pre></td></tr></table></figure>
<p>可以看出这回除了必须保存的AAA，还序列化了tttt和abc，因为这是每一个对象自己的属性，每一个对象不一样的，所以这些数据需要序列化。</p>
<h3 id="序列化、反序列化实验"><a href="#序列化、反序列化实验" class="headerlink" title="序列化、反序列化实验"></a>序列化、反序列化实验</h3><p>定义类AAA，并序列化到文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="comment"># 实验</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AAA</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.tttt = <span class="string">'abc'</span></span><br><span class="line">        </span><br><span class="line">aaa = AAA()</span><br><span class="line">sr = pickle.dumps(aaa)</span><br><span class="line">print(len(sr))</span><br><span class="line"></span><br><span class="line">file = <span class="string">'o:/ser'</span></span><br><span class="line"><span class="keyword">with</span> open(file,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(aaa,f)</span><br></pre></td></tr></table></figure>
<p>将产生的序列化文件发送到其他节点上。增加一个x.py文件，内容如下。最后执行这个脚本 <code>python x.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'ser'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    a = pickle.load(f)   <span class="comment"># 异常</span></span><br></pre></td></tr></table></figure>
<p>会抛出异常 <code>AttributeError: Can&#39;t get attribute &#39;AAA&#39; on &lt;module &#39;__main__&#39; from &#39;t.py&#39;&gt;</code>。</p>
<p>这个异常实际上是找不到类AAA的定义，增加类定义即可解决。</p>
<p>反序列化的时候要找到AAA类的定义，才能成功。否则就会抛出异常。</p>
<p>可以这样理解：反序列化的时候，类是模子，二进制序列就是铁水。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AAA</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'xyz'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'ser'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    a = pickle.load(f)</span><br><span class="line">    print(a)</span><br><span class="line">    a.show()</span><br></pre></td></tr></table></figure>
<p>这里定义了类AAA，并且上面的代码也能成功的执行。</p>
<p>注意：这里的AAA定义和原来完全不同了。</p>
<p>因此，序列化、反序列化必须保证使用同一套类的定义，否则会带来不可预料的结果。</p>
<h3 id="序列化应用"><a href="#序列化应用" class="headerlink" title="序列化应用"></a>序列化应用</h3><p>一般来说，本地序列化的情况，应用较少。大多数场景都应用在网络传输中。将数据序列化后通过网络传输到远程节点，远程服务器上的服务将接收到的数据反序列化后，就可以使用了。但是，要注意一点，远程接收端，反序列化时必须有对应的数据类型，否则就会报错。尤其是自定义类，必须远程得有一致的定义。现在，大多数项目，都不是单机的，也不是单服务的。需要通过网络将数据传送到其他节点上去，这就需要大量的序列化、反序列化过程。但是，问题是，Python程序之间还可以都使用pickle解决序列化、反序列化，如果是跨平台、跨语言、跨协议，pickle就不太适合了，就需要公共的协议。例如XML、Json、Protocol Buffer等。不同的协议，效率不同、学习曲线不同，适用不同场景，要根据不同的情况分析选型。</p>
<h3 id="Json"><a href="#Json" class="headerlink" title="Json"></a>Json</h3><p>JSON(JavaScript Object Notation，JS对象标记)是一种轻量级的数据交换格式。它基于ECMAScript（w3c制定的JS规范）的一个子集，采用完全独立于编程语言的文本格式来存储和表示数据。</p>
<p><a href="http://json.org" target="_blank" rel="noopener">http://json.org</a></p>
<h3 id="Json的数据类型"><a href="#Json的数据类型" class="headerlink" title="Json的数据类型"></a>Json的数据类型</h3><ul>
<li>值</li>
</ul>
<p><strong><em>双引号</em></strong>引起来的字符串，数值，true和false，null，对象，数组，这些都是值</p>
<p><img src="/images/python序列化与反序列化/json1.png" alt=""></p>
<ul>
<li>字符串</li>
</ul>
<p>由双引号包围起来的任意字符的组合，可以有转义字符。</p>
<ul>
<li>数值</li>
</ul>
<p>有正负，有整数、浮点数。</p>
<ul>
<li>对象</li>
</ul>
<p>无序的键值对的集合</p>
<p>格式：<code>{key1:value1,...,keyn:valuen}</code></p>
<p>key必须是一个字符串，需要双引号包围这个字符串。</p>
<p>value可以是任意合法的值</p>
<p><img src="/images/python序列化与反序列化/json2.png" alt=""></p>
<ul>
<li>数组</li>
</ul>
<p>有序的值的集合</p>
<p>格式：<code>[val1,...,valn]</code></p>
<p><img src="/images/python序列化与反序列化/json3.png" alt=""></p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"person"</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="string">"name"</span>:<span class="string">"tom"</span>,</span><br><span class="line">         <span class="string">"age"</span>:<span class="number">18</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="string">"name"</span>:<span class="string">"jerry"</span>,</span><br><span class="line">         <span class="string">"age"</span>:<span class="number">16</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"total"</span>:<span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Json模块"><a href="#Json模块" class="headerlink" title="Json模块"></a><strong><em>Json模块</em></strong></h3><h4 id="Python与Json"><a href="#Python与Json" class="headerlink" title="Python与Json"></a>Python与Json</h4><p>Python支持少量内建数据类型到Json类型的转换。</p>
<table>
<thead>
<tr>
<th>Python类型</th>
<th>Json类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>True</td>
<td>true</td>
</tr>
<tr>
<td>False</td>
<td>false</td>
</tr>
<tr>
<td>None</td>
<td>null</td>
</tr>
<tr>
<td>str</td>
<td>string</td>
</tr>
<tr>
<td>int</td>
<td>integer</td>
</tr>
<tr>
<td>float</td>
<td>float</td>
</tr>
<tr>
<td>list</td>
<td>array</td>
</tr>
<tr>
<td>dict</td>
<td>object</td>
</tr>
</tbody>
</table>
<h4 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h4><table>
<thead>
<tr>
<th>Python类型</th>
<th>Json类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>dumps</td>
<td>json编码</td>
</tr>
<tr>
<td>dump</td>
<td>json编码并存入文件</td>
</tr>
<tr>
<td>loads</td>
<td>json解码</td>
</tr>
<tr>
<td>load</td>
<td>json解码，从文件读取数据</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">d = &#123;<span class="string">'name'</span>:<span class="string">'Tom'</span>,<span class="string">'age'</span>:<span class="number">20</span>,<span class="string">'interest'</span>:[<span class="string">'music'</span>,<span class="string">'movie'</span>]&#125;</span><br><span class="line">j = json.dumps(d)</span><br><span class="line">print(j)   <span class="comment"># 请注意引号的变化</span></span><br><span class="line"></span><br><span class="line">d1 = json.loads(j)</span><br><span class="line">print(d1)</span><br></pre></td></tr></table></figure>
<p>一般json编码的数据很少落地，数据都是通过网络传输。传输的时候，要考虑压缩它。本质上来说它就是个文本，就是个字符串。json很简单，几乎语言编程都支持Json，所以应用范围十分广泛。</p>
<h3 id="MessagePack"><a href="#MessagePack" class="headerlink" title="MessagePack"></a>MessagePack</h3><p>MessagePack是一个基于二进制高效的对象序列化类库，可用于跨语言通信。它可以像JSON那样，在许多种语言之间交换结构对象。但是它比JSON更快速也更轻巧。支持Python、Ruby、Java、C/C++等众多语言。宣称比Google Protocol还要快4倍。兼容json和pickle。</p>
<p><img src="/images/python序列化与反序列化/messagepack1.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 72 bytes</span></span><br><span class="line">&#123;<span class="string">"person"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"tom"</span>,<span class="string">"age"</span>:<span class="number">18</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"jerry"</span>,<span class="string">"age"</span>:<span class="number">16</span>&#125;],<span class="string">"total"</span>:<span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 48 bytes</span></span><br><span class="line"><span class="comment"># 82 a6 70 65 72 73 6f 6e 92 82 a4 6e 61 6d 65 a3 74 6f 6d a3 61 67 65 12 82 a4 64</span></span><br><span class="line"><span class="number">61</span> <span class="number">6</span>d <span class="number">65</span> a5 <span class="number">6</span>a <span class="number">65</span> <span class="number">72</span> <span class="number">72</span> <span class="number">79</span> a3 <span class="number">61</span> <span class="number">67</span> <span class="number">65</span> <span class="number">10</span> a5 <span class="number">74</span> <span class="number">6</span>f <span class="number">74</span> <span class="number">61</span> <span class="number">6</span>c <span class="number">02</span></span><br></pre></td></tr></table></figure>
<p>可以看出，大大的节约了空间。</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><code>pip install msgpack-python</code></p>
<h4 id="常用方法-1"><a href="#常用方法-1" class="headerlink" title="常用方法"></a>常用方法</h4><p>packb序列化对象。提供了dumps来兼容pickle和json。</p>
<p>unpackb 反序列化对象。提供了loads来兼容。</p>
<p>pack 序列化对象保存到文件对象。提供了dump来兼容。</p>
<p>unpack 反序列化对象保存到文件对象。提供了load来兼容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> msgpack</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 源数据</span></span><br><span class="line">d = &#123;<span class="string">'person'</span>:[&#123;<span class="string">'name'</span>:<span class="string">'tom'</span>,<span class="string">'age'</span>:<span class="number">18</span>&#125;,&#123;<span class="string">'name'</span>:<span class="string">'jerry'</span>,<span class="string">'age'</span>:<span class="number">16</span>&#125;],<span class="string">'total'</span>:<span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line">j = json.dumps(d)</span><br><span class="line">m = msgpack.dumps(d)   <span class="comment"># 本质上就是packb</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"json = &#123;&#125;,msgpack = &#123;&#125;"</span>.format(len(j),len(m)))</span><br><span class="line">print(j.encode(),len(j.encode()))   <span class="comment"># json和msgpack的比较</span></span><br><span class="line">print(m,len(m))</span><br><span class="line"></span><br><span class="line">u = msgpack.unpackb(m)</span><br><span class="line">print(type(u),u)</span><br><span class="line"></span><br><span class="line">u = msgpack.unpackb(m, encoding=<span class="string">'utf8'</span>)</span><br><span class="line">print(type(u),u)</span><br></pre></td></tr></table></figure>
<p>MessagePack简单易用，高效压缩，支持语言丰富。</p>
<p>所以，用它序列化也是一种很好的选择。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/09/python基础学习-处理csv与ini文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/09/python基础学习-处理csv与ini文件/" itemprop="url">
                  python基础学习-处理csv与ini文件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-09 11:57:38" itemprop="dateCreated datePublished" datetime="2020-01-09T11:57:38+08:00">2020-01-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="CSV文件简介"><a href="#CSV文件简介" class="headerlink" title="CSV文件简介"></a>CSV文件简介</h3><p>参考RFC 4180</p>
<p><a href="http://www.ietf.org/rfc/rfc4180.txt" target="_blank" rel="noopener">http://www.ietf.org/rfc/rfc4180.txt</a></p>
<p>逗号分隔值 Comma-Separated Values。</p>
<p>CSV是一个被行分隔符、列分隔符划分成行和列的文本文件。</p>
<p>CSV不指定字符编码</p>
<p>行分隔符为\r\n，最后一行可以没有换行符</p>
<p>列分隔符常为逗号或者制表符</p>
<p>每一行称为一条记录record</p>
<p>字段可以使用双引号括起来，也可以不使用。如果字段中出现了双引号、逗号、换行符必须使用双引号括起来。如果字段的值是双引号，使用两个双引号表示一个转义。</p>
<p>表头可选，和字段列对齐就行了。</p>
<h3 id="手动生成CSV文件"><a href="#手动生成CSV文件" class="headerlink" title="手动生成CSV文件"></a>手动生成CSV文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">p = Path(<span class="string">'o:/tmp/mycsv/test.csv'</span>)</span><br><span class="line">parent = p.parent</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> parent.exists():</span><br><span class="line"><span class="comment"># exists()表示此路径是否指向一个已存在的文件或目录</span></span><br><span class="line">    parent.mkdir(parents=<span class="keyword">True</span>)</span><br><span class="line">    </span><br><span class="line">csv_body = <span class="string">'''\</span></span><br><span class="line"><span class="string">id,name,age,comment</span></span><br><span class="line"><span class="string">1,zs,18,"I'm 18"</span></span><br><span class="line"><span class="string">2,ls,20,"this is a ""test""string."</span></span><br><span class="line"><span class="string">3,ww,23,"你好</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">计算机</span></span><br><span class="line"><span class="string">"</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p.write_text(csv_body)</span><br></pre></td></tr></table></figure>
<h3 id="CSV模块"><a href="#CSV模块" class="headerlink" title="CSV模块"></a>CSV模块</h3><p><code>reader(csvfile,dialect=&#39;excel&#39;,**fmtparams)</code></p>
<p>返回DictReader对象，是一个行迭代器。</p>
<p>delimiter 列分隔符，逗号</p>
<p>lineterminator 行分隔符\r\n</p>
<p>quotechar 字段的引用符号，缺省为”，双引号</p>
<p>双引号的处理：</p>
<p>doublequote 双引号的处理，默认为True。如果和quotechar为同一个，True则使用2个双引号表示，False表示使用转义字符将作为双引号的前缀。</p>
<p>escapechar 一个转义字符，默认为None。</p>
<p>quoting 指定双引号的规则。QUOTE_ALL 所有字段；QUOTE_MINIMAL 特殊字符字段；QUOTE_NONNUMERIC 非数字字段；QUOTE_NONE都不使用引号。</p>
<p><code>writer(csvfile, dialect=&#39;excel&#39;, **fmtparams)</code></p>
<p>返回DictWriter的实例。对于 <code>Writer</code> 对象，<em>行</em> 必须是（一组可迭代的）字符串或数字。</p>
<p>主要方法有 writerow、writerows。</p>
<ul>
<li><p><code>csvwriter.writerow</code>(<em>row</em>)</p>
<p>将参数 <em>row</em> 写入 writer 的文件对象，并根据当前设置的变种进行格式化。本方法的返回值就是底层文件对象 <em>write</em> 方法的返回值。在 3.5 版更改: 开始支持任意类型的迭代器。</p>
</li>
<li><p><code>csvwriter.writerows</code>(<em>rows</em>)</p>
<p>将 <em>rows\</em>（即能迭代出多个上述 <em>row</em> 对象的迭代器）中的所有元素写入 writer 的文件对象，并根据当前设置的变种进行格式化。</p>
</li>
</ul>
<p>writerow(iterable)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line">p = Path(<span class="string">'o:/tmp/mycsv/test.csv'</span>)</span><br><span class="line"><span class="keyword">with</span> open(str(p)) <span class="keyword">as</span> f:</span><br><span class="line">    reader = csv.reader(f)</span><br><span class="line">    print(next(reader))</span><br><span class="line">    print(next(reader))</span><br><span class="line">    </span><br><span class="line">rows = [</span><br><span class="line">	[<span class="number">4</span>,<span class="string">'tom'</span>,<span class="number">22</span>,<span class="string">'tom'</span>],</span><br><span class="line">	(<span class="number">5</span>,<span class="string">'jerry'</span>,<span class="number">24</span>,<span class="string">'jerry'</span>),</span><br><span class="line">	(<span class="number">6</span>,<span class="string">'justin'</span>,<span class="number">22</span>,<span class="string">'just\t"in'</span>),</span><br><span class="line">	<span class="string">"abcdefghi"</span>,</span><br><span class="line">	((<span class="number">1</span>,),(<span class="number">2</span>,))</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 不要忘记每个元素后面的逗号</span></span><br><span class="line">row = rows[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">with</span> open(str(p),<span class="string">'a'</span>) <span class="keyword">as</span> f:   <span class="comment"># 向test.csv中追加内容</span></span><br><span class="line">    writer = csv.writer(f)</span><br><span class="line">    writer.writerow(row)  <span class="comment"># 写入一行</span></span><br><span class="line">    writer.writerows(rows)  <span class="comment"># 写入多行</span></span><br></pre></td></tr></table></figure>
<h3 id="ini文件处理"><a href="#ini文件处理" class="headerlink" title="ini文件处理"></a>ini文件处理</h3><p>作为配置文件，ini文件格式很流行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">a = test</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /dbserver/data</span><br><span class="line">port = <span class="number">33060</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line">sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span><br></pre></td></tr></table></figure>
<p>中括号里面的部分称为section，译作节、区、段。</p>
<p>每一个section内，都是key=value形成的键值对，key称为option选项。</p>
<p>注意，这里的DEFAULT是缺省section的名字，必须大写。</p>
<h3 id="configparser"><a href="#configparser" class="headerlink" title="configparser"></a>configparser</h3><p>configparser模块的ConfigParser类就是用来操作的。</p>
<p>可以将section当做key，section存储着键值对组成的字典，可以把ini配置文件当做一个嵌套的字典。默认使用的是有序字典。</p>
<p><code>read(filenames, encoding=None)</code></p>
<p>读取ini文件，可以是单个文件，也可以是文件列表。可以指定文件编码。</p>
<p><code>sections()</code> 返回section列表。缺省section不包括在内。</p>
<p><code>add_section(section_name)</code>增加一个section</p>
<p><code>has_section(section_name)</code> 判断section是否存在</p>
<p><code>options(section)</code> 返回section的所有option，会追加缺省section的option</p>
<p><code>has_option(section, option)</code> 判断section是否存在这个option</p>
<p><code>get(section, option, *, raw=False, vars=None[, fallback])</code> 从指定的段的选项上取值，如果找到返回，如果没有找到就去找DEFAULT段有没有。</p>
<p><code>getint(section, option, *, raw=False, vars=None[, fallback])</code></p>
<p><code>getfloat(section, option, *, raw=False, vars=None[, fallback])</code></p>
<p><code>getboolean(section, option, *, raw=False, vars=None[, fallback])</code></p>
<p>上面三个方法和get一样，返回指定类型数据。</p>
<p><code>items(raw=False, vars=None)</code></p>
<p><code>items(section, raw=False, vars=None)</code></p>
<p>没有section，则返回所有section名字及其对象；如果指定section，则返回这个指定的section的键值对组成二元组。</p>
<p><code>set(section, option, value)</code>  section存在的情况下，写入option=value，要求option、value必须是字符串。</p>
<p><code>remove_section(section)</code> 移除section及其所有option</p>
<p><code>remove_option(section, option)</code>  移除section下的option。</p>
<p><code>write(fileobject, space_around_delimiters=True)</code> 将当前config的所有内容写入fileobject中，一般open函数使用w模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> configparser <span class="keyword">import</span> ConfigParser</span><br><span class="line"></span><br><span class="line">filename = <span class="string">'test.ini'</span></span><br><span class="line">newfilename = <span class="string">'mysql.ini'</span></span><br><span class="line"></span><br><span class="line">cfg = ConfigParser()</span><br><span class="line">cfg.read(filename)</span><br><span class="line">print(cfg.sections())</span><br><span class="line">print(cfg.has_section(<span class="string">'client'</span>))</span><br><span class="line"></span><br><span class="line">print(cfg.items(<span class="string">'mysqld'</span>))</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> cfg.items():</span><br><span class="line">    print(k,type(v))</span><br><span class="line">    print(k,cfg.items(k))</span><br><span class="line">tmp = cfg.get(<span class="string">'mysqld'</span>,<span class="string">'port'</span>)</span><br><span class="line">print(type(tmp),tmp)</span><br><span class="line">print(cfg.get(<span class="string">'mysqld'</span>,<span class="string">'a'</span>))</span><br><span class="line"><span class="comment"># print(cfg.get('mysqld','magedu'))</span></span><br><span class="line">print(cfg.get(<span class="string">'mysqld'</span>,<span class="string">'magedu'</span>,fallback=<span class="string">'python'</span>))</span><br><span class="line"></span><br><span class="line">tmp = cfg.getint(<span class="string">'mysqld'</span>,<span class="string">'port'</span>)</span><br><span class="line">print(type(tmp),tmp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cfg.has_section(<span class="string">'test'</span>):</span><br><span class="line">    cfg.remove_section(<span class="string">'test'</span>)</span><br><span class="line">    </span><br><span class="line">cfg.add_section(<span class="string">'test'</span>)</span><br><span class="line">cfg.set(<span class="string">'test'</span>,<span class="string">'test1'</span>,<span class="string">'1'</span>)</span><br><span class="line">cfg.set(<span class="string">'test'</span>,<span class="string">'test2'</span>,<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(newfilename,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cfg.write(f)</span><br><span class="line">    </span><br><span class="line">print(cfg.getint(<span class="string">'test'</span>,<span class="string">'test2'</span>))</span><br><span class="line">cfg.remove_option(<span class="string">'test'</span>,<span class="string">'test2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字典操作更简单</span></span><br><span class="line">cfg[<span class="string">'test'</span>][<span class="string">'x'</span>] = <span class="string">'100'</span>   <span class="comment"># key不存在</span></span><br><span class="line">cfg[<span class="string">'test2'</span>] = &#123;<span class="string">'test2'</span>:<span class="string">'1000'</span>&#125;   <span class="comment"># section不存在</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'x'</span> <span class="keyword">in</span> cfg[<span class="string">'test'</span>])</span><br><span class="line">print(<span class="string">'x'</span> <span class="keyword">in</span> cfg[<span class="string">'test2'</span>])</span><br><span class="line"></span><br><span class="line">print(cfg._dict)   <span class="comment"># 返回默认字典类型，内部使用有序字典</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改后需要再次写入</span></span><br><span class="line"><span class="keyword">with</span> open(newfilename,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cfg.write(f)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/09/nmcli命令使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/09/nmcli命令使用/" itemprop="url">
                  nmcli命令使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-09 08:51:42" itemprop="dateCreated datePublished" datetime="2020-01-09T08:51:42+08:00">2020-01-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>nmcli命令 是 NetworkManager client 网络管理客户端。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p><code>nmcli [OPTIONS] OBJECT { COMMAND | help }</code></p>
<h4 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h4><p>OBJECT和COMMAND可以用全称也可以用简称，最少可以只用一个字母，建议用头三个字母。OBJECT里面我们平时用的最多的就是connection和device。device叫网络接口，是物理设备。connection是连接，偏重于逻辑设置。多个connection可以应用到同一个device，但同一时间只能启用其中一个connection。这样的好处是针对一个网络接口，我们可以设置多个网络连接，比如静态IP和动态IP，再根据需要up相应connection。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS   </span><br><span class="line">-t[erse]                                  # terse output 简洁的输出   </span><br><span class="line">-p[retty]                                 # pretty output 漂亮的输出   </span><br><span class="line">-m[ode] tabular|multiline                 # output mode  输出模式   </span><br><span class="line">-f[ields] &lt;field1,field2,...&gt;|all|common  # specify fields to output 指定要输出的字段   </span><br><span class="line">-e[scape] yes|no                          # escape columns separators in values 在值中转义列分隔符   </span><br><span class="line">-n[ocheck]                                # 不要检查nmcli和NetworkManager版本   </span><br><span class="line">-a[sk]                                    # 要求缺少参数   </span><br><span class="line">-w[ait] &lt;seconds&gt;                         # 设置超时等待整理操作   </span><br><span class="line">-v[ersion]                                # 显示程序版本   </span><br><span class="line">-h[elp]                                   # 打印此帮助  </span><br><span class="line"></span><br><span class="line">OBJECT   </span><br><span class="line">g[eneral]       # NetworkManager的一般状态和操作   </span><br><span class="line">n[etworking]    # 整体组网控制   </span><br><span class="line">r[adio]         # NetworkManager切换开关   </span><br><span class="line">c[onnection]    # NetworkManager的连接   </span><br><span class="line">d[evice]        # 由NetworkManager管理的设备   </span><br><span class="line">a[gent]         # NetworkManager秘密代理或polkit代理</span><br></pre></td></tr></table></figure>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">***修改网卡的IP地址并添加DNS***</span><br><span class="line">nmcli connection modify enp0s3 ipv4.method manual autoconnect yes ipv4.addresses 192.168.1.115/24 gw4 192.168.1.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改现在网卡的IP地址，并设置为静态地址。指定地址要用ipv4.addresses选项，不能用选项。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> autoconnect yes是控制配置文件中的ONBOOT是yes还是no的。配置文件就是</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/sysconfig/network-scripts/ifcfg-enp0s3。</span></span><br><span class="line">nmcli connection modify enp0s3 ipv4.dns 114.114.114.114</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定dns地址。改变地址与DNS都需要重启接口</span></span><br><span class="line">nmcli con up enp0s3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启，立即生效。不要使用nmcli con down enp0s3后再使用nmcli con up enp0s3，如果这样操作的话，会</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在现有的网卡上再添加一个地址。立即生效的方法还有nmcli dev reapply enp0s3和nmcli dev connect enp0s3，未测试</span></span><br><span class="line"></span><br><span class="line">删除网卡上的IP地址</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在网卡有多个IP地址时可以删除，也可以使用加号添加</span></span><br><span class="line">nmcli connection modify enp0s3 -ipv4.addresses 192.168.1.112/24</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用加减号来控制添加或删除一个地址，如上面就是删除一个地址</span></span><br><span class="line">nmcli con up enp0s3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启才能生效</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">给现有网卡添加一个新的地址</span><br><span class="line">nmcli con modify enp0s3 ip4 192.168.1.105/24 gw4 192.168.1.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给现在的接口添加一个新ip地址，这样网卡就有两个地址了</span></span><br><span class="line">nmcli con up enp0s3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试发现，如果通过编辑配置文件修改地址后，要先重启NetworkManager再使用此命令启动网卡，才能使地址生</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 效，不然直接使用此命令是无法使地址生效的。</span></span><br><span class="line"></span><br><span class="line">***给现有网卡创建一个新的connection***</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样创建后，一块网卡就会有多个配置，这样就可以用不同配置启动网卡了，但只能有一个connection是连接的</span></span><br><span class="line">nmcli con add con-name dhcp type ethernet ifname eno16777728</span><br><span class="line"><span class="meta">#</span><span class="bash"> 动态获取IP方式的网络连接配置</span></span><br><span class="line">nmcli con add con-name static ifname eno16777728 autoconnect yes type ethernet ip4 10.1.254.254/16 gw4 10.1.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定静态IP方式的网络连接配置，添加新的连接，连接名用con-name指定为eno16777728，<span class="built_in">type</span>指定类型，ifname指定接口名</span></span><br><span class="line"></span><br><span class="line">nmcli net on/off</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用/关闭所有的网络连接</span></span><br><span class="line">nmcli dev dis eno33554960</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用网络设备并防止自动激活</span></span><br><span class="line">nmcli con add help</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看添加网络连接配置的帮助</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改网络连接单项参数</span></span><br><span class="line">nmcli con mod IF-NAME connection.autoconnect yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改为自动连接</span></span><br><span class="line">nmcli con mod IF-NAME ipv4.method manual | dhcp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改IP地址是静态还是DHCP</span></span><br><span class="line">nmcli con mod IF-NAME ipv4.addresses “172.25.X.10/24 172.25.X.254”</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改IP配置及网关</span></span><br><span class="line">nmcli con mod IF-NAME ipv4.gateway 10.1.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改默认网关</span></span><br><span class="line">nmcli con mod IF-NAME +ipv4.addresses 10.10.10.10/16</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加第二个IP地址</span></span><br><span class="line">nmcli con mod IF-NAME ipv4.dns 114.114.114.114</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加dns1</span></span><br><span class="line">nmcli con mod IF-NAME +ipv4.dns  8.8.8.8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加dns2</span></span><br><span class="line">nmcli con mod IF-NAME -ipv4.dns  8.8.8.8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除dns</span></span><br><span class="line"></span><br><span class="line">nmcli connection show           </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前连接状态 </span></span><br><span class="line">nmcli connection show --active       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示活动的网络连接 </span></span><br><span class="line">nmcli connection show eno16777736    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示指定网络连接的详情 </span></span><br><span class="line">nmcli device status                </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示网络设备状态 </span></span><br><span class="line">nmcli device show eno16777736   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示指定网络设备的详情</span></span><br><span class="line">nmcli device show               </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示全部网络接口属性 </span></span><br><span class="line">nmcli con up static             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用static连接配置 </span></span><br><span class="line">nmcli con up default            </span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用default连接配置  </span></span><br><span class="line">nmcli con add help              </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看帮助</span></span><br><span class="line">nmcli con up eno16777728</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用网络连接</span></span><br><span class="line">nmcli con down eno33554960</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停用网络连接（可被自动激活）</span></span><br><span class="line">nmcli con del eno33554960</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除网络连接的配置文件</span></span><br><span class="line">nmcli con reload</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新加载配置网络配置文件</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/02/python基础学习-路径操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/02/python基础学习-路径操作/" itemprop="url">
                  python基础学习-路径操作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-02 17:42:12" itemprop="dateCreated datePublished" datetime="2020-01-02T17:42:12+08:00">2020-01-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="路径操作模块"><a href="#路径操作模块" class="headerlink" title="路径操作模块"></a>路径操作模块</h3><h4 id="3-4版本之前"><a href="#3-4版本之前" class="headerlink" title="3.4版本之前"></a>3.4版本之前</h4><ul>
<li>os.path模块</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">p = path.join(<span class="string">'/etc'</span>,<span class="string">'sysconfig'</span>,<span class="string">'network'</span>)</span><br><span class="line"><span class="comment"># 构建一个目录</span></span><br><span class="line">print(type(p),p)</span><br><span class="line"><span class="comment"># 如果是windows系统，这里的/会有问题</span></span><br><span class="line">print(path.exists(p))  <span class="comment"># 返回一个布尔型数据</span></span><br><span class="line"><span class="comment"># 判断目录是否存在</span></span><br><span class="line">print(path.split(p))   <span class="comment"># (head,tail)</span></span><br><span class="line"><span class="comment"># 路径切割，把最后一个/后和其前面的路径切分开</span></span><br><span class="line">print(path.abspath(<span class="string">'.'</span>))</span><br><span class="line"><span class="comment"># 查看绝对路径，点代表当前路径</span></span><br><span class="line">p = path.join(<span class="string">'o:/'</span>,p,<span class="string">'test.txt'</span>)</span><br><span class="line">print(path.dirname(p))</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">print(path.basename(p))</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">print(path.splitdrive(p))</span><br><span class="line"><span class="comment"># 驱动器</span></span><br><span class="line"></span><br><span class="line">p1 = path.abspath(__file__)</span><br><span class="line">print(p1,path.basename(p1))</span><br><span class="line"><span class="keyword">while</span> p1 ~= path.dirname(p1):</span><br><span class="line">    p1 = path.dirname(p1)</span><br><span class="line">    print(p1,path.basename(p1))</span><br></pre></td></tr></table></figure>
<h4 id="3-4版本开始"><a href="#3-4版本开始" class="headerlink" title="3.4版本开始"></a>3.4版本开始</h4><p>建议使用pathlib模块，提供Path对象来操作。包括目录和文件。</p>
<h3 id="pathlib模块"><a href="#pathlib模块" class="headerlink" title="pathlib模块"></a>pathlib模块</h3><p><code>from pathlib import Path</code></p>
<h3 id="目录操作"><a href="#目录操作" class="headerlink" title="目录操作"></a>目录操作</h3><p>初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">p = Path()   <span class="comment"># 当前目录</span></span><br><span class="line">type(p)</span><br><span class="line"><span class="comment"># 这时p的类型就不是字符串了，而是pathlib下的一个类型，系统不同，这个类型也不同</span></span><br><span class="line">p = Path(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c/d'</span>)   <span class="comment"># 当前目录下的a/b/c/d。用逗号分隔，不需要使用/</span></span><br><span class="line">p = Path(<span class="string">'/etc'</span>)   <span class="comment"># 根下的etc目录</span></span><br><span class="line">p.absolute()</span><br><span class="line"><span class="comment"># 查看绝对路径</span></span><br><span class="line">p = p.joinpath(<span class="string">'a'</span>,<span class="string">'b'</span>)</span><br><span class="line"><span class="comment"># 做一个a/b目录路径</span></span><br><span class="line">p.absolute()</span><br><span class="line"><span class="comment"># 查看上面做的路径，但目录并没有创建 </span></span><br><span class="line">p = p / <span class="string">'c'</span> / <span class="string">'d'</span></span><br><span class="line">p</span><br><span class="line"><span class="comment"># 输出：PosixPath('a/b/c/d')</span></span><br><span class="line">p /= <span class="string">'e'</span></span><br><span class="line"><span class="comment"># 这相当于加等，输出：PosixPath('a/b/c/d/e')</span></span><br><span class="line">p1 = Path(<span class="string">'/etc'</span>)</span><br><span class="line"><span class="comment"># 做一个绝对路径</span></span><br><span class="line">p1.absolute()</span><br><span class="line"><span class="comment"># 查看绝对路径 </span></span><br><span class="line">p2 = <span class="string">'/'</span> / <span class="string">'etc'</span> / <span class="string">'sysconfig'</span></span><br><span class="line"><span class="comment"># 这样是不对的，会报错。因为字符串拼接要用加号，这里用/表示除号，所以报错</span></span><br><span class="line">p2 = Path(<span class="string">''</span>)</span><br><span class="line"><span class="comment"># 这是定义p2为当前目录，也就是点</span></span><br><span class="line">p2 = <span class="string">'/etc'</span> / <span class="string">'sysconfig'</span></span><br><span class="line"><span class="comment"># 这样还是会报错，问题和上面一样</span></span><br><span class="line">p2 = p2 / <span class="string">'/etc'</span> / <span class="string">'sysconfig'</span></span><br><span class="line"><span class="comment"># 只有加上当前的路径，再加后面的字符串才可以。这相当于用/etc/sysconfig覆盖p2的路径</span></span><br><span class="line">p2.parts</span><br><span class="line"><span class="comment"># 分解路径，以/为分隔符</span></span><br><span class="line">p2.joinpath(<span class="string">'a/b'</span>,<span class="string">'c'</span>)</span><br><span class="line"><span class="comment"># 路径拼接</span></span><br><span class="line">str(p2)</span><br><span class="line"><span class="comment"># 获取字符串</span></span><br><span class="line">bytes(p2)</span><br><span class="line">p2.parent</span><br><span class="line"><span class="comment"># 显示父目录 </span></span><br><span class="line">p2.parent.parent</span><br><span class="line"><span class="comment"># 如果p2是当前路径，这样做的话，当前路径的父目录还是当前路径，要用p2.absolute().parent才可以</span></span><br><span class="line"></span><br><span class="line">list(p2.parents)</span><br><span class="line">p2 /= <span class="string">'a/b/c/d'</span></span><br><span class="line">list(p2.parents)</span><br><span class="line"><span class="comment"># 迭代目录组成列表</span></span><br><span class="line">next(iter(p2.parents))</span><br><span class="line"><span class="comment"># 先用iter将p2.parents的值变成迭代器，再用next拿一个。如果对象没有parents，也就是没有父目录，那么这</span></span><br><span class="line"><span class="comment">#  样使用会报错，没法再拿路径了</span></span><br></pre></td></tr></table></figure>
<p>路径拼接和分解</p>
<p><strong><em>操作符<code>/</code></em></strong></p>
<p>Path对象 / Path对象</p>
<p>Path对象 / 字符串 或者 字符串 / Path对象</p>
<p><strong><em>分解</em></strong></p>
<p>parts属性，可以返回路径中的每一个部分</p>
<p><strong><em>joinpath</em></strong></p>
<p><code>joinpath(*other)</code>连接多个字符串到Path对象中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p = Path()</span><br><span class="line">p = p / <span class="string">'a'</span></span><br><span class="line">p1 = <span class="string">'b'</span> / p</span><br><span class="line">p2 = Path(<span class="string">'c'</span>)</span><br><span class="line">p3 = p2 / p1</span><br><span class="line">print(p3.parts)</span><br><span class="line">pe.joinpath(<span class="string">'etc'</span>,<span class="string">'init.d'</span>,Path(<span class="string">'httpd'</span>))</span><br></pre></td></tr></table></figure>
<p>获取路径</p>
<p>str 获取路径字符串</p>
<p>bytes 获取路径字符串的bytes</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">'/etc'</span>)</span><br><span class="line">print(str(p),bytes(p))</span><br></pre></td></tr></table></figure>
<p>父目录</p>
<p>parent 目录的逻辑父目录</p>
<p>parents 父目录序列，索引0是直接的父</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">'/a/b/c/d'</span>)</span><br><span class="line">print(p.parent.parent)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> p.parents:</span><br><span class="line">    print(x)</span><br></pre></td></tr></table></figure>
<p>name、stem、suffix、suffixes、with_suffix(suffix)、with_name(name)</p>
<p>name：目录的最后一个部分</p>
<p>suffix：目录中最后一个部分的扩展名</p>
<p>stem：目录最后一个部分，没有后缀</p>
<p>suffixes：返回多个扩展名列表</p>
<p>with_suffix(suffix)：补充扩展名到路径尾部，返回新的路径，扩展名存在则无效</p>
<p>with_name(name)：替换目录最后一个部分并返回一个新的路径</p>
<p><strong>Path的方法拿到的大多数是对象，所以可以使用对象的方法拼接路径，这更方便。返回对象后方便对前面的结果继续处理，如使用<code>p2.parent.parent</code></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">'/magedu/mysqlinstall/mysql.tar.gz'</span>)</span><br><span class="line">print(p.name)</span><br><span class="line">print(p.suffix)</span><br><span class="line">print(p.suffixes)</span><br><span class="line">print(p.stem)</span><br><span class="line">print(p.with_name(<span class="string">'mysql-5.tgz'</span>))</span><br><span class="line">p = Path(<span class="string">'README'</span>)</span><br><span class="line">print(p.with_suffix(<span class="string">'.txt'</span>))</span><br></pre></td></tr></table></figure>
<p>cwd()：返回当前工作目录</p>
<p>home()：返回当前家目录</p>
<p>is_dir()：是否是目录，目录存在返回True</p>
<p>is_file()：是否是普通文件，文件存在返回True</p>
<p>is_symlink()：是否是软链接</p>
<p>is_socket()：是否是socket文件</p>
<p>is_block_device()：是否是块设备</p>
<p>is_char_device()：是否是字符设备</p>
<p>is_absolute()：是否是绝对路径</p>
<p>resolve()：返回一个新的路径，这个新路径就是当前Path对象的绝对路径，如果是软链接则直接被解析</p>
<p>absolute()：也可以获取绝对路径，但是推荐使用resolve()</p>
<p>exists()：目录或文件是否存在</p>
<p>rmdir()：删除空目录。没有提供判断目录为空的方法</p>
<p>touch(mode=0o666,exist_ok=True)：创建一个文件</p>
<p>as_uri()：将路径返回成URI，例如：file:///etc/passwd</p>
<p>mkdir(mode=0o777,parents=False,exist_ok=False)</p>
<p>parents：是否创建父目录，True等同于mkdir -p；False时，父目录不存在，则抛出FileNotFoundError；exist_ok参数，在3.5版本加入。False时，路径存在，抛出FileExistsError；True时，FileExistsError被忽略</p>
<p>iterdir()：迭代当前目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">p = Path()</span><br><span class="line">p /= <span class="string">'a/b/c/d'</span></span><br><span class="line">p.exists()   <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">p.mkdir()   <span class="comment"># FileNotFoundError</span></span><br><span class="line">p.mkdir(parents=<span class="keyword">True</span>)</span><br><span class="line">p.exists()   <span class="comment"># True</span></span><br><span class="line">p.mkdir(parents=<span class="keyword">True</span>)</span><br><span class="line">p.mkdir(parents=<span class="keyword">True</span>,exist_ok=<span class="keyword">True</span>)</span><br><span class="line">p /= <span class="string">'readme.txt'</span></span><br><span class="line">p.parent.rmdir()</span><br><span class="line">p.parent.exists()   <span class="comment"># False 'a/b/c'</span></span><br><span class="line">p.mkdir()   <span class="comment"># FileNotFoundError</span></span><br><span class="line">p.mkdir(parents=<span class="keyword">True</span>)   <span class="comment"># 成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历，并判断文件类型，如果是目录是否可以判断其是否为空？</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> p.parents[len(p.parents)<span class="number">-1</span>].iterdir():</span><br><span class="line"><span class="comment"># 迭代所有路径</span></span><br><span class="line">    print(x,end=<span class="string">'\t'</span>)</span><br><span class="line">    <span class="keyword">if</span> x.is_dir():</span><br><span class="line">        flag = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> x.iterdir():</span><br><span class="line"><span class="comment"># 如果能进来迭代，就证明目录不为空，下面就可以判断，如果是flag = false就是空目录，如果是True就不是空目录</span></span><br><span class="line">            flag = <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># for 循环是否可以使用else子句</span></span><br><span class="line">        print(<span class="string">'dir'</span>,<span class="string">'Not Empth'</span> <span class="keyword">if</span> flag <span class="keyword">else</span> <span class="string">'Empyt'</span>,sep=<span class="string">'\t'</span>)</span><br><span class="line">    <span class="keyword">elif</span> x.is_file():</span><br><span class="line">        print(<span class="string">'file'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'other file'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h4><p>glob(pattern)：通配给定的模式</p>
<p>rglob(pattern)：通配给定的模式，递归目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回一个生成器</span></span><br><span class="line">list(p.glob(<span class="string">'test*'</span>))   <span class="comment"># 返回当前目录对象下的test开头的文件</span></span><br><span class="line">list(p.glob(<span class="string">'**/*.py'</span>))   <span class="comment"># 递归所有目录，等同rglob</span></span><br><span class="line"><span class="comment"># 如果是*/*.py表示当前层，因为/前是一个星号。如果是**/*.py表示从当前路径算起往下所有目录，任意层次目录都要查找。.py前面的*表示任意个字符，/前的一个*表示任意一级，如果/前是两个*，表示任意个字符任意级</span></span><br><span class="line">g = p.rglob(<span class="string">'*.py'</span>)   <span class="comment"># 生成器，rglob表示递归查找</span></span><br><span class="line">next(g)</span><br></pre></td></tr></table></figure>
<h4 id="匹配"><a href="#匹配" class="headerlink" title="匹配"></a>匹配</h4><p>match(pattern)：模式匹配，成功返回True</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Path(<span class="string">'a/b.py'</span>).match(<span class="string">'*.py'</span>)   <span class="comment"># True</span></span><br><span class="line">Path(<span class="string">'/a/b/c.py'</span>).match(<span class="string">'b/*.py'</span>)   <span class="comment"># True</span></span><br><span class="line">Path(<span class="string">'/a/b/c.py'</span>).match(<span class="string">'a/*.py'</span>)   <span class="comment"># False</span></span><br><span class="line">Path(<span class="string">'/a/b/c.py'</span>).match(<span class="string">'a/*/*.py'</span>)   <span class="comment"># True</span></span><br><span class="line">Path(<span class="string">'/a/b/c.py'</span>).match(<span class="string">'z/**/*.py'</span>)   <span class="comment"># True</span></span><br><span class="line">Path(<span class="string">'/a/b/c.py'</span>).match(<span class="string">'**/*.py'</span>)   <span class="comment"># True</span></span><br></pre></td></tr></table></figure>
<p>stat()：相当于stat命令</p>
<p>lstat()同stat()，但如果是符号链接，则显示符号链接本身的文件信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ln -s test t</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">p = Path(<span class="string">'test'</span>)</span><br><span class="line">p.stat()</span><br><span class="line">p1 = Path(<span class="string">'t'</span>)</span><br><span class="line">p1.stat()</span><br><span class="line">p1.lstat()</span><br></pre></td></tr></table></figure>
<h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><p><code>open(mode=&#39;r&#39;,buffering=-1,encoding=None,errors=None,newline=None)</code></p>
<p>使用方法类似内奸函数open。返回一个文件对象</p>
<p>3.5增加的新函数</p>
<p>read_bytes()：以’rb’读取路径对应文件，并返回二进制流。看源码</p>
<p>read_text(encoding=None,errors=None)：以’rt’方式读取路径对应文件，返回文本</p>
<p>Path.write_bytes(data)：以’wb’方式写入数据到路径对应文件</p>
<p>write_text(data,encoding=None,errors=None)：以’wt’方式写入字符串到路径对应文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">'my_binary_file'</span>)</span><br><span class="line">p.write_bytes(<span class="string">b'Binary file contents'</span>)</span><br><span class="line">p.read_bytes()   <span class="comment"># b'Binary file contents'</span></span><br><span class="line"></span><br><span class="line">p = Path(<span class="string">'my_text_file'</span>)</span><br><span class="line">p.write_text(<span class="string">'Text file contents'</span>)</span><br><span class="line">p.read_text()   <span class="comment"># 'Text file contents'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">p = Path(<span class="string">'o:test.py'</span>)</span><br><span class="line">p.write_text(<span class="string">'hello python'</span>)</span><br><span class="line">print(p.read_text())</span><br><span class="line"><span class="keyword">with</span> p.open() <span class="keyword">as</span> f:</span><br><span class="line">    print(f.read(<span class="number">5</span>))</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/02/python基础学习-StringIO和BytesIO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/02/python基础学习-StringIO和BytesIO/" itemprop="url">
                  python基础学习-StringIO和BytesIO
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-02 17:24:53" itemprop="dateCreated datePublished" datetime="2020-01-02T17:24:53+08:00">2020-01-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="StringIO"><a href="#StringIO" class="headerlink" title="StringIO"></a>StringIO</h3><ul>
<li>io模块中的类<ul>
<li>from io import StringIO</li>
</ul>
</li>
<li>内存中，开辟的一个文本模式的buffer，可以像文件对象一样操作它</li>
<li><p>当close方法被调用的时候，这个buffer会被释放</p>
</li>
<li><p>getvalue() 获取全部内容。跟文件指针没有关系</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="comment"># 内存中构建</span></span><br><span class="line">sio = StringIO()   <span class="comment"># 像文件对象一样操作</span></span><br><span class="line">print(sio.readable(),sio.writable(),sio.seekable())</span><br><span class="line"><span class="comment"># 输出：True True True，表示可读，可写，也可seek</span></span><br><span class="line">sio.write(<span class="string">"magedu\nPython"</span>)</span><br><span class="line">sio.seek(<span class="number">0</span>)</span><br><span class="line">print(sio.readline())</span><br><span class="line">print(sio.getvalue())   <span class="comment"># 无视指针，输出全部内容</span></span><br><span class="line"><span class="comment"># getvalue()和sio.read()的效果是一样的，但getvalue()是无视指针的，无需使用seek到开头</span></span><br><span class="line">sio.close()</span><br></pre></td></tr></table></figure>
<ul>
<li>好处<ul>
<li>一般来说，磁盘的操作比内存的操作要慢得多，内存足够的情况下，一般的优化思想是少落地，减少磁盘IO的过程，可以大大提高程序的运行效率</li>
</ul>
</li>
</ul>
<h3 id="BytesIO"><a href="#BytesIO" class="headerlink" title="BytesIO"></a>BytesIO</h3><ul>
<li>io模块中的类<ul>
<li>from io import BytesIO</li>
</ul>
</li>
<li>内存中，开辟的一个二进制模式的buffer，可以像文件对象一样操作它</li>
<li>当close方法被调用的时候，这个buffer会被释放</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO   <span class="comment"># 内存中构建</span></span><br><span class="line">bio = BytesIO()</span><br><span class="line">print(bio.readable(),bio.writable(),bio.seekable())</span><br><span class="line">bio.write(<span class="string">b"magedu\nPython"</span>)</span><br><span class="line">bio.seek(<span class="number">0</span>)</span><br><span class="line">print(bio.readline())</span><br><span class="line">print(bio.getvalue())   <span class="comment"># 无视指针，输出全部内容</span></span><br><span class="line">bio.close()</span><br></pre></td></tr></table></figure>
<h3 id="file-like对象"><a href="#file-like对象" class="headerlink" title="file-like对象"></a>file-like对象</h3><ul>
<li>类文件对象，可以像文件对象一样操作</li>
<li>socket对象、输入输出对象(stdin、stdout) 都是类文件对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdout</span><br><span class="line">f = stdout</span><br><span class="line">print(type(f))</span><br><span class="line">f.write(<span class="string">'magedu.com'</span>)  <span class="comment"># 这是在屏幕输出的</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/02/python基础学习-转：面向对象编程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/02/python基础学习-转：面向对象编程/" itemprop="url">
                  python基础学习-转：面向对象编程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-02 17:22:27" itemprop="dateCreated datePublished" datetime="2020-01-02T17:22:27+08:00">2020-01-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017495723838528" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/1016959663602400/1017495723838528</a></p>
<p>面向对象编程——Object Oriented Programming，简称OOP，是一种程序设计思想。OOP把对象作为程序的基本单元，一个对象包含了数据和操作数据的函数。</p>
<p>面向过程的程序设计把计算机程序视为一系列的命令集合，即一组函数的顺序执行。为了简化程序设计，面向过程把函数继续切分为子函数，即把大块函数通过切割成小块函数来降低系统的复杂度。</p>
<p>而面向对象的程序设计把计算机程序视为一组对象的集合，而每个对象都可以接收其他对象发过来的消息，并处理这些消息，计算机程序的执行就是一系列消息在各个对象之间传递。</p>
<p>在Python中，所有数据类型都可以视为对象，当然也可以自定义对象。自定义的对象数据类型就是面向对象中的类（Class）的概念。</p>
<p>我们以一个例子来说明面向过程和面向对象在程序流程上的不同之处。</p>
<p>假设我们要处理学生的成绩表，为了表示一个学生的成绩，面向过程的程序可以用一个dict表示：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">std1</span> = &#123; <span class="string">'name'</span>: <span class="string">'Michael'</span>, <span class="string">'score'</span>: <span class="number">98</span> &#125;</span><br><span class="line"><span class="attr">std2</span> = &#123; <span class="string">'name'</span>: <span class="string">'Bob'</span>, <span class="string">'score'</span>: <span class="number">81</span> &#125;</span><br></pre></td></tr></table></figure>
<p>而处理学生成绩可以通过函数实现，比如打印学生的成绩：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_score</span><span class="params">(std)</span>:</span></span><br><span class="line">    print(<span class="string">'%s: %s'</span> % (std[<span class="string">'name'</span>], std[<span class="string">'score'</span>]))</span><br></pre></td></tr></table></figure>
<p>如果采用面向对象的程序设计思想，我们首选思考的不是程序的执行流程，而是<code>Student</code>这种数据类型应该被视为一个对象，这个对象拥有<code>name</code>和<code>score</code>这两个属性（Property）。如果要打印一个学生的成绩，首先必须创建出这个学生对应的对象，然后，给对象发一个<code>print_score</code>消息，让对象自己把自己的数据打印出来。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="title">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, name, score)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">self</span>.score = score</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print_score</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        print(<span class="string">'%s: %s'</span> % (<span class="keyword">self</span>.name, <span class="keyword">self</span>.score))</span><br></pre></td></tr></table></figure>
<p>给对象发消息实际上就是调用对象对应的关联函数，我们称之为对象的方法（Method）。面向对象的程序写出来就像这样：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bart = Student('Bart Simpson', 59)</span><br><span class="line">lisa = Student('Lisa Simpson', 87)</span><br><span class="line">bart.print_score()</span><br><span class="line">lisa.print_score()</span><br></pre></td></tr></table></figure>
<p>面向对象的设计思想是从自然界中来的，因为在自然界中，类（Class）和实例（Instance）的概念是很自然的。Class是一种抽象概念，比如我们定义的Class——Student，是指学生这个概念，而实例（Instance）则是一个个具体的Student，比如，Bart Simpson和Lisa Simpson是两个具体的Student。</p>
<p>所以，面向对象的设计思想是抽象出Class，根据Class创建Instance。</p>
<p>面向对象的抽象程度又比函数要高，因为一个Class既包含数据，又包含操作数据的方法。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>数据封装、继承和多态是面向对象的三大特点</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/02/python基础学习-转：[翻译]理解Python的with语句/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/02/python基础学习-转：[翻译]理解Python的with语句/" itemprop="url">
                  python基础学习-转：[翻译]理解Python的with语句
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-02 09:06:50" itemprop="dateCreated datePublished" datetime="2020-01-02T09:06:50+08:00">2020-01-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="转：-翻译-理解Python的With语句"><a href="#转：-翻译-理解Python的With语句" class="headerlink" title="转：[翻译] 理解Python的With语句"></a>转：[翻译] 理解Python的With语句</h1><p><a href="http://linbo.github.io/2013/01/08/python-with#comments" target="_blank" rel="noopener">http://linbo.github.io/2013/01/08/python-with#comments</a>)</p>
<h2 id="With语句是什么？"><a href="#With语句是什么？" class="headerlink" title="With语句是什么？"></a>With语句是什么？</h2><p>Python’s with statement provides a very convenient way of dealing with the situation where you have to do a setup and teardown to make something happen. A very good example for this is the situation where you want to gain a handler to a file, read data from the file and the close the file handler.</p>
<p>有一些任务，可能事先需要设置，事后做清理工作。对于这种场景，Python的with语句提供了一种非常方便的处理方式。一个很好的例子是文件处理，你需要获取一个文件句柄，从文件中读取数据，然后关闭文件句柄。</p>
<p>Without the with statement, one would write something along the lines of:</p>
<p>如果不用with语句，代码如下：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">file</span> = <span class="built_in">open</span>(<span class="string">"/tmp/foo.txt"</span>)</span><br><span class="line">data = <span class="built_in">file</span>.<span class="built_in">read</span>()</span><br><span class="line"><span class="built_in">file</span>.<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure>
<p>There are two annoying things here. First, you end up forgetting to close the file handler. The second is how to handle exceptions that may occur once the file handler has been obtained. One could write something like this to get around this:</p>
<p>这里有两个问题。一是可能忘记关闭文件句柄；二是文件读取数据发生异常，没有进行任何处理。下面是处理异常的加强版本：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">file</span> = <span class="built_in">open</span>(<span class="string">"/tmp/foo.txt"</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    data = <span class="built_in">file</span>.<span class="built_in">read</span>()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="built_in">file</span>.<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure>
<p>While this works well, it is unnecessarily verbose. This is where with is useful. The good thing about with apart from the better syntax is that it is very good handling exceptions. The above code would look like this, when using with:</p>
<p>虽然这段代码运行良好，但是太冗长了。这时候就是with一展身手的时候了。除了有更优雅的语法，with还可以很好的处理上下文环境产生的异常。下面是with版本的代码：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"/tmp /foo.txt"</span>) <span class="keyword">as</span> <span class="built_in">file</span>:</span><br><span class="line">    data = <span class="built_in">file</span>.<span class="built_in">read</span>()</span><br></pre></td></tr></table></figure>
<p>with如何工作？ —— —</p>
<p>while this might look like magic, the way Python handles with is more clever than magic. The basic idea is that the statement after with has to evaluate an object that responds to an <strong>enter</strong>() as well as an <strong>exit</strong>() function.</p>
<p>这看起来充满魔法，但不仅仅是魔法，Python对with的处理还很聪明。基本思想是with所求值的对象必须有一个<strong>enter</strong>()方法，一个<strong>exit</strong>()方法。</p>
<p>After the statement that follows with is evaluated, the <strong>enter</strong>() function on the resulting object is called. The value returned by this function is assigned to the variable following as. After every statement in the block is evaluated, the <strong>exit</strong>() function is called.</p>
<p>紧跟with后面的语句被求值后，返回对象的<strong>enter</strong>()方法被调用，这个方法的返回值将被赋值给as后面的变量。当with后面的代码块全部被执行完之后，将调用前面返回对象的<strong>exit</strong>()方法。</p>
<p>This can be demonstrated with the following example:</p>
<p>下面例子可以具体说明with如何工作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># with_example01.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sample</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"In __enter__()"</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Foo"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, type, value, trace)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"In __exit__()"</span></span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_sample</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Sample()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> get_sample() <span class="keyword">as</span> sample:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"sample:"</span>, sample</span><br></pre></td></tr></table></figure>
<p>When executed, this will result in:<br>行代码，输出如下</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash-<span class="number">3.2</span>$ ./with_example01.py</span><br><span class="line"><span class="built_in">In</span> <span class="variable">__enter__</span>()</span><br><span class="line">sample: Foo</span><br><span class="line"><span class="built_in">In</span> <span class="variable">__exit__</span>()</span><br></pre></td></tr></table></figure>
<p>As you can see, The <strong>enter</strong>() function is executed The value returned by it - in this case “Foo” is assigned to sample The body of the block is executed, thereby printing the value of sample ie. “Foo” The <strong>exit</strong>() function is called. What makes with really powerful is the fact that it can handle exceptions. You would have noticed that the <strong>exit</strong>() function for Sample takes three arguments - val, type and trace. These are useful in exception handling. Let’s see how this works by modifying the above example.</p>
<p>正如你看到的，</p>
<ol>
<li><strong>enter</strong>()方法被执行</li>
<li><strong>enter</strong>()方法返回的值 - 这个例子中是”Foo”，赋值给变量’sample’</li>
<li>执行代码块，打印变量”sample”的值为 “Foo”</li>
<li><strong>exit</strong>()方法被调用</li>
</ol>
<p>with真正强大之处是它可以处理异常。可能你已经注意到Sample类的<strong>exit</strong>方法有三个参数- val, type 和 trace。 这些参数在异常处理中相当有用。我们来改一下代码，看看具体如何工作的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># with_example02.py</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sample</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, type, value, trace)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"type:"</span>, type</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"value:"</span>, value</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"trace:"</span>, trace</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_something</span><span class="params">(self)</span>:</span></span><br><span class="line">        bar = <span class="number">1</span>/<span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> bar + <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Sample() <span class="keyword">as</span> sample:</span><br><span class="line">    sample.do_something()</span><br></pre></td></tr></table></figure>
<p>Notice how in this example, instead of get_sample(), with takes Sample(). It does not matter, as long as the statement that follows with evaluates to an object that has an <strong>enter</strong>() and <strong>exit</strong>() functions. In this case, Sample()’s <strong>enter</strong>() returns the newly created instance of Sample and that is what gets passed to sample.</p>
<p>这个例子中，with后面的get_sample()变成了Sample()。这没有任何关系，只要紧跟with后面的语句所返回的对象有 <strong>enter</strong>()和<strong>exit</strong>()方法即可。此例中，Sample()的<strong>enter</strong>()方法返回新创建的Sample对象，并赋值给变量sample。</p>
<p>When executed:</p>
<p>代码执行后：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bash<span class="number">-3.2</span>$ ./with_example02.py</span><br><span class="line">type: &lt;type <span class="string">'exceptions.ZeroDivisionError'</span>&gt;</span><br><span class="line"><span class="built_in">value</span>: <span class="keyword">integer</span> division <span class="keyword">or</span> modulo <span class="keyword">by</span> <span class="literal">zero</span></span><br><span class="line">trace: &lt;traceback object <span class="keyword">at</span> <span class="number">0x1004a8128</span>&gt;</span><br><span class="line">Traceback (most recent call <span class="keyword">last</span>):</span><br><span class="line">  File <span class="string">"./with_example02.py"</span>, <span class="built_in">line</span> <span class="number">19</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    sample.do_somet hing()</span><br><span class="line">  File <span class="string">"./with_example02.py"</span>, <span class="built_in">line</span> <span class="number">15</span>, <span class="keyword">in</span> do_something</span><br><span class="line">    bar = <span class="number">1</span>/<span class="number">0</span></span><br><span class="line">ZeroDivisionError: <span class="keyword">integer</span> division <span class="keyword">or</span> modulo <span class="keyword">by</span> <span class="literal">zero</span></span><br></pre></td></tr></table></figure>
<p>Essentially, if there are exceptions being thrown from anywhere inside the block, the <strong>exit</strong>() function for the object is called. As you can see, the type, value and the stack trace associated with the exception thrown is passed to this function. In this case, you can see that there was a ZeroDivisionError exception being thrown. People implementing libraries can write code that clean up resources, close files etc. in their <strong>exit</strong>() functions.</p>
<p>实际上，在with后面的代码块抛出任何异常时，<strong>exit</strong>()方法被执行。正如例子所示，异常抛出时，与之关联的type，value和stack trace传给<strong>exit</strong>()方法，因此抛出的ZeroDivisionError异常被打印出来了。开发库时，清理资源，关闭文件等等操作，都可以放在<strong>exit</strong>方法当中。</p>
<p>Thus, Python’s with is a nifty construct that makes code a little less verbose and makes cleaning up during exceptions a bit easier.</p>
<p>因此，Python的with语句是提供一个有效的机制，让代码更简练，同时在异常产生时，清理工作更简单。</p>
<p>I have put the code examples given here on <a href="https://github.com/sdqali/python_dojo/tree/master/with%20Github" target="_blank" rel="noopener">Github</a>.</p>
<p>示例代码可以在<a href="https://github.com/sdqali/python_dojo/tree/master/with%20Github" target="_blank" rel="noopener">Github</a>上面找到。</p>
<p>译注：<a href="http://blog.sdqali.in/blog/2012/07/09/understanding-pythons-with/" target="_blank" rel="noopener">本文原文见</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/31/python基础学习-文件操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/31/python基础学习-文件操作/" itemprop="url">
                  python基础学习-文件操作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-12-31 15:42:08" itemprop="dateCreated datePublished" datetime="2019-12-31T15:42:08+08:00">2019-12-31</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><h4 id="冯诺依曼体系架构"><a href="#冯诺依曼体系架构" class="headerlink" title="冯诺依曼体系架构"></a>冯诺依曼体系架构</h4><p><img src="/images/python文件操作/冯诺依曼体系架构.png" alt=""></p>
<ul>
<li>CPU由运算器和控制器组成<ul>
<li>运算器，完成各种算数运算、逻辑运算、数据传输等数据加工处理</li>
<li>控制器，控制程序的执行</li>
<li>存储器，用于记忆程序和数据，例如内存</li>
<li>输入设备，将数据或者程序输入到计算机中，例如键盘、鼠标</li>
<li>输出设备，将数据或程序的处理结果展示给用户，例如显示器、打印机等</li>
</ul>
</li>
</ul>
<p>一般说IO操作，指的是文件IO，如果指的是网络IO，都会直接说网络IO</p>
<h3 id="文件IO常用操作"><a href="#文件IO常用操作" class="headerlink" title="文件IO常用操作"></a>文件IO常用操作</h3><table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>open</td>
<td>打开</td>
</tr>
<tr>
<td>read</td>
<td>读取</td>
</tr>
<tr>
<td>write</td>
<td>写入</td>
</tr>
<tr>
<td>close</td>
<td>关闭</td>
</tr>
<tr>
<td>readline</td>
<td>行读取</td>
</tr>
<tr>
<td>readlines</td>
<td>多行读取</td>
</tr>
<tr>
<td>seek</td>
<td>文件指针操作</td>
</tr>
<tr>
<td>tell</td>
<td>指针位置</td>
</tr>
</tbody>
</table>
<h4 id="打开操作"><a href="#打开操作" class="headerlink" title="打开操作"></a>打开操作</h4><p><code>open(file,mode=&#39;r&#39;,buffering=-1,encoding=None,errors=None,newline=None,closefd=True,opener=None)</code></p>
<p>打开一个文件，返回一个文件对象(流对象)和文件描述符。打开文件失败，则返回异常</p>
<p>基本使用：</p>
<p>创建一个文件test，然后打开它，用完关闭</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开ipython</span></span><br><span class="line">f = open(<span class="string">"test"</span>)   <span class="comment"># file对象</span></span><br><span class="line"><span class="comment"># windows &lt;_io.TextIOWrapper name='test' mode='r' encoding='cp936'&gt;</span></span><br><span class="line"><span class="comment"># linux &lt;_io.TextIOWrapper name='test' mode='r' encoding='UTF-8'&gt;</span></span><br><span class="line">print(f.read())   <span class="comment"># 读取文件</span></span><br><span class="line">f.close()   <span class="comment"># 关闭文件</span></span><br></pre></td></tr></table></figure>
<p>文件操作中，最常用的操作就是读和写。</p>
<p>文件访问的模式有两种：文本模式和二进制模式。不同模式下，操作函数不尽相同，表现的结果也不一样。</p>
<h5 id="open的参数"><a href="#open的参数" class="headerlink" title="open的参数"></a>open的参数</h5><h6 id="file"><a href="#file" class="headerlink" title="file"></a>file</h6><p>打开或者要创建的文件名。如果不指定路径，默认是当前路径</p>
<h6 id="mode模式"><a href="#mode模式" class="headerlink" title="mode模式"></a>mode模式</h6><table>
<thead>
<tr>
<th>描述字符</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>r</td>
<td>缺省的，表示只读打开</td>
</tr>
<tr>
<td>w</td>
<td>只写打开</td>
</tr>
<tr>
<td>x</td>
<td>创建并写入一个新文件</td>
</tr>
<tr>
<td>a</td>
<td>写入打开，如果文件存在，则追加</td>
</tr>
<tr>
<td>b</td>
<td>二进制模式</td>
</tr>
<tr>
<td>t</td>
<td>缺省的，文本模式</td>
</tr>
<tr>
<td>+</td>
<td>读写打开一个文件。给原来只读、只写方式打开提供缺失的读或者写能力</td>
</tr>
</tbody>
</table>
<p>在上面的例子中，可以看到默认是文本打开模式，且是只读的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># r模式</span></span><br><span class="line">f = open(<span class="string">'test'</span>)   <span class="comment"># 只读还是只写？</span></span><br><span class="line">f.read()</span><br><span class="line">f.write(<span class="string">'abc'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 因为默认是只读打开，所以这里不能写入，这样执行会报错:"UnsupportedOperation: not writable"</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test'</span>,<span class="string">'r'</span>)   <span class="comment"># 只读</span></span><br><span class="line">f.write(<span class="string">'abc'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 这里明确指出了只读打开，写入时也会报错</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test1'</span>,<span class="string">'r'</span>)   <span class="comment"># 只读，文件不存在</span></span><br><span class="line"><span class="comment"># 文件不存在，报错:"FileNotFoundError: [Errno 2] No such file or directory: 'test'"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># w模式</span></span><br><span class="line">f = open(<span class="string">'test'</span>,<span class="string">'w'</span>)   <span class="comment"># 只写打开</span></span><br><span class="line">f.write(<span class="string">'abc'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 使用jupter测试发现，如果test文件不存在，也会创建新的test文件，并写入内容。如果有test文件且其中有内</span></span><br><span class="line"><span class="comment"># 容，这样写入会覆盖里面的内容。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test   <span class="comment"># 看看内容</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test'</span>,mode=<span class="string">'w'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 这样操作文件后，文件会被清空</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test   <span class="comment"># 看看内容</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test1'</span>,mode=<span class="string">'w'</span>)</span><br><span class="line">f.write(<span class="string">'123'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 创建test1文件，并写入123。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test1   <span class="comment"># 看看内容</span></span><br></pre></td></tr></table></figure>
<p>open默认是以只读模式r打开已经存在的文件。</p>
<p>r</p>
<p>只读打开文件，如果使用write方法，会抛异常。</p>
<p>如果文件不存在，抛出FileNotFoundError异常</p>
<p>w</p>
<p>表示只写方式打开，如果读取则抛出异常</p>
<p>如果文件不存在，则直接创建文件</p>
<p>如果文件存在，则清空文件内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'test2'</span>,<span class="string">'x'</span>)</span><br><span class="line"><span class="comment"># f.read()</span></span><br><span class="line"><span class="comment"># 使用x打开的文件，这里用read方法会报错:UnsupportedOperation: not readable"。这是没有读权限，但</span></span><br><span class="line"><span class="comment"># 这并不影响上面创建test2文件</span></span><br><span class="line">f.write(<span class="string">'abcd'</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>x</p>
<p>文件不存在，创建文件，并以只写方式打开</p>
<p>文件存在，抛出FileExistsError异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'test2'</span>,<span class="string">'a'</span>)</span><br><span class="line">f.read()</span><br><span class="line"><span class="comment"># 这里依然会报错，因为没有读权限</span></span><br><span class="line">f.write(<span class="string">'abcde'</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test2</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test2'</span>,<span class="string">'a'</span>)</span><br><span class="line">f.write(<span class="string">'\n hello'</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test2</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test3'</span>,<span class="string">'a'</span>)</span><br><span class="line">f.write(<span class="string">'test3'</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test3</span><br></pre></td></tr></table></figure>
<p>a</p>
<p>文件存在，只写打开，追加内容</p>
<p>文件不存在，则创建后，只写打开，追加内容</p>
<p>r是只读，wxa都是只写。</p>
<p>wxa都可以产生新文件，w不管文件存在与否，都会生成全新内容的文件；a不管文件是否存在，都能在打开的文件尾部追加；x必须要求文件事先不存在，自己造一个新文件</p>
<p>文本模式t</p>
<p>字符流，将文件的字节按照某种字符编码理解，按照字符操作。open的默认mode就是rt。</p>
<p>二进制模式b</p>
<p>字节流，将文件就按照字节理解，与字符编码无关。二进制模式操作时，字节操作使用bytes类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">"test3"</span>,<span class="string">'rb'</span>)   <span class="comment"># 二进制只读</span></span><br><span class="line">s = f.read()</span><br><span class="line">print(type(s))   <span class="comment"># bytes</span></span><br><span class="line">print(s) <span class="comment"># b'test3'</span></span><br><span class="line">f.close()   <span class="comment"># 关闭文件</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"test3"</span>,<span class="string">'wb'</span>)   <span class="comment"># IO对象</span></span><br><span class="line">s = f.write(<span class="string">"马哥教育"</span>.encode())</span><br><span class="line">print(s)   <span class="comment"># 是什么，输出是12</span></span><br><span class="line">f.close()</span><br><span class="line">cat test3</span><br><span class="line"><span class="comment"># 输出：马哥教育</span></span><br></pre></td></tr></table></figure>
<p>思考：windows下，执行下面的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">"test3"</span>,<span class="string">'rw'</span>)</span><br><span class="line"><span class="comment"># 不可以这样打开文件，会报错："ValueError: must have exactly one of create/read/write/append mode"</span></span><br><span class="line">f = open(<span class="string">"test3"</span>,<span class="string">'r+'</span>)</span><br><span class="line">s = f.read()</span><br><span class="line">f.write(<span class="string">"马哥教育"</span>)</span><br><span class="line">print(f.read())   </span><br><span class="line"><span class="comment"># 没有显示，为什么？因为f.read()的值已经保存到s变量中了，所以这里没有显示。如果注释s = f.read()一行</span></span><br><span class="line"><span class="comment"># ，这里就可以显示出内容了。或在这里打印s的值也可以。</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"test3"</span>,<span class="string">'r+'</span>)</span><br><span class="line">s = f.write(<span class="string">"magedu"</span>)</span><br><span class="line">print(f.read())</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 这里不会打印出magedu，只有在使用cat test3查看时才能显示magedu。是因为f.write("magedu")的结果保</span></span><br><span class="line"><span class="comment"># 存到了s变量中，在关闭文件时才会写入吗？并且这里的写入功能是追加的效果</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test3'</span>,<span class="string">'w+'</span>)</span><br><span class="line">r.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 使用read方法查看不会有输出，因为使用w将文件清空了</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test3</span><br><span class="line"><span class="comment"># 文件被清空了</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test3'</span>,<span class="string">'a+'</span>)</span><br><span class="line">f.write(<span class="string">'mag'</span>)</span><br><span class="line">f.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test3</span><br><span class="line"><span class="comment"># 输出：mag</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test3'</span>,<span class="string">'a+'</span>)</span><br><span class="line">f.write(<span class="string">'edu'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test3</span><br><span class="line"><span class="comment"># 输出：magedu</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test3'</span>,<span class="string">'x+'</span>)</span><br><span class="line"><span class="comment"># 因为文件已存在，报错："FileExistsError: [Errno 17] File exists: 'test3'"</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'x+'</span>)</span><br><span class="line">f.write(<span class="string">'python'</span>)</span><br><span class="line">f.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test4</span><br><span class="line"><span class="comment"># 输出：python</span></span><br></pre></td></tr></table></figure>
<p>+</p>
<p>为r、w、a、x提供缺失的读写功能，但是，获取文件对象依旧按照r、w、a、x自己的特征。</p>
<p>+不能单独使用，可以认为它是为前面的模式字符做增强功能的。</p>
<h3 id="文件指针"><a href="#文件指针" class="headerlink" title="文件指针"></a>文件指针</h3><p>上面的例子中，已经说明了有一个指针。</p>
<p>文件指针，指向当前字节位置</p>
<p>mode=r，指针起始在0</p>
<p>mode=a，指针起始在EOF</p>
<p><code>tell()</code>显示指针当前位置</p>
<p><code>seek(offset[,whence])</code>移动文件指针位置。offset偏移多少字节，whence从哪里开始。</p>
<p>文件模式下</p>
<p>whence 0 缺省值，表示从头开始，offset只能正整数</p>
<p>whence 1 表示从当前位置，offset只接受0</p>
<p>whence 2表示从EOF开始，offset只接受0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文本模式</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'r+'</span>)</span><br><span class="line">f.tell()   <span class="comment"># 起始</span></span><br><span class="line">f.read()</span><br><span class="line">f.tell()   <span class="comment"># EOF</span></span><br><span class="line">f.seek(<span class="number">0</span>)   <span class="comment"># 起始</span></span><br><span class="line">f.read()</span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">f.read()</span><br><span class="line"><span class="comment"># 上面seek设置从索引2开始，跳过0个字符后，这里输出：thon</span></span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">1</span>)   <span class="comment"># offset必须为0</span></span><br><span class="line"><span class="comment"># 报错：“UnsupportedOperation: can't do nonzero cur-relative seeks”</span></span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">2</span>)   <span class="comment"># offset必须为0</span></span><br><span class="line"><span class="comment"># 报错：“UnsupportedOperation: can't do nonzero cur-relative seeks”</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 中文 </span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'w+'</span>)</span><br><span class="line">f.write(<span class="string">'马哥教育'</span>)</span><br><span class="line">f.tell()</span><br><span class="line">f.close()</span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'r+'</span>)</span><br><span class="line">f.read(<span class="number">3</span>)</span><br><span class="line"><span class="comment"># 输出：'马哥教'，f.read(3)表示只显示前三个字符，下面再使用read方法时就不会再显示前三个字符了，但如果</span></span><br><span class="line"><span class="comment"># 这里读了多于整个字符数量的值，如f.read(7)，下面就不能再读出任何内容了。</span></span><br><span class="line">f.seek(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 输出：1，表示当前位置是1。这里如果使用f.seek(3)就可以显示出第二个中文了，所以说明三个字节是一个中文。并且使用f.read()显示的是后三个中文，也就是跳过了第一个中文。</span></span><br><span class="line">f.tell()</span><br><span class="line"><span class="comment"># 这里输出的二进制的位置？</span></span><br><span class="line">f.read()</span><br><span class="line"><span class="comment"># 报错："UnicodeDecodeError: 'utf-8' codec can't decode byte 0xa9 in position 0: invalid start byte"，因为是二进制方式输入的，上面又移动的指针位置，所以这里报错</span></span><br><span class="line">f.seek(<span class="number">2</span>) <span class="comment"># f.seek(3)</span></span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>文本模式支持从开头向后偏移的方式。</p>
<p>whence为1表示从当前位置开始偏移，但是只支持偏移0，相当于原地不动，所以没什么用。</p>
<p>whence为2表示从EOF开始，只支持偏移0，相当于移动文件指针到EOF。</p>
<p>seek是按照字节偏移的。</p>
<p>二进制模式下</p>
<p>whence 0 缺省值，表示从头开始，offset只能正整数</p>
<p>whence 1 表示从当前位置，offset可正可负</p>
<p>whence 2 表示从EOF开始，offset可正可负</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 二进制模式</span></span><br><span class="line">f = open(<span class="string">'test'</span>,<span class="string">'rb+'</span>)</span><br><span class="line">f.tell()   <span class="comment"># 起始</span></span><br><span class="line">f.read()</span><br><span class="line">f.tell()   <span class="comment"># EOF</span></span><br><span class="line">f.write(<span class="string">b'abc'</span>)</span><br><span class="line">f.seek(<span class="number">0</span>)   <span class="comment"># 起始</span></span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">1</span>)   <span class="comment"># 从当前指针开始，向后2</span></span><br><span class="line">f.read()</span><br><span class="line">f.seek(<span class="number">-2</span>,<span class="number">2</span>)   <span class="comment"># 从当前指针开始，向前2</span></span><br><span class="line"></span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">2</span>)   <span class="comment"># 从EOF开始，向后2</span></span><br><span class="line">f.seek(<span class="number">0</span>)</span><br><span class="line">f.seek(<span class="number">-2</span>,<span class="number">2</span>)   <span class="comment"># 从EOF开始，向前2</span></span><br><span class="line">f.read()</span><br><span class="line"></span><br><span class="line">f.seek(<span class="number">-20</span>,<span class="number">2</span>)   <span class="comment"># OSError</span></span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>二进制模式支持任意起点的偏移，从头、从尾、从中间位置开始。</p>
<p>向后seek可以超界，但是向前seek的时候，不能超界，否则抛异常。</p>
<h3 id="buffering：缓冲区"><a href="#buffering：缓冲区" class="headerlink" title="buffering：缓冲区"></a>buffering：缓冲区</h3><p>-1 表示使用缺省大小的buffer。如果是二进制模式，使用io.DEFAULT_BUFFER_SIZE值，默认是4096或者8192。如果是文本模式，如果是终端设备，是行缓存方式，如果不是，则使用二进制模式的策略。</p>
<ul>
<li>0 只在二进制模式使用，表示关buffer</li>
<li>1 只在文本模式使用，表示使用行缓冲。意思就是见到换行符就flush</li>
<li>大于1用于指定buffer的大小</li>
</ul>
<p>buffer缓冲区</p>
<p>缓冲区一个内存空间，一般来说是一个FIFO队列，到缓冲区满了或者达到阈值，数据才会flush到磁盘。</p>
<p><code>flush()</code>将缓冲区数据写入磁盘</p>
<p><code>close()</code>关闭前会调用<code>flush()</code></p>
<p><code>io.DEFAULT_BUFFER_SIZE</code>缺省缓冲区大小，字节</p>
<p>二进制模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'w+b'</span>)</span><br><span class="line">print(io.DEFAULT_BUFFER_SIZE)</span><br><span class="line"><span class="comment"># 输出是8192</span></span><br><span class="line">f.write(<span class="string">"magedu.com"</span>.encode())</span><br><span class="line"><span class="comment"># cat test4</span></span><br><span class="line"><span class="comment"># 输出是magedu.com，但上面如果不使用f.close()关闭文件，这里是查看不到的。</span></span><br><span class="line">f.seek(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">"www.magedu.com"</span>.encode())</span><br><span class="line">f.flush()</span><br><span class="line"><span class="comment"># 使用flush方法后，就可以使用cat查看文件了，无需使用close方法关闭文件</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'w+b'</span>,<span class="number">4</span>)</span><br><span class="line">f.write(<span class="string">b"mag"</span>)</span><br><span class="line"><span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b'edu'</span>)</span><br><span class="line"><span class="comment"># cat test4</span></span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>文本模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># buffering=1，使用行缓冲</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'w+'</span>,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 读写方式打开test4，使用行缓冲</span></span><br><span class="line">f.write(<span class="string">"mag"</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">"magedu"</span>*<span class="number">4</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">'\n'</span>)   <span class="comment"># cat test4</span></span><br><span class="line"><span class="comment"># 写入一个换行符</span></span><br><span class="line">f.write(<span class="string">'Hello\nPython'</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># buffering&gt;1，使用指定大小的缓冲区</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'w+'</span>,<span class="number">15</span>)</span><br><span class="line">f.write(<span class="string">"mag"</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">'edu'</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">'Hello\n'</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">'\nPython'</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">'a'</span> * (io.DEFAULT_BUFFER_SIZE - <span class="number">20</span>))   </span><br><span class="line"><span class="comment"># 设置为大于1没什么用，这里的io.DEFAULT_BUFFER_SIZE还是8192</span></span><br><span class="line">f.write(<span class="string">'\nwww.magedu.com/python'</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># buffering=0 这是一种特殊的二进制模式，不需要内存的buffer，可以看做是一个FIFO的文件</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'wb+'</span>,<span class="number">0</span>)</span><br><span class="line">f.write(<span class="string">b"m"</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b"a"</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b"g"</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b"magedu"</span>*<span class="number">4</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b'\n'</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b'Hello\nPython'</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>buffering</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>buffering=-1</td>
<td>t和b，都是io.DEFAULT_BUFFER_SIZE</td>
</tr>
<tr>
<td>buffering=0</td>
<td>b：关闭缓冲区；t：不支持</td>
</tr>
<tr>
<td>buffering=1</td>
<td>b：就1个字节；t：行缓冲，遇到换行符才flush</td>
</tr>
<tr>
<td>buffering&gt;1</td>
<td>b模式表示行缓冲大小。缓冲区的值可以超过io.DEFAULT_BUFFER_SIZE，直到设定的值超出后才把缓冲区flush；t模式，是io.DEFAULT_BUFFER_SIZE，flush完后把当前字符串也写入磁盘</td>
</tr>
</tbody>
</table>
<p>似乎看起来很麻烦，一般来说，只需要记得：</p>
<ol>
<li>文本模式，一般都用默认缓冲区大小</li>
<li>二进制模式，是一个个字节的操作，可以指定buffer的大小</li>
<li>一般来说，默认缓冲区大小是个比较好的选择，除非明确知道，否则不调整它</li>
<li>一般编程中，明确知道需要写磁盘了，都会手动调用一次flush，而不是等到自动flush或者close的时候</li>
</ol>
<h3 id="encoding：编码，仅文本模式使用"><a href="#encoding：编码，仅文本模式使用" class="headerlink" title="encoding：编码，仅文本模式使用"></a>encoding：编码，仅文本模式使用</h3><p>None表示使用缺省编码，依赖操作系统。windows、linux下测试如下代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'test1'</span>,<span class="string">'w'</span>)</span><br><span class="line">f.write(<span class="string">'啊'</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>windows下缺省GBK(0xB0A1)，linux下缺省UTF-8(0xE5 95 8A)</p>
<h3 id="其他参数"><a href="#其他参数" class="headerlink" title="其他参数"></a>其他参数</h3><h4 id="errors"><a href="#errors" class="headerlink" title="errors"></a>errors</h4><p>什么样的编码错误将被捕获</p>
<p>None和strict表示有编码错误将抛出ValueError异常；ignore表示忽略</p>
<h4 id="newline"><a href="#newline" class="headerlink" title="newline"></a>newline</h4><p>文本模式中，换行的转换。可以为<code>None、&#39;&#39;空串、&#39;\r&#39;、&#39;\n&#39;、&#39;\r\n&#39;</code></p>
<p>读时，None表示<code>&#39;\r&#39;、&#39;\n&#39;、&#39;\r\n&#39;</code>都被转换为<code>&#39;\n&#39;</code>；’’表示不会自动转换通用换行符；其他合法字符表示换行符就是指定字符，就会按照指定字符分行</p>
<p>写时，None表示<code>&#39;\n&#39;</code>都会被替换为系统缺省行分隔符os.linesep；<code>&#39;\n&#39;</code>或表示<code>&#39;\n&#39;</code>不替换；其他合法字符表示<code>&#39;\n&#39;</code>会被替换为指定的字符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'o:/test'</span>,<span class="string">'w'</span>)</span><br><span class="line">f.write(<span class="string">'python\rwww.python.org\nwww.magedu.com\r\npython3'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 测试中，上面的第一个\r没起作用，\r前的内容没被写入test文件</span></span><br><span class="line"></span><br><span class="line">newlines = [<span class="keyword">None</span>,<span class="string">''</span>,<span class="string">'\n'</span>,<span class="string">'\r\n'</span>]</span><br><span class="line"><span class="keyword">for</span> n1 <span class="keyword">in</span> newlines:</span><br><span class="line">    f = open(<span class="string">'o:/test'</span>,<span class="string">'r+'</span>,newline=n1)   <span class="comment"># 缺省替换所有换行符</span></span><br><span class="line">    print(f.readlines())</span><br><span class="line">    f.close()</span><br><span class="line"><span class="comment"># 输出中分隔符不同，结果也不同</span></span><br><span class="line"><span class="comment"># ['abc\n', 'www.python.org\n', 'www.magedu.com\n', 'python3']</span></span><br><span class="line"><span class="comment"># ['abc\r', 'www.python.org\n', 'www.magedu.com\r\n', 'python3']</span></span><br><span class="line"><span class="comment"># ['abc\rwww.python.org\n', 'www.magedu.com\r\n', 'python3']</span></span><br><span class="line"><span class="comment"># ['abc\rwww.python.org\nwww.magedu.com\r\n', 'python3']</span></span><br></pre></td></tr></table></figure>
<h4 id="closefd"><a href="#closefd" class="headerlink" title="closefd"></a>closefd</h4><p>关闭文件描述符，True表示关闭它。False会在文件关闭后保持这个描述符。<code>fileobj.fileno()</code>查看</p>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><p><code>read(size=-1)</code>，size表示读取的多少个字符或字节；负数或者None表示读取到EOF</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'o:/test4'</span>,<span class="string">'r+'</span>,<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 这里不能把buffer设置为0，使其关闭，因为这是以文本方式打开的，所以这里报错：</span></span><br><span class="line"><span class="comment"># "ValueError: can't have unbuffered text I/O"</span></span><br><span class="line">f.write(<span class="string">"magedu"</span>)</span><br><span class="line">f.write(<span class="string">'\n'</span>)</span><br><span class="line">f.write(<span class="string">'马哥教育'</span>)</span><br><span class="line">f.seek(<span class="number">0</span>)</span><br><span class="line">f.read(<span class="number">7</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 二进制</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'rb+'</span>)</span><br><span class="line">f.read(<span class="number">7</span>)</span><br><span class="line">f.read(<span class="number">1</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<h3 id="行读取"><a href="#行读取" class="headerlink" title="行读取"></a>行读取</h3><p><code>readline(size=-1)</code>一行行读取文件内容。size设置一次能读取行内几个字符或字节</p>
<p><code>readlines(hint=-1)</code>读取所有行的列表。指定hint则返回指定的行数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按行迭代</span></span><br><span class="line">f = open(<span class="string">'test'</span>)   <span class="comment"># 返回可迭代对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">    print(line)</span><br><span class="line"><span class="comment"># 这与readline方法的效果一样，输出一行内容    </span></span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># abc</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># www.python.org</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># www.magedu.com</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># python3</span></span><br><span class="line"><span class="comment"># &lt;function TextIOWrapper.close()&gt;</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test'</span>)</span><br><span class="line">f.readlines()</span><br><span class="line"><span class="comment"># 输出：['abc\n', 'www.python.org\n', 'www.magedu.com\n', 'python3']</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test'</span>)</span><br><span class="line">f.readline()</span><br><span class="line"><span class="comment"># 输出：'abc\n'，这是test文件的第一行内容</span></span><br></pre></td></tr></table></figure>
<h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><p>write(s)，把字符串s写入到文件中并返回字符的个数</p>
<p><code>writelines(lines)</code>，将字符串列表写入文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'test'</span>,<span class="string">'w+'</span>)</span><br><span class="line"></span><br><span class="line">lines = [<span class="string">'abc'</span>,<span class="string">'123\n'</span>,<span class="string">'magedu'</span>]   <span class="comment"># 提供换行符</span></span><br><span class="line">f.writelines(lines)</span><br><span class="line"></span><br><span class="line">f.seek(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 写入后，记得要将指针移动到开头，不然指针是在最后的，什么也打印不出来</span></span><br><span class="line">print(f.read())</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># abc123</span></span><br><span class="line"><span class="comment"># magedu</span></span><br></pre></td></tr></table></figure>
<h3 id="close"><a href="#close" class="headerlink" title="close"></a>close</h3><p>flush并关闭文件对象。文件已经关闭，再次关闭没有任何效果。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><code>seekable()</code>是否可seek</p>
<p><code>readable()</code>是否可读</p>
<p><code>writable()</code>是否可写</p>
<p><code>closed</code>是否已经关闭</p>
<h3 id="上下文管理"><a href="#上下文管理" class="headerlink" title="上下文管理"></a>上下文管理</h3><h4 id="问题的引出"><a href="#问题的引出" class="headerlink" title="问题的引出"></a>问题的引出</h4><p>在linux中，执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面必须这么写</span></span><br><span class="line">lst = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">2000</span>):</span><br><span class="line">    lst.append(open(<span class="string">'test'</span>))</span><br><span class="line"><span class="comment"># OSError: [Errno 24] Too many open files: 'test'</span></span><br><span class="line"></span><br><span class="line">print(len(lst))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># 978</span></span><br><span class="line"><span class="comment"># The history saving thread hit an unexpected error (OperationalError('unable to open database file')).History will not be written to the database.</span></span><br><span class="line"></span><br><span class="line">lsof 列出打开的文件。没有就用yum install lsof</span><br><span class="line"><span class="comment"># 查看打开test文件的PID号，比如是用jupeter打开的，可以用lsof | grep jupeter查看PID，第二列就是PID</span></span><br><span class="line"><span class="comment"># 因为是打开test文件但没有关闭引起的报错，所以这里要查看打开test文件的PID号</span></span><br><span class="line">lsof -p <span class="number">1427</span> | grep test | wc -l</span><br><span class="line"><span class="comment"># 通过PID查看一共打开了多少次test</span></span><br><span class="line">lsof -p 进程号</span><br><span class="line">ulimit -a 查看所有限制。其中open files就是打开文件数的限制，默认<span class="number">1024</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> lst:</span><br><span class="line">    x.close()</span><br><span class="line"><span class="comment"># 将文件一次关闭，然后就可以继续打开了。再看一次lsof</span></span><br></pre></td></tr></table></figure>
<p><strong><em>有一些任务，可能事先需要设置，事后做清理工作。对于这种场景，Python的with语句提供了一种非常方便的处理方式。一个很好的例子是文件处理，你需要获取一个文件句柄，从文件中读取数据，然后关闭文件句柄。</em></strong></p>
<p>如何解决？</p>
<ol>
<li>异常处理</li>
</ol>
<p>当出现异常的时候，拦截异常。但是，因为很多代码都可能出现OSError异常，还不好判断异常就是因为资源限制产生的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'test'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    f.write(<span class="string">"abc"</span>)   <span class="comment"># 文件只读，写入失败</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    f.close()    <span class="comment"># 这样才行</span></span><br><span class="line"><span class="comment"># 使用finally可以保证打开的文件可以被关闭</span></span><br><span class="line"><span class="comment"># 虽然这段代码运行良好，但是太冗长了。这时候就是with一展身手的时候了。除了有更优雅的语法，with还可以很</span></span><br><span class="line"><span class="comment"># 好的处理上下文环境产生的异常。</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>上下文管理</li>
</ol>
<p>一种特殊的语法，交给解释器去释放文件对象</p>
<p>with工作原理</p>
<ul>
<li><p>基本思想是with所求值的对象必须有一个<code>__enter__()</code>方法，一个<code>__exit__()</code>方法。</p>
</li>
<li><p>紧跟with后面的语句被求值后，返回对象的<code>__enter__()</code>方法被调用，这个方法的返回值将被赋值给as后面的变量；</p>
</li>
<li>当with后面的代码块全部被执行完之后，将调用前面返回对象的<code>__exit__()</code>方法。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> f</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'test'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">"abc"</span>)   <span class="comment">#  文件只读，写入失败</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 测试f是否关闭</span></span><br><span class="line">f.closed   <span class="comment"># f的作用域</span></span><br><span class="line"><span class="comment"># 输出："TypeError: 'bool' object is not callable"，因为已经关闭了，所以报错</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果有多项，可以写成</span></span><br><span class="line">With open(<span class="string">'1.txt'</span>) <span class="keyword">as</span> f1, open(<span class="string">'2.txt'</span>) <span class="keyword">as</span>  f2:</span><br><span class="line">    do something</span><br></pre></td></tr></table></figure>
<p>上下文管理</p>
<ol>
<li>使用with … as 关键字</li>
<li>上下文管理的语句块并不会开启新的作用域</li>
<li>with 语句块执行完的时候，会自动关闭文件对象</li>
</ol>
<p>另一种写法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">f1 = open(<span class="string">'test'</span>)</span><br><span class="line"><span class="keyword">with</span> f1:</span><br><span class="line">    f1.write(<span class="string">"abc"</span>)   <span class="comment"># 文件只读，写入失败</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 测试f是否关闭</span></span><br><span class="line">f1.closed   <span class="comment"># f1的作用域</span></span><br></pre></td></tr></table></figure>
<p>对于类似于文件对象的IO对象，一般来说都需要在不使用的时候关闭、注销、以释放资源。IO被打开的时候，会获得一个文件描述符。计算机资源是有限的，所以操作系统都会做限制。就是为了保护计算机的资源不要被完全耗尽，计算资源是共享的，不是独占的。一般情况下，除非特别明确的知道资源情况，否则不要提高资源的限制值来解决问题。</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><h4 id="指定一个源文件，实现copy到目标目录"><a href="#指定一个源文件，实现copy到目标目录" class="headerlink" title="指定一个源文件，实现copy到目标目录"></a>指定一个源文件，实现copy到目标目录</h4><p>例如把/tmp/test.txt拷贝到/tmp/test1.txt</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">filename1 = <span class="string">'/tmp/test.txt'</span></span><br><span class="line">filename2 = <span class="string">'/tmp/test1.txt'</span></span><br><span class="line"></span><br><span class="line">f = open(filename1, <span class="string">'w+'</span>)</span><br><span class="line">lines = [<span class="string">'abc'</span>,<span class="string">'123'</span>,<span class="string">'magedu'</span>]</span><br><span class="line">f.writelines(<span class="string">'\n'</span>.join(lines))</span><br><span class="line"><span class="comment"># 使用\n作为分隔符将lines列表中的元素连接起来，这时通过join方法已经将连接下来的元素变成了字符串。再把</span></span><br><span class="line"><span class="comment"># 这个字符串写入filename1文件中</span></span><br><span class="line">f.seek(<span class="number">0</span>)</span><br><span class="line">print(f.read())</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy</span><span class="params">(src,dest)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(src) <span class="keyword">as</span> f1:</span><br><span class="line">        <span class="keyword">with</span> open(dest, <span class="string">'w'</span>) <span class="keyword">as</span> f2:</span><br><span class="line">            f2.write(f1.read())</span><br><span class="line"><span class="comment"># 定义一个函数，设置两个参数，使用目录文件的写方法写入从源文件中读取到的内容            </span></span><br><span class="line">copy(filename1, filename2)</span><br></pre></td></tr></table></figure>
<h4 id="有一个文件，对其进行单词统计，不区分大小写，并显示单词重复最多的10个单词"><a href="#有一个文件，对其进行单词统计，不区分大小写，并显示单词重复最多的10个单词" class="headerlink" title="有一个文件，对其进行单词统计，不区分大小写，并显示单词重复最多的10个单词"></a>有一个文件，对其进行单词统计，不区分大小写，并显示单词重复最多的10个单词</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">简单处理后，大概的得数如下：</span><br><span class="line">the, <span class="number">136</span></span><br><span class="line"><span class="keyword">is</span>, <span class="number">60</span></span><br><span class="line">a, <span class="number">54</span></span><br><span class="line">path, <span class="number">52</span></span><br><span class="line"><span class="keyword">if</span>, <span class="number">42</span></span><br><span class="line"><span class="keyword">and</span>, <span class="number">39</span></span><br><span class="line">to, <span class="number">34</span></span><br><span class="line">of, <span class="number">33</span></span><br><span class="line">on, <span class="number">32</span></span><br><span class="line"><span class="keyword">return</span>, <span class="number">30</span></span><br><span class="line"><span class="comment"># 上面是以空格为分隔的结果，这里的path与下面统计的数量不一样，因为分隔符不一样</span></span><br><span class="line">实际上有效的path很多，作为合法的单词path统计应该有<span class="number">100</span>多个。对单词做进一步处理后，统计如下：</span><br><span class="line">path, <span class="number">137</span></span><br><span class="line">the, <span class="number">136</span></span><br><span class="line"><span class="keyword">is</span>, <span class="number">60</span></span><br><span class="line">a, <span class="number">59</span></span><br><span class="line">os, <span class="number">50</span></span><br><span class="line"><span class="keyword">if</span>, <span class="number">43</span></span><br><span class="line"><span class="keyword">and</span>, <span class="number">40</span></span><br><span class="line">to, <span class="number">34</span></span><br><span class="line">of, <span class="number">33</span></span><br><span class="line">on, <span class="number">33</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最好使用字典来实现此题，到目前为止学过的时间复杂度为O(1)的数据结构只有set和dict</span></span><br><span class="line"><span class="comment"># 大的数据统计都用字典这种数据结构，关键是如何分词，如果断开，英文一般用空格。中文要用分词库，比较麻烦。</span></span><br><span class="line"></span><br><span class="line">复制sample.txt文件到指定目录</span><br><span class="line">d = &#123;&#125;</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'sample'</span>, encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        words = line.split()   <span class="comment"># 以默认的空白字符串作为分隔符将line分开，放入words列表中</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> map(str.lower, words):</span><br><span class="line">            d[word] = d.get(word,<span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">print(sorted(d.items(), key=<span class="keyword">lambda</span> item: item[<span class="number">1</span>], reverse=<span class="keyword">True</span>))</span><br><span class="line"><span class="comment"># 1. 定义一个空字典</span></span><br><span class="line"><span class="comment"># 2. 以utf8编码打开目标文件</span></span><br><span class="line"><span class="comment"># 3. 循环目录文件中的每一行，将循环的结果以默认的空白字符串作为分隔符将line分开，并将生成的字符串放入</span></span><br><span class="line"><span class="comment"># words列表中。这是将每一行生成一个列表并对其中的每个单词进行处理。</span></span><br><span class="line"><span class="comment"># 4. 使用字符串的lower将words列表中的所有字母变为小写，再用map生成一个列表，并进行循环。map函数会使用</span></span><br><span class="line"><span class="comment"># 参数中定义的str.lower方法，把第二个参数送进来的列表或字符串中的元素变成一个个单独的元素，并再次组成列</span></span><br><span class="line"><span class="comment"># 表。因为str的方法本来就会把字符串分成一个个单独的元素。</span></span><br><span class="line"><span class="comment"># 5. 从字典d中获取word这个键的值，如果没有值就将值设置为0加1，因为最少也会出现一次，所以这样设置，如果</span></span><br><span class="line"><span class="comment"># 将默认值设置为1，那么再加任何值都不能符合出现的单词的数量的实际情况</span></span><br><span class="line"><span class="comment"># 6. 最后使用sorted将d的键值排序，排序的标准使用item[1]也就是键值对中的值进行排序，reverse=True表示</span></span><br><span class="line"><span class="comment"># 降序排列，默认是升序</span></span><br><span class="line">=======================================================================================</span><br><span class="line">map()函数测试</span><br><span class="line">a=(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">b=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">c=<span class="string">"zhangkang"</span></span><br><span class="line"></span><br><span class="line">la=map(str,a)</span><br><span class="line">lb=map(str,b)</span><br><span class="line">lc=map(str,c)</span><br><span class="line"></span><br><span class="line">print(la)</span><br><span class="line">print(lb)</span><br><span class="line">print(lc)</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>]</span><br><span class="line">[<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>]</span><br><span class="line">[<span class="string">'z'</span>, <span class="string">'h'</span>, <span class="string">'a'</span>, <span class="string">'n'</span>, <span class="string">'g'</span>, <span class="string">'k'</span>, <span class="string">'a'</span>, <span class="string">'n'</span>, <span class="string">'g'</span>]</span><br><span class="line"><span class="comment"># str()是python的内置函数，这个例子是把列表/元组/字符串的每个元素变成了str类型，然后以列表的形式返回。当然我们也可以传入自定义的函数，看下面的例子。</span></span><br><span class="line">=======================================================================================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 得数如下：</span></span><br><span class="line"><span class="comment"># the, 136</span></span><br><span class="line"><span class="comment"># is, 60</span></span><br><span class="line"><span class="comment"># a, 54</span></span><br><span class="line"><span class="comment"># path, 52</span></span><br><span class="line"><span class="comment"># if, 42</span></span><br><span class="line"><span class="comment"># and, 39</span></span><br><span class="line"><span class="comment"># to, 34</span></span><br><span class="line"><span class="comment"># of, 33</span></span><br><span class="line"><span class="comment"># on, 32</span></span><br><span class="line"><span class="comment"># return, 30</span></span><br></pre></td></tr></table></figure>
<p>这是帮助文档中python的文档，path应该很多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> d.keys():</span><br><span class="line">    <span class="keyword">if</span> k.find(<span class="string">'path'</span>) &gt; <span class="number">-1</span>:</span><br><span class="line">        print(k)</span><br></pre></td></tr></table></figure>
<p>使用上面的代码，就可以看到path非常多</p>
<p>os.path.exists(path) 可以认为含有2个path。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makekey</span><span class="params">(s:str)</span>:</span>  <span class="comment"># 这里送进来的参数一定是字符串</span></span><br><span class="line">    chars = set(<span class="string">r"""!'"#./\()[],*-"""</span>)   <span class="comment"># 定义一个集合，其中的字符不要转义</span></span><br><span class="line">    key = s.lower()</span><br><span class="line"><span class="comment"># 这里的s已经是被下面的方法使用空白字符串分割过一次的单词的列表了</span></span><br><span class="line">    ret = []</span><br><span class="line">    <span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(key):  <span class="comment"># 给每个元素加上序号</span></span><br><span class="line"><span class="comment"># 因为送进来的s的值是一个个单独的字符串元素，所以这里加入序号后进行判断，如果属于chars变量中定义的内容</span></span><br><span class="line"><span class="comment"># 就向ret列表中追加一个空格，否则追加元素本身的值。最后再用空字符串将ret中的元素连接起来，以空格为分割</span></span><br><span class="line"><span class="comment"># 符，这样就等于重新组合了一次s送进来的值，也就将os.path.sameopenfile(fp1这样的值分的更细了，因为这</span></span><br><span class="line"><span class="comment"># 本身就是一堆不同的单词用符号连接起来了</span></span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> chars:</span><br><span class="line">            ret.append(<span class="string">' '</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ret.append(c)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(ret).split()</span><br><span class="line"></span><br><span class="line">d = &#123;&#125;</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'sample'</span>,encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        words = line.split()</span><br><span class="line">        <span class="keyword">for</span> wordlist <span class="keyword">in</span> map(makekey,words):</span><br><span class="line">            <span class="comment"># 这里使用上面定义的makekey来分割words中的字符串元素，再组成一个新列表</span></span><br><span class="line">            <span class="comment"># 这等于将line分割了两次，第一次用空白字符串，第二次用makekey函数中的方法</span></span><br><span class="line">            <span class="keyword">for</span> word <span class="keyword">in</span> wordlist:</span><br><span class="line">                d[word] = d.get(word,<span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">                </span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> sorted(d.items(),key=<span class="keyword">lambda</span> item: item[<span class="number">1</span>],reverse=<span class="keyword">True</span>):</span><br><span class="line">	print(k,v)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 对单词做进一步处理后，统计如下：</span></span><br><span class="line">path, <span class="number">137</span></span><br><span class="line">the, <span class="number">136</span></span><br><span class="line"><span class="keyword">is</span>, <span class="number">60</span></span><br><span class="line">a, <span class="number">59</span></span><br><span class="line">os, <span class="number">50</span></span><br><span class="line"><span class="keyword">if</span>, <span class="number">43</span></span><br><span class="line"><span class="keyword">and</span>, <span class="number">40</span></span><br><span class="line">to, <span class="number">34</span></span><br><span class="line">of, <span class="number">33</span></span><br><span class="line">on, <span class="number">33</span></span><br></pre></td></tr></table></figure>
<p>分割key的另一种思路</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makekey</span><span class="params">(s:str)</span>:</span></span><br><span class="line">    chars = set(<span class="string">r"""!'"#./\()[],*-"""</span>)</span><br><span class="line">    key = s.lower()   <span class="comment"># 这个key是一个字符串类型</span></span><br><span class="line">    ret = []</span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    length = len(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(key):</span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> chars: <span class="comment"># 这是把find的过程变成了一遍遍历完</span></span><br><span class="line">            <span class="keyword">if</span> start == i:   <span class="comment"># 如果紧挨着还是特殊字符，start一定等于i</span></span><br><span class="line">            	start += <span class="number">1</span>   <span class="comment"># 加1并continue</span></span><br><span class="line">            	<span class="keyword">continue</span></span><br><span class="line">        	ret.append(key[start:i])</span><br><span class="line">        	start = i + <span class="number">1</span>   <span class="comment"># 加1是跳过这个不需要的特殊字符c</span></span><br><span class="line"><span class="comment"># 这里进行判断，如果c属于chars这个变量中的特殊符号，那么就向下再判断，如果start变量和i变量相等，就把</span></span><br><span class="line"><span class="comment"># start加1并跳出循环。这时的情况是，如果传入的第一个c元素是标点符号，就把start变量加1并跳出循环，如果</span></span><br><span class="line"><span class="comment"># 这里不是特殊符号，不考虑下面的语句那么就会跳过，重新进入循环，直到再次需到特殊符号，这时再判断时，</span></span><br><span class="line"><span class="comment"># start与i变量一定是不相等的，也就可以追加从start到i的值到ret列表中了，这时这段追加的内容就是非特殊符</span></span><br><span class="line"><span class="comment"># 号的索引值。这时的start是上一个特殊符号的索引值加1，i的值是现在的特殊符号的索引值，前包后不包的原则，</span></span><br><span class="line"><span class="comment"># 追加的就是非特殊符号的字符串元素。如果第一个字符串元素不是特殊符号，那么就会跳过本次循环，直到需到特殊</span></span><br><span class="line"><span class="comment"># 符号，这时就可以以从start到i的值为索引值追加元素到列表了。追加后还要新start的值调整为目前的i值加1，</span></span><br><span class="line"><span class="comment"># 这是标记了下一个索引值起始的位置。大部分的非特殊符号都是从这里追加到列表中的。</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> start &lt; len(key):   <span class="comment"># 小于，说明还有有效的字符，而且一直到末尾</span></span><br><span class="line">            ret.append(key[start:])</span><br><span class="line"><span class="comment"># 如果不符合上面的条件，这时的start应该已经到了最后的非特殊字符的索引位置了，如果这个索引值比字符串整体</span></span><br><span class="line"><span class="comment"># 的长度小，加为start一直是加1的，所以应该和字符串的长度是一样的。这时就把从start这个索引值到最后的所</span></span><br><span class="line"><span class="comment"># 有字符串元素追加到列表中。这一段就是处理最后一段非特殊符号元素的，这里已经和上面的i和c变量没关系了，也</span></span><br><span class="line"><span class="comment"># 就是循环都正常执行完后，会再执行一次这段代码。</span></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">print(makekey(<span class="string">'os.path.exists(path)'</span>))</span><br><span class="line">print(makekey(<span class="string">'os.path.-exists(path)'</span>))</span><br><span class="line">print(makekey(<span class="string">'path.os...'</span>))</span><br><span class="line">print(makekey(<span class="string">'path'</span>))</span><br><span class="line">print(makekey(<span class="string">'path-p'</span>))</span><br><span class="line">print(makekey(<span class="string">'***...'</span>))</span><br><span class="line">print(makekey(<span class="string">''</span>))</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/03/nginx问题解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/03/nginx问题解决/" itemprop="url">
                  nginx问题解决
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-12-03 17:00:29" itemprop="dateCreated datePublished" datetime="2019-12-03T17:00:29+08:00">2019-12-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="反向代理二级域名"><a href="#反向代理二级域名" class="headerlink" title="反向代理二级域名"></a>反向代理二级域名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 172.24.211.110;</span><br><span class="line">    root /usr/share/nginx/html;</span><br><span class="line">    access_log /var/log/nginx/access-oss.log;</span><br><span class="line">    location /bajia-images/ &#123;</span><br><span class="line">        proxy_pass  http://bajia-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /chaowai-images/ &#123;</span><br><span class="line">        proxy_pass http://chaowai-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    location /miyun-images/ &#123;</span><br><span class="line">        proxy_pass http://miyun-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /zhihuixiangcun-images/ &#123;</span><br><span class="line">        proxy_pass http://zhihuixiangcun-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-music/ &#123;</span><br><span class="line">        proxy_pass http://family-music.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-photo/ &#123;</span><br><span class="line">        proxy_pass http://family-photo20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-user/ &#123;</span><br><span class="line">        proxy_pass http://family-user20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-video/ &#123;</span><br><span class="line">        proxy_pass http://family-video20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location /wxfwh-images/ &#123;</span><br><span class="line">        proxy_pass http://wxfwh-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里需要注意的是，proxy_pass的地址最后一定要有/，这样访问二级域名时，就会被反向代理到其对应的地址。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如访问http://172.16.211.110/wxfwh-images/就会被反向代理到</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://wxfwh-images.oss-cn-beijing-internal.aliyuncs.com/，如果不加反向代理地址最后的/，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 那么就会到反向代理地址下找二级域名</span></span><br></pre></td></tr></table></figure>
<h3 id="通过域名解析访问"><a href="#通过域名解析访问" class="headerlink" title="通过域名解析访问"></a>通过域名解析访问</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 问题：以上面的配置文件为例，当使用hosts文件解析域名后，无法通过域名访问反向代理，只能通过IP访问</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name *.gehua.net.cn;</span><br><span class="line">    root /usr/share/nginx/html;</span><br><span class="line">    access_log /var/log/nginx/access-oss.log;</span><br><span class="line">    location /bajia-images/ &#123;</span><br><span class="line">        proxy_pass  http://bajia-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /chaowai-images/ &#123;</span><br><span class="line">        proxy_pass http://chaowai-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    location /miyun-images/ &#123;</span><br><span class="line">        proxy_pass http://miyun-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /zhihuixiangcun-images/ &#123;</span><br><span class="line">        proxy_pass http://zhihuixiangcun-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-music/ &#123;</span><br><span class="line">        proxy_pass http://family-music.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-photo/ &#123;</span><br><span class="line">        proxy_pass http://family-photo20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-user/ &#123;</span><br><span class="line">        proxy_pass http://family-user20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-video/ &#123;</span><br><span class="line">        proxy_pass http://family-video20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location /wxfwh-images/ &#123;</span><br><span class="line">        proxy_pass http://wxfwh-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为是为oss对象存储做反向代理，希望通过<span class="string">"域名+bucket名+路径"</span>的方式访问，因为域名较多，所以这里使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 泛域名，这样配置后，可以实现以.gehua.net.cn结尾的域名访问，但是之前的IP地址就无法访问了。</span></span><br></pre></td></tr></table></figure>
<h3 id="不同域名反向代理"><a href="#不同域名反向代理" class="headerlink" title="不同域名反向代理"></a>不同域名反向代理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name bajia-images.endpoint.gehua.net.cn;</span><br><span class="line">    access_log /var/log/nginx/access-upload-bajia.log;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://baes.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name chaowai-images.endpoint.gehua.net;</span><br><span class="line">    access_log /var/log/nginx/access-upload-chaowai.log;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://chaages.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以写成多个server段，第一段使用相同的端口，但使用不同的域名。</span></span><br></pre></td></tr></table></figure>
<h3 id="server-name名称过长"><a href="#server-name名称过长" class="headerlink" title="server_name名称过长"></a>server_name名称过长</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server_name的名称过长，检查配置文件会提示：nginx: [emerg] could not build server_names_hash, you should increase server_names_hash_bucket_size: 64，且无法重新启动。解决方法如下：</span><br><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    server_names_hash_bucket_size 128;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">238</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">174</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
