<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/6/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/22/Jenkins安装与部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/22/Jenkins安装与部署/" itemprop="url">
                  Jenkins安装与部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-22 10:18:30" itemprop="dateCreated datePublished" datetime="2018-10-22T10:18:30+08:00">2018-10-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-01 18:08:34" itemprop="dateModified" datetime="2019-02-01T18:08:34+08:00">2019-02-01</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/持续集成与部署/" itemprop="url" rel="index"><span itemprop="name">持续集成与部署</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Jenkins简单部署"><a href="#Jenkins简单部署" class="headerlink" title="Jenkins简单部署"></a>Jenkins简单部署</h2><h3 id="rpm包安装启动"><a href="#rpm包安装启动" class="headerlink" title="rpm包安装启动"></a>rpm包安装启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">============================================================================================</span><br><span class="line">环境</span><br><span class="line">准备两台主机</span><br><span class="line">node1：地址：192.168.1.63</span><br><span class="line">node2：地址：192.168.1.64</span><br><span class="line">============================================================================================</span><br><span class="line">------------</span><br><span class="line">  jenkins</span><br><span class="line">------------  </span><br><span class="line">[root@jenkins ~]# yum install -y java-1.8.0-openjdk-devel</span><br><span class="line">[root@jenkins ~]# yum install -y jenkins-2.60.3-1.1.noarch.rpm</span><br><span class="line">[root@jenkins ~]# systemctl start jenkins</span><br><span class="line">[root@jenkins ~]# ss -tln</span><br><span class="line">State       Recv-Q Send-Q            Local Address:Port                           Peer Address:Port              </span><br><span class="line">LISTEN      0      128                           *:111                                       *:*                  </span><br><span class="line">LISTEN      0      128                           *:22                                        *:*                  </span><br><span class="line">LISTEN      0      100                   127.0.0.1:25                                        *:*                  </span><br><span class="line">LISTEN      0      128                          :::111                                      :::*                  </span><br><span class="line">LISTEN      0      50                           :::8080</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到监控了8080端口</span></span><br><span class="line">[root@jenkins ~]# vim /etc/sysconfig/jenkins</span><br><span class="line">JENKINS_JAVA_OPTIONS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整jenkins的使用内存，默认此项是-Djava.awt.headless=<span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xms：初始堆内存Heap大小，使用的最小内存，cpu性能高时此值应设的大一些</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xmx：初始堆内存heap最大值，使用的最大内存</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -XX:MaxPermSize:设定最大内存的永久保存区域</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xms与-Xmx设置相同的值，需要根据实际情况设置，增大内存可以提高读写性能</span></span><br><span class="line">访问http://192.168.1.63:8080</span><br></pre></td></tr></table></figure>
<h3 id="tomcat启动"><a href="#tomcat启动" class="headerlink" title="tomcat启动"></a>tomcat启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">  jenkins</span><br><span class="line">------------  </span><br><span class="line">[root@jenkins ~]# yum install -y tomcat</span><br><span class="line">[root@jenkins ~]# cp /usr/lib/jenkins/jenkins.war /usr/share/tomcat/webapps/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将上面安装的jenkins的war包复制到tomcat的部署目录下，也可以直接下载jenkins的war包</span></span><br><span class="line">[root@jenkins ~]# vim /etc/sysconfig/tomcat</span><br><span class="line">JAVA_OPTS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整tomcat使用jvm内存</span></span><br><span class="line">[root@jenkins ~]# systemctl start tomcat</span><br><span class="line">[root@jenkins ~]# ps aux|grep tomcat</span><br><span class="line">tomcat     2242 17.4 40.8 3718460 763224 ?      Ssl  19:27   0:21 /usr/lib/jvm/jre/bin/java -Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m -classpath /usr/share/tomcat/bin/bootstrap.jar:/usr/share/tomcat/bin/tomcat-juli.jar:/usr/share/java/commons-daemon.jar -Dcatalina.base=/usr/share/tomcat -Dcatalina.home=/usr/share/tomcat -Djava.endorsed.dirs= -Djava.io.tmpdir=/var/cache/tomcat/temp -Djava.util.logging.config.file=/usr/share/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager org.apache.catalina.startup.Bootstrap start</span><br><span class="line"></span><br><span class="line">访问http://192.168.1.63:8080/jenkins</span><br><span class="line">[root@jenkins ~]# cat /usr/share/tomcat/.jenkins/secrets/initialAdminPassword </span><br><span class="line">cdc0bfcfa03e4d2da4f7232b213c50c1</span><br><span class="line"><span class="meta">#</span><span class="bash">  查看登录jenkins的默认密码</span></span><br></pre></td></tr></table></figure>
<h3 id="安装maven"><a href="#安装maven" class="headerlink" title="安装maven"></a>安装maven</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">  maven</span><br><span class="line">------------</span><br><span class="line">[root@maven ~]# yum install -y java-1.8.0-openjdk-devel  tomcat tomcat-admin-webapps</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在当前主机上安装一个tomcat，稍后测试maven构建的包是否可以正常运行</span></span><br><span class="line">[root@maven ~]# yum install -y maven git</span><br><span class="line">[root@maven ~]# git clone https://github.com/mageedu/spring-boot-web-jsp.git</span><br><span class="line"><span class="meta">#</span><span class="bash"> 克隆一个java代码测试。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对maven来说最重要的是pom.xml文件，它描述了这个代码是如何构建的</span></span><br><span class="line">[root@maven ~]# cd spring-boot-web-jsp/</span><br><span class="line">[root@maven ~]# vim /etc/maven/settings.xml</span><br><span class="line">&lt;mirrors&gt;</span><br><span class="line">&lt;mirror&gt;</span><br><span class="line">       &lt;id&gt;nexus-osc&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus osc&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> mirrors段添加国内源地址。</span></span><br><span class="line">&lt;profile&gt;</span><br><span class="line">    &lt;id&gt;jdk-1.4&lt;/id&gt;</span><br><span class="line">    &lt;activation&gt;</span><br><span class="line">    &lt;jdk&gt;1.4&lt;/jdk&gt;</span><br><span class="line">    &lt;/activation&gt;</span><br><span class="line">    &lt;repositories&gt;</span><br><span class="line">        &lt;repository&gt;</span><br><span class="line">            &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;local private nexus&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">            &lt;releases&gt;</span><br><span class="line">                &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">            &lt;/releases&gt;</span><br><span class="line">            &lt;snapshots&gt;</span><br><span class="line">                &lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">            &lt;/snapshots&gt;</span><br><span class="line">        &lt;/repository&gt;</span><br><span class="line">    &lt;/repositories&gt;</span><br><span class="line">    &lt;pluginRepositories&gt;</span><br><span class="line">        &lt;pluginRepository&gt;</span><br><span class="line">            &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;local private nexus&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">            &lt;releases&gt;</span><br><span class="line">                &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">            &lt;/releases&gt;</span><br><span class="line">            &lt;snapshots&gt;</span><br><span class="line">                &lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">            &lt;/snapshots&gt;</span><br><span class="line">        &lt;/pluginRepository&gt;</span><br><span class="line">    &lt;/pluginRepositories&gt;</span><br><span class="line">&lt;/profile&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Maven 还需要安装一些插件包，这些插件包的下载地址也让其指向 oschina.net 的 Maven 地址。在&lt;profiles&gt;中插入</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要修改为国内源，不然构建速度将非常慢。尤其是在jenkins中</span></span><br><span class="line">[root@maven spring-boot-web-jsp]# mvn package</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开始构建。</span></span><br><span class="line">[root@maven ~]# vim /etc/tomcat/tomcat-users.xml</span><br><span class="line">&lt;role rolename="manager-gui"/&gt; </span><br><span class="line">&lt;role rolename="manager-script"/&gt;</span><br><span class="line">&lt;user name="tomcat" password="tomcat" roles="manager-gui,manager-script" /&gt;</span><br><span class="line">[root@maven ~]# vim /etc/sysconfig/tomcat</span><br><span class="line">JAVA_OPTS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line">[root@maven ~]# systemctl start tomcat</span><br><span class="line">[root@maven spring-boot-web-jsp]# ls target/</span><br><span class="line">classes            maven-archiver  spring-boot-web-jsp-1.0      spring-boot-web-jsp-1.0.war.original</span><br><span class="line">generated-sources  maven-status    spring-boot-web-jsp-1.0.war</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到构建后有了war包</span></span><br><span class="line">[root@maven spring-boot-web-jsp]# cp target/spring-boot-web-jsp-1.0.war /usr/share/tomcat/webapps/</span><br><span class="line">访问http://192.168.1.64:8080/spring-boot-web-jsp-1.0/，可以看到部署的结果了</span><br></pre></td></tr></table></figure>
<h3 id="测试jenkins"><a href="#测试jenkins" class="headerlink" title="测试jenkins"></a>测试jenkins</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">  jenkins</span><br><span class="line">------------  </span><br><span class="line">[root@jenkins ~]# scp jenkins.war 192.168.1.64:/usr/share/tomcat/webapps/</span><br><span class="line"><span class="meta">#</span><span class="bash"> jenkins.war包的属主属组应该是tomcat，权限是644</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  maven</span><br><span class="line">------------</span><br><span class="line">[root@maven webapps]# cat /usr/share/tomcat/.jenkins/secrets/initialAdminPassword </span><br><span class="line">083cbf58aefd411b89558aea505f3e94</span><br><span class="line">[root@maven webapps]# vim /etc/tomcat/server.xml</span><br><span class="line">&lt;Connector port="8080" protocol="HTTP/1.1"</span><br><span class="line">               connectionTimeout="20000"</span><br><span class="line">               redirectPort="8443" URIEncoding="UTF-8"/&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash">  让tomcat可以使用UTF-8编码。这是为了让jenkins不再报需要使用UTF-8编码的错误</span></span><br><span class="line">[root@maven webapps]# systemctl restart tomcat</span><br><span class="line">访问http://192.168.1.64:8080/jenkins/  --&gt;  输入密码  --&gt;  选择默认插件  --&gt;  创建新用户  --&gt; 在系统管理中配置jenkins的环境  --&gt;  到系统管理中的global tool configuration中配置JDK的别名和路径，取消自动安装，路径写/usr即可  --&gt;  git工具被默认配置了，因为git包已经安装了。Gradle是java的新的构建工具  --&gt;  配置Mave，使用mvn -v查看版本，将版本号输入到Name中，如maven-3.0.5，路径写/usr</span><br><span class="line"></span><br><span class="line">新建一个任务，叫spring-boot-web-jsp。一般构建选择两种，一是自由风格，一是pipeline（流水线），这里选自由风格。选择github project，输入https://github.com/mageedu/spring-boot-web-jsp.git，这是给定一个代码路径，点击高级可显示Display name输入spring-boot-web，这是自定义的。源码管理中的Git是指如果要推送到远程服务器上，在这里要输入地址，用户名和密码或密钥，在这里还是输入https://github.com/mageedu/spring-boot-web-jsp.git，源码管理不做配置也可以，但测试中发现一定要配置源码管理的地址，不然会提示找不到pom.xml文件。构建触发器是指如果代码更新了要怎么办或什么条件下进行构建。第一可以自定义脚本来触发，build after other projects are built指在其他项目构建完触发，build pericxfically是周期性构建，每隔一段时间就看一下源代码是否有变化，有变化就构建，GitHub hook trigger for GITScrn polling是如果GitHub上注册的hook有变化，就会发送通知，下载代码构建，Poll SCM是不断向github轮询，有符合条件的就构建，这里可以在日程表中写入H/5 * * * *，表示每5分钟轮询一次。在构建中可以选择Invoke top-level Maven targets，表示一个顶级的maven构建，在Maven Version中选择安装的maven版本，Goals中输入构建的路径，这种方式易出错。选择Execute shell表示脚本构建，在Command中写入/usr/bin/mvn package即可，它会自动切换到构建目录下构建。构建后操作就是要发布了。视频中这里没有选择。直接点击项目中的立即构建了，在构建中可以选择console一项，可以打开一个窗口查看构建的过程。</span><br><span class="line"></span><br><span class="line">[root@maven webapps]# cd /usr/share/tomcat/.jenkins/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 构建完成后进入此目录</span></span><br><span class="line">[root@maven .jenkins]# ls workspace/spring-boot-web-jsp/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在workspace目录中有构建完的程序</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  jenkins</span><br><span class="line">------------ </span><br><span class="line">[root@jenkins ~]# rm -rf /usr/share/tomcat/webapps/jenkins*</span><br><span class="line">[root@jenkins ~]# cd /etc/tomcat/</span><br><span class="line">[root@jenkins tomcat]# vim tomcat-users.xml</span><br><span class="line">&lt;role rolename="manager-script"/&gt; </span><br><span class="line">&lt;user name="admin" password="admin" roles="manager-script" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash">  我们要将maven上构建的结果在 jenkins上的tomcat上运行，所以需要这里打开manager-script功能。</span></span><br><span class="line">[root@jenkins tomcat]# systemctl restart tomcat</span><br><span class="line">[root@jenkins tomcat]# ss -tln</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  maven</span><br><span class="line">------------</span><br><span class="line">选择系统管理中的管理插件，在可选插件中选择安装Deploy to container，选择安装完成后重启Jenkins。进入spring-boot-web-jsp项目中，点击配置，选择构建后操作中的Deploy war/ear to a container，这是刚安装的插件，WAR/EAR files输入**target/*.war，（**表示任意个路径下的target目录中的.war文件。也可以写为**/*.war或*.war）。Context path可以不改，使用默认，这里使用/test-spring（这是部署到node1的tomcat上的目录的名称）。Containers选择Tomcat7.*，用户名和密码就是上面配置的manager-script的用户名和密码，输入两次tomcat。Tomcat URL输入http://IP:8080/，这是tomcat的访问路径。如果要构建多个tomcat，可以再添加Add Container就可以了。最后保存。</span><br><span class="line">点击项目中的立即构建。构建中出了问题，一直提示没有权限部署。因为node1上没有安装tomcat-admin-webapps</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  jenkins</span><br><span class="line">------------ </span><br><span class="line">[root@jenkins tomcat]# yum install -y tomcat-admin-webapps</span><br><span class="line">[root@jenkins tomcat]# ls webapps/</span><br><span class="line">host-manager  manager  test-spring  test-spring.war</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在此目录下有刚部署的<span class="built_in">test</span>-spring.war文件</span></span><br><span class="line"></span><br><span class="line">访问http://192.168.1.63:8080/test-spring/</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  maven</span><br><span class="line">------------</span><br><span class="line">[root@maven .jenkins]# rm -rf workspace/spring-boot-web-jsp/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除代码，测试重新构建</span></span><br><span class="line">[root@maven .jenkins]# cd</span><br><span class="line">[root@maven ~]# ls</span><br><span class="line">anaconda-ks.cfg  netty-new.jar  spring-boot-web-jsp</span><br><span class="line">[root@maven ~]# vim spring-boot-web-jsp/src/main/resources/application.properties</span><br><span class="line">spring.mvc.view.prefix: /WEB-INF/jsp/</span><br><span class="line">spring.mvc.view.suffix: .jsp</span><br><span class="line"></span><br><span class="line">welcome.message: Hi Jenkins, Test.com, iunx.io.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改这个文件中的显示内容，再保存，这里修改了Test.com, iunx.io.</span></span><br><span class="line">[root@maven ~]# vim spring-boot-web-jsp/src/main/resources/static/css/main.css</span><br><span class="line">h1&#123;</span><br><span class="line">        color:#FFFF00;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">h2&#123;</span><br><span class="line">        color:#0000FF;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改颜色</span></span><br><span class="line">cd spring-boot-web-jsp</span><br><span class="line">git add .</span><br><span class="line">git commit -m "version 4.2.0"</span><br><span class="line">git push </span><br><span class="line">点击自动构建</span><br><span class="line">如果是灰度发布，可以使用脚本，脚本可实现将指定文件发送到服务器并部署</span><br><span class="line">回滚到之前的版本，可以在构建时指定构建的版本就可以了，使用git克隆时就克隆指定的版本就可以了。</span><br><span class="line">在ganneral最上方的一栏中可以选择参数化构建过程。</span><br><span class="line">参考：blog.ramanshalupau.com/parameterized-jenkins-build-for-rollback-purposes，实现滚动发布与回滚</span><br></pre></td></tr></table></figure>
<h2 id="Jenkins-amp-Gitlab"><a href="#Jenkins-amp-Gitlab" class="headerlink" title="Jenkins&amp;Gitlab"></a>Jenkins&amp;Gitlab</h2><h3 id="Jenkins依赖环境准备"><a href="#Jenkins依赖环境准备" class="headerlink" title="Jenkins依赖环境准备"></a>Jenkins依赖环境准备</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">* 安装java环境</span><br><span class="line">[root@jenkins ~]# ll</span><br><span class="line">total 83356</span><br><span class="line">-rw-------. 1 root root     1292 Oct 24 05:42 anaconda-ks.cfg</span><br><span class="line">-rwxr-xr-x  1 root root  9621331 Feb  1 12:51 apache-tomcat-8.5.33.tar.gz</span><br><span class="line">-rwxr-xr-x  1 root root 75728164 Feb  1 12:51 jenkins.war</span><br><span class="line">[root@jenkins ~]# yum install -y java-1.8.0-openjdk-devel</span><br><span class="line">[root@jenkins ~]# vim /etc/profile.d/java.sh</span><br><span class="line">	export JAVA_HOME=/usr</span><br><span class="line">[root@jenkins ~]# . /etc/profile.d/java.sh</span><br><span class="line">[root@jenkins ~]# java -version</span><br><span class="line">openjdk version "1.8.0_181"</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_181-b13)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)</span><br><span class="line"></span><br><span class="line">* tomcat环境</span><br><span class="line">[root@jenkins ~]# tar xf apache-tomcat-8.5.33.tar.gz -C /usr/local/</span><br><span class="line">[root@jenkins ~]# cd /usr/local/</span><br><span class="line">[root@jenkins local]# ln -sv apache-tomcat-8.5.33/ tomcat</span><br><span class="line">'tomcat' -&gt; 'apache-tomcat-8.5.33/'</span><br><span class="line">[root@jenkins local]# cp /root/jenkins.war tomcat/webapps/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上传Jenkins.war文件到tomcat服务器，放入webapps目录中</span></span><br><span class="line">[root@jenkins tomcat]# vim /usr/local/tomcat/conf/tomcat-users.xml</span><br><span class="line">      &lt;role rolename="manager-gui"/&gt;</span><br><span class="line">      &lt;role rolename="manager-script"/&gt;</span><br><span class="line">      &lt;role rolename="manager-jmx"/&gt;</span><br><span class="line">      &lt;role rolename="manager-status"/&gt;</span><br><span class="line">      &lt;user username="tomcat_user" password="tomcat" roles="manager-gui,manager-script,manager-jmx,manager-status"/&gt;</span><br><span class="line">[root@jenkins tomcat]# vim /usr/local/tomcat/conf/server.xml</span><br><span class="line">    &lt;Connector port="8080" protocol="HTTP/1.1"</span><br><span class="line">               connectionTimeout="20000"</span><br><span class="line">               redirectPort="8443" URIEncoding="UTF-8" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入URIEncoding=<span class="string">"UTF-8"</span>地址的编码解码字符集</span></span><br><span class="line">[root@jenkins local]# vim /usr/local/tomcat/bin/catalina.sh</span><br><span class="line">    JAVA_OPTS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整tomcat使用jvm内存</span></span><br><span class="line">[root@jenkins tomcat]# /usr/local/tomcat/bin/startup.sh</span><br><span class="line">[root@jenkins tomcat]# tail -f /usr/local/tomcat/logs/catalina.out</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看启动过程</span></span><br><span class="line">[root@jenkins local]# ps aux|grep tomcat</span><br><span class="line">root       3101 33.7 38.4 3704844 717556 pts/0  Sl   13:02   0:17 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line">[root@jenkins tomcat]# cat /root/.jenkins/secrets/initialAdminPassword </span><br><span class="line">2296380bbe5e4753bc970240aca8ae2d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是打开jenkins页面时要输入的密码，这也是Jenkins的admin管理员的登录密码</span></span><br><span class="line"></span><br><span class="line">* 安装git</span><br><span class="line">[root@jenkins ~]# yum install -y git</span><br></pre></td></tr></table></figure>
<ul>
<li>下面访问10.5.5.250:8080/jenkins</li>
</ul>
<p><img src="/images/jenkins/jenkins1.jpg" alt=""></p>
<ul>
<li>选择安装推荐的插件。如果有软件安装失败，可在安装完后点Retry，再次安装。安装成功进入jenkins后，还要重启一次jenkins服务才能正常访问</li>
</ul>
<p><img src="/images/jenkins/jenkins2.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkins3.jpg" alt=""></p>
<ul>
<li>创建用户，或使用admin用户登录</li>
</ul>
<p><img src="/images/jenkins/jenkins4.jpg" alt=""></p>
<ul>
<li>确认</li>
</ul>
<p><img src="/images/jenkins/jenkins5.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkins6.jpg" alt=""></p>
<ul>
<li>完成上述步骤后可以正常登录，但测试发现chrome浏览器访问时显示空白页面，使用firefox浏览器没有问题</li>
</ul>
<p><img src="/images/jenkins/jenkins7.jpg" alt=""></p>
<ul>
<li>更换火狐浏览器后可以到登录页面，但输入用户名和密码后还是空白页面。解决方法如下：</li>
</ul>
<p><img src="/images/jenkins/jenkins8.jpg" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins tomcat]# tail -f /var/log/messages </span><br><span class="line">Oct 21 22:30:35 jenkins systemd: Stopped IPv4 firewall with iptables.</span><br><span class="line">Oct 21 22:30:35 jenkins systemd: Unit iptables.service entered failed state.</span><br><span class="line">Oct 21 22:30:35 jenkins systemd: iptables.service failed.</span><br><span class="line">Oct 21 22:43:01 jenkins systemd: Started Session 4057 of user root.</span><br><span class="line">Oct 21 22:43:01 jenkins systemd: Starting Session 4057 of user root.</span><br><span class="line">Oct 21 22:57:11 jenkins systemd: Stopping The Apache HTTP Server...</span><br><span class="line">Oct 21 22:57:13 jenkins systemd: Stopped The Apache HTTP Server.</span><br><span class="line">Oct 21 22:57:18 jenkins systemd: Reloading.</span><br><span class="line">Oct 21 22:57:18 jenkins systemd: [/usr/lib/systemd/system/vzfifo.service:19] Support for option SysVStartPriority= has been removed and it is ignored</span><br><span class="line">Oct 21 23:15:06 jenkins systemd: Configuration file /usr/lib/systemd/system/ebtables.service is marked executable. Please remove executable permission bits. Proceeding anyway.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统日志发现，要求取消/usr/lib/systemd/system/ebtables.service的可执行权限。</span></span><br><span class="line">[root@jenkins tomcat]# chmod 744 /usr/lib/systemd/system/ebtables.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 取消属组和其他人的执行权限</span></span><br><span class="line">[root@jenkins tomcat]# lsof -i:8080</span><br><span class="line">[root@jenkins tomcat]# kill -9 1181</span><br><span class="line">[root@jenkins tomcat]# /usr/local/tomcat/bin/startup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭tomcat并重新启动</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以正常访问了，使用chrome浏览器也没有问题了。但因为chrome浏览器的语言的繁体中文，所以Jenkins登录后也是繁体中文</li>
</ul>
<p><img src="/images/jenkins/jenkins9.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkins10.jpg" alt=""></p>
<h3 id="配置JDK和Maven并安装Deploy插件"><a href="#配置JDK和Maven并安装Deploy插件" class="headerlink" title="配置JDK和Maven并安装Deploy插件"></a>配置JDK和Maven并安装Deploy插件</h3><ul>
<li>登录Jenkins</li>
</ul>
<p><img src="/images/jenkins/jenkins配置1.jpg" alt=""></p>
<ul>
<li>选择全局安全配置</li>
</ul>
<p><img src="/images/jenkins/jenkins配置2.jpg" alt=""></p>
<ul>
<li>选择允许用户注册。授权策略可以先任何用户可以做任何事，方便测试使用。也可以是默认的登录用户可以做任何事。最后保存</li>
</ul>
<p><img src="/images/jenkins/jenkins配置3.jpg" alt=""></p>
<ul>
<li>选全局工具配置</li>
</ul>
<p><img src="/images/jenkins/jenkins配置4.jpg" alt=""></p>
<ul>
<li>上面两项都选择文件系统中的settings文件，之后需要输入maven的settings文件路径。JDK也一样要输入JAVA_HOME的路径，同时自定义一个别名。取消自动安装。下面的Git因为还没有，所以可以删除。Maven同JDK，需要自定义名称并输入MAVEN_HOME</li>
</ul>
<p><img src="/images/jenkins/jenkins配置5.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkins配置6.jpg" alt=""></p>
<ul>
<li>Maven的安装</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">到http://mirrors.shu.edu.cn/apache//maven/maven-3/3.5.4/binaries/下载Maven的二进制包，保存到/root目录下</span><br><span class="line">[root@jenkins ~]# tar xf apache-maven-3.5.4-bin.tar.gz -C /usr/local/</span><br><span class="line">[root@jenkins ~]# vim /etc/profile.d/maven.sh</span><br><span class="line">	export PATH=$PATH:/usr/local/apache-maven-3.5.4/bin</span><br><span class="line">	export MAVEN_HOME=/usr/local/apache-maven-3.5.4</span><br><span class="line">[root@jenkins ~]# . /etc/profile.d/maven.sh</span><br><span class="line">[root@jenkins ~]# mvn -version</span><br><span class="line">Apache Maven 3.5.4 (1edded0938998edf8bf061f1ceb3cfdeccf443fe; 2018-06-17T18:33:14Z)</span><br><span class="line">Maven home: /usr/local/apache-maven-3.5.4</span><br><span class="line">Java version: 1.8.0_181, vendor: Oracle Corporation, runtime: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.181-3.b13.el7_5.x86_64/jre</span><br><span class="line">Default locale: en_US, platform encoding: ANSI_X3.4-1968</span><br><span class="line">OS name: "linux", version: "4.15.17-1-pve", arch: "amd64", family: "unix"</span><br><span class="line">[root@jenkins local]# vim /usr/local/apache-maven-3.5.4/conf/settings.xml</span><br><span class="line">&lt;mirrors&gt;</span><br><span class="line">&lt;mirror&gt;</span><br><span class="line">       &lt;id&gt;nexus-osc&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus osc&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> mirrors段添加国内源地址。</span></span><br><span class="line">&lt;profile&gt;</span><br><span class="line">    &lt;id&gt;jdk-1.4&lt;/id&gt;</span><br><span class="line">    &lt;activation&gt;</span><br><span class="line">    &lt;jdk&gt;1.4&lt;/jdk&gt;</span><br><span class="line">    &lt;/activation&gt;</span><br><span class="line">    &lt;repositories&gt;</span><br><span class="line">        &lt;repository&gt;</span><br><span class="line">            &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;local private nexus&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">            &lt;releases&gt;</span><br><span class="line">                &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">            &lt;/releases&gt;</span><br><span class="line">            &lt;snapshots&gt;</span><br><span class="line">                &lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">            &lt;/snapshots&gt;</span><br><span class="line">        &lt;/repository&gt;</span><br><span class="line">    &lt;/repositories&gt;</span><br><span class="line">    &lt;pluginRepositories&gt;</span><br><span class="line">        &lt;pluginRepository&gt;</span><br><span class="line">            &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;local private nexus&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">            &lt;releases&gt;</span><br><span class="line">                &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">            &lt;/releases&gt;</span><br><span class="line">            &lt;snapshots&gt;</span><br><span class="line">                &lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">            &lt;/snapshots&gt;</span><br><span class="line">        &lt;/pluginRepository&gt;</span><br><span class="line">    &lt;/pluginRepositories&gt;</span><br><span class="line">&lt;/profile&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Maven 还需要安装一些插件包，这些插件包的下载地址也让其指向 oschina.net 的 Maven 地址。在&lt;profiles&gt;中插入</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要修改为国内源，不然构建速度将非常慢。尤其是在jenkins中</span></span><br></pre></td></tr></table></figure>
<ul>
<li>选择插件管理</li>
</ul>
<p><img src="/images/jenkins/jenkins配置7.jpg" alt=""></p>
<ul>
<li>安装插件deploy to container，这个插件是让jenkins成功构建后可以部署war包到tomcat的</li>
</ul>
<p><img src="/images/jenkins/jenkins配置8.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkins配置9.jpg" alt=""></p>
<h3 id="gitlab安装"><a href="#gitlab安装" class="headerlink" title="gitlab安装"></a>gitlab安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">下载gitlab-ce-10.6.1-ce.0.el7.x86_64.rpm到/root目录</span><br><span class="line">[root@localhost ~]# yum install -y gitlab-ce-10.6.1-ce.0.el7.x86_64.rpm</span><br><span class="line">[root@localhost ~]# vim /etc/gitlab/gitlab.rb</span><br><span class="line">	external_url 'http://10.5.5.199'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置服务地址</span></span><br><span class="line">[root@localhost ~]# gitlab-ctl reconfigure</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是一个初始化的过程</span></span><br><span class="line">访问IP，要求设置root密码，需要是一个复杂的密码，之后就可以正常登录了</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果访问出现502错误，可以查看是否之前安装并启动过web服务或tomcat服务，卸载服务并重启gitlab后就可以正常访问了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [root@gitlab ~]<span class="comment"># gitlab-ctl restart		# 重启gitlab命令</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 另外也可以查看一下内存是否不足</span></span><br></pre></td></tr></table></figure>
<h3 id="获取gitlab的token"><a href="#获取gitlab的token" class="headerlink" title="获取gitlab的token"></a>获取gitlab的token</h3><ul>
<li>使用root用户登录</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken1.jpg" alt=""></p>
<ul>
<li>选择左下角的settings，并勾选最下方的“Allow requests to the local network from hooks and services”并保存。此项非常关键，如果不勾选此项，之后测试连接jenkins时会报500错误</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken2.jpg" alt=""></p>
<ul>
<li>登出root用户，重新注册一个新用户</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken3.jpg" alt=""></p>
<ul>
<li>选择用户的settings，并选择左侧的”Access Tokens”</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken4.jpg" alt=""></p>
<ul>
<li>创建Token</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken5.jpg" alt=""></p>
<ul>
<li>得到一个Token，这个很重要，需要记录，如果关闭此页面，之后就找不到这个Token了</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken6.jpg" alt=""></p>
<h3 id="创建一个git项目"><a href="#创建一个git项目" class="headerlink" title="创建一个git项目"></a>创建一个git项目</h3><ul>
<li>使用普通用户登录，到首页创建项目</li>
</ul>
<p><img src="/images/jenkins/gitlab项目1.jpg" alt=""></p>
<p><img src="/images/jenkins/gitlab项目2.jpg" alt=""></p>
<ul>
<li>这两条命令在设置jenkins时有用</li>
</ul>
<p><img src="/images/jenkins/gitlab项目3.jpg" alt=""></p>
<h3 id="生成访问Gitlab的ssh秘钥。"><a href="#生成访问Gitlab的ssh秘钥。" class="headerlink" title="生成访问Gitlab的ssh秘钥。"></a>生成访问Gitlab的ssh秘钥。</h3><blockquote>
<p> <strong>从gitlab以SSH方式拉取或提交代码需要用到这个SSH 秘钥</strong>，哪台机器需要从gitlab上拉取代码，就在哪台机器上生成一次SSH Key，因此，在jenkins服务器上，以及你的开发PC上，都需要生成SSH密钥。</p>
</blockquote>
<p><img src="/images/jenkins/gitlabssh1.jpg" alt=""></p>
<ul>
<li>在jenkins与要部署代码的服务器上执行生成秘钥的命令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins conf]# ssh-keygen -t rsa -P ''</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Created directory '/root/.ssh'.</span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">69:1e:73:2b:de:c8:e8:23:79:9a:0a:96:6f:e8:8a:b8 root@jenkins</span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|                 |</span><br><span class="line">|                 |</span><br><span class="line">|                 |</span><br><span class="line">|         .       |</span><br><span class="line">|        S .      |</span><br><span class="line">|  .    o + .     |</span><br><span class="line">|.o.  .  o .      |</span><br><span class="line">|+o..o.o+ +       |</span><br><span class="line">|Eoooo=o.+ .      |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@jenkins conf]# cat /root/.ssh/id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDZS8mV9dyi2kOCnhe3o5V/bc8EEln6cVpNXQ16P4lKvAYSdcmrRTYdWapsssJAzjWnA5Pa/u32n/OWKTZDq+qmV3IxlQwuOVI7AeB5TJTuawk90f/1fj7aN1963yOvlZthS8dRUvEcrq+HHpekmAH+mLDeQGYcZEoNsovl1Cvp3TVNDC/7sKds7yoYmHupknyn5d7tgGID8Up02DJlgUQK6V7ZvivjRxAaYAjsWSEktIZK0jv0uWqo6cSddC/rLERGL4spjdwqErFKDQ8SVhArD5zR7L5Lpf9McbxFLFpMMN0I2U+udCXa8n7vwbzHTyaFU+ZvUkX80ykDpMJIW5ot root@jenkins</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将此公钥放入gitlab中</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/jenkins/gitlabssh2.jpg" alt=""></p>
<p><img src="/images/jenkins/gitlabssh3.jpg" alt=""></p>
<h3 id="jenkins中安装gitlab插件"><a href="#jenkins中安装gitlab插件" class="headerlink" title="jenkins中安装gitlab插件"></a>jenkins中安装gitlab插件</h3><blockquote>
<p>需要的插件：</p>
<ul>
<li>GitLab Hook：使 gitlab web 挂钩能够用于触发 gitlab 项目上的 smc 轮询</li>
<li>GitLab：这个插件允许 gitlab 触发 jenkins 构建, 并在 gitlab ui 中显示它们的结果。</li>
<li>Gitlab Authentication：这是使用 gitlab oauth 的身份验证插件。</li>
<li>Git Parameter：增加了从项目中配置的 git 存储库中选择分支、标记或修订的功能。</li>
<li>Build Authorization Token Root：即使匿名用户看不到 jenkins, 也可以访问生成和相关的 rest 生成触发器</li>
<li>Publish Over SSH：通过 ssh 发送生成项目</li>
</ul>
</blockquote>
<p><img src="/images/jenkins/gitlabPlugin1.jpg" alt=""></p>
<p><img src="/images/jenkins/gitlabPlugin2.jpg" alt=""></p>
<p><img src="/images/jenkins/gitlabPlugin3.jpg" alt=""></p>
<h3 id="jenkins中设置token"><a href="#jenkins中设置token" class="headerlink" title="jenkins中设置token"></a>jenkins中设置token</h3><blockquote>
<p>jenkins可以通过从gitlab上得到的token，与gitlab协同工作</p>
</blockquote>
<p><img src="/images/jenkins/jenkinsgitlabtoken1.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkinsgitlabtoken2.jpg" alt=""></p>
<ul>
<li><p>Connection name可以自定义；Gitlab host URL是gitlab的访问地址；最后设置Credentials</p>
<p><img src="/images/jenkins/jenkinsgitlabtoken3.jpg" alt=""></p>
</li>
<li><p>在弹出的窗口中选择类型为GitLab API token，之后输入在gitlab中取得的项目的token，最后添加</p>
</li>
</ul>
<p><img src="/images/jenkins/jenkinsgitlabtoken4.jpg" alt=""></p>
<ul>
<li>选择刚创建的”GitLab API token”，然后点击”Test Connection”测试是否连接正常，如果没有问题就保存。这里的配置会在创建任务后的第一个General页面的”GitLab Connection”中自动引用</li>
</ul>
<p><img src="/images/jenkins/jenkinsgitlabtoken5.jpg" alt=""></p>
<h3 id="jenkins中设置Publish-over-SSH"><a href="#jenkins中设置Publish-over-SSH" class="headerlink" title="jenkins中设置Publish over SSH"></a>jenkins中设置Publish over SSH</h3><ul>
<li>进入设置</li>
</ul>
<p><img src="/images/jenkins/jenkinsSSH1.jpg" alt=""></p>
<ul>
<li>输入jenkins服务器的私钥，也就是用户家目录中.ssh中的id_rsa文件的内容（这是为了可以通过jenkins的公钥与私钥进行配对，使jenkins可以在远程主机上操作，当然也需要jenkins将公钥传到远程主机），SSH Servers中设置自定义Name，Hostname是要部署代码的服务器地址，Username是登录用的用户名，Remote Directory这里设置为了/usr/share/nginx/html，之后jenkins就可以向这个目录部署网页文件了</li>
</ul>
<p><img src="/images/jenkins/jenkinsSSH2.jpg" alt=""></p>
<h3 id="配置git插件"><a href="#配置git插件" class="headerlink" title="配置git插件"></a>配置git插件</h3><ul>
<li>打开系统管理中的系统设置</li>
</ul>
<p><img src="/images/jenkins/git插件1.jpg" alt=""></p>
<ul>
<li>选择Git plugin</li>
</ul>
<p><img src="/images/jenkins/git插件2.jpg" alt=""></p>
<ul>
<li>设置Git插件的全局配置，然后点击“apply”——“save”。全局配置就是上面“Gitlab创建项目”部分中的global setting ，也就是git的用户名和邮箱地址。在项目第一次commit前，这些信息都可以在GitLab的项目的首页里找到</li>
</ul>
<p><img src="/images/jenkins/git插件3.jpg" alt=""></p>
<h3 id="创建一个Jenkins-Job"><a href="#创建一个Jenkins-Job" class="headerlink" title="创建一个Jenkins Job"></a>创建一个Jenkins Job</h3><blockquote>
<p>在jenkins里，一个任务叫做一个job。一般我们的项目会有多个分支，比如开发分支和产品分支，我们可以对每一个分支都新建一个job，比如，我们对开发分支创建一个测试的job，每次有代码提交就自动运行一次测试，对产品分支创建一个打包的job，每次有代码提交就运行打包任务。</p>
<p>在系统设置中设置的项就是为了可以在任务中得到引用。</p>
</blockquote>
<p><img src="/images/jenkins/创建jenkinsjob1.jpg" alt=""></p>
<ul>
<li>创建的job最好与gitlab中的项目名一致</li>
</ul>
<p><img src="/images/jenkins/创建jenkinsjob2.jpg" alt=""></p>
<h3 id="配置Job"><a href="#配置Job" class="headerlink" title="配置Job"></a>配置Job</h3><ul>
<li>在源码管理里，选择Git，并输入路径，路径可以在gitlab的项目首页上看到</li>
</ul>
<p><img src="/images/jenkins/配置job1.jpg" alt=""></p>
<ul>
<li>添加用户，类型选“SSH Username with private key”；Username填root；选择PrivateKey中的Enter directly，在下面的key中输入jenkins服务器的私钥，可以用命令<code>cat /root/.ssh/id_rsa</code>查看。也里是指使用jenkins服务器上root用户的私钥访问gitlab上的项目，与gitlab上的jenkins服务器的root用户的公钥进行验证。</li>
</ul>
<p><img src="/images/jenkins/配置job2.jpg" alt=""></p>
<blockquote>
<p>在Repository URL下面的红字提示“Failed to connect to repository : Error performing command: git ls-remote -h <a href="mailto:git@10.5.5.11" target="_blank" rel="noopener">git@10.5.5.11</a>:test/ccjdtest.git HEAD”是因为jenkins服务器上没有安装git，安装后解决。</p>
</blockquote>
<p><img src="/images/jenkins/配置job3.jpg" alt=""></p>
<blockquote>
<p>jenkins job默认对master分支进行构建，你也可以自定义分支。这要求你的Gitlab代码仓库中要存在这个分支，一般来说，就是要向代码仓库提交一次更改，请 <strong>自行完成</strong>（Gitlab项目刚创建时是空的，一个分支也没有，这样的话，自动构建时会出错）</p>
</blockquote>
<p><img src="/images/jenkins/配置job4.jpg" alt=""></p>
<ul>
<li>配置构建触发器，选择Build一行，后面的地址就是jenkins上放项目的路径，再选择下面的高级</li>
</ul>
<p><img src="/images/jenkins/配置job5.jpg" alt=""></p>
<ul>
<li>选择Filter branches by regex，表示要触发自动部署的分支，在下面的Target Branch Regex中输入”.*master”，这是正则表达式，表示分支名。最后点击Generate，生成gitlab webhook的安全令牌，在配置gitlab时有用。</li>
</ul>
<p><img src="/images/jenkins/配置job6.jpg" alt=""></p>
<ul>
<li>构建，选择新增中的send files or … over SSH</li>
</ul>
<p><img src="/images/jenkins/配置job7.jpg" alt=""></p>
<ul>
<li>这里的Name中会有在Jenkins的设置中设置的Publish over SSH的服务器名字，下面的Source files中输入“**/**”，Remote directory中要部署到远程服务器的路径，Exec command是在远程服务器部署完代码后要执行的命令</li>
</ul>
<h3 id="gitlab上设置webhook"><a href="#gitlab上设置webhook" class="headerlink" title="gitlab上设置webhook"></a>gitlab上设置webhook</h3><ul>
<li>到gitlab的项目中设置集成</li>
</ul>
<p><img src="/images/jenkins/webhook1.jpg" alt=""></p>
<ul>
<li>URL与Secret Token都是在Jenkins中的项目配置中取得的，取消SSL的勾选，最后添加</li>
</ul>
<p><img src="/images/jenkins/webhook2.jpg" alt=""></p>
<ul>
<li>添加后在下面的Webhooks中就会有添加的项，点Test中的Push events测试。这里一定要在gitlab的项目中有一个文件，如果没有，测试时会提示“Hook execution failed: Ensure the project has at least one commit.”。可以在gitlab项目中创建一个README文件</li>
</ul>
<p><img src="/images/jenkins/webhook3.jpg" alt=""></p>
<ul>
<li>如果测试正常，在页面最上方会有HTTP 200的提示</li>
</ul>
<p><img src="/images/jenkins/webhook4.jpg" alt=""></p>
<ul>
<li>webhook就是为了在有人上传代码时，就会触发上面设置的地址，只要触发这个地址，jenkins就会自动部署</li>
</ul>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><ul>
<li>到要部署代码的服务器上，安装nginx。</li>
<li>到jenkins服务器上安装git，准备拉取代码</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-------------</span><br><span class="line">  jenkins</span><br><span class="line">-------------</span><br><span class="line">ssh-copy-id -i /root/.ssh/id_rsa.pub 10.5.5.22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 要与部署代码的服务器实现密钥通讯</span></span><br><span class="line">git clone git@10.5.5.11:test/ccjdtest.git</span><br><span class="line">cd ccjdtest/</span><br><span class="line">echo "test Jenkins" &gt; index.html</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个文件</span></span><br><span class="line">git config --global user.email "test@ccjd.com"</span><br><span class="line">git config --global user.name "test"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这两项是在gitlab中创建项目时设置的</span></span><br><span class="line">git add .</span><br><span class="line">git commit -m 'add index.html'</span><br><span class="line">git push</span><br><span class="line"><span class="meta">#</span><span class="bash"> 推送到gitlab服务器</span></span><br></pre></td></tr></table></figure>
<ul>
<li>到jenkins中查看项目情况，如果配置正确，推送代码到gitlab后，这里会有提示</li>
</ul>
<p><img src="/images/jenkins/测试1.jpg" alt=""></p>
<ul>
<li>到部署代码的服务器上查看，index.html文件已放入了/usr/share/nginx/html目录中，并且服务已重新启动。访问页面变成了我们设置的内容。</li>
</ul>
<h3 id="测试maven手动部署"><a href="#测试maven手动部署" class="headerlink" title="测试maven手动部署"></a>测试maven手动部署</h3><h4 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h4><ol>
<li>注册gitlab帐号</li>
<li>创建git项目</li>
<li>将上传代码的主机、Jenkins服务器、与部署代码的服务器的公钥上传到gitlab</li>
<li>将项目clone到本地</li>
<li>将本地代码push到gitlab</li>
<li>在Jenkins中创建Job</li>
<li>设置Job中的git地址，Jenkins登录git的用户名与私钥。新建构建“调用顶层Maven目标”</li>
<li>第一次构建，要到Job中点击“立即构建”</li>
<li>构建后操作</li>
</ol>
<h4 id="设置Job"><a href="#设置Job" class="headerlink" title="设置Job"></a>设置Job</h4><ul>
<li>设置Job，输入git地址，设置jenkins服务器登录gitlib时用的用户名与私钥，这样私钥与jenkins上传到gitlab上的公钥就可以配对了</li>
</ul>
<p><img src="/images/jenkins/设置job1.jpg" alt=""></p>
<ul>
<li>设置构建，选择调用顶层Maven目标</li>
</ul>
<p><img src="/images/jenkins/设置job2.jpg" alt=""></p>
<ul>
<li>Maven版本是在jenkins设置中设置好的，目标是一条Maven命令：“clean install -Dmaven.test.skip=true”</li>
</ul>
<p><img src="/images/jenkins/设置job3.jpg" alt=""></p>
<ul>
<li>设置构建后操作。WAR/EAR files是一个相对路径，相对/root/.jenkins/workspace/echarging/而言，echarging是项目的名称，项目下的target中有war文件，这里输入c-rest/target表示在项目目录下还有一层。Context path是访问的名称，之后就可以使用IP:8080/rest访问了。再选择下面的Containers为Tomcat8.x，这要根据实际情况选择，然后添加一个可以访问tomcat的manager_webapp页面的用户名和密码，这是在部署代码的tomcat中设置的。下面就是Tomcat的访问地址。都输入正确后保存即可。这样，在Maven处理完代码后，就会自动部署到部署代码的tomcat服务器上了。</li>
</ul>
<p><img src="/images/jenkins/设置job4.jpg" alt=""></p>
<ul>
<li>在部署代码的服务器上设置tomcat</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon local]# yum install -y java-1.8.0-openjdk-devel</span><br><span class="line">[root@bogon ~]# vim /etc/profile.d/java.sh</span><br><span class="line">	export JAVA_HOME=/usr</span><br><span class="line">[root@bogon tomcat]# vim /usr/local/tomcat/conf/tomcat-users.xml</span><br><span class="line">      &lt;role rolename="manager-gui"/&gt;</span><br><span class="line">      &lt;role rolename="manager-script"/&gt;</span><br><span class="line">      &lt;role rolename="manager-jmx"/&gt;</span><br><span class="line">      &lt;role rolename="manager-status"/&gt;</span><br><span class="line">      &lt;user username="tomcat_user" password="tomcat" roles="manager-gui,manager-script,manager-jmx,manager-status"/&gt;</span><br><span class="line">[root@bogon tomcat]# vim webapps/manager/META-INF/context.xml</span><br><span class="line">	&lt;Context antiResourceLocking="false" privileged="true" &gt;</span><br><span class="line">  &lt;Valve className="org.apache.catalina.valves.RemoteAddrValve"</span><br><span class="line">         allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10.5.5.90|10.5.5.9" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里加入两个地址，一个是本地的地址，为了测试页面是否可以打开。一个是jenkins的地址。如果不加jenkins的地址，jenkins的部署会报错。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>到Job中，点击立即构建</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-------------</span><br><span class="line">  jenkins</span><br><span class="line">-------------</span><br><span class="line">1. 全局安全设置，可以用户注册</span><br><span class="line">2. 系统设置中设置maven和java的家目录</span><br><span class="line">3. 安装deploy to container及gitlib相关插件</span><br><span class="line">4. jenkins中设置token，使jenkins与gitlab可以联合工作</span><br><span class="line">5. 配置publish over ssh，使jenkins可以使用ssh方法发送文件到远程服务器，或在远程服务器上执行命令。当然还需要将jenkins的公钥传输到远程主机</span><br><span class="line">6. 配置git，使用jenkins可以到远程的gitlab上进行验证</span><br><span class="line">7. 配置JOB</span><br><span class="line">7.1 源码管理中使用git，创建一个带有jenkins服务器上私钥的用户名，让jenkins可以使用私钥与github上的jenkins的公钥配对。让gitlab可以将代码推送到jenkins。</span><br><span class="line">7.2 构建触发器选择Build when a change is pushed to GitLab. (当更改推送到 gitlab 时生成。)，这是为了让gitlab可以向jenkins发送POST请求的。之后设置自动触发的分支，生成一个webhook安全令牌。</span><br><span class="line">7.3 构建，选择Send files or execute commands over SSH，也就是在构建期间通过ssh作为构建步骤发送文件或执行命令的方法，之后可以设置要部署的服务器，这个服务器是在publish over ssh中设置好的某台服务器，还可以设置代码的源路径，要部署的远程服务器的路径，要在远程服务器上执行的命令等。</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">  gitlab</span><br><span class="line">-----------</span><br><span class="line">1. 生成token，给jenkins使用</span><br><span class="line">2. 为某个项目设置webhook。设置jenkins的URL与jenkins中生成的webhook安全令牌，使gitlab知道如何通知jenkins</span><br><span class="line">3. 当项目中的代码发生变化时，gitlab会将代码推送到jenkins主机进行部署</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/19/RabbitMQ基本命令与配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/19/RabbitMQ基本命令与配置/" itemprop="url">
                  RabbitMQ基本命令与配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-19 09:19:56 / 修改時間：13:46:31" itemprop="dateCreated datePublished" datetime="2018-10-19T09:19:56+08:00">2018-10-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/消息队列/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><h5 id="rabbitmq-server命令"><a href="#rabbitmq-server命令" class="headerlink" title="rabbitmq server命令"></a>rabbitmq server命令</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">systemctl start rabbitmq-server</span><br><span class="line">systemctl stop rabbitmq-server</span><br><span class="line">systemctl status rabbitmq-server</span><br><span class="line">systemctl rotate-logs rabbitmq-server</span><br><span class="line">systemctl restart rabbitmq-server</span><br><span class="line">systemctl condrestart rabbitmq-server</span><br><span class="line">systemctl try-restart rabbitmq-server</span><br><span class="line">systemctl reload rabbitmq-server</span><br><span class="line">systemctl force-reload rabbitmq-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> rabbitmq默认监听5672端口，网页管理页面监听15672端口</span></span><br></pre></td></tr></table></figure>
<h5 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">** 开启插件</span><br><span class="line">rabbitmq-plugins enable 插件名</span><br><span class="line">** 关闭插件</span><br><span class="line">rabbitmq-plugins disable 插件名</span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启rabbitmq web管理页面插件</span></span><br></pre></td></tr></table></figure>
<h5 id="rabbitmqctl命令"><a href="#rabbitmqctl命令" class="headerlink" title="rabbitmqctl命令"></a>rabbitmqctl命令</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">* 创建用户，设置密码</span><br><span class="line">rabbitmqctl add_user username password</span><br><span class="line"></span><br><span class="line">* 分配用户标签-设置为管理用户。默认用户名密码为guest</span><br><span class="line">rabbitmqctl set_user_tags username tag</span><br><span class="line"><span class="meta">#</span><span class="bash"> Tag可以为：administrator,monitoring, management等</span></span><br><span class="line"></span><br><span class="line">* 查看现有用户信息</span><br><span class="line">rabbitmqctl list_users</span><br><span class="line"></span><br><span class="line">* 删除用户</span><br><span class="line">rabbitmqctl delete_user username</span><br><span class="line"></span><br><span class="line">* 修改用户密码</span><br><span class="line">rabbitmqctl change_password username password</span><br><span class="line"></span><br><span class="line">* 查看所有队列消息</span><br><span class="line">rabbitmqctl list_queues</span><br><span class="line"></span><br><span class="line">* 清除所有队列</span><br><span class="line">rabbitmqctl reset</span><br><span class="line"></span><br><span class="line">* 新建虚拟机</span><br><span class="line">rabbitmqctl add_vhost  虚拟机名</span><br><span class="line"></span><br><span class="line">* 撤销虚拟机</span><br><span class="line">rabbitmqctl delete_vhost 虚拟机名</span><br><span class="line"></span><br><span class="line">* 服务器状态</span><br><span class="line">rabbitmqctl status</span><br></pre></td></tr></table></figure>
<h5 id="防火墙设置"><a href="#防火墙设置" class="headerlink" title="防火墙设置"></a>防火墙设置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 15672 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 25672 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 5672 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 4369 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 5671 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h4 id="rabbitmq配置"><a href="#rabbitmq配置" class="headerlink" title="rabbitmq配置"></a>rabbitmq配置</h4><h5 id="RabbitMQ支持三种配置方式："><a href="#RabbitMQ支持三种配置方式：" class="headerlink" title="RabbitMQ支持三种配置方式："></a><strong>RabbitMQ支持三种配置方式：</strong></h5><ul>
<li>读取环境变量中配置， 这包括shell中环境变量和rabbitmq-env.conf/rabbitmq-env-conf.bat文件中配置的环境变量</li>
</ul>
<p>&emsp;&emsp;可配置如端口、配置文件指定自定义位置、节点名字等信息。</p>
<ul>
<li>读取配置文件rabbitmq.config</li>
</ul>
<p>&emsp;&emsp;可配置权限、集群、插件设置等高级信息， 当然也可配置端口等简单信息</p>
<ul>
<li>通过运行命令时指定参数</li>
</ul>
<p>&emsp;&emsp;通常用来配置集群范围信息， 用来运行时动态传入</p>
<h5 id="环境变量读取优先级"><a href="#环境变量读取优先级" class="headerlink" title="环境变量读取优先级"></a><strong>环境变量读取优先级</strong></h5><ul>
<li><p>读取shell中环境变量</p>
</li>
<li><p>读取rabbitmq-env.conf/rabbitmq-env-conf.bat中的</p>
</li>
<li><p>读取默认的</p>
</li>
</ul>
<h5 id="rabbitmq-env-conf-rabbitmq-env-conf-bat-详解（颜色标注的为常用配置）"><a href="#rabbitmq-env-conf-rabbitmq-env-conf-bat-详解（颜色标注的为常用配置）" class="headerlink" title="rabbitmq-env.conf/rabbitmq-env-conf.bat 详解（颜色标注的为常用配置）"></a><strong>rabbitmq-env.conf/rabbitmq-env-conf.bat 详解（颜色标注的为常用配置）</strong></h5><table>
<thead>
<tr>
<th style="text-align:left">变量名称</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">RABBITMQ_NODE_IP_ADDRESS</td>
<td>默认为空字符串， 即绑定所有网络接口</td>
<td>如果想绑定到一个固定的IP可以使用此变量. 如果要绑定到两个或两个以上只能通过rabbitmq.config中的tcp_listeners来设置。</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_NODE_PORT</td>
<td>5672</td>
<td>供客户端建立连接端口</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_DIST_PORT</td>
<td>RABBITMQ_NODE_PORT + 20000</td>
<td>用于节点和CLI工具连接的端口， 如果rabbitmq.config中配置了kernel.inet_dist_listen_min 或 kernel.inet_dist_listen_max该参数将被忽略</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_NODENAME</td>
<td>Unix*: rabbit@$HOSTNAMEWindows: rabbit@%COMPUTERNAME%</td>
<td>节点名字， 必须唯一</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_CONF_ENV_FILE</td>
<td>Generic UNIX - $RABBITMQ_HOME/etc/rabbitmq/Debian - /etc/rabbitmq/RPM - /etc/rabbitmq/Mac OS X (Homebrew) - ${install_prefix}/etc/rabbitmq/, the Homebrew prefix is usually /usr/localWindows - %APPDATA%\RabbitMQ\</td>
<td>rabbitmq-env.conf/rabbitmq-env-conf.bat 默认位置， 不同系统不同安装方式位置也不同， 如果默认位置没找到则需在该位置手动创建一个</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_CONFIG_FILE</td>
<td>同上</td>
<td>rabbitmq.config 默认位置。 如果默认位置没找到则需在该位置手动创建一个</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_USE_LONGNAME</td>
<td>官网没说。。。。应该是false。。。</td>
<td>取值： true 或 false。  如果配置为true， 这将导致RabbitMQ使用完全限定的名称来标识节点</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_SERVICENAME</td>
<td>Windows Service: RabbitMQ</td>
<td>服务名称</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_CONSOLE_LOG</td>
<td>只在控制台输出日志， 日志不会持久化到文件</td>
<td>取值： new 或 reuse。两种取值都是将控制台输出从服务器重定向到名为%rabbitmqservicename%（上面那个变量）的文件。　　1）默认： 不设置， 控制台的日志不会被持久化到文件　　2）new： 每次启动时都会创建一个新的文件　　3）reuse： 每次启动服务器都会重用该日志文件</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_CTL_ERL_ARGS</td>
<td>None</td>
<td>在调用rabbitmqctl时使用的erl命令的参数。应该仅用于调试目的。</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_SERVER_ERL_ARGS</td>
<td>Unix*:”+K true +A30 +P 1048576 -kernel inet_default_connect_options [{nodelay,true}]”Windows: None</td>
<td>在调用RabbitMQ服务器时使用的erl命令的标准参数， 应该仅用于调试目的</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS</td>
<td>Unix*: NoneWindows: None</td>
<td>在调用RabbitMQ服务器时使用的erl命令的附加参数。这个变量的值被附加到参数的默认列表(RABBITMQ_SERVER_ERL_ARGS).</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_SERVER_START_ARGS</td>
<td>None</td>
<td>在调用RabbitMQ服务器时使用的erl命令的额外参数。这不会覆盖RABBITMQ_SERVER_ERL_ARGS.</td>
</tr>
<tr>
<td style="text-align:left">HOSTNAME</td>
<td>Unix, Linux: <code>env hostname</code>MacOSX: <code>env hostname -s</code></td>
<td>当前机器名称</td>
</tr>
<tr>
<td style="text-align:left">COMPUTERNAME</td>
<td>Windows: localhost</td>
<td>当前机器名称， windows使用该变量</td>
</tr>
<tr>
<td style="text-align:left">ERLANG_SERVICE_MANAGER_PATH</td>
<td>Windows Service: %ERLANG_HOME%\erts-x.x.x\bin</td>
<td>erlsrv.exe的路径， erlsrv.exe这个是erlang服务的包装脚本</td>
</tr>
</tbody>
</table>
<h3 id=""><a href="#" class="headerlink" title=" "></a> </h3><h5 id="rabbitmq-config详解（核心配置）"><a href="#rabbitmq-config详解（核心配置）" class="headerlink" title="rabbitmq.config详解（核心配置）"></a><strong>rabbitmq.config详解（核心配置）</strong></h5><p>&emsp;&emsp;该配置文件使用的是Erlang标准配置文件，语法请参照<a href="http://erlang.org/doc/man/config.html" target="_blank" rel="noopener">这里</a></p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">例： </span><br><span class="line">  [</span><br><span class="line">    &#123;rabbit, [&#123;tcp_listeners, [<span class="number">5673</span>]&#125;]&#125;</span><br><span class="line">  ].</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>key</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>tcp_listeners</td>
<td>监听AMQP连接的端口或主机/对。 Default: [5672]</td>
</tr>
<tr>
<td>num_tcp_acceptors</td>
<td>Erlang进程的数量，接受TCP监听器的连接数。 Default: 10</td>
</tr>
<tr>
<td>handshake_timeout</td>
<td>对AMQP 0-8/0-9/0-9-1握手的最大时间(在套接字连接和SSL握手之后)，以毫秒为间隔 Default: 10000</td>
</tr>
<tr>
<td>ssl_listeners</td>
<td>如上所述，用于SSL连接。 Default: []</td>
</tr>
<tr>
<td>num_ssl_acceptors</td>
<td>用于接受SSL监听连接的Erlang进程的数量。 Default: 1</td>
</tr>
<tr>
<td>ssl_options</td>
<td>SSL配置参数. 详情请看 <a href="http://www.rabbitmq.com/ssl.html#enabling-ssl" target="_blank" rel="noopener">SSL documentation</a>.Default: []</td>
</tr>
<tr>
<td>ssl_handshake_timeout</td>
<td>SSL握手超时，以毫秒为间隔。 Default: 5000</td>
</tr>
<tr>
<td>vm_memory_high_watermark</td>
<td>触发流控制的内存阈值。详情请看 <a href="http://www.rabbitmq.com/memory.html" target="_blank" rel="noopener">memory-based flow control</a>.Default: 0.4</td>
</tr>
<tr>
<td>vm_memory_high_watermark_paging_ratio</td>
<td>设置当内存使用超过总内存百分比多少时，队列开始将消息持久化到磁盘以释放内存。 详情请看 <a href="http://www.rabbitmq.com/memory.html" target="_blank" rel="noopener">memory-based flow control</a>.Default: 0.5</td>
</tr>
<tr>
<td>disk_free_limit</td>
<td>RabbitMQ存储数据的分区的磁盘空间限制。当可用的磁盘空间低于这个限制时，就会触发流控制。值可以相对于RAM的总数设置(例如，内存比例，1.0)。该值也可以设置为整数的字节数。或者，单位(例如“50 mb”)。默认情况下，空闲磁盘空间必须超过50MB。详情请看 <a href="http://www.rabbitmq.com/disk-alarms.html" target="_blank" rel="noopener">Disk Alarms</a>.Default: 50000000</td>
</tr>
<tr>
<td>log_levels</td>
<td>控制日志的粒度。该值是一个日志事件类别和日志级别对的列表。 可设置级别：　　‘none’　　‘error’　　‘warning’　　‘info’ 　　‘debug’ 　　以上下一层级别的日志输出均包含上层级别日志输出（如： warning包含warning和error）, none为不输出日志 另外，当前未分类的事件总是记录在日志中The categories are:channel - 所有与AMQP通道有关的事件connection - 对于所有与网络连接有关的事件federation - 对于所有与<a href="http://www.rabbitmq.com/federation.html" target="_blank" rel="noopener">federation</a>有关的事件mirroring - 对于与镜像队列相关的所有事件Default: [{connection, info}]</td>
</tr>
<tr>
<td>frame_max</td>
<td>框架最大允许大小(以字节为单位)与消费者进行数据交换。设置为0意味着“无限”，但会在一些QPid客户端触发一个bug。设置更大的值可能会提高吞吐量;设置较小的值可能会提高延迟。Default: 131072</td>
</tr>
<tr>
<td>channel_max</td>
<td>与消费者进行谈判的最大允许数量。设置为0意味着“无限”。使用更多的通道会增加代理的内存占用。Default: 0</td>
</tr>
<tr>
<td>channel_operation_timeout</td>
<td>通道操作超时为毫秒(内部使用，由于消息传递协议的差异和限制而不直接暴露于客户机)。 Default: 15000</td>
</tr>
<tr>
<td>heartbeat</td>
<td>该值表示服务器在连接中发送的心跳延迟，在几秒钟内。优化框架。如果设置为0，则会禁用心跳。客户端可能不会遵循服务器的建议，请参阅AMQP参考以了解更多细节。在有大量连接的情况下，禁用心跳可能改善性能，但可能会导致连接在关闭非活动连接的网络设备的出现。Default: 60 (580 prior to release 3.5.5)</td>
</tr>
<tr>
<td>default_vhost</td>
<td>当RabbitMQ创建一个新的数据库时，创建一个虚拟主机。交换amq.rabbitmq.logwill存在于这个虚拟主机中。Default: &lt;&lt;”/“&gt;&gt;</td>
</tr>
<tr>
<td>default_user</td>
<td>当RabbitMQ从头创建一个新数据库时，要创建用户名。  Default: &lt;&lt;”guest”&gt;&gt;</td>
</tr>
<tr>
<td>default_pass</td>
<td>默认用户的密码。 Default: &lt;&lt;”guest”&gt;&gt;</td>
</tr>
<tr>
<td>default_user_tags</td>
<td>默认用户的标记。 Default: [administrator]</td>
</tr>
<tr>
<td>default_permissions</td>
<td>在创建时分配给默认用户的权限。 Default:  [&lt;&lt;”.<em>“&gt;&gt;, &lt;&lt;”.</em>“&gt;&gt;, &lt;&lt;”.*”&gt;&gt;]</td>
</tr>
<tr>
<td>loopback_users</td>
<td>只允许通过环回接口连接到代理的用户列表(即localhost)。 如果您希望允许缺省的来宾用户远程连接，则需要将其更改为 [].Default:  [&lt;&lt;”guest”&gt;&gt;]</td>
</tr>
<tr>
<td>cluster_nodes</td>
<td>当一个节点开始第一次启动时，将它设置为使集群自动发生。元组的第一个元素是节点试图集群到的节点。第二个元素是磁盘或ram，并确定节点类型。 Default: {[], disc}</td>
</tr>
<tr>
<td>server_properties</td>
<td>键值对的列表，在连接上向客户端宣布。 Default: []</td>
</tr>
<tr>
<td>collect_statistics</td>
<td>统计数据收集模式。主要与管理插件有关。选项有: none (不要发布统计数据)coarse (发出每个队列/每个通道/每个连接统计信息)fine (发出的每条数据)通常情况下不需要设置该参数 Default: none</td>
</tr>
<tr>
<td>collect_statistics_interval</td>
<td>统计数据收集间隔以毫秒为间隔。 主要相关插件 <a href="http://www.rabbitmq.com/management.html#statistics-interval" target="_blank" rel="noopener">management plugin</a>.Default: 5000</td>
</tr>
<tr>
<td>management_db_cache_multiplier</td>
<td>管理插件将缓存诸如队列清单之类的代价较高的查询的时间。缓存将把最后一个查询的运行时间乘以这个值，并在此时间内缓存结果。 Default: 5</td>
</tr>
<tr>
<td>auth_mechanisms</td>
<td><a href="http://www.rabbitmq.com/authentication.html" target="_blank" rel="noopener">SASL authentication mechanisms</a> to offer to clients.Default: [‘PLAIN’, ‘AMQPLAIN’]</td>
</tr>
<tr>
<td>auth_backends</td>
<td>List of <a href="http://www.rabbitmq.com/access-control.html" target="_blank" rel="noopener">authentication and authorisation backends</a> to use.Other databases than rabbit_auth_backend_internalare available through <a href="http://www.rabbitmq.com/plugins.html" target="_blank" rel="noopener">plugins</a>.Default: [rabbit_auth_backend_internal]</td>
</tr>
<tr>
<td>reverse_dns_lookups</td>
<td>设置为true，让RabbitMQ对客户端连接执行反向DNS查找，并通过rabbitmqctl和管理插件呈现该信息。 Default: false</td>
</tr>
<tr>
<td>delegate_count</td>
<td>用于集群内部通信的委托进程的数量。当为多核CPU时可以考虑设置该值 Default: 16</td>
</tr>
<tr>
<td>trace_vhosts</td>
<td>Used internally by the <a href="http://www.rabbitmq.com/firehose.html" target="_blank" rel="noopener">tracer</a>. 通常情况下不需要设置该参数Default: []</td>
</tr>
<tr>
<td>tcp_listen_options</td>
<td>默认的套接字选项。通常情况下不需要设置该参数 Default:<code>[{backlog,       128},  {nodelay,       true},  {linger,        {true,0}},  {exit_on_close, false}]</code></td>
</tr>
<tr>
<td>hipe_compile</td>
<td>设置为true，使用HiPE预编译RabbitMQ的部分，这是Erlang的即时编译器。这将增加服务器的吞吐量，以增加启动时间的成本。 您可能会看到，在启动时延迟几分钟，您的性能会提高20-50%。这些数据是高度工作负载和硬件依赖的。HiPE支持可能不会编译到您的Erlang安装中。如果不是这样，启用这个选项只会导致一个警告消息被显示，而启动将照常进行。例如，Debian/Ubuntu用户需要安装erlangbase-base-hipe包。HiPE在某些平台上是不可用的，尤其是Windows。HiPE在17.5之前就已经知道了erlangp/otp版本的问题。HiPE推荐使用最新的erlangp/otp版本Default: false</td>
</tr>
<tr>
<td>cluster_partition_handling</td>
<td>如何处理网络分区。可用模式:  ignorepause_minority{pause_if_all_down, [nodes], ignore \</td>
<td>autoheal} (例: [‘rabbit@node1’, ‘rabbit@node2’])autoheal详情请看<a href="http://www.rabbitmq.com/partitions.html#automatic-handling" target="_blank" rel="noopener">documentation on partitions</a> Default: ignore</td>
</tr>
<tr>
<td>cluster_keepalive_interval</td>
<td>节点应该多频繁地将keepalive消息发送到其他节点(以毫秒为单位)。请注意，这与netticktime不一样; 错过的keepalive消息不会导致节点被认为挂机。 Default: 10000</td>
</tr>
<tr>
<td>queue_index_embed_msgs_below</td>
<td>在消息的字节数中，消息将被直接嵌入到队列索引中。详情请看 <a href="http://www.rabbitmq.com/persistence-conf.html" target="_blank" rel="noopener">persister tuning</a> Default: 4096</td>
</tr>
<tr>
<td>msg_store_index_module</td>
<td>用于队列索引的实现模块。 详情请看 <a href="http://www.rabbitmq.com/persistence-conf.html" target="_blank" rel="noopener">persister tuning</a> Default: rabbit_msg_store_ets_index</td>
</tr>
<tr>
<td>backing_queue_module</td>
<td>队列内容的实现模块。通常情况下不需要设置该参数 Default: rabbit_variable_queue</td>
</tr>
<tr>
<td>msg_store_file_size_limit</td>
<td>Tunable value for the persister.  通常情况下不需要设置该参数Default: 16777216</td>
</tr>
<tr>
<td>mnesia_table_loading_retry_limit</td>
<td>在等待集群中的Mnesia tables可用时，需要重试的次数。 Default: 10</td>
</tr>
<tr>
<td>mnesia_table_loading_retry_timeout</td>
<td>在集群中等待每个重试的时间，以便可用 Default: 30000</td>
</tr>
<tr>
<td>queue_index_max_ journal_entries</td>
<td>Tunable value for the persister.  通常情况下不需要设置该参数Default: 65536</td>
</tr>
<tr>
<td>queue_master_locator</td>
<td>Queue master定位策略可用策略:&lt;&lt;”min-masters”&gt;&gt;&lt;&lt;”client-local”&gt;&gt;&lt;&lt;”random”&gt;&gt;详情请看 <a href="http://www.rabbitmq.com/ha.html#queue-master-location" target="_blank" rel="noopener">documentation on queue master location</a> Default: &lt;&lt;”client-local”&gt;&gt;</td>
</tr>
<tr>
<td>lazy_queue_explicit_gc_run_operation_threshold</td>
<td>调优： 只有在内存压力下有延迟队列时。　　　 这是触发垃圾收集器和其他内存减少活动的阈值。一个低的值可以降低性能，一个高的值可以提高性能，但是会导致更高的内存消耗。通常情况下不需要设置该参数Default: 1000</td>
</tr>
<tr>
<td>queue_explicit_gc_run_operation_threshold</td>
<td>调优： 在内存压力较大时。这是触发垃圾收集器和其他内存减少活动的阈值。一个低的值可以降低性能，一个高的值可以提高性能，但是会导致更高的内存消耗。通常情况下不需要设置该参数Default: 1000</td>
</tr>
</tbody>
</table>
<h5 id="配置条目加密"><a href="#配置条目加密" class="headerlink" title="配置条目加密"></a><strong>配置条目加密</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 可以在RabbitMQ配置文件中加密敏感配置条目（例如密码，包含URL的凭据）。代理在开始时解密加密的条目.请注意，加密配置条目不会使系统有意义地更安全。然而，它们允许RabbitMQ的部署符合各国的规定，要求在配置文件中不应以纯文本形式显示敏感数据。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加密值必须在Erlang加密元组内：&#123;encrypted，...&#125;。以下是默认用户加密密码的配置</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;rabbit, [</span><br><span class="line">  &#123;default_user, &lt;&lt;"guest"&gt;&gt;&#125;,</span><br><span class="line">  &#123;default_pass,</span><br><span class="line">&#123;encrypted,</span><br><span class="line"> &lt;&lt;"cPAymwqmMnbPXXRVqVzpxJdrS8mHEKuo2V+3vt1u/fymexD9oztQ2G/oJ4PAaSb2c5N/hRJ2aqP/X0VAfx8xOQ=="&gt;&gt;</span><br><span class="line">&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;config_entry_decoder, [</span><br><span class="line"> &#123;passphrase, &lt;&lt;"mypassphrase"&gt;&gt;&#125;</span><br><span class="line"> ]&#125;</span><br><span class="line">]&#125;</span><br><span class="line">].</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意configentrydecoder密钥与RabbitMQ用于解密加密值的密码。密码短语不需要在配置文件中进行硬编码，它可以在一个单独的文件中。</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;rabbit, [</span><br><span class="line">  ...</span><br><span class="line">  &#123;config_entry_decoder, [</span><br><span class="line"> &#123;passphrase, &#123;file, "/path/to/passphrase/file"&#125;&#125;</span><br><span class="line"> ]&#125;</span><br><span class="line">]&#125;</span><br><span class="line">].</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当使用&#123;passphrase，prompt&#125;启动时，RabbitMQ也可以要求操作者输入密码</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用rabbitmqctl和encode命令加密值</span></span><br><span class="line"></span><br><span class="line">rabbitmqctl encode '&lt;&lt;"guest"&gt;&gt;' mypassphrase</span><br><span class="line">&#123;encrypted,&lt;&lt;"... long encrypted value..."&gt;&gt;&#125;</span><br><span class="line">rabbitmqctl encode '"amqp://fred:secret@host1.domain/my_vhost"' mypassphrase</span><br><span class="line">&#123;encrypted,&lt;&lt;"... long encrypted value..."&gt;&gt;&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果要解密值，请添加--decode选项</span></span><br><span class="line"></span><br><span class="line">rabbitmqctl encode --decode '&#123;encrypted, &lt;&lt;"..."&gt;&gt;&#125;' mypassphrase</span><br><span class="line">&lt;&lt;"guest"&gt;&gt;</span><br><span class="line">rabbitmqctl encode --decode '&#123;encrypted, &lt;&lt;"..."&gt;&gt;&#125;' mypassphrase</span><br><span class="line">"amqp://fred:secret@host1.domain/my_vhost"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以对不同类型的值进行编码。上面的例子编码了二进制文件（&lt;&lt;“guest”&gt;&gt;）和字符串（“amqp：// fred：secret@host1.domain/my_vhost”）。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加密机制使用PBKDF2从密码短语中产生派生密钥。默认散列函数为SHA512，默认迭代次数为1000.默认密码为AES 256 CBC</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 您可以在配置文件中更改这些默认值：</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;rabbit, [</span><br><span class="line">  ...</span><br><span class="line">  &#123;config_entry_decoder, [</span><br><span class="line"> &#123;passphrase, "mypassphrase"&#125;,</span><br><span class="line"> &#123;cipher, blowfish_cfb64&#125;,</span><br><span class="line"> &#123;hash, sha256&#125;,</span><br><span class="line"> &#123;iterations, 10000&#125;</span><br><span class="line"> ]&#125;</span><br><span class="line">]&#125;</span><br><span class="line">].    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在命令行：</span></span><br><span class="line"></span><br><span class="line">rabbitmqctl encode --cipher blowfish_cfb64 --hash sha256 --iterations 10000 \</span><br><span class="line"> '&lt;&lt;"guest"&gt;&gt;' mypassphrase</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/19/RabbitMQ概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/19/RabbitMQ概念/" itemprop="url">
                  RabbitMQ概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-19 09:19:07" itemprop="dateCreated datePublished" datetime="2018-10-19T09:19:07+08:00">2018-10-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-30 11:11:37" itemprop="dateModified" datetime="2019-01-30T11:11:37+08:00">2019-01-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/消息队列/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="转：干货：这也许是最全面透彻的一篇RabbitMQ指南！"><a href="#转：干货：这也许是最全面透彻的一篇RabbitMQ指南！" class="headerlink" title="转：干货：这也许是最全面透彻的一篇RabbitMQ指南！"></a>转：干货：这也许是最全面透彻的一篇RabbitMQ指南！</h2><p>原文地址：<a href="https://www.cnblogs.com/zhangxiaoliu/p/7524846.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhangxiaoliu/p/7524846.html</a></p>
<p><strong>本文大纲：</strong></p>
<ol>
<li>RabbitMQ 历史</li>
<li>RabbitMQ 应用场景</li>
<li>RabbitMQ 系统架构</li>
<li>RabbitMQ 基本概念</li>
<li>RabbitMQ 细节阐明</li>
</ol>
<p><strong>历史-从开始到现在</strong></p>
<p>RabbitMQ是一个Erlang开发的AMQP（Advanced Message Queuing Protocol ）的开源实现。AMQP 的出现其实也是应了广大人民群众的需求，虽然在同步消息通讯的世界里有很多公开标准（如 Cobar）的 IIOP ，或者是 SOAP 等），但是在异步消息处理中却不是这样，只有大企业有一些商业实现（如微软的 MSMQ ，IBM 的 WebSphere MQ 等），因此，在 2006 年的 6 月，Cisco 、Red Hat、iMatix 等联合制定了 AMQP 的公开标准。</p>
<p>RabbitMQ由RabbitMQ Technologies Ltd开发并且提供商业支持的。该公司在2010年4月被SpringSource（VMware的一个部门）收购。在2013年5月被并入Pivotal。其实VMware，Pivotal和EMC本质上是一家的。不同的是，VMware是独立上市子公司，而Pivotal是整合了EMC的某些资源，现在并没有上市。</p>
<p>RabbitMQ官网：<a href="http://www.rabbitmq.com" target="_blank" rel="noopener">http://www.rabbitmq.com</a></p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>言归正传。RabbitMQ，或者说AMQP解决了什么问题，或者说它的应用场景是什么？</p>
<p>对于一个大型的软件系统来说，它会有很多的组件或者说模块，又或者说子系统。那这些模块又如何通信？这和传统的IPC有很大的区别。传统的IPC很多都是在单一系统上的，模块耦合性很大，不适合扩展（Scalability）。如果使用Socket，那么不同的模块的确可以部署到不同的机器上，但是还是有很多问题需要解决。比如：</p>
<ul>
<li>信息的发送者和接收者如何维持这个连接，如果一方的连接中断，这期间的数据是以什么方式丢失？</li>
<li>如何降低发送者和接收者的耦合度？</li>
<li>如何让Priority高的接收者先接到数据？</li>
<li>如何做到Load Balance？有效均衡接收者的负载？</li>
<li>如何有效的将数据发送到相关的接收者？也就是说将接收者subscribe 不同的数据，如何做有效的filter。</li>
<li>如何做到可扩展，甚至将这个通信模块发到cluster上？</li>
<li>如何保证接收者接收到了完整，正确的数据？</li>
</ul>
<p>AMQP协议解决了以上的问题，而RabbitMQ实现了AMQP。</p>
<h3 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h3><p><img src="/images/rabbitmq/消息模型.jpg" alt=""></p>
<h4 id="RabbitMQ-Server"><a href="#RabbitMQ-Server" class="headerlink" title="RabbitMQ Server"></a><strong>RabbitMQ Server</strong></h4><p>&emsp;&emsp;也叫Broker Server，它不是运送食物的卡车，而是一种传输服务。原话是RabbitMQ isn’t a food truck, it’s a delivery service. 它的角色就是维护一条从Producer到Consumer的路线，保证数据能够按照指定的方式进行传输。虽然这个保证也不是100%的保证，但是对于普通的应用来说这已经足够了。当然对于商业系统来说，可以再做一层数据一致性的guard，就可以彻底保证系统的一致性了。</p>
<h4 id="producer"><a href="#producer" class="headerlink" title="producer"></a>producer</h4><p>&emsp;&emsp;数据的发送方。Create messages and publish (send) them to a Broker Server (RabbitMQ)。一个Message有两个部分：payload（有效载荷）和label（标签）。payload顾名思义就是传输的数据。label是exchange的名字或者说是一个tag，它描述了payload，而且RabbitMQ也是通过这个label来决定把这个Message发给哪个Consumer。AMQP仅仅描述了label，而RabbitMQ决定了如何使用这个label的规则。</p>
<h4 id="consumer"><a href="#consumer" class="headerlink" title="consumer"></a>consumer</h4><p>&emsp;&emsp;数据的接收方。Consumers attach to a Broker Server (RabbitMQ) and subscribe to a queue。把queue比作是一个有名字的邮箱。当有Message到达某个邮箱后，RabbitMQ把它发送给它的某个订阅者即Consumer。当然可能会把同一个Message发送给很多的Consumer。在这个Message中，只有payload，label已经被删掉了。对于Consumer来说，它是不知道谁发送的这个信息的,就是协议本身不支持。如果Producer发送的payload包含了Producer的信息就另当别论了。</p>
<p>对于一个数据从Producer到Consumer的正确传递，还有三个概念需要明确：exchanges, queues and bindings。</p>
<ul>
<li>Exchanges are where producers publish their messages.</li>
<li>Queues are where the messages end up and are received by consumers.</li>
<li>Bindings are how the messages get routed from the exchange to particular queues.</li>
</ul>
<p>还有几个概念是上述图中没有标明的，那就是Connection（连接）和Channel（通道，频道）。</p>
<h4 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h4><p>&emsp;&emsp;就是一个TCP的连接。Producer和Consumer都是通过TCP连接到RabbitMQ Server的。</p>
<h4 id="Connection-Factory"><a href="#Connection-Factory" class="headerlink" title="Connection Factory"></a>Connection Factory</h4><p>&emsp;&emsp;连接管理器。应用程序与Rabbit之间建立连接的管理器，程序代码中使用；</p>
<h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h4><p>&emsp;&emsp;信道。消息推送使用的通道。虚拟连接。它建立在上述的TCP连接中。数据流动都是在Channel中进行的。也就是说，一般情况是程序起始建立TCP连接，第二步就是建立这个Channel。因为对于系统来说，建立和关闭TCP连接是有代价的，频繁的建立关闭TCP连接对于系统的性能有很大的影响，而且TCP的连接数也有限制，这也限制了系统处理高并发的能力。但是，在TCP连接中建立Channel是没有上述代价的。对于Producer或者Consumer来说，可以并发的使用多个Channel进行Publish或者Receive。有实验表明，1s的数据可以Publish10K的数据包。当然对于不同的硬件环境，不同的数据包大小这个数据肯定不一样，但是我只想说明，对于普通的Consumer或者Producer来说，这已经足够了。如果不够用，你考虑的应该是如何细化SPLIT你的设计。</p>
<h4 id="相关定义"><a href="#相关定义" class="headerlink" title="相关定义"></a>相关定义</h4><ul>
<li>Broker： 简单来说就是消息队列服务器实体</li>
<li>Exchange： 消息交换机，它指定消息按什么规则，路由到哪个队列</li>
<li>Queue： 消息队列载体，每个消息都会被投入到一个或多个队列</li>
<li>Binding： 绑定，它的作用就是把exchange和queue按照路由规则绑定起来</li>
<li>Routing Key： 路由关键字，exchange根据这个关键字进行消息投递</li>
<li>VHost： 虚拟主机，一个broker里可以开设多个vhost，用作不同用户的权限分离。</li>
<li>Producer： 消息生产者，就是投递消息的程序</li>
<li>Consumer： 消息消费者，就是接受消息的程序</li>
<li>Channel： 消息通道，在客户端的每个连接里，可建立多个channel，每个channel代表一个会话任务</li>
</ul>
<p>由Exchange、Queue、RoutingKey三个才能决定一个从Exchange到Queue的唯一的线路。</p>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>&emsp;&emsp;Connection Factory（连接管理器）、Connection、Channel（信道）都是RabbitMQ对外提供的API中最基本的对象。Connection是RabbitMQ的socket链接，它封装了socket协议相关部分逻辑。Connection Factory则是Connection的制造工厂。Channel是我们与RabbitMQ打交道的最重要的一个接口，我们大部分的业务操作是在Channel这个接口中完成的，包括定义Queue、定义Exchange、绑定Queue与Exchange、发布消息等。</p>
<h4 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h4><p>&emsp;&emsp;Queue（队列）是RabbitMQ的内部对象，用于存储消息，用下图表示。</p>
<p><img src="/images/rabbitmq/queue.jpg" alt=""></p>
<p>&emsp;&emsp;RabbitMQ中的消息都只能存储在Queue中，生产者（下图中的P）生产消息并最终投递到Queue中，消费者（下图中的C）可以从Queue中获取消息并消费。</p>
<p><img src="/images/rabbitmq/queue1.jpg" alt=""></p>
<p>&emsp;&emsp;多个消费者可以订阅同一个Queue，这时Queue中的消息会被平均分摊给多个消费者进行处理，而不是每个消费者都收到所有的消息并处理。</p>
<p><img src="/images/rabbitmq/queue2.jpg" alt=""></p>
<h4 id="Message-acknowledgment"><a href="#Message-acknowledgment" class="headerlink" title="Message acknowledgment"></a>Message acknowledgment</h4><p>&emsp;&emsp;在实际应用中，可能会发生消费者收到Queue中的消息，但没有处理完成就宕机（或出现其他意外）的情况，这种情况下就可能会导致消息丢失。为了避免这种情况发生，我们可以要求消费者在消费完消息后发送一个回执给RabbitMQ，RabbitMQ收到消息回执（Message acknowledgment）后才将该消息从Queue中移除。</p>
<p>&emsp;&emsp;如果RabbitMQ没有收到回执并检测到消费者的RabbitMQ连接断开，则RabbitMQ会将该消息发送给其他消费者（如果存在多个消费者）进行处理。这里不存在timeout，一个消费者处理消息时间再长也不会导致该消息被发送给其他消费者，除非它的RabbitMQ连接断开。</p>
<p>&emsp;&emsp;这里会产生另外一个问题，如果我们的开发人员在处理完业务逻辑后，忘记发送回执给RabbitMQ，这将会导致严重的bug——Queue中堆积的消息会越来越多。消费者重启后会重复消费这些消息并重复执行业务逻辑。</p>
<p>&emsp;&emsp;另外publish message 是没有ACK的。</p>
<h4 id="Message-durability"><a href="#Message-durability" class="headerlink" title="Message durability"></a>Message durability</h4><p>&emsp;&emsp;如果我们希望即使在RabbitMQ服务重启的情况下，也不会丢失消息，我们可以将Queue与Message都设置为可持久化的（durable），这样可以保证绝大部分情况下我们的RabbitMQ消息不会丢失。但依然解决不了小概率丢失事件的发生（比如RabbitMQ服务器已经接收到生产者的消息，但还没来得及持久化该消息时RabbitMQ服务器就断电了），如果我们需要对这种小概率事件也要管理起来，那么我们要用到事务。</p>
<h4 id="Prefetch-count"><a href="#Prefetch-count" class="headerlink" title="Prefetch count"></a><strong>Prefetch count</strong></h4><p>&emsp;&emsp;前面我们讲到如果有多个消费者同时订阅同一个Queue中的消息，Queue中的消息会被平摊给多个消费者。这时如果每个消息的处理时间不同，就有可能会导致某些消费者一直在忙，而另外一些消费者很快就处理完手头工作并一直空闲的情况。我们可以通过设置Prefetch count来限制Queue每次发送给每个消费者的消息数，比如我们设置prefetchCount=1，则Queue每次给每个消费者发送一条消息；消费者处理完这条消息后Queue会再给该消费者发送一条消息。</p>
<p><img src="/images/rabbitmq/prefetchcount.jpg" alt=""></p>
<h4 id="Exchange"><a href="#Exchange" class="headerlink" title="Exchange"></a><strong>Exchange</strong></h4><p>&emsp;&emsp;生产者将消息投递到Queue中，实际上这在RabbitMQ中这种事情永远都不会发生。实际的情况是，生产者将消息发送到Exchange（交换器，下图中的X），由Exchange将消息路由到一个或多个Queue中（或者丢弃）。</p>
<p><img src="/images/rabbitmq/exchange.jpg" alt=""></p>
<h4 id="Routing-Key"><a href="#Routing-Key" class="headerlink" title="Routing Key"></a><strong>Routing Key</strong></h4><p>&emsp;&emsp;生产者在将消息发送给Exchange的时候，一般会指定一个Routing Key，来指定这个消息的路由规则，而这个Routing Key需要与Exchange Type及Binding key联合使用才能最终生效。</p>
<p>&emsp;&emsp;在Exchange Type与Binding key固定的情况下（在正常使用时一般这些内容都是固定配置好的），我们的生产者就可以在发送消息给Exchange时，通过指定Routing Key来决定消息流向哪里。</p>
<p>&emsp;&emsp;RabbitMQ为Routing Key设定的长度限制为255 bytes。</p>
<h4 id="Binding"><a href="#Binding" class="headerlink" title="Binding"></a><strong>Binding</strong></h4><p>&emsp;&emsp;RabbitMQ中通过Binding将Exchange与Queue关联起来，这样RabbitMQ就知道如何正确地将消息路由到指定的Queue了。</p>
<p><img src="/images/rabbitmq/binding.jpg" alt=""></p>
<h4 id="Binding-key"><a href="#Binding-key" class="headerlink" title="Binding key"></a><strong>Binding key</strong></h4><p>&emsp;&emsp;在绑定（Binding）Exchange与Queue的同时，一般会指定一个Binding key。消费者将消息发送给Exchange时，一般会指定一个Routing Key。当Binding key与Routing Key相匹配时，消息将会被路由到对应的Queue中。</p>
<p>&emsp;&emsp;在绑定多个Queue到同一个Exchange的时候，这些Binding允许使用相同的Binding key。</p>
<p>&emsp;&emsp;Binding key并不是在所有情况下都生效，它依赖于Exchange Type，比如fanout类型的Exchange就会无视Binding key，而是将消息路由到所有绑定到该Exchange的Queue。</p>
<h4 id="Exchange-Types"><a href="#Exchange-Types" class="headerlink" title="Exchange Types"></a><strong>Exchange Types</strong></h4><p>&emsp;&emsp;RabbitMQ常用的Exchange Type有fanout、direct、topic、headers这四种（AMQP规范里还提到两种Exchange Type，分别为system与自定义，这里不予以描述），下面分别进行介绍。</p>
<h5 id="fanout"><a href="#fanout" class="headerlink" title="fanout"></a><strong>fanout</strong></h5><p>&emsp;&emsp;fanout类型的Exchange路由规则非常简单，它会把所有发送到该Exchange的消息路由到所有与它绑定的Queue中。</p>
<p><img src="/images/rabbitmq/fanout.jpg" alt=""></p>
<p>&emsp;&emsp;上图中，生产者（P）发送到Exchange（X）的所有消息都会路由到图中的两个Queue，并最终被两个消费者（C1与C2）消费。</p>
<h5 id="direct"><a href="#direct" class="headerlink" title="direct"></a><strong>direct</strong></h5><p>&emsp;&emsp;direct类型的Exchange路由规则也很简单，它会把消息路由到那些Binding key与Routing key完全匹配的Queue中。</p>
<p><img src="/images/rabbitmq/direct.jpg" alt=""></p>
<p>&emsp;&emsp;以上图的配置为例，我们以routingKey=”error”发送消息到Exchange，则消息会路由到Queue1（amqp.gen-S9b…，这是由RabbitMQ自动生成的Queue名称）和Queue2（amqp.gen-Agl…）；如果我们以Routing Key=”info”或routingKey=”warning”来发送消息，则消息只会路由到Queue2。如果我们以其他Routing Key发送消息，则消息不会路由到这两个Queue中。</p>
<h5 id="topic"><a href="#topic" class="headerlink" title="topic"></a><strong>topic</strong></h5><p>&emsp;&emsp;前面讲到direct类型的Exchange路由规则是完全匹配Binding Key与Routing Key，但这种严格的匹配方式在很多情况下不能满足实际业务需求。topic类型的Exchange在匹配规则上进行了扩展，它与direct类型的Exchage相似，也是将消息路由到Binding Key与Routing Key相匹配的Queue中，但这里的匹配规则有些不同，它约定：Routing Key为一个句点号“.”分隔的字符串（我们将被句点号”. “分隔开的每一段独立的字符串称为一个单词），如”stock.usd.nyse”、”nyse.vmw”、”quick.orange.rabbit”。Binding Key与Routing Key一样也是句点号“. ”分隔的字符串。</p>
<p>&emsp;&emsp;Binding Key中可以存在两种特殊字符”*“与”#”，用于做模糊匹配，其中”*“用于匹配一个单词，”#”用于匹配多个单词（可以是零个）。</p>
<p><img src="/images/rabbitmq/topic.jpg" alt=""></p>
<p>&emsp;&emsp;以上图中的配置为例，routingKey=”quick.orange.rabbit”的消息会同时路由到Q1与Q2，routingKey=”lazy.orange.fox”的消息会路由到Q1，routingKey=”lazy.brown.fox”的消息会路由到Q2，routingKey=”lazy.pink.rabbit”的消息会路由到Q2（只会投递给Q2一次，虽然这个routingKey与Q2的两个bindingKey都匹配）；routingKey=”quick.brown.fox”、routingKey=”orange”、routingKey=”quick.orange.male.rabbit”的消息将会被丢弃，因为它们没有匹配任何bindingKey。</p>
<h5 id="headers"><a href="#headers" class="headerlink" title="headers"></a><strong>headers</strong></h5><p>&emsp;&emsp;headers类型的Exchange不依赖于Routing Key与Binding Key的匹配规则来路由消息，而是根据发送的消息内容中的headers属性进行匹配。</p>
<p>&emsp;&emsp;在绑定Queue与Exchange时指定一组键值对；当消息发送到Exchange时，RabbitMQ会取到该消息的headers（也是一个键值对的形式），对比其中的键值对是否完全匹配Queue与Exchange绑定时指定的键值对。如果完全匹配则消息会路由到该Queue，否则不会路由到该Queue。</p>
<h4 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a><strong>RPC</strong></h4><p>&emsp;&emsp;MQ本身是基于异步的消息处理，前面的示例中所有的生产者（P）将消息发送到RabbitMQ后不会知道消费者（C）处理成功或者失败（甚至连有没有消费者来处理这条消息都不知道）。但实际的应用场景中，我们很可能需要一些同步处理，需要同步等待服务端将我的消息处理完成后再进行下一步处理。这相当于RPC（Remote Procedure Call，远程过程调用）。在RabbitMQ中也支持RPC。</p>
<p><img src="/images/rabbitmq/rpc.jpg" alt=""></p>
<p>&emsp;&emsp;<strong>RabbitMQ中实现RPC的机制是：</strong>客户端发送请求（消息）时，在消息的属性（Message Properties，在AMQP协议中定义了14种properties，这些属性会随着消息一起发送）中设置两个值replyTo（一个Queue名称，用于告诉服务器处理完成后将通知我的消息发送到这个Queue中）和correlationId（此次请求的标识号，服务器处理完成后需要将此属性返还，客户端将根据这个id了解哪条请求被成功执行了或执行失败）。服务器端收到消息处理完后，将生成一条应答消息到replyTo指定的Queue，同时带上correlationId属性。客户端之前已订阅replyTo指定的Queue，从中收到服务器的应答消息后，根据其中的correlationId属性分析哪条请求被执行了，根据执行结果进行后续业务处理。</p>
<h4 id="使用ACK确认Message的正确传递"><a href="#使用ACK确认Message的正确传递" class="headerlink" title="使用ACK确认Message的正确传递"></a><strong>使用ACK确认Message的正确传递</strong></h4><p>&emsp;&emsp;默认情况下，如果Message 已经被某个Consumer正确的接收到了，那么该Message就会被从Queue中移除。当然也可以让同一个Message发送到很多的Consumer。</p>
<p>&emsp;&emsp;如果一个Queue没被任何的Consumer Subscribe（订阅），当有数据到达时，这个数据会被cache，不会被丢弃。当有Consumer时，这个数据会被立即发送到这个Consumer。这个数据被Consumer正确收到时，这个数据就被从Queue中删除。</p>
<p>&emsp;&emsp;那么什么是正确收到呢？通过ACK。每个Message都要被acknowledged（确认，ACK）。我们可以显式的在程序中去ACK，也可以自动的ACK。如果有数据没有被ACK，那么RabbitMQ Server会把这个信息发送到下一个Consumer。</p>
<p>&emsp;&emsp;如果这个APP有bug，忘记了ACK，那么RabbitMQ Server不会再发送数据给它，因为Server认为这个Consumer处理能力有限。而且ACK的机制可以起到限流的作用（Benefitto throttling）：在Consumer处理完成数据后发送ACK，甚至在额外的延时后发送ACK，将有效的balance Consumer的load。</p>
<p>&emsp;&emsp;当然对于实际的例子，比如我们可能会对某些数据进行merge，比如merge 4s内的数据，然后sleep 4s后再获取数据。特别是在监听系统的state，我们不希望所有的state实时的传递上去，而是希望有一定的延时。这样可以减少某些IO，而且终端用户也不会感觉到。</p>
<h4 id="Reject-a-message"><a href="#Reject-a-message" class="headerlink" title="Reject a message"></a><strong>Reject a message</strong></h4><p>&emsp;&emsp;有两种方式，第一种的Reject可以让RabbitMQ Server将该Message 发送到下一个Consumer。第二种是从Queue中立即删除该Message。</p>
<h4 id="Creating-a-queue"><a href="#Creating-a-queue" class="headerlink" title="Creating a queue"></a><strong>Creating a queue</strong></h4><p>&emsp;&emsp;Consumer和Procuder都可以通过 queue.declare 创建queue。对于某个Channel来说，Consumer不能declare一个queue，却订阅其他的queue。当然也可以创建私有的queue。这样只有APP本身才可以使用这个queue。queue也可以自动删除，被标为auto-delete的queue在最后一个Consumer unsubscribe后就会被自动删除。那么如果是创建一个已经存在的queue呢？那么不会有任何的影响。需要注意的是没有任何的影响，也就是说第二次创建如果参数和第一次不一样，那么该操作虽然成功，但是queue的属性并不会被修改。</p>
<p>&emsp;&emsp;那么谁应该负责创建这个queue呢？是Consumer，还是Producer？</p>
<p>&emsp;&emsp;如果queue不存在，当然Consumer不会得到任何的Message。那么Producer Publish的Message会被丢弃。所以，还是为了数据不丢失，Consumer和Producer都try to create the queue！反正不管怎么样，这个接口都不会出问题。</p>
<p>&emsp;&emsp;queue对load balance的处理是完美的。对于多个Consumer来说，RabbitMQ 使用循环的方式（round-robin）均衡地发送给不同的Consumer。</p>
<h4 id="Exchanges"><a href="#Exchanges" class="headerlink" title="Exchanges"></a><strong>Exchanges</strong></h4><p>&emsp;&emsp;从架构图可以看出，Procuder Publish的Message进入了Exchange。接着通过”routing keys”， RabbitMQ会找到应该把这个Message放到哪个queue里。queue也是通过这个routing keys来做的绑定。</p>
<p>&emsp;&emsp;有三种类型的Exchanges：direct, fanout,topic。 每个实现了不同的路由算法（routing algorithm）。</p>
<h4 id="Direct-exchange"><a href="#Direct-exchange" class="headerlink" title="Direct exchange"></a><strong>Direct exchange</strong></h4><p>&emsp;&emsp;如果 routing key 匹配，那么Message就会被传递到相应的queue中。其实在queue创建时，它会自动的以queue的名字作为routing key来绑定那个exchange。</p>
<h4 id="Fanout-exchange"><a href="#Fanout-exchange" class="headerlink" title="Fanout exchange"></a><strong>Fanout exchange</strong></h4><p>&emsp;&emsp;会向响应的queue广播。</p>
<h4 id="Topic-exchange"><a href="#Topic-exchange" class="headerlink" title="Topic exchange"></a><strong>Topic exchange</strong></h4><p>&emsp;&emsp;对key进行模式匹配，比如ab可以传递到所有ab的queue。</p>
<h4 id="Virtual-hosts"><a href="#Virtual-hosts" class="headerlink" title="Virtual hosts"></a><strong>Virtual hosts</strong></h4><p>&emsp;&emsp;每个virtual host本质上都是一个RabbitMQ Server，拥有它自己的queue，exchagne，和bings rule等等。这保证了你可以在多个不同的Application中使用RabbitMQ。</p>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p>acknowledgment[əkˈnɔlidʒmənt]：确认</p>
<p>cache[kæʃ]： 缓存</p>
<p>balance[ˈbæləns]：平衡</p>
<p>merge[mə:dʒ]：合并</p>
<p>unsubscribe[ˌʌnsəbˈskraɪb]：退订</p>
<p>declare[diˈklɛə]：声明</p>
<p>Publish[ˈpʌbliʃ]：发布</p>
<p>exchange[iksˈtʃeindʒ]：交换</p>
<p>fanout[fænaʊt]：分列（帐户）</p>
<p>derect[diˈrekt]：直接</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/18/RabbitMQ部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/18/RabbitMQ部署/" itemprop="url">
                  RabbitMQ部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-18 14:52:42" itemprop="dateCreated datePublished" datetime="2018-10-18T14:52:42+08:00">2018-10-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-03-05 18:28:23" itemprop="dateModified" datetime="2019-03-05T18:28:23+08:00">2019-03-05</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/消息队列/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><blockquote>
<p>RabbitMQ是一个开源的AMQP实现，服务器端用Erlang语言编写，支持多种客户端，如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等，支持AJAX。用于在分布式系统中存储转发消息，在易用性、扩展性、高可用性等方面表现不俗。</p>
<p>AMQP，即Advanced message Queuing Protocol，高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。消息中间件主要用于组件之间的解耦，消息的发送者无需知道消息使用者的存在，反之亦然。</p>
<p>AMQP的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全。</p>
</blockquote>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><blockquote>
<ul>
<li>RabbitMQ Server也称为Broker Server，是一种传输服务。它的角色就是维护一条从Producer（生产者）到Consumer（消费者）的路线，保证数据能够按照指定的方式进行传输。虽然这个保证也不是100%的保证，但是对于普通的应用来说这已经足够了。当然对于商业系统来说，可以再做一层数据一致性的guard，就可以彻底保证系统的一致性了。</li>
<li>producer：数据的发送方。Create messages and publish (send) them to a Broker Server (RabbitMQ)。一个Message有两个部分：payload（有效载荷）和label（标签）。payload顾名思义就是传输的数据。label是exchange的名字或者说是一个tag，它描述了payload，而且RabbitMQ也是通过这个label来决定把这个Message发给哪个Consumer。AMQP仅仅描述了label，而RabbitMQ决定了如何使用这个label的规则。</li>
<li>consumer：数据的接收方。Consumers attach to a Broker Server (RabbitMQ) and subscribe to a queue。把queue比作是一个有名字的邮箱。当有Message到达某个邮箱后，RabbitMQ把它发送给它的某个订阅者即Consumer。当然可能会把同一个Message发送给很多的Consumer。在这个Message中，只有payload，label已经被删掉了。对于Consumer来说，它是不知道谁发送的这个信息的,就是协议本身不支持。如果Producer发送的payload包含了Producer的信息就另当别论了。</li>
<li>Connection：就是一个TCP的连接。Producer和Consumer都是通过TCP连接到RabbitMQ Server的。</li>
<li>Connection Factory：连接管理器。应用程序与Rabbit之间建立连接的管理器，程序代码中使用；</li>
<li>Channel：信道。消息推送使用的通道。虚拟连接。它建立在上述的TCP连接中。数据流动都是在Channel中进行的。也就是说，一般情况是程序起始建立TCP连接，第二步就是建立这个Channel。因为对于系统来说，建立和关闭TCP连接是有代价的，频繁的建立关闭TCP连接对于系统的性能有很大的影响，而且TCP的连接数也有限制，这也限制了系统处理高并发的能力。但是，在TCP连接中建立Channel是没有上述代价的。对于Producer或者Consumer来说，可以并发的使用多个Channel进行Publish或者Receive。</li>
<li>exchanges：消息交换机，它指定消息按什么规则，路由到哪个队列。</li>
<li>Queue：消息队列载体，每个消息都会被投入到一个或多个队列，用于存储生产者的消息。</li>
<li>Binding：绑定是如何将消息从Exchange路由到特定队列的。也就是把exchange和queue按照路由规则绑定起来。</li>
<li>Routing Key：路由关键字，exchange根据这个关键字进行消息投递</li>
<li><strong><em>由Exchange、Queue、RoutingKey三个才能决定一个从Exchange到Queue的唯一的线路。</em></strong></li>
<li>VHost：虚拟主机，一个broker里可以开设多个vhost，用作不同用户的权限分离。</li>
</ul>
</blockquote>
<h4 id="publish消息确认机制"><a href="#publish消息确认机制" class="headerlink" title="publish消息确认机制"></a>publish消息确认机制</h4><blockquote>
<p> 如果采用标准的 AMQP 协议，则唯一能够保证消息不会丢失的方式是利用事务机制 — 令 channel 处于 transactional 模式、向其 publish 消息、执行 commit 动作。在这种方式下，事务机制会带来大量的多余开销，并会导致吞吐量下降 250% 。为了补救事务带来的问题，引入了 confirmation 机制（即 Publisher Confirm）。</p>
<p>confirm 机制是在channel上使用 confirm.select方法，处于 transactional 模式的 channel 不能再被设置成 confirm 模式，反之亦然。</p>
<p>在 channel 被设置成 confirm 模式之后，所有被 publish 的后续消息都将被 confirm（即 ack） 或者被 nack 一次。但是没有对消息被 confirm 的快慢做任何保证，并且同一条消息不会既被 confirm 又被 nack 。</p>
<p>RabbitMQ 将在下面的情况中对消息进行 confirm ：</p>
<ol>
<li>RabbitMQ发现当前消息无法被路由到指定的 queues 中；</li>
<li>非持久属性的消息到达了其所应该到达的所有 queue 中（和镜像 queue 中）；</li>
<li>持久消息到达了其所应该到达的所有 queue 中（和镜像 queue 中），并被持久化到了磁盘（被 fsync）；</li>
<li>持久消息从其所在的所有 queue 中被 consume 了（如果必要则会被 acknowledge）。</li>
</ol>
</blockquote>
<h4 id="consumer消息确认机制"><a href="#consumer消息确认机制" class="headerlink" title="consumer消息确认机制"></a>consumer消息确认机制</h4><blockquote>
<p>为了保证数据不被丢失，RabbitMQ支持消息确认机制，即acknowledgments。</p>
<p>如果没启动消息确认机制，RabbitMQ在consumer收到消息后就会把消息删除。</p>
<p>启用消息确认后，consumer在处理数据后应通过回调函数显示发送ack， RabbitMQ收到ack后才会删掉数据。如果consumer一段时间内不回馈，RabbitMQ会将该消息重新分配给另外一个绑定在该队列上的consumer。另一种情况是consumer断开连接，但是获取到的消息没有回馈，则RabbitMQ同样重新分配。</p>
<p>注意：如果consumer 没调用basic.qos 方法设置prefetch_count=1，那即使该consumer有未ack的messages，RabbitMQ仍会继续发messages给它。</p>
</blockquote>
<h4 id="消息持久化"><a href="#消息持久化" class="headerlink" title="消息持久化"></a>消息持久化</h4><blockquote>
<p>消息确认机制确保了consumer退出时消息不会丢失，但如果是RabbitMQ本身因故障退出，消息还是会丢失。为了保证在RabbitMQ出现意外情况时数据仍没有丢失，需要将queue和message都要持久化。</p>
<p>queue持久化：channel.queue_declare(queue=’hello’, durable=True)</p>
<p>message持久化：channel.basic_publish(exchange=”,</p>
<p>routing_key=”task_queue”,</p>
<p>body=message,</p>
<p>properties=pika.BasicProperties(</p>
<p>delivery_mode = 2,)  #消息持久化</p>
<p>)</p>
<p>即使有消息持久化，数据也有可能丢失，因为rabbitmq是先将数据缓存起来，到一定条件才保存到硬盘上，这期间rabbitmq出现意外数据有可能丢失。</p>
<p>网上有测试表明：持久化会对RabbitMQ的性能造成比较大的影响，可能会下降10倍不止。</p>
</blockquote>
<h4 id="RABBITMQ集群基本概念"><a href="#RABBITMQ集群基本概念" class="headerlink" title="RABBITMQ集群基本概念"></a>RABBITMQ集群基本概念</h4><blockquote>
<p>一个RABBITMQ集群中可以共享user，virtualhosts，queues（开启Highly Available Queues），exchanges等。但message只会在创建的节点上传输。当message进入A节点的queue中后，consumer从B节点拉取时，RabbitMQ会临时在A、B间进行消息传输，把A中的消息实体取出并经过B发送给consumer。所以consumer应尽量连接每一个节点，从中取消息。</p>
<p>RABBITMQ的集群节点包括内存节点、磁盘节点。内存节点的元数据仅放在内存中，性能比磁盘节点会有所提升。不过，如果在投递message时，打开了message的持久化，那么内存节点的性能只能体现在资源管理上，比如增加或删除队列（queue），虚拟主机（vrtual hosts），交换机（exchange）等，发送和接受message速度同磁盘节点一样。<font color="green">一个集群至少要有一个磁盘节点。</font></p>
</blockquote>
<h4 id="镜像队列概念"><a href="#镜像队列概念" class="headerlink" title="镜像队列概念"></a><strong>镜像队列概念</strong></h4><blockquote>
<p>镜像队列可以同步queue和message，当主queue挂掉，从queue中会有一个变为主queue来接替工作。</p>
<p>镜像队列是基于普通的集群模式的,所以你还是得先配置普通集群,然后才能设置镜像队列。</p>
<p>镜像队列设置后，会分一个主节点和多个从节点，如果主节点宕机，从节点会有一个选为主节点，原先的主节点起来后会变为从节点。</p>
<p>queue和message虽然会存在所有镜像队列中，但客户端读取时不论物理机连接的主节点还是从节点，都是从主节点读取数据，然后主节点再将queue和message的状态同步给从节点，因此多个客户端连接不同的镜像队列不会产生同一message被多次接受的情况。</p>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>下载rpm包<br><a href="http://www.rabbitmq.com/download.html" target="_blank" rel="noopener">http://www.rabbitmq.com/download.html</a></li>
</ul>
<p><img src="/images/rabbitmq/下载页面1.jpg" alt=""></p>
<ul>
<li>分别点击两个箭头指向的页面下载相应包</li>
</ul>
<p><img src="/images/rabbitmq/下载页面2.jpg" alt=""></p>
<ul>
<li>箭头指向为CentOS7中可以安装的erlang的rpm包和rabbitmq的rpm包</li>
</ul>
<p><img src="/images/rabbitmq/下载页面3.jpg" alt=""></p>
<p><img src="/images/rabbitmq/下载页面4.jpg" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum install -y erlang-19.3.6.11-2.el7.centos.x86_64.rpm</span><br><span class="line">yum install -y rabbitmq-server-3.6.16-2.el7.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将两个rpm包上传到服务器并安装</span></span><br><span class="line">vim /etc/rabbitmq/rabbitmq.config</span><br><span class="line">	[&#123;rabbit, [&#123;loopback_users, []&#125;]&#125;].</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装后没有此文件，自已创建此文件并加入上面内容，不要忘记最后的点</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启网页管理页面的插件。如果停用可以使用<span class="built_in">disable</span>参数</span></span><br><span class="line">cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.16/plugins/</span><br><span class="line">wget https://dl.bintray.com/rabbitmq/community-plugins/rabbitmq_delayed_message_exchange-0.0.1.ez</span><br><span class="line"><span class="meta">#</span><span class="bash"> 消息延迟发送给消费者的插件</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br><span class="line">service rabbitmq-server start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果无法启动，可以使用journalctl -xe &gt; /root/abc.txt命令将报错信息重定向到一个文件，并查看。测试中无法启动是因为上面的配置文件写错了，改成上面的样子后启动就没问题了。</span></span><br><span class="line">ss -tlnp</span><br><span class="line"><span class="meta">#</span><span class="bash"> rabbitmq的网页默认监听在15672端口上，服务器监听在5672端口</span></span><br></pre></td></tr></table></figure>
<ul>
<li>访问rabbitmq远程管理页面。默认用户名和密码都是guest</li>
</ul>
<p><img src="/images/rabbitmq/登录1.jpg" alt=""></p>
<p><img src="/images/rabbitmq/登录2.jpg" alt=""></p>
<h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><h4 id="账号级别"><a href="#账号级别" class="headerlink" title="账号级别"></a>账号级别</h4><ul>
<li>超级管理员administrator，可以登录控制台，查看所有信息，可以对用户和策略进行操作</li>
<li>监控者monitoring，可以登录控制台，可以查看节点的相关信息，比如进程数，内存磁盘使用情况</li>
<li>策略制定者policymaker，可以登录控制台，制定策略，但是无法查看节点信息</li>
<li>普通管理员management，仅能登录控制台</li>
<li>其他，无法登录控制台，一般指的是提供者和消费者</li>
</ul>
<h4 id="添加账号"><a href="#添加账号" class="headerlink" title="添加账号"></a>添加账号</h4><h5 id="命令添加"><a href="#命令添加" class="headerlink" title="命令添加"></a>命令添加</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user username password</span><br><span class="line"><span class="meta">#</span><span class="bash">添加用户和密码</span></span><br><span class="line">rabbitmqctl set_user_tags username Account_level</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给用户一个账号级别，如administrator,monitoring等</span></span><br></pre></td></tr></table></figure>
<h5 id="网页添加"><a href="#网页添加" class="headerlink" title="网页添加"></a>网页添加</h5><ul>
<li>添加用户</li>
</ul>
<p><img src="/images/rabbitmq/添加用户1.jpg" alt=""></p>
<ul>
<li>添加后的用户还没有指定可以访问的路径</li>
</ul>
<p><img src="/images/rabbitmq/添加用户2.jpg" alt=""></p>
<ul>
<li>添加虚拟主机</li>
</ul>
<p><img src="/images/rabbitmq/添加虚拟主机1.jpg" alt=""></p>
<ul>
<li>点击/test进入页面，之后指定用户。这相当于建立了一个用户可以访问的库</li>
</ul>
<p><img src="/images/rabbitmq/添加虚拟主机2.jpg" alt=""></p>
<p><img src="/images/rabbitmq/添加虚拟主机3.jpg" alt=""></p>
<p><img src="/images/rabbitmq/添加用户3.jpg" alt=""></p>
<h3 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h3><h4 id="创建并加入集群"><a href="#创建并加入集群" class="headerlink" title="创建并加入集群"></a>创建并加入集群</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">准备三台主机</span><br><span class="line">主机名：rabbitmq1	地址：192.168.1.60</span><br><span class="line">主机名：rabbitmq2	地址：192.168.1.61</span><br><span class="line">主机名：rabbitmq3	地址：192.168.1.62</span><br><span class="line"></span><br><span class="line">注意事项</span><br><span class="line">1. 三台主机互相可以解析主机名，erlang是通过主机名来连接服务，必须保证各个主机名之间可以ping通。</span><br><span class="line">2. 三台主机的cookie文件要一致</span><br><span class="line">3. 如果queue是非持久化queue，则如果创建queue的那个节点失败，发送方和接收方可以创建同样的queue继续运作。但如果是持久化queue，则只能等创建queue的那个节点恢复后才能继续服务。</span><br><span class="line">4. 在集群元数据有变动的时候需要有disk node在线，但是在节点加入或退出的时候所有的disk node必须全部在线。如果没有正确退出disk node，集群会认为这个节点当掉了，在这个节点恢复之前不要加入其它节点。.</span><br><span class="line"></span><br><span class="line">集群创建流程</span><br><span class="line">1. 关闭两个节点的rabbitmq服务</span><br><span class="line">2. 第一个节启动rabbitmq服务，将cookie文件与hosts文件复制到另两个节点</span><br><span class="line">3. 另两个节点将cookie文件的属主属组改为rabbitmq。启动rabbitmq服务，关闭5672端口，加入集群，再启动5672端口</span><br><span class="line">==============================================================================================</span><br><span class="line">------------------------</span><br><span class="line">  rabbitmq2&amp;3</span><br><span class="line">------------------------</span><br><span class="line">[root@rabbitmq1 ~]# ps aux|grep rabbit|awk '&#123;print $2&#125;'|xargs kill -9</span><br><span class="line"><span class="meta">#</span><span class="bash"> 杀掉三台主机上的rabbitmq进程</span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  rabbitmq1</span><br><span class="line">-----------------</span><br><span class="line">[root@rabbitmq1 ~]# systemctl start rabbitmq-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> rabbitmq1上的服务不能关闭</span></span><br><span class="line">[root@rabbitmq1 ~]# scp /var/lib/rabbitmq/.erlang.cookie 192.168.1.61:/var/lib/rabbitmq/ </span><br><span class="line">[root@rabbitmq1 ~]# scp /var/lib/rabbitmq/.erlang.cookie 192.168.1.62:/var/lib/rabbitmq/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将cookie文件传到另两台主机，使三台主机的cookie文件一致</span></span><br><span class="line">[root@rabbitmq1 ~]# vim /etc/hosts</span><br><span class="line">192.168.1.60 rabbitmq1</span><br><span class="line">192.168.1.61 rabbitmq2</span><br><span class="line">192.168.1.62 rabbitmq3</span><br><span class="line">[root@rabbitmq1 ~]# scp /etc/hosts 192.168.1.61:/etc/</span><br><span class="line">[root@rabbitmq1 ~]# scp /etc/hosts 192.168.1.62:/etc/</span><br><span class="line"></span><br><span class="line">------------------------</span><br><span class="line">  rabbitmq2&amp;3</span><br><span class="line">------------------------</span><br><span class="line">[root@rabbitmq3 ~]# chown rabbitmq.rabbitmq /var/lib/rabbitmq/.erlang.cookie</span><br><span class="line"><span class="meta">#</span><span class="bash"> cookie文件的属主属组应该是rabbitmq，启动rabbitmq程序的也是rabbitmq用户</span></span><br><span class="line">[root@rabbitmq2 ~]# systemctl start rabbitmq-server.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动两个节点的rabbitmq服务</span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  rabbitmq1</span><br><span class="line">-----------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面进行加入集群工作</span></span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl cluster_status</span><br><span class="line">Cluster status of node rabbit@rabbitmq1 ...</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@rabbitmq1]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[rabbit@rabbitmq1]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;"rabbit@rabbitmq1"&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[]&#125;]</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在rabbitmq1上查看集群中主机的情况，这时只有一台主机</span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  rabbitmq2</span><br><span class="line">-----------------</span><br><span class="line">[root@rabbitmq2 ~]# rabbitmqctl stop_app</span><br><span class="line">Stopping node rabbit@rabbitmq2 ...</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭应用，也就是关闭了5672端口</span></span><br><span class="line">[root@rabbitmq2 ~]# rabbitmqctl join_cluster rabbit@rabbitmq1</span><br><span class="line">Clustering node rabbit@rabbitmq2 with rabbit@rabbitmq1 ...</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入集群，集群名称rabbit@rabbitmq1是在rabbitmq1上查看集群信息显示的</span></span><br><span class="line">[root@rabbitmq2 ~]# rabbitmqctl start_app</span><br><span class="line">Starting node rabbit@rabbitmq2 ...</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动应用</span></span><br><span class="line">[root@rabbitmq2 ~]#  rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"><span class="meta">#</span><span class="bash"> 两个从节点也一定要启动rabbitmq_management，不然在网页中可以看到两个从节点，但提示<span class="string">"Node statistics not available"</span></span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  rabbitmq3</span><br><span class="line">-----------------</span><br><span class="line">[root@rabbitmq3 ~]# rabbitmqctl stop_app</span><br><span class="line">Stopping node rabbit@rabbitmq3 ...</span><br><span class="line">...done.</span><br><span class="line">[root@rabbitmq3 ~]# rabbitmqctl join_cluster rabbit@rabbitmq1</span><br><span class="line">Clustering node rabbit@rabbitmq3 with rabbit@rabbitmq1 ...</span><br><span class="line">...done.</span><br><span class="line">[root@rabbitmq3 ~]# rabbitmqctl start_app</span><br><span class="line">Starting node rabbit@rabbitmq3 ...</span><br><span class="line">...done.</span><br><span class="line">[root@rabbitmq3 ~]#  rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  rabbitmq1</span><br><span class="line">-----------------</span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl cluster_status</span><br><span class="line">Cluster status of node rabbit@rabbitmq1 ...</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@rabbitmq1,rabbit@rabbitmq2,rabbit@rabbitmq3]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[rabbit@rabbitmq3,rabbit@rabbitmq2,rabbit@rabbitmq1]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;"rabbit@rabbitmq1"&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[]&#125;]</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以看到三台主机在集群中，[&#123;nodes,[&#123;disc,[rabbit@rabbitmq1,rabbit@rabbitmq2,rabbit@rabbitmq3]&#125;]&#125;,中的disc表示三个节点都是磁盘节点，后面是节点的名称。</span></span><br></pre></td></tr></table></figure>
<h4 id="改变存储模式"><a href="#改变存储模式" class="headerlink" title="改变存储模式"></a>改变存储模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">--------------------</span><br><span class="line">  rabbitmq1&amp;2</span><br><span class="line">--------------------</span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl stop_app</span><br><span class="line">Stopping node rabbit@rabbitmq1 ...</span><br><span class="line">...done.</span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl change_cluster_node_type ram</span><br><span class="line">Turning rabbit@rabbitmq1 into a ram node ...</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 改两个节点为内存节点，ram表示内存节点，disc表示磁盘节点</span></span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl start_app</span><br><span class="line">Starting node rabbit@rabbitmq1 ...</span><br><span class="line">...done.</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  rabbitmq1</span><br><span class="line">-----------------</span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl cluster_status</span><br><span class="line">Cluster status of node rabbit@rabbitmq1 ...</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@rabbitmq3]&#125;,&#123;ram,[rabbit@rabbitmq2,rabbit@rabbitmq1]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[rabbit@rabbitmq2,rabbit@rabbitmq3,rabbit@rabbitmq1]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;"rabbit@rabbitmq1"&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[]&#125;]</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以看到节点3为磁盘节点，另外两个为内存节点</span></span><br></pre></td></tr></table></figure>
<h4 id="退出集群"><a href="#退出集群" class="headerlink" title="退出集群"></a>退出集群</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">-----------------</span><br><span class="line">  rabbitmq2</span><br><span class="line">-----------------</span><br><span class="line">[root@rabbitmq2 ~]# rabbitmqctl stop_app</span><br><span class="line">Stopping node rabbit@rabbitmq2 ...</span><br><span class="line">...done.</span><br><span class="line">[root@rabbitmq2 ~]# rabbitmqctl reset</span><br><span class="line">Resetting node rabbit@rabbitmq2 ...</span><br><span class="line">...done.</span><br><span class="line">[root@rabbitmq2 ~]# rabbitmqctl start_app</span><br><span class="line">Starting node rabbit@rabbitmq2 ...</span><br><span class="line">...done.</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  rabbitmq1</span><br><span class="line">-----------------</span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl forget_cluster_node rabbit@rabbitmq2</span><br><span class="line">Removing node rabbit@rabbitmq2 from cluster ...</span><br><span class="line">Error: &#123;not_a_cluster_node,"The node selected is not in the cluster."&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 移除节点时会有一个错误提示：<span class="string">"选定的节点不在群集中。"</span></span></span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl cluster_status                      </span><br><span class="line">Cluster status of node rabbit@rabbitmq1 ...</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@rabbitmq3]&#125;,&#123;ram,[rabbit@rabbitmq1]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[rabbit@rabbitmq3,rabbit@rabbitmq1]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;"rabbit@rabbitmq1"&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[]&#125;]</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再查看已经没有rabbitmq2节点了</span></span><br></pre></td></tr></table></figure>
<h4 id="集群重启"><a href="#集群重启" class="headerlink" title="集群重启"></a>集群重启</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 集群重启时，最后一个挂掉的节点应该第一个重启，如果因特殊原因（比如同时断电），而不知道哪个节点最后一个挂掉。可用以下方法重启：</span></span><br><span class="line"></span><br><span class="line">* 先在一个节点上执行</span><br><span class="line">rabbitmqctl force_boot</span><br><span class="line">service rabbitmq-server start</span><br><span class="line"></span><br><span class="line">* 在其他节点上执行</span><br><span class="line">service rabbitmq-server start</span><br><span class="line"></span><br><span class="line">* 查看cluster状态是否正常（要在所有节点上查询）。</span><br><span class="line">rabbitmqctl cluster_status</span><br><span class="line"></span><br><span class="line"><span class="meta"> #</span><span class="bash"> 如果有节点没加入集群，可以先退出集群，然后再重新加入集群。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上述方法不适合内存节点重启，内存节点重启的时候是会去磁盘节点同步数据，如果磁盘节点没起来，内存节点一直失败。</span></span><br></pre></td></tr></table></figure>
<h4 id="配置镜像队列"><a href="#配置镜像队列" class="headerlink" title="配置镜像队列"></a>配置镜像队列</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">-----------------</span><br><span class="line">  rabbitmq1</span><br><span class="line">-----------------</span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl list_queues</span><br><span class="line">Listing queues ...</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看队列</span></span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl eval 'rabbit_amqqueue:declare(&#123;resource,&lt;&lt;"/"&gt;&gt;,queue,&lt;&lt;"hello"&gt;&gt;&#125;,true,false,[],none).'</span><br><span class="line">&#123;new,&#123;amqqueue,&#123;resource,&lt;&lt;"/"&gt;&gt;,queue,&lt;&lt;"hello"&gt;&gt;&#125;,</span><br><span class="line">               true,false,none,[],&lt;5370.11741.0&gt;,[],[],undefined,[],[]&#125;&#125;</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个叫hello的队列</span></span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl list_queues</span><br><span class="line">Listing queues ...</span><br><span class="line">hello   0</span><br><span class="line">test    0</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 现在可以看到两个队列，<span class="built_in">test</span>队列是在web页面上创建的，相对简单，只要在queues页面中添加一个队列，输入队列名即可完成简单的创建。</span></span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl set_policy ha-all "test" '&#123;"ha-mode":"all"&#125;'    </span><br><span class="line">Setting policy "ha-all" for pattern "test" to "&#123;\"ha-mode\":\"all\"&#125;" with priority "0" ...</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 把名为“<span class="built_in">test</span>”的队列设置为同步给所有节点</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ha-all 是同步模式，指同步给所有节点，还有另外两种模式ha-exactly表示在指定个数的节点上进行镜像，节点的个数由ha-params指定，ha-nodes表示在指定的节点上进行镜像，节点名称通过ha-params指定；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">test</span> 是同步的队列名，可以用正则表达式匹配；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#123;<span class="string">"ha-mode"</span>:<span class="string">"all"</span>&#125; 表示同步给所有，同步模式的不同，此参数也不同。</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/rabbitmq/创建队列.png" alt=""></p>
<blockquote>
<p>执行上面命令后，可以在web管理界面查看queue 页面，里面test队列的node节点后会出现+2标签，表示有2个从节点，而主节点则是当前显示的node。而hello因为没有设置镜像队列，所以没有+2标签。</p>
</blockquote>
<h4 id="创建帐户"><a href="#创建帐户" class="headerlink" title="创建帐户"></a>创建帐户</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">-----------------</span><br><span class="line">  rabbitmq2</span><br><span class="line">-----------------</span><br><span class="line">[root@rabbitmq2 ~]# rabbitmqctl stop_app</span><br><span class="line">Stopping node rabbit@rabbitmq2 ...</span><br><span class="line">...done.</span><br><span class="line">[root@rabbitmq2 ~]# rabbitmqctl join_cluster rabbit@rabbitmq1</span><br><span class="line">Clustering node rabbit@rabbitmq2 with rabbit@rabbitmq1 ...</span><br><span class="line">...done.</span><br><span class="line">[root@rabbitmq2 ~]# rabbitmqctl start_app</span><br><span class="line">Starting node rabbit@rabbitmq2 ...</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 先将rabbitmq2加入集群</span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  rabbitmq1</span><br><span class="line">-----------------</span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl add_user test centos</span><br><span class="line">Creating user "test" ...</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个叫<span class="built_in">test</span>的用户，密码是centos</span></span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl set_user_tags test administrator</span><br><span class="line">Setting tags for user "test" to [administrator] ...</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给<span class="built_in">test</span>用户添加一个管理员的角色</span></span><br><span class="line">[root@rabbitmq1 ~]# rabbitmqctl set_permissions -p / test ".*" ".*" ".*"</span><br><span class="line">Setting permissions for user "test" in vhost "/" ...</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在根虚拟机里设置<span class="built_in">test</span>用户配置权限、写权限、读权限。.*是正则表达式。rabbitmq的权限是根据不同的虚拟主机（virtual hosts）配置的，同用户在不同的虚拟主机（virtual hosts）里可能不一样。</span></span><br><span class="line"></span><br><span class="line">---------------------</span><br><span class="line">  rabbitmq2&amp;3</span><br><span class="line">---------------------</span><br><span class="line">[root@rabbitmq2 ~]# rabbitmqctl list_users</span><br><span class="line">Listing users ...</span><br><span class="line">guest   [administrator]</span><br><span class="line">test    [administrator]</span><br><span class="line">...done.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为是集群，只要在一台主机设置即可，其它会自动同步。</span></span><br></pre></td></tr></table></figure>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><h4 id="Node-statistics-not-available"><a href="#Node-statistics-not-available" class="headerlink" title="Node statistics not available"></a>Node statistics not available</h4><p><img src="/images/rabbitmq/问题一.png" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 显示Node statistics not available是因为节点的web插件未启用</span></span><br><span class="line">---------------------</span><br><span class="line">  rabbitmq2&amp;3</span><br><span class="line">---------------------</span><br><span class="line">[root@rabbitmq2 ~]# rabbitmq-plugins enable rabbitmq_management</span><br><span class="line">The following plugins have been enabled:</span><br><span class="line">  mochiweb</span><br><span class="line">  webmachine</span><br><span class="line">  rabbitmq_web_dispatch</span><br><span class="line">  amqp_client</span><br><span class="line">  rabbitmq_management_agent</span><br><span class="line">  rabbitmq_management</span><br><span class="line">Plugin configuration has changed. Restart RabbitMQ for changes to take effect.</span><br><span class="line">[root@rabbitmq2 ~]# systemctl restart rabbitmq-server.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要重新启动才能生效</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果不能启动插件，可以先rabbitmqctl stop_app，之后再添加</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/rabbitmq/问题一解决.png" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/17/awk内置函数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/17/awk内置函数/" itemprop="url">
                  awk内置函数
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-17 16:48:35" itemprop="dateCreated datePublished" datetime="2018-10-17T16:48:35+08:00">2018-10-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 16:12:57" itemprop="dateModified" datetime="2019-01-15T16:12:57+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="awk内置函数"><a href="#awk内置函数" class="headerlink" title="awk内置函数"></a>awk内置函数</h3><h4 id="算数函数"><a href="#算数函数" class="headerlink" title="算数函数"></a>算数函数</h4><h5 id="rand函数"><a href="#rand函数" class="headerlink" title="rand函数"></a>rand函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print rand()&#125;'</span><br><span class="line">0.237788</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print rand()&#125;'</span><br><span class="line">0.237788</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print rand()&#125;'</span><br><span class="line">0.237788</span><br><span class="line"><span class="meta">#</span><span class="bash"> 单纯的使用rand函数，生成的值是不变的</span></span><br></pre></td></tr></table></figure>
<h5 id="srand函数"><a href="#srand函数" class="headerlink" title="srand函数"></a>srand函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print rand()&#125;'</span><br><span class="line">0.121122</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print rand()&#125;'</span><br><span class="line">0.665691</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print rand()&#125;'</span><br><span class="line">0.383723</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配合srand函数使用rand函数就可以生成小于1的随机数了</span></span><br></pre></td></tr></table></figure>
<h5 id="int函数"><a href="#int函数" class="headerlink" title="int函数"></a>int函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print rand()&#125;'</span><br><span class="line">0.999933</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print 100*rand()&#125;'</span><br><span class="line">72.6895</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print int(100*rand())&#125;'</span><br><span class="line">82</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用int函数最后截取出一个整数，第二步后要取出多少位的值就乘以多少</span></span><br></pre></td></tr></table></figure>
<h4 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h4><h5 id="gsub函数"><a href="#gsub函数" class="headerlink" title="gsub函数"></a>gsub函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# cat test4</span><br><span class="line">Allen Phillips</span><br><span class="line">Green Lee</span><br><span class="line">William Aiden James Lee</span><br><span class="line">Angel Jack</span><br><span class="line">Tyler Kevin</span><br><span class="line">Lucas Thomas</span><br><span class="line">Kevin</span><br><span class="line">[root@bogon ~]# awk '&#123;gsub("l","L",$1);print $0&#125;' test4</span><br><span class="line">ALLen Phillips</span><br><span class="line">Green Lee</span><br><span class="line">WiLLiam Aiden James Lee</span><br><span class="line">AngeL Jack</span><br><span class="line">TyLer Kevin</span><br><span class="line">Lucas Thomas</span><br><span class="line">Kevin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用gsub函数，将小写字母<span class="string">"l"</span>替换成大写字母<span class="string">"L"</span>，但是替换的范围只限于<span class="string">"<span class="variable">$1</span>"</span>，所以，当我们再次输出文本时，发现只有文本中的第一列中的小写字母<span class="string">"l"</span>被替换成了大写字母<span class="string">"L"</span>，其他列中的小写字母<span class="string">"l"</span>并未被替换。如果想要替换文本中所有的小写字母<span class="string">"l"</span>，则可以将上图中的<span class="string">"<span class="variable">$1</span>"</span>换成<span class="string">"<span class="variable">$0</span>"</span>，或者省略gsub函数中的第三个参数，省略gsub中的第三个参数时，默认为<span class="string">"<span class="variable">$0</span>"</span></span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;gsub("[a-z]","6",$1);print $0&#125;' test4</span><br><span class="line">A6666 Phillips</span><br><span class="line">G6666 Lee</span><br><span class="line">W666666 Aiden James Lee</span><br><span class="line">A6666 Jack</span><br><span class="line">T6666 Kevin</span><br><span class="line">L6666 Thomas</span><br><span class="line">K6666</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过正则表达式进行匹配，这里将第一列中的小写字母都替换成了6</span></span><br></pre></td></tr></table></figure>
<h5 id="sub函数"><a href="#sub函数" class="headerlink" title="sub函数"></a>sub函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;sub("l","L",$1);print $0&#125;' test4</span><br><span class="line">ALlen Phillips</span><br><span class="line">Green Lee</span><br><span class="line">WiLliam Aiden James Lee</span><br><span class="line">AngeL Jack</span><br><span class="line">TyLer Kevin</span><br><span class="line">Lucas Thomas</span><br><span class="line">Kevin</span><br><span class="line"><span class="meta">#</span><span class="bash"> sub函数只会替换指定范围内第一次匹配到的符合条件的字符。</span></span><br></pre></td></tr></table></figure>
<h5 id="length函数"><a href="#length函数" class="headerlink" title="length函数"></a>length函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;for(i=1;i&lt;=NF;i++)&#123;print $i,length($i)&#125;&#125;' test4</span><br><span class="line">Allen 5</span><br><span class="line">Phillips 8</span><br><span class="line">Green 5</span><br><span class="line">Lee 3</span><br><span class="line">William 7</span><br><span class="line">Aiden 5</span><br><span class="line">James 5</span><br><span class="line">Lee 3</span><br><span class="line">Angel 5</span><br><span class="line">Jack 4</span><br><span class="line">Tyler 5</span><br><span class="line">Kevin 5</span><br><span class="line">Lucas 5</span><br><span class="line">Thomas 6</span><br><span class="line">Kevin 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过length函数，获取到指定字符串的长度。</span></span><br><span class="line">[root@bogon ~]# awk '&#123;print $0,length()&#125;' test4</span><br><span class="line">Allen Phillips 14</span><br><span class="line">Green Lee 9</span><br><span class="line">William Aiden James Lee 23</span><br><span class="line">Angel Jack 10</span><br><span class="line">Tyler Kevin 11</span><br><span class="line">Lucas Thomas 12</span><br><span class="line">Kevin 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> length函数可以省略传入的参数，即不指定任何字符串，当省略参数时，默认使用<span class="string">"<span class="variable">$0</span>"</span>作为参数</span></span><br></pre></td></tr></table></figure>
<h5 id="index函数"><a href="#index函数" class="headerlink" title="index函数"></a>index函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print index($0,"Lee")&#125;' test4</span><br><span class="line">0</span><br><span class="line">7</span><br><span class="line">21</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用index函数，在每一行中找字符串<span class="string">"Lee"</span>，如果Lee存在于当前行，则返回字符串Lee位于当前行的位置，如果Lee不存在于当前行，则返回0，表示当前行并不存在Lee，如上，第二行中包含Lee，而且Lee位于第二行的第7个字符的位置，所以返回数字7</span></span><br></pre></td></tr></table></figure>
<h5 id="split函数"><a href="#split函数" class="headerlink" title="split函数"></a>split函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk -v ts="大鹏:少松:老董" 'BEGIN&#123;split(ts,test,":");for(i in test)&#123;print test[i]&#125;&#125;'</span><br><span class="line">大鹏</span><br><span class="line">少松</span><br><span class="line">老董</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过split函数，将字符串ts切割，以<span class="string">":"</span>作为分割符，将分割后的字符串保存到了名为<span class="built_in">test</span>的数组中，当我们输出数组中的元素时，每个元素的值为分割后的字符，其实，split函数也有对应的返回值，其返回值就是分割以后的数组长度</span></span><br><span class="line">[root@bogon ~]# awk -v ts="大鹏:少松:老董" 'BEGIN&#123;print split(ts,test,":")&#125;'</span><br><span class="line">3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 被split函数分割后的数组的元素下标从1开始，不像其他语言中的数组下标是从0开始的，而且数组中元素输出的顺序可能与字符串中字符的顺序不同</span></span><br><span class="line">[root@bogon ~]# awk -v ts="大鹏:少松:老董" 'BEGIN&#123;ruo=split(ts,test,":");for(i=1;i&lt;=ruo;i++)&#123;print i,test[i]&#125;&#125;'</span><br><span class="line">1 大鹏</span><br><span class="line">2 少松</span><br><span class="line">3 老董</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="keyword">for</span>(i=1;i&lt;=ruo;i++)这样的循环语句，才能按顺序输出内容</span></span><br></pre></td></tr></table></figure>
<h4 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">* asort</span><br><span class="line"><span class="meta">#</span><span class="bash"> asort 函数可以根据元素的值进行排序</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["a"]=66;t["b"]=88;t["c"]=3;for(i in t)&#123;print i,t[i]&#125;&#125;'</span><br><span class="line">a 66</span><br><span class="line">b 88</span><br><span class="line">c 3</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["a"]=66;t["b"]=88;t["c"]=3;asort(t);for(i in t)&#123;print i,t[i]&#125;&#125;'</span><br><span class="line">1 3</span><br><span class="line">2 66</span><br><span class="line">3 88</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数组中元素的值均为数字，但是下标为自定义的字符串，通过asort函数对数组排序后，再次输出数组中的元素时，已经按照元素的值的大小进行了排序，但是，数组的下标也被重置为了纯数字。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["a"]=66;t["b"]=88;t["c"]=3;asort(t,newt);for(i in t)&#123;print i,t[i]&#125;&#125;'</span><br><span class="line">a 66</span><br><span class="line">b 88</span><br><span class="line">c 3</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["a"]=66;t["b"]=88;t["c"]=3;asort(t,newt);for(i in newt)&#123;print i,newt[i]&#125;&#125;'</span><br><span class="line">1 3</span><br><span class="line">2 66</span><br><span class="line">3 88</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对原数组元素值排序的同时，创建一个新的数组，将排序后的元素放置在新数组中。上面两条命令一条打印源数组的值，一条打印新数组的值。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["a"]=66;t["b"]=88;t["c"]=3;len=asort(t,newt);for(i=1;i&lt;=len;i++)&#123;print i,newt[i]&#125;&#125;'</span><br><span class="line">1 3</span><br><span class="line">2 66</span><br><span class="line">3 88</span><br><span class="line"><span class="meta">#</span><span class="bash"> asort函数也有返回值，它的返回值就是数组的长度。这里将asort的返回值保存在了len中</span></span><br><span class="line"></span><br><span class="line">* asorti</span><br><span class="line"><span class="meta">#</span><span class="bash"> asorti 函数可以根据元素的下标进行排序</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["z"]=66;t["q"]=88;t["a"]=3;for(i in t)&#123;print i,t[i]&#125;&#125;'</span><br><span class="line">z 66</span><br><span class="line">a 3</span><br><span class="line">q 88</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["z"]=66;t["q"]=88;t["a"]=3;len=asorti(t,newt);for(i=1;i&lt;=len;i++)&#123;print i,newt[i]&#125;&#125;'</span><br><span class="line">1 a</span><br><span class="line">2 q</span><br><span class="line">3 z</span><br><span class="line"><span class="meta">#</span><span class="bash"> asorti 函数根据数组t的下标排序后，创建了一个新的数组newt，newt中元素的值即为t数组下标的值，上例中，我们使用len变量保存了asorti函数的返回值，并且输出了最后排序后的新数组。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["z"]=66;t["q"]=88;t["a"]=3;len=asorti(t,newt);for(i=1;i&lt;=len;i++)&#123;print i,newt[i]&#125;&#125;'</span><br><span class="line">1 a</span><br><span class="line">2 q</span><br><span class="line">3 z</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["z"]=66;t["q"]=88;t["a"]=3;len=asorti(t,newt);for(i=1;i&lt;=len;i++)&#123;print i,t[newt[i]]&#125;&#125;'</span><br><span class="line">1 3</span><br><span class="line">2 88</span><br><span class="line">3 66</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据排序后的下标再次输出对应的元素值，从而达到根据数组下标排序后，输出原数组元素的目的。新数组负责排序老数组的下标，并将排序后的下标作为新数组的元素，而我们输出新数组元素的同时，又将新数组的元素值作为老数组下标，从而输出了老数组中的元素值</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/17/awk数组/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/17/awk数组/" itemprop="url">
                  awk数组
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-17 15:20:44" itemprop="dateCreated datePublished" datetime="2018-10-17T15:20:44+08:00">2018-10-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 16:08:39" itemprop="dateModified" datetime="2019-01-15T16:08:39+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="awk数组"><a href="#awk数组" class="headerlink" title="awk数组"></a>awk数组</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[0]="大鹏";test[1]="少松";test[2]="老董";print test[1]&#125;'</span><br><span class="line">少松</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为数组中的元素赋值，下标从0开始。最后打印数组中的第二个元素。awk的数组默认从1开始。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[0]="大鹏";test[1]="少松";test[2]="老董";test[3]="正伟";test[4]="法林";test[5]="";print test[5]&#125;'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面<span class="built_in">test</span>[5]设置为了空字符串，在awk中也是被允许的，所以可以打印出一个空行</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[0]="大鹏";test[1]="少松";test[2]="老董";test[3]="正伟";test[4]="法林";test[5]="";print test[6]&#125;'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在引用一个不存在的数组元素也是可以的，会打印出一个空字符串。</span></span><br><span class="line"></span><br><span class="line">* 语法</span><br><span class="line">	if(下标 in 数组名)</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 判断数组中是否存在对应的元素</span></span><br><span class="line">	delete</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 删除整个数组</span></span><br><span class="line">	</span><br><span class="line">* 使用数字为下标</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[0]="大鹏";test[1]="少松";test[2]="老董";test[3]="正伟";test[4]="法林";test[5]="";if(6 in test)&#123;print "数组的第7个元素存在即可看到"&#125;&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果下标是6的元素存在，就会打印后面的一段话</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[0]="大鹏";test[1]="少松";test[2]="老董";test[3]="正伟";test[4]="法林";test[5]="";if(!(6 in test))&#123;print "数组的第7个元素不存在即可看到"&#125;&#125;'</span><br><span class="line">数组的第7个元素不存在即可看到</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以取反</span></span><br><span class="line"></span><br><span class="line">* 以字符串为下标</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test["a"]="大鹏";test["b"]="少松";test["cc"]="老董";test["fe"]="正伟";test["ews"]="法林";test["adg"]="";&#123;print test["ews"]&#125;&#125;'</span><br><span class="line">法林</span><br><span class="line"><span class="meta">#</span><span class="bash"> 还可以使用字符串作为下标，但字符串两侧一个要有双引号</span></span><br><span class="line"></span><br><span class="line">* 删除</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test["a"]="大鹏";test["b"]="少松";test["cc"]="老董";test["fe"]="正伟";test["ews"]="法林";test["adg"]="";print test["ews"];delete test;&#123;print test["ews"]&#125;&#125;'</span><br><span class="line">法林</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在delete前的<span class="built_in">print</span>可以打印出内容，经过delete删除数组后，就没法打印出同样数据元素的内容了</span></span><br><span class="line"></span><br><span class="line">* 打印所有元素</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[1]="大鹏";test[2]="少松";test[3]="老董";test[4]="正伟";test[5]="法林";test[6]="";for (i=1;i&lt;=6;i++)&#123;print i,test[i]&#125;&#125;'</span><br><span class="line">1 大鹏</span><br><span class="line">2 少松</span><br><span class="line">3 老董</span><br><span class="line">4 正伟</span><br><span class="line">5 法林</span><br><span class="line">6 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种<span class="keyword">for</span>循环只能输出以数字为下标的数组</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test["a"]="大鹏";test["b"]="少松";test["cc"]="老董";test["fe"]="正伟";test["ews"]="法林";test["adg"]="";for(i in test)&#123;print i,test[i]&#125;&#125;'</span><br><span class="line">cc 老董</span><br><span class="line">a 大鹏</span><br><span class="line">b 少松</span><br><span class="line">fe 正伟</span><br><span class="line">ews 法林</span><br><span class="line">adg </span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span>循环中的变量<span class="string">"i"</span>表示的是元素的下标，而并非表示元素的值，所以，如果想要输出元素的值，则需要使用<span class="string">"print 数组名[变量]"</span></span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[1]="大鹏";test[2]="少松";test[3]="老董";test[4]="正伟";test[5]="法林";test[6]="";for (i in test)&#123;print i,test[i]&#125;&#125;'</span><br><span class="line">4 正伟</span><br><span class="line">5 法林</span><br><span class="line">6 </span><br><span class="line">1 大鹏</span><br><span class="line">2 少松</span><br><span class="line">3 老董</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用这种<span class="keyword">for</span>循环，是不能按数字顺序打印元素的，因为数字被转换成了字符串。awk中的数组本质上就是关联数组</span></span><br><span class="line"></span><br><span class="line">* 统计次数</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;a=1;print a;a=a+1;print a&#125;'</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将变量a的值设置为1，进行加法计算，每次自加后，再次打印变量a的值，都会加1。a=a+1可以写为a++</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;a="test";print a;a=a+1;print a;a++;print a&#125;'</span><br><span class="line">test</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 字符串两侧一定要有双引号。字符串也可以进行运算，如果参与运算，字符串将被当做数字0进行运算</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;a="";print a;a=a+1;print a;a++;print a&#125;'</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 空字符串也可以当做0进行运算</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print test["i"];test["i"]++;print test["i"]&#125;'</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不存在的字符串也可以参与运算，因为不存在的字符串会被赋值为空字符串</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test5</span><br><span class="line">192.168.1.123	</span><br><span class="line">192.168.1.124	</span><br><span class="line">192.168.1.123	</span><br><span class="line">192.168.1.123</span><br><span class="line">192.168.1.124</span><br><span class="line">192.168.2.222</span><br><span class="line">172.16.100.3</span><br><span class="line">172.16.100.3</span><br><span class="line">172.16.100.3</span><br><span class="line">172.16.100.3</span><br><span class="line">172.16.100.3</span><br><span class="line">172.16.100.3</span><br><span class="line">192.168.1.15</span><br><span class="line">172.16.100.7</span><br><span class="line">[root@bogon ~]# awk '&#123;count[$1]++&#125;END&#123;for(i in count)&#123;print i,count[i]&#125;&#125;' test5</span><br><span class="line">172.16.100.3 6</span><br><span class="line">192.168.2.222 1</span><br><span class="line">172.16.100.7 1</span><br><span class="line">192.168.1.123 3</span><br><span class="line">192.168.1.124 2</span><br><span class="line">192.168.1.15 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用空模式与END模式，空模式中，我们随便创建了一个数组，并且将IP地址作为引用元素的下标，进行引用，所以，当执行到第一行时，我们引用的是count[<span class="string">"192.168.1.123"</span>]，这个元素并不存在，所以，当第一行被空模式中的动作处理完毕后，count[<span class="string">"192.168.1.123"</span>]的值已经被赋值为1了。这时，空模式中的动作继续处理下一行，而下一行的IP地址为192.168.1.124，所以，count[<span class="string">"192.168.1.124"</span>]第一次参与运算的过程与上述过程一样。其他IP地址第一次参与运算的过程与上述过程也一样。直到再次遇到相同的IP地址时，使用同样一个IP地址作为下标的元素将会再次被自加，每次遇到相同的IP地址，对应元素的值都会加1。直到处理完所有行，开始执行END模式中的动作。而END模式中，我们打印出了count数组中的所有元素的下标，以及元素对应的值。此刻，count数组中的下标即为IP地址，元素的值即为对应IP地址出现的次数。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们对一个不存在的元素进行自加运算后，这个元素的值就变成了自加运算的次数</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test4</span><br><span class="line">Allen Phillips</span><br><span class="line">Green Lee</span><br><span class="line">William Aiden James Lee</span><br><span class="line">Angel Jack</span><br><span class="line">Tyler Kevin</span><br><span class="line">Lucas Thomas</span><br><span class="line">Kevin</span><br><span class="line">[root@bogon ~]# awk '&#123;for(i=1;i&lt;=NF;i++)&#123;count[$i]++&#125;&#125;END&#123;for(s in count)&#123;print s,count[s]&#125;&#125;' test4</span><br><span class="line">Tyler 1</span><br><span class="line">Angel 1</span><br><span class="line">James 1</span><br><span class="line">Lucas 1</span><br><span class="line">William 1</span><br><span class="line">Thomas 1</span><br><span class="line">Green 1</span><br><span class="line">Jack 1</span><br><span class="line">Phillips 1</span><br><span class="line">Kevin 2</span><br><span class="line">Lee 2</span><br><span class="line">Allen 1</span><br><span class="line">Aiden 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此命令与上面计算IP地址出现次数的命令同理，只是文件中比上面的文件多了几列，所以先将每列的内容赋值给count，NF就表示一共有几列，这会先将第一列的内容赋值给count，之后第二列第三列，但不会超过每行的总列数。理解了前半部分命令，END后面的动作就和上面的命令意思一样了。这里count[<span class="variable">$i</span>]赋值后就会变为count[Tyler]、count[Angel]等，然后给这个元素赋值，因为这是一个不存在的数组，并且空模式处理后会自加，所以赋值从1开始，也就是count[Tyler]=1、count[Angel]=1等，这个数字实际也就是最后要计算的次数了</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/17/awk动作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/17/awk动作/" itemprop="url">
                  awk动作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-17 14:13:32" itemprop="dateCreated datePublished" datetime="2018-10-17T14:13:32+08:00">2018-10-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 15:49:54" itemprop="dateModified" datetime="2019-01-15T15:49:54+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="awk动作"><a href="#awk动作" class="headerlink" title="awk动作"></a>awk动作</h3><ul>
<li>输出语句</li>
<li>组合语句</li>
<li>条件判断控制语句</li>
<li>循环控制语句</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print $0&#125;' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line"><span class="meta">#</span><span class="bash"> &#123;&#125;与<span class="built_in">print</span> <span class="variable">$0</span>是两个动作。<span class="string">"print"</span>属于<span class="string">"输出语句"</span>类型的动作，<span class="string">"输出语句"</span>类型的动作的作用就是输出、打印信息。<span class="string">"&#123;  &#125;"</span>属于<span class="string">"组合语句"</span>类型的动作，组合语句<span class="string">"类型的动作的作用就是将多个代码组合成代码块。</span></span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk '&#123;print $1&#125;&#123;print $2&#125;' test</span><br><span class="line">abc</span><br><span class="line">345</span><br><span class="line">123</span><br><span class="line">klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用了两个大括号<span class="string">"&#123;  &#125;"</span>，它们属于<span class="string">"组合语句"</span>类型的动作，它们分别将两个<span class="built_in">print</span>括住，表示这两个<span class="built_in">print</span>动作分别作为两个独立的个体。先打印<span class="variable">$1</span>再打印<span class="variable">$2</span></span></span><br><span class="line">[root@bogon ~]# awk '&#123;print $1;print $2&#125;' test</span><br><span class="line">abc</span><br><span class="line">345</span><br><span class="line">123</span><br><span class="line">klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将上面的动作组合在一起。当我们把多个动作（多段代码）组合成一个代码块的时候，每段动作（每段代码）之间需要用分号<span class="string">";"</span>隔开</span></span><br></pre></td></tr></table></figure>
<h4 id="条件判断控制语句"><a href="#条件判断控制语句" class="headerlink" title="条件判断控制语句"></a>条件判断控制语句</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">    if(条件)</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;if(NR == 1)&#123;print $0&#125;&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要将动作写在&#123;&#125;中，控制语句也要有&#123;&#125;，所以这里有两个&#123;&#125;，<span class="keyword">if</span>语句中的大括号中，也可以执行多个动作。将行号是1的行打印出来。</span></span><br><span class="line">[root@bogon ~]# awk '&#123;if(NR == 1)&#123;print $1;print $2&#125;&#125;' test</span><br><span class="line">abc</span><br><span class="line">345</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果行号是1，就打印第一列再打印第二列</span></span><br><span class="line">[root@bogon ~]# awk '&#123;if(NR == 1)print $1&#125;' test</span><br><span class="line">abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果<span class="keyword">if</span>后的动作只有一个，那么也可以不写&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">* 语法</span><br><span class="line">    "if...else..."的语法如下：</span><br><span class="line">    if(条件)</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    "if...else if...else"的语法如下：</span><br><span class="line">    if(条件1)</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    else if(条件2)</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -F":" '&#123;if($3 &lt; 1000)&#123;print $1,"系统用户"&#125;else&#123;print $1,"普通用户"&#125;&#125;' /etc/passwd</span><br><span class="line">root 系统用户</span><br><span class="line">bin 系统用户</span><br><span class="line">daemon 系统用户</span><br><span class="line">adm 系统用户</span><br><span class="line">lp 系统用户</span><br><span class="line">sync 系统用户</span><br><span class="line">shutdown 系统用户</span><br><span class="line">halt 系统用户</span><br><span class="line">mail 系统用户</span><br><span class="line">operator 系统用户</span><br><span class="line">games 系统用户</span><br><span class="line">ftp 系统用户</span><br><span class="line">nobody 系统用户</span><br><span class="line">systemd-network 系统用户</span><br><span class="line">dbus 系统用户</span><br><span class="line">polkitd 系统用户</span><br><span class="line">postfix 系统用户</span><br><span class="line">sshd 系统用户</span><br><span class="line">openvpn 系统用户</span><br><span class="line">ruopu 普通用户</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对/etc/passwd文件中的用户做判断，用户ID小于1000的为系统用户，否则就是普通用户</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test7</span><br><span class="line">姓名	年龄</span><br><span class="line">aaa	18</span><br><span class="line">bbb	66</span><br><span class="line">ccc	36</span><br><span class="line">[root@bogon ~]# awk 'NR !=1&#123;if($2&lt;=30)&#123;print $1,"年轻人"&#125;else if($2&gt;=30 &amp;&amp; $2&lt;=50)&#123;print $1,"中年人"&#125;else&#123;print $1,"老年人"&#125;&#125;' test7</span><br><span class="line">aaa 年轻人</span><br><span class="line">bbb 老年人</span><br><span class="line">ccc 中年人</span><br><span class="line"><span class="meta">#</span><span class="bash"> 首先忽略第一行，然后判断文件中第二列的年龄，最后打印出结果</span></span><br></pre></td></tr></table></figure>
<h5 id="三元运算"><a href="#三元运算" class="headerlink" title="三元运算"></a>三元运算</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">条件?结果1:结果2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果条件成立，则返回结果1，如果条件不成立，则返回结果2。</span></span><br><span class="line"></span><br><span class="line">表达式1 ? 表达式2 : 表达式3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果表达式1为真，则执行表达式2，如果表达式1为假，则执行表达式3</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -F: '&#123;if($3 &lt; 1000)&#123;usertype="系统用户"&#125;else&#123;usertype="普通用户"&#125;;print $1,usertype&#125;' /etc/passwd</span><br><span class="line">root 系统用户</span><br><span class="line">bin 系统用户</span><br><span class="line">daemon 系统用户</span><br><span class="line">adm 系统用户</span><br><span class="line">lp 系统用户</span><br><span class="line">sync 系统用户</span><br><span class="line">shutdown 系统用户</span><br><span class="line">halt 系统用户</span><br><span class="line">mail 系统用户</span><br><span class="line">operator 系统用户</span><br><span class="line">games 系统用户</span><br><span class="line">ftp 系统用户</span><br><span class="line">nobody 系统用户</span><br><span class="line">systemd-network 系统用户</span><br><span class="line">dbus 系统用户</span><br><span class="line">polkitd 系统用户</span><br><span class="line">postfix 系统用户</span><br><span class="line">sshd 系统用户</span><br><span class="line">openvpn 系统用户</span><br><span class="line">ruopu 普通用户</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"if...else"</span>结构，对usertype变量进行了赋值，如果用户的UID小于1000，则对usertype变量赋值为<span class="string">"系统用户"</span>，否则赋值usertype变量为<span class="string">"普通用户"</span>，最后打印出用户名所在的列与usertype变量的值。</span></span><br><span class="line">[root@bogon ~]# awk -F: '&#123;usertype=$3&lt;1000?"系统用户":"普通用户";print $1,usertype&#125;' /etc/passwd</span><br><span class="line">root 系统用户</span><br><span class="line">bin 系统用户</span><br><span class="line">daemon 系统用户</span><br><span class="line">adm 系统用户</span><br><span class="line">lp 系统用户</span><br><span class="line">sync 系统用户</span><br><span class="line">shutdown 系统用户</span><br><span class="line">halt 系统用户</span><br><span class="line">mail 系统用户</span><br><span class="line">operator 系统用户</span><br><span class="line">games 系统用户</span><br><span class="line">ftp 系统用户</span><br><span class="line">nobody 系统用户</span><br><span class="line">systemd-network 系统用户</span><br><span class="line">dbus 系统用户</span><br><span class="line">polkitd 系统用户</span><br><span class="line">postfix 系统用户</span><br><span class="line">sshd 系统用户</span><br><span class="line">openvpn 系统用户</span><br><span class="line">ruopu 普通用户</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"<span class="variable">$3</span>&lt;1000"</span>就是语法中的<span class="string">"条件"</span>，<span class="string">"系统用户"</span>就是语法中<span class="string">"?"</span>后面的<span class="string">"结果1"</span>，<span class="string">"普通用户"</span>就是语法中<span class="string">":"</span>后面的<span class="string">"结果2"</span> ，同时，在上例中我们使用usertype变量接收了三元运算后的返回值，所以，当条件成立时，usertype变量被赋值为<span class="string">"系统用户"</span>，当条件不成立时，usertype变量被赋值为<span class="string">"普通用户"</span>。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -F: '&#123;$3&lt;1000?a++:b++&#125;END&#123;print a,b&#125;' /etc/passwd</span><br><span class="line">19 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"<span class="variable">$3</span>&lt;1000"</span>即为表达式1，<span class="string">"a++"</span>即为表达式2，<span class="string">"b++"</span>即为表达式3。当每遇到一个UID小于1000的用户，我就对变量a加1，否则我就对变量b加1，从而算出了系统用户与普通用户的数量，最后再END模式中输出了变量a与变量b的值。</span></span><br></pre></td></tr></table></figure>
<h4 id="循环控制语句"><a href="#循环控制语句" class="headerlink" title="循环控制语句"></a>循环控制语句</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">    # for循环语法格式1</span><br><span class="line">    for(初始化; 布尔表达式; 更新) &#123;</span><br><span class="line">    //代码语句</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # for循环语法格式2</span><br><span class="line">    for(变量 in 数组) &#123;</span><br><span class="line">    //代码语句</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # while循环语法</span><br><span class="line">    while( 布尔表达式 ) &#123;</span><br><span class="line">    //代码语句</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # do...while循环语法</span><br><span class="line">    do &#123;</span><br><span class="line">    //代码语句</span><br><span class="line">    &#125;while(条件)</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;for(i=1;i&lt;=6;i++)&#123;print i&#125;&#125;'</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">[root@bogon ~]# awk -v i=1 'BEGIN&#123;while(i&lt;=5)&#123;print i;i++&#125;&#125;'</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;i=1;while(i&lt;=5)&#123;print i;i++&#125;&#125;'</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;i=1;do&#123;print "test";i++&#125;while(i&lt;1)&#125;'</span><br><span class="line">test</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;i=1;do&#123;print "test";i++&#125;while(i&lt;11)&#125;'</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不论如何，先执行一次<span class="keyword">do</span>后面的动作</span></span><br><span class="line"></span><br><span class="line">* 跳出循环语法</span><br><span class="line">	continue的作用：跳出"当前"循环</span><br><span class="line">	break的作用：跳出"整个"循环</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;for(i=0;i&lt;6;i++)&#123;if(i==3)&#123;continue&#125;;print i&#125;&#125;'</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 先设置i在0到6之前循环，再判断，如果i等于3就跳过此次循环。<span class="keyword">if</span>动作是<span class="keyword">for</span>循环的一部分。也就是<span class="function"><span class="title">for</span></span>()&#123;<span class="function"><span class="title">if</span></span>()&#123;&#125;&#125;</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;for(i=0;i&lt;6;i++)&#123;if(i==3)&#123;break&#125;;print i&#125;&#125;'</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">break</span>可以跳出整个循环</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">continue</span>与<span class="built_in">break</span>同样可以用于<span class="keyword">while</span>循环与do...while循环，此处就不再赘述了。</span></span><br><span class="line"></span><br><span class="line">* 退出</span><br><span class="line">	exit</span><br><span class="line">	next</span><br><span class="line">	</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print 1;exit;print 2;print 3&#125;'</span><br><span class="line">1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="built_in">exit</span>会跳出整个脚本，所以没有打印2和3</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "start";exit&#125;&#123;print $0&#125;END&#123;print "over"&#125;' test</span><br><span class="line">start</span><br><span class="line">over</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exit</span>并不会跳出awk命令，遇到<span class="built_in">exit</span>后，之后的命令都不执行，它会直接执行END模式的动作。如果没有END模式，将直接退出整个awk命令。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test8</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">[root@bogon ~]# awk '&#123;if(NR==2)&#123;next&#125;;print $0&#125;' test8</span><br><span class="line">1</span><br><span class="line">3</span><br><span class="line"><span class="meta">#</span><span class="bash"> next命令可以促使awk不对当前行执行对应的动作，而是直接处理下一行。next与<span class="built_in">continue</span>有些类似，只是，<span class="built_in">continue</span>是针对<span class="string">"循环"</span>而言的，<span class="built_in">continue</span>的作用是结束<span class="string">"本次循环"</span>，而next是针对<span class="string">"逐行处理"</span>而言的，next的作用是结束<span class="string">"对当前行的处理"</span>，从而直接处理<span class="string">"下一行"</span></span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/17/awk模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/17/awk模式/" itemprop="url">
                  awk模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-17 11:28:32" itemprop="dateCreated datePublished" datetime="2018-10-17T11:28:32+08:00">2018-10-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 15:33:14" itemprop="dateModified" datetime="2019-01-15T15:33:14+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="awk模式"><a href="#awk模式" class="headerlink" title="awk模式"></a>awk模式</h3><ul>
<li>BEGIN/END模式</li>
<li>关系表达式模式</li>
<li>空模式</li>
<li>正则模式</li>
<li>行范围模式</li>
</ul>
<blockquote>
<p>模式也可以理解为条件。不指定任何”条件”，awk会一行一行的处理文本中的每一行。指定了”条件”，只有满足”条件”的行才会被处理，不满足”条件”的行就不会被处理。</p>
</blockquote>
<h4 id="关系表达式模式"><a href="#关系表达式模式" class="headerlink" title="关系表达式模式"></a>关系表达式模式</h4><table>
<thead>
<tr>
<th>关系运算符</th>
<th>含义</th>
<th>用法示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt;</td>
<td>小于</td>
<td>x &lt; y</td>
</tr>
<tr>
<td>&lt;=</td>
<td>小于等于</td>
<td>x &lt;= y</td>
</tr>
<tr>
<td>==</td>
<td>等于</td>
<td>x == y</td>
</tr>
<tr>
<td>!=</td>
<td>不等于</td>
<td>x != y</td>
</tr>
<tr>
<td>&gt;=</td>
<td>大于等于</td>
<td>x &gt;= y</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于</td>
<td>x &gt; y</td>
</tr>
<tr>
<td>~</td>
<td>与对应的正则匹配则为真</td>
<td>x ~ /正则/</td>
</tr>
<tr>
<td>!~</td>
<td>与对应的正则不匹配则为真</td>
<td>x !~ /正则/</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# cat test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk 'NF==5 &#123;print $0&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印正好有五列的行。这里的条件就是这一行一共有五列</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'NF&gt;2&#123;print $0&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk 'NF&lt;=4 &#123;print $0&#125;' test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 文件中没有小于等于四列的行</span></span><br><span class="line">[root@bogon ~]# awk '$1==123 &#123;print $0&#125;' test</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要用两个等号</span></span><br></pre></td></tr></table></figure>
<h4 id="空模式"><a href="#空模式" class="headerlink" title="空模式"></a>空模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print $0&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 没有使用模式实际是使用的空模式，<span class="string">"空模式"</span>会匹配文本中的每一行，所以，每一行都满足<span class="string">"条件"</span></span></span><br></pre></td></tr></table></figure>
<h5 id="打印奇偶行"><a href="#打印奇偶行" class="headerlink" title="打印奇偶行"></a>打印奇偶行</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# cat test9</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">[root@bogon ~]# awk 'i=!i' test9</span><br><span class="line">1</span><br><span class="line">3</span><br><span class="line">5</span><br><span class="line">7</span><br><span class="line">9</span><br><span class="line">11</span><br><span class="line">[root@bogon ~]# awk '!(i=!i)' test9</span><br><span class="line">2</span><br><span class="line">4</span><br><span class="line">6</span><br><span class="line">8</span><br><span class="line">10</span><br><span class="line">12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当awk开始处理第一行时，变量 i 被初始化，变量 i 在被初始化时，值为<span class="string">"空"</span>，而awk中，数字0或者<span class="string">"空字符串"</span>表示假，所以可以认为模式为假，但是 i 直接取反了，对假取反后的值为真，将取反后的值又赋值给了变量i，此刻，变量i的值为真，所以当awk处理第一行文本时，变量i的值被赋值为真，模式成立则需要执行对应的动作，而上例中又省略了动作，所以默认动作为<span class="string">"&#123;print <span class="variable">$0</span>&#125;"</span>，所以，第一行被整行打印了。当第一行文本处理完毕后，awk开始处理第二行文本，此时，i 为真，但是取反后，i 为假，所以第二行没有被输出，依次类推，最终只打印了奇数行。打印偶数行同理，只是从第一次就让i为空字符串为假</span></span><br><span class="line">* 知识点</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在awk中，如果省略了模式对应的动作，当前行满足模式时，默认动作为打印整行，即&#123;<span class="built_in">print</span> <span class="variable">$0</span>&#125;。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在awk中，0或者空字符串表示<span class="string">"假"</span>，非0值或者非空字符串表示<span class="string">"真"</span></span></span><br><span class="line"></span><br><span class="line">* 解析</span><br><span class="line">[root@bogon ~]# awk '/1/&#123;print $0&#125;' test9</span><br><span class="line">1</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果当前行中包含字符<span class="string">"1"</span>，则执行对应的动作，而对应的动作就是打印整行。</span></span><br><span class="line">root@ccjd:~# awk '/regi/&amp;&amp;/mi/&amp;&amp;/192/&#123;print $0&#125;' daemon.json | head</span><br><span class="line">        "registry-mirrors":["http://192.168.0.198:80"],</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以通过&amp;&amp;符号指定多个条件，需要同时满足才可以。</span></span><br><span class="line">[root@bogon ~]# awk '$1&gt;10&#123;print $0&#125;' test9</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果test9文本中文本行的第一列的值如果大于10，则打印整行。</span></span><br><span class="line">[root@bogon ~]# awk '/1/' test9</span><br><span class="line">1</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">[root@bogon ~]# awk '$1&gt;10' test9</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当使用了模式时，如果省略了模式对应的动作，默认动作为<span class="string">"&#123;print <span class="variable">$0</span>&#125;"</span>，<span class="string">"空模式"</span>与<span class="string">"BEGIN/END模式"</span>除外。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '&#123;print $0&#125;' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '1&#123;print $0&#125;' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '2&#123;print $0&#125;' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '2' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '0&#123;print $0&#125;' test2</span><br><span class="line">[root@bogon ~]# awk '0' test2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一条awk命令使用了<span class="string">"空模式"</span>，也就是说，每一行都满足模式，每一行经过<span class="string">"空模式"</span>匹配以后结果都是<span class="string">"真"</span>，所以每一行都会执行对应的动作。第二条awk命令原来<span class="string">"模式的位置"</span>被替换为了数字<span class="string">"1"</span>，我们可以把数字<span class="string">"1"</span>理解成一种模式匹配后的结果，而1是非零值，在awk中非零值表示真，所以，<span class="string">"1"</span>表示<span class="string">"真"</span>，  换句话说就是模式的匹配结果为真，模式成立则会执行对应的动作，也就是打印整行。第三条awk命令与第二条awk命令同理，动作前的数字可以换为任何非0数字或非空字符串。第四条awk命令数字<span class="string">"2"</span>为非零值，表示模式为真，当使用模式时，可以省略动作，当使用模式并省略动作时，默认动作为打印整行，所以，第四条awk命令表示打印所有行，因为每一行的模式都为真。第五条awk命令与第六条awk命令因为数字<span class="string">"0"</span>与空字符串表示假，当模式为假时，不会执行对应的动作，而当存在模式并省略动作时，默认动作为打印整行，但是由于模式为假，所以对应的动作并未执行。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 理解了此处，再看上面打印奇偶行就容易理解了</span></span><br><span class="line">[root@bogon ~]# awk '!0' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '!5' test2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 还能对真与假进行取反，非真即为假，非假即为真</span></span><br><span class="line">[root@bogon ~]# awk 'i=1' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk 'i=a' test2</span><br><span class="line">[root@bogon ~]# awk 'i="a"' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk 'i=0' test2</span><br><span class="line">[root@bogon ~]# awk 'i=""' test2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用了awk的变量，将变量 i赋值为1，当 i=1 以后，i为非零值，表示为真，我们可以认为这是一种模式匹配后的结果，当模式为真时，同时省略了对应动作时，默认动作为打印整行，所以上例会输出test2中的所有行。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;i=!i;print i&#125;' test2</span><br><span class="line">1</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印出处理每一行时，i 对应的值。</span></span><br></pre></td></tr></table></figure>
<h4 id="正则模式"><a href="#正则模式" class="headerlink" title="正则模式"></a>正则模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 把<span class="string">"正则表达式"</span>当做<span class="string">"条件"</span>，能与正则匹配的行，就算满足条件，满足条件的行才会执行对应的动作，不能被正则匹配到的行，则不会执行对应的动作。</span></span><br><span class="line"></span><br><span class="line">语法</span><br><span class="line">awk '/正则表达式/&#123;动作&#125;' 文件</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# grep "^ruo" /etc/passwd</span><br><span class="line">ruopu:x:1000:1000::/home/ruopu:/bin/bash</span><br><span class="line">[root@bogon ~]# awk  '/^ruo/&#123;print $0&#125;' /etc/passwd</span><br><span class="line">ruopu:x:1000:1000::/home/ruopu:/bin/bash</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -F":" 'BEGIN&#123;printf "%-10s%-10s\n","用户名","用户ID"&#125; /^ruo/&#123;printf "%-10s\t%-10s\n",$1,$3&#125;' /etc/passwd</span><br><span class="line">用户名       用户ID      </span><br><span class="line">ruopu     	1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从/etc/passwd文件中找出符合条件的行（用户名以ruo开头的用户）；找出符合条件的文本行以后，以<span class="string">":"</span>作为分隔符，将文本行分段；取出我们需要的字段，格式化输出；结合BEGIN模式，输出一个格式化以后的文本，提高可读性</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# grep "/bin/bash" /etc/passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">ruopu:x:1000:1000::/home/ruopu:/bin/bash</span><br><span class="line">[root@bogon ~]# awk '/\/bin\/bash/&#123;print $0&#125;' /etc/passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">ruopu:x:1000:1000::/home/ruopu:/bin/bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用斜线时要用转义符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当在awk命令中使用正则模式时，使用到的正则用法属于<span class="string">"扩展正则表达式"</span>；</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -V</span><br><span class="line">GNU Awk 4.0.2</span><br><span class="line"><span class="meta">#</span><span class="bash"> CentOS7使用awk版本</span></span><br><span class="line">[root@bogon ~]# cat test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '/he&#123;2,3&#125;y/&#123;print $0&#125;' test2</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line"><span class="meta">#</span><span class="bash"> CentOS7中可以直接使用&#123;x,y&#125;的形式匹配</span></span><br><span class="line">[root@bogon ~]# awk --posix '/he&#123;2,3&#125;y/&#123;print $0&#125;' test2</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">[root@bogon ~]# awk --re-interval '/he&#123;2,3&#125;y/&#123;print $0&#125;' test2</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果无法直接使用&#123;x,y&#125;的形式，就要使用--posix或者--re-interval选项</span></span><br></pre></td></tr></table></figure>
<h4 id="行范围模式"><a href="#行范围模式" class="headerlink" title="行范围模式"></a>行范围模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">awk '/正则1/,/正则2/&#123;动作&#125;' 文件</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从被正则1匹配到的行开始，到被正则2匹配到的行结束，之间的所有行都会执行对应的动作。在行范围模式中，不管是正则1，还是正则2，都以第一次匹配到的行为准</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat -n test4</span><br><span class="line">     1	Allen Phillips</span><br><span class="line">     2	Green Lee</span><br><span class="line">     3	William Aiden James Lee</span><br><span class="line">     4	Angel Jack</span><br><span class="line">     5	Tyler Kevin</span><br><span class="line">     6	Lucas Thomas</span><br><span class="line">     7	Kevin</span><br><span class="line">[root@bogon ~]# awk '/Lee/,/Kevin/&#123;print $0&#125;' test4</span><br><span class="line">Green Lee</span><br><span class="line">William Aiden James Lee</span><br><span class="line">Angel Jack</span><br><span class="line">Tyler Kevin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 找出从Lee第一次出现的行，到Kevin第一次出现的行之间的所有行</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'NR&gt;=3 &amp;&amp; NR&lt;=6 &#123;print $0&#125;' test4</span><br><span class="line">William Aiden James Lee</span><br><span class="line">Angel Jack</span><br><span class="line">Tyler Kevin</span><br><span class="line">Lucas Thomas</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样也可以打印出需要范围的行</span></span><br><span class="line"></span><br><span class="line">* 关系运算符~与!~的使用</span><br><span class="line">[root@bogon ~]# cat test3</span><br><span class="line">主机名	网卡1的IP	网卡2的IP</span><br><span class="line">主机A	192.168.1.123	192.168.1.124</span><br><span class="line">主机B	192.168.2.222	172.16.100.3</span><br><span class="line">主机C	10.1.0.1	172.16.100.3</span><br><span class="line">主机D	10.1.2.1	192.168.1.15</span><br><span class="line">主机E	10.1.5.1	172.16.100.5</span><br><span class="line">主机F	192.168.1.234	172.16.100.6</span><br><span class="line">主机G	10.1.7.1	172.16.100.7</span><br><span class="line">[root@bogon ~]# awk '$2~/192\.168\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;/&#123;print $1,$2&#125;' test3</span><br><span class="line">主机A 192.168.1.123</span><br><span class="line">主机B 192.168.2.222</span><br><span class="line">主机F 192.168.1.234</span><br><span class="line"><span class="meta">#</span><span class="bash"> 找出网卡1的IP地址在192.168.0.0/16网段内的主机。先执行第二列匹配相应地址，最后再打印出来。如果正则模式不能使用，要加入--posix或者--re-interval选项</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/16/awk基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/16/awk基础/" itemprop="url">
                  awk基础
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-16 13:54:49" itemprop="dateCreated datePublished" datetime="2018-10-16T13:54:49+08:00">2018-10-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 15:09:05" itemprop="dateModified" datetime="2019-01-15T15:09:05+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 我们在linux上所使用的awk其实是gawk，也就是GNU awk，简称为gawk。awk其实是一门编程语言，它支持条件判断、数组、循环等功能。grep：更适合单纯的查找或匹配文本、sed：更适合编辑匹配到的文本、awk：更适合格式化文本，对文本进行较复杂格式处理</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# ll /usr/bin/awk </span><br><span class="line">lrwxrwxrwx. 1 root root 4 Oct  8 14:20 /usr/bin/awk -&gt; gawk</span><br><span class="line"></span><br><span class="line">* 语法</span><br><span class="line">awk [options] 'program' file1 , file2 , ...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对于上述语法中的program来说，又可以细分成pattern（模式）和action（动作），也就是说，awk的基本语法如下</span></span><br><span class="line">awk [options] 'Pattern&#123;Action&#125;' file</span><br><span class="line">-F：用于指定输入分隔符。</span><br><span class="line">-v：用于设置变量的值。</span><br><span class="line"></span><br><span class="line">* 常用内置变量：</span><br><span class="line">    FS：输入字段分隔符， 默认为空白字符</span><br><span class="line">    OFS：输出字段分隔符， 默认为空白字符</span><br><span class="line">    RS：输入记录分隔符(输入换行符)， 指定输入时的换行符</span><br><span class="line">    ORS：输出记录分隔符（输出换行符），输出时用指定符号代替换行符</span><br><span class="line">    NF：number of Field，当前行的字段的个数(即当前行被分割成了几列)，字段数量</span><br><span class="line">    NR：行号，当前处理的文本行的行号。</span><br><span class="line">    FNR：各文件分别计数的行号</span><br><span class="line">    FILENAME：当前文件名</span><br><span class="line">    ARGC：命令行参数的个数</span><br><span class="line">    ARGV：数组，保存的是命令行所给定的各参数</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="variable">$0</span> 表示显示整行 ，<span class="variable">$NF</span>表示当前行分割后的最后一列（<span class="variable">$0</span>和<span class="variable">$NF</span>均为内置变量）。<span class="variable">$NF</span> 和 NF 要表达的意思是不一样的，对于awk来说，<span class="variable">$NF</span>表示最后一个字段，NF表示当前行被分隔符切开以后，一共有几个字段。假如一行文本被空格分成了7段，那么NF的值就是7，<span class="variable">$NF</span>的值就是<span class="variable">$7</span>,  而<span class="variable">$7</span>表示当前行的第7个字段，也就是最后一列，那么每行的倒数第二列可以写为$(NF-1)。</span></span><br></pre></td></tr></table></figure>
<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">* 打印全部</span><br><span class="line">[root@bogon ~]# echo ddd &gt; testd</span><br><span class="line">[root@bogon ~]# awk '&#123;print&#125;' testd </span><br><span class="line">ddd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将testd文件中的内容打印了出来</span></span><br><span class="line">[root@bogon ~]# awk '&#123;print $0&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面两种写法都可以打印整行</span></span><br><span class="line"></span><br><span class="line">* 打印某列</span><br><span class="line">[root@bogon ~]# df -h | awk '&#123;print $2&#125;'</span><br><span class="line">Size</span><br><span class="line">30G</span><br><span class="line">234M</span><br><span class="line">245M</span><br><span class="line">245M</span><br><span class="line">245M</span><br><span class="line">1014M</span><br><span class="line">976M</span><br><span class="line">49M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出df的信息的第2列，<span class="variable">$2</span>表示将当前行按照分隔符分割后的第2列，不指定分隔符时，默认使用空格作为分隔符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> awk是逐行处理的，处理完当前行，再处理下一行。awk默认以<span class="string">"换行符"</span>为标记，识别每一行，每次遇到<span class="string">"回车换行"</span>，就认为是当前行的结束，新的一行的开始，awk会按照用户指定的分割符去分割当前行</span></span><br><span class="line"></span><br><span class="line">* 打印多个列</span><br><span class="line">[root@bogon ~]# cat test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk '&#123;print $2,$5,$6&#125;' test</span><br><span class="line">345 lkj;l </span><br><span class="line">klj adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一行并没有第六列，所以并没有输出任何文本，而第二行有第六列，所以输出了。</span></span><br><span class="line"></span><br><span class="line">* 添加自己的字段</span><br><span class="line">[root@bogon ~]# awk '&#123;print $1,$2,"string"&#125;' test</span><br><span class="line">abc 345 string</span><br><span class="line">123 klj string</span><br><span class="line">[root@bogon ~]# awk  '&#123;print $1,$2,423&#125;' test</span><br><span class="line">abc 345 423</span><br><span class="line">123 klj 423</span><br><span class="line">[root@bogon ~]# awk '&#123;print "diyilie:" $1,"diyilie:" $2&#125;' test</span><br><span class="line">diyilie:abc diyilie:345</span><br><span class="line">diyilie:123 diyilie:klj</span><br><span class="line">[root@bogon ~]# awk '&#123;print "diyilie:"$1,"534","diyilie:"$2&#125;' test</span><br><span class="line">diyilie:abc 534 diyilie:345</span><br><span class="line">diyilie:123 534 diyilie:klj</span><br><span class="line">[root@bogon ~]# cat test | awk '&#123;print $1&#125;'</span><br><span class="line">abc</span><br><span class="line">123</span><br><span class="line">[root@bogon ~]# cat test | awk '&#123;print "$1"&#125;'</span><br><span class="line"><span class="meta">$</span><span class="bash">1</span></span><br><span class="line"><span class="meta">$</span><span class="bash">1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 变量不能加引号</span></span><br><span class="line">[root@bogon ~]# cat test | awk '&#123;print "firstF:"$1&#125;'</span><br><span class="line">firstF:abc</span><br><span class="line">firstF:123</span><br><span class="line">[root@bogon ~]# cat test | awk '&#123;print "firstF:$1"&#125;'</span><br><span class="line">firstF:$1</span><br><span class="line">firstF:$1</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$1</span>这种内置变量的外侧不能加入双引号，否则<span class="variable">$1</span>会被当做文本输出</span></span><br></pre></td></tr></table></figure>
<h4 id="特殊模式"><a href="#特殊模式" class="headerlink" title="特殊模式"></a>特殊模式</h4><h5 id="BEGIN"><a href="#BEGIN" class="headerlink" title="BEGIN"></a>BEGIN</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> BEGIN 模式指定了处理文本之前需要执行的操作</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa","bbb"&#125;' test</span><br><span class="line">aaa bbb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在开始处理<span class="built_in">test</span>文件中的文本之前，先执行打印动作，输出的内容为<span class="string">"aaa"</span>,<span class="string">"bbb"</span>.</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa","bbb"&#125;'</span><br><span class="line">aaa bbb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为不打算处理文本文件，所以也可以不指定文本文件，只进行一个处理前的打印动作。</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa","bbb"&#125;&#123;print $1,$2&#125;' test</span><br><span class="line">aaa bbb</span><br><span class="line">abc 345</span><br><span class="line">123 klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以先进行处理前打印，再处理文本文件，但两次打印要分开写</span></span><br></pre></td></tr></table></figure>
<h5 id="END"><a href="#END" class="headerlink" title="END"></a>END</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> END 模式指定了处理完所有行之后所需要执行的操作</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa","bbb"&#125;&#123;print $1,$2&#125;END&#123;print "ccc","ddd"&#125;' test</span><br><span class="line">aaa bbb</span><br><span class="line">abc 345</span><br><span class="line">123 klj</span><br><span class="line">ccc ddd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 结合BEGIN模式和END模式一起使用</span></span><br></pre></td></tr></table></figure>
<h4 id="分隔符"><a href="#分隔符" class="headerlink" title="分隔符"></a>分隔符</h4><ul>
<li><p>awk的分隔符还分为两种，”输入分隔符” 和 “输出分隔符”</p>
</li>
<li><p>输入分隔符，英文原文为field separator，此处简称为FS。awk默认以空白字符为分隔符对每一行进行分割。</p>
</li>
<li><p>输出分割符，英文原文为output field separator，此处简称为OFS。awk默认的输出分割符也是空格。</p>
</li>
</ul>
<h5 id="输入分隔符"><a href="#输入分隔符" class="headerlink" title="输入分隔符"></a>输入分隔符</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# cat test1</span><br><span class="line"><span class="meta">aaa#</span><span class="bash">dfa<span class="comment">#123#jkl;</span></span></span><br><span class="line"><span class="meta">aiew#</span><span class="bash">adkf<span class="comment">#alkdjf#asdjfj</span></span></span><br><span class="line"></span><br><span class="line">[root@test ~]# awk -F# '&#123;print $1,$2&#125;' test1</span><br><span class="line">aaa dfa</span><br><span class="line">aiew adkf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定默认分隔符为<span class="comment">#号，对文本进行分隔</span></span></span><br><span class="line"></span><br><span class="line">[root@test ~]# awk -v FS=# '&#123;print $1,$2&#125;' test1   </span><br><span class="line">aaa dfa</span><br><span class="line">aiew adkf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 还能够通过设置内部变量的方式，指定awk的输入分隔符，awk内置变量FS可以用于指定输入分隔符，但是在使用变量时，需要使用-v选项，用于指定对应的变量</span></span><br></pre></td></tr></table></figure>
<h5 id="输出分隔符"><a href="#输出分隔符" class="headerlink" title="输出分隔符"></a>输出分隔符</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当我们要对处理完的文本进行输出的时候，以什么文本或符号作为分隔符。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;print $1,$2&#125;' test</span><br><span class="line">abc 345</span><br><span class="line">123 klj</span><br><span class="line">[root@bogon ~]# awk -v OFS="+++" '&#123;print $1,$2&#125;' test</span><br><span class="line">abc+++345</span><br><span class="line">123+++klj</span><br><span class="line">[root@bogon ~]# awk -v OFS='+++' '&#123;print $1,$2&#125;' test</span><br><span class="line">abc+++345</span><br><span class="line">123+++klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加号两侧可以是单引号或双引号</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -v FS='#' -v OFS='---' '&#123;print $1,$2&#125;' test1</span><br><span class="line">aaa---dfa</span><br><span class="line">aiew---adkf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同时指定输入分隔符和输出分割符</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;print $1,$2&#125;' test</span><br><span class="line">abc 345</span><br><span class="line">123 klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 分开显示要使用逗号分隔两个变量</span></span><br><span class="line">[root@bogon ~]# awk '&#123;print $1 $2&#125;' test</span><br><span class="line">abc345</span><br><span class="line">123klj</span><br><span class="line">[root@bogon ~]# awk '&#123;print $1$2&#125;' test</span><br><span class="line">abc345</span><br><span class="line">123klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出不使用分隔符，打印在一起</span></span><br></pre></td></tr></table></figure>
<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><ul>
<li>“变量”又分为”内置变量” 和 “自定义变量” , “输入分隔符FS”和”输出分隔符OFS”都属于内置变量。内置变量就是awk预定义好的、内置在awk内部的变量，而自定义变量就是用户定义的变量。</li>
</ul>
<h5 id="内置变量NR"><a href="#内置变量NR" class="headerlink" title="内置变量NR"></a>内置变量NR</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在awk中，只有在引用<span class="variable">$0</span>、<span class="variable">$1</span>等内置变量的值的时候才会用到<span class="string">"$"</span>，引用其他变量时，不管是内置变量，还是自定义变量，都不使用<span class="string">"$"</span>，而是直接使用变量名。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk '&#123;print NR,NF&#125;' test</span><br><span class="line">1 5</span><br><span class="line">2 6</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印每一行的行号以及每一行对应的列的数量。内置变量NR表示每一行的行号，内置变量NF表示每一行中一共有几列</span></span><br><span class="line">[root@bogon ~]# awk '&#123;print NR,$0&#125;' test</span><br><span class="line">1 abc 345 ssd asdf lkj;l</span><br><span class="line">2 123 klj adf daff adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 先打印出行号，再打印出整行的内容</span></span><br></pre></td></tr></table></figure>
<h5 id="内置变量FNR"><a href="#内置变量FNR" class="headerlink" title="内置变量FNR"></a>内置变量FNR</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print NR,$0&#125;' test test1</span><br><span class="line">1 abc 345 ssd asdf lkj;l</span><br><span class="line">2 123 klj adf daff adeills adsfei</span><br><span class="line">3 aaa#dfa#123#jkl;</span><br><span class="line">4 aiew#adkf#alkdjf#asdjfj</span><br><span class="line"><span class="meta">#</span><span class="bash"> awk处理多个文件的时候，如果使用NR显示行号，那么，多个文件的所有行会按照顺序进行排序。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;print FNR,$0&#125;' test test1</span><br><span class="line">1 abc 345 ssd asdf lkj;l</span><br><span class="line">2 123 klj adf daff adeills adsfei</span><br><span class="line">1 aaa#dfa#123#jkl;</span><br><span class="line">2 aiew#adkf#alkdjf#asdjfj</span><br><span class="line"><span class="meta">#</span><span class="bash"> FNR变量可以在处理多个文件时分开显示行号。</span></span><br></pre></td></tr></table></figure>
<h5 id="内置变量RS"><a href="#内置变量RS" class="headerlink" title="内置变量RS"></a>内置变量RS</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print NR,$0&#125;' test</span><br><span class="line">1 abc 345 ssd asdf lkj;l</span><br><span class="line">2 123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk -v RS=" " '&#123;print NR,$0&#125;' test</span><br><span class="line">1 abc</span><br><span class="line">2 345</span><br><span class="line">3 ssd</span><br><span class="line">4 asdf</span><br><span class="line">5 lkj;l</span><br><span class="line">123</span><br><span class="line">6 klj</span><br><span class="line">7 adf</span><br><span class="line">8 daff</span><br><span class="line">9 adeills</span><br><span class="line">10 adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定空格为换行符并打印，第5行是因为<span class="built_in">test</span>文本中的第一行行尾和第二行开头之间没有空格，只有回车，所以打印成这个样子。</span></span><br></pre></td></tr></table></figure>
<h5 id="内置变量ORS"><a href="#内置变量ORS" class="headerlink" title="内置变量ORS"></a>内置变量ORS</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk  -v ORS='+++' '&#123;print NR,$0&#125;' test</span><br><span class="line">1 abc 345 ssd asdf lkj;l+++2 123 klj adf daff adeills adsfei+++[root@bogon ~]#</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定输出换行符，awk认为有+++号就是换行了，所以才打印成这个样子</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -v RS=" " -v ORS='+++' '&#123;print NR,$0&#125;' test</span><br><span class="line">1 abc+++2 345+++3 ssd+++4 asdf+++5 lkj;l</span><br><span class="line">123+++6 klj+++7 adf+++8 daff+++9 adeills+++10 adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一起使用输入输出换行符。</span></span><br></pre></td></tr></table></figure>
<h5 id="内置变量FILENAME"><a href="#内置变量FILENAME" class="headerlink" title="内置变量FILENAME"></a>内置变量FILENAME</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print FILENAME,FNR,$0&#125;' test test1</span><br><span class="line">test 1 abc 345 ssd asdf lkj;l</span><br><span class="line">test 2 123 klj adf daff adeills adsfei</span><br><span class="line">test1 1 aaa#dfa#123#jkl;</span><br><span class="line">test1 2 aiew#adkf#alkdjf#asdjfj</span><br><span class="line"><span class="meta">#</span><span class="bash"> FILENAME是为了显示文件名的。上面每行都打印了文件名，行号，文件内容</span></span><br></pre></td></tr></table></figure>
<h5 id="内置变量ARGC与ARGV"><a href="#内置变量ARGC与ARGV" class="headerlink" title="内置变量ARGC与ARGV"></a>内置变量ARGC与ARGV</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa",ARGV[1]&#125;' test test1</span><br><span class="line">aaa test</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa",ARGV[1],ARGV[2]&#125;' test test1</span><br><span class="line">aaa test test1</span><br><span class="line"><span class="meta">#</span><span class="bash"> ARGV内置变量表示的是一个数组。数组的索引都是从0开始的，所以，ARGV[1]表示引用ARGV数组中的第二个元素的值。命令后的文件名组成了这个数组，使用ARGV调用数组中的元素值，ARGV[1]对应的值为<span class="built_in">test</span>，ARGV[2]对应的值为test1，ARGV[0]对应的值为awk</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa",ARGV[0]&#125;' test</span><br><span class="line">aaa awk</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa",ARGV[0],ARGV[1],ARGV[2],ARGC&#125;' test test1</span><br><span class="line">aaa awk test test1 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在上面的例子中，应该有三个参数，awk、<span class="built_in">test</span>、test1，这三个参数作为数组的元素存放于ARGV中，而ARGC则表示参数的数量，也可以理解为ARGV数组的长度。</span></span><br></pre></td></tr></table></figure>
<h5 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 自定义变量方法</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法一：-v varname=value  变量名区分字符大小写。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法二：在program中直接定义。</span></span><br><span class="line"></span><br><span class="line">* 方法一</span><br><span class="line">[root@bogon ~]# awk -v myVar="testVar" 'BEGIN&#123;print myVar&#125;'</span><br><span class="line">testVar</span><br><span class="line"></span><br><span class="line">* 方法二</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;myvar="ttt";print myvar&#125;'</span><br><span class="line">ttt</span><br><span class="line"><span class="meta">#</span><span class="bash"> ttt两侧一定要使用双引号，不能使用单引号。分号两侧有没有空格都可以。</span></span><br><span class="line"></span><br><span class="line">* 一次定义多个变量</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;myvar1="111";myvar2="222";print myvar1,myvar2&#125;'</span><br><span class="line">111 222</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# abc=123</span><br><span class="line">[root@bogon ~]# awk -v myvar=$abc 'BEGIN&#123;print myvar&#125;'</span><br><span class="line">123</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要在awk中引用shell中的变量的时候，可以通过方法一间接的引用。</span></span><br></pre></td></tr></table></figure>
<h4 id="printf命令"><a href="#printf命令" class="headerlink" title="printf命令"></a>printf命令</h4><ul>
<li>printf命令的作用是按照我们指定的格式输出文本。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 语法</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">printf</span> <span class="string">"指定的格式"</span> <span class="string">"文本1"</span> <span class="string">"文本2"</span> <span class="string">"文本3"</span> ......</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# echo abc</span><br><span class="line">abc</span><br><span class="line">[root@bogon ~]# printf abc</span><br><span class="line">abc[root@bogon ~]#</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span>命令会对输出的文本进行换行，而<span class="built_in">printf</span>命令则不会对输出的文本进行换行</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# echo -e "abc \ndef \njkl \ndfj"</span><br><span class="line">abc </span><br><span class="line">def </span><br><span class="line">jkl </span><br><span class="line">dfj</span><br><span class="line">[root@bogon ~]# printf "abc \ndef \njkl \ndfj \n"</span><br><span class="line">abc </span><br><span class="line">def </span><br><span class="line">jkl </span><br><span class="line">dfj</span><br><span class="line">[root@bogon ~]# printf "%s\n" abc def jkl dfj</span><br><span class="line">abc</span><br><span class="line">def</span><br><span class="line">jkl</span><br><span class="line">dfj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 前两种方法要使用转义符\n进行换行。第三条命令中的每一个<span class="string">"文本"</span>都会被当做参数项传入<span class="built_in">printf</span>命令，而每个被传入的参数都会按照指定的<span class="string">"格式"</span>被<span class="string">"格式化"</span>。<span class="string">"%s\n"</span>就是格式，而后面的每一段字符串，都被当做参数传入到了<span class="built_in">printf</span>命令中，并按照我们指定的格式进行了格式化。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %s是<span class="string">"格式替换符"</span>。使用<span class="string">"%s"</span>代替传入的每一个参数，上面命令中的参数就是abc def jkl dfj，如果我们指定的格式为<span class="string">"%s\n"</span>，当abc被当做参数传入<span class="built_in">printf</span>命令时，<span class="built_in">printf</span>就会把<span class="string">"%s\n"</span>中的%s替换成abc，于是，abc就变成了我们指定的格式<span class="string">"abc\n"</span>，最终<span class="built_in">printf</span>输出的就是格式化后的<span class="string">"abc\n"</span>，以此类推，每一段文本都被当做一个参数传入<span class="built_in">printf</span>命令，然后按照指定的格式输出了。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# printf "%s\n" 1 11 213 11123</span><br><span class="line">1</span><br><span class="line">11</span><br><span class="line">213</span><br><span class="line">11123</span><br><span class="line">[root@bogon ~]# printf "%f\n" 1 11 213 11123</span><br><span class="line">1.000000</span><br><span class="line">11.000000</span><br><span class="line">213.000000</span><br><span class="line">11123.000000</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"%f"</span>也代替了每一个传入的参数，它会将每一个传入的参数转换成<span class="string">"浮点类型"</span></span></span><br><span class="line"></span><br><span class="line">* 格式替换符</span><br><span class="line"><span class="meta">#</span><span class="bash"> %s 字符串</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %f 浮点格式（也就是我们概念中的<span class="built_in">float</span>或者double）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %b 相对应的参数中包含转义字符时，可以使用此替换符进行替换，对应的转义字符会被转义。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %c ASCII字符。显示相对应参数的第一个字符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %d, %i 十进制整数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %o 不带正负号的八进制值</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %u 不带正负号的十进制值</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %x 不带正负号的十六进制值，使用a至f表示10至15</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %X 不带正负号的十六进制值，使用A至F表示10至15</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %% 表示<span class="string">"%"</span>本身</span></span><br><span class="line"></span><br><span class="line">* printf常用的转义符</span><br><span class="line"><span class="meta">#</span><span class="bash"> \a 警告字符，通常为ASCII的BEL字符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \b 后退</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \c 抑制（不显示）输出结果中任何结尾的换行字符（只在%b格式指示符控制下的参数字符串中有效），而且，任何留在参数里的字符、任何接下来的参数以及任何留在格式字符串中的字符，都被忽略</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \f 换页（formfeed）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \n 换行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \r 回车（Carriage <span class="built_in">return</span>）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \t 水平制表符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \v 垂直制表符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \\ 一个字面上的反斜杠字符，即<span class="string">"\"本身。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \ddd 表示1到3位数八进制值的字符，仅在格式字符串中有效</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \0ddd 表示1到3位的八进制值字符</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# printf "( %s ) " 1 23 234 23423;echo ""</span><br><span class="line">( 1 ) ( 23 ) ( 234 ) ( 23423 )</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为每个传入的参数添加一对<span class="string">"括号"</span>，并且括号内侧需要有空格。最后的<span class="built_in">echo</span>命令是为了换行</span></span><br><span class="line">[root@bogon ~]# printf "%s\t" 1 23 234 23423;echo</span><br><span class="line">1	23	234	23423</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"制表符"</span>隔开每个参数，<span class="built_in">echo</span>后不加引号也可以</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# printf "%s %s\n" a b df ad e r</span><br><span class="line">a b</span><br><span class="line">df ad</span><br><span class="line">e r</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定的<span class="string">"格式"</span>中所包含的<span class="string">"格式替换符"</span>的数量，就代表每次格式化的参数的数量，每个<span class="string">"格式替换符"</span>与参数都是一一对应的</span></span><br><span class="line">[root@bogon ~]# printf "%s %s %s\n" a b c d e f </span><br><span class="line">a b c</span><br><span class="line">d e f</span><br><span class="line">[root@bogon ~]# printf "%s %s %s\n" 姓名 性别 年龄 董鹏 男 29 少松 女 39</span><br><span class="line">姓名 性别 年龄</span><br><span class="line">董鹏 男 29</span><br><span class="line">少松 女 39</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面的年龄与其上面的标题没有对齐</span></span><br><span class="line">[root@bogon ~]# printf "%7s %5s %4s\n" 姓名 性别 年龄 董鹏 男 29 少松 女 39</span><br><span class="line"> 姓名 性别 年龄</span><br><span class="line"> 董鹏   男   29</span><br><span class="line"> 少松   女   39</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在原来的<span class="string">"格式替换符"</span>中间加入了特定的数字，可以使输出的文字向右对齐。如果想向左对齐，就将数字改为负数，如：%-9s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果使用%+9s，表示给后面对应的参数前加一个+号。</span></span><br><span class="line">[root@bogon ~]# printf "aaa fff\n";printf "%-9s %-12f \n" abc 123.123123 bbb 2312.12345</span><br><span class="line">aaa fff</span><br><span class="line">abc       123.123123   </span><br><span class="line">bbb       2312.123450</span><br><span class="line">[root@bogon ~]# printf "aaa fff\n";printf "%-9s %-12.2f \n" abc 123.123123 bbb 2312.12345</span><br><span class="line">aaa fff</span><br><span class="line">abc       123.12       </span><br><span class="line">bbb       2312.12 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一条命令的数字修饰符为12，表示对应的替换符<span class="string">"%f"</span>的输出宽度为12个字符，第二条命令的数字修饰符为12.2 ，表示对应的替换符<span class="string">"%f"</span>的输出宽度为12个字符，并且小数点的精度为2。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# printf "aaa fff\n";printf "%-9s %-12d \n" abc 123 bbb 2312</span><br><span class="line">aaa fff</span><br><span class="line">abc       123          </span><br><span class="line">bbb       2312 </span><br><span class="line">[root@bogon ~]# printf "aaa fff\n";printf "%-9s %-12.4d \n" abc 123 bbb 2312</span><br><span class="line">aaa fff</span><br><span class="line">abc       0123         </span><br><span class="line">bbb       2312</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当格式替换符为<span class="string">"%d"</span>时，如果数字修饰符带有小数点，则数字修饰符小数点后的数字表示整数的长度，长度不够时，高位用0补全</span></span><br></pre></td></tr></table></figure>
<h4 id="printf动作"><a href="#printf动作" class="headerlink" title="printf动作"></a>printf动作</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print $1&#125;' test</span><br><span class="line">abc</span><br><span class="line">123</span><br><span class="line">[root@bogon ~]# awk '&#123;printf $1&#125;' test</span><br><span class="line">abc123[root@bogon ~]#</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">printf</span>动作不会自动换行</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;printf "%s\n",$1&#125;' test</span><br><span class="line">abc</span><br><span class="line">123</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用格式替换符，不要忘记<span class="variable">$1</span>前面的逗号</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;printf "%s\n",1,2,3,4,5&#125;'</span><br><span class="line">1</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;printf "%s\n%s\n%s\n%s\n%s\n",1,2,3,4,5&#125;'</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在awk中，格式替换符的数量必须与传入的参数的数量相同。也就是格式替换符必须与需要格式化的参数一一对应。不可以像使用<span class="built_in">printf</span>命令一样，一个格式替换符可以反复使用。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="built_in">printf</span>动作注意事项</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. 使用<span class="built_in">printf</span>动作输出的文本不会换行，如果需要换行，可以在对应的<span class="string">"格式替换符"</span>后加入<span class="string">"\n"</span>进行转义。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 使用<span class="built_in">printf</span>动作时，<span class="string">"指定的格式"</span> 与 <span class="string">"被格式化的文本"</span> 之间，需要用<span class="string">"逗号"</span>隔开。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 使用<span class="built_in">printf</span>动作时，<span class="string">"格式"</span>中的<span class="string">"格式替换符"</span>必须与 <span class="string">"被格式化的文本"</span> 一一对应。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;printf "第一列： %s 第二列： %s\n",$1,$2&#125;' test</span><br><span class="line">第一列： abc 第二列： 345</span><br><span class="line">第一列： 123 第二列： klj</span><br><span class="line">[root@bogon ~]# awk -v FS="#" '&#123;printf "第一列： %s 第二列： %s\n",$1,$2&#125;' test1</span><br><span class="line">第一列： aaa 第二列： dfa</span><br><span class="line">第一列： aiew 第二列： adkf</span><br><span class="line">[root@bogon ~]# awk -v FS=":" 'BEGIN&#123;printf "%-10s\t %s\n","用户名称","用户ID"&#125;&#123;printf "%-10s\t %s\n",$1,$3&#125;' /etc/passwd</span><br><span class="line">用户名称      	 用户ID</span><br><span class="line">root      	 0</span><br><span class="line">bin       	 1</span><br><span class="line">daemon    	 2</span><br><span class="line">adm       	 3</span><br><span class="line">lp        	 4</span><br><span class="line">sync      	 5</span><br><span class="line">shutdown  	 6</span><br><span class="line">halt      	 7</span><br><span class="line">mail      	 8</span><br><span class="line">operator  	 11</span><br><span class="line">games     	 12</span><br><span class="line">ftp       	 14</span><br><span class="line">nobody    	 99</span><br><span class="line">systemd-network	 192</span><br><span class="line">dbus      	 81</span><br><span class="line">polkitd   	 999</span><br><span class="line">postfix   	 89</span><br><span class="line">sshd      	 74</span><br><span class="line">openvpn   	 998</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/16/iptables动作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/16/iptables动作/" itemprop="url">
                  iptables动作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-16 09:01:54" itemprop="dateCreated datePublished" datetime="2018-10-16T09:01:54+08:00">2018-10-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 13:55:59" itemprop="dateModified" datetime="2019-01-15T13:55:59+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>“动作”与”匹配条件”一样，也有”基础”与”扩展”之分。同样，使用扩展动作也需要借助扩展模块，但是，扩展动作可以直接使用，不用像使用”扩展匹配条件”那样指定特定的模块。</p>
</blockquote>
<h4 id="REJECT"><a href="#REJECT" class="headerlink" title="REJECT"></a>REJECT</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 常用选项为--reject-with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可用值如下:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-net-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-host-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-port-unreachable,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-proto-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-net-prohibited</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-host-pro-hibited</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-admin-prohibited</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当不设置任何值时，默认值为icmp-port-unreachable。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# iptables -I INPUT -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">[root@localhost ~]# iptables -I INPUT -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝所有主机访问本机</span></span><br><span class="line">[root@localhost ~]# ping 10.5.5.90</span><br><span class="line">PING 10.5.5.90 (10.5.5.90) 56(84) bytes of data.</span><br><span class="line">From 10.5.5.90 icmp_seq=1 Destination Port Unreachable</span><br><span class="line">From 10.5.5.90 icmp_seq=2 Destination Port Unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时用其他主机ping本机提示是“Destination Port Unreachable”</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line">[root@localhost ~]# iptables -A INPUT -j REJECT --reject-with icmp-host-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改提示信息为“icmp-host-unreachable”</span></span><br><span class="line">[root@localhost ~]# ping 10.5.5.90</span><br><span class="line">PING 10.5.5.90 (10.5.5.90) 56(84) bytes of data.</span><br><span class="line">From 10.5.5.90 icmp_seq=1 Destination Host Unreachable</span><br><span class="line">From 10.5.5.90 icmp_seq=2 Destination Host Unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用其他主机ping本机时提示已改为“Destination Host Unreachable”</span></span><br></pre></td></tr></table></figure>
<h4 id="LOG"><a href="#LOG" class="headerlink" title="LOG"></a>LOG</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用LOG动作，可以将符合条件的报文的相关信息记录到日志中，但当前报文具体是被<span class="string">"接受"</span>，还是被<span class="string">"拒绝"</span>，都由后面的规则控制</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> --<span class="built_in">log</span>-level选项可以指定记录日志的日志级别，可用级别有emerg，alert，crit，error，warning，notice，info，debug。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --<span class="built_in">log</span>-prefix选项可以给记录到的相关信息添加<span class="string">"标签"</span>之类的信息，以便区分各种记录到的报文信息，方便在分析时进行过滤。--<span class="built_in">log</span>-prefix对应的值不能超过29个字符。</span></span><br><span class="line"></span><br><span class="line">* 基本设置</span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -j LOG</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上述规则表示所有发往22号端口的tcp报文都符合条件，所以都会被记录到日志中，查看/var/<span class="built_in">log</span>/messages即可看到对应报文的相关信息。但是上述规则只是用于示例，因为上例中使用的匹配条件过于宽泛。所以在使用LOG动作时，匹配条件应该尽量写的精确一些，匹配到的报文数量也会大幅度的减少，这样冗余的日志信息就会变少，同时日后分析日志时，日志中的信息可用程度更高。</span></span><br><span class="line">[root@localhost ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 48 packets, 4200 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1          46     3296 LOG        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22 LOG flags 0 level 4</span><br><span class="line">[root@localhost ~]# tail -f /var/log/messages </span><br><span class="line">Oct 16 17:27:36 localhost kernel: IN=eno16777736 OUT= MAC=00:0c:29:45:17:9b:50:7b:9d:65:f9:ff:08:00 SRC=10.5.5.23 DST=10.5.5.90 LEN=40 TOS=0x00 PREC=0x00 TTL=64 ID=2314 DF PROTO=TCP SPT=51108 DPT=22 WINDOW=16243 RES=0x00 ACK URGP=0 </span><br><span class="line">Oct 16 17:27:37 localhost kernel: IN=eno16777736 OUT= MAC=00:0c:29:45:17:9b:50:7b:9d:65:f9:ff:08:00 SRC=10.5.5.23 DST=10.5.5.90 LEN=92 TOS=0x00 PREC=0x00 TTL=64 ID=2323 DF PROTO=TCP SPT=51108 DPT=22 WINDOW=16243 RES=0x00 ACK PSH URGP=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> LOG动作默认会将报文的相关信息记录在/var/<span class="built_in">log</span>/message文件中</span></span><br><span class="line">[root@localhost ~]# vim /etc/rsyslog.conf</span><br><span class="line">	kern.warning /var/log/iptables.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入上面一行，让iptables将日志记录在其他位置	</span></span><br><span class="line">[root@localhost ~]# systemctl restart rsyslog</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启日志服务</span></span><br><span class="line"></span><br><span class="line">* --log-prefix</span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -m state --state NEW -j LOG --log-prefix "want-in-from-port-22"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将主动连接22号端口的报文的相关信息都记录到日志中，并且把这类记录命名为<span class="string">"want-in-from-port-22"</span></span></span><br><span class="line">[root@localhost ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 44 packets, 3150 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 LOG        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22 state NEW LOG flags 0 level 4 prefix "want-in-from-port-22"</span><br><span class="line">[root@localhost ~]# tail -f /var/log/iptables.log </span><br><span class="line">Oct 16 17:41:08 localhost kernel: want-in-from-port-22IN=eno16777736 OUT= MAC=00:0c:29:45:17:9b:00:0c:29:96:6b:bf:08:00 SRC=10.5.5.91 DST=10.5.5.90 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=7879 DF PROTO=TCP SPT=42102 DPT=22 WINDOW=14600 RES=0x00 SYN URGP=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用其他主机连接本机时会有相关记录。这条日志中包含<span class="string">"标签"</span>：want-in-from-port-22，如果有很多日志记录，我们就能通过这个<span class="string">"标签"</span>进行筛选了，这样方便我们查看日志，同时，从上述记录中还能够得知报文的源IP与目标IP，源端口与目标端口等信息，从上述日志我们能够看出，10.5.5.91这个IP想要在17:41:08连接到10.5.5.91（当前主机的IP）的22号端口，报文由eno16777736网卡进入，eno16777736网卡的MAC地址为00:0c:29:45:17:9b，客户端网卡的mac地址为00:0c:29:96:6b:bf。</span></span><br></pre></td></tr></table></figure>
<h4 id="测试源地址与目标地址转换"><a href="#测试源地址与目标地址转换" class="headerlink" title="测试源地址与目标地址转换"></a>测试源地址与目标地址转换</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 准备四台主机，一台主机为公网主机，一台为防火墙，两台为内网主机。使用公网主机通过防火墙访问内网linux服务器。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A 公网主机IP：10.5.5.90</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> B 防火墙IP：10.5.5.91、192.168.116.129</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> C 内网linux服务器IP：192.168.116.130</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> D 内网windows主机IP：192.168.116.131</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将主机C和D的网关都指向B的内网地址，主机A和B的公网地址是桥接到宿主机的网卡上，打开B防火墙的路由功能ip_forward，在A和C主机上启动httpd服务。</span></span><br></pre></td></tr></table></figure>
<h5 id="SNAT"><a href="#SNAT" class="headerlink" title="SNAT"></a>SNAT</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t nat -A POSTROUTING -s 192.168.116.0/24 -j SNAT --to-source 10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加规则，让内网主机经过防火墙出去时的地址都改为防火墙的外网地址。<span class="string">"-t nat"</span>表示操作nat表。filter表的功能是过滤，nat表的功能就是地址转换，所以我们需要在nat表中定义nat规则。<span class="string">"-A POSTROUTING"</span>表示将SNAT规则添加到POSTROUTING链的末尾，在centos7中，SNAT规则只能存在于POSTROUTING链与INPUT链中，在centos6中，SNAT规则只能存在于POSTROUTING链中。<span class="string">"-j SNAT"</span>表示使用SNAT动作，对匹配到的报文进行处理，对匹配到的报文进行源地址转换。<span class="string">"--to-source 10.5.5.91"</span>表示将匹配到的报文的源IP修改为10.5.5.91</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在centos7中，SNAT规则也可以定义在INPUT链中，我们可以这样理解，发往本机的报文经过INPUT链以后报文就到达了本机，如果再不修改报文的源地址，就没有机会修改了。</span></span><br><span class="line">[root@localhost ~]# iptables -t nat --line -nvxL</span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 SNAT       all  --  *      *       192.168.116.0/24     0.0.0.0/0            to:10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置上面的规则后就可以ping通外网主机了</span></span><br><span class="line">* A</span><br><span class="line">[root@localhost ~]# tcpdump -i eno16777736 -nn icmp</span><br><span class="line">18:41:22.375035 IP 10.5.5.91 &gt; 10.5.5.90: ICMP echo request, id 14189, seq 17, length 64</span><br><span class="line">18:41:22.375090 IP 10.5.5.90 &gt; 10.5.5.91: ICMP echo reply, id 14189, seq 17, length 64</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时在主机A上抓包，用C主机ping主机A，可以看到是10.5.5.91发来的数据。在主机C上也可以看到是主机A返回的信息。在C主机上抓包也可以看到是外网主机返回的信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在A主机上不要添加到内网的路由，这样，在防火墙没有添加SNAT规则时，内网是不能ping通外网的，当添加了SNAT规则后，内网主机就可以ping通外网了</span></span><br></pre></td></tr></table></figure>
<h5 id="DNAT"><a href="#DNAT" class="headerlink" title="DNAT"></a>DNAT</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t nat -I PREROUTING -d 10.5.5.91 -p tcp --dport 3389 -j DNAT --to-destination 192.168.116.131:3389</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入一条规则，在PREROUTING链上，目标地址是防火墙的外网地址，端口是3389。目标地址转换为内网地址192.168.116.131:3389。实际就是地址与端口映射，将外网的地址与端口映射为内网的地址与端口</span></span><br><span class="line">[root@localhost ~]# iptables -t nat --line -nvxL</span><br><span class="line">Chain PREROUTING (policy ACCEPT 18 packets, 2657 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           1       52 DNAT       tcp  --  *      *       0.0.0.0/0            10.5.5.91            tcp dpt:3389 to:192.168.116.131:3389</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 18 packets, 2657 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 1 packets, 52 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           6      904 SNAT       all  --  *      *       192.168.116.0/24     0.0.0.0/0            to:10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置内网windows主机可以远程访问，之后用本机远程连接10.5.5.91，也就是防火墙地址，这时是可以连接到内网主机192.168.116.131上的。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 理论上只配置DNAT规则即可，但是如果在测试时无法正常DNAT，可以尝试配置对应的SNAT，此处按照配置SNAT的流程进行。SNAT规则与上面是一样的，就是将内网的主机出去的地址都改为防火墙的地址。</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -t nat -I PREROUTING -d 10.5.5.91 -p tcp --dport 8080 -j DNAT --to-destination 192.168.116.130:80</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加一条端口映射，将外网的8080端口映射到内网的80端口上</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这次，我们不用再次定义SNAT规则了，因为之前已经定义过SNAT规则，上次定义的SNAT规则只要定义一次就行，而DNAT规则则需要根据实际的情况去定义。</span></span><br></pre></td></tr></table></figure>
<h4 id="MASQUERADE"><a href="#MASQUERADE" class="headerlink" title="MASQUERADE"></a>MASQUERADE</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当我们拨号网上时，每次分配的IP地址往往不同，不会长期分给我们一个固定的IP地址，如果这时，我们想要让内网主机共享公网IP上网，就会很麻烦，因为每次IP地址发生变化以后，我们都要重新配置SNAT规则，这样显得不是很人性化，我们通过MASQUERADE即可解决这个问题，MASQUERADE会动态的将源地址转换为可用的IP地址，其余与SNAT实现的功能完全一致，都是修改源地址，只不过SNAT需要指明将报文的源地址改为哪个IP，而MASQUERADE则不用指定明确的IP，会动态的将报文的源地址修改为指定网卡上可用的IP地址</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -t nat -I POSTROUTING -s 192.168.116.0/24 -o eno16777736 -j MASQUERADE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过外网网卡出去的报文在经过POSTROUTING链时，会自动将报文的源地址修改为外网网卡上可用的IP地址，这时，即使外网网卡中的公网IP地址发生了改变，也能够正常的、动态的将内部主机的报文的源IP映射为对应的公网IP。可以把MASQUERADE理解为动态的、自动化的SNAT，如果没有动态SNAT的需求，没有必要使用MASQUERADE，因为SNAT更加高效。</span></span><br></pre></td></tr></table></figure>
<h4 id="REDIRECT"><a href="#REDIRECT" class="headerlink" title="REDIRECT"></a>REDIRECT</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用REDIRECT动作可以在本机上进行端口映射</span></span><br><span class="line">[root@localhost ~]# iptables -t nat -A PREROUTING -p tcp --dport 19000 -j REDIRECT --to-ports 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将本机的22端口映射到本机的19000端口上。REDIRECT规则只能定义在PREROUTING链或者OUTPUT链中。</span></span><br><span class="line">[root@template network-scripts]# ssh 192.168.1.14 -p 19000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在另一台主机连接测试</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">90</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">67</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
