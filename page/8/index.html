<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/8/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/05/CentOS优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/05/CentOS优化/" itemprop="url">
                  CentOS优化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-03-05 11:29:58 / 修改時間：13:02:35" itemprop="dateCreated datePublished" datetime="2019-03-05T11:29:58+08:00">2019-03-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="文件句柄数"><a href="#文件句柄数" class="headerlink" title="文件句柄数"></a>文件句柄数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 临时调整</span><br><span class="line">[root@template ~]# ulimit -n</span><br><span class="line">1024</span><br><span class="line">[root@template ~]# ulimit -n 65535</span><br><span class="line">[root@template ~]# ulimit -n</span><br><span class="line">65535</span><br><span class="line"></span><br><span class="line">* 永久生效</span><br><span class="line">[root@template ~]# vim /etc/security/limits.conf</span><br><span class="line">*       soft    nofile          65535</span><br><span class="line">*       hard    nofile          65535</span><br></pre></td></tr></table></figure>
<h3 id="调整历史记录及连接超时"><a href="#调整历史记录及连接超时" class="headerlink" title="调整历史记录及连接超时"></a>调整历史记录及连接超时</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@template ~]# vim /etc/bashrc</span><br><span class="line">HISTFILESIZE=4000</span><br><span class="line">HISTSIZE=4000</span><br><span class="line">HISTTIMEFORMAT='%F %T '</span><br><span class="line">export HISTTIMEFORMAT</span><br><span class="line"><span class="meta">#</span> 添加上面四行。HISTFILESIZE定义了.bash_history中保存命令的总数，默认是1000，这里改成了4000，HISTSIZE设置了history命令输出最多的记录总数，HISTTIMEFORMAT定了时间显示格式。</span><br><span class="line"><span class="meta">#</span>以前的操作记录都会显示更改/etc/bashrc文件的时间，而不是真正的操作时间，只有更改完/etc/bashrc以后的操作记录会显示正确的时间</span><br><span class="line">export TMOUT=10</span><br><span class="line"><span class="meta">#</span> 置连接会话的超时时间</span><br></pre></td></tr></table></figure>
<h3 id="同步时间"><a href="#同步时间" class="headerlink" title="同步时间"></a>同步时间</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 查看时区</span><br><span class="line">[root@template ~]# cat /etc/sysconfig/clock </span><br><span class="line">ZONE="Asia/Shanghai"</span><br><span class="line"></span><br><span class="line">* 同步时间</span><br><span class="line">[root@template ~]# ntpdate cn.pool.ntp.org</span><br><span class="line">[root@template ~]#crontab -e</span><br><span class="line">0 10 * * * /usr/sbin/ntpdate cn.pool.ntp.org</span><br></pre></td></tr></table></figure>
<h3 id="调整yum源"><a href="#调整yum源" class="headerlink" title="调整yum源"></a>调整yum源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp CentOS-Base.repo&#123;,.$(date +%F)&#125;</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure>
<h3 id="更改SSH服务端远程登录的配置"><a href="#更改SSH服务端远程登录的配置" class="headerlink" title="更改SSH服务端远程登录的配置"></a>更改SSH服务端远程登录的配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@template ~]# cp /etc/ssh/sshd_config&#123;,.bak&#125;</span><br><span class="line">[root@template ~]# vim /etc/ssh/sshd_config</span><br><span class="line">Port 52113           </span><br><span class="line"><span class="meta">#</span> ssh连接默认的端口</span><br><span class="line">PermitRootLogin no   </span><br><span class="line"><span class="meta">#</span> 禁止root登录</span><br><span class="line">PermitEmptyPasswords no </span><br><span class="line"><span class="meta">#</span> 禁止空密码登录，此项默认就是no</span><br><span class="line">UseDNS no            </span><br><span class="line"><span class="meta">#</span> 不使用DNS解析地址</span><br><span class="line">[root@template ~]# /etc/init.d/sshd restart</span><br></pre></td></tr></table></figure>
<h3 id="锁定关键系统文件"><a href="#锁定关键系统文件" class="headerlink" title="锁定关键系统文件"></a>锁定关键系统文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@template ~]# chattr +i /etc/passwd /etc/inittab /etc/group /etc/shadow /etc/gshadow</span><br><span class="line"><span class="meta">#</span> attr命令用于改变文件属性，i选项表示不得任意更动文件或目录。这时创建用户或组的命令执行也会失败。</span><br><span class="line">[root@template ~]# ll /etc/gshadow</span><br><span class="line">---------- 1 root root 631 1月  18 18:38 /etc/gshadow</span><br><span class="line">[root@template ~]# ll /etc/shadow</span><br><span class="line">---------- 1 root root 1259 1月  18 18:40 /etc/shadow</span><br><span class="line">[root@template ~]# chattr -i /etc/shadow</span><br><span class="line"><span class="meta">#</span> 使用-i可以解锁</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/15/python概念及语法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/15/python概念及语法/" itemprop="url">
                  python概念及语法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-02-15 18:05:02" itemprop="dateCreated datePublished" datetime="2019-02-15T18:05:02+08:00">2019-02-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-24 11:22:42" itemprop="dateModified" datetime="2019-06-24T11:22:42+08:00">2019-06-24</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="编译器与解释器"><a href="#编译器与解释器" class="headerlink" title="编译器与解释器"></a>编译器与解释器</h4><blockquote>
<p><strong>编译器</strong>是把源程序的每一条语句都编译成机器语言,并保存成二进制文件,这样运行时计算机可以直接以机器语言来运行此程序,速度很快；它把源代码转换成目标机器的CPU指令</p>
<p>而<strong>解释器</strong>则是只在执行程序时,才一条一条的解释成机器语言给计算机来执行,所以运行速度是不如编译后的程序运行的快的。解释后转换成字节码，运行在虚拟机上，解释器执行中间代码。</p>
<p>这是因为计算机不能直接认识并执行我们写的语句,它只能认识机器语言(是二进制的形式)。</p>
</blockquote>
<h4 id="编译型语言与解释型语言"><a href="#编译型语言与解释型语言" class="headerlink" title="编译型语言与解释型语言"></a>编译型语言与解释型语言</h4><blockquote>
<ul>
<li><p>编译型<br>优点：编译器一般会有预编译的过程对代码进行优化。因为编译只做一次，运行时不需要编译，所以编译型语言的程序执行效率高。可以脱离语言环境独立运行。<br>缺点：编译之后如果需要修改就需要整个模块重新编译。编译的时候根据对应的运行环境生成机器码，不同的操作系统之间移植就会有问题，需要根据运行的操作系统环境编译不同的可执行文件。</p>
</li>
<li><p>解释型<br>优点：有良好的平台兼容性，在任何环境中都可以运行，前提是安装了解释器（虚拟机）。灵活，修改代码的时候直接修改就可以，可以快速部署，不用停机维护。</p>
<p>缺点：每次运行的时候都要解释一遍，性能上不如编译型语言。</p>
</li>
</ul>
</blockquote>
<h4 id="低级语言与高级语言"><a href="#低级语言与高级语言" class="headerlink" title="低级语言与高级语言"></a>低级语言与高级语言</h4><blockquote>
<ul>
<li><p>低级语言</p>
<p>面向机器的语言，包括机器语言、汇编语言</p>
<p>不同的机器不能通用，不同的机器需要不同的机器指令或者汇编程序</p>
</li>
<li><p>高级语言</p>
<p>接近自然语言和数学语言的计算机语言</p>
<p>高级语言首先要书写源程序，通过编译程序把源程序转换成机器指令的程序</p>
<p>人们只需要关心怎么书写源程序，针对不同机器的编译的事交给编译器处理</p>
</li>
</ul>
<p>语言越高级，越接近人类的自然语言和数学语言。语言越低级，越能让机器理解。高级语言和低级语言之间需要一个转换的工具，就是编译器或解释器。</p>
</blockquote>
<h4 id="动态语言和静态语言"><a href="#动态语言和静态语言" class="headerlink" title="动态语言和静态语言"></a>动态语言和静态语言</h4><blockquote>
<ul>
<li><p>动态类型语言：动态类型语言是指在运行期间才去做数据类型检查的语言，也就是说，在用动态类型的语言编程时，永远也不用给任何变量指定数据类型，该语言会在你第一次赋值给变量时，在内部将数据类型记录下来。Python和Ruby就是一种典型的动态类型语言，其他的各种脚本语言如VBScript也多少属于动态类型语言。</p>
</li>
<li><p>静态类型语言：静态类型语言与动态类型语言刚好相反，它的数据类型是在编译其间检查的，也就是说在写程序时要声明所有变量的数据类型，C/C++是静态类型语言的典型代表，其他的静态类型语言还有C#、JAVA等。</p>
</li>
</ul>
</blockquote>
<h4 id="强类型定义语言和弱类型定义语言"><a href="#强类型定义语言和弱类型定义语言" class="headerlink" title="强类型定义语言和弱类型定义语言"></a>强类型定义语言和弱类型定义语言</h4><blockquote>
<ul>
<li>强类型语言：不同类型之间操作，必须先强制类型转换为同一类型。print(‘a’+1)</li>
<li>弱类型语言：不同类型间可以操作，自动隐式转换，JavaScript中console.log(1+’a’)</li>
</ul>
</blockquote>
<h3 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h3><blockquote>
<ul>
<li><p>注释：# 标注的文本</p>
</li>
<li><p>数字：</p>
<ul>
<li>整数，不区分long和int。可使用二进制、十进制、十六进制。bool(布尔)有两个值True和False</li>
<li>浮点数：1.2、3.1415、-0.12、1.46e9等价于1.46*10的9次方</li>
<li>复数：1+2j</li>
</ul>
</li>
<li><p>字符串：</p>
<ul>
<li>使用’ “ 单双引号引用的字符的序列</li>
<li>‘’’和””” 单双三引号，可以跨行、可以在其中自由的使用单双引号</li>
<li>在字符串前面加上r或R前缀，表示该字符串不做特殊的处理</li>
</ul>
</li>
<li><p>转义序列</p>
<ul>
<li>\\    \t    \r    \n    \‘    \“</li>
<li>前缀r，把里面的所有字符当普通字符对待</li>
</ul>
</li>
<li><p>缩进</p>
<ul>
<li>未使用C等语言的花括号，而是采用缩进的方式表示层次关系</li>
<li>约定使用4个空格缩进</li>
</ul>
</li>
<li><p>续行</p>
<ul>
<li>在行尾使用\</li>
<li>如果使用各种括号，认为括号内是一个整体，内部跨行不用\</li>
</ul>
</li>
<li><p>标识符</p>
<ol>
<li>一个名字，用来指代一个值</li>
<li>只能字母、下划线和数字</li>
<li>只能以字母或下划线开头</li>
<li>不能是python的关键字，如def、class就不能作为标识符</li>
<li>python是大小写敏感的</li>
</ol>
<ul>
<li>约定：<ul>
<li>不允许使用中文</li>
<li>不允许使用歧义单词，如class_</li>
<li>在python中不要随便使用下划线开头的表示符</li>
</ul>
</li>
</ul>
</li>
<li><p>常量</p>
<ul>
<li>一旦赋值就不能改变值的标识符</li>
<li>python中无法定义常量</li>
</ul>
</li>
<li><p>字面常量</p>
<ul>
<li>一个单独的量，如12、”abc”、’234531.03e-9’</li>
</ul>
</li>
<li><p>变量</p>
<ul>
<li>赋值后，可以改变值的标识符</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><h4 id="算数运算符"><a href="#算数运算符" class="headerlink" title="算数运算符"></a>算数运算符</h4><table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>两个对象相加</td>
<td>a + b输出结果30</td>
</tr>
<tr>
<td>-</td>
<td>得到负数或是一个数减去另一个数</td>
<td>a - b输出结果-10</td>
</tr>
<tr>
<td>*</td>
<td>两个数相乘或是返回一个被重复若干次的字符串</td>
<td>a * b输出结果200</td>
</tr>
<tr>
<td>/</td>
<td>x除以y</td>
<td>b / a输出结果2</td>
</tr>
<tr>
<td>%</td>
<td>返回除法的余数</td>
<td>b % a输出结果0</td>
</tr>
<tr>
<td>**</td>
<td>返回x的y次幂</td>
<td>a ** b为10的20次方，输出结果1000000000000000000</td>
</tr>
<tr>
<td>//</td>
<td>返回商的整数部分</td>
<td>9 // 2输出结果4，9.0//2.0输出结果4.0</td>
</tr>
</tbody>
</table>
<h4 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h4><table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>==</td>
<td>比较两个对象是否相等</td>
<td>(a == b)返回False</td>
</tr>
<tr>
<td>!=</td>
<td>比较两个对象是否不等</td>
<td>(a != b)返回true</td>
</tr>
<tr>
<td>&lt;&gt;</td>
<td>比较两个对象是否不等</td>
<td>(a &lt;&gt; b)返回true。这个运算符类似!=</td>
</tr>
<tr>
<td>&gt;</td>
<td>返回x是否大于y，返回一个bool值</td>
<td>(a &gt; b)返回False；4&gt;3&gt;2或4&gt;mynumber&gt;=1是链式比较操作符</td>
</tr>
<tr>
<td>&lt;</td>
<td>返回x是否小于y。所有比较运算符返回1表示真，返回0表示假。这分别与特殊的变量True和False等价。注意，这些变量名的大写。</td>
<td>(a &lt; b)返回true</td>
</tr>
<tr>
<td>&gt;=</td>
<td>返回x是否大于等于y</td>
<td>(a &gt;= b)返回False</td>
</tr>
<tr>
<td>&lt;=</td>
<td>返回x是否小于等于y</td>
<td>(a &lt;= b)返回true</td>
</tr>
</tbody>
</table>
<h4 id="赋值运算符"><a href="#赋值运算符" class="headerlink" title="赋值运算符"></a>赋值运算符</h4><table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td>简单的赋值运算符</td>
<td>c = a+b将a + b的运算结果赋值为c</td>
</tr>
<tr>
<td>+=</td>
<td>加法赋值运算符</td>
<td>c += a等效于c = c + a</td>
</tr>
<tr>
<td>-=</td>
<td>减法赋值运算符</td>
<td>c -= a等效于c = c - a</td>
</tr>
<tr>
<td>*=</td>
<td>乘法赋值运算符</td>
<td>c *= a等效于c = c * a</td>
</tr>
<tr>
<td>/=</td>
<td>除法赋值运算符</td>
<td>c /= a等效于c = c / a</td>
</tr>
<tr>
<td>%=</td>
<td>取模赋值运算符</td>
<td>c %= a等效于c = c % a</td>
</tr>
<tr>
<td>**=</td>
<td>幂赋值运算符</td>
<td>c **= a等效于c = c ** a</td>
</tr>
<tr>
<td>//=</td>
<td>取整除赋值运算符</td>
<td>c //= a等效于c = c // a</td>
</tr>
</tbody>
</table>
<h4 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h4><blockquote>
<p>短路运算符，可以把and当作乘法，把or当作加法，非是取反。and 如果第一个表达式为False，后面就没有必要计算了，这个逻辑表达式一定是False；or 如果第一个表达式为True，后面没有必要计算了，这个逻辑表达式一定是True</p>
</blockquote>
<table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>and</td>
<td>布尔“与”，如果x为False，x and y返回False，否则它返回y的计算值</td>
<td>(a and b)返回true</td>
</tr>
<tr>
<td>or</td>
<td>布尔“或”，如果x是True，它返回True，否则它返回y的计算值</td>
<td>(a or b)返回true</td>
</tr>
<tr>
<td>not</td>
<td>布尔“非”，如果x为True，返回False。如果x为False，它返回True</td>
<td>not(a and b)返回false</td>
</tr>
</tbody>
</table>
<h4 id="成员运算符"><a href="#成员运算符" class="headerlink" title="成员运算符"></a>成员运算符</h4><table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>in</td>
<td>如果在指定的序列中找到值返回True，否则返回False</td>
<td>x在y序列中，如果x在y序列中返回True</td>
</tr>
<tr>
<td>not in</td>
<td>如果在指定的序列中没有找到值返回True，否则返回False</td>
<td>x不在y序列中，如果x不在y序列中返回True</td>
</tr>
</tbody>
</table>
<h4 id="身份运算符"><a href="#身份运算符" class="headerlink" title="身份运算符"></a>身份运算符</h4><table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>is</td>
<td>is是判断两个标识符是不是引用自一个对象</td>
<td>x is y，如果id(x)等于id(y)，is返回结果1</td>
</tr>
<tr>
<td>is not</td>
<td>is not是判断两个标识符是不是引用自不同对象</td>
<td>x is not y，如果id(x)不等于id(y)，is not返回结果1</td>
</tr>
</tbody>
</table>
<h4 id="位运算符"><a href="#位运算符" class="headerlink" title="位运算符"></a>位运算符</h4><table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>&amp;</td>
<td>按位与运算符</td>
<td>(a &amp; b)输出结果12，二进制解释：0000 1100。只有1和1相与得1，其他相与都是0</td>
</tr>
<tr>
<td>I</td>
<td>按位或运算符</td>
<td>(a I b)输出结果61，二进制解释：0011 1101</td>
</tr>
<tr>
<td>^</td>
<td>按位异或运算符</td>
<td>(a ^ b)输出结果49，二进制解释：0011 0001</td>
</tr>
<tr>
<td>~</td>
<td>按位取反运算符</td>
<td>(~a)输出结果-61，二进制解释：1100 0011，在一个有符号二进制数的补码形式</td>
</tr>
<tr>
<td>&lt;&lt;</td>
<td>左移动运算符</td>
<td>a &lt;&lt; 2输出结果240，二进制解释：1111 0000</td>
</tr>
<tr>
<td>&gt;&gt;</td>
<td>右移动运算符</td>
<td>a &gt;&gt; 2输出结果15，二进制解释：0000 1111</td>
</tr>
</tbody>
</table>
<h4 id="运算符优先级"><a href="#运算符优先级" class="headerlink" title="运算符优先级"></a>运算符优先级</h4><blockquote>
<p>算数运算符 &gt; 位运算符 &gt; 身份运算符 &gt; 成员运算符 &gt; 逻辑运算符</p>
<p>记不住，就用小括号</p>
<p>长表达式，多用括号，易懂、易读</p>
</blockquote>
<h4 id="原码、反码、补码、负数表示法"><a href="#原码、反码、补码、负数表示法" class="headerlink" title="原码、反码、补码、负数表示法"></a>原码、反码、补码、负数表示法</h4><blockquote>
<ul>
<li><p>原码</p>
<p>5 =&gt; 0b101，1 =&gt; 0b1，-1 =&gt; -0b1，bin(-1)</p>
</li>
<li><p>反码</p>
<p>正数的反码与原码相同；负数的反码符号位不变其余按位取反</p>
</li>
<li><p>补码</p>
<p>正数的补码与原码相同；负数的补码符号位不变其余按位取反后+1；补码的补码就是原码</p>
</li>
<li><p>负数表示法</p>
<p>数字电路的CPU中的运算器实现了加法器，但是没有减法器，减法是转换成加法</p>
<p>负数在计算机中使用补码存储，-1的补码为1111 1111</p>
<p>5 - 1 =&gt; 5+(-1)直觉上是0b101-0b1，其实计算机中是0b101+0b11111111，溢出位舍弃</p>
</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">例：<span class="number">5</span><span class="number">-1</span>保存为二进制</span><br><span class="line"><span class="number">0000</span> <span class="number">0101</span>		</span><br><span class="line"><span class="comment"># 5的二进制。原码是人比较习惯的方式，-0b1中的负号表示转换为二进制数字时在最高位是0还是1，1表示负号，0表示正号。-0b1是python中的写法。-0b1也就是原码</span></span><br><span class="line"><span class="number">1111</span> <span class="number">1111</span>		</span><br><span class="line"><span class="comment"># -1的二进制，因为计算机中保存的都是补码，而正数的原码与补码一样，所以上面的5不会变。-1的二进制是1000 0001，转换为补码后，除最高位的符号位不变外，还要加1，就是1111 1110 + 1，所以最后就是1111 1111</span></span><br><span class="line"><span class="number">1</span> <span class="number">0000</span> <span class="number">0100</span></span><br><span class="line"><span class="comment"># 这是5和-1的二进制相加后的结果，因为最高位的1溢出了，所以舍弃，最后就变成了0000 0100，也就是4了</span></span><br><span class="line"></span><br><span class="line">例：~<span class="number">12</span>为什么是<span class="number">-13</span></span><br><span class="line"><span class="number">0000</span> <span class="number">1100</span></span><br><span class="line"><span class="comment"># 这是12的二进制</span></span><br><span class="line"><span class="number">1111</span> <span class="number">0011</span></span><br><span class="line"><span class="comment"># 这是对12的二进制取反后的数，但最高位是1表示负数，并且保存在计算机中的应该是数字的补码，所以要取这个负数的补码</span></span><br><span class="line"><span class="number">1000</span> <span class="number">1101</span></span><br><span class="line"><span class="comment"># 这是对上面二进制数取的补码，因为上面表示负数，所以按照最高位不变最后加1的原则，取出的二进制数就是这个数，转换为十进制数就是-13了。</span></span><br></pre></td></tr></table></figure>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><blockquote>
<p>变量无须事先声明，也不需要指定类型</p>
<p>编程中一般无须关心变量的存亡，也不用关心内存的管理</p>
<p>python使用引用 计数记录所有对象的引用数。当对象引用数变为0,它就可以被垃圾回收（GC）了。</p>
<p>计数增加：赋值给其它变量就增加引用计数，例如：x=3;y=x</p>
<p>计数减少：函数运行结束时，局部变量就会被自动销毁，对象引用计数减少。变量被赋值给其它对象。例如：x=3;y=x;x=4</p>
</blockquote>
<h3 id="程序控制"><a href="#程序控制" class="headerlink" title="程序控制"></a>程序控制</h3><blockquote>
<ul>
<li><p>顺序</p>
<p>按照先后顺序一条条执行</p>
</li>
<li><p>分支</p>
<p>根据不同的情况判断，条件满足执行某条件下的语句</p>
</li>
<li><p>循环</p>
<p>条件满足就反复执行，不满足就不执行或不再执行</p>
</li>
</ul>
</blockquote>
<h4 id="单分支结构"><a href="#单分支结构" class="headerlink" title="单分支结构"></a>单分支结构</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>语句</span><br><span class="line"><span class="keyword">if</span> condition:</span><br><span class="line">		代码块</span><br><span class="line"><span class="comment"># condition必须是一个bool类型，这个地方有一个隐式转换bool(condition)</span></span><br><span class="line"><span class="keyword">if</span> <span class="number">1</span> &lt; <span class="number">2</span>:</span><br><span class="line">		print(<span class="string">'1 less than 2'</span>)</span><br><span class="line"><span class="comment"># 代码块：类似于if语句的冒号后面的就是一个语句块	</span></span><br><span class="line"></span><br><span class="line">=======================================================================================</span><br><span class="line">真值表</span><br><span class="line"><span class="string">""</span>						   假</span><br><span class="line"><span class="string">"string"</span>			 真</span><br><span class="line"><span class="number">0</span>							假</span><br><span class="line">&gt;=<span class="number">1</span>						 真</span><br><span class="line">&lt;=<span class="number">-1</span>					 真</span><br><span class="line">()空元组			  假</span><br><span class="line">[]空列表			  假</span><br><span class="line">&#123;&#125;空字典			  假</span><br><span class="line"><span class="keyword">None</span>				  假</span><br><span class="line">=======================================================================================</span><br></pre></td></tr></table></figure>
<h4 id="三目运算"><a href="#三目运算" class="headerlink" title="三目运算"></a>三目运算</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">语法：真值if条件else假值</span><br><span class="line">x if(x&gt;y) else y</span><br><span class="line">print((x if (x&gt;y) else y) if ((x if (x&gt;y) else y)&gt;z) else z)</span><br></pre></td></tr></table></figure>
<h4 id="多分支结构"><a href="#多分支结构" class="headerlink" title="多分支结构"></a>多分支结构</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>...<span class="keyword">elif</span>...<span class="keyword">else</span>语句</span><br><span class="line"><span class="keyword">if</span> condition1:</span><br><span class="line">		代码块<span class="number">1</span></span><br><span class="line"><span class="keyword">elif</span> condition2:</span><br><span class="line">		代码块<span class="number">2</span></span><br><span class="line"><span class="keyword">elif</span> condition3:</span><br><span class="line">		代码块<span class="number">3</span></span><br><span class="line"><span class="meta">... </span>...</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">		代码块</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">a = <span class="number">5</span></span><br><span class="line"><span class="keyword">if</span> a &lt; <span class="number">0</span>:</span><br><span class="line">		print(<span class="string">'negative'</span>)</span><br><span class="line"><span class="keyword">elif</span> a == <span class="number">0</span>:</span><br><span class="line">		print(<span class="string">'zero'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">		print(<span class="string">'positive'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="分支嵌套"><a href="#分支嵌套" class="headerlink" title="分支嵌套"></a>分支嵌套</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">例：</span><br><span class="line">score = <span class="number">80</span></span><br><span class="line"><span class="keyword">if</span> score &lt; <span class="number">0</span>:</span><br><span class="line">		print(<span class="string">'wrong'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">if</span> sore == <span class="number">0</span>:</span><br><span class="line">				print(<span class="string">'egg'</span>)</span><br><span class="line">		<span class="keyword">elif</span> score &lt;= <span class="number">100</span>:</span><br><span class="line">				print(<span class="string">'right'</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">				print(<span class="string">'too big'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> condition:</span><br><span class="line">		block</span><br><span class="line"><span class="comment"># 当条件满足即condition为True，进入循环体，执行block</span></span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">flag = <span class="number">10</span></span><br><span class="line"><span class="keyword">while</span> flag:</span><br><span class="line">		print(flag)</span><br><span class="line">		flag -= <span class="number">1</span></span><br><span class="line"><span class="comment"># lag是标记，while flag也就是while为真，flag会递减，等flag等于0时，while就会退出循环了</span></span><br><span class="line"><span class="comment"># while true是死循环，因为条件永远为真，不会变成假。如果 改为-10也会是死循环，可以使用return退出死循环</span></span><br></pre></td></tr></table></figure>
<h4 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> iteratable:</span><br><span class="line">		block</span><br><span class="line"><span class="comment"># 当可迭代对象中有元素可以迭代，进入循环体，执行block</span></span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">		print(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment"># range()函数类似seq命令，range(10)可以输出从0到9，共10个数字</span></span><br><span class="line"><span class="comment"># iteratable表示迭代的，element表示元素。</span></span><br><span class="line"></span><br><span class="line">In [1]: range?                                                                  </span><br><span class="line">Init signature: range(self, /, *args, **kwargs)</span><br><span class="line">Docstring:     </span><br><span class="line">range(stop) -&gt; range object</span><br><span class="line">range(start, stop[, step]) -&gt; range object</span><br><span class="line"></span><br><span class="line">Return an object that produces a sequence of integers <span class="keyword">from</span> start (inclusive)</span><br><span class="line">to stop (exclusive) by step.  range(i, j) produces i, i+<span class="number">1</span>, i+<span class="number">2</span>, ..., j<span class="number">-1.</span></span><br><span class="line">start defaults to <span class="number">0</span>, <span class="keyword">and</span> stop <span class="keyword">is</span> omitted!  range(<span class="number">4</span>) produces <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3.</span></span><br><span class="line">These are exactly the valid indices <span class="keyword">for</span> a list of <span class="number">4</span> elements.</span><br><span class="line">When step <span class="keyword">is</span> given, it specifies the increment (<span class="keyword">or</span> decrement).</span><br><span class="line">Type:           type</span><br><span class="line">Subclasses:     </span><br><span class="line"><span class="comment"># range?可以查看帮助</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>,<span class="number">5</span>): </span><br><span class="line">   ...:     print(i) </span><br><span class="line">   ...:                                                                         </span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="comment"># 只会输出3和4</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">6</span>,<span class="number">2</span>): </span><br><span class="line">   ...:     print(i) </span><br><span class="line">   ...:                                                                         </span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="comment"># 还可以加上步长</span></span><br></pre></td></tr></table></figure>
<h4 id="循环continue语句"><a href="#循环continue语句" class="headerlink" title="循环continue语句"></a>循环continue语句</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">中断当前循环的当次执行，继续下一次循环</span><br><span class="line">例：</span><br><span class="line">In [<span class="number">7</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>): </span><br><span class="line">   ...:     <span class="keyword">if</span> <span class="keyword">not</span> i%<span class="number">2</span>: </span><br><span class="line">   ...:         print(i) </span><br><span class="line">   ...:                                                                         </span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="comment"># 这里会打印偶数是因为range中的数字与2取余后，如果是0就表示假，1表示真，但取余前加了not，所以假就变成了真，所以打印的是偶数，如果不加not，那么就会打印所有奇数。</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10</span>,<span class="number">2</span>): </span><br><span class="line">   ...:     print(i) </span><br><span class="line">   ...:                                                                         </span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="comment"># 直接使用range()函数就可以打印奇偶数</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">10</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10</span>): </span><br><span class="line">    ...:     <span class="keyword">if</span> i &amp; <span class="number">1</span>: </span><br><span class="line">    ...:         <span class="keyword">continue</span> </span><br><span class="line">    ...:     print(i) </span><br><span class="line">    ...:                                                                        </span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="comment"># range()函数内的数字和1按位与，如果为真，也就是1，就会中断当前循环，如果为假就会打印i</span></span><br></pre></td></tr></table></figure>
<h4 id="循环break语句"><a href="#循环break语句" class="headerlink" title="循环break语句"></a>循环break语句</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">终止当前循环，跳出循环</span><br><span class="line">例：计算<span class="number">1000</span>以内的被<span class="number">7</span>整除的前<span class="number">20</span>个数（<span class="keyword">for</span>循环）</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">1000</span>,<span class="number">7</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> count == <span class="number">20</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># range必须从0开始，如果从1开始，那么永远到不了7的整数倍。但这样也会打印0</span></span><br></pre></td></tr></table></figure>
<h4 id="continue和break语句总结"><a href="#continue和break语句总结" class="headerlink" title="continue和break语句总结"></a>continue和break语句总结</h4><blockquote>
<ul>
<li>continue和break是循环的控制语句，只影响当前循环，包括while、for循环</li>
<li>如果循环嵌套，continue和break也只影响语句所在的那一层循环</li>
<li>continue和break不是跳出语句块，所以if cond: break不是跳出if，而是终止if外的break所在的循环</li>
</ul>
</blockquote>
<h4 id="循环else子句"><a href="#循环else子句" class="headerlink" title="循环else子句"></a>循环else子句</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果循环正常的执行结束，就执行else子句；如果使用break终止，else子句不会执行</span></span><br><span class="line"><span class="keyword">while</span> condition:</span><br><span class="line">		block</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">		block</span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> iteratable:</span><br><span class="line">    	block</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    	block</span><br></pre></td></tr></table></figure>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 输入<span class="number">2</span>个数字，输出最大数</span><br><span class="line">a = input(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">b = input(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line"><span class="keyword">while</span> a == b:</span><br><span class="line">    print(<span class="string">'请重新输入'</span>)</span><br><span class="line">    a = input(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">    b = input(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">    <span class="keyword">if</span> a &gt; b:</span><br><span class="line">        print(a)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(b)</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 给定一个不超过<span class="number">5</span>位的正整数，判断其有几位</span><br><span class="line"><span class="comment"># 使用input函数，例：input函数获取键盘输入，input([prompt])。input()是内建函数，返回的是字符串。下划线在ipython中是一个特殊的字符，表示上一次output的结果。</span></span><br><span class="line">a = int(input(<span class="string">'&gt;&gt;&gt;'</span>))</span><br><span class="line"><span class="keyword">if</span> a // <span class="number">100000</span>:</span><br><span class="line">    print(<span class="string">'6位数'</span>)</span><br><span class="line"><span class="keyword">elif</span> a // <span class="number">10000</span>:</span><br><span class="line">    print(<span class="string">'5位数'</span>)</span><br><span class="line"><span class="keyword">elif</span> a // <span class="number">1000</span>:</span><br><span class="line">    print(<span class="string">'4位数'</span>)</span><br><span class="line"><span class="keyword">elif</span> a // <span class="number">100</span>:</span><br><span class="line">    print(<span class="string">'3位数'</span>)</span><br><span class="line"><span class="keyword">elif</span> a // <span class="number">10</span>:</span><br><span class="line">    print(<span class="string">'2位数'</span>)</span><br><span class="line"><span class="keyword">elif</span> a // <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">'1位数'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="number">3.</span> 给定一个不超过<span class="number">5</span>位的正整数，判断该数的位数，依次打印出个位、十位、百位、千位、万位的数字</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 打印一个连长为n的正方形</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> 求<span class="number">100</span>内所有奇数的和(<span class="number">2500</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> 判断学生成绩，成绩等级A~E。其中，<span class="number">90</span>分以上为A，<span class="number">80</span>～<span class="number">89</span>分为B，<span class="number">70</span>～<span class="number">79</span>分为C，<span class="number">60</span>～<span class="number">69</span>分为D，<span class="number">60</span>分以下为E</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span> 求<span class="number">1</span>到<span class="number">5</span>阶乘之和</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span> 给一个数，判断它是否是素数（质数）。质数：一个大于<span class="number">1</span>的自然数只能被<span class="number">1</span>和它本身整除</span><br><span class="line"></span><br><span class="line"><span class="number">9.</span> 打印九九乘法表</span><br><span class="line"></span><br><span class="line"><span class="number">10.</span> 打印菱形</span><br><span class="line"></span><br><span class="line"><span class="number">11.</span> 打印<span class="number">100</span>以内的斐波那契数列</span><br><span class="line"></span><br><span class="line"><span class="number">12.</span> 求斐波那契数列第<span class="number">101</span>项</span><br><span class="line"></span><br><span class="line"><span class="number">13.</span> 求<span class="number">10</span>万内的所有素数</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/31/puppet的master-agent认证/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/31/puppet的master-agent认证/" itemprop="url">
                  puppet的master&agent认证
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-31 22:06:41" itemprop="dateCreated datePublished" datetime="2019-01-31T22:06:41+08:00">2019-01-31</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-01 12:53:02" itemprop="dateModified" datetime="2019-02-01T12:53:02+08:00">2019-02-01</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/编排工具/" itemprop="url" rel="index"><span itemprop="name">编排工具</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="mastar-amp-agent"><a href="#mastar-amp-agent" class="headerlink" title="mastar&amp;agent"></a>mastar&amp;agent</h3><h4 id="手动注册"><a href="#手动注册" class="headerlink" title="手动注册"></a>手动注册</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line">===========================================================================================</span><br><span class="line">手动注册是由Agent端先发起证书申请请求，然后由Puppetserver端确认，方可注册成功，这种注册方式安全系数中等，逐一注册（puppet cert --sign certnmame）在节点数量较大的情况下是比较麻烦的，效率也低，批量注册(puppet cert --sign --all)效率很高，一次性便可注册所有的Agent的请求，但是这种方式安全系数较低，因为错误的请求也会被注册上。</span><br><span class="line"></span><br><span class="line">环境</span><br><span class="line">master：192.168.1.70</span><br><span class="line">agent1：192.168.1.71</span><br><span class="line">agent2：192.168.1.72</span><br><span class="line">===========================================================================================</span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@puppet ~]# hostnamectl set-hostname master.ruopu.com</span><br><span class="line">[root@master ~]# vim /etc/hosts</span><br><span class="line">192.168.1.70 master.ruopu.com</span><br><span class="line">192.168.1.71 node1.ruopu.com</span><br><span class="line">192.168.1.72 node2.ruopu.com</span><br><span class="line">[root@master ~]# rsync -e ssh -arvz --progress /etc/hosts 192.168.1.71:/etc</span><br><span class="line">[root@master ~]# rsync -e ssh -arvz --progress /etc/hosts 192.168.1.72:/etc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 主机名的修改非常重要，必须做。让三台主机可以互相解析</span></span><br><span class="line">[root@puppet ~]# yum install -y puppt puppet-server facter tree</span><br><span class="line">[root@puppet ~]# vim /etc/puppet/puppet.conf</span><br><span class="line">[main]</span><br><span class="line">    logdir = /var/log/puppet		# 默认日志存放路径</span><br><span class="line">    rundir = /var/run/puppet		# pid存放路径</span><br><span class="line">    ssldir = $vardir/ssl		 # 证书存放目录，默认$vardir为/var/lib/puppet</span><br><span class="line">[agent]</span><br><span class="line">    classfile = $vardir/classes.txt</span><br><span class="line">    localconfig = $vardir/localconfig</span><br><span class="line">    server = master.ruopu.com		# 设置agent认证连接master端的服务器名称，注意这个名字必须能够被节点解析</span><br><span class="line">    certname = master.ruopu.com		# 设置agent端certname名称</span><br><span class="line">[master]</span><br><span class="line">    certname = master.ruopu.com		# 设置puppetmaster认证服务器名</span><br><span class="line">[root@puppet ~]# touch /etc/puppet/manifests/site.pp</span><br><span class="line">[root@puppet ~]# systemctl start puppetmaster </span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动服务端，自动生成CA证书，并签署。</span></span><br><span class="line">[root@master ~]# ss -tln</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128        *:8140                   *:*   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听在8140端口</span></span><br><span class="line">[root@puppet ~]# tree /var/lib/puppet/ssl/</span><br><span class="line">/var/lib/puppet/ssl/</span><br><span class="line">├── ca</span><br><span class="line">│   ├── ca_crl.pem</span><br><span class="line">│   ├── ca_crt.pem</span><br><span class="line">│   ├── ca_key.pem</span><br><span class="line">│   ├── ca_pub.pem</span><br><span class="line">│   ├── inventory.txt</span><br><span class="line">│   ├── private</span><br><span class="line">│   │   └── ca.pass</span><br><span class="line">│   ├── requests</span><br><span class="line">│   ├── serial</span><br><span class="line">│   └── signed</span><br><span class="line">│       └── master.ruopu.com.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到，signed中已经有服务端了，证明服务器已被认证</span></span><br><span class="line">[root@puppet ~]# puppet cert --list --all</span><br><span class="line">+ "master.ruopu.com" (SHA256) B5:A8:47:D4:FE:4E:FE:AC:5E:48:A2:C0:CF:7E:CB:1D:B9:03:26:8F:1F:66:6B:9A:29:E3:C7:39:E0:5E:D6:E0 (alt names: "DNS:master.ruopu.com", "DNS:puppet", "DNS:puppet.ruopu.com")</span><br><span class="line"><span class="meta">#</span><span class="bash"> 有加号的证明是已被认证的主机</span></span><br><span class="line">[root@puppet ~]# tail -f /var/log/puppet/masterhttp.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听日志</span></span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">  agent1&amp;2</span><br><span class="line">---------------</span><br><span class="line">[root@puppettest1 ~]# hostnamectl set-hostname node1.ruopu.com</span><br><span class="line">[root@puppettest1 ~]# yum install -y puppet facter</span><br><span class="line">[root@node1 ~]# vim /etc/puppet/puppet.conf </span><br><span class="line">[main]</span><br><span class="line">    logdir = /var/log/puppet</span><br><span class="line">    rundir = /var/run/puppet</span><br><span class="line">    ssldir = $vardir/ssl</span><br><span class="line">[agent]</span><br><span class="line">    classfile = $vardir/classes.txt</span><br><span class="line">    localconfig = $vardir/localconfig</span><br><span class="line">    server = master.ruopu.com		# 指向puppetmaster端</span><br><span class="line">    certname = node1.ruopu.com		# 设置自己的certname名</span><br><span class="line">    listen = true		# 让puppet监听8139端口 </span><br><span class="line">[root@node1 ~]# vim /etc/puppet/auth.conf</span><br><span class="line">path /run</span><br><span class="line">method save</span><br><span class="line">auth any</span><br><span class="line">allow master.ruopu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在文件尾部path /的上方加入上面内容</span></span><br><span class="line">[root@puppettest1 ~]# systemctl start puppetagent</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动客户端</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@master ~]# puppet cert --list --all</span><br><span class="line">  "node1.ruopu.com"  (SHA256) F8:DF:B8:26:AE:92:5D:26:96:D9:21:AE:92:3F:84:40:6F:65:3F:B5:D0:C7:27:AC:12:44:E3:87:09:6B:19:0D</span><br><span class="line">+ "master.ruopu.com" (SHA256) B5:A8:47:D4:FE:4E:FE:AC:5E:48:A2:C0:CF:7E:CB:1D:B9:03:26:8F:1F:66:6B:9A:29:E3:C7:39:E0:5E:D6:E0 (alt names: "DNS:master.ruopu.com", "DNS:puppet", "DNS:puppet.ruopu.com")</span><br><span class="line"><span class="meta">#</span><span class="bash">  这时可以看到客户端的请求，没有加号</span></span><br><span class="line">[root@master ~]# puppet cert --sign --all</span><br><span class="line">Notice: Signed certificate request for node1.ruopu.com</span><br><span class="line">Notice: Removing file Puppet::SSL::CertificateRequest node1.ruopu.com at '/var/lib/puppet/ssl/ca/requests/node1.ruopu.com.pem'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 签署请求</span></span><br><span class="line">[root@master ~]# puppet cert --list --all</span><br><span class="line">+ "master.ruopu.com" (SHA256) B5:A8:47:D4:FE:4E:FE:AC:5E:48:A2:C0:CF:7E:CB:1D:B9:03:26:8F:1F:66:6B:9A:29:E3:C7:39:E0:5E:D6:E0 (alt names: "DNS:master.ruopu.com", "DNS:puppet", "DNS:puppet.ruopu.com")</span><br><span class="line">+ "node1.ruopu.com"  (SHA256) DC:8F:2C:D6:0C:97:6B:F7:1B:A6:48:55:E9:D9:3A:AA:C7:C5:C2:89:86:0E:45:C8:22:68:4B:B7:39:4B:B9:D3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 已被认证</span></span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">  agent1&amp;2</span><br><span class="line">---------------</span><br><span class="line">[root@node1 ~]# ss -tln</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128        *:8139                   *:* </span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以看到客户端监听在8139端口了，在认证后需要等待一会儿才会监听地址。</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@master ~]# puppet kick --all</span><br><span class="line">Warning: Puppet kick is deprecated. See http://links.puppetlabs.com/puppet-kick-deprecation</span><br><span class="line">Warning: Failed to load ruby LDAP library. LDAP functionality will not be available</span><br><span class="line">Finished</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试推送是否成功</span></span><br><span class="line">[root@master ~]# cd /etc/puppet/modules/</span><br><span class="line">[root@master modules]# mkdir -pv &#123;jdk8,tomcat,nginx&#125;/&#123;manifests,files,templates,lib,spec,tests&#125;</span><br><span class="line">[root@master modules]# yum install -y nginx tomcat java-1.8.0-openjdk-devel</span><br><span class="line">[root@master modules]# vim /etc/nginx/nginx.conf</span><br><span class="line">		location / &#123;</span><br><span class="line">           proxy_pass http://192.168.1.72:8080;</span><br><span class="line">        &#125;</span><br><span class="line">[root@master modules]# cp /etc/nginx/nginx.conf /etc/puppet/modules/nginx/files/</span><br><span class="line">[root@master modules]# cp /etc/tomcat/server.xml /etc/puppet/modules/tomcat/files/</span><br><span class="line">[root@master modules]# vim nginx/manifests/init.pp</span><br><span class="line">class nginx &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      name =&gt; 'nginx',</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">   &#125;</span><br><span class="line">   file&#123;'nginx.conf':</span><br><span class="line">      path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">      source =&gt; "puppet:///modules/nginx/nginx.conf",</span><br><span class="line">   &#125;</span><br><span class="line">   service&#123;'nginx':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">   Package['nginx'] -&gt; File['nginx.conf'] ~&gt; Service['nginx']</span><br><span class="line">&#125;</span><br><span class="line">[root@master modules]# vim tomcat/manifests/init.pp</span><br><span class="line">class tomcat &#123;</span><br><span class="line">   package&#123;['tomcat','tomcat-webapps','tomcat-admin-webapps','tomcat-docs-we</span><br><span class="line">bapp']:		# 安装多个包要用这种定义方式</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">   &#125; -&gt;</span><br><span class="line">   file&#123;'server.xml':</span><br><span class="line">      path =&gt; '/etc/tomcat/server.xml',</span><br><span class="line">      source =&gt; 'puppet:///modules/tomcat/server.xml',</span><br><span class="line">   &#125; ~&gt;</span><br><span class="line">   service&#123;'tomcat':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@master modules]# vim jdk8/manifests/init.pp</span><br><span class="line">class jdk8 &#123;</span><br><span class="line">   package&#123;'jdk8':</span><br><span class="line">      name =&gt; 'java-1.8.0-openjdk-devel',</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">   &#125;</span><br><span class="line">   file&#123;'java.sh':</span><br><span class="line">      path =&gt; '/etc/profile.d/java.sh',</span><br><span class="line">      source =&gt; "puppet:///modules/jdk8/java.sh",</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@master modules]# vim jdk8/files/java.sh</span><br><span class="line">export JAVA_HOME=/usr</span><br><span class="line">[root@master modules]# cd /etc/puppet/manifests/</span><br><span class="line">[root@master manifests]# vim site.pp		# 定义主机清单</span><br><span class="line">node 'node1.test.com' &#123;</span><br><span class="line">   include nginx</span><br><span class="line">&#125;</span><br><span class="line">node 'node2.test.com' &#123;</span><br><span class="line">   include jdk8</span><br><span class="line">   include tomcat</span><br><span class="line">&#125;</span><br><span class="line">[root@master manifests]# puppet module list</span><br><span class="line">/etc/puppet/modules</span><br><span class="line">├── jdk8 (???)</span><br><span class="line">├── nginx (???)</span><br><span class="line">└── tomcat (???)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看上面定义的三个模块tomcat、nginx、jdk8是否加载</span></span><br><span class="line">[root@master modules]# puppet kick --all</span><br><span class="line">Warning: Puppet kick is deprecated. See http://links.puppetlabs.com/puppet-kick-deprecation</span><br><span class="line">Warning: Failed to load ruby LDAP library. LDAP functionality will not be available</span><br><span class="line">Finished</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提醒所有客户端进行同步，如果是单个主机，可以写为客户端的主机名，如node1.ruopu.com，不能写为node1，因为不是主机名，所以推送不过去。也可以写多个主机名，主机名之间用空格分隔。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个推送的过程很慢，测试中一起推送非常慢，使用了单个主机的推送</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  agent1</span><br><span class="line">-------------</span><br><span class="line">[root@node1 ~]# rpm -q nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到安装了nginx</span></span><br><span class="line">[root@node1 ~]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务也启动了</span></span><br><span class="line">[root@node1 ~]# vim /etc/nginx/nginx.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件也被修改了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个过程有些慢，需要在服务端推送后等一会儿才会生效。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===========================================================================================</span><br><span class="line">客户端认证出现问题或推送失败的解决方法</span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@puppet ~]# puppet cert --clean node1.ruopu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务端使用此命令将某个主机的认证清除</span></span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">  agent</span><br><span class="line">----------</span><br><span class="line">[root@puppettest1 ~]# systemctl stop puppetagent</span><br><span class="line"><span class="meta">#</span><span class="bash"> 先停止服务</span></span><br><span class="line">[root@puppettest1 ~]# rm -rf /var/lib/puppet/ssl/*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除所有密钥</span></span><br><span class="line">[root@puppettest1 ~]# systemctl start puppetagent</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再启动</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@puppet ~]# puppet cert --list --all</span><br><span class="line">[root@puppet ~]# puppet cert --sign --all </span><br><span class="line"><span class="meta">#</span><span class="bash"> 签署认证</span></span><br><span class="line">[root@puppet ~]# tail -f /var/log/puppet/masterhttp.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看日志</span></span><br><span class="line">[root@puppet ~]# tree /var/lib/puppet/ssl/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看认证</span></span><br><span class="line">===========================================================================================</span><br></pre></td></tr></table></figure>
<h4 id="自动注册"><a href="#自动注册" class="headerlink" title="自动注册"></a>自动注册</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">============================================================================================</span><br><span class="line">这种注册方式简单来讲是通过Puppetmaster端的ACL列表进行控制的，安全系统较低，也就是说符合预先定义的ACL列表中的所有节点请求不需要确认都会被自动注册上，也就是说你只需要知道ACL列表要求，其次能和PuppetMaster端通信便可轻易注册成功。当然，它的最大优点就是效率非常高。</span><br><span class="line">============================================================================================</span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@master modules]# puppet cert --clean node2.ruopu.com</span><br><span class="line">Notice: Revoked certificate with serial 5</span><br><span class="line">Notice: Removing file Puppet::SSL::Certificate node2.ruopu.com at '/var/lib/puppet/ssl/ca/signed/node2.ruopu.com.pem'</span><br><span class="line">Notice: Removing file Puppet::SSL::Certificate node2.ruopu.com at '/var/lib/puppet/ssl/certs/node2.ruopu.com.pem'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除PuppetMaster端已经注册的agent2的证书</span></span><br><span class="line">[root@master modules]# puppet cert --list --all</span><br><span class="line">+ "master.ruopu.com" (SHA256) B5:A8:47:D4:FE:4E:FE:AC:5E:48:A2:C0:CF:7E:CB:1D:B9:03:26:8F:1F:66:6B:9A:29:E3:C7:39:E0:5E:D6:E0 (alt names: "DNS:master.ruopu.com", "DNS:puppet", "DNS:puppet.ruopu.com")</span><br><span class="line">+ "node1.ruopu.com"  (SHA256) DC:8F:2C:D6:0C:97:6B:F7:1B:A6:48:55:E9:D9:3A:AA:C7:C5:C2:89:86:0E:45:C8:22:68:4B:B7:39:4B:B9:D3</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  agent2</span><br><span class="line">-------------</span><br><span class="line">[root@node2 ~]# rm -rf /var/lib/puppet/ssl/*</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@master modules]# vim /etc/puppet/autosign.conf</span><br><span class="line">*.ruopu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在Puppetmaster端编写ACL列表</span></span><br><span class="line">[root@master modules]# systemctl restart puppetmaster.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启服务</span></span><br><span class="line">[root@master modules]# puppet cert --list --all</span><br><span class="line">+ "master.ruopu.com" (SHA256) B5:A8:47:D4:FE:4E:FE:AC:5E:48:A2:C0:CF:7E:CB:1D:B9:03:26:8F:1F:66:6B:9A:29:E3:C7:39:E0:5E:D6:E0 (alt names: "DNS:master.ruopu.com", "DNS:puppet", "DNS:puppet.ruopu.com")</span><br><span class="line">+ "node1.ruopu.com"  (SHA256) DC:8F:2C:D6:0C:97:6B:F7:1B:A6:48:55:E9:D9:3A:AA:C7:C5:C2:89:86:0E:45:C8:22:68:4B:B7:39:4B:B9:D3</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  agent2</span><br><span class="line">-------------</span><br><span class="line">[root@node2 ~]# puppet agent --test</span><br><span class="line">Info: Creating a new SSL key for node2.ruopu.com</span><br><span class="line">Info: Caching certificate for ca</span><br><span class="line">Info: csr_attributes file loading from /etc/puppet/csr_attributes.yaml</span><br><span class="line">Info: Creating a new SSL certificate request for node2.ruopu.com</span><br><span class="line">Info: Certificate Request fingerprint (SHA256): 6E:0E:32:71:38:77:41:92:E6:55:B0:90:07:3B:42:BF:87:8A:A7:16:2F:C2:90:25:43:10:B6:8B:DF:0A:65:A8</span><br><span class="line">Info: Caching certificate for node2.ruopu.com</span><br><span class="line">Info: Caching certificate_revocation_list for ca</span><br><span class="line">Info: Caching certificate for ca</span><br><span class="line">Notice: Ignoring --listen on onetime run</span><br><span class="line">Info: Retrieving pluginfacts</span><br><span class="line">Info: Retrieving plugin</span><br><span class="line">Info: Caching catalog for node2.ruopu.com</span><br><span class="line">Warning: The package type's allow_virtual parameter will be changing its default value from false to true in a future release. If you do not want to allow virtual packages, please explicitly set allow_virtual to false.</span><br><span class="line">   (at /usr/share/ruby/vendor_ruby/puppet/type.rb:816:in `set_default')</span><br><span class="line">Info: Applying configuration version '1548985465'</span><br><span class="line">Notice: Finished catalog run in 4.31 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 申请证书</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@master modules]# puppet cert --list --all</span><br><span class="line">+ "master.ruopu.com" (SHA256) B5:A8:47:D4:FE:4E:FE:AC:5E:48:A2:C0:CF:7E:CB:1D:B9:03:26:8F:1F:66:6B:9A:29:E3:C7:39:E0:5E:D6:E0 (alt names: "DNS:master.ruopu.com", "DNS:puppet", "DNS:puppet.ruopu.com")</span><br><span class="line">+ "node1.ruopu.com"  (SHA256) DC:8F:2C:D6:0C:97:6B:F7:1B:A6:48:55:E9:D9:3A:AA:C7:C5:C2:89:86:0E:45:C8:22:68:4B:B7:39:4B:B9:D3</span><br><span class="line">+ "node2.ruopu.com"  (SHA256) 3F:C1:1E:F7:4B:BA:2B:28:E0:79:49:AF:F3:96:BC:FE:78:A2:D2:F6:A4:9A:76:E6:29:BA:D9:09:29:D4:E0:79</span><br><span class="line"><span class="meta">#</span><span class="bash"> agent2已经自动注册成功</span></span><br><span class="line"></span><br><span class="line">[root@master modules]# puppet kick node2.ruopu.com   </span><br><span class="line">Warning: Puppet kick is deprecated. See http://links.puppetlabs.com/puppet-kick-deprecation</span><br><span class="line">Warning: Failed to load ruby LDAP library. LDAP functionality will not be available</span><br><span class="line">Triggering node2.ruopu.com</span><br><span class="line">Error: Host node2.ruopu.com failed: SSL_connect returned=1 errno=0 state=error: certificate verify failed: [certificate revoked for /CN=node2.ruopu.com]</span><br><span class="line"></span><br><span class="line">node2.ruopu.com finished with exit code 2</span><br><span class="line">Failed: node2.ruopu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时向agent2推送可能会有问题，需要重启agent2的puppet服务</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  agent2</span><br><span class="line">-------------</span><br><span class="line">[root@node2 ~]# systemctl restart puppetagent</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@master modules]# vim /root/puppetclient.txt</span><br><span class="line">node1.ruopu.com</span><br><span class="line">node2.ruopu.com</span><br><span class="line">[root@master modules]# puppet kick --host `cat /root/puppetclient.txt`</span><br><span class="line">Warning: Puppet kick is deprecated. See http://links.puppetlabs.com/puppet-kick-deprecation</span><br><span class="line">Warning: Failed to load ruby LDAP library. LDAP functionality will not be available</span><br><span class="line">Triggering node1.ruopu.com</span><br><span class="line">Getting status</span><br><span class="line">status is success</span><br><span class="line">node1.ruopu.com finished with exit code 0</span><br><span class="line">Triggering node2.ruopu.com</span><br><span class="line">Getting status</span><br><span class="line">status is success</span><br><span class="line">node2.ruopu.com finished with exit code 0</span><br><span class="line">Finished</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用此种方法一起推送</span></span><br></pre></td></tr></table></figure>
<h4 id="预签名注册"><a href="#预签名注册" class="headerlink" title="预签名注册"></a>预签名注册</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">============================================================================================</span><br><span class="line">预签名注册是在agent端未提出申请的情况下，预先在puppetmaster端生成agent端的证书，然后复制到节点对应的目录下即可注册成功，这种方式安全系数最高，但是操作麻烦，需要提前预知所有节点服务器的certname名称，其次需要将生成的证书逐步copy到所有节点上去。不过，如果你的系统中安装了kickstart或者cobbler这样的自动化工具，倒是可以将证书部分转换成脚本集成到统一自动化部署中</span><br><span class="line">== 生产环境中建议此方式进行注册，既安全又可靠！ ==</span><br><span class="line">============================================================================================</span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@master modules]# puppet cert --clean node1.ruopu.com</span><br><span class="line">Notice: Revoked certificate with serial 4</span><br><span class="line">Notice: Removing file Puppet::SSL::Certificate node1.ruopu.com at '/var/lib/puppet/ssl/ca/signed/node1.ruopu.com.pem'</span><br><span class="line">Notice: Removing file Puppet::SSL::Certificate node1.ruopu.com at '/var/lib/puppet/ssl/certs/node1.ruopu.com.pem'</span><br><span class="line">[root@master modules]# puppet cert --list --all</span><br><span class="line">+ "master.ruopu.com" (SHA256) B5:A8:47:D4:FE:4E:FE:AC:5E:48:A2:C0:CF:7E:CB:1D:B9:03:26:8F:1F:66:6B:9A:29:E3:C7:39:E0:5E:D6:E0 (alt names: "DNS:master.ruopu.com", "DNS:puppet", "DNS:puppet.ruopu.com")</span><br><span class="line">+ "node2.ruopu.com"  (SHA256) 3F:C1:1E:F7:4B:BA:2B:28:E0:79:49:AF:F3:96:BC:FE:78:A2:D2:F6:A4:9A:76:E6:29:BA:D9:09:29:D4:E0:79</span><br><span class="line">[root@master modules]# mv /etc/puppet/autosign.conf&#123;,.bak&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除自动注册ACL列表</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  agent1</span><br><span class="line">-------------</span><br><span class="line">[root@puppettest1 ~]# rm -rf /var/lib/puppet/*</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@master modules]# puppet ca generate node1.ruopu.com</span><br><span class="line">Notice: node1.ruopu.com has a waiting certificate request</span><br><span class="line">Notice: Signed certificate request for node1.ruopu.com</span><br><span class="line">Notice: Removing file Puppet::SSL::CertificateRequest node1.ruopu.com at '/var/lib/puppet/ssl/ca/requests/node1.ruopu.com.pem'</span><br><span class="line">Notice: Removing file Puppet::SSL::CertificateRequest node1.ruopu.com at '/var/lib/puppet/ssl/certificate_requests/node1.ruopu.com.pem'</span><br><span class="line">"-----BEGIN CERTIFICATE-----\nM...</span><br><span class="line"><span class="meta">#</span><span class="bash"> puppetserver端预先生成agent1证书</span></span><br><span class="line">============================================================================================</span><br><span class="line">[root@master modules]# puppet --version</span><br><span class="line">3.6.2</span><br><span class="line">[root@master modules]# puppet help</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3.6.2版本中的命令与网上的一些教程已有很多不同，可以通过此命令查看帮助信息</span></span><br><span class="line">[root@master modules]# puppet help ca</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是查看ca模块的帮助命令</span></span><br><span class="line">============================================================================================</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  agent1</span><br><span class="line">-------------</span><br><span class="line">[root@puppettest1 ~]# puppet agent --test --server=master.ruopu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 节点生成目录结构，最后是服务端的主机名</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@master modules]# scp /var/lib/puppet/ssl/private_keys/node1.ruopu.com.pem node1.ruopu.com:/var/lib/puppet/ssl/private_keys/</span><br><span class="line">[root@master modules]# scp /var/lib/puppet/ssl/certs/node1.ruopu.com.pem node1.ruopu.com:/var/lib/puppet/ssl/certs/</span><br><span class="line">[root@master modules]# scp /var/lib/puppet/ssl/certs/ca.pem node1.ruopu.com:/var/lib/puppet/ssl/certs/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制密钥到客户端</span></span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  agent1</span><br><span class="line">-------------</span><br><span class="line">[root@puppettest1 ~]# puppet agent --test</span><br><span class="line">Notice: Ignoring --listen on onetime run</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试。实际发现，在服务端生成客户端密钥时就已经完成客户端的认证了。</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@master modules]# puppet kick node1.ruopu.com      </span><br><span class="line">Warning: Puppet kick is deprecated. See http://links.puppetlabs.com/puppet-kick-deprecation</span><br><span class="line">Warning: Failed to load ruby LDAP library. LDAP functionality will not be available</span><br><span class="line">Triggering node1.ruopu.com</span><br><span class="line">Getting status</span><br><span class="line">status is running</span><br><span class="line">Host node1.ruopu.com is already running</span><br><span class="line">node1.ruopu.com finished with exit code 3</span><br><span class="line">Failed: node1.ruopu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提示错误的原因是agent1节点每5秒与服务器同步一次，比较频繁，所以有此提示。如果将更新时间改为默认的1800秒，再次推送就不会有此提示了。</span></span><br></pre></td></tr></table></figure>
<h4 id="客户端定时更新"><a href="#客户端定时更新" class="headerlink" title="客户端定时更新"></a>客户端定时更新</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-------------</span><br><span class="line">  agent2</span><br><span class="line">-------------</span><br><span class="line">[root@node2 ~]# puppet agent --configprint runinterval</span><br><span class="line">1800</span><br><span class="line"><span class="meta">#</span><span class="bash"> Puppet客户端定时更新时间默认为30分钟</span></span><br><span class="line">[root@node2  modules]# vim /etc/puppet/puppet.conf</span><br><span class="line">[agent]</span><br><span class="line">    runinterval = 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在agent段中加入上述内容，表示设置agent端5秒去同步。修改即可，无需重启服务</span></span><br><span class="line">[root@node2 ~]# puppet agent --configprint runinterval</span><br><span class="line">5</span><br><span class="line">------------</span><br><span class="line">  master</span><br><span class="line">------------</span><br><span class="line">[root@puppet ~]# tail -f /var/log/puppet/masterhttp.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看日志会频繁变动</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> runinterval=0，并不表示从来不运行，而是表示继续运行；如果想要puppet agent从不运行，应该使用--no-client选项来启动；如：puppet agent --no-client</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用--no-client选项，会启动守护进程但不检测配置，除非它被puppet kick触发。而且只有当puppet.conf配置listen=<span class="literal">true</span>或启动时有带--listen选项时，它才生效；</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/29/查看用户登录信息/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/29/查看用户登录信息/" itemprop="url">
                  查看用户登录信息
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-29 18:34:29 / 修改時間：19:21:19" itemprop="dateCreated datePublished" datetime="2019-01-29T18:34:29+08:00">2019-01-29</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="w"><a href="#w" class="headerlink" title="w"></a>w</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">查看当前登入系统的用户信息及用户当前的进程（而who命令只能看用户不能看进程）。该命令能查看的信息包括系统当前时间，系统运行时间，登陆系统用户总数及系统1、5、15分钟内的平均负载信息。后面的信息是用户，终端，登录源，login time，idle time，JCPU，PCPU，当前执行的进程等。w的信息来自两个文件：用户登录信息来自/var/run/utmp，进程信息来自/proc/。</span><br><span class="line"></span><br><span class="line">参数</span><br><span class="line">-h：不显示标题。</span><br><span class="line">-u：列出当前进程和CPU时间时忽略用户名。这主要是用于执行su命令后的情况。</span><br><span class="line">-s：使用短模式。不显示登录时间、JCPU(终端机阶段作业)和PCPU（程序消耗）时间。</span><br><span class="line">-f：切换显示FROM项，也就是远程主机名项。默认值是不显示远程主机名</span><br><span class="line">-V：显示版本信息。</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@haproxy ~]# w</span><br><span class="line"> 18:33:57 up 11:19,  2 users,  load average: 0.00, 0.01, 0.05</span><br><span class="line">USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT</span><br><span class="line">root     tty1                      15:17    3:15m  0.07s  0.07s -bash</span><br><span class="line">root     pts/0    192.168.1.9      12:18    5.00s  0.70s  0.00s w</span><br><span class="line"><span class="meta">#</span><span class="bash"> User：登录用户名 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TTY：登录后系统分配的终端号 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> From：远程主机名，即从哪登录的 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> login@：何时登录 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IDLE：用户空闲时间。这是个计时器，一旦用户执行任何操作，改计时器就会被重置。 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> JCPU：和终端连接的所有进程占用时间。包括当前正在运行的后台作业占用时间 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PCPU：当前进程所占用时间 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WHAT：当前正在运行进程的命令行</span></span><br></pre></td></tr></table></figure>
<h3 id="who"><a href="#who" class="headerlink" title="who"></a>who</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">查看当前登入系统的用户信息。其中who -m等效于whoami。</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@haproxy ~]# who</span><br><span class="line">root     tty1         2019-01-29 15:17</span><br><span class="line">root     pts/0        2019-01-29 12:18 (192.168.1.9)</span><br></pre></td></tr></table></figure>
<h3 id="last"><a href="#last" class="headerlink" title="last"></a>last</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">列出当前和曾经登入系统的用户信息，它默认读取的是/var/log/wtmp文件的信息。输出的内容包括：用户名、终端位置（pts/0伪终端，意味着从SSH或telnet等工具远程连接的用户，图形界面终端归于此类。tty0直接连接到计算机或本地连接的用户。后面的数字代表连接编号）、登录源信息、开始时间、结束时间（still login in尚未退出，down直到正常关机，crash直到强制关机）、持续时间。注意最后一行输出的是wtmp文件起始记录的时间。当然也可以通过last -f参数指定读取文件，可以是/var/log/btmp、/var/run/utmp</span><br><span class="line"></span><br><span class="line">参数</span><br><span class="line">-R 不显示登录系统或终端的主机名称或IP</span><br><span class="line">-a 将登录系统或终端的主机名过IP地址显示在最后一行</span><br><span class="line">-d 将IP地址转成主机名称</span><br><span class="line">-I 显示特定IP登录情况。</span><br><span class="line">-o 读取有linux-libc5应用编写的旧类型wtmp文件</span><br><span class="line">-x 显示系统关闭、用户登录和退出的历史</span><br><span class="line">-F 显示登录的完整时间</span><br><span class="line">-w 在输出中显示完整的用户名或域名</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@haproxy ~]# last</span><br><span class="line">root     pts/0        192.168.1.9      Tue Jan 29 12:18   still logged in   </span><br><span class="line">root     pts/0        192.168.1.9      Tue Jan 29 15:22 - 12:18  (-3:-3)    </span><br><span class="line">root     tty1                          Tue Jan 29 15:17   still logged in   </span><br><span class="line">reboot   system boot  3.10.0-693.el7.x Tue Jan 29 15:13 - 18:41  (03:27)    </span><br><span class="line">root     tty1                          Wed Oct 24 05:42 - 05:50  (00:07)    </span><br><span class="line">reboot   system boot  3.10.0-693.el7.x Wed Oct 24 05:42 - 05:50  (00:07)    </span><br><span class="line"></span><br><span class="line">wtmp begins Wed Oct 24 05:42:31 2018</span><br><span class="line"></span><br><span class="line">[root@haproxy ~]# last -f /var/log/btmp </span><br><span class="line"></span><br><span class="line">btmp begins Wed Oct 24 05:42:34 2018</span><br><span class="line"></span><br><span class="line">[root@haproxy ~]# last -f /var/run/utmp </span><br><span class="line">root     pts/0        192.168.1.9      Tue Jan 29 12:18   still logged in   </span><br><span class="line">root     tty1                          Tue Jan 29 15:17   still logged in   </span><br><span class="line">reboot   system boot  3.10.0-693.el7.x Tue Jan 29 15:13 - 18:43  (03:29)    </span><br><span class="line"></span><br><span class="line">utmp begins Tue Jan 29 15:13:55 2019</span><br><span class="line"></span><br><span class="line">[root@haproxy ~]# last root</span><br><span class="line">root     pts/0        192.168.1.9      Tue Jan 29 12:18   still logged in   </span><br><span class="line">root     pts/0        192.168.1.9      Tue Jan 29 15:22 - 12:18  (-3:-3)    </span><br><span class="line">root     tty1                          Tue Jan 29 15:17   still logged in   </span><br><span class="line">root     tty1                          Wed Oct 24 05:42 - 05:50  (00:07)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定用户</span></span><br><span class="line"></span><br><span class="line">[root@haproxy ~]# last -n 1</span><br><span class="line">root     pts/0        192.168.1.9      Tue Jan 29 12:18   still logged in   </span><br><span class="line"></span><br><span class="line">wtmp begins Wed Oct 24 05:42:31 2018</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定输出记录的条数</span></span><br><span class="line"></span><br><span class="line">[root@haproxy ~]# last -10 -t 20190129000000</span><br><span class="line">root     tty1                          Wed Oct 24 05:42 - 05:50  (00:07)    </span><br><span class="line">reboot   system boot  3.10.0-693.el7.x Wed Oct 24 05:42 - 05:50  (00:07)    </span><br><span class="line"></span><br><span class="line">wtmp begins Wed Oct 24 05:42:31 2018</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示指定时间之前的记录</span></span><br><span class="line"></span><br><span class="line">[root@haproxy ~]# last -10 -d</span><br><span class="line">root     pts/0        192.168.1.9      Tue Jan 29 12:18   still logged in   </span><br><span class="line">root     pts/0        192.168.1.9      Tue Jan 29 15:22 - 12:18  (-3:-3)    </span><br><span class="line">root     tty1         0.0.0.0          Tue Jan 29 15:17   still logged in   </span><br><span class="line">reboot   system boot  0.0.0.0          Tue Jan 29 15:13 - 18:56  (03:42)    </span><br><span class="line">root     tty1         0.0.0.0          Wed Oct 24 05:42 - 05:50  (00:07)    </span><br><span class="line">reboot   system boot  0.0.0.0          Wed Oct 24 05:42 - 05:50  (00:07)    </span><br><span class="line"></span><br><span class="line">wtmp begins Wed Oct 24 05:42:31 2018</span><br><span class="line"><span class="meta">#</span><span class="bash">  将IP 地址转换为主机地址</span></span><br></pre></td></tr></table></figure>
<h3 id="lastlog"><a href="#lastlog" class="headerlink" title="lastlog"></a>lastlog</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">列出所有用户最近登录的信息，或者指定用户的最近登录信息。lastlog引用的是/var/log/lastlog文件中的信息，包括login-name、port、last login time</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@haproxy ~]# lastlog </span><br><span class="line">Username         Port     From             Latest</span><br><span class="line">root             pts/0    192.168.1.9      Tue Jan 29 12:18:32 +0800 2019</span><br><span class="line">bin                                        **Never logged in**</span><br><span class="line">daemon                                     **Never logged in**</span><br><span class="line">adm                                        **Never logged in**</span><br><span class="line">lp                                         **Never logged in**</span><br><span class="line">sync                                       **Never logged in**</span><br><span class="line">shutdown                                   **Never logged in**</span><br><span class="line">halt                                       **Never logged in**</span><br><span class="line">mail                                       **Never logged in**</span><br><span class="line">operator                                   **Never logged in**</span><br><span class="line">games                                      **Never logged in**</span><br><span class="line">ftp                                        **Never logged in**</span><br><span class="line">nobody                                     **Never logged in**</span><br><span class="line">systemd-network                            **Never logged in**</span><br><span class="line">dbus                                       **Never logged in**</span><br><span class="line">polkitd                                    **Never logged in**</span><br><span class="line"></span><br><span class="line">[root@haproxy ~]# lastlog -u 0</span><br><span class="line">Username         Port     From             Latest</span><br><span class="line">root             pts/0    192.168.1.9      Tue Jan 29 12:18:32 +0800 2019</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过用户的UID查看指定用户的登录信息</span></span><br></pre></td></tr></table></figure>
<h3 id="lastb"><a href="#lastb" class="headerlink" title="lastb"></a>lastb</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">列出失败尝试的登录信息，和last命令功能完全相同，只不过它默认读取的是/var/log/btmp文件的信息。当然也可以通过last -f参数指定读取文件，可以是/var/log/btmp、/var/run/utmp</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@haproxy ~]# lastb</span><br><span class="line">root     ssh:notty    192.168.1.9      Tue Jan 29 19:05 - 19:05  (00:00)    </span><br><span class="line"></span><br><span class="line">btmp begins Tue Jan 29 19:05:21 2019</span><br></pre></td></tr></table></figure>
<h3 id="登录日志"><a href="#登录日志" class="headerlink" title="登录日志"></a>登录日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. /var/run/utmp：记录当前正在登录系统的用户信息，默认由who和w记录当前登录用户的信息，uptime记录系统启动时间；</span><br><span class="line">2. /var/log/wtmp：记录当前正在登录和历史登录系统的用户信息，默认由last命令查看；</span><br><span class="line">3. /var/log/btmp：记录失败的登录尝试信息，默认由lastb命令查看。</span><br><span class="line">4. /var/log/lastlog：记录每个用户最后的登入信息</span><br></pre></td></tr></table></figure>
<h3 id="清除登录日志"><a href="#清除登录日志" class="headerlink" title="清除登录日志"></a>清除登录日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]# echo &gt; /var/log/wtmp </span><br><span class="line">[root@haproxy ~]# echo &gt; /var/log/btmp </span><br><span class="line">[root@haproxy ~]# echo &gt; /var/log/lastlog</span><br><span class="line">[root@haproxy ~]# history -r</span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入当前用户家目录中的.bash_history</span></span><br><span class="line">[root@haproxy ~]# history -c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除当前会话的历史记录</span></span><br><span class="line">[root@haproxy ~]# echo &gt; ~/.bash_history</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除所有历史记录</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/29/puppet配置与使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/29/puppet配置与使用/" itemprop="url">
                  puppet配置与使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-29 15:17:23" itemprop="dateCreated datePublished" datetime="2019-01-29T15:17:23+08:00">2019-01-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-31 22:04:51" itemprop="dateModified" datetime="2019-01-31T22:04:51+08:00">2019-01-31</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/编排工具/" itemprop="url" rel="index"><span itemprop="name">编排工具</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h4><blockquote>
<ul>
<li>group：定义组</li>
<li>user：定义用户</li>
<li>file：定义配置文件</li>
<li>service：定义服务</li>
<li>exec：执行命令</li>
<li>package：管理程序包</li>
<li>cron：周期性任务计划</li>
<li>notify：主要用于输出puppet的辅助提示信息,在puppet的执行过程中通过这些辅助信息了解执行的过程,它并不会改变任何操作状态.</li>
</ul>
</blockquote>
<h4 id="资源中的参数"><a href="#资源中的参数" class="headerlink" title="资源中的参数"></a>资源中的参数</h4><blockquote>
<ul>
<li>name：指定要创建或显示的信息</li>
<li>system：是否为系统的，true为是，false表示非；</li>
<li>ensure：描述状态的。present表示必须创建，adsent表示不创建。latest表示安装最新版本，installed也表示安装最新版本，如果不想安装最新版本，要指定版本号，用present也可以安装。running表示处理启动状态。file表示是配置文件。directory表示定义为目录；</li>
<li>enable：表示开机是否自启动，如true</li>
<li>require：表示依赖哪个属性；</li>
<li>before：表示先于上面的哪个资源执行</li>
<li>subscribe：订阅前面的资源，如果前面发生改变就通知后面的资源，服务会重启。notify和subscribe是通知相关的其它资源进行“刷新”操作</li>
<li>-&gt;表示某资源要在另一个资源之前执行。-&gt;不能写在下面的资源后，如果要用这个符号，就要写在优先于的资源的上面。</li>
<li>~&gt;表示通知某资源</li>
<li>path：在exec资源中使用时一定要给定命令路径，如’/bin:/sbin:/usr/bin:/usr/sbin’,，如果在exec中没有给路径的情况下。</li>
<li>recurse：表示递归复制整个目录，可用true。</li>
<li>creates：只有在此目录不存在时才执行。对于目录或文件路径类的操作资源来讲，可以用creates来判断，如果不存在才创建</li>
<li>command：要执行的命令</li>
<li>unless：表示其指定的命令执行失败了才执行上面的创建用户命令</li>
<li>refreshonly：refreshonly为true表示触发时才执行命令，如程序包安装了才创建用户，如果没有程序包，就不会创建。如果没有refreshonly时，即使没有事件通知它，exec也会执行。如果加上refreshonly时，exec仅在其他资源用notify或subscribe事件通知时才会执行。refreshonly作用是让exec只在通知时执行，如果被通知多次就执行多次。</li>
<li>refresh：如果有其他资源调用exec的时候，exec会执行好几次，加上refresh后就只会执行一次了，refresh作用就是不管有通知没通知，有多少次通知，都只执行一次。</li>
<li>provider：定义用什么方式安装，如rpm</li>
<li>owner：表示文件属主</li>
<li>group：表示文件属组</li>
<li>mode：表示文件权限</li>
<li>message：输出描述信息</li>
<li>withpath：是否显示完整对象路径。</li>
</ul>
</blockquote>
<h3 id="puppet单机模型"><a href="#puppet单机模型" class="headerlink" title="puppet单机模型"></a>puppet单机模型</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">环境</span><br><span class="line">node1：192.168.1.70</span><br><span class="line">==============================================================================================</span><br><span class="line">------------</span><br><span class="line">  node1</span><br><span class="line">------------ </span><br><span class="line">[root@puppet ~]# yum install -y epel-release</span><br><span class="line">[root@puppet ~]# yum install -y puppet facter</span><br><span class="line"><span class="meta">#</span><span class="bash"> facter是一个非常有用的系统盘点工具，自定义时可以让节点增加更多的标签。这个工具可以通过一些预先设定好变量定位一台主机，比如可以通过变量lsbdistrelease便可以知道当前系统的版本号，通过osfamily便可以知道系统是RedHat还是SLES，还有其他等等。</span></span><br><span class="line">[root@puppet ~]# puppet describe -l</span><br><span class="line">These are the types known to puppet:</span><br><span class="line">augeas          - Apply a change or an array of changes to the  ...</span><br><span class="line">computer        - Computer object management using DirectorySer ...</span><br><span class="line">cron            - Installs and manages cron jobs</span><br><span class="line">exec            - Executes external commands</span><br><span class="line">file            - Manages files, including their content, owner ...</span><br><span class="line">filebucket      - A repository for storing and retrieving file  ...</span><br><span class="line">group           - Manage groups</span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看资源类型</span></span><br><span class="line">[root@puppet ~]# puppet describe group</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看组类型</span></span><br><span class="line">[root@puppet ~]# mkdir manifests</span><br><span class="line">[root@puppet ~]# cd manifests</span><br></pre></td></tr></table></figure>
<h4 id="资源组创建"><a href="#资源组创建" class="headerlink" title="资源组创建"></a>资源组创建</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim first.pp</span><br><span class="line"><span class="meta">#</span><span class="bash"> puppet资源清单要以.pp结尾</span></span><br><span class="line">group&#123;'nginx':			# 如果组中没有空白可以不用引号，这里组名就叫nignx，之后用冒号隔开</span><br><span class="line">   name =&gt; 'nginx',</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一个属性name，用=&gt;表示赋值，也叫nginx，最后用逗号隔开。如果不写name，那么就用上面的title当默认的name，也就是上面的nginx</span></span><br><span class="line">   gid =&gt; 900,		# 指定组id，一定要指定组id，如果不加组id，创建系统组会失败。如果已经有要创建的组了，可以通过这里修改组id</span><br><span class="line">   system =&gt; true,</span><br><span class="line"><span class="meta">#</span><span class="bash"> system表示系统组，这里的<span class="literal">true</span>不能加引号，因为<span class="literal">true</span>是布尔型的值。如果创建普通组，可以去掉system项</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply --verbose --noop first.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.07 seconds</span><br><span class="line">Info: Applying configuration version '1548897081'</span><br><span class="line">Info: Creating state file /var/lib/puppet/state/state.yaml</span><br><span class="line">Notice: Finished catalog run in 0.01 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> apply表示跑一次，--verbose表示查看详细信息，--noop表示干跑。显示结果是绿色表示没有问题</span></span><br><span class="line">[root@puppet manifests]# puppet apply -v first.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.06 seconds</span><br><span class="line">Info: Applying configuration version '1548897756'</span><br><span class="line">Notice: /Stage[main]/Main/Group[nginx]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line">[root@puppet manifests]# cat /etc/group|grep nginx            </span><br><span class="line">nginx:x:900:</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建成功</span></span><br></pre></td></tr></table></figure>
<h4 id="创建组和用户资源"><a href="#创建组和用户资源" class="headerlink" title="创建组和用户资源"></a>创建组和用户资源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim second.pp</span><br><span class="line">group&#123;'memcached':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line"><span class="meta">#</span><span class="bash"> ensure是描述状态的，present表示必须创建出来。定义系统组时必须有此项(CentOS6上500以内为系统用户和组，500开始为普通用户和组。CentOS7上是1000以内)，但最好何时都加上</span></span><br><span class="line">   name =&gt; 'memcached',</span><br><span class="line">   system =&gt; true,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop second.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.06 seconds</span><br><span class="line">Info: Applying configuration version '1548898738'</span><br><span class="line">Notice: /Stage[main]/Main/Group[memcached]/ensure: current_value absent, should be present (noop)</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.03 seconds</span><br><span class="line">[root@puppet manifests]# puppet apply -v second.pp         </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.07 seconds</span><br><span class="line">Info: Applying configuration version '1548898802'</span><br><span class="line">Notice: /Stage[main]/Main/Group[memcached]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line">[root@puppet manifests]# grep -i 'memcached' /etc/group</span><br><span class="line">memcached:x:899:</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这次在second.pp中不加组id也可以创建系统组了。但还是建议加入组id</span></span><br><span class="line">[root@puppet manifests]# vim user1.pp</span><br><span class="line">user&#123;'nginx':</span><br><span class="line">   uid =&gt; 444,</span><br><span class="line">   gid =&gt; 'nginx',</span><br><span class="line">   system =&gt; true,</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop --debug user1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.11 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 基本组要事先存在才能创建用户，--debug可以输出更加详细的信息</span></span><br><span class="line">[root@puppet manifests]# vim user1.pp </span><br><span class="line">group&#123;'nginx':</span><br><span class="line">   system =&gt; true,</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">user&#123;'nginx':</span><br><span class="line">   uid =&gt; 444,</span><br><span class="line">   gid =&gt; 'nginx',</span><br><span class="line">   system =&gt; true,</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --debug --noop user1.pp</span><br><span class="line">[root@puppet manifests]# puppet apply -v --debug user1.pp  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样就能创建了，同一个定义执行多遍，其结果是一样的。这叫幂等性。如果没有幂等性，要让其拥有</span></span><br><span class="line"></span><br><span class="line">[root@puppet manifests]# vim user2.pp</span><br><span class="line">user&#123;'redis':</span><br><span class="line">   gid =&gt; 'redis',</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">group&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop --debug user2.pp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以执行，会先创建组再创建用户，反着写也可以。只要是在同一文件中就没问题</span></span><br><span class="line">[root@puppet manifests]# vim user2.pp                     </span><br><span class="line">user&#123;'redis':</span><br><span class="line">   gid =&gt; 'redis',</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   require =&gt; Group['redis'],</span><br><span class="line"><span class="meta">#</span><span class="bash"> require表示依赖哪个属性，Group这个属性的第一个字母必须大写，后面用[<span class="string">''</span>]的方式写明title。这样定义后，执行时就必须先执行下面的命令</span></span><br><span class="line">&#125;</span><br><span class="line">group&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   before =&gt; User['redis'],</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这表示先于上面的user执行，格式与上面的require一样，这两种方法都可以使group先执行</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet describe package</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看管理程序包的</span></span><br></pre></td></tr></table></figure>
<h4 id="创建程序包资源"><a href="#创建程序包资源" class="headerlink" title="创建程序包资源"></a>创建程序包资源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim pkg1.pp</span><br><span class="line">package&#123;'redis':</span><br><span class="line">   ensure =&gt; latest,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# rpm -q redis</span><br><span class="line">package redis is not installed</span><br><span class="line">[root@puppet manifests]# puppet apply -v pkg1.pp                </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.21 seconds</span><br><span class="line">Warning: The package type's allow_virtual parameter will be changing its default value from false to true in a future release. If you do not want to allow virtual packages, please explicitly set allow_virtual to false.</span><br><span class="line">   (at /usr/share/ruby/vendor_ruby/puppet/type.rb:816:in `set_default')</span><br><span class="line">Info: Applying configuration version '1548900655'</span><br><span class="line">Notice: /Stage[main]/Main/Package[redis]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 11.39 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里会有一个Warning: 提示，可以在文件中加入allow_virtual =&gt; <span class="literal">false</span>，就不会提示了</span></span><br><span class="line">[root@puppet manifests]# rpm -q redis</span><br><span class="line">redis-3.2.12-2.el7.x86_64</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装成功了</span></span><br><span class="line"></span><br><span class="line">下载jdk-8u201-linux-x64.rpm到root目录</span><br><span class="line">[root@puppet manifests]# vim pkg2.pp</span><br><span class="line">package&#123;'jdk':</span><br><span class="line">   ensure =&gt; installed,</span><br><span class="line">   source =&gt; '/root/jdk-8u201-linux-x64.rpm',</span><br><span class="line">   provider =&gt; rpm,</span><br><span class="line">   allow_virtual =&gt; false,		# 不加入此项，还会有警告提示</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop pkg2.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.22 seconds</span><br><span class="line">Info: Applying configuration version '1548905011'</span><br><span class="line">Notice: /Stage[main]/Main/Package[jdk]/ensure: current_value absent, should be present (noop)</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.11 seconds</span><br><span class="line">[root@puppet manifests]# puppet apply -v pkg2.pp        </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.22 seconds</span><br><span class="line">Info: Applying configuration version '1548905065'</span><br><span class="line">Notice: /Stage[main]/Main/Package[jdk]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 7.13 seconds</span><br><span class="line">[root@puppet manifests]# java -version</span><br><span class="line">java version "1.8.0_201"</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_201-b09)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.201-b09, mixed mode)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装成功</span></span><br><span class="line">[root@puppet manifests]# ls /usr/java/</span><br><span class="line">default  jdk1.8.0_201-amd64  latest</span><br><span class="line">[root@puppet manifests]# rpm -q jdk1.8-2000:1.8.0_201-fcs.x86_64</span><br><span class="line">jdk1.8-1.8.0_201-fcs.x86_64</span><br></pre></td></tr></table></figure>
<h4 id="服务与配置文件"><a href="#服务与配置文件" class="headerlink" title="服务与配置文件"></a>服务与配置文件</h4><h5 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim service1.pp</span><br><span class="line">service&#123;'redis':</span><br><span class="line">   ensure =&gt; running,		# 确保处于启动状态</span><br><span class="line">   enable =&gt; true,		# 是否开机自启动</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop service1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.08 seconds</span><br><span class="line">Info: Applying configuration version '1548905408'</span><br><span class="line">Notice: /Stage[main]/Main/Service[redis]/ensure: current_value stopped, should be running (noop)</span><br><span class="line">Info: /Stage[main]/Main/Service[redis]: Unscheduling refresh on Service[redis]</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.03 seconds</span><br><span class="line">[root@puppet manifests]# puppet apply -v service1.pp        </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.08 seconds</span><br><span class="line">Info: Applying configuration version '1548905419'</span><br><span class="line">Notice: /Stage[main]/Main/Service[redis]/ensure: ensure changed 'stopped' to 'running'</span><br><span class="line">Info: /Stage[main]/Main/Service[redis]: Unscheduling refresh on Service[redis]</span><br><span class="line">Notice: Finished catalog run in 0.10 seconds</span><br><span class="line">[root@puppet manifests]# ss -tln</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128    127.0.0.1:6379                   *:*             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到redis启动了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务要依赖程序包，要先安装程序包，才能启动服务</span></span><br><span class="line">[root@puppet manifests]# vim service1.pp                        </span><br><span class="line">package&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">service&#123;'redis':</span><br><span class="line">   ensure =&gt; running,</span><br><span class="line">   enable =&gt; true,</span><br><span class="line">   require =&gt; Package['redis']</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# cp /etc/redis.conf ./</span><br><span class="line">[root@puppet manifests]# vim redis.conf</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">requirepass centos</span><br><span class="line">[root@puppet manifests]# vim file1.pp</span><br><span class="line">file&#123;'/etc/redis.conf':		# 如果只写名字，后面一定要有path。否则就要给目标主机上配置文件的全路径</span><br><span class="line">   ensure =&gt; file,</span><br><span class="line">   source =&gt; '/root/manifests/redis.conf',</span><br><span class="line">   owner =&gt; 'redis',		# 文件属主</span><br><span class="line">   group =&gt; 'root',			# 文件属组</span><br><span class="line">   mode =&gt; '0644',			# 文件权限</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop file1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.07 seconds</span><br><span class="line">Info: Applying configuration version '1548905958'</span><br><span class="line">Notice: /Stage[main]/Main/File[/etc/redis.conf]/content: current_value &#123;md5&#125;d98629fded012cd2a25b9db0599a9251, should be &#123;md5&#125;1a1a5828970c05c20bb80d5930c66f12 (noop)</span><br><span class="line">Notice: /Stage[main]/Main/File[/etc/redis.conf]/mode: current_value 0640, should be 0644 (noop)</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 2 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line">[root@puppet manifests]# puppet apply -v --debug file1.pp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样只会改变文件，但服务不会重启</span></span><br><span class="line">[root@puppet manifests]# grep -E -v "^$|^#" /etc/redis.conf </span><br><span class="line">bind 0.0.0.0</span><br><span class="line">requirepass centos</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到本机的redis配置文件已被修改了</span></span><br></pre></td></tr></table></figure>
<h5 id="通知-amp-订阅"><a href="#通知-amp-订阅" class="headerlink" title="通知&amp;订阅"></a>通知&amp;订阅</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">* 方法一</span><br><span class="line">[root@puppet manifests]# vim service1.pp </span><br><span class="line">package&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">&#125;</span><br><span class="line">file&#123;'/etc/redis.conf':</span><br><span class="line">   ensure =&gt; file,</span><br><span class="line">   source =&gt; '/root/manifests/redis.conf',</span><br><span class="line">   require =&gt; Package['redis'],</span><br><span class="line">   owner =&gt; 'redis',</span><br><span class="line">   group =&gt; 'root',</span><br><span class="line">&#125;</span><br><span class="line">service&#123;'redis':</span><br><span class="line">   ensure =&gt; running,</span><br><span class="line">   enable =&gt; true,</span><br><span class="line">   require =&gt; Package['redis'],</span><br><span class="line">   subscribe =&gt; File['/etc/redis.conf'],</span><br><span class="line"><span class="meta">#</span><span class="bash"> 订阅前面的资源，如果前面发生改变就通知后面的资源，服务会重启。notify和subscribe是通知相关的其它资源进行“刷新”操作</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# vim redis.conf</span><br><span class="line">requirepass 123456</span><br><span class="line"><span class="meta">#</span><span class="bash"> 改一下模板的密码</span></span><br><span class="line">[root@puppet manifests]# puppet apply -v service1.pp  </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.41 seconds</span><br><span class="line">Warning: The package type's allow_virtual parameter will be changing its default value from false to true in a future release. If you do not want to allow virtual packages, please explicitly set allow_virtual to false.</span><br><span class="line">   (at /usr/share/ruby/vendor_ruby/puppet/type.rb:816:in `set_default')</span><br><span class="line">Info: Applying configuration version '1548906366'</span><br><span class="line">Info: /Stage[main]/Main/File[/etc/redis.conf]: Filebucketed /etc/redis.conf to puppet with sum 1a1a5828970c05c20bb80d5930c66f12</span><br><span class="line">Notice: /Stage[main]/Main/File[/etc/redis.conf]/content: content changed '&#123;md5&#125;1a1a5828970c05c20bb80d5930c66f12' to '&#123;md5&#125;3a3222440b0c68afc02b378da96a22b7'</span><br><span class="line">Notice: /Stage[main]/Main/File[/etc/redis.conf]/mode: mode changed '0644' to '0640'</span><br><span class="line">Info: /Stage[main]/Main/File[/etc/redis.conf]: Scheduling refresh of Service[redis]</span><br><span class="line">Info: /Stage[main]/Main/File[/etc/redis.conf]: Scheduling refresh of Service[redis]</span><br><span class="line">Notice: /Stage[main]/Main/Service[redis]: Triggered 'refresh' from 2 events</span><br><span class="line">Notice: Finished catalog run in 0.25 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提示会刷新服务，对服务来说刷新就是重启</span></span><br><span class="line">[root@puppet manifests]# grep -E -v "^$|^#" /etc/redis.conf                 </span><br><span class="line">bind 0.0.0.0</span><br><span class="line">requirepass 123456</span><br><span class="line"><span class="meta">#</span><span class="bash"> 密码变了</span></span><br><span class="line">[root@puppet manifests]# redis-cli </span><br><span class="line">127.0.0.1:6379&gt; AUTH 123456</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 密码生效了，说明服务重启了</span></span><br><span class="line">[root@puppet manifests]# ss -tln</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128    *:6379                   *:* </span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听地址也改变了</span></span><br><span class="line"></span><br><span class="line">* 方法二</span><br><span class="line">[root@puppet manifests]# vim service1.pp</span><br><span class="line">package&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   allow_virtual =&gt; false,	</span><br><span class="line">&#125; -&gt;		# 表示package在file之前执行</span><br><span class="line">file&#123;'/etc/redis.conf':</span><br><span class="line">   ensure =&gt; file,</span><br><span class="line">   source =&gt; '/root/manifests/redis.conf',</span><br><span class="line">   owner =&gt; 'redis',</span><br><span class="line">   group =&gt; 'root',</span><br><span class="line">&#125; ~&gt;		# 表示通知后面的service</span><br><span class="line">service&#123;'redis':</span><br><span class="line">   ensure =&gt; running,</span><br><span class="line">   enable =&gt; true,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">* 方法三</span><br><span class="line">[root@puppet manifests]# vim service1.pp                    </span><br><span class="line">package&#123;'redis':</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   allow_virtual =&gt; false,</span><br><span class="line">&#125; </span><br><span class="line">file&#123;'/etc/redis.conf':</span><br><span class="line">   ensure =&gt; file,</span><br><span class="line">   source =&gt; '/root/manifests/redis.conf',</span><br><span class="line">   owner =&gt; 'redis',</span><br><span class="line">   group =&gt; 'root',</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从源文件路径中将文件复制到file指定的目标路径</span></span><br><span class="line">service&#123;'redis':</span><br><span class="line">   ensure =&gt; running,</span><br><span class="line">   enable =&gt; true,</span><br><span class="line">&#125;</span><br><span class="line">Package['redis'] -&gt; File['/etc/redis.conf'] ~&gt; Service['redis']</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以在最下面单独定义通知和依赖关系，感觉这种方法使逻辑更清晰</span></span><br><span class="line">[root@puppet manifests]# vim redis.conf</span><br><span class="line">bind 127.0.0.1</span><br><span class="line">[root@puppet manifests]# puppet apply -v service1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.38 seconds</span><br><span class="line">Info: Applying configuration version '1548907154'</span><br><span class="line">Info: /Stage[main]/Main/File[/etc/redis.conf]: Filebucketed /etc/redis.conf to puppet with sum 3a3222440b0c68afc02b378da96a22b7</span><br><span class="line">Notice: /Stage[main]/Main/File[/etc/redis.conf]/content: content changed '&#123;md5&#125;3a3222440b0c68afc02b378da96a22b7' to '&#123;md5&#125;632baae21fab969118a56acd6b389543'</span><br><span class="line">Info: /Stage[main]/Main/File[/etc/redis.conf]: Scheduling refresh of Service[redis]</span><br><span class="line">Notice: /Stage[main]/Main/Service[redis]: Triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.22 seconds</span><br><span class="line">[root@puppet manifests]# ss -tln</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128    127.0.0.1:6379                   *:* </span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到服务重启了。但有些服务是不能重启的，如nginx。要在定义资源时写restart为nginx -s reload，改restart命令，不让其重启</span></span><br></pre></td></tr></table></figure>
<h5 id="生成指定信息的文件"><a href="#生成指定信息的文件" class="headerlink" title="生成指定信息的文件"></a>生成指定信息的文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim file2.pp</span><br><span class="line">file&#123;'/tmp/test.txt':		# 生成/tmp/test.txt文件</span><br><span class="line">   ensure =&gt; file,		# 这里也可以用persent</span><br><span class="line">   content =&gt; 'Hello there',		# 文件还可以基于content生成，用/n可换行</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用content生成文件信息，写入到file指定的目标文件中</span></span><br><span class="line">[root@puppet manifests]# puppet apply file2.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.07 seconds</span><br><span class="line">Notice: /Stage[main]/Main/File[/tmp/test.txt]/ensure: defined content as '&#123;md5&#125;e8ea7a8d1e93e8764a84a0f3df4644de'</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line">[root@puppet manifests]# cat /tmp/test.txt </span><br><span class="line">Hello there</span><br></pre></td></tr></table></figure>
<h5 id="生成软链接"><a href="#生成软链接" class="headerlink" title="生成软链接"></a>生成软链接</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim file3.pp</span><br><span class="line">file&#123;'/tmp/test.txt.link':		# 生成链接文件</span><br><span class="line">   ensure =&gt; link,		# 链接文件类型</span><br><span class="line">   target =&gt; '/tmp/test.txt',		# 指定源文件路径</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply file3.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.07 seconds</span><br><span class="line">Notice: /Stage[main]/Main/File[/tmp/test.txt.link]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 0.03 seconds</span><br><span class="line">[root@puppet manifests]# ll /tmp</span><br><span class="line">lrwxrwxrwx 1 root root 13 Jan 31 12:09 test.txt.link -&gt; /tmp/test.txt</span><br></pre></td></tr></table></figure>
<h5 id="复制目录"><a href="#复制目录" class="headerlink" title="复制目录"></a>复制目录</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim file4.pp</span><br><span class="line">file&#123;'/tmp/pam.d':</span><br><span class="line">   ensure =&gt; directory,</span><br><span class="line">   source =&gt; '/etc/pam.d',</span><br><span class="line">   recurse =&gt; true,		# 表示递归复制整个目录</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果不用<span class="built_in">source</span>和recurse，那么就会创建一个空目录。测试不用recurse也会创建一个pam.d的空目录。</span></span><br><span class="line">[root@puppet manifests]# puppet apply file4.pp</span><br><span class="line">[root@puppet manifests]# ll /tmp/pam.d/</span><br><span class="line">total 108</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到目录被复制了</span></span><br></pre></td></tr></table></figure>
<h4 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h4><h5 id="基本执行"><a href="#基本执行" class="headerlink" title="基本执行"></a>基本执行</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim exec1.pp</span><br><span class="line">exec&#123;'mkdir':		# mkdir不能当命令用，如果要当，要加路径</span><br><span class="line">   command =&gt; 'mkdir /tmp/testdir',</span><br><span class="line">   path =&gt; '/bin:/sbin:/usr/bin:/usr/sbin',		# 一定要给定命令路径</span><br><span class="line">   creates =&gt; '/tmp/testdir',		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只有在此目录不存在时才执行。对于目录或文件路径类的操作资源来讲，可以用creates来判断，如果不存在才创建</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v exec1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.02 seconds</span><br><span class="line">Info: Applying configuration version '1548908746'</span><br><span class="line">Notice: /Stage[main]/Main/Exec[mkdir]/returns: executed successfully</span><br><span class="line">Notice: Finished catalog run in 0.06 seconds</span><br><span class="line">[root@puppet manifests]# ls /tmp/</span><br><span class="line">testdir</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令执行了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果文件中不加creates一项，执行时会报错，因为已经有目录了，这个命令是不幂等的。如果有creates一项，就不会报错了</span></span><br></pre></td></tr></table></figure>
<h5 id="判断执行"><a href="#判断执行" class="headerlink" title="判断执行"></a>判断执行</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim exec2.pp </span><br><span class="line">exec&#123;'adduser':</span><br><span class="line">   command =&gt; 'useradd -r mogilefs',</span><br><span class="line">   path =&gt; '/bin:/sbin:/usr/bin:/usr/sbin',</span><br><span class="line">   unless =&gt; 'id mogilefs',		# unless表示其指定的命令执行失败了才执行上面的创建用户命令</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply exec2.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.02 seconds</span><br><span class="line">Notice: /Stage[main]/Main/Exec[adduser]/returns: executed successfully</span><br><span class="line">Notice: Finished catalog run in 0.08 seconds</span><br><span class="line">[root@puppet manifests]# id mogilefs</span><br><span class="line">uid=442(mogilefs) gid=442(mogilefs) groups=442(mogilefs)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令执行成功了</span></span><br><span class="line">[root@puppet manifests]# puppet apply exec2.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.02 seconds</span><br><span class="line">Notice: Finished catalog run in 0.06 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次执行时，就不会再执行文件中的命令了</span></span><br><span class="line"></span><br><span class="line">[root@puppet manifests]# vim exec2.pp</span><br><span class="line">package&#123;'mogilefs':</span><br><span class="line">   ensure =&gt; latest,</span><br><span class="line">&#125;</span><br><span class="line">exec&#123;'adduser':</span><br><span class="line">   command =&gt; 'useradd -r mogilefs',</span><br><span class="line">   path =&gt; '/bin:/sbin:/usr/bin:/usr/sbin',</span><br><span class="line">   unless =&gt; 'id mogilefs',</span><br><span class="line">   refreshonly =&gt; true,</span><br><span class="line"><span class="meta">#</span><span class="bash"> refreshonly作用是让<span class="built_in">exec</span>仅在其他资源用notify或subscribe事件通知时才会执行，如果被通知多次就执行多次。</span></span><br><span class="line">   subscribe =&gt; Package['mogilefs'],</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义何时执行，Package表示其指定的包安装后才执行</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# userdel -r mogilefs</span><br><span class="line">[root@puppet manifests]# puppet apply -v exec2.pp   </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.27 seconds</span><br><span class="line">Info: Applying configuration version '1548909636'</span><br><span class="line">Error: Could not update: Execution of '/usr/bin/yum -d 0 -e 0 -y list mogilefs' returned 1: Error: No matching Packages to list</span><br><span class="line">Wrapped exception:</span><br><span class="line">Execution of '/usr/bin/yum -d 0 -e 0 -y list mogilefs' returned 1: Error: No matching Packages to list</span><br><span class="line">Error: /Stage[main]/Main/Package[mogilefs]/ensure: change from absent to latest failed: Could not update: Execution of '/usr/bin/yum -d 0 -e 0 -y list mogilefs' returned 1: Error: No matching Packages to list</span><br><span class="line">Notice: /Stage[main]/Main/Exec[adduser]: Dependency Package[mogilefs] has failures: true</span><br><span class="line">Warning: /Stage[main]/Main/Exec[adduser]: Skipping because of failed dependencies</span><br><span class="line">Notice: Finished catalog run in 4.67 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提示没有程序包，不能执行</span></span><br><span class="line">[root@puppet manifests]# id mogilefs</span><br><span class="line">id: mogilefs: no such user</span><br></pre></td></tr></table></figure>
<h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim cron1.pp</span><br><span class="line">cron&#123;'synctime':</span><br><span class="line">   command =&gt; '/usr/sbin/ntpdate ntp.ubuntu.com &amp;&gt; /dev/null',		# 要执行的命令</span><br><span class="line">   name =&gt; 'synctime from ntp server',</span><br><span class="line">   minute =&gt; '*/3',		# 每3分钟执行一次</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面三个是必须给的属性，不给定用户，就是给当前用户的定时任务</span></span><br><span class="line">   ensure =&gt; present,		# absent表示删除，persent表示添加</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v cron1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.03 seconds</span><br><span class="line">Info: Applying configuration version '1548910460'</span><br><span class="line">Notice: /Stage[main]/Main/Cron[synctime]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 0.09 seconds</span><br><span class="line">[root@puppet manifests]# crontab -l</span><br><span class="line">*/3 * * * * /usr/sbin/ntpdate ntp.ubuntu.com &amp;&gt; /dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加了定时任务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果将上面改为ensure =&gt; absent，再执行一次puppet就会删除定时任务。</span></span><br></pre></td></tr></table></figure>
<h4 id="显示提示信息"><a href="#显示提示信息" class="headerlink" title="显示提示信息"></a>显示提示信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim notify1.pp</span><br><span class="line">notify&#123;'sayhi':</span><br><span class="line">   message =&gt; 'How old are you',</span><br><span class="line">   name =&gt; 'sayhi',</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> notify是显示提示信息的，信息会发送到日志中</span></span><br><span class="line">[root@puppet manifests]# puppet apply notify1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.01 seconds</span><br><span class="line">Notice: How old are you</span><br><span class="line">Notice: /Stage[main]/Main/Notify[sayhi]/message: defined 'message' as 'How old are you'</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 结果中有Notify:后是message定义的信息</span></span><br></pre></td></tr></table></figure>
<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">定义变量：以$开头，如：$system、$flag</span><br><span class="line">赋值：=  ，如：$one = "first one"</span><br><span class="line"></span><br><span class="line">引用变量：有三种方法如下</span><br><span class="line"><span class="meta">$</span><span class="bash">var = <span class="string">"Hello World!"</span></span></span><br><span class="line">notice "1.$var"</span><br><span class="line">notice "2.$&#123;var&#125;"</span><br><span class="line">notice "3.$::var"</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# facter -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 收集打印当前系统上的所有变量，这些变量会传递给puppet主机</span></span><br><span class="line">[root@puppet manifests]# vim user3.pp</span><br><span class="line">[root@puppet manifests]# vim user3.pp             </span><br><span class="line"><span class="meta">$</span><span class="bash">username = <span class="string">"test"</span></span></span><br><span class="line"></span><br><span class="line">group&#123;"$username":		# 在使用变量时要用双引号引用</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   system =&gt; true,</span><br><span class="line">&#125; -&gt;</span><br><span class="line">user&#123;"$username":</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   gid =&gt; "$username",</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v user3.pp</span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.12 seconds</span><br><span class="line">Info: Applying configuration version '1548913706'</span><br><span class="line">Notice: /Stage[main]/Main/Group[test]/ensure: created</span><br><span class="line">Notice: /Stage[main]/Main/User[test]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 0.08 seconds.</span><br><span class="line">[root@puppet manifests]# id test</span><br><span class="line">uid=1000(test) gid=896(test) groups=896(test)</span><br><span class="line">[root@puppet manifests]# grep test /etc/group</span><br><span class="line">test:x:896:</span><br></pre></td></tr></table></figure>
<h4 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">语法结构：</span><br><span class="line"></span><br><span class="line">/(?&lt;ENABLED OPTION&gt;:&lt;SUBPATTERN&gt;)/</span><br><span class="line">/(?-&lt;DISABLED OPTION&gt;:&lt;SUBPATTERN&gt;)/</span><br><span class="line"></span><br><span class="line">OPTION：</span><br><span class="line">i: 忽略字符大小写</span><br><span class="line">m: 把点号当换行符使用</span><br><span class="line">x：忽略模式中的空白字符和注释</span><br><span class="line"></span><br><span class="line">惯常用法：(?i-mx:PATTERN)</span><br><span class="line"><span class="meta">$</span><span class="bash">webpackage=<span class="variable">$operatingsystem</span>? &#123;</span></span><br><span class="line">       /(?i-mx:ubuntu|debian)/ =&gt; ‘apache2‘,</span><br><span class="line">       /(?i-mx:fedora|redhat|centos)/  =&gt; ‘httpd‘,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="判断语句"><a href="#判断语句" class="headerlink" title="判断语句"></a>判断语句</h4><h5 id="if判断"><a href="#if判断" class="headerlink" title="if判断"></a>if判断</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">语法一</span><br><span class="line">if 条件 &#123;</span><br><span class="line">语句</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">条件：是true执行语句，是false则跳过语句</span><br><span class="line"></span><br><span class="line">语法二</span><br><span class="line">if CONDITION &#123;</span><br><span class="line">...</span><br><span class="line">&#125; else &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">语法三</span><br><span class="line">if CONDITION &#123;</span><br><span class="line">...</span><br><span class="line">&#125; elsif CONDITION &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">else &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">if $operatingsystem =~ /^(?i-mx:(Ubuntu|RedHat))/ &#123;</span><br><span class="line">       notice("Welcome to $1 linux distribution.")</span><br><span class="line">&#125; else &#123;</span><br><span class="line">       notice("Welcome to unkown world.")</span><br><span class="line">&#125;</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# vim if.pp</span><br><span class="line">if $operatingsystem == 'CentOS' &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      ensure =&gt; present,</span><br><span class="line">      allow_virtual =&gt; false,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop if.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.22 seconds</span><br><span class="line">Info: Applying configuration version '1548914166'</span><br><span class="line">Notice: /Stage[main]/Main/Package[nginx]/ensure: current_value absent, should be present (noop)</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.13 seconds</span><br><span class="line"></span><br><span class="line">[root@puppet manifests]# vim if.pp</span><br><span class="line">if $operatingsystem == 'Fedora' &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      ensure =&gt; present,</span><br><span class="line">      allow_virtual =&gt; false,</span><br><span class="line">   &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">   notify&#123;'goaway':</span><br><span class="line">      message =&gt; 'allien',</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop if.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.01 seconds</span><br><span class="line">Info: Applying configuration version '1548914282'</span><br><span class="line">Notice: /Stage[main]/Main/Notify[goaway]/message: current_value absent, should be allien (noop)</span><br><span class="line">Notice: Class[Main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.04 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行了message</span></span><br></pre></td></tr></table></figure>
<h5 id="unless判断"><a href="#unless判断" class="headerlink" title="unless判断"></a>unless判断</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">语法</span><br><span class="line">unless 条件 &#123;</span><br><span class="line">语句</span><br><span class="line">&#125;</span><br><span class="line">条件：当false时，执行语句。当true时跳过。</span><br><span class="line">==============================================================================================</span><br><span class="line">例</span><br><span class="line"><span class="meta">$</span><span class="bash">varless = 100</span></span><br><span class="line">unless $varless &gt; 1000 &#123;</span><br><span class="line">  notice "$varless &gt; 1000 is false"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="case判断"><a href="#case判断" class="headerlink" title="case判断"></a>case判断</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">语法</span><br><span class="line">case 变量/表达式 &#123;</span><br><span class="line">值1 : &#123;语句1&#125;</span><br><span class="line">值2,值3 : &#123;语句2&#125;</span><br><span class="line">default : &#123;不是上面的值时，执行这条语句&#125;</span><br><span class="line">&#125;</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# vim case.pp</span><br><span class="line">case $operatingsystem &#123;</span><br><span class="line">   RedHat,CentOS,Fedora: &#123; $webserver = 'httpd' &#125;</span><br><span class="line">   /(?i-mx:debian|ubuntu)/: &#123; $webserver = "apache2" &#125;</span><br><span class="line">   default: &#123; $webserver = 'httpd' &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果是RedHat等，就定义webserver变量为httpd，如果是debian等，就为apache2，否则就为httpd</span></span><br><span class="line">&#125;</span><br><span class="line">package&#123;"$webserver":</span><br><span class="line">   ensure =&gt; latest,</span><br><span class="line">   allow_virtual =&gt; false,</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# puppet apply -v case.pp           </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.23 seconds</span><br><span class="line">Info: Applying configuration version '1548915048'</span><br><span class="line">Notice: /Stage[main]/Main/Package[httpd]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 8.68 seconds</span><br><span class="line">[root@puppet manifests]# rpm -q httpd</span><br><span class="line">httpd-2.4.6-88.el7.centos.x86_64</span><br></pre></td></tr></table></figure>
<h5 id="selector判断"><a href="#selector判断" class="headerlink" title="selector判断"></a>selector判断</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">语法</span><br><span class="line">未知变量 = 可知变量 ? &#123;</span><br><span class="line">值1 =&gt; 赋值1,</span><br><span class="line">值2 =&gt; 赋值2,</span><br><span class="line">default =&gt; 赋值3,</span><br><span class="line">&#125;</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# vim selector.pp</span><br><span class="line"><span class="meta">$</span><span class="bash">webserver = <span class="variable">$operatingsystem</span> ? &#123;</span></span><br><span class="line">   /(ubuntu|debian)/ =&gt; 'apache2',</span><br><span class="line">   /(?i-mx:centos|redhat|fedora)/ =&gt; 'httpd',</span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line">   default =&gt; 'httpd',</span><br><span class="line">&#125;</span><br><span class="line">package&#123;"$webserver":</span><br><span class="line">   ensure =&gt; present,</span><br><span class="line">   allow_virtual =&gt; false,</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用这种方法也可以判断，判断operatingsystem是什么，然后赋值给webserver。</span></span><br><span class="line">[root@puppet manifests]# yum remove httpd -y</span><br><span class="line">[root@puppet manifests]# puppet apply selector.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.23 seconds</span><br><span class="line">Notice: /Stage[main]/Main/Package[httpd]/ensure: created</span><br><span class="line">Notice: Finished catalog run in 9.19 seconds</span><br><span class="line">[root@puppet manifests]# rpm -q httpd</span><br><span class="line">httpd-2.4.6-88.el7.centos.x86_64</span><br></pre></td></tr></table></figure>
<h4 id="类"><a href="#类" class="headerlink" title="类"></a>类</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">语法</span><br><span class="line">class name &#123;</span><br><span class="line">... puppet code ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义过的类只有被调用(声明)才会执行；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 类名可以包含小写字母、数字和下划线，但只能小写字母开头；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 类会引入新的变量作用域；</span></span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# vim class1.pp</span><br><span class="line">class nginx &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">      allow_virtual =&gt; false,</span><br><span class="line">   &#125; -&gt;</span><br><span class="line">   service&#123;'nginx':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">include nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要使用include来调用，不然是不能执行的</span></span><br><span class="line">[root@puppet manifests]# puppet apply -v --noop class1.pp </span><br><span class="line">Notice: Compiled catalog for puppet in environment production in 0.33 seconds</span><br><span class="line">Info: Applying configuration version '1548917037'</span><br><span class="line">Notice: /Stage[main]/Nginx/Package[nginx]/ensure: current_value absent, should be latest (noop)</span><br><span class="line">Notice: /Stage[main]/Nginx/Service[nginx]/ensure: current_value stopped, should be running (noop)</span><br><span class="line">Info: /Stage[main]/Nginx/Service[nginx]: Unscheduling refresh on Service[nginx]</span><br><span class="line">Notice: Class[Nginx]: Would have triggered 'refresh' from 2 events</span><br><span class="line">Notice: Stage[main]: Would have triggered 'refresh' from 1 events</span><br><span class="line">Notice: Finished catalog run in 0.19 seconds</span><br><span class="line"></span><br><span class="line">[root@puppet manifests]# vim class2.pp</span><br><span class="line">class dbserver ($pkgname='mariadb-server') &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 类有一个参数是<span class="variable">$pkgname</span>，mariadb-server是它的默认值。如果传递值给pkgname，就用传递的值，如果没传，就用默认值</span></span><br><span class="line">   package&#123;"$pkgname":</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">      allow_virtual =&gt; false,</span><br><span class="line">   &#125;</span><br><span class="line">   service&#123;'mariadb.service':</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里要写成mariadb.service，不然会无法启动。测试中，将这里写成mariadb，并在下面加上name =&gt; <span class="string">'mariadb.service'</span>也是不行的，系统还是会提示service中的mariadb启动。会提示找不到。</span></span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果没有定义pkgname的默认值并调用dbserver类，它会不知道包名是什么。如果定义了默认值，在CentOS7上就可以执行了</span></span><br><span class="line">if $operatingsystem == "CentOS" &#123;</span><br><span class="line"><span class="meta">   $</span><span class="bash">dbpkg = <span class="variable">$operatingsystemmajrelease</span> ? &#123;</span></span><br><span class="line">      7 =&gt; 'mariadb-server',</span><br><span class="line">      default =&gt; 'mysqld-server',</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断，如果操作系统是CentOS，并且嵌套判断，如果是7版本，就返回mariadb-server给<span class="variable">$dbpkg</span>，否则，就返回mysqld-server</span></span><br><span class="line">class&#123;'dbserver':		# 给dbserver类的参数传值</span><br><span class="line">   pkgname =&gt; $dbpkg,		# 这里也可以是一个具体的值，用单引号引起</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用class&#123;<span class="string">'dbserver'</span>:传递值也是调用类的一种方法</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果类的参数没有默认值，也可以用这种方法给参数传递值</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样都定义完才能实现根据不同系统安装不同名称的程序包</span></span><br></pre></td></tr></table></figure>
<h4 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# cp class1.pp class3.pp</span><br><span class="line">[root@puppet manifests]# vim class3.pp</span><br><span class="line">class nginx &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">      allow_virtual =&gt; false,</span><br><span class="line">   &#125; -&gt;</span><br><span class="line">   service&#123;'nginx':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">      require =&gt; Package['nginx'],</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">class nginx::web inherits nginx &#123;</span><br><span class="line">   file&#123;'nginx.conf':		# 提供配置文件</span><br><span class="line">      path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">      source =&gt; '/root/manifests/nginx.conf',</span><br><span class="line">   &#125;</span><br><span class="line">   Package['nginx'] -&gt; File['nignx.conf'] ~&gt; Service['nginx']</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义Package要先于File资源，最后要通知Service资源</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> nginx::web是子类的名称，inherits表示继承，最后是父类的名称。这样定义后，子类就能使用父类中定义的内容了</span></span><br><span class="line">class nginx::webproxy inherits nginx &#123;</span><br><span class="line">   file&#123;'nginx.conf':</span><br><span class="line">      path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">      source =&gt; '/root/manifests/nginx-webproxy.conf',</span><br><span class="line">   &#125;</span><br><span class="line">      Service['nginx']&#123;</span><br><span class="line">      enable =&gt; false,</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改父类中属性的值，要先引用属性，再写修改的值。修改的项如果有值，就修改其值，如果没有此项，就新增此项。</span></span><br><span class="line">      require +&gt; File['nginx.conf']		# +&gt;，表示新增一个参数，但不会修改原值，这里表示依赖File属性</span><br><span class="line">   &#125;</span><br><span class="line">   Package['nginx'] -&gt; File['nginx.conf'] ~&gt; Service['nginx']</span><br><span class="line">&#125;</span><br><span class="line">class nginx::mysqlproxy inherits nginx &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">include nginx::webproxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里只能引用一个子类，因为如果定义了多个，在本机上就没法确定用哪个子类了</span></span><br><span class="line">[root@puppet manifests]# yum install -y nginx</span><br><span class="line">[root@puppet manifests]# cp /etc/nginx/nginx.conf /root/manifests</span><br><span class="line">[root@puppet manifests]# cp nginx.conf nginx-webproxy.conf</span><br><span class="line">[root@puppet manifests]# vim nginx-webproxy.conf </span><br><span class="line">location / &#123;</span><br><span class="line">           proxy_pass http://192.168.1.71;</span><br><span class="line">        &#125;</span><br><span class="line">[root@puppet manifests]# yum remove -y nginx</span><br><span class="line">[root@puppet manifests]# puppet apply -v class3.pp</span><br><span class="line"></span><br><span class="line">--------------------</span><br><span class="line">  192.168.1.71</span><br><span class="line">--------------------</span><br><span class="line">[root@puppettest1 ~]# yum install nginx -y</span><br><span class="line">[root@puppettest1 ~]# vim /usr/share/nginx/html/test.html</span><br><span class="line">192.168.1.71</span><br><span class="line">[root@puppettest1 ~]# systemctl start nginx</span><br><span class="line"></span><br><span class="line">访问http://192.168.1.70/test.html，可以看到页面上显示192.168.1.71了。</span><br></pre></td></tr></table></figure>
<h4 id="puppet模板"><a href="#puppet模板" class="headerlink" title="puppet模板"></a>puppet模板</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim template.pp</span><br><span class="line">package&#123;'nginx':</span><br><span class="line">   ensure =&gt; latest,</span><br><span class="line">&#125;</span><br><span class="line">file&#123;'nginx.conf':</span><br><span class="line">   path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">   content =&gt; template('/root/manifests/nginx.conf.erb'),</span><br><span class="line"><span class="meta">#</span><span class="bash"> content表示直接生成内容，template是内建的函数，用它去加载一个指定的模板</span></span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# cp nginx.conf nginx.conf.erb</span><br><span class="line">[root@puppet manifests]# vim nginx.conf.erb </span><br><span class="line">worker_processes &lt;%=  @processorcount %&gt;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> processorcount是变量名称，变量是内建的，与auto相同，通过facter -p processorcount命令可以查看到信息。等号是变量替换</span></span><br><span class="line">[root@puppet manifests]# puppet apply -v template.pp</span><br><span class="line">[root@puppet manifests]# less /etc/nginx/nginx.conf           </span><br><span class="line">worker_processes 2;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用模板后，这里变为了2</span></span><br></pre></td></tr></table></figure>
<h4 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]# vim /etc/puppet/puppet.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件中的[main]表示全局配置段，[agent]表示只用于agent程序</span></span><br><span class="line">[root@puppet manifests]# puppet help config</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看配置文件帮助信息</span></span><br><span class="line">[root@puppet manifests]# puppet config print</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印puppet配置信息。其中的modulepath是模块的路径</span></span><br><span class="line">[root@puppet manifests]# puppet config print modulepath</span><br><span class="line">/etc/puppet/modules:/usr/share/puppet/modules</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只显示modulepath一项</span></span><br><span class="line">[root@puppet manifests]# puppet help module</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看模块配置帮助</span></span><br><span class="line">[root@puppet manifests]# puppet module list</span><br><span class="line">/etc/puppet/modules (no modules installed)</span><br><span class="line">/usr/share/puppet/modules (no modules installed)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看模块信息</span></span><br><span class="line">[root@puppet manifests]# puppet module search nginx</span><br><span class="line">Notice: Searching https://forgeapi.puppetlabs.com ...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到互联网搜索与nginx相关的模块</span></span><br><span class="line">[root@puppet manifests]# puppet module install oris-nginx</span><br><span class="line">Notice: Preparing to install into /etc/puppet/modules ...</span><br><span class="line">Notice: Downloading from https://forgeapi.puppetlabs.com ...</span><br><span class="line">Notice: Installing -- do not interrupt ...</span><br><span class="line">/etc/puppet/modules</span><br><span class="line">└─┬ oris-nginx (v1.3.0)</span><br><span class="line">  ├─┬ puppetlabs-apt (v6.3.0)</span><br><span class="line">  │ └── puppetlabs-translate (v1.2.0)</span><br><span class="line">  └── puppetlabs-stdlib (v5.2.0)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装模块oris-nginx</span></span><br><span class="line">[root@puppet ~]# mkdir modules</span><br><span class="line">[root@puppet ~]# cd modules/</span><br><span class="line">[root@puppet modules]# mkdir -pv chrony/&#123;manifests,files,templates,lib,spec,tests&#125;</span><br><span class="line">[root@puppet modules]# cd chrony/manifests/</span><br><span class="line">[root@puppet manifests]# vim init.pp		# 创建清单，名字不能变，都要叫init.pp</span><br><span class="line">class chrony &#123;		# 这个清单中必须有一个与模块名相同的类的名字。模块名就是module目录中的目录的名字</span><br><span class="line">   package&#123;'chrony':</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">   &#125; -&gt;</span><br><span class="line">   file&#123;'chrony.conf':</span><br><span class="line">      path =&gt; '/etc/chrony.conf',</span><br><span class="line">      source =&gt; 'puppet:///modules/chrony/chrony.conf',</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是源路径，表示/etc/puppet/modules/chrony/files目录，只是files目录是不用写，可以自动找到</span></span><br><span class="line">   &#125; ~&gt;</span><br><span class="line">   service&#123;'chronyd':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# cp /etc/chrony.conf /root/modules/chrony/files/</span><br><span class="line">[root@puppet modules]# vim chrony/files/chrony.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 3.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注释三行</span></span><br><span class="line">[root@puppet modules]# cp -a /root/modules/chrony/ /etc/puppet/modules/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置好模块后，要将整个目录都复制到puppet的模块目录。上面创建的modules目录只是为了临时编辑用的，编辑好后是要复制到指定目录的，指定目录是通过puppet config <span class="built_in">print</span> modulepath命令查看到的两个目录都可以</span></span><br><span class="line">[root@puppet modules]# puppet module list</span><br><span class="line">/etc/puppet/modules</span><br><span class="line">├── chrony (???)</span><br><span class="line">├── oris-nginx (v1.3.0)</span><br><span class="line">├── puppetlabs-apt (v6.3.0)</span><br><span class="line">├── puppetlabs-stdlib (v5.2.0)</span><br><span class="line">└── puppetlabs-translate (v1.2.0)</span><br><span class="line">/usr/share/puppet/modules (no modules installed)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 现在就能看到chrony模块了</span></span><br><span class="line">[root@puppet modules]# puppet apply -v -d --noop -e 'include chrony'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-e调用模块</span></span><br><span class="line">[root@puppet modules]# puppet apply -v -e 'include chrony'</span><br><span class="line">[root@puppet modules]# cat /etc/chrony.conf </span><br><span class="line"><span class="meta">#</span><span class="bash"> Use public servers from the pool.ntp.org project.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span><br><span class="line">server 0.centos.pool.ntp.org iburst</span><br><span class="line"><span class="meta">#</span><span class="bash">server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 3.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到配置文件已被修改</span></span><br><span class="line">[root@puppet modules]# mv /etc/puppet/modules/nginx/ /root</span><br><span class="line"><span class="meta">#</span><span class="bash"> 移走上面安装的nginx模块</span></span><br><span class="line">[root@puppet modules]# mkdir -pv nginx/&#123;manifests,files,templates,spec,lib,tests&#125;</span><br><span class="line">[root@puppet modules]# vim nginx/manifests/init.pp		# 定义一个基类</span><br><span class="line">class nginx &#123;</span><br><span class="line">   package&#123;'nginx':</span><br><span class="line">      ensure =&gt; latest,</span><br><span class="line">   &#125;</span><br><span class="line">   service&#123;'nginx':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet modules]# vim nginx/manifests/webproxy.pp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义子类。如果代码较多，可以定义多个子类，但一定要有一个与清单名一样的类名称。参考官方文档，3.8版本以后的版本中，资源清单文件的文件名要与子类名一样</span></span><br><span class="line">class nginx::webproxy inherits nginx &#123;</span><br><span class="line">   file&#123;'nginx.conf':</span><br><span class="line">      path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">      source =&gt; 'puppet:///modules/nginx/nginx-webproxy.conf',</span><br><span class="line">   &#125;</span><br><span class="line">   Package['nginx'] -&gt; File['nginx.conf'] ~&gt; Service['nginx']</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet modules]# cp /root/manifests/nginx-webproxy.conf nginx/files/</span><br><span class="line">[root@puppet modules]# cp -a nginx/ /etc/puppet/modules/</span><br><span class="line">[root@puppet modules]# puppet module list</span><br><span class="line">/etc/puppet/modules</span><br><span class="line">├── chrony (???)</span><br><span class="line">├── nginx (???)</span><br><span class="line">[root@puppet manifests]# puppet apply -v -d --noop -e 'include nginx::webproxy'</span><br><span class="line">==============================================================================================</span><br><span class="line">注意：</span><br><span class="line">1. puppet 3.8及以后的版本中，资源清单文件的文件名要与文件听类名保持一致，例如某子类名为“base_class::child_class”，其文件名应该为child_class.pp；</span><br><span class="line">2. 无需再资源清单文件中使用import语句；</span><br><span class="line">3. manifests目录下可存在多个清单文件，每个清单文件包含一个类，其文件名同类名；</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@puppet manifests]# pwd</span><br><span class="line">/etc/puppet/modules/nginx/manifests</span><br><span class="line">[root@puppet manifests]# vim web.pp</span><br><span class="line">class nginx::web inherits nginx &#123;</span><br><span class="line">   file&#123;'nginx.conf':</span><br><span class="line">      path =&gt; '/etc/nginx/nginx.conf',</span><br><span class="line">      content =&gt; 'template('nginx/nginx.conf.erb')',</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里应该是一个相对路径，也就是/etc/puppet/modules下的nginx目录，这里可以省略nginx目录中的template目录，直接写template目录中的nginx.conf.erb即可。</span></span><br><span class="line">   &#125;</span><br><span class="line">   Package['nginx'] -&gt; File['nginx.conf'] ~&gt; Service['nginx']</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet manifests]# cp /root/manifests/nginx.conf.erb ../templates/</span><br><span class="line">[root@puppet manifests]# puppet apply -v -d --noop -e 'include nginx::web'</span><br><span class="line"></span><br><span class="line">[root@puppet manifests]# cd /root/modules/</span><br><span class="line">[root@puppet modules]# mkdir -pv redis/&#123;manifests,files,templates,spec,lib,tests&#125;</span><br><span class="line">下载一个redis-3.2.8-1.el7.x86_64.rpm到 /root/modules/redis/tests目录中</span><br><span class="line">[root@puppet modules]# vim redis/manifests/init.pp</span><br><span class="line">class redis &#123;</span><br><span class="line"><span class="meta">   $</span><span class="bash">redispkg=<span class="string">'redis-3.2.8-1.el7.x86_64.rpm'</span></span></span><br><span class="line">   package&#123;'redis':</span><br><span class="line">      ensure =&gt; installed,</span><br><span class="line">      provider =&gt; yum,</span><br><span class="line">      source =&gt; "puppet:///modules/redis/$redispkg",</span><br><span class="line">   &#125;</span><br><span class="line">   service&#123;'redis':</span><br><span class="line">      ensure =&gt; running,</span><br><span class="line">      enable =&gt; true,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@puppet modules]# cp -a redis/ /etc/puppet/modules/</span><br><span class="line">[root@puppet modules]# puppet module list</span><br><span class="line">/etc/puppet/modules</span><br><span class="line">├── chrony (???)</span><br><span class="line">├── nginx (???)</span><br><span class="line">├── puppetlabs-apt (v6.3.0)</span><br><span class="line">├── puppetlabs-stdlib (v5.2.0)</span><br><span class="line">├── puppetlabs-translate (v1.2.0)</span><br><span class="line">└── redis (???)</span><br><span class="line">[root@puppet modules]# puppet apply -v -d --noop -e 'include redis'</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/29/haproxy部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/29/haproxy部署/" itemprop="url">
                  haproxy部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-29 07:29:34 / 修改時間：15:11:40" itemprop="dateCreated datePublished" datetime="2019-01-29T07:29:34+08:00">2019-01-29</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/balance/" itemprop="url" rel="index"><span itemprop="name">balance</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">haproxy配置段分为两段，一为全局配置段，一为代理配置段。代理配置段又分为三段，第一段是frontend，用来定义接收以及从何处接收请求。第二段是backend，定义接收到请求后代理至哪些主机，以及如何进行代理。第三段是listen，定义直接匹配的前端和后端，没有分开定义。这三段如果使用同一个值，用defaults定义。</span><br><span class="line">==============================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Example configuration <span class="keyword">for</span> a possible web application.  See the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> full configuration options online.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Global settings</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line">global		# 全局配置段</span><br><span class="line">    # to have these messages end up in /var/log/haproxy.log you will</span><br><span class="line">    # need to:</span><br><span class="line">    #</span><br><span class="line">    # 1) configure syslog to accept network log events.  This is done</span><br><span class="line">    #    by adding the '-r' option to the SYSLOGD_OPTIONS in</span><br><span class="line">    #    /etc/sysconfig/syslog</span><br><span class="line">    #</span><br><span class="line">    # 2) configure local2 events to go to the /var/log/haproxy.log</span><br><span class="line">    #   file. A line like the following can be added to</span><br><span class="line">    #   /etc/sysconfig/syslog</span><br><span class="line">    #</span><br><span class="line">    #    local2.*                       /var/log/haproxy.log</span><br><span class="line">    #</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义全局日志配置，日志级别为info。127.0.0.1是定义日志输出的地址，local2是日志设备。也就是使用127上的rsyslog来记录日志。这样定义，日志会输出到messages中</span></span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line"><span class="meta">#</span><span class="bash"> pid存放路径</span></span><br><span class="line">    maxconn     4000</span><br><span class="line"><span class="meta">#</span><span class="bash"> haproxy的最大头连接数，与linux的最大打开的文件数有关。一般小于最大打开文件数</span></span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    nbproc		1</span><br><span class="line"><span class="meta">#</span><span class="bash"> haproxy启动时创建的进程数，不要超时CPU的核数</span></span><br><span class="line">    daemon</span><br><span class="line"><span class="meta">#</span><span class="bash"> 做守护进程</span></span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> common defaults that all the <span class="string">'listen'</span> and <span class="string">'backend'</span> sections will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use <span class="keyword">if</span> not designated <span class="keyword">in</span> their block</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line"><span class="meta">#</span><span class="bash"> haproxy实例的运行模式，一般是tcp或http。http就表示工作在七层</span></span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接后端服务器失败重试的次数，如果超过这个值就标记为不可用</span></span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 成功连接服务器的最长等待时间，没有单位是毫秒</span></span><br><span class="line">    timeout client          1m</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端发送数据最长等待时间</span></span><br><span class="line">    timeout server          1m</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务器端回应客户端的最长等待时间</span></span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置检查后端服务器的超时时间，如果超过这个值就标记不可用</span></span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> main frontend <span class="built_in">which</span> proxys to the backends</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line">frontend  main *:5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> main是名称，可自定义名称。*:5000表示监听在所有地址的5000端口</span></span><br><span class="line">    mode	http</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定负载均衡的工作模式</span></span><br><span class="line">	option	httplog</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置haproxy记录http请求的日志记录。建议打开</span></span><br><span class="line">	option	forwardfor</span><br><span class="line"><span class="meta">#</span><span class="bash"> 让后端服务器获取客户端的真实地址</span></span><br><span class="line">	option	httpclose</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端与服务器完成一次连接后，服务器主动关闭这个连接</span></span><br><span class="line">	log		global</span><br><span class="line"><span class="meta">#</span><span class="bash"> 引用全局的日志配置</span></span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /styleshe</span><br><span class="line">ets</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以-i后定义的内容开头的信息的名称为url_static</span></span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以-i后定义的内容结尾的信息的名称为url_static</span></span><br><span class="line">    use_backend static          if url_static</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果是acl中定义了url_static条件的话，就给后端的static池中定义的主机</span></span><br><span class="line">    default_backend             app</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认给app池中定义的主机，也就是不符合给static池的请求都给app</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> static backend <span class="keyword">for</span> serving up images, stylesheets and such</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line">backend static</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义一组后端服务器，static是自取名</span></span><br><span class="line">	mode 		http</span><br><span class="line">	option		redispatch</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用于会话保持</span></span><br><span class="line">	option		abortonclose</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自动结束处理较长的连接</span></span><br><span class="line">    balance     roundrobin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置调度算法</span></span><br><span class="line">	cookie		SERVERID</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定cookie的ID值，表示允许向cookie插入一个serverID。serverID在下面配置。如果是<span class="built_in">source</span>算法，就不用设置	cookie。因为使用cookie就是为了会话保持</span></span><br><span class="line">	option		httpchk GET /index.jsp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 探测后端服务器状态，健康检测，如果长时间无效应，会将后端服务器剔除。haproxy会访问下面sever中定义的每一个后端主机的IP/index.jsp来探测主机是否正常</span></span><br><span class="line">    server      static 127.0.0.1:4331 cookie server1 weight 6 check inter 2000 rise 2 fall 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> static是主机名，自定义的。之后是地址和端口。cookie server1就是定义上面的cookie   SERVERID的。每个server的SERVERID是不一样的。weight是权重。check表示启用对后端服务器的检查，inter是检查的时间间隔，默认单位是毫秒，rise表示连续检查几次标记为正常，fall表示连续检查几次标记为失败</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> round robin balancing between the various backends</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------------------------</span></span><br><span class="line">backend app</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server  app1 127.0.0.1:5001 check</span><br><span class="line">    server  app2 127.0.0.1:5002 check</span><br><span class="line">    server  app3 127.0.0.1:5003 check</span><br><span class="line">    server  app4 127.0.0.1:5004 check</span><br><span class="line">    </span><br><span class="line">listen admin_stats</span><br><span class="line"><span class="meta">#</span><span class="bash"> listen可以同时拥前端和后端，将前端与后端绑定在一起。主要配置与监控相关的信息。admin_stats是自定义名称</span></span><br><span class="line">	bind 0.0.0.0:9188</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置状态页地址和端口</span></span><br><span class="line">	mode http</span><br><span class="line">	log 127.0.0.1  local0 err</span><br><span class="line">	stats refresh 20s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 刷新的时间间隔</span></span><br><span class="line">	stats uri /haproxy-status</span><br><span class="line"><span class="meta">#</span><span class="bash"> 状态页的地址</span></span><br><span class="line">	stats realm welcome login\ Haproxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 欢迎信息</span></span><br><span class="line">	status auth admin:admin123</span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证信息，用户名:密码</span></span><br><span class="line">	stats hide-version</span><br><span class="line"><span class="meta">#</span><span class="bash"> 隐藏版本号</span></span><br><span class="line">	stats admin if TRUE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启管理后端服务器功能</span></span><br><span class="line"></span><br><span class="line">==============================================================================================</span><br><span class="line">算法</span><br><span class="line">1. roundrobin：Each server is used in turns, according to their weights.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置高度算法为轮询，这里的轮询是加权轮询，这取决于下面的server中是否设定了权重。roundrobin是动态算法，支持权重的运行时调整，调整完不用重启服务。另外支持慢启动，慢启动指当后端加入一台新服务器时，调度器会将请求慢慢地分配到新加入的服务器上，如果马上全部分配到新加入的服务器上，对服务器的压力很大。roundrobin对后端主机的数量是有限制的。最多支持4095个。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server options： weight <span class="comment">#</span></span></span><br><span class="line">2. static-rr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 静态算法：不支持权重的运行时调整及慢启动；后端主机数量无上限；</span></span><br><span class="line">3. leastconn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加权最少连接，最少连接的接收请求，这个算法也是动态的。建议使用在支持长连接的会话中。例如MySQL、LDAP等；</span></span><br><span class="line">4.  first：</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据服务器在列表中的位置，自上而下进行调度；前面服务器的连接数达到上限，新请求才会分配给下一台服务。如果后端有三台服务器，这个算法会依次将后端服务器请求打满，第一台打满后再给第二台服务器</span></span><br><span class="line">5. source</span><br><span class="line"><span class="meta">#</span><span class="bash"> 源地址<span class="built_in">hash</span>，相当于nginx中的IPhash，LVS的HS。如果<span class="built_in">hash</span>取决于hast-type，如果是map-based就是取模法，取模法就是把所有服务器按权重虚拟成节点，如果是权重是2就虚拟成两个节点。对数组元素数量取模，等于几就映射给索引为几的服务器，但服务器变动，<span class="built_in">hash</span>值会影响全局。如果是consistent就是一致性<span class="built_in">hash</span></span></span><br><span class="line">6. uri</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将请求同一个uri的主机代理到后端同一台主机，取决与<span class="built_in">hash</span>-type</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对URI的左半部分做<span class="built_in">hash</span>计算，并由服务器总权重相除以后派发至某挑出的服务器；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;<span class="comment">#&lt;frag&gt;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 左半部分：/&lt;path&gt;;&lt;params&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 整个uri：/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;<span class="comment">#&lt;frag&gt;</span></span></span><br><span class="line">7. url_param</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调度时以某个特定的值调度到后端同一主机，用处不大。动态还是静态取决于<span class="built_in">hash</span>-type</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对用户请求的uri&lt;params&gt;部分中的参数的值作<span class="built_in">hash</span>计算，并由服务器总权重相除以后派发至某挑出的服务器；通常用于追踪用户，以确保来自同一个用户的请求始终发往同一个Backend Server；</span></span><br><span class="line">8. hdr(&lt;name&gt;)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求报文的首部，对对应首部的值做<span class="built_in">hash</span>，一样的就给同一主机。可以对浏览器调度</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对于每个http请求，此处由&lt;name&gt;指定的http首部将会被取出做<span class="built_in">hash</span>计算； 并由服务器总权重相除以后派发至某挑出的服务器；没有有效值的会被轮询调度；根据HTTP请求头来锁定每一次HTTP请求 </span></span><br><span class="line">9. rdp-cookie(&lt;name&gt;)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 远程桌面协议</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 表示根据cookie(name)来锁定并哈希第一次TCP请求</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> uri向下的四种算法为七层算法，用的不多</span></span><br><span class="line"></span><br><span class="line">常用的负载均衡算法</span><br><span class="line">1.轮询算法：roundrobin</span><br><span class="line">2. 根据请求源IP算法：source</span><br><span class="line">3. 最少连接者先处理算法：leastconn</span><br><span class="line">==============================================================================================</span><br></pre></td></tr></table></figure>
<h3 id="测试轮询"><a href="#测试轮询" class="headerlink" title="测试轮询"></a>测试轮询</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">环境</span><br><span class="line">准备三台主机</span><br><span class="line">haproxy：外网地址：192.168.1.25；内网地址：172.16.106.143</span><br><span class="line">httpd1：内网地址：172.16.106.145</span><br><span class="line">httpd2：内网地址：172.16.106.144</span><br><span class="line">==============================================================================================</span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">  httpd1&amp;2</span><br><span class="line">---------------</span><br><span class="line">[root@httpd1 ~]# yum install -y httpd</span><br><span class="line">[root@httpd1 ~]# systemctl start chronyd</span><br><span class="line">[root@httpd1 ~]# systemctl enable chronyd</span><br><span class="line">[root@httpd1 ~]# chronyc</span><br><span class="line">chrony version 3.1</span><br><span class="line">Copyright (C) 1997-2003, 2007, 2009-2017 Richard P. Curnow and others</span><br><span class="line">chrony comes with ABSOLUTELY NO WARRANTY.  This is free software, and</span><br><span class="line">you are welcome to redistribute it under certain conditions.  See the</span><br><span class="line">GNU General Public License version 2 for details.</span><br><span class="line"></span><br><span class="line"><span class="meta">chronyc&gt;</span><span class="bash"> waitsync </span></span><br><span class="line">try: 1, refid: 771CCEC1, correction: 0.000001078, skew: 32.010</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步时间</span></span><br><span class="line">[root@httpd1 ~]# vim /var/www/html/index.html</span><br><span class="line">Backend Server 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给两台服务器提供一个主面，另一台服务器的内容是Backend Server 2</span></span><br><span class="line">[root@httpd1 ~]# systemctl start httpd</span><br><span class="line">[root@httpd2 ~]# curl 172.16.106.144</span><br><span class="line">Backend Server 2</span><br><span class="line">[root@httpd2 ~]# curl 172.16.106.145</span><br><span class="line">Backend Server 1</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim /etc/rsyslog.conf</span><br><span class="line"><span class="meta">$</span><span class="bash">ModLoad imudp		<span class="comment"># 基于UDP收集日志</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">UDPServerRun 514		<span class="comment"># 监听端口</span></span></span><br><span class="line">local2.*                                                /var/log/haproxy.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入此行，设置haproxy的日志路径</span></span><br><span class="line">[root@haproxy haproxy]# systemctl restart rsyslog</span><br><span class="line">[root@haproxy ~]# cd /etc/haproxy/</span><br><span class="line">[root@haproxy haproxy]# cp haproxy.cfg&#123;,.bak&#125;</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">global</span><br><span class="line">   log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line">frontend  myweb		# 定义前端主机，取名叫myweb</span><br><span class="line">    bind *:80		# 定义haproxy的监听端口</span><br><span class="line">    default_backend             websrvs		# 定义默认使用的后端主机是websrvs</span><br><span class="line">backend websrvs			# 定义后端主机组叫websrvs</span><br><span class="line">    balance     roundrobin		# 使用轮询的方式</span><br><span class="line">    server      srv1 172.16.106.145:80 check</span><br><span class="line">    server      srv2 172.16.106.144:80 check</span><br><span class="line"><span class="meta">#</span><span class="bash"> 后端主机信息，使用server定义，srv1是haproxy内部引用的ID号，自定义的。它是服务器在haproxy上的内部名称；出现在日志及警告信息；check是对主机的健康检测，如果不加，那么会被认为是始终在线的。这是四层检测，发TCP请求，如果响应就表示在线</span></span><br><span class="line">[root@haproxy haproxy]# systemctl start haproxy</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl 192.168.1.25;done</span><br><span class="line">Backend Server 1</span><br><span class="line">Backend Server 2</span><br></pre></td></tr></table></figure>
<h3 id="first算法"><a href="#first算法" class="headerlink" title="first算法"></a>first算法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">根据服务器在列表中的位置，自上而下进行调度；前面服务器的连接数达到上限，新请求才会分配给下一台服务；</span><br><span class="line">==============================================================================================</span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     first</span><br><span class="line">    server      srv1 172.16.106.145:80 check maxconn 3		# maxconn指定最大并发连接数</span><br><span class="line">    server      srv2 172.16.106.144:80 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service </span><br><span class="line">[root@haproxy haproxy]# yum install -y httpd-tools</span><br><span class="line">[root@haproxy haproxy]# ab -n 100000 -c 10 http://192.168.1.25/index.html</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd2</span><br><span class="line">------------</span><br><span class="line">[root@httpd2 ~]# tail -f /var/log/httpd/access_log </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在第二台web服务器上查看日志，如果有请求日志，就说明第一台web服务器打满了</span></span><br></pre></td></tr></table></figure>
<h3 id="uri算法"><a href="#uri算法" class="headerlink" title="uri算法"></a>uri算法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">对URI的左半部分做hash计算，并由服务器总权重相除以后派发至某挑出的服务器；只要访问的是同一页面，不管是哪台主机，都发往同一台服务器</span><br><span class="line">==============================================================================================</span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     uri</span><br><span class="line">    server      srv1 172.16.106.145:80 check maxconn 3		# maxconn指定最大并发连接数</span><br><span class="line">    server      srv2 172.16.106.144:80 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service </span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">  httpd1&amp;2</span><br><span class="line">---------------</span><br><span class="line">[root@httpd2 ~]# for i in &#123;1..10&#125;;do echo "Test Page $i @BES 1" &gt; /var/www/html/test$i.html;done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在两台主机上分别添加主页</span></span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl http://192.168.1.25/test1.html;done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时显示的内容是一样的，因为请求被发到了同一台主机。另外可以换其他主机再访问，结果应该和这里一样，因为访问的都是同一页面</span></span><br></pre></td></tr></table></figure>
<h3 id="hdr算法"><a href="#hdr算法" class="headerlink" title="hdr算法"></a>hdr算法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">hdr(&lt;name&gt;)：对于每个http请求，此处由&lt;name&gt;指定的http首部将会被取出做hash计算，并由服务器总权重相除以后派发至某挑出的服务器，没有有效值的会被轮询调度。</span><br><span class="line">==============================================================================================</span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     hdr(User-Agent)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对客户端浏览器进行<span class="built_in">hash</span>计算并调度，如果浏览器一样就发往后端同一主机</span></span><br><span class="line">    server      srv1 172.16.106.145:80 check maxconn 3		# maxconn指定最大并发连接数</span><br><span class="line">    server      srv2 172.16.106.144:80 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl http://192.168.1.25/test1.html;done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时不管访问哪个页面，都会被发到同一台服务器处理，到哪台后端服务器是不能预测的</span></span><br></pre></td></tr></table></figure>
<h3 id="压缩测试"><a href="#压缩测试" class="headerlink" title="压缩测试"></a>压缩测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check maxconn 3</span><br><span class="line">    server      srv2 172.16.106.144:80 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# cp /var/log/httpd/access_log /var/www/html/log.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 找一个大一些的文件做压缩测试</span></span><br><span class="line">[root@httpd1 ~]# rsync -e ssh -arzv --progress /var/www/html/log.txt 172.16.106.144:/var/www/html/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将文件复制到另一台web服务器上</span></span><br><span class="line"></span><br><span class="line">用firefox访问192.168.1.77/log.txt，按F12，这时Response headers(响应头)中会有Content-Encoding gzip的显示</span><br></pre></td></tr></table></figure>
<h3 id="备用主机"><a href="#备用主机" class="headerlink" title="备用主机"></a>备用主机</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check </span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line"><span class="meta">#</span><span class="bash"> backup指备用主机，也就是sorryserver.</span></span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl http://192.168.1.25/index.html;done</span><br><span class="line">Backend Server 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时请求只会发到第一台web服务器上</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# systemctl stop httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止web服务</span></span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl http://192.168.1.25/index.html;done</span><br><span class="line">Backend Server 2</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# systemctl start httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动web服务后，所有的请求又都会发到httpd1上了</span></span><br></pre></td></tr></table></figure>
<h3 id="七层反向代理"><a href="#七层反向代理" class="headerlink" title="七层反向代理"></a>七层反向代理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    option httpchk</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2</span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 反向代理在四层还是七层取决于mode设置的是tcp还是http</span></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# tail -f /var/log/httpd/access_log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时这里会不停显示<span class="string">"172.16.106.143 - - [29/Jan/2019:09:54:16 +0800] "</span>OPTIONS / HTTP/1.0<span class="string">" 200 - "</span>-<span class="string">" "</span>-<span class="string">""</span>，这表示haproxy发出的健康检测请求，但这会产生大量无效日志</span></span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    option httpchk GET /index.html HTTP/1.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定使用GET方法，对/index.html检测，协议是HTTP/1.0</span></span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> inter是每隔多久检测一次，单位是毫秒；rise是检测几次就上线，fall检测几次就下线</span></span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# tail -f /var/log/httpd/access_log</span><br><span class="line">172.16.106.143 - - [29/Jan/2019:09:57:45 +0800] "GET /index.html HTTP/1.0" 200 17 "-" "-"</span><br></pre></td></tr></table></figure>
<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    option httpchk GET /index.html HTTP/1.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定使用GET方法，对/index.html检测，协议是HTTP/1.0</span></span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 redir http://www.baidu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> redir &lt;prefix&gt;：将发往此server的所有GET和HEAD类的请求重定向至指定的URL</span></span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">访问192.168.1.25时会被转到百度首页</span><br></pre></td></tr></table></figure>
<h3 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用weight定义权重</span></span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]# for i in `seq 10`;do curl http://192.168.1.25/index.html;done</span><br><span class="line">Backend Server 1</span><br><span class="line">Backend Server 1</span><br><span class="line">Backend Server 2</span><br></pre></td></tr></table></figure>
<h3 id="状态页"><a href="#状态页" class="headerlink" title="状态页"></a>状态页</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    stats enable</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 </span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">访问192.168.1.25/haproxy?stats，如果设置中没有用stats uri指定页面地址，/haproxy?stats是默认的页面。页面中会用颜色标记后端主机，配置文件中的第二个server是backup，不同状态主机用不同颜色标识。停掉第一台web服务器的服务，颜色也会改变</span><br></pre></td></tr></table></figure>
<h3 id="自定义状态页uri"><a href="#自定义状态页uri" class="headerlink" title="自定义状态页uri"></a>自定义状态页uri</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin		# 自定义状态页uri</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 </span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">访问http://192.168.1.25/myproxy?admin</span><br></pre></td></tr></table></figure>
<h3 id="登录状态页认证"><a href="#登录状态页认证" class="headerlink" title="登录状态页认证"></a>登录状态页认证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin		# 自定义状态页uri</span><br><span class="line">    stats realm "HAProxy Stats Page"		# 设置登录认证时弹出的信息。测试中此项未起作用</span><br><span class="line">    stats auth admin:centos		# 设置认证的用户名和密码</span><br><span class="line">    stats admin if TRUE		# 启用页面的管理功能，if TRUE表示一直为真，总是可以访问，生产中不能这样使用</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 </span><br><span class="line">    server      srv2 172.16.106.144:80 check backup</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">访问http://192.168.1.25/myproxy?admin，打开页面的管理功能后，可以页面进行一些简单操作</span><br></pre></td></tr></table></figure>
<h3 id="自定义状态页面的端口"><a href="#自定义状态页面的端口" class="headerlink" title="自定义状态页面的端口"></a>自定义状态页面的端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2</span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1</span><br><span class="line">listen stats		# listen可以同时拥前端和后端，将前端与后端绑定在一起。主要配置与监控相关的信息。</span><br><span class="line">    bind *:9099</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在这里定义listen，名字叫stats，之后用<span class="built_in">bind</span>指定状态页的端口，打开相应功能。与上面一样实现了状态页功能，只是这里又定义了状态页的端口</span></span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">访问http://192.168.1.25:9099/myproxy?admin</span><br></pre></td></tr></table></figure>
<h3 id="代理ssh"><a href="#代理ssh" class="headerlink" title="代理ssh"></a>代理ssh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2</span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1</span><br><span class="line">listen stats</span><br><span class="line">    bind *:9099</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">listen sshsrvs</span><br><span class="line">    mode tcp</span><br><span class="line">    bind *:22322</span><br><span class="line">    balance leastconn</span><br><span class="line">    server sshsrv1 172.16.106.145:22 check</span><br><span class="line">    server sshsrv2 172.16.106.144:22 check</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再添加一个listen，用mode指定在tcp层(四层)实现代理。监听在22322端口，leastconn算法表示加权最少连接，最少连接的接收请求，建议使用在支持长连接的会话中。这个算法也是动态的</span></span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]#ssh 192.168.1.25 -p 22322</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接了两次，分别连接到了两台httpd上</span></span><br></pre></td></tr></table></figure>
<h3 id="cookie粘性绑定"><a href="#cookie粘性绑定" class="headerlink" title="cookie粘性绑定"></a>cookie粘性绑定</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">	cookie SRV insert indirect nocache</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2 cookie srv1</span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1 cookie srv1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入cookie的键名，server最后的cookie是其值，cookie的值最好和server的名字一致。当用户访问时，如果被调度到第一台web服务器上，用户的cookie中会加入cookie的键和值在开头，这里就是SRV=srv1，当用户再次访问时，这个cookie的键和值也会到haproxy服务器，这时haproxy就知道上次这个用户的请求被调度到哪台服务器上，这次还会调度到同一台服务器上。insert表示信息数据的插入方式，上面表示仅对indirect和nocache这样的数据拷入cookie</span></span><br><span class="line">listen stats</span><br><span class="line">    bind *:9099</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">listen sshsrvs</span><br><span class="line">    mode tcp</span><br><span class="line">    bind *:22322</span><br><span class="line">    balance leastconn</span><br><span class="line">    server sshsrv1 172.16.106.145:22 check</span><br><span class="line">    server sshsrv2 172.16.106.144:22 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">用浏览器访问192.168.1.25，访问多次也不会有变化</span><br></pre></td></tr></table></figure>
<h3 id="让后端主机收到的请求地址是源地址"><a href="#让后端主机收到的请求地址是源地址" class="headerlink" title="让后端主机收到的请求地址是源地址"></a>让后端主机收到的请求地址是源地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">defaults</span><br><span class="line">    option forwardfor       except 127.0.0.0/8 if-none</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此项是原本就有的，forwardfor表示对请求加入一个首部，得到后端服务器真正的请求地址。except表示除了，这里表示除了本机127地址发出的请求，其他请求都加入首部。<span class="keyword">if</span>-none表示如果没有首部才添加</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# vim /etc/httpd/conf/httpd.conf</span><br><span class="line">LogFormat "%&#123;X-Forwarded-For&#125;i %h %l %u %t \"%r\" %&gt;s %b \"%&#123;Referer&#125;i\" \"%&#123;Use</span><br><span class="line">r-Agent&#125;i\"" combined</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将%h改为%&#123;X-Forwarded-For&#125;i，X-Forwarded-For是haproxy中forwardfor默认的格式</span></span><br><span class="line">[root@httpd1 ~]# systemctl restart httpd</span><br><span class="line">[root@httpd1 ~]# tail -f /var/log/httpd/access_log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次访问192.168.1.25时，查看web服务器日志，可以看到客户端的请求IP地址，而不再是haproxy的内网地址了。</span></span><br></pre></td></tr></table></figure>
<h3 id="添加首部"><a href="#添加首部" class="headerlink" title="添加首部"></a>添加首部</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    reqadd X-Proxy-By:\ HAProxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加请求报文首部，\是转义符，转义后面的空格。X-Proxy-By:\ HAProxy都是自定义的名称，表示这个服务器是由Haproxy代理的</span></span><br><span class="line">    rspadd X-Proxy-By:\ HAProxy-1.5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加响应首部</span></span><br><span class="line">    rspidel ^Server:.*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除响应报文中Server开头的所有内容</span></span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">	cookie SRV insert indirect nocache</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2 cookie srv1</span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1 cookie srv1</span><br><span class="line">listen stats</span><br><span class="line">    bind *:9099</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">listen sshsrvs</span><br><span class="line">    mode tcp</span><br><span class="line">    bind *:22322</span><br><span class="line">    balance leastconn</span><br><span class="line">    server sshsrv1 172.16.106.145:22 check</span><br><span class="line">    server sshsrv2 172.16.106.144:22 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 ~]# vim /etc/httpd/conf/httpd.conf</span><br><span class="line">LogFormat "%&#123;X-Forwarded-For&#125;i %l %u %t \"%r\" %&gt;s %b \"%&#123;Referer&#125;i\" \"%&#123;User-A</span><br><span class="line">gent&#125;i %&#123;X-Proxy-By&#125;i\"" combined</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将请求首部加到最后</span></span><br><span class="line">[root@httpd1 ~]# systemctl restart httpd</span><br><span class="line">[root@httpd1 ~]# tail -f /var/log/httpd/access_log</span><br><span class="line">192.168.1.9 - - [29/Jan/2019:11:13:52 +0800] "GET / HTTP/1.1" 304 - "-" "Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0 HAProxy"</span><br><span class="line">访问192.168.1.25，并查看日志，可以看到请求首部HAProxy</span><br><span class="line">在浏览器上按F12可以看到响应首部，在Response headers中有X-Proxy-By: HAProxy-1.5</span><br></pre></td></tr></table></figure>
<h3 id="acl访问控制"><a href="#acl访问控制" class="headerlink" title="acl访问控制"></a>acl访问控制</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    reqadd X-Proxy-By:\ HAProxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加请求报文首部，\是转义符，转义后面的空格。X-Proxy-By:\ HAProxy都是自定义的名称，表示这个服务器是由Haproxy代理的</span></span><br><span class="line">    rspadd X-Proxy-By:\ HAProxy-1.5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加响应首部</span></span><br><span class="line">    rspidel ^Server:.*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除响应报文中Server开头的所有内容</span></span><br><span class="line">    default_backend             websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">	cookie SRV insert indirect nocache</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2 cookie srv1</span><br><span class="line">    server      srv2 172.16.106.144:80 check weight 1 cookie srv1</span><br><span class="line">listen stats</span><br><span class="line">    bind *:9099</span><br><span class="line">    acl allowstats src 192.168.1.9</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义acl名字是allowstats，只允许源地址是192.168.1.64的地址来访问</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> acl all src 0.0.0.0/0.0.0.0表示设置acl为所有主机地址</span></span><br><span class="line">    block if ! allowstats</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义除allowstats以外的任何主机不能访问，!是取反的。如果没有!号，表示除了allowstats外的主机都能访问。block是阻塞之意。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http-request allow <span class="keyword">if</span> allowstats表示允许allowstats的主机访问，这样所有主机都能访问了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http-request deny <span class="keyword">if</span> all：不允许除allowstats外的其他主机访问</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 先要自定义一个acl，之后用http-request指定，这样可以实现除了allowstats外的其他主机都不能访问</span></span><br><span class="line">==============================================================================================</span><br><span class="line">	acl allowstats src 192.168.1.9</span><br><span class="line">    http-request allow if allowstats</span><br><span class="line">    errorfile 403 /etc/haproxy/errorfiles/403forbid.http</span><br><span class="line">    acl all src 0.0.0.0/0.0.0.0</span><br><span class="line">    http-request deny if all</span><br><span class="line"><span class="meta">#</span><span class="bash">上面可以设置为这样，结果是只有192.168.1.9可以访问状态页，其他主机不可访问。要注意acl与http-request要定义在一起，如果将http-request allow放在http-request deny下面，也会使所有主机都不能访问状态页</span></span><br><span class="line">==============================================================================================</span><br><span class="line">    errorloc 403 http://192.168.1.25:10080/errorloc/403.html</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里不能定义errorfile，因为上面已经拒绝本机访问了，也就是本机不能访问http://192.168.1.25</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里也可以使用errorfile 403 /etc/haproxy/errorfiles/403forbid.http，之后创建/etc/haproxy/errorfiles/403forbid.http，当无权访问时，就会提示错误页的内容。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> errorfile &lt;code&gt; &lt;file&gt;：在用户请求不存在的页面时，返回一个页面文件给客户端而非由haproxy生成的错误代码；可用于所有段中。&lt;code&gt;：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有200、400、403、408、500、502、503和504；&lt;file&gt;：指定用于响应的页面文件；</span></span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">listen sshsrvs</span><br><span class="line">    mode tcp</span><br><span class="line">    bind *:22322</span><br><span class="line">    balance leastconn</span><br><span class="line">    server sshsrv1 172.16.106.145:22 check</span><br><span class="line">    server sshsrv2 172.16.106.144:22 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]# yum install -y nginx</span><br><span class="line">[root@haproxy haproxy]# vim /etc/nginx/conf.d/errorsrv.conf</span><br><span class="line">server &#123;</span><br><span class="line">   listen 10080;</span><br><span class="line">   server_name 192.168.1.25;</span><br><span class="line">   root /data/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy haproxy]# mkdir -pv /data/nginx/html/errorloc</span><br><span class="line">[root@haproxy haproxy]# vim /data/nginx/html/errorloc/403.html</span><br><span class="line">403 Forbidden from nginx </span><br><span class="line">[root@haproxy haproxy]# systemctl start nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用nginx提供一个haproxy的错误页</span></span><br><span class="line">[root@haproxy haproxy]# curl --basic --user admin:centos http://192.168.1.25:9099/myproxy?admin/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用curl命令访问，基于basic认证，用户名和密码用--user指定</span></span><br><span class="line"></span><br><span class="line">使用一台新主机访问http://192.168.1.25:9099/myproxy?admin，因为此主机的地址不是192.168.1.9，所以返回nginx提供的错误页内容：403 Forbidden from nginx。</span><br></pre></td></tr></table></figure>
<h3 id="后端主机动静分离"><a href="#后端主机动静分离" class="headerlink" title="后端主机动静分离"></a>后端主机动静分离</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">后端两台web服务器，一台配置为两个虚拟主机，支持动态服务。另一台也配置为两台虚拟主机，支持静态服务。静态服务当图片服务器</span><br><span class="line">==============================================================================================</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd1</span><br><span class="line">------------</span><br><span class="line">[root@httpd1 network-scripts]# yum install -y php</span><br><span class="line">[root@httpd1 ~]# mkdir -pv /data/web/vhost&#123;1,2&#125;</span><br><span class="line">[root@httpd1 ~]# vim /data/web/vhost1/info.php</span><br><span class="line">&lt;h1&gt;Application Server 1&lt;/h1&gt;		#vhost2中将此处改为Application Server 2</span><br><span class="line">&lt;?php</span><br><span class="line">   phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line">[root@httpd1 ~]# cp /data/web/vhost&#123;1,2&#125;/info.php</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将vhost1中的info.php复制到vhost2中</span></span><br><span class="line">[root@httpd1 ~]# vim /etc/httpd/conf.d/vhost1.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www1.test.com</span><br><span class="line">   DocumentRoot "/data/web/vhost1"</span><br><span class="line">   &lt;Directory "/data/web/vhost1"&gt;</span><br><span class="line">      options FollowSymLinks</span><br><span class="line">      AllowOverride None</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@httpd1 ~]# cp /etc/httpd/conf.d/vhost&#123;1,2&#125;.conf</span><br><span class="line">[root@httpd1 ~]# vim /etc/httpd/conf.d/vhost2.conf</span><br><span class="line">Listen 8080</span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">   ServerName www2.test.com</span><br><span class="line">   DocumentRoot "/data/web/vhost2"</span><br><span class="line">   &lt;Directory "/data/web/vhost2"&gt;</span><br><span class="line">      options FollowSymLinks</span><br><span class="line">      AllowOverride None</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@httpd1 ~]# httpd -t</span><br><span class="line">[root@httpd1 ~]# systemctl restart httpd</span><br><span class="line">访问http://172.16.106.145/info.php，http://172.16.106.145:8080/info.php可以看到php页面</span><br><span class="line">[root@httpd1 ~]# scp /etc/httpd/conf.d/vhost* 172.16.106.144:/etc/httpd/conf.d/</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  httpd2</span><br><span class="line">------------</span><br><span class="line">[root@httpd2 ~]# mkdir -pv /data/web/vhost&#123;1,2&#125;</span><br><span class="line">[root@httpd2 vhost1]# find /usr/share -iname "*.jpg" -exec cp &#123;&#125; /data/web/vhost1/ \;</span><br><span class="line">[root@httpd2 vhost1]# find /usr/share -iname "*.jpg" -exec cp &#123;&#125; /data/web/vhost2/ \;</span><br><span class="line">[root@httpd2 ~]# vim /data/web/vhost1/test.txt</span><br><span class="line">Image Server 1</span><br><span class="line">[root@httpd2 ~]# vim /data/web/vhost2/test.txt</span><br><span class="line">Image Server 2</span><br><span class="line">[root@httpd2 ~]# systemctl restart httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里已有从httpd1上复制过来的配置文件</span></span><br><span class="line">访问http://172.16.106.144/test.txt，http://172.16.106.144:8080/test.txt</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression type text/html text/plain application/xml application/javascript</span><br><span class="line">    acl static path_end .jpg .jpeg .png .gif .txt .html .css .javascript .js</span><br><span class="line"><span class="meta">#</span><span class="bash"> path_end表示以什么结尾的。请求时，一定要写明后缀，如curl 192.168.1.25/index.html，不然请求都会被代理到动态服务器上。因为设置了默认是发给动态服务器，而且动态服务器设置了cookie粘性绑定，信息是不会变的</span></span><br><span class="line">    acl static path_beg /imgs /images /css /javascripts</span><br><span class="line"><span class="meta">#</span><span class="bash"> path_beg定义以什么开头。两个acl可以一起使用</span></span><br><span class="line">    use_backend staticsrvs if static</span><br><span class="line"><span class="meta">#</span><span class="bash"> use_backend表示当符合指定的条件时使用特定的backend。这表示如果访问的内容是以acl中定义的结尾的静态内容，就给后端的staticsrvs主机。否则就给下面default定义的动态主机</span></span><br><span class="line">	default_backend dynsrvs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认主机组</span></span><br><span class="line">    reqadd X-Proxy-By:\ HAProxy</span><br><span class="line">    rspadd X-Proxy-By:\ HAProxy-1.5</span><br><span class="line">    rspidel ^Server:.*</span><br><span class="line">backend dynsrvs</span><br><span class="line">    cookie SRV insert indirect nocache</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.145:80 check inter 3000ms rise 1 fall 2 weight 2 cookie dynsrv1</span><br><span class="line">    server      srv2 172.16.106.145:8080 check weight 1 cookie dynsrv2</span><br><span class="line">backend staticsrvs</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      srv1 172.16.106.144:80 check</span><br><span class="line">    server      srv2 172.16.106.144:8080 check</span><br><span class="line">listen stats</span><br><span class="line">    bind *:9099</span><br><span class="line">    acl allowstats src 192.168.1.9</span><br><span class="line">    block if ! allowstats</span><br><span class="line">    errorloc 403 http://192.168.1.25:10080/errorloc/403.htm</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /myproxy?admin</span><br><span class="line">    stats realm "HAProxy Stats Page"</span><br><span class="line">    stats auth admin:centos</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">listen sshsrvs</span><br><span class="line">    mode tcp</span><br><span class="line">    bind *:22322</span><br><span class="line">    balance leastconn</span><br><span class="line">    server sshsrv1 172.16.106.145:22 check</span><br><span class="line">    server sshsrv2 172.16.106.144:22 check</span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line"></span><br><span class="line">访问状态页192.168.1.25:9099/myproxy?admin</span><br><span class="line">访问192.168.1.25/info.php，因为cookie绑定了，所以内容不会变</span><br><span class="line">访问192.168.1.25/test.txt，多次访问会有变化</span><br></pre></td></tr></table></figure>
<h3 id="阻塞curl工具访问"><a href="#阻塞curl工具访问" class="headerlink" title="阻塞curl工具访问"></a>阻塞curl工具访问</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">	acl bad_browsers hdr_reg(User-Agent) .*curl.*</span><br><span class="line">    block if bad_browsers</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入上面两条，定义acl，用hdr_reg，直接匹配用户请求报文中的首部，下面使用block拒绝acl设置的客户端访问</span></span><br><span class="line">[root@haproxy haproxy]# systemctl restart haproxy.service</span><br><span class="line">[root@haproxy haproxy]# curl http://192.168.1.25</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;</span><br><span class="line">Request forbidden by administrative rules.</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="阻塞域访问"><a href="#阻塞域访问" class="headerlink" title="阻塞域访问"></a>阻塞域访问</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  myweb  *:80</span><br><span class="line">	acl valid_referers hdr_reg(Referer) \.ruopu\.com.*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用hdr_reg，匹配Referer，匹配来自ruopu.com的任何值</span></span><br><span class="line">    block unless valid_referers</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不是上面定义的值就拒绝</span></span><br><span class="line">[root@haproxy haproxy]# curl -e "http://www.ruopu.com/admin.php" http://192.168.1.25/test2.html</span><br><span class="line">Test Page 2 @BES 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用-e模拟一个Referer，这样就能返回值了</span></span><br><span class="line">[root@haproxy haproxy]# curl http://192.168.1.25/test2.html</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;</span><br><span class="line">Request forbidden by administrative rules.</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 直接访问是没有权限的</span></span><br></pre></td></tr></table></figure>
<h3 id="SSL功能"><a href="#SSL功能" class="headerlink" title="SSL功能"></a>SSL功能</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">--------------</span><br><span class="line">  haproxy</span><br><span class="line">--------------</span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend https</span><br><span class="line">    bind *:443 ssl crt /etc/haproxy/certs/haproxy.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义用ssl协议，crt指明密钥的路径</span></span><br><span class="line">    acl static path_end .jpg .jpeg .png .gif .txt .html .css .javascript .js</span><br><span class="line">    acl static path_beg /imgs /images /css /javascripts</span><br><span class="line">    use_backend staticsrvs if static</span><br><span class="line">    default_backend dynsrvs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 与上面一样，如果是特定结尾或开头的就转到静态页，不是的就转到动态页</span></span><br><span class="line"></span><br><span class="line">frontend  http   *:80</span><br><span class="line">    redirect scheme https if ! &#123; ssl_fc &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> redirect即为重定向之意。scheme指协议，ssl_fc指非ssl会话的前端链接。这是定义，如果不是https协议的非前端会话，都转到https443端口上。</span></span><br><span class="line">[root@haproxy certs]# mkdir /etc/haproxy/certs</span><br><span class="line">[root@haproxy certs]# cd /etc/pki/CA</span><br><span class="line">[root@haproxy certs]# (umask 077;openssl genrsa -out private/cakey.pem 4096)</span><br><span class="line">[root@haproxy certs]# openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 365</span><br><span class="line">[root@haproxy certs]# touch index.txt</span><br><span class="line">[root@haproxy certs]# echo 01 &gt; serial</span><br><span class="line">[root@haproxy certs]# cd /etc/haproxy/certs/</span><br><span class="line">[root@haproxy certs]# openssl genrsa -out haproxy.key 2048</span><br><span class="line">[root@haproxy certs]# openssl req -new -key haproxy.key -out haproxy.csr</span><br><span class="line">[root@haproxy certs]# openssl ca -in haproxy.csr -out haproxy.crt</span><br><span class="line">[root@haproxy certs]# cat haproxy.crt haproxy.key &gt; haproxy.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将两个文件打包成pem文件</span></span><br><span class="line">[root@haproxy certs]# chmod 600 haproxy.pem</span><br><span class="line">[root@haproxy certs]# systemctl restart haproxy</span><br><span class="line">[root@haproxy certs]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时应该有443和8080端口被监听</span></span><br><span class="line"></span><br><span class="line">访问https://192.168.1.25/test.txt</span><br><span class="line">访问http://192.168.1.25/test.txt，访问会被重定向到https</span><br><span class="line"></span><br><span class="line">[root@haproxy haproxy]# vim haproxy.cfg</span><br><span class="line">frontend  http   *:80</span><br><span class="line">    redirect location https://192.168.1.25 if ! &#123; ssl_fc &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置所有请求都重定向到https://172.16.0.67</span></span><br><span class="line"></span><br><span class="line">访问http://192.168.1.25/test.txt，这会重定向到https://172.16.0.67。不论访问什么页面，都会重定向到https://172.16.0.67</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/28/LVS部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/28/LVS部署/" itemprop="url">
                  LVS部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-28 18:18:42 / 修改時間：22:25:44" itemprop="dateCreated datePublished" datetime="2019-01-28T18:18:42+08:00">2019-01-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/balance/" itemprop="url" rel="index"><span itemprop="name">balance</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><blockquote>
<p>LVS是 Linux Virtual Server 的简称，也就是Linux虚拟服务器。这是一个由章文嵩博士发起的一个开源项目，它的官方网是 <a href="http://www.linuxvirtualserver.org" target="_blank" rel="noopener">http://www.linuxvirtualserver.org</a> 现在 LVS 已经是 Linux 内核标准的一部分。使用 LVS 可以达到的技术目标是：通过 LVS 达到的负载均衡技术和 Linux 操作系统实现一个高性能高可用的 Linux 服务器集群，它具有良好的可靠性、可扩展性和可操作性。从而以低廉的成本实现最优的性能。LVS 是一个实现负载均衡集群的开源软件项目，LVS架构从逻辑上可分为调度层、Server集群层和共享存储。</p>
</blockquote>
<h3 id="LVS的基本工作原理"><a href="#LVS的基本工作原理" class="headerlink" title="LVS的基本工作原理"></a>LVS的基本工作原理</h3><p><img src="/images/lvs/基本工作原理.png" alt=""></p>
<blockquote>
<ol>
<li><p>当用户向负载均衡调度器（Director Server）发起请求时，调度器将请求发往至内核空间</p>
</li>
<li><p>PREROUTING链首先会接收到用户请求，判断目标IP确定是本机IP，将数据包发往INPUT链</p>
</li>
<li><p>IPVS是工作在INPUT链上的，当用户请求到达INPUT时，IPVS会将用户请求和自己已定义好的集群服务进行比对，如果用户请求的就是定义的集群服务，那么此时IPVS会强行修改数据包里的目标IP地址及端口，并将新的数据包发往POSTROUTING链</p>
</li>
<li><p>POSTROUTING链接收数据包后发现目标IP地址刚好是自己的后端服务器，那么此时通过选路，将数据包最终发送给后端的服务器</p>
</li>
</ol>
</blockquote>
<h3 id="LVS的组成"><a href="#LVS的组成" class="headerlink" title="LVS的组成"></a>LVS的组成</h3><blockquote>
<p>LVS 由两部分程序组成，包括 ipvs 和 ipvsadm。</p>
<ol>
<li><p>ipvs(ip virtual server)：一段代码工作在内核空间，叫ipvs，是真正生效实现调度的代码。</p>
</li>
<li><p>ipvsadm：在用户空间，负责为ipvs内核框架编写规则，定义谁是集群服务，而谁是后端真实的服务器(Real Server)</p>
</li>
</ol>
</blockquote>
<h3 id="LVS相关术语"><a href="#LVS相关术语" class="headerlink" title="LVS相关术语"></a>LVS相关术语</h3><blockquote>
<ol>
<li>DS：Director Server。前端负载均衡器节点。</li>
<li>RS：Real Server。后端真实的工作服务器。</li>
<li>VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址。</li>
<li>DIP：Director Server IP，前端负载均衡器节点上用于和内部主机通讯的IP地址。</li>
<li>RIP：Real Server IP，后端服务器的IP地址。</li>
<li>CIP：Client IP，访问客户端的IP地址。</li>
</ol>
</blockquote>
<h3 id="LVS-NAT原理和特点"><a href="#LVS-NAT原理和特点" class="headerlink" title="LVS/NAT原理和特点"></a>LVS/NAT原理和特点</h3><p><img src="/images/lvs/nat原理.png" alt=""></p>
<blockquote>
<ol>
<li>当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP</li>
<li>PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</li>
<li>IPVS比对数据包请求的服务是否为集群服务，若是，修改数据包的目标IP地址为后端服务器IP，然后将数据包发至POSTROUTING链。 此时报文的源IP为CIP，目标IP为RIP</li>
<li>POSTROUTING链通过选路，将数据包发送给Real Server</li>
<li>Real Server比对发现目标为自己的IP，开始构建响应报文发回给Director Server。 此时报文的源IP为RIP，目标IP为CIP</li>
<li>Director Server在响应客户端前，此时会将源IP地址修改为自己的VIP地址，然后响应给客户端。 此时报文的源IP为VIP，目标IP为CIP</li>
</ol>
</blockquote>
<h4 id="LVS-NAT模型的特性"><a href="#LVS-NAT模型的特性" class="headerlink" title="LVS-NAT模型的特性"></a>LVS-NAT模型的特性</h4><blockquote>
<ol>
<li>RS应该使用私有地址，RS的网关必须指向DIP</li>
<li>DIP和RIP必须在同一个网段内</li>
<li>请求和响应报文都需要经过Director Server，高负载场景中，Director Server易成为性能瓶颈<br>支持端口映射</li>
<li>RS可以使用任意操作系统</li>
<li>缺陷：对Director Server压力会比较大，请求和响应都需经过director server</li>
</ol>
</blockquote>
<h3 id="LVS-DR原理和特点"><a href="#LVS-DR原理和特点" class="headerlink" title="LVS/DR原理和特点"></a>LVS/DR原理和特点</h3><p><img src="/images/lvs/dr原理.png" alt=""></p>
<blockquote>
<ol>
<li>当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP</li>
<li>PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</li>
<li>IPVS比对数据包请求的服务是否为集群服务，若是，将请求报文中的源MAC地址修改为DIP的MAC地址，将目标MAC地址修改RIP的MAC地址，然后将数据包发至POSTROUTING链。 此时的源IP和目的IP均未修改，仅修改了源MAC地址为DIP的MAC地址，目标MAC地址为RIP的MAC地址</li>
<li>由于DS和RS在同一个网络中，所以是通过二层来传输。POSTROUTING链检查目标MAC地址为RIP的MAC地址，那么此时数据包将会发至Real Server。</li>
<li>RS发现请求报文的MAC地址是自己的MAC地址，就接收此报文。处理完成之后，将响应报文通过lo接口传送给eth0网卡然后向外发出。 此时的源IP地址为VIP，目标IP为CIP</li>
<li>响应报文最终送达至客户端</li>
</ol>
</blockquote>
<h4 id="LVS-DR模型的特性"><a href="#LVS-DR模型的特性" class="headerlink" title="LVS-DR模型的特性"></a>LVS-DR模型的特性</h4><blockquote>
<p>特点</p>
<ol>
<li>保证前端路由将目标地址为VIP报文统统发给Director Server，而不是RS</li>
<li>RS可以使用私有地址；也可以是公网地址，如果使用公网地址，此时可以通过互联网对RIP进行直接访问</li>
<li>RS和Director Server必须在同一个物理网络中</li>
<li>所有的请求报文经由Director Server，但响应报文必须不能经过Director Server</li>
<li>不支持地址转换，也不支持端口映射</li>
<li>RS可以是大多数常见的操作系统</li>
<li>RS的网关绝不允许指向DIP(因为我们不允许他经过director)</li>
<li>RS上的lo接口配置VIP的IP地址</li>
<li>缺陷：RS和DS必须在同一机房中</li>
<li>企业中最常用的是 DR 模型</li>
</ol>
<p>解决</p>
<ol>
<li>在前端路由器做静态地址路由绑定，将对于VIP的地址仅路由到Director Server。但用户未必有路由操作权限，因为有可能是运营商提供的，所以这个方法未必实用</li>
<li>arptables：在arp的层次上实现在ARP解析时做防火墙规则，过滤RS响应ARP请求。这是由iptables提供的。修改RS上内核参数（arp_ignore和arp_announce），将RS上的VIP配置在lo接口的别名上，并限制其不能响应对VIP地址解析请求。</li>
</ol>
</blockquote>
<h3 id="LVS-Tun原理和特点"><a href="#LVS-Tun原理和特点" class="headerlink" title="LVS/Tun原理和特点"></a>LVS/Tun原理和特点</h3><p><img src="/images/lvs/tun原理.png" alt=""></p>
<blockquote>
<ol>
<li>当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP 。</li>
<li>PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</li>
<li>IPVS比对数据包请求的服务是否为集群服务，若是，在请求报文的首部再次封装一层IP报文，封装源IP为为DIP，目标IP为RIP。然后发至POSTROUTING链。 此时源IP为DIP，目标IP为RIP</li>
<li>POSTROUTING链根据最新封装的IP报文，将数据包发至RS（因为在外层封装多了一层IP首部，所以可以理解为此时通过隧道传输）。 此时源IP为DIP，目标IP为RIP</li>
<li>RS接收到报文后发现是自己的IP地址，就将报文接收下来，拆除掉最外层的IP后，会发现里面还有一层IP首部，而且目标是自己的lo接口VIP，那么此时RS开始处理此请求，处理完成之后，通过lo接口送给eth0网卡，然后向外传递。 此时的源IP地址为VIP，目标IP为CIP</li>
<li>响应报文最终送达至客户端</li>
</ol>
</blockquote>
<h4 id="LVS-Tun模型特性"><a href="#LVS-Tun模型特性" class="headerlink" title="LVS-Tun模型特性"></a>LVS-Tun模型特性</h4><blockquote>
<ol>
<li>RIP、VIP、DIP全是公网地址</li>
<li>RS的网关不会也不可能指向DIP</li>
<li>所有的请求报文经由Director Server，但响应报文必须不能进过Director Server</li>
<li>不支持端口映射</li>
<li>RS的系统必须支持隧道</li>
</ol>
</blockquote>
<h3 id="LVS的八种调度算法"><a href="#LVS的八种调度算法" class="headerlink" title="LVS的八种调度算法"></a>LVS的八种调度算法</h3><h4 id="轮叫调度-rr"><a href="#轮叫调度-rr" class="headerlink" title="轮叫调度 rr"></a>轮叫调度 rr</h4><blockquote>
<p>这种算法是最简单的，就是依次将请求调度到不同的服务器上，该算法最大的特点就是简单。轮询算法假设所有的服务器处理请求的能力都是一样的，调度器会将所有的请求平均分配给每个真实服务器，不管后端 RS 配置和处理能力，非常均衡地分发下去。</p>
</blockquote>
<h4 id="加权轮叫-wrr"><a href="#加权轮叫-wrr" class="headerlink" title="加权轮叫 wrr"></a>加权轮叫 wrr</h4><blockquote>
<p>这种算法比 rr 的算法多了一个权重的概念，可以给 RS 设置权重，权重越高，那么分发的请求数越多，权重的取值范围 0 – 100。主要是对rr算法的一种优化和补充， LVS 会考虑每台服务器的性能，并给每台服务器添加权值，如果服务器A的权值为1，服务器B的权值为2，则调度到服务器B的请求会是服务器A的2倍。权值越高的服务器，处理的请求越多。</p>
</blockquote>
<h4 id="最少链接-lc"><a href="#最少链接-lc" class="headerlink" title="最少链接 lc"></a>最少链接 lc</h4><blockquote>
<p>这个算法会根据后端 RS 的连接数来决定把请求分发给谁，比如 RS1 连接数比 RS2 连接数少，那么请求就优先发给 RS1</p>
</blockquote>
<h4 id="加权最少链接-wlc"><a href="#加权最少链接-wlc" class="headerlink" title="加权最少链接 wlc"></a>加权最少链接 wlc</h4><blockquote>
<p>这个算法比 lc 多了一个权重的概念。</p>
</blockquote>
<h4 id="基于局部性的最少连接调度算法-lblc"><a href="#基于局部性的最少连接调度算法-lblc" class="headerlink" title="基于局部性的最少连接调度算法 lblc"></a>基于局部性的最少连接调度算法 lblc</h4><blockquote>
<p>这个算法是请求数据包的目标 IP 地址的一种调度算法，该算法先根据请求的目标 IP 地址寻找最近的该目标 IP 地址所有使用的服务器，如果这台服务器依然可用，并且有能力处理该请求，调度器会尽量选择相同的服务器，否则会继续选择其它可行的服务器</p>
</blockquote>
<h4 id="复杂的基于局部性最少的连接算法-lblcr"><a href="#复杂的基于局部性最少的连接算法-lblcr" class="headerlink" title="复杂的基于局部性最少的连接算法 lblcr"></a>复杂的基于局部性最少的连接算法 lblcr</h4><blockquote>
<p>记录的不是目标 IP 与一台服务器之间的连接记录，而是维护一个目标 IP 到一组服务器之间的映射关系，防止单点服务器负载过高。</p>
</blockquote>
<p>#### </p>
<h4 id="目标地址散列调度算法-dh"><a href="#目标地址散列调度算法-dh" class="headerlink" title="目标地址散列调度算法 dh"></a>目标地址散列调度算法 dh</h4><blockquote>
<p>该算法是根据目标 IP 地址通过散列函数将目标 IP 与服务器建立映射关系，出现服务器不可用或负载过高的情况下，发往该目标 IP 的请求会固定发给该服务器。</p>
</blockquote>
<h4 id="源地址散列调度算法-sh"><a href="#源地址散列调度算法-sh" class="headerlink" title="源地址散列调度算法 sh"></a>源地址散列调度算法 sh</h4><blockquote>
<p>与目标地址散列调度算法类似，但它是根据源地址散列算法进行静态分配固定的服务器资源。</p>
</blockquote>
<h3 id="部署LVS-NAT模型"><a href="#部署LVS-NAT模型" class="headerlink" title="部署LVS/NAT模型"></a>部署LVS/NAT模型</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">==============================================================================================</span><br><span class="line">环境</span><br><span class="line">准备三台主机</span><br><span class="line">director：外网地址：192.168.1.26；内网地址：172.16.106.140</span><br><span class="line">realServer1：内网地址：172.16.106.142</span><br><span class="line">realServer2：内网地址：172.16.106.141</span><br><span class="line">==============================================================================================</span><br><span class="line">---------------------</span><br><span class="line">  realServer1&amp;2</span><br><span class="line">---------------------</span><br><span class="line">[root@realserver1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">IPADDR=172.16.106.142</span><br><span class="line"><span class="meta">#</span><span class="bash"> realServer2主机的地址为172.16.106.141</span></span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=172.16.106.140</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置两台realServer主机的地址为静态地址，并将网关指向director的内网地址。</span></span><br><span class="line">[root@realserver2 ~]# yum install -y nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 两台主机需要安装nginx，可以临时添加dirctor的防火墙规则，iptables -t nat -A POSTROUTING -s 172.16.106.0/24 -j SNAT --to-source 192.168.1.26，并开启路由转发功能，<span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward，最后为realServer配置DNS。这样realServer就可以连接外网了。安装nginx后再取消director的防火墙规则。</span></span><br><span class="line">[root@realserver1 ~]# mkdir /usr/share/nginx/html/test</span><br><span class="line">[root@realserver1 ~]# vim /usr/share/nginx/html/test/index.html</span><br><span class="line">	realServer1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在两台主机上添加主面测试文件，一个是realServer1，一个是realServer2</span></span><br><span class="line">[root@realserver1 ~]# systemctl start nginx</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  Director</span><br><span class="line">--------------</span><br><span class="line">[root@director ~]# yum install -y ipvsadm</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/all/send_redirects</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/default/send_redirects</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/send_redirects</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/eth1/send_redirects</span><br><span class="line">[root@director ~]# ipvsadm -A -t 192.168.1.26:80 -s wrr</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.1.26:80 -r 172.16.106.142:80 -m -w 1</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.1.26:80 -r 172.16.106.141:80 -m -w 1</span><br><span class="line">[root@director ~]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  192.168.1.26:80 wrr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.16.106.141:80            Masq    1      1          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.16.106.142:80            Masq    1      1          0  </span></span><br><span class="line"> [root@director ~]# ipvsadm -C</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 清除所有ipvs规则</span></span><br><span class="line">---------</span><br><span class="line">  本机</span><br><span class="line">---------</span><br><span class="line">使用IE浏览器访问192.168.1.26/test/，会轮流返回realServer上的页面内容。不能使用realServer访问，访问超时，不会返回结果</span><br></pre></td></tr></table></figure>
<h3 id="部署LVS-DR模型"><a href="#部署LVS-DR模型" class="headerlink" title="部署LVS/DR模型"></a>部署LVS/DR模型</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">环境</span><br><span class="line">准备三台主机，以上面三台主机为基础</span><br><span class="line">director：外网地址：192.168.1.26</span><br><span class="line">realServer1：内网地址：192.168.1.27</span><br><span class="line">realServer2：内网地址：192.168.1.28</span><br><span class="line">VIP：192.168.1.260</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  Director</span><br><span class="line">--------------</span><br><span class="line">[root@director ~]# ipvsadm -C</span><br><span class="line">[root@director ~]# vim lvs_dr.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">vip=192.168.1.60</span><br><span class="line">rs1=192.168.1.27</span><br><span class="line">rs2=192.168.1.28</span><br><span class="line">ifconfig ens33:0 down</span><br><span class="line">ifconfig ens33:0 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line">route add -host $vip dev ens33:0</span><br><span class="line">[root@director ~]# ipvsadm -A -t 192.168.1.60:80 -s wrr</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.1.60:80 -r 192.168.1.27 -g -w 1</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.1.60:80 -r 192.168.1.28 -g -w 1</span><br><span class="line">[root@director ~]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  192.168.1.60:80 wrr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.1.27:80              Route   1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.1.28:80              Route   1      0          0</span></span><br><span class="line">  </span><br><span class="line">---------------------</span><br><span class="line">  realServer1&amp;2</span><br><span class="line">---------------------</span><br><span class="line">[root@realserver1 ~]# vim lvs_dr_rs.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">vip=192.168.1.60</span><br><span class="line">ifconfig lo:0 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line">route add -host $vip lo:0</span><br><span class="line">echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">  本机</span><br><span class="line">---------</span><br><span class="line">使用IE浏览器访问192.168.1.26/test/，会轮流返回realServer上的页面内容。不能使用realServer访问，访问超时，不会返回结果</span><br></pre></td></tr></table></figure>
<h3 id="部署keepalived-LVS环境"><a href="#部署keepalived-LVS环境" class="headerlink" title="部署keepalived+LVS环境"></a>部署keepalived+LVS环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">环境</span><br><span class="line">准备四台主机，以上面三台主机为基础</span><br><span class="line">director1：外网地址：192.168.1.26</span><br><span class="line">director2：外网地址：192.168.1.26</span><br><span class="line">realServer1：内网地址：192.168.1.27</span><br><span class="line">realServer2：内网地址：192.168.1.28</span><br><span class="line">VIP：192.168.1.260</span><br><span class="line"></span><br><span class="line">------------------</span><br><span class="line">  Director1&amp;2</span><br><span class="line">------------------</span><br><span class="line">[root@director keepalived]# ifconfig ens33:0 down</span><br><span class="line"><span class="meta">#</span><span class="bash"> down掉director1上的ens33:0网卡，因为此网卡上有VIP地址。影响下面的keepalived测试</span></span><br><span class="line">[root@realserver2 ~]# yum install -y ipvsadm keeyalived</span><br><span class="line">[root@director ~]# cd /etc/keepalived/</span><br><span class="line">[root@director keepalived]# cp keepalived.conf&#123;,.bak&#125;</span><br><span class="line">[root@director keepalived]# vim keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">      root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id node1		# # director2这里要改为node2</span><br><span class="line">   vrrp_mcast_group4 224.1.101.12</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER		# director2这里要改为BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100		# dirctor2这里要改为96</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.60 dev ens33 label ens33:0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.1.60 80 &#123;</span><br><span class="line">    delay_loop 1</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 192.168.1.27 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">           TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 10</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 192.168.1.28 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">           TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 10</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@director keepalived]# echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">[root@director keepalived]# systemctl start keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动keepalived后，会自动生成ipvs规则</span></span><br><span class="line">[root@director keepalived]# tcpdump -i ens33 -vv -nn host 224.1.101.12</span><br><span class="line"><span class="meta">#</span><span class="bash">这时可以看到探测信息，这是拥有VIP地址的主机发来的。</span></span><br><span class="line">[root@director keepalived]# ip a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到VIP在director1上</span></span><br><span class="line">[root@director keepalived]# ipvsadm -ln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是否生成了ipvs规则，如果未生成，可以用下面命令</span></span><br><span class="line">[root@director keepalived]# ipvsadm -A -t 192.168.1.60:80 -s wrr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成一个虚拟服务器，用加权轮询算法</span></span><br><span class="line">[root@director keepalived]# ipvsadm -a -t 192.168.1.60:80 -r 192.168.1.27:80 -g -w 1</span><br><span class="line">[root@director keepalived]# ipvsadm -a -t 192.168.1.60:80 -r 192.168.1.28:80 -g -w 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将realserver加入到虚拟服务器中，-g表示使用DR直接路由，-w指定权重。</span></span><br><span class="line">[root@director keepalived]# ipvsadm -E -t 10.5.5.140:9999 -s wrr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改调度算法</span></span><br><span class="line"></span><br><span class="line">---------------------</span><br><span class="line">  realServer1&amp;2</span><br><span class="line">---------------------</span><br><span class="line">[root@realserver1 ~]# vim lvs_dr_rs.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">vip=192.168.1.60</span><br><span class="line">ifconfig lo:0 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line">route add -host $vip lo:0</span><br><span class="line">echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">  本机</span><br><span class="line">---------</span><br><span class="line">使用IE浏览器访问192.168.1.26/test/，会轮流返回realServer上的页面内容。不能使用realServer访问，访问超时，不会返回结果。使用命令：</span><br><span class="line">root@ru:ruopu.gitb#for i in `seq 10000`;do curl 192.168.1.60/test/ &amp;&amp; echo $i;done</span><br><span class="line">也会返回两台服务器的页面内容。这时如果停止一台keepalived，VIP地址会转移到另一台上，访问还会继续</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/25/ELK部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/25/ELK部署/" itemprop="url">
                  ELK部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-25 09:04:32" itemprop="dateCreated datePublished" datetime="2019-01-25T09:04:32+08:00">2019-01-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-26 16:03:15" itemprop="dateModified" datetime="2019-06-26T16:03:15+08:00">2019-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="elk概念"><a href="#elk概念" class="headerlink" title="elk概念"></a>elk概念</h3><blockquote>
<p>ELK又称为ELK Stack,是 Elasticsearch、Logstash、Kibana 三个开源软件的组合,每个完成不同的功能，官方网站 <a href="http://www.elastic.co" target="_blank" rel="noopener">www.elastic.co</a></p>
</blockquote>
<h4 id="elasticsearch概念"><a href="#elasticsearch概念" class="headerlink" title="elasticsearch概念"></a>elasticsearch概念</h4><blockquote>
<p>Elasticsearch 可实现数据的实时全文搜索、支持分布式可实现高可用、提供<br>API接口，可以处理大规模日志数据，比如Nginx、Tomcat、系统日志等。</p>
</blockquote>
<h4 id="logstash概念"><a href="#logstash概念" class="headerlink" title="logstash概念"></a>logstash概念</h4><blockquote>
<p>Logstash:通过插件实现日志收集，支持日志过滤，支持普通log、自定义json格式的日志解析。</p>
</blockquote>
<h5 id="logstash格式"><a href="#logstash格式" class="headerlink" title="logstash格式"></a>logstash格式</h5><blockquote>
<p>input {} #input 插件收集日志</p>
<p>output {} #output 插件输出日志</p>
</blockquote>
<h4 id="kibana概念"><a href="#kibana概念" class="headerlink" title="kibana概念"></a>kibana概念</h4><blockquote>
<p>kibana：kibana主要是调用elasticsearch的数据，并进行前端数据可视化的展现。</p>
</blockquote>
<h3 id="elk部署"><a href="#elk部署" class="headerlink" title="elk部署"></a>elk部署</h3><h4 id="elk简单部署"><a href="#elk简单部署" class="headerlink" title="elk简单部署"></a>elk简单部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line">======================================================================================</span><br><span class="line">收集单个日志</span><br><span class="line">======================================================================================</span><br><span class="line"></span><br><span class="line">准备三台主机，做els集群，配置：双核处理器，2G内存。地址：192.168.1.20，192.168.1.21，192.168.1.22</span><br><span class="line">准备一台主机，安装nginx，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装kibana，地址：192.168.1.23</span><br><span class="line"></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">sed -i ‘/SELINUX/s/enforcing/disabled/’ /etc/selinux/config</span><br><span class="line"><span class="meta">#</span> 关闭三台主机的防火墙和SELinux</span><br><span class="line">ulimit -n</span><br><span class="line"><span class="meta">#</span> 查看打开文件最大数</span><br><span class="line">echo "* soft nofile 65536" &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo "* hard nofile 65536" &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="meta">#</span> 调整打开文件最大数</span><br><span class="line">ulimit -n 65535</span><br><span class="line"><span class="meta">#</span> 临时调整打开文件最大数</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br><span class="line">chronyc</span><br><span class="line"><span class="meta">chronyc&gt;</span> waitsync</span><br><span class="line"><span class="meta">#</span> 同步三台主机时间</span><br><span class="line">yum install jdk-8u201-linux-x64.rpm -y</span><br><span class="line"><span class="meta">#</span> 安装jdk</span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">    export JAVA_HOME=/usr</span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line"><span class="meta">#</span> 设置java家目录并加载</span><br><span class="line">yum install -y elasticsearch-6.5.4.rpm</span><br><span class="line"><span class="meta">#</span> 三台主机均安装els</span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">    cluster.name: testelk</span><br><span class="line">    # 集群的名称，名称相同的主机就是处于同一个集群</span><br><span class="line">    node.name: node1</span><br><span class="line">    # 集群情况下，当前node的名字，每个node应该不一样。要将此文件复制到另两个节点</span><br><span class="line">    path.data: /elkdata/data</span><br><span class="line">    # 数据目录</span><br><span class="line">    path.logs: /elkdata/logs</span><br><span class="line">    # 日志目录</span><br><span class="line">    # bootstrap.memory_lock: true</span><br><span class="line">    # 服务启动时即锁定足够大的内存，提高效率。测试中如果打开此项，启动会失败，提示内存未锁定</span><br><span class="line">    network.host: 0.0.0.0</span><br><span class="line">    # 监听的地址</span><br><span class="line">    http.port: 9200</span><br><span class="line">    # 客户端访问端口</span><br><span class="line">    discovery.zen.ping.unicast.hosts: ["192.168.1.20", "192.168.1.21", "192.168.1.22"]</span><br><span class="line">    # 组播范围</span><br><span class="line">    discovery.zen.minimum_master_nodes: 2</span><br><span class="line">    # 设置此项为了必免脑裂，这里的数字是总节点数除以2加1算出来的。</span><br><span class="line">vim /etc/elasticsearch/jvm.options</span><br><span class="line">    -Xms3g  # 初始化的堆内存</span><br><span class="line">    -Xmx3g  # 最大堆内存，可以改大此值。这两个值要保持一致。或将上面配置文件中的bootstrap.memory_lock的值改为false</span><br><span class="line">mkdir /elkdata/&#123;data,logs&#125; -pv</span><br><span class="line"><span class="meta">#</span> 创建数据和日志目录</span><br><span class="line">chown elasticsearch.elasticsearch /elkdata/ -R</span><br><span class="line">systemctl start elasticsearch</span><br><span class="line">systemctl enable elasticsearch</span><br><span class="line"><span class="meta">#</span> 三台服务器启动并查看状态</span><br><span class="line">======================================================================================</span><br><span class="line">Master的职责：</span><br><span class="line">1. 节点状态信息</span><br><span class="line">2. 集群状态信息</span><br><span class="line">3. 创建索引</span><br><span class="line">4. 删除索引</span><br><span class="line">5. 分片管理</span><br><span class="line">6. 关闭节点</span><br><span class="line">Slave节点的职责：</span><br><span class="line">1. 同步数据</span><br><span class="line">2. 等待机会成为master</span><br><span class="line">======================================================================================</span><br><span class="line">-----------------------------------</span><br><span class="line">  node1上安装elasticsearch-head插件</span><br><span class="line">-----------------------------------</span><br><span class="line">git clone git://github.com/mobz/elasticsearch-head.git</span><br><span class="line"><span class="meta">#</span> 下载elasticsearch-head插件，这个插件是为了实现简单的集群监控、主机信息显示和管理等功能</span><br><span class="line">yum install -y epel-release</span><br><span class="line">yum install npm -y</span><br><span class="line">cd elasticsearch-head/</span><br><span class="line">npm install grunt -save</span><br><span class="line"><span class="meta">#</span> 这里可能会有报错"npm: relocation error: npm: symbol SSL_set_cert_cb, version libssl.so.10 not defined in file libssl.so.10 with link time reference"，需要安装openssl即可解决。</span><br><span class="line">npm install</span><br><span class="line">npm run start &amp;</span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">    #---------------------------------- http ---------------------------------------</span><br><span class="line">    http.cors.enabled: true     # 打开http功能</span><br><span class="line">    http.cors.allow-origin: "*"     # 允许谁访问</span><br><span class="line"><span class="meta">#</span> 配置elasticsearch允许远程访问</span><br><span class="line">systemctl restart elasticsearch</span><br><span class="line"></span><br><span class="line">* nginx</span><br><span class="line">yum install -y gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br><span class="line">tar xf nginx-1.12.2.tar.gz</span><br><span class="line">cd nginx-1.12.2/</span><br><span class="line">./configure --prefix=/usr/local/nginx</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd /usr/local/nginx/</span><br><span class="line">mkdir html/test</span><br><span class="line">echo "nginx test page" &gt;&gt; html/test/index.html</span><br><span class="line">vim conf/nginx.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        location /test &#123;</span><br><span class="line">           root html;</span><br><span class="line">           index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">/usr/local/nginx/sbin/nginx -t</span><br><span class="line">/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="meta">#</span> 启动</span><br><span class="line">访问http://192.168.1.30/test/测试</span><br><span class="line">======================================================================================</span><br><span class="line"><span class="meta">#</span> 下面在nginx主机上安装logstash</span><br><span class="line">======================================================================================</span><br><span class="line">yum -y install jdk-8u201-linux-x64.rpm</span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">export JAVA_HOME=/usr</span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line">yum -y install logstash-6.5.4.rpm</span><br><span class="line">systemctl start logstash</span><br><span class="line">systemctl enable logstash</span><br><span class="line">/usr/share/logstash/bin/logstash -e "input&#123;stdin&#123;&#125;&#125; output&#123;stdout&#123; codec =&gt; "rydebug"&#125;&#125;"</span><br><span class="line"><span class="meta">#</span> 执行此命令并不需要启动logstash服务，执行此命令就是启动服务，Ctrl + c可以关闭服务</span><br><span class="line">WARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class="line">[WARN ] 2019-06-25 17:14:39.128 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified</span><br><span class="line">[INFO ] 2019-06-25 17:14:39.153 [LogStash::Runner] runner - Starting Logstash &#123;"logstash.version"=&gt;"6.5.4"&#125;</span><br><span class="line">[INFO ] 2019-06-25 17:14:44.034 [Converge PipelineAction::Create&lt;main&gt;] pipeline - Starting pipeline &#123;:pipeline_id=&gt;"main", "pipeline.workers"=&gt;2, "pipeline.batch.size"=&gt;125, "pipeline.batch.delay"=&gt;50&#125;</span><br><span class="line">The stdin plugin is now waiting for input:</span><br><span class="line">[INFO ] 2019-06-25 17:14:44.444 [Converge PipelineAction::Create&lt;main&gt;] pipeline - Pipeline started successfully &#123;:pipeline_id=&gt;"main", :thread=&gt;"#&lt;Thread:0x71f559d3 run&gt;"&#125;</span><br><span class="line">[INFO ] 2019-06-25 17:14:44.603 [Ruby-0-Thread-1: /usr/share/logstash/lib/bootstrap/environment.rb:6] agent - Pipelines running &#123;:count=&gt;1, :running_pipelines=&gt;[:main], :non_running_pipelines=&gt;[]&#125;</span><br><span class="line">[INFO ] 2019-06-25 17:14:45.472 [Api Webserver] agent - Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</span><br><span class="line"><span class="meta">#</span> 这是一条使用标准输入输出的命令，上面是执行命令后的正常输出。有时会报错，不明白原因，可能是没有调动logstash，可能是没有设置JAVA_HOME环境变量，修改后一定重启logstash。</span><br><span class="line">    hello    # 输入hello后会有下面信息</span><br><span class="line">    &#123;</span><br><span class="line">        "@timestamp" =&gt; 2019-01-24T08:47:22.515Z,    </span><br><span class="line">        #@timestamp，用来标记当前事件发生的时间</span><br><span class="line">        "message" =&gt; "hello",    #消息的具体内容</span><br><span class="line">            "host" =&gt; "nginx1",    #host标记事件发生在哪里</span><br><span class="line">        "@version" =&gt; "1"    #@version时间版本号，一个事件就是一个ruby对象</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span> 测试。这要等待一会儿才会有结果</span><br><span class="line">vim /etc/logstash/conf.d/system.conf</span><br><span class="line">    input &#123;</span><br><span class="line">        file&#123;</span><br><span class="line">            type =&gt; "messagelog"</span><br><span class="line">            path =&gt; "/var/log/messages"</span><br><span class="line">            start_position =&gt; "beginning"   # 首次从头收集</span><br><span class="line">        &#125;</span><br><span class="line">        # 从文件输入，类型是messagelog，写明路径，最后指定从头收集</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    output &#123;</span><br><span class="line">        file &#123;</span><br><span class="line">            path =&gt; "/tmp/123.txt"</span><br><span class="line">        &#125;</span><br><span class="line">        # 输出到一个文件，用file引导，下面写明路径。</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; ["192.168.1.20:9200"]    # 指定第一台logstash地址即可。</span><br><span class="line">            index =&gt; "system-messages-%&#123;+YYYY.MM.dd&#125;"   # 索引的命名规则，后面加入日期</span><br><span class="line">        &#125;</span><br><span class="line">        # 输出到elasticsearch，写明地址，索引的名称</span><br><span class="line">    &#125;</span><br><span class="line">/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf -t</span><br><span class="line"><span class="meta">#</span> 使用-f指定配置文件，-t表示测试配置文件是否正确</span><br><span class="line">chmod 644 /var/log/messages</span><br><span class="line"><span class="meta">#</span> 让普通用户可以读系统日志</span><br><span class="line">systemctl start logstash</span><br><span class="line"><span class="meta">#</span> 启动logstash。也可以使用/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf在前台启动</span><br><span class="line">tail -f /tmp/123.txt</span><br><span class="line"><span class="meta">#</span> 这时可以看到输出的日志文件了</span><br><span class="line">访问192.168.1.20:9100，在其中的数据浏览中修改上方的连接地址为第一台logstash的地址，之后就可以看到一个叫system-messages-2019.01.24的索引了</span><br><span class="line"></span><br><span class="line">======================================================================================</span><br><span class="line">收集多个日志</span><br><span class="line">======================================================================================</span><br><span class="line">cp /etc/logstash/conf.d/system.conf /etc/logstash/conf.d/nginx.conf -a</span><br><span class="line">vim /etc/logstash/conf.d/nginx.conf</span><br><span class="line">input &#123;</span><br><span class="line">   file&#123;</span><br><span class="line">      type =&gt; "messagelog"      # type是自定义的，为了下面的if判断使用</span><br><span class="line">      path =&gt; "/var/log/messages"</span><br><span class="line">      start_position =&gt; "beginning"</span><br><span class="line">   &#125;</span><br><span class="line">   file &#123;</span><br><span class="line">      type =&gt; "nginxlog"</span><br><span class="line">      path =&gt; "/usr/local/nginx/logs/access.log"</span><br><span class="line">      start_position =&gt; "beginning"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">   file &#123;</span><br><span class="line">      path =&gt; "/tmp/123.txt"</span><br><span class="line">   &#125;</span><br><span class="line">   elasticsearch &#123;</span><br><span class="line">      hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">      index =&gt; "system-messages-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">   &#125;</span><br><span class="line">   if [type] == "nginxlog" &#123;        # 使用if判断type是否为输入中定义的nginxlog，如果是就传输到elasticsearch中</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">      hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">      index =&gt; "nginx-messages-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf -t</span><br><span class="line">systemctl restart logstash</span><br><span class="line">访问192.168.1.20:9100，在概览中可以看到传过来的nginxlog索引了</span><br><span class="line"></span><br><span class="line">* kibana</span><br><span class="line"><span class="meta">#</span> 下面安装kibana</span><br><span class="line">yum install -y kibana-6.5.4-x86_64.rpm</span><br><span class="line">vim /etc/kibana/kibana.yml</span><br><span class="line">    server.port: 5601</span><br><span class="line">    server.host: "0.0.0.0"</span><br><span class="line">    elasticsearch.url: "http://192.168.1.20:9200"   # 调用elasticsearch的接口，写一个就可以</span><br><span class="line">systemctl start kibana</span><br><span class="line">yum install -y gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br><span class="line">tar xf nginx-1.12.2.tar.gz</span><br><span class="line">cd nginx-1.12.2/</span><br><span class="line">./configure --prefix=/usr/local/nginx</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="meta">#</span> 使用nginx反向代理kibana</span><br><span class="line">vim /etc/kibana/kibana.yml</span><br><span class="line">    server.host: "localhost"</span><br><span class="line">    # 改为监听本地地址</span><br><span class="line">cd /usr/local/nginx/</span><br><span class="line">mkdir /usr/local/nginx/conf/conf.d</span><br><span class="line">vim /usr/local/nginx/conf/conf.d/kibana.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name test.kibana.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://localhost:5601;</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">            proxy_set_header Connection 'upgrade';</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_cache_bypass $http_upgrade;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">    http &#123;</span><br><span class="line">        ...</span><br><span class="line">        include /usr/local/nginx/conf/conf.d/*.conf;</span><br><span class="line">    &#125;</span><br><span class="line">/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="meta">#</span> 启动</span><br><span class="line">设置本机可以解析test.kibana.com</span><br></pre></td></tr></table></figure>
<h5 id="kibana简单设置使用"><a href="#kibana简单设置使用" class="headerlink" title="kibana简单设置使用"></a>kibana简单设置使用</h5><h6 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h6><blockquote>
<p>这里可以选择使用样本数据，也可以只使用自己的数据。可以通过对样本数据设置的学习，了解kibana的设置方法</p>
</blockquote>
<p><img src="/images/kibana/访问1.png" alt=""></p>
<h6 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h6><blockquote>
<p>选择左侧的Management，之后在右边输入从els中获取的索引的名称，只需要输入前面部分，后面的日期可以使用星号配置，这里在下面也可以看到匹配到的索引，最后点击下一步。之后选择按时间过滤并创建即可。</p>
</blockquote>
<p><img src="/images/kibana/配置索引1.png" alt=""></p>
<p><img src="/images/kibana/配置索引2.png" alt=""></p>
<blockquote>
<p>这后可以在Discover中看到我们添加的索引了，如果无法显示数据，可能是右上方的时间有误</p>
</blockquote>
<p><img src="/images/kibana/查看1.png" alt=""></p>
<h5 id="nginx登录认证"><a href="#nginx登录认证" class="headerlink" title="nginx登录认证"></a>nginx登录认证</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* kibana</span><br><span class="line">[root@kibana ~]# yum install -y httpd-tools</span><br><span class="line">[root@kibana ~]# htpasswd -bc /usr/local/nginx/conf/htpasswd.users kibanauser centos</span><br><span class="line">Adding password for user kibanauser</span><br><span class="line"><span class="meta">#</span> 设置登录用户名和密码</span><br><span class="line">[root@kibana ~]# vim /usr/local/nginx/conf/conf.d/kibana.conf </span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name test.kibana.com;</span><br><span class="line">   auth_basic "Restricted Access";</span><br><span class="line">   auth_basic_user_file /usr/local/nginx/conf/htpasswd.users;</span><br><span class="line">   location / &#123;</span><br><span class="line">      proxy_pass http://localhost:5601;</span><br><span class="line">      proxy_http_version 1.1;</span><br><span class="line">      proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">      proxy_set_header Connection 'upgrade';</span><br><span class="line">      proxy_set_header Host $host;</span><br><span class="line">      proxy_cache_bypass $http_upgrade;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span> 加入认证</span><br><span class="line">[root@kibana ~]# /usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">再次访问kibana页面时就需要认证了</span><br></pre></td></tr></table></figure>
<h4 id="日志收集"><a href="#日志收集" class="headerlink" title="日志收集"></a>日志收集</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line">======================================================================================</span><br><span class="line">* 规划</span><br><span class="line">通过在要收集日志的服务器上安装filebeat进行日志收集，之后将收集到的数据写入到redis服务器，再通过logstash服务器取出数据并写入到elasticsearch集群中。也可以通过filebeat收集日志后转发给logstash服务器，再由logstash服务器写入到redis中，再由另一台logstash服务器从redis服务器中取出数据并写入到elasticsearch集群中。</span><br><span class="line"></span><br><span class="line">* 环境</span><br><span class="line">准备三台主机，做els集群，配置：双核处理器，2G内存。地址：192.168.1.20，192.168.1.21，192.168.1.22</span><br><span class="line">准备一台主机，安装nginx，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装kibana，地址：192.168.1.23</span><br><span class="line">准备一台主机，安装redis，地址：192.168.1.24</span><br><span class="line">准备一台主机，安装haproxy，地址：192.168.1.31</span><br><span class="line"></span><br><span class="line">* 软件版本</span><br><span class="line">1. 操作系统:CentOS7.4.1708</span><br><span class="line">2. jdk: jdk-8u201 官方rpm或gz包</span><br><span class="line">3. elasticsearch:6.5.4 官方当前最新rpm</span><br><span class="line">4. logstash:6.5.4 官方当前最新rpm</span><br><span class="line">5. kibana:6.5.4 官方当前最新rpm</span><br><span class="line">6. filebeat:6.5.4 官方当前最新rpm</span><br><span class="line">7. nginx:1.12.2</span><br><span class="line">8. redis:5.0.3 官方最新源码包</span><br><span class="line">======================================================================================</span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis ~]# yum install -y gcc</span><br><span class="line">[root@redis ~]# tar xf redis-5.0.3.tar.gz -C /usr/local/src/</span><br><span class="line">[root@redis redis-5.0.3]# cd /usr/local/src/redis-5.0.3/</span><br><span class="line">[root@redis redis-5.0.3]# make</span><br><span class="line">[root@redis redis-5.0.3]# ln -sv /usr/local/src/redis-5.0.3/ /usr/local/redis</span><br><span class="line">‘/usr/local/redis’ -&gt; ‘/usr/local/src/redis-5.0.3/’</span><br><span class="line">[root@redis redis-5.0.3]# cp src/redis-server src/redis-cli /usr/bin</span><br><span class="line">[root@redis redis-5.0.3]# cd /usr/local/redis/</span><br><span class="line">[root@redis redis]# vim redis.conf</span><br><span class="line">    bind 0.0.0.0</span><br><span class="line">    daemonize yes</span><br><span class="line">    # 让redis以守护进程方式运行</span><br><span class="line">    save ""		</span><br><span class="line">    #save 900 1</span><br><span class="line">    #save 300 10</span><br><span class="line">    #save 60 10000</span><br><span class="line">    # 因为不需要持久存储，所以将save ""打开，将下面三行关闭。</span><br><span class="line">    requirepass centos</span><br><span class="line">    logfile "/var/log/redis.log"</span><br><span class="line">    # 输出日志路径，默认会输出到/dev/null中</span><br><span class="line">[root@redis redis]# redis-server /usr/local/redis/redis.conf</span><br><span class="line"><span class="meta">#</span> 启动redis，启动时指定配置文件</span><br><span class="line">[root@redis redis]# ss -tln</span><br><span class="line">[root@redis redis]# redis-cli </span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">127.0.0.1:6379&gt; AUTH centos</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">(empty list or set)</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  haproxy</span><br><span class="line">-------------</span><br><span class="line">[root@haproxy ~]# yum install jdk-8u201-linux-x64.rpm</span><br><span class="line">[root@haproxy ~]# yum install logstash-6.5.4.rpm</span><br><span class="line">[root@haproxy ~]# yum install -y haproxy</span><br><span class="line">[root@haproxy ~]# vim /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local6		# 这行很重要，local6是haproxy的日志级别，在rsyslog配置文件中也要定义这个级别</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line">frontend myweb		</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websrvs</span><br><span class="line">backend websrvs</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server srv1 192.168.1.30:80 check</span><br><span class="line"><span class="meta">#</span> 这里只简单地将haproxy反代到nginx服务器上，实现访问haproxy就会反代到nginx服务器上</span><br><span class="line">[root@haproxy ~]# vim /etc/rsyslog.d/haproxy.conf</span><br><span class="line">    $ModLoad imudp</span><br><span class="line">    $UDPServerRun 514</span><br><span class="line">    $ModLoad imtcp</span><br><span class="line">    $InputTCPServerRun 514</span><br><span class="line">    local6.* @@192.168.1.31:5140</span><br><span class="line"><span class="meta">#</span> 接收日志的logstash服务器IP:PORT，local6对应haproxy的日志级别。这里将日志传给了本机的logstash</span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/syslog.conf </span><br><span class="line">input &#123;</span><br><span class="line">   syslog &#123;</span><br><span class="line">      type =&gt; "system-rsyslog"</span><br><span class="line">      port =&gt; "5140"		# 从logstash的5140端口输入，实际也是定义logstash监听的端口</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">   stdout &#123;</span><br><span class="line">      codec =&gt; rubydebug</span><br><span class="line">   &#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"		# redis的数据类型要使用list</span><br><span class="line">      key =&gt; "system-rsyslog"		# 写入redis的键名</span><br><span class="line">      host =&gt; "192.168.1.24"		# redis地址</span><br><span class="line">      port =&gt; "6379"		# redis端口</span><br><span class="line">      db =&gt; "0"			# redis库</span><br><span class="line">      password =&gt; "centos"		# redis密码</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# systemctl restart rsyslog</span><br><span class="line"><span class="meta">#</span> rsyslog监听在514端口</span><br><span class="line">[root@haproxy ~]# systemctl start haproxy    </span><br><span class="line">[root@haproxy ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/syslog.conf</span><br><span class="line">在本机设置hosts文件，解析haproxy地址到www.test.com，访问www.test.com，这时应该显示一些信息，如：</span><br><span class="line">&#123;</span><br><span class="line">         "timestamp" =&gt; "Jan 25 12:53:39",</span><br><span class="line">        "@timestamp" =&gt; 2019-01-25T04:53:39.000Z,</span><br><span class="line">           "message" =&gt; "192.168.1.9:33634 [25/Jan/2019:12:53:39.002] myweb websrvs/srv1 0/0/1/1/2 304 175 - - ---- 2/2/0/0/0 0/0 \"GET / HTTP/1.1\"\n",</span><br><span class="line">         "logsource" =&gt; "localhost",</span><br><span class="line">              "type" =&gt; "system-rsyslog",</span><br><span class="line">              "host" =&gt; "192.168.1.31",</span><br><span class="line">          "priority" =&gt; 182,</span><br><span class="line">    "facility_label" =&gt; "local6",</span><br><span class="line">          "severity" =&gt; 6,</span><br><span class="line">           "program" =&gt; "haproxy",</span><br><span class="line">          "facility" =&gt; 22,</span><br><span class="line">    "severity_label" =&gt; "Informational",</span><br><span class="line">               "pid" =&gt; "3817",</span><br><span class="line">          "@version" =&gt; "1"</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# ss -tln</span><br><span class="line"><span class="meta">#</span> 可以看到监听了5140端口</span><br><span class="line">[root@haproxy ~]# systemctl start logstash</span><br><span class="line"><span class="meta">#</span> 在后台启动</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis redis]# redis-cli -a centos</span><br><span class="line">127.0.0.1:6379&gt; SELECT 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) "system-rsyslog"</span><br><span class="line">127.0.0.1:6379&gt; LLEN system-rsyslog</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; LPOP system-rsyslog</span><br><span class="line">"&#123;\"facility\":22,\"host\":\"192.168.1.31\",\"logsource\":\"localhost\",\"program\":\"haproxy\",\"@version\":\"1\",\"facility_label\":\"local6\",\"message\":\"192.168.1.9:33540 [25/Jan/2019:12:37:37.836] myweb websrvs/srv1 0/0/0/1/1 304 175 - - ---- 2/2/0/1/0 0/0 \\\"GET / HTTP/1.1\\\"\\n\",\"priority\":182,\"pid\":\"3817\",\"timestamp\":\"Jan 25 12:37:37\",\"severity\":6,\"severity_label\":\"Informational\",\"type\":\"system-rsyslog\",\"@timestamp\":\"2019-01-25T04:37:37.000Z\"&#125;"</span><br><span class="line"><span class="meta">#</span> 可以看到相关数据了</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  haproxy</span><br><span class="line">-------------</span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/syslog.conf </span><br><span class="line">input &#123;</span><br><span class="line">   syslog &#123;</span><br><span class="line">      type =&gt; "system-rsyslog"</span><br><span class="line">      port =&gt; "5140"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">   stdout &#123;</span><br><span class="line">      codec =&gt; rubydebug</span><br><span class="line">   &#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      key =&gt; "haproxy-log-31"		# 改变输出到redis中的键名</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# systemctl restart logstash</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) "haproxy-log-31"</span><br><span class="line">2) "system-rsyslog"</span><br><span class="line"><span class="meta">#</span> 可以看到从logstash传入新的键了</span><br><span class="line"></span><br><span class="line">======================================================================================</span><br><span class="line">下面设置收集TCP/UDP日志</span><br><span class="line">======================================================================================</span><br><span class="line">-------------</span><br><span class="line">  haproxy</span><br><span class="line">-------------</span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class="line">input &#123;</span><br><span class="line">   tcp &#123;</span><br><span class="line">      port =&gt; "5500"</span><br><span class="line">      type =&gt; "tcp-syslog"</span><br><span class="line">      mode =&gt; "server"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">	stdout &#123;</span><br><span class="line">	  codec =&gt; rubydebug</span><br><span class="line">	&#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      key =&gt; "tcp-syslog"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf -t</span><br><span class="line">WARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class="line">[WARN ] 2019-01-25 13:16:45.820 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified</span><br><span class="line">Configuration OK</span><br><span class="line">[INFO ] 2019-01-25 13:16:47.307 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br><span class="line"><span class="meta">#</span> 测试配置文件没有问题</span><br><span class="line">[root@haproxy ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf</span><br><span class="line"><span class="meta">#</span> logstash启动时还会监听本地的9600端口</span><br><span class="line">[root@haproxy ~]# yum install -y nc</span><br><span class="line">[root@haproxy ~]# echo "nc test"|nc 192.168.1.31 5500</span><br><span class="line">这时logstash会在终端输出内容：</span><br><span class="line">&#123;</span><br><span class="line">          "host" =&gt; "haproxy",</span><br><span class="line">       "message" =&gt; "nc test",</span><br><span class="line">          "port" =&gt; 39566,</span><br><span class="line">          "type" =&gt; "tcp-syslog",</span><br><span class="line">    "@timestamp" =&gt; 2019-01-25T05:29:16.034Z,</span><br><span class="line">      "@version" =&gt; "1"</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# nc 192.168.1.31 5500 &lt; /root/anaconda-ks.cfg</span><br><span class="line">[root@haproxy ~]# echo "伪设备" &gt; /dev/tcp/192.168.1.31/5500</span><br><span class="line"><span class="meta">#</span> /dev后面的部分是没有的，要手动输入，在logstash中也会显示</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) "tcp-syslog"</span><br><span class="line">2) "haproxy-log-31"</span><br><span class="line">3) "system-rsyslog"</span><br><span class="line">127.0.0.1:6379&gt; LLEN tcp-syslog</span><br><span class="line">(integer) 52</span><br><span class="line"><span class="meta">#</span> redis中也可以看到数据了</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">  logstash</span><br><span class="line">-------------</span><br><span class="line"><span class="meta">#</span> 使用nginx主机中的logstash收集redis中的数据</span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class="line">input &#123;</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "haproxy-log-31"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;  </span><br><span class="line">   </span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "tcp-syslog"</span><br><span class="line">      db =&gt; "0"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">   if [type] == "tcp-syslog" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "tcp-rsyslog-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">      &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">   </span><br><span class="line">   if [type] == "system-rsyslog" &#123;		# 这里判断的是haproxy服务器的logstash设置中input定义的type</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "haproxy-log-31-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">      &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">#</span> 从redis中取行数据，之后输出到elasticsearch集群中。</span><br><span class="line">[root@nginx1 ~]# systemctl start logstash</span><br><span class="line">[root@nginx1 ~]# tail -f /var/log/logstash/logstash-plain.log</span><br><span class="line"><span class="meta">#</span> 可以通过这个日志文件查看logstash运行是否正常，如是否可以连接到redis服务器</span><br><span class="line">访问els服务器：192.168.1.20:9200，这时可以看到haproxy-log-31-*这个索引了</span><br></pre></td></tr></table></figure>
<h4 id="filebeat收集日志"><a href="#filebeat收集日志" class="headerlink" title="filebeat收集日志"></a>filebeat收集日志</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line">======================================================================================</span><br><span class="line">* 规划</span><br><span class="line">1. 在web端安装filebeat进行对日志的收集，之后将日志发送给logstash。</span><br><span class="line">2. 配置一台logstash服务器，将收到的日志转发到redis</span><br><span class="line">3. 使用另一台logstash服务器从redis中读取日志，并将处理的结果写入到elasticsearch集群</span><br><span class="line">4. 配置地图显示IP访问地址</span><br><span class="line">5. 将日志写入数据库持久化保存</span><br><span class="line">6. 通过zabbix对elasticsearch集群状态及redis队列长度监控并实现邮件报警</span><br><span class="line"></span><br><span class="line">* 环境</span><br><span class="line">准备三台主机，做els集群，配置：双核处理器，2G内存。地址：192.168.1.20，192.168.1.21，192.168.1.22</span><br><span class="line">准备一台主机，安装nginx，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装kibana，地址：192.168.1.23</span><br><span class="line">准备一台主机，安装redis，地址：192.168.1.24</span><br><span class="line">准备一台主机，安装logstash负责将日志转发到redis，地址：192.168.1.30</span><br><span class="line">准备一台主机，安装logstash负责从redis中读取数据并写入elasticsearch集群，地址：192.168.1.31。需要从redis中取出数据，所以再配置一台logstash服务器</span><br><span class="line">======================================================================================</span><br><span class="line"></span><br><span class="line">-------------------------------------</span><br><span class="line">  nginx+tomcat+logstash30</span><br><span class="line">-------------------------------------</span><br><span class="line"><span class="meta">#</span> 下面配置nginx日志格式，filebeat获取nginx与系统日志并转发至本机的logstash</span><br><span class="line">[root@nginx1 ~]# mkdir /usr/local/nginx/html/web</span><br><span class="line">[root@nginx1 ~]# echo "Nginx WebPage" &gt; /usr/local/nginx/html/web/index.html</span><br><span class="line">访问http://192.168.1.30/web/</span><br><span class="line">[root@nginx1 ~]# vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    log_format access1 '&#123;"@timestamp":"$time_iso8601",'</span><br><span class="line">                         '"host":"$server_addr",'</span><br><span class="line">                         '"clientip":"$remote_addr",'</span><br><span class="line">                         '"size":$body_bytes_sent,'</span><br><span class="line">                         '"responsetime":$request_time,'</span><br><span class="line">                         '"upstreamtime":"$upstream_response_time",'</span><br><span class="line">                         '"upstreamhost":"$upstream_addr",'</span><br><span class="line">                         '"http_host":"$host",'</span><br><span class="line">                         '"url":"$uri",'</span><br><span class="line">                         '"domain":"$host",'</span><br><span class="line">                         '"xff":"$http_x_forwarded_for",'</span><br><span class="line">                         '"referer":"$http_referer",'</span><br><span class="line">                         '"status":"$status"&#125;';</span><br><span class="line">	server &#123;</span><br><span class="line">		...</span><br><span class="line">        access_log  logs/host.access.log  access1;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span> 配置日志格式为Json格式。相对普通日志格式,json易于识别,每个值都有与其相对于的key,易于提取日志内容及方便后续进一步对日志的分析。可以到http://www.kjson.com/上验证Json格式是否正确。</span><br><span class="line">[root@nginx1 ~]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line">[root@nginx1 ~]# /usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">[root@nginx1 ~]# yum install -y filebeat-6.5.4-x86_64.rpm</span><br><span class="line"><span class="meta">#</span> 安装filebeat，这个软件可以在web端实时收集日志并传递给logstash进一步处理</span><br><span class="line">======================================================================================</span><br><span class="line">为什么不用logstash在web端收集</span><br><span class="line">1. 依赖java环境，一旦java出问题，可能影响到web服务</span><br><span class="line">2. 系统资源占用率高，且存在bug风险</span><br><span class="line">3. 配置比较复杂，支持匹配过滤</span><br><span class="line">4. filebeat挺好的，专注日志收集，语法简单，安装快捷，配置方便</span><br><span class="line">======================================================================================</span><br><span class="line">[root@nginx1 ~]# vim /etc/filebeat/filebeat.yml</span><br><span class="line"><span class="meta">#</span>filebeat.inputs:</span><br><span class="line"><span class="meta">#</span>- type: log</span><br><span class="line"><span class="meta">#</span>  enabled: false</span><br><span class="line"><span class="meta">#</span>  paths:</span><br><span class="line"><span class="meta">#</span>    - /var/log/*.log</span><br><span class="line"><span class="meta">#</span>output.elasticsearch:</span><br><span class="line"><span class="meta">  #</span> Array of hosts to connect to.</span><br><span class="line"><span class="meta">#</span>  hosts: ["localhost:9200"]</span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/messages</span><br><span class="line">  include_lines: ["^ERR","^WARN"]		</span><br><span class="line"><span class="meta">  #</span> 如果加入此行，filebeat会只发送正则表达式匹配到的日志，其他都不发送。测试中未加此行。</span><br><span class="line">  fields:</span><br><span class="line">    service: system-log-30</span><br><span class="line"><span class="meta">#</span> filebeat6中需要通过fields: service:这样的方式定义输出的类型，而5版本中的设置是使用  document_type: 定义类型。如果6版本中也按5版本的方法设置，在logstash中是找不到的。</span><br><span class="line">output.redis:</span><br><span class="line">  hosts: ["192.168.1.24:6379"]</span><br><span class="line">  key: "system-log-30"</span><br><span class="line">  db: 10</span><br><span class="line">  timeout: 5</span><br><span class="line">  password: "centos"</span><br><span class="line"><span class="meta">#</span> 在配置文件最下方加入上面内容，另外需要注释配置文件中的inputs和其他output，不然启动会失败，不能有多个output段。启动失败时日志中会提示如"Exiting: prospectors and inputs used in the configuration file, define only inputs not both"</span><br><span class="line">[root@nginx1 ~]# tail -f /var/log/filebeat/filebeat</span><br><span class="line"><span class="meta">#</span> 查看日志</span><br><span class="line"></span><br><span class="line">[root@nginx1 ~]# vim /etc/filebeat/filebeat.yml</span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/messages</span><br><span class="line">  fields:</span><br><span class="line">    service: system-log-30</span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /usr/local/nginx/logs/access.log</span><br><span class="line">  fields:</span><br><span class="line">    service: nginx-accesslog-30</span><br><span class="line">  </span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: ["192.168.1.30:5044","192.168.1.30:5045"]</span><br><span class="line">  enabled: true</span><br><span class="line">  worker: 1</span><br><span class="line">  compression_level: 3</span><br><span class="line">  loadbalance: true		# 默认为false，全部发送到随机选择的一个，相当于高可用模式</span><br><span class="line">[root@nginx1 filebeat]# systemctl restart filebeat </span><br><span class="line"></span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">    input &#123;				</span><br><span class="line">       beats &#123;		# 这个输入的名称是自定义的</span><br><span class="line">          port =&gt; 5044</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">       beats &#123;</span><br><span class="line">          port =&gt; 5045</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    output &#123;</span><br><span class="line">       stdout &#123;</span><br><span class="line">          codec =&gt; "rubydebug"</span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf</span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">    input &#123;				</span><br><span class="line">       beats &#123;		# 此输入插件使Logstash能够从Elastic Beats框架接收事件</span><br><span class="line">          port =&gt; 5044</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">       beats &#123;</span><br><span class="line">          port =&gt; 5045</span><br><span class="line">          codec =&gt; "json"</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    output &#123;</span><br><span class="line">       if [fields][service] == "system-log-30" &#123;		</span><br><span class="line"><span class="meta">#</span> 这里的[fields][service] 是在filebeat的input中定义的，这是logstash6版本中的使用方法。如果是5版本，需要使用if [type] == ""来匹配数据类型</span><br><span class="line">          redis &#123;</span><br><span class="line">             data_type =&gt; "list"</span><br><span class="line">             host =&gt; "192.168.1.24"</span><br><span class="line">             port =&gt; "6379"</span><br><span class="line">             key =&gt; "system-log-30"</span><br><span class="line">             db =&gt; "15"</span><br><span class="line">             password =&gt; "centos"</span><br><span class="line">          &#125;  </span><br><span class="line"><span class="meta">#</span> 收集到的系统日志会因为JSON格式而报错，如"[ERROR] 2019-01-28 00:01:06.861 [defaultEventExecutorGroup-5-1] json - JSON parse error, original data now in message field &#123;:error=&gt;#&lt;LogStash::Json::ParserError: Unrecognized token 'Jan': was expecting ('true', 'false' or 'null')</span><br><span class="line"><span class="meta">#</span> at [Source: (String)"Jan 28 00:01:01 nginx1 systemd: Started Session 197 of user root."; line: 1, column: 4]&gt;, :data=&gt;"Jan 28 00:01:01 nginx1 systemd: Started Session 197 of user root."&#125;"，但数据还是会被写入到redis中。</span><br><span class="line">       &#125;  </span><br><span class="line">       if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">          redis &#123;</span><br><span class="line">             data_type =&gt; "list"</span><br><span class="line">             host =&gt; "192.168.1.24"</span><br><span class="line">             port =&gt; "6379"</span><br><span class="line">             key =&gt; "nginx-accesslog-30"</span><br><span class="line">             db =&gt; "15"</span><br><span class="line">             password =&gt; "centos"</span><br><span class="line">             codec =&gt; "json"</span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/beats.conf -t</span><br><span class="line">[root@nginx1 ~]# systemctl start logstash</span><br><span class="line">[root@nginx1 ~]# lsof -i:5045                 </span><br><span class="line">COMMAND    PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">java     22018 logstash  111u  IPv6 265612      0t0  TCP *:osp (LISTEN)</span><br><span class="line">java     22018 logstash  140u  IPv6 265052      0t0  TCP nginx1:osp-&gt;nginx1:60146 (ESTABLISHED)</span><br><span class="line">filebeat 22162     root    5u  IPv4 265051      0t0  TCP nginx1:60146-&gt;nginx1:osp (ESTABLISHED)</span><br><span class="line"><span class="meta">#</span>  查看是否连接到5044端口</span><br><span class="line">[root@nginx1 ~]# netstat -alnp | grep filebeat</span><br><span class="line">tcp        0      0 192.168.1.30:60146      192.168.1.30:5045       ESTABLISHED 22162/filebea      </span><br><span class="line">tcp        0      0 192.168.1.30:44502      192.168.1.30:5044       ESTABLISHED 22162/filebea</span><br><span class="line"><span class="meta">#</span>  netstart查看端口</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis ~]# lsof -i:6379 -n    </span><br><span class="line">COMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">redis-ser 15196 root    6u  IPv4  32440      0t0  TCP *:6379 (LISTEN)</span><br><span class="line">redis-ser 15196 root   10u  IPv4 166066      0t0  TCP 192.168.1.24:6379-&gt;192.168.1.30:48894 (ESTABLISHED)</span><br><span class="line"><span class="meta">#</span> 可以看到192.168.1.30连到了这台redis上。</span><br><span class="line">[root@redis ~]# redis-cli -a centos</span><br><span class="line">127.0.0.1:6379&gt; SELECT 5</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[5]&gt; KEYS *</span><br><span class="line">1) "system-log-30"</span><br><span class="line">2) "nginx-accesslog-30"</span><br><span class="line"><span class="meta">#</span> 可以看到redis库中已经有数据了。</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  logstash31</span><br><span class="line">-----------------</span><br><span class="line"><span class="meta">#</span> 下面配置logstash从redis读取数据</span><br><span class="line">[root@haproxy ~]# cd /etc/logstash/conf.d/</span><br><span class="line">[root@haproxy conf.d]# vim redis-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "system-log-30"</span><br><span class="line">      db =&gt; "5"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   &#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "nginx-accesslog-30"</span><br><span class="line">      db =&gt; "5"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   codec =&gt; "json"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">   if [fields][service]== "system-log-30" &#123;</span><br><span class="line"><span class="meta">   #</span> 这里也要使用这样的判断方法，不能使用if [type] == ""这样的方法</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "system-log-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">         # 这里的%&#123;+yyyy.MM.dd&#125;年和日都要使用小写字母，不能使用大写字母，不然logstash会报错。</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "nginx-accesslog-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy conf.d]# systemctl start logstash</span><br><span class="line">访问http://192.168.1.20:9100/，这时可以看到有日志索引nginx-accesslog-30-****.**.**存在了。</span><br></pre></td></tr></table></figure>
<h5 id="kibana验证nginx访问日志"><a href="#kibana验证nginx访问日志" class="headerlink" title="kibana验证nginx访问日志"></a>kibana验证nginx访问日志</h5><blockquote>
<p>因为kibana是从本机的nginx反向代理的，所以访问的地址是test.kibana.com，访问时出现错误提示：重定向次数过多，需要清理cookie。重启kibana后正常。原因不明。</p>
</blockquote>
<blockquote>
<p>在kibana中创建nginx-accesslog-30-*索引后，就可以看到数据信息了</p>
</blockquote>
<p><img src="/images/kibana/查看2.png" alt=""></p>
<h5 id="部署tomcat"><a href="#部署tomcat" class="headerlink" title="部署tomcat"></a>部署tomcat</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------</span><br><span class="line">  nginx+tomcat+logstash30</span><br><span class="line">-------------------------------------</span><br><span class="line"><span class="meta">#</span> 下面部署tomcat</span><br><span class="line">[root@nginx1 ~]# yum install -y tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br><span class="line">[root@nginx1 ~]# mkdir /usr/share/tomcat/webapps/tomcatweb</span><br><span class="line">[root@nginx1 ~]# vim /usr/share/tomcat/webapps/tomcatweb/index.html</span><br><span class="line">	Tomcat Web Page</span><br><span class="line"><span class="meta">#</span> 创建一个测试页</span><br><span class="line">[root@nginx1 ~]# systemctl start tomcat</span><br><span class="line">访问http://192.168.1.30:8080/tomcatweb/</span><br><span class="line">[root@nginx1 ~]# systemctl stop tomcat</span><br><span class="line">[root@nginx1 ~]# vim /etc/tomcat/server.xml</span><br><span class="line">&lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="</span><br><span class="line">logs"</span><br><span class="line">               prefix="localhost_access_log." suffix=".txt"</span><br><span class="line">               pattern="&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;</span><br><span class="line">,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;method&amp;quot;</span><br><span class="line">:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query</span><br><span class="line">?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;AgentVersion&amp;quot;:</span><br><span class="line">&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;" /&gt;</span><br><span class="line"><span class="meta">#</span> 需要注意tomcat日志的json格式，使用两个&amp;quot;将字段和变量分隔，标点符号不需要使用</span><br><span class="line">[root@nginx1 ~]# rm -rf /var/log/tomcat/*</span><br><span class="line">[root@nginx1 ~]# systemctl start tomcat</span><br><span class="line">[root@nginx1 ~]# tail /var/log/tomcat/localhost_access_log.2019-01-28.txt</span><br><span class="line">&#123;"clientip":"192.168.1.9","ClientUser":"-","authenticated":"-","AccessTime":"[28/Jan/2019:09:58:44 +0800]","method":"GET /tomcatweb/ HTTP/1.1","status":"304","SendBytes":"-","Query?string":"","partner":"-","AgentVersion":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36"&#125;</span><br><span class="line"><span class="meta">#</span> 验证tomcat日志转json</span><br><span class="line">[root@nginx1 ~]# vim /etc/filebeat/filebeat.yml</span><br><span class="line">    - input_type: log</span><br><span class="line">      paths:</span><br><span class="line">        - /var/log/tomcat/localhost_access_log.*</span><br><span class="line">      fields:</span><br><span class="line">        service: tomcat-accesslog-30</span><br><span class="line"><span class="meta">#</span> 加入对tomcat日志的收集</span><br><span class="line">[root@nginx1 ~]# systemctl restart filebeat.service</span><br><span class="line">[root@nginx1 ~]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">output &#123;</span><br><span class="line">    ...</span><br><span class="line">    if [fields][service] == "tomcat-accesslog-30" &#123;</span><br><span class="line">      redis &#123;</span><br><span class="line">         data_type =&gt; "list"</span><br><span class="line">         host =&gt; "192.168.1.24"</span><br><span class="line">         port =&gt; "6379"</span><br><span class="line">         key =&gt; "tomcat-accesslog-30"</span><br><span class="line">         db =&gt; "5"</span><br><span class="line">         password =&gt; "centos"</span><br><span class="line">         codec =&gt; "json"</span><br><span class="line">      &#125;  </span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br><span class="line">[root@nginx1 ~]# systemctl restart logstash</span><br><span class="line">[root@nginx1 ~]# yum install -y httpd-tools</span><br><span class="line">[root@nginx1 ~]# ab -n1000 -c10 http://192.168.1.30:8080/tomcatweb/</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">     redis</span><br><span class="line">-------------</span><br><span class="line">[root@redis ~]# redis-cli -a centos</span><br><span class="line">127.0.0.1:6379&gt; SELECT 5</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[5]&gt; KEYS *</span><br><span class="line">1) "tomcat-accesslog-30"</span><br><span class="line"><span class="meta">#</span> 可以看到redis中已经有数据了</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">  logstash31</span><br><span class="line">-----------------</span><br><span class="line"><span class="meta">#</span> 下面配置logstash从redis读取tomcat的数据</span><br><span class="line">[root@haproxy conf.d]# vim redis-es.conf       </span><br><span class="line">input &#123;</span><br><span class="line">...</span><br><span class="line">redis &#123;</span><br><span class="line">      data_type =&gt; "list"</span><br><span class="line">      host =&gt; "192.168.1.24"</span><br><span class="line">      port =&gt; "6379"</span><br><span class="line">      key =&gt; "tomcat-accesslog-30"</span><br><span class="line">      db =&gt; "5"</span><br><span class="line">      password =&gt; "centos"</span><br><span class="line">   codec =&gt; "json"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">...</span><br><span class="line">if [fields][service] == "tomcat-accesslog-30" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "tomcat-accesslog-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy conf.d]# systemctl restart logstash</span><br><span class="line">最后加入到kibana中</span><br><span class="line"></span><br><span class="line">--------------------</span><br><span class="line">  elasticsearch</span><br><span class="line">--------------------</span><br><span class="line">[root@els3 ~]# du -sh /elkdata/data/nodes/0/indices/</span><br><span class="line">97M     /elkdata/data/nodes/0/indices/</span><br><span class="line">[root@els3 ~]# du -sh /elkdata/data/nodes/0/indices/*</span><br><span class="line">4.0K    /elkdata/data/nodes/0/indices/--3-U6GWTSifioos1N2yUQ</span><br><span class="line">91M     /elkdata/data/nodes/0/indices/6MycbQuEQWmCbg3-A1q5EA</span><br><span class="line">120K    /elkdata/data/nodes/0/indices/HGUqPJuCQ1iTPJr1EVfxoQ</span><br><span class="line">2.0M    /elkdata/data/nodes/0/indices/KuBtJ9ztSDaI7dFaiNfeFQ</span><br><span class="line">2.9M    /elkdata/data/nodes/0/indices/QbkLT5G7RYu5nivgm2uncA</span><br><span class="line">1.5M    /elkdata/data/nodes/0/indices/_yuF7skcTtWOF4YJl_UaTw</span><br><span class="line"><span class="meta">#</span> 验证filebeat读取的日志，已经通过logstash写入到elasticsearch的数据目录中</span><br></pre></td></tr></table></figure>
<h3 id="kibana配置地图显示IP访问地址"><a href="#kibana配置地图显示IP访问地址" class="headerlink" title="kibana配置地图显示IP访问地址"></a>kibana配置地图显示IP访问地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">-----------------</span><br><span class="line">  logstash31</span><br><span class="line">-----------------</span><br><span class="line">[root@kibana ~]# wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz</span><br><span class="line"><span class="meta">#</span> 在写入elasticsearch的logstash服务器配置</span><br><span class="line">[root@haproxy ~]# gunzip GeoLite2-City.tar.gz</span><br><span class="line">[root@haproxy ~]# tar xf GeoLite2-City.tar</span><br><span class="line">[root@haproxy ~]# cd GeoLite2-City_20190122/</span><br><span class="line">[root@haproxy GeoLite2-City_20190122]# cp GeoLite2-City.mmdb /etc/logstash/ -a</span><br><span class="line">[root@haproxy ~]# vim /etc/logstash/conf.d/redis-es.conf</span><br><span class="line">input &#123;&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">   filter &#123;</span><br><span class="line">   if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">   geoip &#123;</span><br><span class="line">        source =&gt; "clientip"</span><br><span class="line">        target =&gt; "geoip"</span><br><span class="line">        database =&gt; "/etc/logstash/GeoLite2-City.mmdb"</span><br><span class="line">        add_field =&gt; ["[geoip][coordinates]","%&#123;[geoip][longitude]&#125;"]</span><br><span class="line">        add_field =&gt; ["[geoip][coordinates]","%&#123;[geoip][latitude]&#125;"]</span><br><span class="line">   &#125;</span><br><span class="line">   mutate &#123;</span><br><span class="line">        convert =&gt; ["[geoip][coordinates]","float"]</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    ...</span><br><span class="line">    if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         hosts =&gt; ["192.168.1.20:9200"]</span><br><span class="line">         index =&gt; "logstash-nginx-accesslog-30-%&#123;+yyyy.MM.dd&#125;"</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">#</span> 这里输出到els中的index名称必须以logstash开头，不然在kibana中创建地图选择Field时会有错误提示"No Compatible Fields: The "nginx-accesslog-30-*" index pattern does not contain any of the following field types: geo_point"</span><br><span class="line">&#125;</span><br><span class="line">[root@haproxy ~]# systemctl restart logstash</span><br></pre></td></tr></table></figure>
<h4 id="kibana创建地图"><a href="#kibana创建地图" class="headerlink" title="kibana创建地图"></a>kibana创建地图</h4><blockquote>
<p>删除旧的索引，重新创建新索引</p>
</blockquote>
<p><img src="/images/kibana/地图1.png" alt=""></p>
<blockquote>
<p>查看字段，会有以geoip开头的字段加入</p>
</blockquote>
<p><img src="/images/kibana/地图2.png" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------</span><br><span class="line">  nginx+tomcat+logstash30</span><br><span class="line">-------------------------------------</span><br><span class="line">[root@nginx1 ~]# echo '&#123;"@timestamp":"2019-01-27T19:27:57+08:00","host":"192.168.1.30","clientip":"106.38.38.83","size":0,"responsetime":0.000,"upstreamtime":"-","upstreamhost":"-","http_host":"192.168.1.30","url":"/index.html","domain":"192.168.1.30","xff":"-","referer":"-","status":"304"&#125;' &gt;&gt; /usr/local/nginx/logs/host.access.log.</span><br><span class="line"><span class="meta">#</span> 加入一条假数据到日志文件中，clientip改为公网地址</span><br></pre></td></tr></table></figure>
<blockquote>
<p>创建地图，选择logstash-nginx-accesslog-30-*</p>
</blockquote>
<p><img src="/images/kibana/地图3.png" alt=""></p>
<blockquote>
<p>在Buckets中的Aggregation选择Geohash，Field选择geoip.location，最后点击上方的三角按钮，这时就可以在地图上看到标记了</p>
</blockquote>
<p><img src="/images/kibana/地图4.png" alt=""></p>
<h3 id="将日志写入数据库"><a href="#将日志写入数据库" class="headerlink" title="将日志写入数据库"></a>将日志写入数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">=======================================================================================</span><br><span class="line">规划</span><br><span class="line">1. 安装数据库并授权</span><br><span class="line">2. 创建表</span><br><span class="line">3. 配置logstash将数据写入数据库</span><br><span class="line">4. 测试</span><br><span class="line"></span><br><span class="line">环境</span><br><span class="line">准备一台主机，安装mariadb，地址：192.168.1.25</span><br><span class="line">logstash地址：192.168.1.30</span><br><span class="line">=======================================================================================</span><br><span class="line">--------------</span><br><span class="line">  mariadb</span><br><span class="line">--------------</span><br><span class="line">[root@mysql ~]# yum install -y mariadb-server</span><br><span class="line">[root@mysql ~]# systemctl start mariadb</span><br><span class="line">[root@mysql ~]# mysql_secure_installation</span><br><span class="line">[root@mysql ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE elk CHARACTER SET utf8 COLLATE utf8_bin;</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL privileges ON elk.* TO elk@"%" identified by "centos";</span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line"><span class="meta">#</span> 创建数据库并授权</span><br><span class="line">[root@els3 ~]# mysql -h192.168.1.25 -uelk -pcentos</span><br><span class="line"><span class="meta">#</span> 在其他主机验证远程登录数据库</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  logstash</span><br><span class="line">--------------</span><br><span class="line">[root@nginx1 ~]# yum install -y ruby</span><br><span class="line"><span class="meta">#</span> 需要安装ruby后才可以使用gem命令</span><br><span class="line">[root@nginx1 ~]# gem sources --add http://gems.ruby-china.com --remove https://rubygems.org/</span><br><span class="line"><span class="meta">#</span> Gem是一个管理Ruby库和程序的标准包，它通过Ruby Gem（如 http://rubygems.org/ ）源来查找、安装、升级和卸载软件包，非常的便捷。</span><br><span class="line"><span class="meta">#</span> taobao Gems 源已停止维护，现由 ruby-china 提供镜像服务，所以将国内源改为http://gems.ruby-china.com</span><br><span class="line">[root@nginx1 ~]# mkdir -pv /usr/share/logstash/vendor/jar/jdbc</span><br><span class="line">[root@nginx1 ~]# unzip mysql-connector-java-8.0.14.zip</span><br><span class="line">[root@nginx1 ~]# cp mysql-connector-java-8.0.14/mysql-connector-java-8.0.14.jar /usr/share/logstash/vendor/jar/jdbc/</span><br><span class="line">[root@nginx1 ~]# chown -R logstash.logstash /usr/share/logstash/vendor/jar/</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash-plugin install logstash-output-jdbc</span><br><span class="line">[root@nginx1 ~]# /usr/share/logstash/bin/logstash-plugin list|grep jdbc</span><br><span class="line">logstash-filter-jdbc_static</span><br><span class="line">logstash-filter-jdbc_streaming</span><br><span class="line">logstash-input-jdbc</span><br><span class="line">logstash-output-jdb</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  mariadb</span><br><span class="line">--------------</span><br><span class="line">[root@mysql ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; use elk</span><br><span class="line">MariaDB [elk]&gt; CREATE TABLE elklog (id int(11) NOT NULL AUTO_INCREMENT,host VARCHAR(255),clientip VARCHAR(255),url VARCHAR(255),status INT(16),time timestamp,PRIMARY KEY (id));</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  logstash</span><br><span class="line">--------------</span><br><span class="line">[root@nginx1 filebeat]# vim /etc/logstash/conf.d/beats.conf</span><br><span class="line">if [fields][service] == "nginx-accesslog-30" &#123;</span><br><span class="line">      redis &#123;</span><br><span class="line">         data_type =&gt; "list"</span><br><span class="line">         host =&gt; "192.168.1.24"</span><br><span class="line">         port =&gt; "6379"</span><br><span class="line">         key =&gt; "nginx-accesslog-30"</span><br><span class="line">         db =&gt; "5"</span><br><span class="line">         password =&gt; "centos"</span><br><span class="line">         codec =&gt; "json"</span><br><span class="line">      &#125;</span><br><span class="line">      jdbc &#123;</span><br><span class="line">         driver_jar_path =&gt; "/usr/share/logstash/vendor/jar/jdbc/mysql-connector-java-8.0.14.jar"</span><br><span class="line">         # 插件路径 </span><br><span class="line">         connection_string =&gt; "jdbc:mysql://192.168.1.25:3306/elk?user=elk&amp;password=centos&amp;useUnic</span><br><span class="line">ode=true&amp;characterEncoding=UTF8"</span><br><span class="line"><span class="meta">#</span> 数据库地址、端口、用户名、密码等信息</span><br><span class="line">         statement =&gt; ["INSERT INTO elklog(host,clientip,url,status) VALUES(?,?,?,?)","http_host","clientip","url","status"]</span><br><span class="line"><span class="meta">#</span> 最后四个引号("http_host","clientip","url","status")中的名称是从logstash中取得的字段名称，这四个引号是传入的变量</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">#</span> 设置输出到数据库中</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">  mariadb</span><br><span class="line">--------------</span><br><span class="line">[root@mysql ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; use elk</span><br><span class="line">MariaDB [elk]&gt; select * from elklog;</span><br><span class="line">| 6000 | &#123;"containerized":true,"id":"3e6f1f53c66e409f81bc71d9331832af","architecture":"x86_64","os":&#123;"codename":"Core","family":"redhat","platform":"centos","version":"7 (Core)"&#125;,"name":"nginx1"&#125; | 192.168.1.30 | /test/index.html |   NULL | 2019-01-28 21:28:35 |</span><br><span class="line"><span class="meta">#</span> 这里保存的host有问题，需要将logstash中的statement最后的引号中的host改为http_host即可取得服务器地址了</span><br></pre></td></tr></table></figure>
<h3 id="删除els中索引的脚本"><a href="#删除els中索引的脚本" class="headerlink" title="删除els中索引的脚本"></a>删除els中索引的脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span></span><br><span class="line">DATE=`date -d "0 days ago" +%Y.%m.%d`</span><br><span class="line"><span class="meta">#</span> 获取今天的日期，如果想获取一个月前的日期，就使用30 days ago</span><br><span class="line">LOG_NAME="nginx-accesslog-30"</span><br><span class="line">FILE_NAME=$LOG_NAME-$DATE</span><br><span class="line">curl -XDELETE http://192.168.1.20:9200/$FILE_NAME</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">   echo "$&#123;FILE_NAME&#125; delete success."</span><br><span class="line">else</span><br><span class="line">   echo "$&#123;FILE_NAME&#125; delete error."</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span> 不可直接从/elkdata/data/nodes/0/indices/目录中删除索引，会使els服务器运行出错</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/21/zookeeper-kafka部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/21/zookeeper-kafka部署/" itemprop="url">
                  zookeeper&kafka部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-21 14:51:45" itemprop="dateCreated datePublished" datetime="2019-01-21T14:51:45+08:00">2019-01-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-05-24 23:12:59" itemprop="dateModified" datetime="2019-05-24T23:12:59+08:00">2019-05-24</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/消息队列/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="kafka配置文件說明"><a href="#kafka配置文件說明" class="headerlink" title="kafka配置文件說明"></a>kafka配置文件說明</h3><h4 id="Broker配置"><a href="#Broker配置" class="headerlink" title="Broker配置"></a>Broker配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> broker的全局唯一编号，不能重复</span></span><br><span class="line">broker.id=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用来监听链接的端口，producer或consumer将在此端口建立连接</span></span><br><span class="line">port=9092</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 处理网络请求的线程数量，也就是接收消息的线程数。接收线程会将接收到的消息放到内存中，然后再从内存中写入磁盘。</span></span><br><span class="line">num.network.threads=3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 消息从内存中写入磁盘时使用的线程数量。用来处理磁盘IO的线程数量</span></span><br><span class="line">num.io.threads=8</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送套接字的缓冲区大小</span></span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接受套接字的缓冲区大小</span></span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求套接字的缓冲区大小</span></span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> kafka运行日志存放的路径</span></span><br><span class="line">log.dirs=/export/servers/logs/kafka</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> topic在当前broker上的分片个数。每個partition的備份個數，默認為1，建議根據實際條件選擇；如果這個值較大，意味著消息在各個server上同步時需要的延遲較高</span></span><br><span class="line">num.partitions=2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们知道segment文件默认会被保留7天的时间，超时的话就会被清理，那么清理这件事情就需要有一些线程来做。这里就是用来设置恢复和清理data下数据的线程数量</span></span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> segment文件保留的最长时间，默认保留7天（168小时），超时将被删除，也就是说7天之前的数据将被清理掉。</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 滚动生成新的segment文件的最大时间</span></span><br><span class="line">log.roll.hours=168</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志文件中每个segment的大小，默认为1G</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">上面的参数设置了每一个segment文件的大小是1G，那么就需要有一个东西去定期检查segment文件有没有达到1G，多长时间去检查一次，就需要设置一个周期性检查文件大小的时间（单位是毫秒）。</span></span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志清理是否打开</span></span><br><span class="line">log.cleaner.enable=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> broker需要使用zookeeper保存meta数据，因此broker為zk client；此處為zookeeper集群的connectString，後面可以跟上path，比如hostname:port/chroot/kafka。不過需要注意，path的全路徑需要由自己來創建（使用zookeeper腳本工具）</span></span><br><span class="line">zookeeper.connect=zk01:2181,zk02:2181,zk03:2181</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper链接超时时间</span></span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面我们说过接收线程会将接收到的消息放到内存中，然后再从内存写到磁盘上，那么什么时候将消息从内存中写入磁盘，就有一个时间限制（时间阈值）和一个数量限制（数量阈值），这里设置的是数量阈值，下一个参数设置的则是时间阈值。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 为了减少磁盘写入的次数，broker会将消息暂时buffer起来，当消息的个数达到一定阀值或者过了一定的时间间隔时，再flush到磁盘，这样减少了磁盘IO调用的次数。</span></span><br><span class="line">log.flush.interval.messages=10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 消息buffer的时间，达到阈值，将触发将消息从内存flush到磁盘，单位是毫秒。</span></span><br><span class="line">log.flush.interval.ms=3000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除topic需要server.properties中设置delete.topic.enable=<span class="literal">true</span>否则只是标记删除</span></span><br><span class="line">delete.topic.enable=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此处的host.name为本机IP(重要),如果不改,则客户端会抛出：Producer connection to localhost:9092 unsuccessful 错误！指定broker實例綁定的網絡接口地址</span></span><br><span class="line">host.name=kafka01</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> partition leader等待follower同步消息的最大時間，如果超時，leader將follower移除同步列表</span></span><br><span class="line">replica.lag.time.max.ms=10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 允許follower落後的最大消息條數，如果達到閾值，將follower移除同步列表</span></span><br><span class="line"><span class="meta">#</span><span class="bash">replica.lag.max.message=4000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 消息的備份的個數，默認為1</span></span><br><span class="line">num.replica.fetchers=1</span><br><span class="line"></span><br><span class="line">advertised.host.name=192.168.239.128</span><br></pre></td></tr></table></figure>
<h4 id="Consumer主要配置"><a href="#Consumer主要配置" class="headerlink" title="Consumer主要配置"></a>Consumer主要配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 消费者集群通过连接Zookeeper来找到broker。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper连接服务器地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> consumer作為zookeeper client，需要通過zk保存一些meta信息，此處為zk connectString</span></span><br><span class="line">zookeeper.connect=zk01:2181,zk02:2181,zk03:2181</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper的session过期时间，默认5000ms，用于检测消费者是否挂掉</span></span><br><span class="line">zookeeper.session.timeout.ms=5000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当消费者挂掉，其他消费者要等该指定时间才能检查到并且触发重新负载均衡</span></span><br><span class="line">zookeeper.connection.timeout.ms=10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是一个时间阈值。指定多久消费者更新offset到zookeeper中。注意offset更新时基于time而不是每次获得的消息。一旦在更新zookeeper发生异常并重启，将可能拿到已拿到过的消息</span></span><br><span class="line">zookeeper.sync.time.ms=2000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 當前消費者的group名稱，需要指定</span></span><br><span class="line">group.id=xxxxx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是一个数量阈值，经测试是500条。当consumer消费一定量的消息之后,将会自动向zookeeper提交offset信息。注意offset信息并不是每消费一次消息就向zk提交一次,而是现在本地保存(内存),并定期提交,默认为<span class="literal">true</span></span></span><br><span class="line">auto.commit.enable=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 自动更新时间。默认60 * 1000</span></span><br><span class="line">auto.commit.interval.ms=60*1000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前consumer的标识,可以设定,也可以有系统生成，主要用来跟踪消息消费情况，便于观察</span></span><br><span class="line">conusmer.id=xxx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 消费者客户端编号，用于区分不同客户端，默认客户端程序自动产生</span></span><br><span class="line">client.id=xxxx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大取多少块缓存到消费者(默认10)</span></span><br><span class="line">queued.max.message.chunks=50</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当有新的consumer加入到group时,将会reblance，此后将会有partitions的消费端迁移到新的consumer上，如果一个consumer获得了某个partition的消费权限，那么它将会向zk注册 <span class="string">"Partition Owner registry"</span>节点信息，但是有可能此时旧的consumer尚没有释放此节点，此值用于控制，注册节点的重试次数。</span></span><br><span class="line">rebalance.max.retries=5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 每拉取一批消息的最大字节数。获取消息的最大尺寸，broker不会像consumer输出大于此值的消息chunk每次feth将得到多条消息，此值为总大小，提升此值,将会消耗更多的consumer端内存</span></span><br><span class="line">fetch.min.bytes=6553600</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当消息的尺寸不足时，server阻塞的时间，如果超时，消息将立即发送给consumer。数据一批一批到达，如果每一批是10条消息，如果某一批还不到10条，但是超时了，也会立即发送给consumer。</span></span><br><span class="line">fetch.wait.max.ms=5000</span><br><span class="line">socket.receive.buffer.bytes=655360</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果zookeeper没有offset值或offset值超出范围。那么就给个初始的offset。有smallest、largest、anything可选，分别表示给当前最小的offset、当前最大的offset、抛异常。默认largest</span></span><br><span class="line">auto.offset.reset=smallest</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定序列化处理类</span></span><br><span class="line">derializer.class=kafka.serializer.DefaultDecoder</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 獲取消息的最大尺寸，broker不會像consumer輸出大於此值的消息chunk。每次fetch將得到多條消息，此值為總大小</span></span><br><span class="line">fetch.messages.max.bytes=1024*1024</span><br></pre></td></tr></table></figure>
<h4 id="Producer主要配置"><a href="#Producer主要配置" class="headerlink" title="Producer主要配置"></a>Producer主要配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 指定kafka节点列表，用于获取metadata，不必全部指定</span></span><br><span class="line"><span class="meta">#</span><span class="bash">需要kafka的服务器地址，来获取每一个topic的分片数等元数据信息。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">對於開發者而言，需要通過broker.list指定當前producer需要關注的broker列表，producer通過和每個broker連接，並獲取partitions，如果某個broker連接失敗，將導致此上的partitions無法繼續發佈消息。格式：host1:port,host2:port，其中host:port需要參考broker配置文件。對於producer而言沒有使用zookeeper自動發現broker列表，非常奇怪。</span></span><br><span class="line">metadata.broker.list=kafka01:9092,kafka02:9092,kafka03:9092</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生产者生产的消息被发送到哪个block，需要一个分组策略。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">指定分区处理类。默认kafka.producer.DefaultPartitioner，表通过key哈希到对应分区</span></span><br><span class="line"><span class="meta">#</span><span class="bash">partitions路由類，消息在發送時將根據此實例的方法獲得partition索引號</span></span><br><span class="line"><span class="meta">#</span><span class="bash">partitioner.class=kafka.producer.DefaultPartitioner</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生产者生产的消息可以通过一定的压缩策略（或者说压缩算法）来压缩。消息被压缩后发送到broker集群，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">而broker集群是不会进行解压缩的，broker集群只会把消息发送到消费者集群，然后由消费者来解压缩。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">是否压缩，默认0表示不压缩，1表示用gzip压缩，2表示用snappy压缩。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">压缩后消息中会有头来指明消息压缩类型，故在消费者端消息解压是透明的无需指定。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">文本数据会以1比10或者更高的压缩比进行压缩。</span></span><br><span class="line">compression.codec=none</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">指定序列化处理类，消息在网络上传输就需要序列化，它有String、数组等许多种实现。將消息實體轉換成byte[]</span></span><br><span class="line">serializer.class=kafka.serializer.DefaultEncoder</span><br><span class="line">key.serializer.class=$&#123;serializer.class&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">如果要压缩消息，这里指定哪些topic要压缩消息，默认empty，表示不压缩。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果上面启用了压缩，那么这里就需要设置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">compressed.topics= </span></span><br><span class="line"><span class="meta">#</span><span class="bash">这是消息的确认机制，默认值是0。在面试中常被问到。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">producer有个ack参数，有三个值，分别代表：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">（1）不在乎是否写入成功；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">（2）写入leader成功；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">（3）写入leader和所有副本都成功；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">要求非常可靠的话可以牺牲性能设置成最后一种。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">为了保证消息不丢失，至少要设置为1，也就</span></span><br><span class="line"><span class="meta">#</span><span class="bash">是说至少保证leader将消息保存成功。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">设置发送数据是否需要服务端的反馈,有三个值0,1,2，分别代表3种状态：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">0: producer不会等待broker发送ack。生产者只要把消息发送给broker之后，就认为发送成功了，这是第1种情况；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1: 当leader接收到消息之后发送ack。生产者把消息发送到broker之后，并且消息被写入到本地文件，才认为发送成功，这是第二种情况；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2: 当所有的follower都同步消息成功后发送ack。不仅是主的分区将消息保存成功了，而且其所有的分区的副本数也都同步好了，才会被认为发动成功，这是第3种情况。</span></span><br><span class="line">request.required.acks=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">broker必须在该时间范围之内给出反馈，否则失败。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">在向producer发送ack之前,broker允许等待的最大时间 ，如果超时,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">broker将会向producer发送一个error ACK.意味着上一次消息因为某种原因</span></span><br><span class="line"><span class="meta">#</span><span class="bash">未能成功(比如follower未能同步成功)</span></span><br><span class="line">request.timeout.ms=10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生产者将消息发送到broker，有两种方式，一种是同步，表示生产者发送一条，broker就接收一条；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">还有一种是异步，表示生产者积累到一批的消息，装到一个池子里面缓存起来，再发送给broker，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">这个池子不会无限缓存消息，在下面，它分别有一个时间限制（时间阈值）和一个数量限制（数量阈值）的参数供我们来设置。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">一般我们会选择异步。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">同步还是异步发送消息，默认“sync”表同步，<span class="string">"async"</span>表异步。异步可以提高发送吞吐量,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">也意味着消息将会在本地buffer中,并适时批量发送，但是也可能导致丢失未发送过去的消息</span></span><br><span class="line">producer.type=sync</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在async模式下,当message被缓存的时间超过此值后,将会批量发送给broker,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">默认为5000ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">此值和batch.num.messages协同工作.</span></span><br><span class="line">queue.buffering.max.ms = 5000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">异步情况下，缓存中允许存放消息数量的大小。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">在async模式下,producer端允许buffer的最大消息量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">无论如何,producer都无法尽快的将消息发送给broker,从而导致消息在producer端大量沉积</span></span><br><span class="line"><span class="meta">#</span><span class="bash">此时,如果消息的条数达到阀值,将会导致producer端阻塞或者消息被抛弃，默认为10000条消息。</span></span><br><span class="line">queue.buffering.max.messages=20000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">如果是异步，指定每次批量发送数据量，默认为200</span></span><br><span class="line"><span class="meta">#</span><span class="bash">消息在producer端buffer的條數，僅在producer.type=async下有效</span></span><br><span class="line">batch.num.messages=500</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在生产端的缓冲池中，消息发送出去之后，在没有收到确认之前，该缓冲池中的消息是不能被删除的，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">但是生产者一直在生产消息，这个时候缓冲池可能会被撑爆，所以这就需要有一个处理的策略。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">有两种处理方式，一种是让生产者先别生产那么快，阻塞一下，等会再生产；另一种是将缓冲池中的消息清空。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">当消息在producer端沉积的条数达到<span class="string">"queue.buffering.max.meesages"</span>后阻塞一定时间后,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">队列仍然没有enqueue(producer仍然没有发送出任何消息)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">此时producer可以继续阻塞或者将消息抛弃,此timeout值用于控制<span class="string">"阻塞"</span>的时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-1: 不限制阻塞超时时间，让produce一直阻塞,这个时候消息就不会被抛弃</span></span><br><span class="line"><span class="meta">#</span><span class="bash">0: 立即清空队列,消息被抛弃</span></span><br><span class="line">queue.enqueue.timeout.ms=-1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">当producer接收到error ACK,或者没有接收到ACK时,允许消息重发的次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash">因为broker并没有完整的机制来避免消息重复,所以当网络异常时(比如ACK丢失)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">有可能导致broker接收到重复的消息,默认值为3.</span></span><br><span class="line">message.send.max.retries=3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">producer刷新topic metada的时间间隔,producer需要知道partition leader</span></span><br><span class="line"><span class="meta">#</span><span class="bash">的位置,以及当前topic的情况</span></span><br><span class="line"><span class="meta">#</span><span class="bash">因此producer需要一个机制来获取最新的metadata,当producer遇到特定错误时,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">将会立即刷新</span></span><br><span class="line"><span class="meta">#</span><span class="bash">(比如topic失效,partition丢失,leader失效等),此外也可以通过此参数来配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">额外的刷新机制，默认值600000</span></span><br><span class="line">topic.metadata.refresh.interval.ms=60000</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上是关于kafka一些基础说明，在其中我们知道如果要kafka正常运行，必须配置zookeeper，否则无论是kafka集群还是客户端的生产者和消费者都无法正常的工作</p>
</blockquote>
<h3 id="zookeeper集群部署"><a href="#zookeeper集群部署" class="headerlink" title="zookeeper集群部署"></a>zookeeper集群部署</h3><blockquote>
<p>zookeeper是一个为分布式应用提供一致性服务的软件，它是开源的Hadoop项目的一个子项目，并根据google发表的一篇论文来实现的。zookeeper为分布式系统提供了高效且易于使用的协同服务，它可以为分布式应用提供相当多的服务，诸如统一命名服务，配置管理，状态同步和组服务等。zookeeper接口简单，我们不必过多地纠结在分布式系统编程难于处理的同步和一致性问题上，你可以使用zookeeper提供的现成(off-the-shelf)服务来实现分布式系统额配置管理，组管理，Leader选举等功能。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">準備三台主機，主機名分別為kafka1(10.5.5.19)、kafka2(10.5.5.24)、kafka3(10.5.5.155)。</span><br><span class="line"></span><br><span class="line">* kafka1</span><br><span class="line">到http://zookeeper.apache.org/releases.html去下载zookeeper</span><br><span class="line">yum install java-1.8.0-openjdk-deve</span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper依賴java</span></span><br><span class="line">tar -zxvf zookeeper-3.4.9.tar.gz -C /usr/local</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解壓安裝</span></span><br><span class="line">cd /usr/local</span><br><span class="line">ln -sv zookeeper-3.4.9 zookeeper</span><br><span class="line">cd zookeeper/conf</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vim zoo.cfg</span><br><span class="line">	tickTime=2000</span><br><span class="line">    initLimit=10</span><br><span class="line">    syncLimit=5</span><br><span class="line">    dataDir=/usr/local/zookeeper/data</span><br><span class="line">    dataLogDir=/usr/local/zookeeper/logs</span><br><span class="line">    clientPort=2181</span><br><span class="line">    server.1=10.5.5.19:2888:3888</span><br><span class="line">    server.2=10.5.5.24:2888:3888</span><br><span class="line">    server.3=10.5.5.155:2888:3888</span><br><span class="line"><span class="meta">#</span><span class="bash"> tickTime：这个时间是作为Zookeeper服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每个 tickTime 时间就会发送一个心跳。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dataDir：顾名思义就是 Zookeeper保存数据的目录，默认情况下，Zookeeper将写数据的日志文件也保存在这个目录里。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> clientPort：这个端口就是客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> initLimit：这个配置项是用来配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 5个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5*2000=10 秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> syncLimit：这个配置项标识 Leader 与Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是5*2000=10 秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server.A=B：C：D：其中 A 是一个数字，表示这个是第几号服务器；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意：dataDir,dataLogDir中的wwb是当前登录用户名，data，logs目录开始是不存在，需要使用mkdir命令创建相应的目录。并且在该目录下创建文件myid。serve1,server2,server3该文件内容分别为1,2,3。</span></span><br><span class="line">cd /usr/local/zookeeper</span><br><span class="line">mkdir &#123;data,logs&#125;</span><br><span class="line">cd data</span><br><span class="line">echo 1 &gt; myid</span><br><span class="line">cd</span><br><span class="line">scp zookeeper-3.4.9.tar.gz 10.5.5.24:/root</span><br><span class="line">scp zookeeper-3.4.9.tar.gz 10.5.5.155:/root</span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">	export JAVA_HOME=/usr</span><br><span class="line">chmod +x /etc/profile.d/java.sh</span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line">java -version</span><br><span class="line">scp /etc/profile.d/java.sh 10.5.5.24:/etc/profile.d</span><br><span class="line">scp /etc/profile.d/java.sh 10.5.5.155:/etc/profile.d</span><br><span class="line"></span><br><span class="line">* kafka2&amp;kafka3</span><br><span class="line">yum install java-1.8.0-openjdk-deve</span><br><span class="line">cd /root</span><br><span class="line">tar xf zookeeper-3.4.9.tar.gz -C /usr/local/</span><br><span class="line">cd /usr/local/</span><br><span class="line">ln -sv zookeeper-3.4.9 zookeeper</span><br><span class="line">cd zookeeper</span><br><span class="line">mkdir &#123;data,logs&#125;</span><br><span class="line">cd data/</span><br><span class="line">echo 2 &gt; myid</span><br><span class="line"><span class="meta">#</span><span class="bash"> kafka3這裡改為<span class="built_in">echo</span> 3 &gt; myid</span></span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line">* 三台主機</span><br><span class="line">cd /usr/local/zookeeper/bin</span><br><span class="line">./zkServer.sh start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 啟動zookeeper</span></span><br><span class="line">ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這時只有leader節點會監聽2888端口，另外兩台是不監聽的。三台主機都會監聽2181和3888端口</span></span><br><span class="line">./zkCli.sh -server 10.5.5.19:2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這裡如果連接的是本機的zookeeper可以不用參數和地址，連接集群中其他zookeeper需要。</span></span><br></pre></td></tr></table></figure>
<h3 id="kafka集群部署"><a href="#kafka集群部署" class="headerlink" title="kafka集群部署"></a>kafka集群部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">使用生產環境kafka包，版本：kafka_2.12-0.10.2.0。三台主機的操作相同</span><br><span class="line"></span><br><span class="line">cd /root</span><br><span class="line">tar xf kafka_2.12-0.10.2.0.tgz -C /usr/local</span><br><span class="line">cd /usr/local</span><br><span class="line">ln -sv kafka_2.12-0.10.2.0 kafka</span><br><span class="line">cd kafka/config/</span><br><span class="line">vim server.properties</span><br><span class="line">	broker.id=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 三台主機這裡的id是不台一樣的，分別為1、2、3</span></span><br><span class="line">    num.network.threads=3</span><br><span class="line">    num.io.threads=8</span><br><span class="line">    socket.send.buffer.bytes=102400</span><br><span class="line">    socket.receive.buffer.bytes=102400</span><br><span class="line">    socket.request.max.bytes=104857600</span><br><span class="line">    log.dirs=/usr/local/kafka/logs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這裡改了日誌地址</span></span><br><span class="line">    num.partitions=1</span><br><span class="line">    num.recovery.threads.per.data.dir=1</span><br><span class="line">    log.retention.hours=168</span><br><span class="line">    log.segment.bytes=1073741824</span><br><span class="line">    log.retention.check.interval.ms=300000</span><br><span class="line">    zookeeper.connect=10.5.5.19:2181,10.5.5.24:2181,10.5.5.155:2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper集群內的所有地址都寫入</span></span><br><span class="line">    zookeeper.connection.timeout.ms=6000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件基本使用默認配置，之後會再查看配置文件詳細設置</span></span><br><span class="line">mkdir /usr/local/kafka/logs</span><br><span class="line">cd /usr/local/kafka/bin</span><br><span class="line">nohup ./kafka-server-start.sh ../config/server.properties &amp;</span><br><span class="line">ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這時應該監聽了默認端口9092</span></span><br></pre></td></tr></table></figure>
<h3 id="zookeeper命令"><a href="#zookeeper命令" class="headerlink" title="zookeeper命令"></a>zookeeper命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">./zkServer.sh start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 啟動zookeeper</span></span><br><span class="line">./zkServer.sh status</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看當前zookeeper是leader還是follower</span></span><br><span class="line">./zkServer.sh stop</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止zookeeper</span></span><br><span class="line">./zkCli.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper客戶端，連接當前主機上的zookeeper</span></span><br><span class="line">./zkCli.sh -server IP:port</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接远端服务</span></span><br><span class="line">[root@kafka3 zookeeper]# bin/zkCli.sh </span><br><span class="line">Connecting to localhost:2181</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /</span><br><span class="line">[cluster, controller, controller_epoch, brokers, zookeeper, admin, isr_change_notification, consumers, config]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] ls /brokers</span><br><span class="line">[ids, topics, seqid]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] ls /brokers/topics</span><br><span class="line">[test]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 3] ls /brokers/ids   </span><br><span class="line">[0, 1, 2]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 7] get /brokers/ids/0</span><br><span class="line">&#123;"listener_security_protocol_map":&#123;"PLAINTEXT":"PLAINTEXT"&#125;,"endpoints":["PLAINTEXT://192.168.1.14:9092"],"jmx_port":-1,"host":"192.168.1.14","timestamp":"1548120711670","port":9092,"version":4&#125;</span><br><span class="line">cZxid = 0x10000001c</span><br><span class="line">ctime = Tue Jan 22 09:31:51 CST 2019</span><br><span class="line">mZxid = 0x10000001c</span><br><span class="line">mtime = Tue Jan 22 09:31:51 CST 2019</span><br><span class="line">pZxid = 0x10000001c</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x2687326f51f0000</span><br><span class="line">dataLength = 194</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure>
<h3 id="kafka命令"><a href="#kafka命令" class="headerlink" title="kafka命令"></a>kafka命令</h3><h4 id="創建topic"><a href="#創建topic" class="headerlink" title="創建topic"></a>創建topic</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka1 bin]# ./kafka-topics.sh --create --zookeeper 192.168.1.14:2181 --replication-factor 1 --partitions 3 --topic test</span><br><span class="line">Created topic "test".</span><br><span class="line"><span class="meta">#</span><span class="bash"> 創建topic，--create表示創建，--zookeeper指明zookeeper地址，--topic指定topic名稱，--replication-factor指定副本的數量，--partitions指定分區的數量。--<span class="keyword">if</span>-not-exists表示如果topic不存在就創建。創建的副本的數量不能大於broker，不然會有錯誤提示“Error <span class="keyword">while</span> executing topic <span class="built_in">command</span> : replication factor: 4 larger than available brokers: 2”</span></span><br><span class="line">[root@kafka3 kafka]# ls logs/</span><br><span class="line">cleaner-offset-checkpoint  log-cleaner.log                   server.log.2019-01-22-09</span><br><span class="line">controller.log             meta.properties                   state-change.log</span><br><span class="line">kafka-authorizer.log       recovery-point-offset-checkpoint  test-0</span><br><span class="line">kafka-request.log          replication-offset-checkpoint     test-3</span><br><span class="line">kafkaServer-gc.log         server.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在创建topic后，可以在/usr/<span class="built_in">local</span>/kafka/logs目录查看到分区的目录</span></span><br></pre></td></tr></table></figure>
<h4 id="查看topic"><a href="#查看topic" class="headerlink" title="查看topic"></a>查看topic</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka1 bin]# ./kafka-topics.sh --list --zookeeper localhost:2181</span><br><span class="line">test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看所有的topic</span></span><br><span class="line">[root@kafka1 bin]# ./kafka-topics.sh --describe --zookeeper 192.168.1.15:2181 --topic test</span><br><span class="line">Topic:test      PartitionCount:3        ReplicationFactor:1     Configs:</span><br><span class="line">        Topic: test     Partition: 0    Leader: 2       Replicas: 2     Isr: 2</span><br><span class="line">        Topic: test     Partition: 1    Leader: 0       Replicas: 0     Isr: 0</span><br><span class="line">        Topic: test     Partition: 2    Leader: 1       Replicas: 1     Isr: 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看指定topic情況。列出了lx_test_topic的parition数量、replica因子以及每个partition的leader、replica信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PartitionCount：topic对应的partition的个数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ReplicationFactor：topic对应的副本因子，说白就是副本个数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Partition：partition编号，从0开始递增</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Leader：当前partition起作用的breaker.id</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Replicas: 当前副本数据坐在的breaker.id，是一个列表，排在最前面的起作用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Isr：当前kakfa集群中可用的breaker.id列表</span></span><br></pre></td></tr></table></figure>
<h4 id="增加topic分區"><a href="#增加topic分區" class="headerlink" title="增加topic分區"></a>增加topic分區</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka1 bin]# ./kafka-topics.sh --zookeeper localhost:2181 --alter --topic test --partitions 4</span><br><span class="line">WARNING: If partitions are increased for a topic that has a key, the partition logic or ordering of the messages will be affected</span><br><span class="line">Adding partitions succeeded!</span><br><span class="line"><span class="meta">#</span><span class="bash"> 給現有的topic添加分區，使用--alter選項，在命令中不能加--replication-factor選項，不然會報錯。另外，分区的数量只能增加</span></span><br></pre></td></tr></table></figure>
<h4 id="創建生產者"><a href="#創建生產者" class="headerlink" title="創建生產者"></a>創建生產者</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka1 bin]# ./kafka-console-producer.sh --broker-list 192.168.1.15:9092,192.168.1.13:9092 --topic test</span><br><span class="line">abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 創建生產者，這時終端會等待用戶輸入信息</span></span><br></pre></td></tr></table></figure>
<h4 id="創建消費者"><a href="#創建消費者" class="headerlink" title="創建消費者"></a>創建消費者</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka2 bin]# ./kafka-console-consumer.sh --zookeeper 192.168.1.14:2181 --topic test --from-beginning</span><br><span class="line">Using the ConsoleConsumer with old consumer is deprecated and will be removed in a future major release. Consider using the new consumer by passing [bootstrap-server] instead of [zookeeper].</span><br><span class="line">abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 創建消費者，創建後終端會等待生產者生產消息。在生產者終端輸入信息後，消費者終端會顯示生產者輸入的消息，這表示消費者消費了。如果有多個地址，地址間要用逗號隔開。</span></span><br></pre></td></tr></table></figure>
<h4 id="查看消費者列表"><a href="#查看消費者列表" class="headerlink" title="查看消費者列表"></a>查看消費者列表</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">查看consumer group列表有新、旧两种命令，分别查看新版(信息保存在broker中)consumer列表和老版(信息保存在zookeeper中)consumer列表，因而需要区分指定bootstrap--server和zookeeper参数：</span><br><span class="line">[root@kafka3 bin]# ./kafka-consumer-groups.sh --new-consumer --bootstrap-server 127.0.0.1:9092 --list</span><br><span class="line">Note: This will only show information about consumers that use the Java consumer API (non-ZooKeeper-based consumers).</span><br><span class="line">[root@kafka3 bin]# ./kafka-consumer-groups.sh --zookeeper 127.0.0.1:2181 --list</span><br><span class="line">Note: This will only show information about consumers that use ZooKeeper (not those using the Java consumer API).</span><br><span class="line"></span><br><span class="line">console-consumer-6777</span><br><span class="line">--------------------------------------------</span><br><span class="line">bin/kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --broker-info --group inbound --topic inboundMsg --zookeeper 192.168.2.182:2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> 结果中的Lag是待消费的数量</span></span><br><span class="line">watch '/usr/local/kafka/bin/kafka-consumer-groups.sh --new-consumer --bootstrap-server 192.168.2.182:9092 --group inbound --describe'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果是多个分区，用此命令</span></span><br><span class="line">--------------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看特定consumer group 详情，使用--group与--describe参数</span></span><br></pre></td></tr></table></figure>
<h4 id="查看kafka日誌"><a href="#查看kafka日誌" class="headerlink" title="查看kafka日誌"></a>查看kafka日誌</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./kafka-run-class.sh kafka.tools.DumpLogSegments</span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们可以看到都需要哪些参数，根据不同的需求我们可以选择不同的参数。</span></span><br><span class="line">[root@kafka3 bin]# ./kafka-run-class.sh kafka.tools.DumpLogSegments --files /usr/local/kafka/logs/test-0/00000000000000000000.log --print-data-log</span><br><span class="line">Dumping /usr/local/kafka/logs/test-0/00000000000000000000.log</span><br><span class="line">Starting offset: 0</span><br><span class="line">offset: 0 position: 0 CreateTime: 1548121485387 isvalid: true payloadsize: 3 magic: 1 compresscodec: NONE crc: 3938834414 payload: abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里--<span class="built_in">print</span>-data-log 是表示查看消息内容的，不加此项是查看不到详细的消息内容。如果要查看多个<span class="built_in">log</span>文件可以用逗号分隔。</span></span><br></pre></td></tr></table></figure>
<h4 id="刪除topic"><a href="#刪除topic" class="headerlink" title="刪除topic"></a>刪除topic</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim server.properties</span><br><span class="line">	delete.topic.enable=true</span><br><span class="line">kill -9 kafka</span><br><span class="line">zkServer.sh restart</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置文件後要重啟zookeeper和kafka</span></span><br><span class="line">zkCli.sh</span><br><span class="line">rmr /brokers/topic/topic-name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 進入zookeeper中再刪除topic</span></span><br></pre></td></tr></table></figure>
<h3 id="kafka测试"><a href="#kafka测试" class="headerlink" title="kafka测试"></a>kafka测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 测试生产者</span><br><span class="line">[root@kafka1 kafka]# bin/kafka-topics.sh --create --zookeeper localhost:2181 --topic test-rep-one --partitions 6 --replication-factor 1      </span><br><span class="line">Created topic "test-rep-one".</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个六分区一个副本的topic</span></span><br><span class="line">[root@kafka1 kafka]# bin/kafka-producer-perf-test.sh --num-records 500000 --throughput 100000 --record-size 3000 --topic testtest-rep-one --producer-props bootstrap.servers=192.168.1.14:9092,192.168.1.15:9092,192.168.1.13:9092</span><br><span class="line">...</span><br><span class="line">51490 records sent, 10298.0 records/sec (29.46 MB/sec), 997.3 ms avg latency, 1031.0 max latency.</span><br><span class="line">52075 records sent, 10415.0 records/sec (29.80 MB/sec), 982.8 ms avg latency, 1019.0 max latency.</span><br><span class="line">500000 records sent, 10366.131774 records/sec (29.66 MB/sec), 971.63 ms avg latency, 1033.00 ms max latency, 988 ms 50th, 1014 ms 95th, 1022 ms 99th, 1028 ms 99.9th.</span><br><span class="line"><span class="meta">#</span><span class="bash"> --num-records：要生成的消息数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --throughput：将最大消息吞吐量限制为*大约*吞吐量消息/秒，也就是每秒发送多少条数据</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --record-size：消息大小（字节）。注意，您必须只提供一个--record-size或--payload文件。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --topic：指定主题</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --producer-props：kafka生产者相关的配置属性，如bootstrap。 servers，client.id等。这些配置优先于通过--producer.config传递的配置。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bootstrap.servers：指定kafka地址与端口</span></span><br></pre></td></tr></table></figure>
<h3 id="附錄"><a href="#附錄" class="headerlink" title="附錄"></a>附錄</h3><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">Kafka <span class="keyword">is</span> a distributed,partitioned,replicated commit logservice</span><br><span class="line">卡夫卡是一个分布式的，分区的，复制提交的日志服务</span><br><span class="line">distributed<span class="comment">[dɪ'strɪbjʊtɪd]</span>	adj. 分布式的，分散式的</span><br><span class="line">partitioned adj. 分割的；分区的；分段的</span><br><span class="line">replicated 重复的</span><br><span class="line">topic n. 主题（等于theme）；题目；</span><br><span class="line">partition n. 划分，分开；<span class="comment">[数]</span> 分割；隔墙；隔离物</span><br><span class="line">append 添加；附加</span><br><span class="line">offset 偏移</span><br><span class="line">anatomy <span class="keyword">of</span> a topic</span><br><span class="line">解剖一个主题</span><br><span class="line">anatomy<span class="comment">[ə'nætəmɪ]</span>	n. 解剖；解剖学；剖析；骨骼</span><br><span class="line">consumer n. 消费者；用户，顾客</span><br><span class="line">producer<span class="comment">[prə'djuːsə]</span> n. 制作人，制片人；生产者；发生器</span><br><span class="line">replica<span class="comment">['replɪkə]</span> n. 复制品，复制物</span><br><span class="line">queue<span class="comment">[kjuː]</span> n. 队列；长队；辫子</span><br><span class="line">guarantee<span class="comment">[,ɡærən'ti]</span> n. 保证；担保；保证人；保证书；抵押品</span><br><span class="line">replication factor 複製因子</span><br><span class="line">factor<span class="comment">['fæktə]</span> n. 因素；要素；<span class="comment">[物]</span> 因数；代理人</span><br><span class="line">Websit activity tracking 網絡活動追蹤</span><br><span class="line">activity<span class="comment">[ækˈtɪvətɪ]</span> n. 活动；行动；活跃</span><br><span class="line">Log Aggregation 日誌收集</span><br><span class="line">aggregation<span class="comment">[,æɡrɪ'ɡeɪʃən]</span> n. <span class="comment">[地质]</span><span class="comment">[数]</span> 聚合，聚集；聚集体，集合体</span><br><span class="line">fetch<span class="comment">[fetʃ]</span> vi. 拿；取物；</span><br><span class="line">push<span class="comment">[pʊʃ]</span> n. 推</span><br><span class="line">pull<span class="comment">[pʊl]</span> n. 拉</span><br><span class="line">batch fetch 批量獲取</span><br><span class="line">batch<span class="comment">[bætʃ]</span> n. 一批</span><br><span class="line">provider<span class="comment">[prə'vaɪdə]</span> n. 供应者；养家者</span><br><span class="line">exactly once 恰一次</span><br><span class="line">exactly<span class="comment">[ɪɡ'zæktli]</span>  adv. 恰好地；正是；精确地；正确地</span><br><span class="line">at most once 最多一次</span><br><span class="line">at least once 至少一次</span><br><span class="line">up to date 最新的</span><br><span class="line">log entry　日誌條目</span><br><span class="line">entry<span class="comment">[ˈentrɪ]</span> n. 进入；入口；条目；登记；报关手续；对土地的侵占</span><br><span class="line">segment<span class="comment">['segm(ə)nt]</span> n. 段；部分</span><br><span class="line">chunk<span class="comment">[tʃʌŋk]</span> 數據塊</span><br><span class="line">copy on write 寫入時複製</span><br><span class="line">meta<span class="comment">['metə]</span> 元</span><br><span class="line">Broker node registry Broker節點註冊</span><br><span class="line">registry<span class="comment">['redʒɪstrɪ]</span> n. 注册；登记处；挂号处；船舶的国籍</span><br><span class="line">stream<span class="comment">[striːm]</span> n. 溪流；流动；潮流；光线</span><br><span class="line">balance<span class="comment">['bæl(ə)ns]</span> n. 平衡；余额；匀称</span><br><span class="line">off the shelf 現成的</span><br><span class="line">shelf<span class="comment">[ʃelf]</span> n. 架子；搁板；搁板状物；暗礁</span><br><span class="line">chubby<span class="comment">['tʃʌbɪ]</span> adj. 圆胖的，丰满的 <span class="comment">[ 比较级 chubbier 最高级 chubbiest ]</span></span><br><span class="line">election<span class="comment">[ɪ'lekʃ(ə)n]</span> n. 选举；当选；选择权；上帝的选拔</span><br><span class="line">discovery<span class="comment">[dɪ'skʌv(ə)rɪ]</span> n. 发现，发觉；被发现的事物</span><br><span class="line">broadcast<span class="comment">['brɔːdkɑːst]</span> n. 广播；播音；广播节目</span><br><span class="line">random<span class="comment">['rændəm]</span> adj. <span class="comment">[数]</span> 随机的；任意的；胡乱的</span><br><span class="line">controller<span class="comment">[kən'trəʊlə]</span>	n. 控制器；管理员</span><br><span class="line">proposal<span class="comment">[prəˈpəuzəl]</span> n. 提议;建议; 求婚; 〈美〉投标;</span><br><span class="line">epoch<span class="comment">[ˈi:pɔk]</span> n. 纪元;时期;新时代;世;</span><br><span class="line">failover<span class="comment">[feɪl'əʊvər]</span> n.</span><br><span class="line"><span class="comment">[电脑]</span><span class="comment">[数据库]</span>失效备援 （为系统备援能力的一种，当系统中其中一项设备失效而无法运作时，另一项设备即可自动接手原失效系统所执行的工作）</span><br><span class="line">persist<span class="comment">[pəˈsist]</span> v. 坚持;   固执;   存留;   继续存在; </span><br><span class="line">ephemeral<span class="comment">[ɪˈfemərəl]</span> adj. 短暂的，瞬息的;   朝露;   一年生;   朝生暮死;</span><br><span class="line">sequence<span class="comment">[ˈsi:kwəns]</span>	n. <span class="comment">[数]</span>数列，序列;   顺序;   连续;   片断插曲; </span><br><span class="line">split brain<span class="comment">[split]</span><span class="comment">[brein]</span> 脑裂</span><br><span class="line">split n. 划分;   分歧;   裂缝;   劈叉; </span><br><span class="line">brain n. 脑;   智慧;   聪明的人;   （群体中）最聪明的人;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/21/kafka概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/21/kafka概念/" itemprop="url">
                  kafka概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-21 08:49:36" itemprop="dateCreated datePublished" datetime="2019-01-21T08:49:36+08:00">2019-01-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-22 10:06:32" itemprop="dateModified" datetime="2019-01-22T10:06:32+08:00">2019-01-22</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/zookeeper-kafka/" itemprop="url" rel="index"><span itemprop="name">zookeeper&kafka</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h3><blockquote>
<p> Kafka is a distributed，partitioned，replicated commit logservice。它提供了类似于JMS的特性，但是在设计实现上完全不同，此外它并不是JMS规范的实现。kafka对消息保存时根据Topic进行归类，发送消息者稱为Producer，消息接受者稱为Consumer，此外kafka集群由多个kafka实例组成，每个实例(server)稱为broker。无论是kafka集群，还是producer和consumer都依赖于zookeeper来保证系统可用性，zookeeper集群保存一些meta(元數據)信息。</p>
</blockquote>
<p><img src="/images/kafka/介绍.png" alt=""></p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="消息队列（Message-Queue）"><a href="#消息队列（Message-Queue）" class="headerlink" title="消息队列（Message Queue）"></a>消息队列（Message Queue）</h4><blockquote>
<ul>
<li>消息 Message<br>网络中的两台计算机或者两个通讯设备之间传递的数据。例如说：文本、音乐、视频等内容。</li>
<li>队列 Queue<br>一种特殊的线性表（数据元素首尾相接），特殊之处在于只允许在首部删除元素和在尾部追加元素。入队、出队。</li>
<li>消息队列 MQ<br>消息+队列，保存消息的队列。消息的传输过程中的容器；主要提供生产、消费接口供外部调用做数据的存储和获取。</li>
</ul>
</blockquote>
<h4 id="MQ分类"><a href="#MQ分类" class="headerlink" title="MQ分类"></a>MQ分类</h4><blockquote>
<p>MQ主要分为两类：点对点(p2p)、发布订阅(Pub/Sub)</p>
<ul>
<li><p>共同点：<br>消息生产者生产消息发送到queue中，然后消息消费者从queue中读取并且消费消息。</p>
</li>
<li><p>不同点：<br>p2p模型包括：消息队列(Queue)、发送者(Sender)、接收者(Receiver)<br>一个生产者生产的消息只有一个消费者(Consumer)(即一旦被消费，消息就不在消息队列中)。比如说打电话。</p>
<p>Pub/Sub包含：消息队列(Queue)、主题(Topic)、发布者(Publisher)、订阅者(Subscriber)<br>每个消息可以有多个消费者，彼此互不影响。比如我发布一个微博：关注我的人都能够看到。<br>那么在大数据领域呢，为了满足日益增长的数据量，也有一款可以满足百万级别消息的生成和消费，分布式、持久稳定的产品——Kafka。</p>
</li>
</ul>
</blockquote>
<h4 id="Kafka组件"><a href="#Kafka组件" class="headerlink" title="Kafka组件"></a>Kafka组件</h4><blockquote>
<ul>
<li>Topic：主题，Kafka处理的消息的不同分类。</li>
<li>Broker：消息代理，Kafka集群中的一个kafka服务节点称为一个broker，主要存储消息数据。存在硬盘中。每个topic都是有分区的。</li>
<li>Partition：Topic物理上的分组，一个topic在broker中被分为1个或者多个partition，分区在创建topic的时候指定。</li>
<li>Message：消息，是通信的基本单位，每个消息都属于一个partition</li>
<li>Producer：消息和数据的生产者，向Kafka的一个topic发布消息。</li>
<li>Consumer：消息和数据的消费者，定于topic并处理其发布的消息。</li>
<li>Zookeeper：协调kafka的正常运行。</li>
</ul>
</blockquote>
<h4 id="Topics-logs"><a href="#Topics-logs" class="headerlink" title="Topics/logs"></a><strong>Topics/logs</strong></h4><blockquote>
<p> 一个Topic可以认为是一类消息，每个topic将被分成多个partition(分区)，每个partition在存储层面是append log文件。任何发布到此partition的消息都会被直接追加到log文件的尾部，每条消息在文件中的位置称为offset（偏移量），offset为一个long型数字，它唯一的标记一条消息。kafka并没有提供其他额外的索引机制来存储offset，因为在kafka中几乎不允许对消息进行“随机读写”。</p>
</blockquote>
<p><img src="/images/kafka/topics_logs.png" alt=""></p>
<blockquote>
<p>kafka和JMS（Java Message Service）实现(activeMQ)不同的是：即使消息被消费,消息仍然不会被立即删除。日志文件将会根据broker中的配置要求，保留一定的时间之后删除；比如log文件保留2天，那么两天后,文件会被清除，无论其中的消息是否被消费。kafka通过这种简单的手段，来释放磁盘空间，以及减少消息消费之后对文件内容改动的磁盘IO开支。</p>
<p>对于consumer而言，它需要保存消费消息的offset，对于offset的保存和使用，由consumer来控制；当consumer正常消费消息时，offset将会”线性”的向前驱动，即消息将依次顺序被消费。事实上consumer可以使用任意顺序消费消息，它只需要将offset重置为任意值。(offset将会保存在zookeeper中)</p>
<p>kafka集群几乎不需要维护任何consumer和producer状态信息，这些信息由zookeeper保存；因此producer和consumer的客户端实现非常轻量级，它们可以随意离开，而不会对集群造成额外的影响。</p>
<p>partitions的设计目的有多个。最根本原因是kafka基于文件存储。通过分区，可以将日志内容分散到多个server上，来避免文件尺寸达到单机磁盘的上限，每个partiton都会被当前server(kafka实例)保存；可以将一个topic切分為任意多个partitions，来提高消息保存/消费的效率。此外越多的partitions意味着可以容纳更多的consumer，有效提升并发消费的能力。</p>
</blockquote>
<h4 id="Distribution"><a href="#Distribution" class="headerlink" title="Distribution"></a>Distribution</h4><blockquote>
<p> 一个Topic的多个partitions，被分布在kafka集群中的多个server上；每个server(kafka实例)负责partitions中消息的读写操作；此外kafka还可以配置partitions需要备份的个数(replicas)，每个partition将会被备份到多台机器上，以提高可用性。</p>
<p> 基于replicated方案，那么就意味着需要对多个备份进行调度；每个partition都有一个server为”leader”；leader负责所有的读写操作，如果leader失效，那么将会有其他follower来接管(成为新的leader)；follower只是单调的和leader跟进，同步消息即可。由此可见作为leader的server承载了全部的请求压力，因此从集群的整体考虑，有多少个partitions就意味着有多少个”leader”，kafka会将”leader”均衡的分散在每个实例上，来确保整体的性能稳定。</p>
<ul>
<li><p>Producers</p>
<p>Producer将消息发布到指定的Topic中，同时Producer也能决定将此消息归属于哪个partition；比如基于”round-robin”方式或者通过其他的一些算法等。</p>
</li>
<li><p>Consumers</p>
<p>本质上kafka只支持Topic。每个consumer属于一个consumer group；反过来说，每个group中可以有多个consumer。发送到Topic的消息，只会被订阅此Topic的每个group中的一个consumer消费。</p>
<p>如果所有的consumer都具有相同的group，这种情况和queue模式很像；消息将会在consumers之间负载均衡。</p>
<p>如果所有的consumer都具有不同的group，那这就是”发布-订阅”；消息将会广播给所有的消费者。</p>
<p>在kafka中，一个partition中的消息只会被group中的一个consumer消费；每个group中consumer消息消费互相独立；我们可以认为一个group是一个”订阅”者，因為一个Topic中的每个partions，只会被一个”订阅者”中的一个consumer消费，不过一个consumer可以消费多个partitions中的消息。kafka只能保证一个partition中的消息被某个consumer消费时，消息是顺序的。事实上，从Topic角度来说，消息仍不是有序的。</p>
<p>kafka的设计原理决定，对于一个topic，同一个group中不能有多于partitions个数的consumer同时消费，否则将意味着某些consumer将无法得到消息。partition與consumer的數量最好相等。</p>
</li>
<li><p>Guarantees</p>
</li>
</ul>
<ol>
<li>发送到partitions中的消息将会按照它接收的顺序追加到日志中</li>
<li>对于消费者而言，它们消费消息的顺序和日志中消息顺序一致。</li>
<li>如果Topic的“replication factor”为N,那么允许N-1个kafka实例失效。</li>
</ol>
</blockquote>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><blockquote>
<ol>
<li>Messaging<br>对于一些常规的消息系统，kafka是个不错的选择；partitons/replication和容错，可以使kafka具有良好的扩展性和性能优势。不过到目前为止，我们应该很清楚认识到，kafka并没有提供JMS中的”事务性””消息传输担保(消息确认机制)””消息分组”等企业级特性；kafka只能使用作为”常规”的消息系统，在一定程度上，尚未确保消息的发送与接收绝对可靠(比如消息重发，消息发送丢失等)</li>
<li>Websit activity tracking<br>kafka可以作为”网站活動跟踪”的最佳工具；可以将网页/用户操作等信息发送到kafka中。并实时监控，或者离线统计分析等</li>
<li>Log Aggregation<br>kafka的特性决定它非常适合作为”日志收集中心”；application可以将操作日志”批量””异步”的发送到kafka集群中，而不是保存在本地或者DB中；kafka可以批量提交消息/压缩消息等，这对producer端而言，几乎感觉不到性能的开支。此时consumer端可以使用hadoop等其他系统化的存储和分析系统。</li>
</ol>
</blockquote>
<h3 id="设计原理"><a href="#设计原理" class="headerlink" title="设计原理"></a>设计原理</h3><blockquote>
<p> kafka的设计初衷是希望作为一个统一的信息收集平台，能够实时的收集反馈信息，并需要能够支撑较大的数据量，且具备良好的容错能力。</p>
</blockquote>
<h4 id="持久性"><a href="#持久性" class="headerlink" title="持久性"></a>持久性</h4><blockquote>
<p> kafka使用文件存储消息，这就直接决定kafka在性能上严重依赖文件系统的本身特性。且无论任何OS下，对文件系统本身的优化几乎没有可能。文件缓存/直接内存映射等是常用的手段。因为kafka是对日志文件进行append操作，因此磁盘检索的开支是较小的；同时为了减少磁盘写入的次数，broker会将消息暂时buffer起来，当消息的个数(或尺寸)达到一定閾值时，再flush到磁盘，这样减少了磁盘IO调用的次数。</p>
</blockquote>
<h4 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h4><blockquote>
<p>需要考虑的影响性能点很多，除磁盘IO之外，我们还需要考虑网络IO，这直接关系到kafka的吞吐量问题。kafka并没有提供太多高超的技巧；对于producer端，可以将消息buffer起来，当消息的条数达到一定閾值时，批量发送给broker；对于consumer端也是一样，批量fetch多条消息。不过消息量的大小可以通过配置文件来指定。对于kafka broker端，似乎有个sendfile系统调用[^註釋]可以潜在的提升网络IO的性能。将文件的数据映射到系统内存中，socket直接读取相应的内存区域即可，而无需进程再次copy和交换。 其实对于producer/consumer/broker三者而言，CPU的开支应该都不大，因此启用消息压缩机制是一个良好的策略；压缩需要消耗少量的CPU资源，不过对于kafka而言，网络IO更应该需要考虑。可以将任何在网络上传输的消息都经过压缩。kafka支持gzip/snappy等多种压缩方式。</p>
</blockquote>
<h4 id="生產者"><a href="#生產者" class="headerlink" title="生產者"></a>生產者</h4><blockquote>
<p>负载均衡：producer将会和Topic下所有partition leader保持socket连接；消息由producer直接通过socket发送到broker，中间不会经过任何”路由层”。事实上，消息被路由到哪个partition上，由producer客户端决定。比如可以采用”random””key-hash””轮询”等方式，如果一个topic中有多个partitions，那么在producer端实现”消息均衡分发”是必要的。</p>
<p>其中partition leader的位置(host:port)注册在zookeeper中，producer作为zookeeper client，已经注册了watch用来监听partition leader的变更事件。</p>
<p>异步发送：将多条消息暂且在客户端buffer起来，并将他们批量的发送到broker，小数据IO太多，会拖慢整体的网络延迟，批量延迟发送事实上提升了网络效率。不过这也有一定的隐患，比如说当producer失效时，那些尚未发送的消息将会丢失。</p>
</blockquote>
<h4 id="消費者"><a href="#消費者" class="headerlink" title="消費者"></a>消費者</h4><blockquote>
<p>consumer端向broker发送”fetch”请求，并告知其获取消息的offset；此后consumer将会获得一定条数的消息；consumer端也可以重置offset来重新消费消息。</p>
<p>在JMS实现中，Topic模型基于push方式，即broker将消息推送给consumer端。不过在kafka中，采用了pull方式，即consumer在和broker建立连接之后，主动去pull(或者说fetch)消息；这種模式有些优点，首先consumer端可以根据自己的消费能力适时的去fetch消息并处理，且可以控制消息消费的进度(offset)；此外，消费者可以良好的控制消息消费的数量，batch fetch（批量獲取）.</p>
<p>其他JMS实现，消息消费的位置是由provider保留，以便避免重复发送消息或者将没有消费成功的消息重发等，同时还要控制消息的状态。这就要求JMS broker需要太多额外的工作。在kafka中，partition中的消息只有一个consumer在消费，且不存在消息状态的控制，也没有复杂的消息确认机制，可见kafka broker端是相当轻量级的。当消息被consumer接收之后，consumer可以在本地保存最后消費的offset，并间歇性的向zookeeper注册offset。由此可见，consumer客户端也很轻量级。</p>
</blockquote>
<p><img src="/images/kafka/消费者.png" alt=""></p>
<h4 id="消息傳送機制"><a href="#消息傳送機制" class="headerlink" title="消息傳送機制"></a>消息傳送機制</h4><blockquote>
<p>对于JMS实现，消息传输担保非常直接，有且只有一次(exactly once)。在kafka中稍有不同：</p>
<ol>
<li>at most once：最多一次，这个和JMS中”非持久化”消息类似。发送一次，无论成败，将不会重发。</li>
<li>at least once：消息至少发送一次，如果消息未能接受成功，可能会重发，直到接收成功。</li>
<li>exactly once：消息只会发送一次。</li>
</ol>
<ul>
<li>at most once：消费者fetch消息，然后保存offset，然后处理消息；当client保存offset之后，但是在消息处理过程中出现了异常，导致部分消息未能继续处理。那么此后”未处理”的消息将不能被fetch到，这就是”at most once”。</li>
<li>at least once：消费者fetch消息，然后处理消息，然后保存offset。如果消息处理成功之后，但是在保存offset阶段zookeeper异常导致保存操作未能执行成功，这就导致接下来再次fetch时可能获得上次已经处理过的消息，这就是”at least once”，原因offset没有及时的提交给zookeeper，zookeeper恢复正常还是之前offset状态。</li>
<li><p>exactly once：kafka中并没有严格的去实现(基于2阶段提交,事务)，我们认为这种策略在kafka中是没有必要的。</p>
<p>通常情况下”at-least-once”是我们首选(相比at most once而言，重复接收数据总比丢失数据要好)。</p>
</li>
</ul>
</blockquote>
<h4 id="複製備份"><a href="#複製備份" class="headerlink" title="複製備份"></a>複製備份</h4><blockquote>
<p>kafka将每个partition数据复制到多个server上，任何一个partition都有一个leader和多个follower(可以没有)；备份的个数可以通过broker配置文件来设定。leader处理所有的read-write请求，follower需要和leader保持同步。Follower和consumer一样，消费消息并保存在本地日志中；leader负责跟踪所有的follower状态，如果follower”落后”太多或者失效，leader将会把它从replicas同步列表中删除。当所有的follower都将一条消息保存成功，此消息才被认为是”committed”，那么此时consumer才能消费它。即使只有一个replicas实例存活,仍然可以保证消息的正常发送和接收，只要zookeeper集群存活即可。(不同于其他分布式存储，比如hbase需要”多数派”存活才行)<br>当leader失效时，需在followers中选取出新的leader，可能此时follower落后于leader，因此需要选择一个”up-to-date”的follower。选择follower时需要兼顾一个问题，就是新leaderserver上已经承载的partition leader的个数，如果一个server上有过多的partition leader，意味着此server将承受着更多的IO压力。在选举新leader，需要考虑到”负载均衡”。</p>
</blockquote>
<h4 id="日誌"><a href="#日誌" class="headerlink" title="日誌"></a>日誌</h4><blockquote>
<p>如果一个topic的名称为”my_topic”，它有2个partitions，那么日志将会保存在my_topic_0和my_topic_1两个目录中；日志文件中保存了一序列”log entries”(日志条目)，每个log entry格式为”4个字节的数字，N表示消息的长度” + “N个字节的消息内容”；每个日志都有一个offset来唯一的标记一条消息，offset的值为8个字节的数字，表示此消息在此partition中所处的起始位置。**每个partition在物理存储层面有多个log file组成(称为segment)。segmentfile的命名为”最小offset”.kafka(log)。例如”00000000000.kafka(log)”；其中”最小offset”表示此segment中起始消息的offset。</p>
</blockquote>
<p><img src="/images/kafka/日志.png" alt=""></p>
<blockquote>
<p>其中每个partiton中所持有的segments列表信息会存储在zookeeper中。</p>
<p>当segment文件尺寸达到一定閾值时(可以通过配置文件设定，默认1G)，将会创建一个新的文件；当buffer中消息的条数达到閾值时将会触发日志信息flush到日志文件中，同时如果”距离最近一次flush的时间差”达到閾值时，也会触发flush到日志文件。如果broker失效，极有可能会丢失那些尚未flush到文件的消息。因为server意外仍然会导致log文件格式的破坏(文件尾部)，那么就要求当server启動時需要检测最后一个segment的文件结构是否合法并进行必要的修复。</p>
<p>获取消息时，需要指定offset和最大chunk尺寸，offset用来表示消息的起始位置，chunk size用来表示最大获取消息的总长度(间接的表示消息的条数)。根据offset，可以找到此消息所在segment文件，然后根据segment的最小offset取差值，得到它在file中的相对位置，直接读取输出即可。</p>
<p>日志文件的删除策略非常简单，启动一个后台线程定期扫描log file列表，把保存时间超过閾值的文件直接删除(根据文件的创建时间)。为了避免删除文件时仍然有read操作(consumer消费)，采取copy-on-write方式。</p>
</blockquote>
<h4 id="分配"><a href="#分配" class="headerlink" title="分配"></a>分配</h4><blockquote>
<p>kafka使用zookeeper来存储一些meta信息，并使用了zookeeper watch机制来发现meta信息的变更并作出相应的动作(比如consumer失效，触发负载均衡等)</p>
<ol>
<li><p>Broker node registry：当一个kafkabroker启动后，首先会向zookeeper注册自己的节点信息(临时znode)，同时当broker和zookeeper断开连接时，此znode也会被删除。</p>
<p>格式： /broker/ids/[0…N]   –&gt;host:port，其中[0..N]表示broker id，每个broker的配置文件中都需要指定一个数字类型的id(全局不可重复)，znode的值为此broker的host:port信息。</p>
</li>
<li><p>Broker Topic Registry：当一个broker启动时，会向zookeeper注册自己持有的topic和partitions信息，仍然是一个临时znode。</p>
<p>格式： /broker/topics/[topic]/[0…N]，其中[0..N]表示partition索引号。</p>
</li>
<li><p>Consumer and Consumer group：每个consumer客户端被创建时，会向zookeeper注册自己的信息，此作用主要是为了”负载均衡”。</p>
<p>一个group中的多个consumer可以交错的消费一个topic的所有partitions；简而言之，保证此topic的所有partitions都能被此group所消费，且消费时为了性能考虑，让partition相对均衡的分散到每个consumer上。</p>
</li>
<li><p>Consumer id Registry： 每个consumer都有一个唯一的ID(host:uuid，可以通过配置文件指定，也可以由系统生成)，此id用来标记消费者信息。</p>
<p>格式：/consumers/[group_id]/ids/[consumer_id]</p>
<p>仍然是一个临时的znode，此节点的值为{“topic_name”:#streams…}，即表示此consumer目前所消费的topic + partitions列表。</p>
</li>
<li><p>Consumer offset Tracking：用来跟踪每个consumer目前所消费的partition中最大的offset。</p>
<p>格式：/consumers/[group_id]/offsets/[topic]/[broker_id-partition_id]–&gt;offset_value</p>
<p>此znode为持久节点，可以看出offset跟group_id有关，以表明当group中一个消费者失效，其他consumer可以继续消费。</p>
</li>
<li><p>Partition Owner registry：用来标记partition被哪个consumer消费。临时znode</p>
<p>格式：/consumers/[group_id]/owners/[topic]/[broker_id-partition_id]–&gt;consumer_node_id</p>
<p>当consumer启动时，所触发的操作：<br>A. 首先进行”Consumer id Registry”；<br>B. 然后在”Consumer id Registry”节点下注册一个watch用来监听当前group中其他consumer的”leave”和”join”；只要此znode path下节点列表变更，都会触发此group下consumer的负载均衡。(比如一个consumer失效，那么其他consumer接管partitions)。<br>C. 在”Broker id registry”节点下，注册一个watch用来监听broker的存活情况；如果broker列表变更，将会触发所有的groups下的consumer重新balance（在consumer間再平衡，重新分配？）。</p>
</li>
</ol>
</blockquote>
<p><img src="/images/kafka/分配.png" alt=""></p>
<blockquote>
<ol>
<li>Producer端使用zookeeper用来”发现”broker列表，以及和Topic下每个partition leader建立socket连接并发送消息。</li>
<li>Broker端使用zookeeper用来注册broker信息，以监测partitionleader存活性。</li>
<li>Consumer端使用zookeeper用来注册consumer信息，其中包括consumer消费的partition列表等，同时也用来发现broker列表，并和partition leader建立socket连接，并获取消息。</li>
</ol>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">158</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">123</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
