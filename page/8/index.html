<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/8/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/16/iptables动作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/16/iptables动作/" itemprop="url">
                  iptables动作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-16 09:01:54" itemprop="dateCreated datePublished" datetime="2018-10-16T09:01:54+08:00">2018-10-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 13:55:59" itemprop="dateModified" datetime="2019-01-15T13:55:59+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>“动作”与”匹配条件”一样，也有”基础”与”扩展”之分。同样，使用扩展动作也需要借助扩展模块，但是，扩展动作可以直接使用，不用像使用”扩展匹配条件”那样指定特定的模块。</p>
</blockquote>
<h4 id="REJECT"><a href="#REJECT" class="headerlink" title="REJECT"></a>REJECT</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 常用选项为--reject-with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可用值如下:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-net-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-host-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-port-unreachable,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-proto-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-net-prohibited</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-host-pro-hibited</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-admin-prohibited</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当不设置任何值时，默认值为icmp-port-unreachable。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# iptables -I INPUT -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">[root@localhost ~]# iptables -I INPUT -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝所有主机访问本机</span></span><br><span class="line">[root@localhost ~]# ping 10.5.5.90</span><br><span class="line">PING 10.5.5.90 (10.5.5.90) 56(84) bytes of data.</span><br><span class="line">From 10.5.5.90 icmp_seq=1 Destination Port Unreachable</span><br><span class="line">From 10.5.5.90 icmp_seq=2 Destination Port Unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时用其他主机ping本机提示是“Destination Port Unreachable”</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line">[root@localhost ~]# iptables -A INPUT -j REJECT --reject-with icmp-host-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改提示信息为“icmp-host-unreachable”</span></span><br><span class="line">[root@localhost ~]# ping 10.5.5.90</span><br><span class="line">PING 10.5.5.90 (10.5.5.90) 56(84) bytes of data.</span><br><span class="line">From 10.5.5.90 icmp_seq=1 Destination Host Unreachable</span><br><span class="line">From 10.5.5.90 icmp_seq=2 Destination Host Unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用其他主机ping本机时提示已改为“Destination Host Unreachable”</span></span><br></pre></td></tr></table></figure>
<h4 id="LOG"><a href="#LOG" class="headerlink" title="LOG"></a>LOG</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用LOG动作，可以将符合条件的报文的相关信息记录到日志中，但当前报文具体是被<span class="string">"接受"</span>，还是被<span class="string">"拒绝"</span>，都由后面的规则控制</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> --<span class="built_in">log</span>-level选项可以指定记录日志的日志级别，可用级别有emerg，alert，crit，error，warning，notice，info，debug。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --<span class="built_in">log</span>-prefix选项可以给记录到的相关信息添加<span class="string">"标签"</span>之类的信息，以便区分各种记录到的报文信息，方便在分析时进行过滤。--<span class="built_in">log</span>-prefix对应的值不能超过29个字符。</span></span><br><span class="line"></span><br><span class="line">* 基本设置</span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -j LOG</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上述规则表示所有发往22号端口的tcp报文都符合条件，所以都会被记录到日志中，查看/var/<span class="built_in">log</span>/messages即可看到对应报文的相关信息。但是上述规则只是用于示例，因为上例中使用的匹配条件过于宽泛。所以在使用LOG动作时，匹配条件应该尽量写的精确一些，匹配到的报文数量也会大幅度的减少，这样冗余的日志信息就会变少，同时日后分析日志时，日志中的信息可用程度更高。</span></span><br><span class="line">[root@localhost ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 48 packets, 4200 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1          46     3296 LOG        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22 LOG flags 0 level 4</span><br><span class="line">[root@localhost ~]# tail -f /var/log/messages </span><br><span class="line">Oct 16 17:27:36 localhost kernel: IN=eno16777736 OUT= MAC=00:0c:29:45:17:9b:50:7b:9d:65:f9:ff:08:00 SRC=10.5.5.23 DST=10.5.5.90 LEN=40 TOS=0x00 PREC=0x00 TTL=64 ID=2314 DF PROTO=TCP SPT=51108 DPT=22 WINDOW=16243 RES=0x00 ACK URGP=0 </span><br><span class="line">Oct 16 17:27:37 localhost kernel: IN=eno16777736 OUT= MAC=00:0c:29:45:17:9b:50:7b:9d:65:f9:ff:08:00 SRC=10.5.5.23 DST=10.5.5.90 LEN=92 TOS=0x00 PREC=0x00 TTL=64 ID=2323 DF PROTO=TCP SPT=51108 DPT=22 WINDOW=16243 RES=0x00 ACK PSH URGP=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> LOG动作默认会将报文的相关信息记录在/var/<span class="built_in">log</span>/message文件中</span></span><br><span class="line">[root@localhost ~]# vim /etc/rsyslog.conf</span><br><span class="line">	kern.warning /var/log/iptables.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入上面一行，让iptables将日志记录在其他位置	</span></span><br><span class="line">[root@localhost ~]# systemctl restart rsyslog</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启日志服务</span></span><br><span class="line"></span><br><span class="line">* --log-prefix</span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -m state --state NEW -j LOG --log-prefix "want-in-from-port-22"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将主动连接22号端口的报文的相关信息都记录到日志中，并且把这类记录命名为<span class="string">"want-in-from-port-22"</span></span></span><br><span class="line">[root@localhost ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 44 packets, 3150 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 LOG        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22 state NEW LOG flags 0 level 4 prefix "want-in-from-port-22"</span><br><span class="line">[root@localhost ~]# tail -f /var/log/iptables.log </span><br><span class="line">Oct 16 17:41:08 localhost kernel: want-in-from-port-22IN=eno16777736 OUT= MAC=00:0c:29:45:17:9b:00:0c:29:96:6b:bf:08:00 SRC=10.5.5.91 DST=10.5.5.90 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=7879 DF PROTO=TCP SPT=42102 DPT=22 WINDOW=14600 RES=0x00 SYN URGP=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用其他主机连接本机时会有相关记录。这条日志中包含<span class="string">"标签"</span>：want-in-from-port-22，如果有很多日志记录，我们就能通过这个<span class="string">"标签"</span>进行筛选了，这样方便我们查看日志，同时，从上述记录中还能够得知报文的源IP与目标IP，源端口与目标端口等信息，从上述日志我们能够看出，10.5.5.91这个IP想要在17:41:08连接到10.5.5.91（当前主机的IP）的22号端口，报文由eno16777736网卡进入，eno16777736网卡的MAC地址为00:0c:29:45:17:9b，客户端网卡的mac地址为00:0c:29:96:6b:bf。</span></span><br></pre></td></tr></table></figure>
<h4 id="测试源地址与目标地址转换"><a href="#测试源地址与目标地址转换" class="headerlink" title="测试源地址与目标地址转换"></a>测试源地址与目标地址转换</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 准备四台主机，一台主机为公网主机，一台为防火墙，两台为内网主机。使用公网主机通过防火墙访问内网linux服务器。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A 公网主机IP：10.5.5.90</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> B 防火墙IP：10.5.5.91、192.168.116.129</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> C 内网linux服务器IP：192.168.116.130</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> D 内网windows主机IP：192.168.116.131</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将主机C和D的网关都指向B的内网地址，主机A和B的公网地址是桥接到宿主机的网卡上，打开B防火墙的路由功能ip_forward，在A和C主机上启动httpd服务。</span></span><br></pre></td></tr></table></figure>
<h5 id="SNAT"><a href="#SNAT" class="headerlink" title="SNAT"></a>SNAT</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t nat -A POSTROUTING -s 192.168.116.0/24 -j SNAT --to-source 10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加规则，让内网主机经过防火墙出去时的地址都改为防火墙的外网地址。<span class="string">"-t nat"</span>表示操作nat表。filter表的功能是过滤，nat表的功能就是地址转换，所以我们需要在nat表中定义nat规则。<span class="string">"-A POSTROUTING"</span>表示将SNAT规则添加到POSTROUTING链的末尾，在centos7中，SNAT规则只能存在于POSTROUTING链与INPUT链中，在centos6中，SNAT规则只能存在于POSTROUTING链中。<span class="string">"-j SNAT"</span>表示使用SNAT动作，对匹配到的报文进行处理，对匹配到的报文进行源地址转换。<span class="string">"--to-source 10.5.5.91"</span>表示将匹配到的报文的源IP修改为10.5.5.91</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在centos7中，SNAT规则也可以定义在INPUT链中，我们可以这样理解，发往本机的报文经过INPUT链以后报文就到达了本机，如果再不修改报文的源地址，就没有机会修改了。</span></span><br><span class="line">[root@localhost ~]# iptables -t nat --line -nvxL</span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 SNAT       all  --  *      *       192.168.116.0/24     0.0.0.0/0            to:10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置上面的规则后就可以ping通外网主机了</span></span><br><span class="line">* A</span><br><span class="line">[root@localhost ~]# tcpdump -i eno16777736 -nn icmp</span><br><span class="line">18:41:22.375035 IP 10.5.5.91 &gt; 10.5.5.90: ICMP echo request, id 14189, seq 17, length 64</span><br><span class="line">18:41:22.375090 IP 10.5.5.90 &gt; 10.5.5.91: ICMP echo reply, id 14189, seq 17, length 64</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时在主机A上抓包，用C主机ping主机A，可以看到是10.5.5.91发来的数据。在主机C上也可以看到是主机A返回的信息。在C主机上抓包也可以看到是外网主机返回的信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在A主机上不要添加到内网的路由，这样，在防火墙没有添加SNAT规则时，内网是不能ping通外网的，当添加了SNAT规则后，内网主机就可以ping通外网了</span></span><br></pre></td></tr></table></figure>
<h5 id="DNAT"><a href="#DNAT" class="headerlink" title="DNAT"></a>DNAT</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t nat -I PREROUTING -d 10.5.5.91 -p tcp --dport 3389 -j DNAT --to-destination 192.168.116.131:3389</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入一条规则，在PREROUTING链上，目标地址是防火墙的外网地址，端口是3389。目标地址转换为内网地址192.168.116.131:3389。实际就是地址与端口映射，将外网的地址与端口映射为内网的地址与端口</span></span><br><span class="line">[root@localhost ~]# iptables -t nat --line -nvxL</span><br><span class="line">Chain PREROUTING (policy ACCEPT 18 packets, 2657 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           1       52 DNAT       tcp  --  *      *       0.0.0.0/0            10.5.5.91            tcp dpt:3389 to:192.168.116.131:3389</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 18 packets, 2657 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 1 packets, 52 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           6      904 SNAT       all  --  *      *       192.168.116.0/24     0.0.0.0/0            to:10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置内网windows主机可以远程访问，之后用本机远程连接10.5.5.91，也就是防火墙地址，这时是可以连接到内网主机192.168.116.131上的。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 理论上只配置DNAT规则即可，但是如果在测试时无法正常DNAT，可以尝试配置对应的SNAT，此处按照配置SNAT的流程进行。SNAT规则与上面是一样的，就是将内网的主机出去的地址都改为防火墙的地址。</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -t nat -I PREROUTING -d 10.5.5.91 -p tcp --dport 8080 -j DNAT --to-destination 192.168.116.130:80</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加一条端口映射，将外网的8080端口映射到内网的80端口上</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这次，我们不用再次定义SNAT规则了，因为之前已经定义过SNAT规则，上次定义的SNAT规则只要定义一次就行，而DNAT规则则需要根据实际的情况去定义。</span></span><br></pre></td></tr></table></figure>
<h4 id="MASQUERADE"><a href="#MASQUERADE" class="headerlink" title="MASQUERADE"></a>MASQUERADE</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当我们拨号网上时，每次分配的IP地址往往不同，不会长期分给我们一个固定的IP地址，如果这时，我们想要让内网主机共享公网IP上网，就会很麻烦，因为每次IP地址发生变化以后，我们都要重新配置SNAT规则，这样显得不是很人性化，我们通过MASQUERADE即可解决这个问题，MASQUERADE会动态的将源地址转换为可用的IP地址，其余与SNAT实现的功能完全一致，都是修改源地址，只不过SNAT需要指明将报文的源地址改为哪个IP，而MASQUERADE则不用指定明确的IP，会动态的将报文的源地址修改为指定网卡上可用的IP地址</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -t nat -I POSTROUTING -s 192.168.116.0/24 -o eno16777736 -j MASQUERADE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过外网网卡出去的报文在经过POSTROUTING链时，会自动将报文的源地址修改为外网网卡上可用的IP地址，这时，即使外网网卡中的公网IP地址发生了改变，也能够正常的、动态的将内部主机的报文的源IP映射为对应的公网IP。可以把MASQUERADE理解为动态的、自动化的SNAT，如果没有动态SNAT的需求，没有必要使用MASQUERADE，因为SNAT更加高效。</span></span><br></pre></td></tr></table></figure>
<h4 id="REDIRECT"><a href="#REDIRECT" class="headerlink" title="REDIRECT"></a>REDIRECT</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用REDIRECT动作可以在本机上进行端口映射</span></span><br><span class="line">[root@localhost ~]# iptables -t nat -A PREROUTING -p tcp --dport 19000 -j REDIRECT --to-ports 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将本机的22端口映射到本机的19000端口上。REDIRECT规则只能定义在PREROUTING链或者OUTPUT链中。</span></span><br><span class="line">[root@template network-scripts]# ssh 192.168.1.14 -p 19000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在另一台主机连接测试</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/15/iptables网络防火墙/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/15/iptables网络防火墙/" itemprop="url">
                  iptables网络防火墙
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-15 14:32:53" itemprop="dateCreated datePublished" datetime="2018-10-15T14:32:53+08:00">2018-10-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 13:12:06" itemprop="dateModified" datetime="2019-01-15T13:12:06+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li><p>网络防火墙往往处于网络的入口或者边缘</p>
</li>
<li><p>网络防火墙的职责就是”过滤并转发”。要想”过滤”，只能在INPUT、OUTPUT、FORWARD三条链中实现，要想”转发”，报文则只会经过FORWARD链（发往本机的报文才会经过INPUT链），所以，iptables的角色变为”网络防火墙”时，规则只能定义在FORWARD链中。</p>
</li>
</ul>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 准备三台linux主机，一台为外网主机，一台为内网主机，一台允当防火墙</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A外网主机IP：10.5.5.90</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> B内网主机IP：192.168.116.130</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> C网络防火墙IP：192.168.116.129、10.5.5.91</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将虚拟机C的第二块网卡和B的网卡设置为仅主机</span></span><br><span class="line">* B</span><br><span class="line">[root@localhost ~]# vim /etc/sysconfig/network-scripts/ifcfg-eno16777736</span><br><span class="line">    IPADDR=192.168.116.130</span><br><span class="line">    NETMASK=255.255.255.0</span><br><span class="line">    GATEWAY=192.168.116.129</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将B主机的网关指向C（防火墙）主机的内网地址192.168.116.129</span></span><br><span class="line"></span><br><span class="line">* A</span><br><span class="line">[root@localhost ~]#route add -net 192.168.116.0/24 gw 10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给外网主机加一条路由，让外网主机知道如何到内网主机</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 现在外网与内网主机还不能互相ping通，因为防火墙没有路由数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为在CentOS中，IP地址属于主机，所以内外网的主机都可以ping通防火墙的外网地址</span></span><br><span class="line"></span><br><span class="line">* C</span><br><span class="line">[root@localhost ~]# echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启防火墙路由功能</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时内外网可以互相ping通了。</span></span><br><span class="line">[root@localhost ~]# iptables -A FORWARD -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝所有数据转发。这时内外网又不能互相ping通了。</span></span><br><span class="line"></span><br><span class="line">* A</span><br><span class="line">[root@localhost ~]# vim /var/www/html/index.html</span><br><span class="line">	10.5.5.90</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加默认主页</span></span><br><span class="line">[root@localhost ~]# systemctl start httpd</span><br><span class="line"></span><br><span class="line">* B</span><br><span class="line">[root@localhost ~]# vim /var/www/html/index.html</span><br><span class="line">	192.168.116.130</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加默认主页</span></span><br><span class="line">[root@localhost ~]# systemctl start httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动两台主机的httpd服务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时两台主机是不能互相访问的</span></span><br><span class="line"></span><br><span class="line">* C</span><br><span class="line">[root@localhost ~]# iptables -I FORWARD -s 192.168.116.0/24 -p tcp --dport 80 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 让源地址是192.168.116.0网段的主机可以访问外部的80端口。只加入这一条还不行，这只是数据流出的规则，还要加数据流入的规则</span></span><br><span class="line">[root@localhost ~]# iptables -I FORWARD -d 192.168.116.0/24 -p tcp --sport 80 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入此条后，192.168.116.0网段的主机就可以访问外部的80端口了。</span></span><br><span class="line">[root@localhost ~]# iptables -D FORWARD 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除FORWARD中的第一条规则</span></span><br><span class="line">[root@localhost ~]# iptables -I FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入这一条就可以将绝大多数响应报文放行了。配置完上述规则后，我们只要考虑请求报文的方向就行了，而回应报文，上述一条规则就能搞定，这样配置，即使以后有更多服务的响应报文需要放行，我们也不用再去针对响应报文设置规则了</span></span><br><span class="line">[root@localhost ~]# iptables -I FORWARD -s 192.168.116.0/24 -p tcp --dport 22 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入这一条就可以实现内网主机使用ssh连接外部主机了</span></span><br><span class="line">[root@test ~]# iptables -I FORWARD -p icmp -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 放行内外网间的ping请求</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/15/iptables自定义规则链/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/15/iptables自定义规则链/" itemprop="url">
                  iptables自定义规则链
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-15 14:05:17" itemprop="dateCreated datePublished" datetime="2018-10-15T14:05:17+08:00">2018-10-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 12:38:26" itemprop="dateModified" datetime="2019-01-15T12:38:26+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="创建自定义规则链"><a href="#创建自定义规则链" class="headerlink" title="创建自定义规则链"></a>创建自定义规则链</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当默认链中的规则非常多时，不方便我们管理。所以要自定义规则链</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 自定义链并不能直接使用，而是需要被默认链引用才能够使用</span></span><br><span class="line"></span><br><span class="line">* 创建自定义链</span><br><span class="line">[root@bogon ~]# iptables -t filter -N IN_WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"-t filter"</span>表示操作的表为filter表，与之前的示例相同，省略-t选项时，缺省操作的就是filter表。<span class="string">"-N IN_WEB"</span>表示创建一个自定义链，自定义链的名称为<span class="string">"IN_WEB"</span></span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line">2         386    26796 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">3        4087   278278 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 44 packets, 4228 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain IN_WEB (0 references)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看filter表中的链，这条自定义链的引用计数为0 (0 references)，也就是说，这条自定义链还没有被任何默认链所引用，所以，即使IN_WEB中配置了规则，也不会生效</span></span><br><span class="line"></span><br><span class="line">* 创建自定义链规则</span><br><span class="line">[root@bogon ~]# iptables -I IN_WEB -s 10.5.5.249 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables --line -nvxL IN_WEB</span><br><span class="line">Chain IN_WEB (0 references)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     all  --  *      *       10.5.5.249           0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自定义链中已经有了一条规则，但是目前，这条规则无法匹配到任何报文，因为我们并没有在任何默认链中引用它。</span></span><br><span class="line"></span><br><span class="line">* 引用自定义链</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 80 -j IN_WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在INPUT链中添加了一条规则，访问本机80端口的tcp报文将会被这条规则匹配到，而上述规则中的<span class="string">"-j IN_WEB"</span>表示：访问80端口的tcp报文将由自定义链<span class="string">"IN_WEB"</span>中的规则进行处理。此处，我们将<span class="string">"动作"</span>替换为了<span class="string">"自定义链"</span>，当<span class="string">"-j"</span>对应的值为一个自定义链时，就表示被当前规则匹配到的报文将交由对应的自定义链处理。当IN_WEB自定义链被INPUT链引用以后，可以发现，IN_WEB链的引用计数已经变为1，表示这条自定义链已经被引用了1次，自定义链还可以引用其他的自定义链</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 IN_WEB     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">2           0        0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line">3         663    46156 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">4        5196   351595 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 76 packets, 7396 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain IN_WEB (1 references)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     all  --  *      *       10.5.5.249           0.0.0.0/0            reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>
<h4 id="重命名自定义链"><a href="#重命名自定义链" class="headerlink" title="重命名自定义链"></a>重命名自定义链</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# iptables -E IN_WEB WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"-E"</span>选项可以修改自定义链名</span></span><br><span class="line">[root@bogon ~]# iptables -nvL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">   80  5672 WEB        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line">  888 62080 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line"> 6265  425K REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 24 packets, 2328 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain WEB (2 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    1    60 REJECT     all  --  *      *       10.5.5.249           0.0.0.0/0            reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>
<h4 id="删除自定义链"><a href="#删除自定义链" class="headerlink" title="删除自定义链"></a>删除自定义链</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"-X"</span>选项可以删除自定义链，但是删除自定义链时，需要满足两个条件：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1、自定义链没有被任何默认链引用，即自定义链的引用计数为0。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、自定义链中没有任何规则，即自定义链为空。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -X WEB</span><br><span class="line">iptables: Too many links.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提示：Too many links，是因为WEB链已经被默认链所引用</span></span><br><span class="line">[root@bogon ~]# iptables -D INPUT 1</span><br><span class="line">[root@bogon ~]# iptables -X WEB</span><br><span class="line">iptables: Directory not empty.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除引用自定义链的规则后，再次尝试删除自定义链，提示：Directory not empty，是因为WEB链中存在规则</span></span><br><span class="line">[root@bogon ~]# iptables -t filter -F WEB</span><br><span class="line">[root@bogon ~]# iptables -t filter -X WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除规则后再删除自定义链就没问题了。使用<span class="string">"-X"</span>选项可以删除一个引用计数为0的、空的自定义链</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/12/iptables匹配条件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/12/iptables匹配条件/" itemprop="url">
                  iptables匹配条件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-12 16:35:15" itemprop="dateCreated datePublished" datetime="2018-10-12T16:35:15+08:00">2018-10-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-13 14:46:45" itemprop="dateModified" datetime="2019-02-13T14:46:45+08:00">2019-02-13</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基本匹配条件"><a href="#基本匹配条件" class="headerlink" title="基本匹配条件"></a>基本匹配条件</h3><h4 id="指定地址"><a href="#指定地址" class="headerlink" title="指定地址"></a>指定地址</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">* 一次指定多个源地址</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249,10.5.5.224 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用逗号分隔多个地址</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 55 packets, 4698 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 DROP       all  --  *      *       10.5.5.224           0.0.0.0/0           </span><br><span class="line">2          12     1008 DROP       all  --  *      *       10.5.5.249           0.0.0.0/0 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定后会一次添加两条规则</span></span><br><span class="line"></span><br><span class="line">* 指定网段</span><br><span class="line">[root@bogon ~]# iptables -I FORWARD -s 10.5.5.0/16 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝10.5.5.0网段的所有地址访问</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL FORWARD</span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 DROP       all  --  *      *       10.5.0.0/16          0.0.0.0/0</span><br><span class="line"></span><br><span class="line">* 对条件取反</span><br><span class="line">[root@bogon ~]# iptables -A INPUT ! -s 10.5.5.25 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"! -s 10.5.5.25"</span>表示对 -s 10.5.5.25这个匹配条件取反， -s 10.5.5.25表示报文源IP地址为10.5.5.25即可满足匹配条件，使用 <span class="string">"!"</span> 取反后则表示，报文源地址IP只要不为10.5.5.25即满足条件，那么，上例中规则表达的意思就是，只要发往本机的报文的源地址不是10.5.5.25，就接受报文。但10.5.5.25还是可以ping通这台主机，因为filter表的INPUT链中只有一条规则，这条规则要表达的意思就是：只要报文的源IP不是10.5.5.25，那么就接受此报文，但并不能代表，报文的源IP是10.5.5.25时，会被拒绝。因为并没有任何一条规则指明源IP是10.5.5.25时，该执行怎样的动作，所以，当来自10.5.5.25的报文经过INPUT链时，并不能按上例中的规则处理报文，这时报文被两条规则匹配，一是拒绝10.5.5.25的报文，一是默认允许所有报文通过的规则。于是，此报文就继续匹配后面的规则，因为只有一条规则，于是，此报文就会去匹配当前链的默认动作(默认策略)，因为默认策略是ACCEPT，所以10.5.5.25还可以ping通这台主机。</span></span><br><span class="line">[root@bogon ~]# iptables --line -vnxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 287 packets, 24108 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1         159    12226 ACCEPT     all  --  *      *      !10.5.5.25            0.0.0.0/0 </span><br><span class="line"></span><br><span class="line">* 指定目标地址</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -d 10.5.5.22 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这条规则就可以实现上面的禁止10.5.5.249访问本机10.5.5.22</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-d选项指定目标地址。如果我们不指定任何目标地址，则目标地址默认为0.0.0.0/0，同理，如果我们不指定源地址，源地址默认为0.0.0.0/0。-d选项也可以使用<span class="string">"叹号"</span>进行取反，也能够同时指定多个IP地址，使用<span class="string">"逗号"</span>隔开即可。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 但是请注意，不管是-s选项还是-d选项，取反操作与同时指定多个IP的操作不能同时使用。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当一条规则中有多个匹配条件时，那么多个匹配条件之间，默认存在<span class="string">"与"</span>的关系。如上面规则表示源地址与目标地址必须同时能被这两个条件匹配，才算作被当前规则匹配</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1          12     1008 DROP       all  --  *      *       10.5.5.249           10.5.5.22           </span><br><span class="line">2        1978   144348 ACCEPT     all  --  *      *      !10.5.5.25            0.0.0.0/0</span><br></pre></td></tr></table></figure>
<h4 id="协议类型"><a href="#协议类型" class="headerlink" title="协议类型"></a>协议类型</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp -s 10.5.5.249 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝10.5.5.249的tcp请求，所以ssh无法连接，但可以ping通。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当不使用-p指定协议类型时，默认表示所有类型的协议都会被匹配到，与使用-p all的效果相同。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT ! -p udp -s 10.5.5.249 -j DROP</span><br><span class="line">[root@bogon ~]# iptables --line -xvnL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 192 packets, 11044 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1          18     1512 DROP      !udp  --  *      *       10.5.5.249           0.0.0.0/0           </span><br><span class="line">2           0        0 DROP       tcp  --  *      *       10.5.5.249           0.0.0.0/0 </span><br><span class="line"><span class="meta">#</span><span class="bash"> -p用于匹配报文的协议类型,可以匹配的协议类型tcp、udp、udplite、icmp、esp、ah、sctp等（centos7中还支持icmpv6、mh）</span></span><br></pre></td></tr></table></figure>
<h4 id="网卡接口"><a href="#网卡接口" class="headerlink" title="网卡接口"></a>网卡接口</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 流入</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -i eth0 -j DROP</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp ! -i eth0 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> -i用于匹配报文是从哪个网卡接口流入本机的，由于匹配条件只是用于匹配报文流入的网卡，所以在OUTPUT链与POSTROUTING链中不能使用此选项。</span></span><br><span class="line">[root@bogon ~]# iptables --line -xvnL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 52 packets, 4422 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 DROP       icmp --  !eth0  *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">2          25     2100 DROP       icmp --  eth0   *       0.0.0.0/0            0.0.0.0/0</span><br><span class="line"></span><br><span class="line">* 流出</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p icmp -o eth0 -j DROP</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p icmp ! -o eth0 -j DROP</span><br><span class="line">[root@bogon ~]# iptables --line -xvnL OUTPUT</span><br><span class="line">Chain OUTPUT (policy ACCEPT 65 packets, 6908 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 DROP       icmp --  *      !eth0   0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">2          23     1932 DROP       icmp --  *      eth0    0.0.0.0/0            0.0.0.0/0</span><br></pre></td></tr></table></figure>
<h3 id="扩展匹配条件"><a href="#扩展匹配条件" class="headerlink" title="扩展匹配条件"></a>扩展匹配条件</h3><h4 id="tcp扩展模块"><a href="#tcp扩展模块" class="headerlink" title="tcp扩展模块"></a>tcp扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">* 目标端口</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp -m tcp --dport 22 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-m选项来指定扩展模块，如果想要使用--dport这个扩展匹配条件，则必须依靠某个扩折模块完成，上例中，这个扩展模块就是tcp扩展模块。 -m tcp表示使用tcp扩展模块，--dport表示tcp扩展模块中的一个扩展匹配条件，可用于匹配报文的目标端口。-p tcp与 -m tcp并不冲突，-p用于匹配报文的协议，-m 用于指定扩展模块的名称，正好这个扩展模块也叫tcp。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 基本匹配条件我们可以直接使用，而如果想要使用扩展匹配条件，则需要依赖一些扩展模块</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 扩展匹配条件是可以取反的，同样是使用<span class="string">"!"</span>进行取反，比如 <span class="string">"! --dport 22"</span>，表示目标端口不是22的报文将会被匹配到。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp --dport 22 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以省略-m选项。当使用-p选项指定了报文的协议时，如果在没有使用-m指定对应的扩展模块名称的情况下，使用了扩展匹配条件，  iptables默认会调用与-p选项对应的协议名称相同的模块。</span></span><br><span class="line"></span><br><span class="line">* 源端口</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp --sport 22 -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables --line -xvnL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 59 packets, 4224 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 ACCEPT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            tcp spt:22</span><br><span class="line">2           1       60 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            tcp dpt:22 reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">* 指定端口范围</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp --dport 22:25 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables --line -xvnL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 9 packets, 662 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            tcp dpts:22:25 reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> --dport 22:25表示目标端口为22到25之间的所有端口</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp --dport :22 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp --sport 80: -j REJECT </span><br><span class="line">[root@bogon ~]# iptables --line -xvnL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 46 packets, 3358 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            tcp spts:80:65535 reject-with icmp-port-unreachable</span><br><span class="line">2           0        0 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            tcp dpts:0:22 reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> --sport和--dport都可以指定多个端口，第一条表示从0到22端口，第二条表示80端口到65535端口</span></span><br><span class="line"></span><br><span class="line">* --tcp-flags</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"--tcp-flags"</span>指的就是tcp头中的标志位，我们可以通过此扩展匹配条件，去匹配tcp报文的头部的标识位，然后根据标识位的实际情况实现访问控制的功能。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp -m tcp --dport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"-m tcp --dport 22"</span>的表示使用tcp扩展模块，指定目标端口为22号端口(ssh默认端口)，<span class="string">"--tcp-flags"</span>用于匹配报文tcp头部的标志位，<span class="string">"SYN,ACK,FIN,RST,URG,PSH SYN"</span>就是用于配置我们要匹配的标志位的，我们可以把这串字符拆成两部分去理解，第一部分为<span class="string">"SYN,ACK,FIN,RST,URG,PSH"</span>，第二部分为<span class="string">"SYN"</span>。第一部分表示：我们需要匹配报文tcp头中的哪些标志位，这里指定了六个标志位。第二部分表示：第一部分的标志位列表中，哪些标志位必须为1，这里指定的是SYN标志位必须为1，其他标志位必须为0。也就是tcp三次握手时第一次握手时的情况。</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 44 packets, 3226 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22 flags:0x3F/0x02 reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN -j REJECT</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp -m tcp --sport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN,ACK -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一条命令匹配到的报文是第一次握手的报文，第二条命令匹配到的报文是第二次握手的报文。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp -m tcp --dport 22 --tcp-flags ALL SYN -j REJECT</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp -m tcp --sport 22 --tcp-flags ALL SYN,ACK -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面两条命令可以简写成这样，也就是将六个标志位用ALL代替</span></span><br><span class="line"></span><br><span class="line">* --syn</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp -m tcp --dport 22 --syn -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"--syn"</span>选项匹配第一次握手，这相当于使用<span class="string">"--tcp-flags SYN,RST,ACK,FIN  SYN"</span>，也就是说，可以使用<span class="string">"--syn"</span>选项去匹配tcp新建连接的请求报文。</span></span><br></pre></td></tr></table></figure>
<h4 id="udp扩展"><a href="#udp扩展" class="headerlink" title="udp扩展"></a>udp扩展</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# iptables -I INPUT -p udp -m udp --dport 137 -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p udp -m udp --dport 138 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 放行samba服务的137与138这两个UDP端口</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p udp --dport 137 -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p udp --dport 138 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以省略-m选项</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p udp --dport 137:157 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开放137到157之间的所有udp端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> udp中的--sport与--dport也只能指定连续的端口范围，并不能一次性指定多个离散的端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用multiport扩展模块，即可指定多个离散的UDP端口</span></span><br></pre></td></tr></table></figure>
<h4 id="icmp扩展"><a href="#icmp扩展" class="headerlink" title="icmp扩展"></a>icmp扩展</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ICMP协议的全称为Internet Control Message Protocol，翻译为互联网控制报文协议，它主要用于探测网络上的主机是否可用，目标是否可达，网络是否通畅，路由是否可用等。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们平常使用ping命令ping某主机时，如果主机可达，对应主机会对我们的ping请求做出回应（此处不考虑禁ping等情况），也就是说，我们发出ping请求，对方回应ping请求，虽然ping请求报文与ping回应报文都属于ICMP类型的报文，但是如果在概念上细分的话，它们所属的类型还是不同的，我们发出的ping请求属于类型8的icmp报文，而对方主机的ping回应报文则属于类型0的icmp报文，根据应用场景的不同，icmp报文被细分为如下各种类型。</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/iptables/icmp.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 从上图可以看出，所有表示<span class="string">"目标不可达"</span>的icmp报文的<span class="built_in">type</span>码为3，而<span class="string">"目标不可达"</span>又可以细分为多种情况，是网络不可达呢？还是主机不可达呢？再或者是端口不可达呢？所以，为了更加细化的区分它们，icmp对每种<span class="built_in">type</span>又细分了对应的code，用不同的code对应具体的场景，所以，我们可以使用<span class="built_in">type</span>/code去匹配具体类型的ICMP报文，比如可以使用<span class="string">"3/1"</span>表示主机不可达的icmp报文。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上图中的第一行就表示ping回应报文，它的<span class="built_in">type</span>为0，code也为0，从上图可以看出，ping回应报文属于查询类（query）的ICMP报文，从大类上分，ICMP报文还能分为查询类与错误类两大类，目标不可达类的icmp报文则属于错误类报文。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 而我们发出的ping请求报文对应的<span class="built_in">type</span>为8，code为0。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上例中，我们并没有使用任何扩展匹配条件，我们只是使用<span class="string">"-p icmp"</span>匹配了所有icmp协议类型的报文。如果进行了上述设置，别的主机向我们发送的ping请求报文无法进入防火墙，我们向别人发送的ping请求对应的回应报文也无法进入防火墙。所以，我们既无法ping通别人，别人也无法ping通我们。</span></span><br><span class="line">[root@bogon ~]# iptables -F</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -m icmp --icmp-type 8/0 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 本机可以ping通外部主机，但外部主机不能ping通本机</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"-m icmp"</span>表示使用icmp扩展，因为上例中使用了<span class="string">"-p icmp"</span>，所以<span class="string">"-m icmp"</span>可以省略，使用<span class="string">"--icmp-type"</span>选项表示根据具体的<span class="built_in">type</span>与code去匹配对应的icmp报文，而上图中的<span class="string">"--icmp-type 8/0"</span>表示icmp报文的<span class="built_in">type</span>为8，code为0才会被匹配到，也就是只有ping请求类型的报文才能被匹配到，所以，别人对我们发起的ping请求将会被拒绝通过防火墙，而我们之所以能够ping通别人，是因为别人回应我们的报文的icmp <span class="built_in">type</span>为0，code也为0，所以无法被上述规则匹配到，所以我们可以看到别人回应我们的信息。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -m icmp --icmp-type 8 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为<span class="built_in">type</span>为8的类型下只有一个code为0的类型，所以我们可以省略对应的code</span></span><br><span class="line">[root@test ~]# iptables -I OUTPUT -p icmp --icmp-type 8 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果这样设置，那么我们的主机就无法ping通外部主机了，因为我们ping外部主机发出的是类型8的报文，设置在OUTPUT链上，就无法出去了。我们ping外部主机出去的是类型8进来的是类型0的报文，外部主机ping我们的主机，进来的是类型8出去的是类型0的报文。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -m icmp --icmp-type "echo-request" -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们可以用icmp报文的描述名称去匹配对应类型的报文。使用 --icmp-type <span class="string">"echo-request"</span>与 --icmp-type 8/0的效果完全相同</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 名称中的<span class="string">"空格"</span>需要替换为<span class="string">"-"</span>，如<span class="built_in">echo</span> request要命令中要写为<span class="built_in">echo</span>-request</span></span><br></pre></td></tr></table></figure>
<h4 id="multiport扩展模块"><a href="#multiport扩展模块" class="headerlink" title="multiport扩展模块"></a>multiport扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* 指定不连续端口</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp -m multiport --dports 22,36,80 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 121 packets, 7270 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            multiport dports 22,36,80 reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁止来自249的主机上的tcp报文访问本机的22号端口、36号端口以及80号端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用multiport模块的--sports扩展条件同时指定多个离散的源端口。使用multiport模块的--dports扩展条件同时指定多个离散的目标端口</span></span><br><span class="line"></span><br><span class="line">* 指定连续端口</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp -m multiport --dports 22,80:88 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 47 packets, 3474 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            multiport dports 22,80:88 reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用multiport模块的--sports与--dpors时，也可以指定连续的端口范围，并且能够在指定连续的端口范围的同时，指定离散的端口号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝来自10.5.5.249的tcp报文访问当前主机的22号端口以及80到88之间的所有端口号</span></span><br></pre></td></tr></table></figure>
<h4 id="iprange扩展模块"><a href="#iprange扩展模块" class="headerlink" title="iprange扩展模块"></a>iprange扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用iprange扩展模块可以指定<span class="string">"一段连续的IP地址范围"</span>，用于匹配报文的源地址或者目标地址。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iprange扩展模块中有两个扩展匹配条件可以使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --src-range</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --dst-range</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -m iprange --src-range 10.5.5.240-10.5.5.249 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables --line -nxvL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 208 packets, 11763 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            source IP range 10.5.5.240-10.5.5.249 reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果报文的源IP地址在10.5.5.240到10.5.5.249之间，则丢弃报文，IP段的始末IP使用<span class="string">"横杠"</span>连接，--src-range与--dst-range和其他匹配条件一样，能够使用<span class="string">"!"</span>取反</span></span><br></pre></td></tr></table></figure>
<h4 id="string扩展模块"><a href="#string扩展模块" class="headerlink" title="string扩展模块"></a>string扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用string扩展模块，可以指定要匹配的字符串，如果报文中包含对应的字符串，则符合匹配条件。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> string模块的常用选项</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --algo：用于指定匹配算法，可选的算法有bm与kmp，此选项为必须选项，我们不用纠结于选择哪个算法，但是我们必须指定一个。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --string：用于指定需要匹配的字符串。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面在10.5.5.249上部署</span></span><br><span class="line">[root@test html]# yum install -y httpd</span><br><span class="line">[root@test html]# vim /var/www/html/index.html</span><br><span class="line">	OOXX</span><br><span class="line">[root@test html]# vim /var/www/html/index1.html</span><br><span class="line">	Hello World</span><br><span class="line">[root@test ~]# systemctl start httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面到10.5.5.22主机访问</span></span><br><span class="line">[root@bogon ~]# curl 10.5.5.249</span><br><span class="line">OOXX</span><br><span class="line">[root@bogon ~]# curl 10.5.5.249/index1.html</span><br><span class="line">Hello World</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在249主机上安装httpd，提供两个网页，内容分别为OOXX和Hello World。此时在另一台主机可以正常访问</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -m string --algo bm --string "OOXX" -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果报文中包含<span class="string">"OOXX"</span>字符，我们就拒绝报文进入本机。<span class="string">'-m string'</span>表示使用string模块，<span class="string">'--algo bm'</span>表示使用bm算法去匹配指定的字符串，<span class="string">' --string "OOXX" '</span>则表示我们想要匹配的字符串为<span class="string">"OOXX"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是设置返回的信息中如果有OOXX就拒绝进入本机</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 51 packets, 3603 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  "OOXX" ALGO name bm TO 65535 reject-with icmp-port-unreachable</span><br><span class="line">[root@bogon ~]# curl 10.5.5.249</span><br><span class="line">^C</span><br><span class="line">[root@bogon ~]# curl 10.5.5.249/index1.html</span><br><span class="line">Hello World</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在22主机上设置规则后，因为249主机的默认页中包含“OOXX”，所以访问时会停留在空白处，没有信息返回。如果访问index1.html页面是没有问题的。</span></span><br></pre></td></tr></table></figure>
<h4 id="time扩展模块"><a href="#time扩展模块" class="headerlink" title="time扩展模块"></a>time扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 可以通过time扩展模块，根据时间段匹配报文，如果报文到达的时间在指定的时间范围以内，则符合匹配条件。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --monthdays与--weekdays可以使用<span class="string">"!"</span>取反，其他选项不能取反。</span></span><br><span class="line"></span><br><span class="line">* 指定时间</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --timestart 09:00:00 --timestop 18:00:00 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 443 -m time --timestart 09:00:00 --timestop 18:00:00 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每天早上9点到下午6点不能看网页。<span class="string">"-m time"</span>表示使用time扩展模块，--timestart选项用于指定起始时间，--timestop选项用于指定结束时间。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试时，此条设置完未生效，依然可以访问网页</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL OUTPUT</span><br><span class="line">Chain OUTPUT (policy ACCEPT 37 packets, 3516 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443 TIME from 09:00:00 to 18:00:00 UTC reject-with icmp-port-unreachable</span><br><span class="line">2           0        0 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 TIME from 09:00:00 to 18:00:00 UTC reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">* 按周指定日期</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --weekdays 6,7 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只有周六日不能看网页。使用--weekdays选项可以指定每个星期的具体哪一天，可以同时指定多个，用逗号隔开，除了能够数字表示<span class="string">"星期几"</span>,还能用缩写表示，例如：Mon, Tue, Wed, Thu, Fri, Sat, Sun</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --timestart 09:00:00 --timestop 18:00:00 --weekdays 6,7 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将上面两种方法结合使用。指定只有周六日的早上9点到下午6点不能浏览网页。</span></span><br><span class="line"></span><br><span class="line">* 指月指定日期</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --monthdays 22,23 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用--monthdays选项可以具体指定的每个月的22号，23号不能访问网页。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --weekdays 5 --monthdays 22,23,24,25,26,27,28 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当一条规则中同时存在多个条件时，多个条件之间默认存在<span class="string">"与"</span>的关系。所以，上面的规则表示匹配的时间必须为星期五，并且这个<span class="string">"星期五"</span>同时还需要是每个月的22号到28号之间的一天，也就表示每个月的第4个星期五</span></span><br><span class="line"></span><br><span class="line">* 指定具体时间</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --datestart 2018-10-15 --datestop 2018-10-19 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用--datestart 选项与-datestop选项，指定具体的日期范围。测试中，此条可以生效。</span></span><br></pre></td></tr></table></figure>
<h4 id="connlimit扩展模块"><a href="#connlimit扩展模块" class="headerlink" title="connlimit扩展模块"></a>connlimit扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用connlimit扩展模块，可以限制每个IP地址同时链接到server端的链接数量，注意：我们不用指定IP，其默认就是针对<span class="string">"每个客户端IP"</span>，即对单IP的并发连接数限制。</span></span><br><span class="line"></span><br><span class="line">* --connlimit-above</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 超过两个连接就拒绝。使用<span class="string">"-m connlimit"</span>指定使用connlimit扩展，使用<span class="string">"--connlimit-above 2"</span>表示限制每个IP的链接数量上限为2，再配合-p tcp --dport 22，即表示限制每个客户端IP的ssh并发链接数量不能超过(above)2。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> centos6中，我们可以对--connlimit-above选项进行取反</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -m connlimit ! --connlimit-above 2 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每个客户端IP的ssh链接数量只要不超过两个，则允许链接。但上例的规则并不能表示：每个客户端IP的ssh链接数量超过两个则拒绝链接。因为匹配不到时要匹配默认规则，如果默认规则是ACCEPT，那么依然可以连接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 即使我们配置了上例中的规则，也不能达到<span class="string">"限制"</span>的目的，所以我们通常并不会对此选项取反，因为既然使用了此选项，我们的目的通常就是<span class="string">"限制"</span>连接数量。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> centos7中iptables为我们提供了一个新的选项，--connlimit-upto，这个选项的含义与<span class="string">"! --commlimit-above"</span>的含义相同，即链接数量未达到指定的连接数量之意，所以综上所述，--connlimit-upto选项也不常用。</span></span><br><span class="line"></span><br><span class="line">* --connlimit-mask</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 2 --connlimit-mask 24 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"--connlimit-mask 24"</span>表示某个C类网段。上面规则表示，一个最多包含254个IP的C类网络中，同时最多只能有2个ssh客户端连接到当前服务器</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 10 --connlimit-mask 27 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"--connlimit-mask 27"</span>表示某个C类网段，通过计算后可以得知，这个网段中最多只能有30台机器（30个IP），这30个IP地址最多只能有10个ssh连接同时连接到服务器端</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在不使用--connlimit-mask的情况下，连接数量的限制是针对<span class="string">"每个IP"</span>而言的，当使用了--connlimit-mask选项以后，则可以针对<span class="string">"某类IP段内的一定数量的IP"</span>进行连接数量的限制</span></span><br></pre></td></tr></table></figure>
<h4 id="limit扩展模块"><a href="#limit扩展模块" class="headerlink" title="limit扩展模块"></a>limit扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">limit</span>模块是对<span class="string">"报文到达速率"</span>进行限制的.如果想要限制单位时间内流入的包的数量，就能用<span class="built_in">limit</span>模块</span></span><br><span class="line"></span><br><span class="line">* --limit</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -m limit --limit 10/minute -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"-p icmp"</span>表示我们针对ping请求添加了一条规则（ping使用icmp协议），<span class="string">"-m limit"</span>表示使用<span class="built_in">limit</span>模块， <span class="string">"--limit 10/minute -j ACCEPT"</span>表示每分钟最多放行10个包，就相当于每6秒钟最多放行一个包</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 5950 packets, 5128996 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1         111     9416 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 10/min burst 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的规则并不会起作用。因为每6秒放行一个包，那么iptables就会计时，每6秒一个轮次，到第6秒时，达到的报文就会匹配到对应的规则，执行对应的动作ACCEPT。那么在第6秒之前到达的包，则无法被上述规则匹配到。那么这些包就要向下匹配策略中的其他规则，如果都不能匹配，就会匹配默认策略，因为默认策略是ACCEPT，所以ping此主机的时候还是会正常运行。</span></span><br><span class="line">[root@bogon ~]# iptables -A INPUT -p icmp -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝所有的ping包</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 6 packets, 428 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1         150    12692 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 10/min burst 5</span><br><span class="line">2          56     4704 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一条规则表示每分钟最多放行10个icmp包，也就是6秒放行一个，第6秒的icmp包会被上例中的第一条规则匹配到，第6秒之前的包则不会被第一条规则匹配到，于是被后面的拒绝规则匹配到了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时再ping此主机时就可以发现每6秒才能ping通一次了。但还有一个问题，就是最开始的5个ping包是不受限制的，可以正常ping通。现象如下，下面解释原因</span></span><br><span class="line">[root@test ~]# ping 10.5.5.22</span><br><span class="line">PING 10.5.5.22 (10.5.5.22) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=1 ttl=64 time=0.248 ms</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=2 ttl=64 time=0.355 ms</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=3 ttl=64 time=0.332 ms</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=4 ttl=64 time=0.261 ms</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=5 ttl=64 time=0.528 ms</span><br><span class="line">From 10.5.5.22 icmp_seq=6 Destination Port Unreachable</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=7 ttl=64 time=0.418 ms</span><br><span class="line">From 10.5.5.22 icmp_seq=8 Destination Port Unreachable</span><br><span class="line">From 10.5.5.22 icmp_seq=9 Destination Port Unreachable</span><br><span class="line">From 10.5.5.22 icmp_seq=10 Destination Port Unreachable</span><br><span class="line">From 10.5.5.22 icmp_seq=11 Destination Port Unreachable</span><br><span class="line">From 10.5.5.22 icmp_seq=12 Destination Port Unreachable</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=13 ttl=64 time=0.435 ms</span><br><span class="line">From 10.5.5.22 icmp_seq=14 Destination Port Unreachable</span><br><span class="line">From 10.5.5.22 icmp_seq=15 Destination Port Unreachable</span><br><span class="line"></span><br><span class="line">* --limit-burst</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"--limit-burst"</span>可以指定<span class="string">"空闲时可放行的包的数量。在不使用"</span>--<span class="built_in">limit</span>-burst<span class="string">"选项明确指定放行包的数量时，默认值为5，所以才会有上面的现象。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果想要彻底了解<span class="built_in">limit</span>模块的工作原理，我们需要先了解一下<span class="string">"令牌桶"</span>算法，因为<span class="built_in">limit</span>模块使用了令牌桶算法。我们可以这样想象，有一个木桶，木桶里面放了5块令牌，而且这个木桶最多也只能放下5块令牌，所有报文如果想要出关入关，都必须要持有木桶中的令牌才行，这个木桶有一个神奇的功能，就是每隔6秒钟会生成一块新的令牌，如果此时，木桶中的令牌不足5块，那么新生成的令牌就存放在木桶中，如果木桶中已经存在5块令牌，新生成的令牌就无处安放了，只能溢出木桶（令牌被丢弃），如果此时有5个报文想要入关，那么这5个报文就去木桶里找令牌，正好一人一个，于是他们5个手持令牌，快乐的入关了，此时木桶空了，再有报文想要入关，已经没有对应的令牌可以使用了，但是，过了6秒钟，新的令牌生成了，此刻，正好来了一个报文想要入关，于是，这个报文拿起这个令牌，就入关了，在这个报文之后，如果很长一段时间内没有新的报文想要入关，木桶中的令牌又会慢慢的积攒了起来，直到达到5个令牌，并且一直保持着5个令牌，直到有人需要使用这些令牌，这就是令牌桶算法的大致逻辑。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"--limit"</span>选项就是用于指定<span class="string">"多长时间生成一个新令牌的"</span>，<span class="string">"--limit-burst"</span>选项就是用于指定<span class="string">"木桶中最多存放几个令牌的"</span></span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -m limit --limit-burst 1 --limit 10/minute -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"--limit"</span>选项时，可以选择的时间单位有多种，如：/second、/minute、/hour、/day。比如，3/second表示每秒生成3个<span class="string">"令牌"</span>，30/minute表示每分钟生成30个<span class="string">"令牌"</span>。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 174 packets, 11316 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1          13     1092 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 10/min burst 1</span><br><span class="line">2         194    16296 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>
<h4 id="state扩展模块"><a href="#state扩展模块" class="headerlink" title="state扩展模块"></a>state扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 对于state模块而言的<span class="string">"连接"</span>并不能与tcp的<span class="string">"连接"</span>画等号，在TCP/IP协议簇中，UDP和ICMP是没有所谓的连接的，但是对于state模块来说，tcp报文、udp报文、icmp报文都是有连接状态的。对于state模块而言，只要两台机器在<span class="string">"你来我往"</span>的通信，就算建立起了连接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> state模块中的报文状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NEW：连接中的第一个包，状态就是NEW，我们可以理解为新连接的第一个包的状态为NEW。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ESTABLISHED：我们可以把NEW状态包后面的包的状态理解为ESTABLISHED，表示连接已建立。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RELATED：从字面上理解RELATED译为关系、相关的，但是这样仍然不容易理解，我们举个例子。比如FTP服务，FTP服务端会建立两个进程，一个命令进程，一个数据进程。命令进程负责服务端与客户端之间的命令传输（我们可以把这个传输过程理解成state中所谓的一个<span class="string">"连接"</span>，暂称为<span class="string">"命令连接"</span>）。数据进程负责服务端与客户端之间的数据传输 ( 我们把这个过程暂称为<span class="string">"数据连接"</span> )。但是具体传输哪些数据，是由命令去控制的，所以，<span class="string">"数据连接"</span>中的报文与<span class="string">"命令连接"</span>是有<span class="string">"关系"</span>的。那么，<span class="string">"数据连接"</span>中的报文可能就是RELATED状态，因为这些报文与<span class="string">"命令连接"</span>中的报文有关系。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># (注：如果想要对ftp进行连接追踪，需要单独加载对应的内核模块nf_conntrack_ftp，如果想要自动加载，可以配置/etc/sysconfig/iptables-config文件)</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> INVALID：如果一个包没有办法被识别，或者这个包没有任何状态，那么这个包的状态就是INVALID，我们可以主动屏蔽状态为INVALID的报文。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> UNTRACKED：报文的状态为UNTRACKED时，表示报文未被追踪，当报文的状态为UNTRACKED时通常表示无法找到相关的连接。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -A INPUT -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将状态为RELATED和ESTABLISHED的报文都放行，这样，就表示只有回应我们的报文能够通过防火墙，如果是别人主动发送过来的新的报文，则无法通过防火墙。如想通过ssh连接本机，是不行的，但本机可以ssh连接其他主机。</span></span><br></pre></td></tr></table></figure>
<h3 id="黑白名单机制"><a href="#黑白名单机制" class="headerlink" title="黑白名单机制"></a>黑白名单机制</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当链的默认策略为ACCEPT时，链中的规则对应的动作应该为DROP或者REJECT，表示只有匹配到规则的报文才会被拒绝，没有被规则匹配到的报文都会被默认接受，这就是<span class="string">"黑名单"</span>机制。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当链的默认策略为DROP时，链中的规则对应的动作应该为ACCEPT，表示只有匹配到规则的报文才会被放行，没有被规则匹配到的报文都会被默认拒绝，这就是<span class="string">"白名单"</span>机制。</span></span><br><span class="line"></span><br><span class="line">* 白名单</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -P INPUT DROP</span><br><span class="line">[root@bogon ~]# iptables --line -nxvL INPUT</span><br><span class="line">Chain INPUT (policy DROP 336 packets, 17902 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line">2         130     9172 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 放行22与80端口，并将默认策略改为DROP，这样其他端口都是无法访问的。因为只改了INPUT链为DROP，OUTPUT链的默认策略还是ACCEPT，所以可以访问80与22端口。如果OUTPUT的默认策略也是DROP，那就要再写两条出的规则。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果此时有误操作，删除了防火墙规则，那么所有连接就都无法进来了。也就是无法通过远程连接主机了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果想要使用<span class="string">"白名单"</span>的机制，最好将链的默认策略保持为<span class="string">"ACCEPT"</span>，然后将<span class="string">"拒绝所有请求"</span>这条规则放在链的尾部，将<span class="string">"放行规则"</span>放在前面，这样做，既能实现<span class="string">"白名单"</span>机制，又能保证在规则被清空时，管理员还有机会连接到主机</span></span><br><span class="line">[root@bogon ~]# iptables -P INPUT ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -A INPUT -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当所有放行规则设置完成后，在INPUT链的尾部，设置一条拒绝所有请求的规则。这样就能必免上面的问题了</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/12/iptables基本操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/12/iptables基本操作/" itemprop="url">
                  iptables基本操作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-12 14:03:43" itemprop="dateCreated datePublished" datetime="2018-10-12T14:03:43+08:00">2018-10-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 10:29:53" itemprop="dateModified" datetime="2019-01-15T10:29:53+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# iptables -t filter -L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">OUTPUT_direct  all  --  anywhere             anywhere</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出filter表的所有规则</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 报文发往本机时，会经过PREROUTING链与INPUT链。所以，如果我们想要禁止某些报文发往本机，我们只能在PREROUTING链和INPUT链中定义规则，但是PREROUTING链并不存在于filter表中，因为PREROUTING链没有过滤功能，所以，只能在INPUT链上定义</span></span><br><span class="line"></span><br><span class="line">root@bogon ~]# iptables -L INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED</span><br><span class="line"><span class="meta">#</span><span class="bash">只查看指定表中的指定链规则。可以省略-t filter，当没有使用-t选项指定表时，默认为操作filter表</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -vL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"> 1894  144K ACCEPT     all  --  any    any     anywhere             anywhere             ctstate RELATED,ESTABLISHED</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-v选项可以显示更多信息。字段含义如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pkts:对应规则匹配到的报文的个数。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bytes:对应匹配到的报文包的大小总和。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target:规则对应的target（目标），往往表示规则对应的<span class="string">"动作"</span>，即规则匹配成功后需要采取的措施。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> prot:表示规则对应的协议，是否只针对某些协议应用此规则。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> opt:表示规则对应的选项。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span>:表示数据包由哪个接口(网卡)流入，我们可以设置通过哪块网卡流入的报文需要匹配当前规则。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> out:表示数据包由哪个接口(网卡)流出，我们可以设置通过哪块网卡流出的报文需要匹配当前规则。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span>:表示规则对应的源头地址，可以是一个IP，也可以是一个网段。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> destination:表示规则对应的目标地址。可以是一个IP，也可以是一个网段。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span>与destination为anywhere是因为做了名称解析</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -nvL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"> 1918  146K ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在规则非常多的情况下如果进行名称解析，效率会比较低。可以使用-n选项，表示不对IP地址进行名称反解，直接显示IP地址</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables --line-number -nvL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">1     1971  150K ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用--line-numbers即可显示规则的编号。--line-numbers选项并没有对应的短选项，不过我们缩写成--line</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Chain INPUT (policy ACCEPT 0 packets, 0 bytes)的含义如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> policy表示当前链的默认策略，policy ACCEPT表示INPUT的链的默认动作为ACCEPT，默认接受通过INPUT关卡的所有请求</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> packets表示当前链（上例为INPUT链）默认策略匹配到的包的数量，0 packets表示默认策略匹配到0个包。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bytes表示当前链默认策略匹配到的所有包的大小总和。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables --line -xnvL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 5557 packets, 332K bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1        2012   153468 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其实，我们可以把packets与bytes称作<span class="string">"计数器"</span>，上例中的计数器记录了默认策略匹配到的报文数量与总大小，<span class="string">"计数器"</span>只会在使用-v选项时，才会显示出来。当被匹配到的包达到一定数量时，计数器会自动将匹配到的包的大小转换为可读性较高的单位。如果你想要查看精确的计数值，而不是经过可读性优化过的计数值，那么你可以使用-x选项，表示显示精确的计数值</span></span><br></pre></td></tr></table></figure>
<h4 id="添加规则"><a href="#添加规则" class="headerlink" title="添加规则"></a>添加规则</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">* 拒绝某地址访问</span><br><span class="line">[root@bogon ~]# iptables -t filter -I INPUT -s 10.5.5.249 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝10.5.5.249访问本机，这时249主机不能ping通本机</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -I表示将规则插入到每一条，-s指定源地址，-j指定动作。在iptables中，动作被称之为<span class="string">"target"</span></span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 519 packets, 33559 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1         193    16212 DROP       all  --  *      *       10.5.5.249           0.0.0.0/0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 有193个包被对应的规则匹配到，总计大小16212bytes。</span></span><br><span class="line">[root@bogon ~]# iptables -A INPUT -s 10.5.5.249 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> -A为append之意，表示追加一条规则到末尾</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 86 packets, 6164 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1         598    50232 DROP       all  --  *      *       10.5.5.249           0.0.0.0/0           </span><br><span class="line">2           0        0 ACCEPT     all  --  *      *       10.5.5.249           0.0.0.0/0 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 追加规则后发现追加的规则并未匹配到，因为数据是按规则序列从上向下匹配的，第一条规则已经拒绝了所有请求，所以后面的规则也不会匹配到了。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT 3 -s 10.5.5.249 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定将规则插入到INPUT链的第三条</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 51 packets, 3610 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1         941    79044 DROP       all  --  *      *       10.5.5.249           0.0.0.0/0           </span><br><span class="line">2           0        0 ACCEPT     all  --  *      *       10.5.5.249           0.0.0.0/0           </span><br><span class="line">3           0        0 DROP       all  --  *      *       10.5.5.249           0.0.0.0/0</span><br></pre></td></tr></table></figure>
<h4 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# iptables -D INPUT 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除INPUT链中的第三条规则</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 6 packets, 466 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1        1040    87360 DROP       all  --  *      *       10.5.5.249           0.0.0.0/0           </span><br><span class="line">2           0        0 ACCEPT     all  --  *      *       10.5.5.249           0.0.0.0/0</span><br><span class="line">[root@bogon ~]# iptables -D INPUT -s 10.5.5.249 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据匹配条件删除规则，这里要删除的是源地址是10.5.5.249，动作是ACCEPT的规则</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 6 packets, 428 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1        1128    94752 DROP       all  --  *      *       10.5.5.249           0.0.0.0/0</span><br><span class="line">[root@bogon ~]# iptables -t filter -F</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除filter表中的所有规则</span></span><br></pre></td></tr></table></figure>
<h4 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# iptables -R INPUT 1 -s 10.5.5.249 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> -R选项表示修改指定的链，使用-R INPUT 1表示修改INPUT链的第1条规则，使用-j REJECT表示将INPUT链中的第一条规则的动作修改为REJECT，注意：上例中， -s选项以及对应的源地址不可省略。在使用-R选项修改某个规则时，必须指定规则对应的原本的匹配条件。如果上例中的命令没有使用-s指定对应规则中原本的源地址，那么在修改完成后，你修改的规则中的源地址会自动变为0.0.0.0/0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果你想要修改某条规则，还不如先将这条规则删除，然后在同样位置再插入一条新规则</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 9 packets, 662 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           2      168 REJECT     all  --  *      *       10.5.5.249           0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">* 修改默认策略</span><br><span class="line">[root@bogon ~]# iptables -P FORWARD DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-P选项修改默认策略，修改filter表中的FORWARD链的默认策略为DROP</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL FORWARD</span><br><span class="line">Chain FORWARD (policy DROP 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到policy后面是DROP了</span></span><br></pre></td></tr></table></figure>
<h4 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* CentOS6</span><br><span class="line">[root@bogon ~]# service iptables save</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使修改的规则永久生效</span></span><br><span class="line">[root@bogon ~]# cat /etc/sysconfig/iptables</span><br><span class="line"><span class="meta">#</span><span class="bash"> 规则保存在/etc/sysconfig/iptables中</span></span><br><span class="line"></span><br><span class="line">* CentOS7</span><br><span class="line">[root@test ~]# yum install -y iptables-services</span><br><span class="line">[root@bogon ~]# systemctl start iptables</span><br><span class="line">[root@bogon ~]# systemctl enable iptables</span><br><span class="line">[root@bogon ~]# service iptables save</span><br><span class="line">iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 要安装iptables-services后才能使用service命令保存规则</span></span><br><span class="line"></span><br><span class="line">* 其他保存方法</span><br><span class="line">[root@bogon ~]# iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line">* 重新加载规则</span><br><span class="line">[root@bogon ~]# iptables-restore &lt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/12/jdyc环境简单部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/12/jdyc环境简单部署/" itemprop="url">
                  jdyc环境简单部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-12 10:23:41" itemprop="dateCreated datePublished" datetime="2018-10-12T10:23:41+08:00">2018-10-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-07 16:55:56" itemprop="dateModified" datetime="2018-11-07T16:55:56+08:00">2018-11-07</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/jdbc/" itemprop="url" rel="index"><span itemprop="name">jdbc</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="web、netty、wechat、processor"><a href="#web、netty、wechat、processor" class="headerlink" title="web、netty、wechat、processor"></a>web、netty、wechat、processor</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">* 安装环境</span><br><span class="line">yum install -y java-1.8.0-openjdk-devel</span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">	export JAVA_HOME=/usr</span><br><span class="line">tar xf apache-tomcat-8.5.33.tar.gz -C /usr/local</span><br><span class="line">cd /usr/local</span><br><span class="line">ln -sv apache-tomcat-8.5.33 tomcat</span><br><span class="line">* 部署</span><br><span class="line">** web</span><br><span class="line">vim /usr/local/tomcat/conf/server.xml</span><br><span class="line">	&lt;Host name="localhost"  appBase="webapps"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line">	&lt;Context path="" docBase="echarge" reloadable="true" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash">修改tomcat的启动端口，加入Context</span></span><br><span class="line"></span><br><span class="line">** wechat</span><br><span class="line">	&lt;Host name="localhost"  appBase="webapps"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line">    &lt;Context path="" docBase="rest-app" debug="0" reloadable="true"/&gt;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span><span class="bash">netty与processor不必调整tomcat设置，将相关包放入tomcat中的webapps中</span></span><br><span class="line">* 启动</span><br><span class="line">/usr/local/tomcat/bin/startup.sh</span><br><span class="line">tail -f /usr/local/tomcat/logs/catalina.out</span><br><span class="line"><span class="meta">#</span><span class="bash">查看启动日志</span></span><br></pre></td></tr></table></figure>
<h1 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mariadb</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">	[client]</span><br><span class="line">    default-character-set = utf8mb4</span><br><span class="line">    [mysql]</span><br><span class="line">    default-character-set = utf8mb4</span><br><span class="line">    #字符集要加上，不然使用中会有字符不能正常显示</span><br><span class="line">    socket=/var/lib/mysql/mysql.sock</span><br><span class="line">    [mysqld]</span><br><span class="line">    datadir=/var/lib/mysql</span><br><span class="line">    socket=/var/lib/mysql/mysql.sock</span><br><span class="line">    symbolic-links=0</span><br><span class="line"></span><br><span class="line">    character-set-server = utf8mb4</span><br><span class="line">    collation-server = utf8mb4_unicode_ci</span><br><span class="line">    wait_timeout=10</span><br><span class="line">    sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span><br><span class="line"></span><br><span class="line">    innodb_file_per_table=ON</span><br><span class="line">    skip_name_resolve=ON</span><br><span class="line"></span><br><span class="line">    server_id=1</span><br><span class="line">    log-bin=master-log</span><br><span class="line">    relay_log=relay-log</span><br><span class="line"></span><br><span class="line">    auto_increment_offset=1</span><br><span class="line">    auto_increment_increment=2</span><br><span class="line"><span class="meta">	#</span><span class="bash">这是为了做主主复制的配置</span></span><br><span class="line">    [mysqld_safe]</span><br><span class="line">    log-error=/var/log/mysqld.log</span><br><span class="line">mysql_secure_installation</span><br><span class="line"><span class="meta">#</span><span class="bash">设置用户名和密码</span></span><br><span class="line">mysql</span><br><span class="line">GRANT ALL ON *.* TO 'echarge'@'%' IDENTIFIED BY 'centos';</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<h1 id="zk-amp-kafka"><a href="#zk-amp-kafka" class="headerlink" title="zk&amp;kafka"></a>zk&amp;kafka</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> zookeeper环境依赖JVM虚拟机</span></span><br><span class="line">yum install -y java-1.8.0-openjdk-devel</span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">	export JAVA_HOME=/usr</span><br><span class="line">	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要准备三台主机，在三台主机上做相同的操作</span></span><br><span class="line">* zookeeper</span><br><span class="line">tar -xf zookeeper-3.4.9.tar.gz -C /usr/local</span><br><span class="line">cd /usr/local</span><br><span class="line">ln -sv zookeeper-3.4.9 zookeeper</span><br><span class="line">mkdir -pv /data/zookeeper</span><br><span class="line">cd /usr/local/zookeeper/conf</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vim zoo.cfg</span><br><span class="line">    tickTime=2000</span><br><span class="line">    initLimit=10</span><br><span class="line">    syncLimit=5</span><br><span class="line">    dataDir=/data/zookeeper</span><br><span class="line">    clientPort=2181</span><br><span class="line">    server.1=10.5.5.19:2888:3888</span><br><span class="line">    server.2=10.5.5.7:2888:3888</span><br><span class="line">    server.3=10.5.5.2:2888:3888</span><br><span class="line">scp zoo.cfg node2:/usr/local/zookeeper</span><br><span class="line">scp zoo.cfg node3:/usr/local/zookeeper</span><br><span class="line">cd /data/zookeeper</span><br><span class="line">echo 1 &gt; myid</span><br><span class="line">//给zookeeper一个ID号，这个ID号与配置文件中的server.ID要一致。另两个节点要改为2和3。</span><br><span class="line">cd /usr/local/zookeeper</span><br><span class="line">bin/zkServer.sh start</span><br><span class="line">//启动</span><br><span class="line">bin/zkServer.sh status</span><br><span class="line">//查看状态，如果是主节点，就显示leader，否则显示follower</span><br><span class="line">./bin/zkCli.sh -server 10.5.5.2:2181</span><br><span class="line">//连接到其他服务器上的zookeeper</span><br><span class="line"></span><br><span class="line">* kafka</span><br><span class="line">tar xf kafka_2.10-0.10.0.1.tgz -C /usr/local</span><br><span class="line">cd /usr/local</span><br><span class="line">ln -sv kafka_2.10-0.10.0.1 kafka</span><br><span class="line">cd kafka</span><br><span class="line">vim config/server.properties</span><br><span class="line">    broker.id=0</span><br><span class="line">    //三个节点的broker.id要不一样，不然另两个节点不能启动kafka</span><br><span class="line">    port=9092</span><br><span class="line">    host.name=10.5.5.2</span><br><span class="line">    #本机的地址</span><br><span class="line">    num.network.threads=3</span><br><span class="line">    num.io.threads=8</span><br><span class="line">    socket.send.buffer.bytes=102400</span><br><span class="line">    socket.receive.buffer.bytes=102400</span><br><span class="line">    socket.request.max.bytes=104857600</span><br><span class="line">    log.dirs=/tmp/kafka-logs</span><br><span class="line">    num.partitions=3</span><br><span class="line">    num.recovery.threads.per.data.dir=3</span><br><span class="line">    log.retention.hours=168</span><br><span class="line">    log.segment.bytes=1073741824</span><br><span class="line">    log.retention.check.interval.ms=300000</span><br><span class="line">    zookeeper.connect=10.5.5.19:2181,10.5.5.7:2181,10.5.5.2:2181</span><br><span class="line">    zookeeper.connection.timeout.ms=6000</span><br><span class="line">bin/kafka-server-start.sh config/server.properties</span><br><span class="line">//启动</span><br><span class="line"></span><br><span class="line">* 创建主题</span><br><span class="line">bin/kafka-topics.sh --create --zookeeper 10.5.5.232:2181 --replication-factor 3 --partitions 22 --topic inboundMsg</span><br><span class="line">bin/kafka-topics.sh --create --zookeeper 10.5.5.232:2181 --replication-factor 3 --partitions 22 --topic outboundMsg</span><br><span class="line"><span class="meta">#</span><span class="bash">创建3个副本，22个分区</span></span><br><span class="line"></span><br><span class="line">* 测试</span><br><span class="line">bin/kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --broker-info --group inbound --topic inboundMsg --zookeeper 192.168.2.182:2181</span><br><span class="line"><span class="meta">#</span><span class="bash">结果中的Lag是待消费的数量</span></span><br><span class="line">watch '/usr/local/kafka/bin/kafka-consumer-groups.sh --new-consumer --bootstrap-server 192.168.2.182:9092 --group inbound --describe'</span><br><span class="line"><span class="meta">#</span><span class="bash">如果是多个分区，用此命令</span></span><br><span class="line">bin/kafka-topics.sh --describe --zookeeper 10.5.5.2:2181</span><br><span class="line"><span class="meta">#</span><span class="bash">查看Topic；--zookeeper 为zk集群地址，使用任意一个节点都行</span></span><br><span class="line">bin/kafka-topics.sh --list --zookeeper 10.5.5.7:2181</span><br><span class="line"><span class="meta">#</span><span class="bash">查看Topic 列表</span></span><br><span class="line">bin/kafka-console-producer.sh --broker-list 10.5.5.2:9092,10.5.5.7:9092,10.5.5.19:9092 --topic my-test</span><br><span class="line"><span class="meta">#</span><span class="bash">在一个节点上创建生产者，在任意节点执行均可，之后输入一些内容</span></span><br><span class="line">    abadfasdfas</span><br><span class="line">bin/kafka-console-consumer.sh --bootstrap-server 10.5.5.2:9092,10.5.5.7:9092,10.5.5.19:9092 --from-beginning --topic my-test</span><br><span class="line"><span class="meta">#</span><span class="bash">在另两个节点，创建消费者。--broker-server broker 节点列表，类似于上面的 --broker-list；即三台服务器节点列表，实际上写成其中一个、两个或者三个均可，中间逗号隔开；--from-beginning 表明从头获取，而不是从接入时间获取之后的消息</span></span><br></pre></td></tr></table></figure>
<h1 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">准备三台主机</span></span><br><span class="line">* 安装</span><br><span class="line">yum install -y redis</span><br><span class="line"></span><br><span class="line">* 配置</span><br><span class="line">vim /etc/sudoers</span><br><span class="line">    #Defaults requiretty</span><br><span class="line"><span class="meta">#</span><span class="bash">注释上面一行</span></span><br><span class="line">vim /etc/sudoers.d/redis</span><br><span class="line">    redis ALL=(ALL) NOPASSWD:/sbin/ip,NOPASSWD:/sbin/arping</span><br><span class="line"><span class="meta">#</span><span class="bash">这是为了让redis用户使用sudo命令时不用密码也可执行ip和arping命令。因为redis-sentinel进程是以redis身份运行的，所以执行脚本时也是redis用户，但redis用户是不能设置本机地址的，所以要给它权限。</span></span><br><span class="line">vim /opt/notify_mymaster.sh</span><br><span class="line">    #!/bin/bash</span><br><span class="line">    #</span><br><span class="line">    MASTER_IP=$&#123;6&#125;</span><br><span class="line">    LOCAL_IP='192.168.2.65'</span><br><span class="line">    VIP='192.168.2.183'</span><br><span class="line">    NETMASK='24'</span><br><span class="line">    INTERFACE='ens160'</span><br><span class="line">    if [ $&#123;MASTER_IP&#125; = $&#123;LOCAL_IP&#125; ];then</span><br><span class="line">        sudo /usr/sbin/ip addr add $&#123;VIP&#125;/$&#123;NETMASK&#125; dev $&#123;INTERFACE&#125;</span><br><span class="line">        sudo /usr/sbin/arping -q -c 3 -A $&#123;VIP&#125; -I $&#123;INTERFACE&#125;</span><br><span class="line">        exit 0</span><br><span class="line">    else</span><br><span class="line">       sudo /usr/sbin/ip addr del $&#123;VIP&#125;/$&#123;NETMASK&#125; dev $&#123;INTERFACE&#125;</span><br><span class="line">       exit 0</span><br><span class="line">    fi</span><br><span class="line">    exit 1</span><br><span class="line">chmod +x /opt/notify_mymaster.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> /sbin是/usr/sbin的软链接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为如果没有脚本或脚本没有执行权限，redis-sentinel服务就不能启动，所以提前设置。</span></span><br><span class="line"></span><br><span class="line">* redis1</span><br><span class="line">vim /etc/redis.conf</span><br><span class="line">    bind 0.0.0.0</span><br><span class="line">    #监听所有地址</span><br><span class="line">systemctl start redis</span><br><span class="line">redis-cli</span><br><span class="line">    CONFIG SET requirepass redisqwer1234</span><br><span class="line">    AUTH redisqwer1234</span><br><span class="line">    CONFIG GET requirepass</span><br><span class="line">    CONFIG SET masterauth redisqwer1234</span><br><span class="line">    CONFIG REWRITE</span><br><span class="line"><span class="meta">#</span><span class="bash">设置并查看认证密码</span></span><br><span class="line"></span><br><span class="line">* redis2&amp;3</span><br><span class="line">vim /etc/redis.conf</span><br><span class="line">    bind 0.0.0.0</span><br><span class="line">systemctl start redis</span><br><span class="line">redis-cli</span><br><span class="line">    SLAVEOF 192.168.2.65 6379</span><br><span class="line">    #指明主节点地址与端口</span><br><span class="line">    CONFIG SET masterauth redisqwer1234</span><br><span class="line">    #设置主节点的认证信息</span><br><span class="line">    CONFIG SET requirepass redisqwer1234</span><br><span class="line">    CONFIG REWRITE</span><br><span class="line"><span class="meta">#</span><span class="bash">这里的三个节点都应该设置masterauth和requirepass的值，requirepass的值是自己作为主节点时，别人请求要用的认证密码。masterauth是与主节点通信时要用到的认证密码。也就是说，masterauth指向的密码就是requirepass设置的密码。因为三个节点都可以做主节点，所以都要设置。如果只设置一个，那么在主节点查看从节点信息时，有可能只显示一个。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">可在从节点查看/var/<span class="built_in">log</span>/redis/redis.conf日志，日志中会显示不能加入集群的信息</span></span><br><span class="line"></span><br><span class="line">* redis1</span><br><span class="line">INFO replication</span><br><span class="line"><span class="meta">#</span><span class="bash">查看状态信息，有slave0的信息，也就是从节点的信息。如：</span></span><br><span class="line">    slave0:ip=192.168.2.62,port=6379,state=online,offset=212225,lag=1</span><br><span class="line">    slave1:ip=192.168.2.65,port=6379,state=online,offset=212225,lag=1</span><br><span class="line"></span><br><span class="line">* redis2&amp;3</span><br><span class="line">redis-cli</span><br><span class="line">    CONFIG SET requirepass redisqwer1234</span><br><span class="line">    AUTH redisqwer1234</span><br><span class="line">    CONFIG REWRITE</span><br><span class="line"><span class="meta">#</span><span class="bash">设置两个节点的认证信息与主节点一样，这是为了在从节点提升为主节点时的准备</span></span><br><span class="line"></span><br><span class="line">* redis1</span><br><span class="line">vim /etc/redis-sentinel.conf</span><br><span class="line">    port 26379</span><br><span class="line">    bind 0.0.0.0</span><br><span class="line">    #这一项一定要加上，不然不能通过认证</span><br><span class="line">    sentinel monitor mymaster 10.5.5.235 6379 2</span><br><span class="line">    #sentinel监听主节点的地址和端口，2表示至少有几个sentinel进行选举才能通过</span><br><span class="line">	sentinel auth-pass mymaster ccjd.redis.com</span><br><span class="line"><span class="meta">	#</span><span class="bash">认证mymaster的主节点的密码，建议用随机字符串。如果不写此项就无法用sentinel slaves mymaster命令查看到从节点的信息</span></span><br><span class="line">	sentinel down-after-milliseconds mymaster 5000</span><br><span class="line"><span class="meta">	#</span><span class="bash">多久连接不到主节点就认为它宕机了，这是主观宕机。这里定义是30秒，可改为5000</span></span><br><span class="line">	sentinel parallel-syncs mymaster 1</span><br><span class="line"><span class="meta">	#</span><span class="bash">一次只给几个从节点同步。并行同步的数量</span></span><br><span class="line">	sentinel failover-timeout mymaster 60000</span><br><span class="line"><span class="meta">	#</span><span class="bash">故障转移多久完成不了，就进行新的转移。这个时间不要太短。这里是3分钟</span></span><br><span class="line">	sentinel client-reconfig-script mymaster   /opt/notify_mymaster.sh</span><br><span class="line"><span class="meta">	#</span><span class="bash">故障转移时执行notify_mymaster.sh脚本。加入这一行，sentinel的client-reconfig-script在每次执行时会传递出7个参数，第6个就是主redis的地址</span></span><br><span class="line">scp /etc/redis-sentinel.conf redis2:/etc</span><br><span class="line">scp /etc/redis-sentinel.conf redis3:/etc</span><br><span class="line">systemctl start redis-sentinel</span><br><span class="line">ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash">监听26379端口</span></span><br><span class="line">tail -f /var/log/redis/sentinel.log</span><br><span class="line"></span><br><span class="line">* redis2&amp;3</span><br><span class="line">systemctl start redis-sentinel</span><br><span class="line"></span><br><span class="line">* redis1</span><br><span class="line">redis-cli -h 10.5.5.21 -p 26379</span><br><span class="line">	SENTINEL master mymaster    </span><br><span class="line"><span class="meta">	#</span><span class="bash">查看主节点状态</span></span><br><span class="line">	SENTINEL slaves mymaster	</span><br><span class="line"><span class="meta">	#</span><span class="bash">查看从节点状态</span></span><br><span class="line">	SENTINEL failover mymaster	</span><br><span class="line"><span class="meta">	#</span><span class="bash">切换主节点</span></span><br><span class="line">	SENTINEL master mymaster</span><br><span class="line">	SENTINEL failover mymaster</span><br><span class="line"><span class="meta">	#</span><span class="bash">当再次切换时就很慢，停掉主节点的服务后还要等一会。可能与设置中的failover-timeout的时间是3分钟有关。</span></span><br><span class="line">	SENTINEL get-master-addr-by-name mymaster</span><br><span class="line"><span class="meta">	#</span><span class="bash">获得现在名称为mymaster主redis的IP和端口</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/08/LVM逻辑卷/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/08/LVM逻辑卷/" itemprop="url">
                  LVM逻辑卷
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-08 09:29:42" itemprop="dateCreated datePublished" datetime="2018-10-08T09:29:42+08:00">2018-10-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-02 12:33:48" itemprop="dateModified" datetime="2019-02-02T12:33:48+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><ul>
<li><p>MD：在內核中它的所有調配工作由md這個模塊來完成，進而能實現將多個物理設備組合成一個邏輯設備或叫元設備（meta device）。主要用來實現軟RAID： /dev/md#</p>
</li>
<li><p>DM：Device Mapper 設備映射；這種機制也能夠提供將多個物理設備映射成一個邏輯設備，功能比MD強大；由多個子模塊組成，完成多種不同的組織方式。</p>
<p>​              可提供軟RAID，LVM2功能</p>
</li>
<li><p>快照功能：保留數據在你做快照那一刻的狀態，快照一般小於原數據，它只是訪問同一個數據的另一條路徑，與文件軟鏈接相似，默認訪問只有一個路徑，快照是另一條路徑，又不僅限於路徑，它也可以作爲用戶去訪問對應磁盤上它所映射文件的通路。將快照那一刻的狀態保留下來作爲文件的訪問通道，被快照的文件被修改時，先保存一份快照，訪問時看數據是否改變，如果改變就訪問快照裏的數據，沒改變就訪問原數據，所以快照文件很小。快照裏只有一些改變的數據。主要是用來做數據備份的</p>
<p>​       多路徑功能：讓我們實現數據存儲設備的尋路，能通過多种不同的線來完成</p>
<p><img src="/images/LVM/快照1.jpeg"></p>
<blockquote>
<p>左圖為最初的 LV 磁盘快照區的狀況，LVM 會預留一個區域 (左圖的左側三個 PE 區塊) 作為資料存放處。 此時快照區內並沒有任何資料，而快照區與系統區共享所有的 PE 資料， 因此你會看到快照區的內容與檔案系統是一模一樣的。 等到系統運作一陣子後，假設 A 區域的資料被变動了 (上面右圖所示)，則变動前系統會將該區域的資料移動到快照區， 所以在右圖的快照區被佔用了一塊 PE 成為 A，而其他 B 到 I 的區塊則還是與檔案系統共用</p>
</blockquote>
</li>
<li><p>LVM 的全名是 Logical Volume Manager，中文可以翻译作逻辑卷轴管理员。LVM 的作用是将几个实体磁盘 通过软件组合成为一块看起来是独立的大磁盘(VG) ，然后将这块大磁盘再经过分割，成为可使用的分割槽 (LV)， 最终就能够挂载使用了。这样的系统可以进行文件通讯员的扩充或缩小与一个称为 PE 的项目有关。 LVM的作用：邏輯設備動態增減</p>
</li>
<li><p>PV：Physical Volume，实体卷轴。磁盘需要调整系统识别码为8e，然后经过pvcreate命令转为LVM最底层的实体卷轴（PV）</p>
</li>
<li><p>VG：Volume Group，卷轴组。LVM的大磁盘就是将许多PV整合成一个VG。每个VG最多仅能包含65534个PE，如果使用LVM的默认参数，则一个VG最大可达256GB容量。</p>
</li>
<li><p>PE：Physical Extend，实体延伸区块。LVM默认使用4MB的PE区块，而LVM的VG最多可以含有65534个PE，因此默认的VG容量是256GB。这个PE是整个LVM最小的储存区块，我们的文件资料都是由写入PE来处理的。调整PE的大小会影响到VG的最大容量。</p>
</li>
<li><p>LV：Logical Volume，逻辑卷轴。VG最终会被切成LV，这个LV就是最后可以被格式化使用的分区。LV的名称通常为/dev/vgname/lvname。LVM的文件系统容量变更是通过交换PE来进行文件转换的，将原来LV内的PE转移到其他装置中就可以降低LV容量，或将其他装置的PE加到此LV中就可以加大容量。</p>
</li>
<li><p>操作流程</p>
</li>
</ul>
<p><img src="/images/LVM/操作流程.gif"></p>
<ul>
<li><p>线性模式 (linear)：假如我将 /dev/hda1, /dev/hdb1 这两个 partition 加入到 VG 当中，并且整个 VG 只有一个 LV 时，那么所谓的线性模式就是：当 /dev/hda1 的容量用完之后，/dev/hdb1 的硬碟才会被使用到， 这也是我们所建议的模式。</p>
</li>
<li><p>交错模式 (triped)：那什么是交错模式？很简单啊，就是我将一笔资料拆成两部分，分别写入 /dev/hda1 与 /dev/hdb1 的意思，感觉上有点像 RAID 0 啦！如此一来，一份资料用两颗硬碟来写入，理论上，读写的效能会比较好。</p>
<p>基本上，LVM 最主要的用处是在实现一个可以弹性调整容量的文件系统上， 而不是在建立一个效能为主的磁盘上，所以，我们应该利用的是 LVM 可以弹性管理整个 partition 大小的用途上，而不是着眼在效能上的。因此， LVM 预设的读写模式是线性模式。 如果你使用 triped 模式，要注意，当任何一个 partition 损坏时，所有的资料都会‘损毁’的。</p>
</li>
<li><p>在增減邏輯卷大小的時候要用到物理邊界，邏輯邊界的概念，物理邊界指磁盤的大小，邏輯邊界指文件系統的大小。創建分區的過程就是創建物理邊界的過程，在物理邊界內部創建文件系統，文件存儲在文件系統上，文件系統邊界叫邏輯邊界，存多少數據取決於物理邊界大小與邏輯邊界大小，邏輯邊界是緊靠在物理邊界大小上創建的。所以擴展時要先擴展物理邊界，然後再擴展邏輯邊界，如果縮減就相反，先縮減文件系統邊界，再縮減物理邊界。</p>
</li>
<li><p>對卷創建快照指給邏輯卷創建快照，但快照卷必須與邏輯卷在同一個卷組中</p>
</li>
</ul>
<h1 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">* pv</span><br><span class="line">pvcreate：#将实体 partition 建立成为 PV </span><br><span class="line">pvremove：#将 PV 属性移除，让该 partition 不具有 PV 属性。刪除PV中的原數據</span><br><span class="line">pvscan：#搜寻目前系统里面任何具有 PV 的磁碟</span><br><span class="line">pvdisplay：#显示出目前系统上面的 PV 状态</span><br><span class="line">pvmove：#移動PV中的數據到其他PV上，就可以拆掉這個磁盤了。</span><br><span class="line"></span><br><span class="line">* vg</span><br><span class="line">vgcreate：#创建VG</span><br><span class="line">	vgcreate [-s N[mgt]] VG名称 PV名称选项与参数：</span><br><span class="line"><span class="meta">	#</span><span class="bash">-s ：后面接 PE 的大小 (size) ，单位可以是 m, g, t (大小写均可)。默認為4MB</span></span><br><span class="line">vgremove：#删除一个VG</span><br><span class="line">vgscan：#搜寻系统上面是否有VG存在</span><br><span class="line">vgextend：#在VG内擴展额外的PV</span><br><span class="line">vgreduce：#在VG内移除PV</span><br><span class="line">vgs：#搜寻VG，简单输出</span><br><span class="line">vgdisplay：#显示目前系统上面的VG状态</span><br><span class="line">vgchange:#设定 VG 是否启动 (active)；      </span><br><span class="line"></span><br><span class="line">* lv</span><br><span class="line">lvcreate：#创建LV</span><br><span class="line">	lvcreate [-L N[mgt]] [-n LV名称] VG名称</span><br><span class="line">	lvcreate [-l N] [-n LV名称] VG名称选项与参数：</span><br><span class="line"><span class="meta">	#</span><span class="bash">-L  ：后面接容量，容量的单位可以是 M,G,T 等，要注意的是，最小单位为 PE，因此这个数量必须要是 PE 的倍数，若不相符，系统会自行计算最相近的容量。</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">-l  ：后面可以接 PE 的‘个数’，而不是容量。若要这么做，得要自行计算 PE 数。</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">-n  ：后面接的就是 LV 的名称</span></span><br><span class="line">lvremove：#删除LV</span><br><span class="line">lvextend：#在LV里面增加容量</span><br><span class="line">lvreduce：#在LV里面减少容量</span><br><span class="line">lvresize：#对LV进行容量大小的调整</span><br><span class="line">lvs</span><br><span class="line">lvdisplay：#显示系统上面的LV状态</span><br><span class="line">       </span><br><span class="line">* 擴展邏輯卷</span><br><span class="line">	lvextend</span><br><span class="line">		-L [+]n /PATH/TO/LV            </span><br><span class="line"><span class="meta">		#</span><span class="bash">擴展物理邊界，有加號表示要再擴展多大，不用加號表示擴展到多大</span></span><br><span class="line">	resize2fs</span><br><span class="line">	resize2fs /PATH/TO/LV n  </span><br><span class="line"><span class="meta">	#</span><span class="bash">擴展邏輯邊界，這裏只能指定擴展到多大，最大不能超過物理邊界。因爲是ext文件系統，其他文件系統不一定要這樣用，或用其他命令。</span></span><br><span class="line">		-p：不用指定擴展多少，能有多大擴多大</span><br><span class="line">	resize2fs -p /PATH/TO/LV       </span><br><span class="line">               </span><br><span class="line">* 縮減邏輯卷</span><br><span class="line">	resize2fs</span><br><span class="line">	resize2fs [-f] [device] [size]选项与参数：</span><br><span class="line"><span class="meta">	#</span><span class="bash">-f      ：强制进行 resize 的动作！</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">[device]：装置的档案名称；</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">[size]  ：可以加也可以不加。如果加上 size 的话，那么就必须要给予一个单位，譬如 M, G 等等。如果没有 size 的话，那么预设使用‘整个 partition’的容量来处理！  </span></span><br><span class="line"><span class="meta">	#</span><span class="bash">縮減邏輯邊界 </span></span><br><span class="line"><span class="meta">	#</span><span class="bash">不能在線縮減，要先卸載，確保縮減後的空間大小依然能存儲原有的所有數據；在縮減前應該先強行檢查文件，以確保文件系統處於一至性狀態</span></span><br><span class="line"> </span><br><span class="line">	lvreduce -L [-]# /PATH/TO/LV       </span><br><span class="line"><span class="meta">	#</span><span class="bash">縮減物理邊界</span></span><br><span class="line"></span><br><span class="line">* 快照卷</span><br><span class="line">1. 生命周期為整個數據時長，在這段時長內，數據的增長量不能超出快照卷大小；大小自己估計，         保險的辦法是和原卷一樣大，或與原卷中數據一樣大</span><br><span class="line">2. 快照卷應該是只讀的</span><br><span class="line">3. 跟原卷在同一卷組內</span><br><span class="line"> </span><br><span class="line">lvcreate</span><br><span class="line">	-s: #指定為快照卷</span><br><span class="line">	-P r|w: #設定是只讀還是讀寫權限，建議爲只讀</span><br><span class="line"> </span><br><span class="line">	lvcreate -L n -n SLV_NAME -s -p r /PATH/TO/LV</span><br><span class="line"><span class="meta">	#</span><span class="bash">-L指定大小，-n指定快照卷名稱，最後指定對哪個邏輯卷創建</span></span><br></pre></td></tr></table></figure>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="创建LVM卷"><a href="#创建LVM卷" class="headerlink" title="创建LVM卷"></a>创建LVM卷</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">* 准备分区</span><br><span class="line">fdisk /dev/sdb</span><br><span class="line"><span class="meta">#</span><span class="bash">分出四个分区，并将分区system ID改为8e。</span></span><br><span class="line">partprobe /dev/sdb</span><br><span class="line">fdisk -l</span><br><span class="line"><span class="meta">#</span><span class="bash">四个分区的system都应该是Linux LVM，改为8及机是为了使LVM的侦测指令可以侦测到partition。不改也可以进行LVM创建。</span></span><br><span class="line">* PV</span><br><span class="line">[root@bogon ~]# pvcreate /dev/sdb&#123;1,2,3,5&#125;</span><br><span class="line">  Physical volume "/dev/sdb1" successfully created.</span><br><span class="line">  Physical volume "/dev/sdb2" successfully created.</span><br><span class="line">  Physical volume "/dev/sdb3" successfully created.</span><br><span class="line">  Physical volume "/dev/sdb5" successfully created.</span><br><span class="line">[root@bogon ~]# pvscan </span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;31.00 GiB / 4.00 MiB free]</span><br><span class="line">  PV /dev/sdb1                      lvm2 [1.00 GiB]</span><br><span class="line">  PV /dev/sdb3                      lvm2 [1.00 GiB]</span><br><span class="line">  PV /dev/sdb2                      lvm2 [1.00 GiB]</span><br><span class="line">  PV /dev/sdb5                      lvm2 [&lt;9.00 GiB]</span><br><span class="line">  Total: 5 [42.99 GiB] / in use: 1 [&lt;31.00 GiB] / in no VG: 4 [&lt;12.00 GiB]</span><br><span class="line"><span class="meta">#</span><span class="bash">这里分别显示每个PV的信息与系统所有PV的信息。最后一行显示的是：整体PV的量/已经被使用的VG的PV量/剩余的PV量</span></span><br><span class="line">[root@bogon ~]# pvdisplay </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sda2</span><br><span class="line"><span class="meta">  #</span><span class="bash">实际的 partition 装置名称</span></span><br><span class="line">  VG Name               centos</span><br><span class="line"><span class="meta">  #</span><span class="bash">分配到哪个VG的名称</span></span><br><span class="line">  PV Size               &lt;31.00 GiB / not usable 3.00 MiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">容量说明</span></span><br><span class="line">  Allocatable           yes</span><br><span class="line"><span class="meta">  #</span><span class="bash">是否已被分配出去，已分配就是yes，否则是NO。</span></span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">在此PV内的PE的大小</span></span><br><span class="line">  Total PE              7935</span><br><span class="line"><span class="meta">  #</span><span class="bash">共有几个PE</span></span><br><span class="line">  Free PE               1</span><br><span class="line"><span class="meta">  #</span><span class="bash">未被LV用掉的PE</span></span><br><span class="line">  Allocated PE          7934</span><br><span class="line"><span class="meta">  #</span><span class="bash">还可分配出去的PE的数量</span></span><br><span class="line">  PV UUID               4jHxbK-P3Py-rV7o-3o1l-fOQc-LhY0-lvFtJv</span><br><span class="line">  </span><br><span class="line">   </span><br><span class="line">  "/dev/sdb1" is a new physical volume of "1.00 GiB"</span><br><span class="line">  --- NEW Physical volume ---</span><br><span class="line">  PV Name               /dev/sdb1</span><br><span class="line">  VG Name               </span><br><span class="line"><span class="meta">  #</span><span class="bash">因为没有分配到VG，所以这里是空白</span></span><br><span class="line">  PV Size               1.00 GiB</span><br><span class="line">  Allocatable           NO</span><br><span class="line">  PE Size               0   </span><br><span class="line">  Total PE              0</span><br><span class="line">  Free PE               0</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               totx56-SkbA-AXtb-gpUS-MGW2-1rdZ-XTrUQn</span><br><span class="line">  ......</span><br><span class="line"><span class="meta">#</span><span class="bash">由于PE是在建立VG时才给予的参数，因此在这里看到的PV里头的PE都是0，而且也没有多余的PE可供分配</span></span><br><span class="line"></span><br><span class="line">* VG</span><br><span class="line">[root@bogon ~]# vgcreate -s 16M ruopuvg /dev/sdb&#123;1,2,3&#125;</span><br><span class="line">  Volume group "ruopuvg" successfully created</span><br><span class="line">[root@bogon ~]# vgscan </span><br><span class="line">  Reading volume groups from cache.</span><br><span class="line">  Found volume group "ruopuvg" using metadata type lvm2</span><br><span class="line">  Found volume group "centos" using metadata type lvm2</span><br><span class="line">[root@bogon ~]# pvscan</span><br><span class="line">  PV /dev/sdb1   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb2   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb3   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;31.00 GiB / 4.00 MiB free]</span><br><span class="line">  PV /dev/sdb5                      lvm2 [&lt;9.00 GiB]</span><br><span class="line">  Total: 5 [&lt;42.95 GiB] / in use: 4 [&lt;33.95 GiB] / in no VG: 1 [&lt;9.00 GiB]</span><br><span class="line"><span class="meta">#</span><span class="bash">显示有三个PV被用了，sdb5没被用。</span></span><br><span class="line">[root@bogon ~]# vgdisplay </span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  System ID             </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        3</span><br><span class="line">  Metadata Sequence No  1</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                0</span><br><span class="line">  Open LV               0</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                3</span><br><span class="line">  Act PV                3</span><br><span class="line">  VG Size               2.95 GiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">整体的VG容量大小</span></span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">PE的大小</span></span><br><span class="line">  Total PE              189</span><br><span class="line"><span class="meta">  #</span><span class="bash">PE的整体数量</span></span><br><span class="line">  Alloc PE / Size       0 / 0   </span><br><span class="line">  Free  PE / Size       189 / 2.95 GiB</span><br><span class="line">  VG UUID               DAWGEA-EGjX-tsd0-DHoL-2MOq-R4SV-VaTHcT</span><br><span class="line"><span class="meta">#</span><span class="bash">最后三行指PE能够使用的情况，由于还未创建LV，所以所有的PE均可自由使用。</span></span><br><span class="line">[root@bogon ~]# vgextend ruopuvg /dev/sdb5</span><br><span class="line">  Volume group "ruopuvg" successfully extended</span><br><span class="line"><span class="meta">#</span><span class="bash">将sdb5加入到刚创建的VG中  </span></span><br><span class="line"></span><br><span class="line">* LV</span><br><span class="line">[root@bogon ~]# lvcreate -l 100 -n ruopulv ruopuvg</span><br><span class="line">  Logical volume "ruopulv" created.</span><br><span class="line"><span class="meta">#</span><span class="bash">分配100个PE给这个LV，也可以用lvcreate -L 2G -n ruopulv ruopuvg来创建LV</span></span><br><span class="line">[root@bogon ~]# ll /dev/ruopuvg/ruopulv </span><br><span class="line">lrwxrwxrwx. 1 root root 7 Oct  9 11:39 /dev/ruopuvg/ruopulv -&gt; ../dm-2</span><br><span class="line">[root@bogon ~]# lvdisplay </span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ruopuvg/ruopulv</span><br><span class="line">  LV Name                ruopulv</span><br><span class="line"><span class="meta">  #</span><span class="bash">LV的名称</span></span><br><span class="line">  VG Name                ruopuvg</span><br><span class="line">  LV UUID                7Nxeng-bsdp-i3OA-ckl2-0YiQ-TOKi-Ng03JH</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time bogon, 2018-10-09 11:39:05 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line"><span class="meta">  #</span><span class="bash"> open                 0</span></span><br><span class="line">  LV Size                1.56 GiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">LV的容量</span></span><br><span class="line">  Current LE             100</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:2</span><br><span class="line"></span><br><span class="line">* 格式化与使用</span><br><span class="line">[root@bogon ~]# mkfs.ext4 /dev/ruopuvg/ruopulv </span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Discarding device blocks: done                            </span><br><span class="line">Filesystem label=</span><br><span class="line">OS type: Linux</span><br><span class="line">Block size=4096 (log=2)</span><br><span class="line">Fragment size=4096 (log=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">102544 inodes, 409600 blocks</span><br><span class="line">20480 blocks (5.00%) reserved for the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=419430400</span><br><span class="line">13 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">7888 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">	32768, 98304, 163840, 229376, 294912</span><br><span class="line"></span><br><span class="line">Allocating group tables: done                            </span><br><span class="line">Writing inode tables: done                            </span><br><span class="line">Creating journal (8192 blocks): done</span><br><span class="line">Writing superblocks and filesystem accounting information: done </span><br><span class="line"><span class="meta">#</span><span class="bash">格式化LV</span></span><br><span class="line">[root@bogon ~]# mount /dev/ruopuvg/ruopulv /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash">挂载</span></span><br></pre></td></tr></table></figure>
<h2 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# fdisk /dev/sdc</span><br><span class="line"><span class="meta">#</span><span class="bash">新加一块硬盘，创建两个新分区，system ID改为8e</span></span><br><span class="line">[root@bogon ~]# partprobe /dev/sdc</span><br><span class="line">pvcreate /dev/sdc1</span><br><span class="line">[root@bogon ~]# pvcreate /dev/sdc1</span><br><span class="line">  Physical volume "/dev/sdc1" successfully created.</span><br><span class="line">[root@bogon ~]# pvscan </span><br><span class="line">  PV /dev/sdb1   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb2   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb3   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb5   VG ruopuvg         lvm2 [8.98 GiB / 7.42 GiB free]</span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;31.00 GiB / 4.00 MiB free]</span><br><span class="line">  PV /dev/sdc1                      lvm2 [1.00 GiB]</span><br><span class="line">  Total: 6 [43.93 GiB] / in use: 5 [42.93 GiB] / in no VG: 1 [1.00 GiB]</span><br><span class="line"></span><br><span class="line">* 加大VG</span><br><span class="line">[root@bogon ~]# vgextend ruopuvg /dev/sdc1</span><br><span class="line">  Volume group "ruopuvg" successfully extended</span><br><span class="line">[root@bogon ~]# vgdisplay </span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  System ID             </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        5</span><br><span class="line">  Metadata Sequence No  4</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                1</span><br><span class="line">  Open LV               1</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                5</span><br><span class="line">  Act PV                5</span><br><span class="line">  VG Size               12.92 GiB</span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              827</span><br><span class="line">  Alloc PE / Size       100 / 1.56 GiB</span><br><span class="line">  Free  PE / Size       727 / &lt;11.36 GiB</span><br><span class="line">  VG UUID               DAWGEA-EGjX-tsd0-DHoL-2MOq-R4SV-VaTHcT</span><br><span class="line"><span class="meta">#</span><span class="bash">整体的VG变大了，PE的数量也增加了</span></span><br><span class="line"></span><br><span class="line">* 加大LV</span><br><span class="line">[root@bogon ~]# lvresize -l +100 /dev/ruopuvg/ruopulv </span><br><span class="line">  Size of logical volume ruopuvg/ruopulv changed from 1.56 GiB (100 extents) to 3.12 GiB (200 extents).</span><br><span class="line">  Logical volume ruopuvg/ruopulv successfully resized.</span><br><span class="line"><span class="meta">#</span><span class="bash">给LV再增加100个PE，也可以使用-L选项</span></span><br><span class="line">[root@bogon ~]# lvdisplay </span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ruopuvg/ruopulv</span><br><span class="line">  LV Name                ruopulv</span><br><span class="line">  VG Name                ruopuvg</span><br><span class="line">  LV UUID                7Nxeng-bsdp-i3OA-ckl2-0YiQ-TOKi-Ng03JH</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time bogon, 2018-10-09 11:39:05 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line"><span class="meta">  #</span><span class="bash"> open                 1</span></span><br><span class="line">  LV Size                3.12 GiB</span><br><span class="line">  Current LE             200</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:2</span><br><span class="line">[root@bogon ~]# df -h /mnt</span><br><span class="line">Filesystem                   Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/ruopuvg-ruopulv  1.6G   38M  1.4G   3% /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash">虽然增加了LV的容量，但实际中，LV挂载的分区并未变大</span></span><br><span class="line">[root@bogon ~]# dumpe2fs /dev/ruopuvg/ruopulv </span><br><span class="line">dumpe2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">......</span><br><span class="line">Block count:              409600</span><br><span class="line"><span class="meta">#</span><span class="bash">这个文件系统的block总数</span></span><br><span class="line">......</span><br><span class="line">Blocks per group:         32768</span><br><span class="line"><span class="meta">#</span><span class="bash">多少个block设定成为一个block group</span></span><br><span class="line">[root@bogon ~]# resize2fs /dev/ruopuvg/ruopulv </span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem at /dev/ruopuvg/ruopulv is mounted on /mnt; on-line resizing required</span><br><span class="line">old_desc_blocks = 1, new_desc_blocks = 1</span><br><span class="line">The filesystem on /dev/ruopuvg/ruopulv is now 819200 blocks long.</span><br><span class="line"><span class="meta">#</span><span class="bash">这里使用整个lvresize命令扩容进来的空间，也可以用size来指定扩容多少空间</span></span><br><span class="line">[root@bogon ~]# df -h /mnt</span><br><span class="line">Filesystem                   Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/ruopuvg-ruopulv  3.1G   38M  2.9G   2% /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash">使用resize2fs命令后，LV才会真正扩容</span></span><br><span class="line">[root@bogon ~]# ll /mnt</span><br><span class="line">total 20</span><br><span class="line">drwxr-xr-x. 80 root root  4096 Oct  9 11:45 etc</span><br><span class="line">drwx------.  2 root root 16384 Oct  9 11:44 lost+found</span><br><span class="line"><span class="meta">#</span><span class="bash">之前复制进去的/etc目录还存在。这样就实现了热扩容</span></span><br><span class="line"></span><br><span class="line">root@ruopu:~# lvextend -r -l +100%free /dev/ubuntu-vg/ubuntu-lv</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-r选项可以使扩容的空间当时生效，无需再使用resize2fs命令，使用-l表示指定逻辑卷的LE数，-L表示指定逻辑卷的大小，单位为“kKmMgGtT”字节。+100%free表示将所有空余空间都加进来，只能使用-l选项指定。</span></span><br><span class="line">root@ruopu:~# lvextend -r -L 19G /dev/ubuntu-vg/ubuntu-lv</span><br></pre></td></tr></table></figure>
<h2 id="缩减"><a href="#缩减" class="headerlink" title="缩减"></a>缩减</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# resize2fs /dev/ruopuvg/ruopulv 1500M</span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem at /dev/ruopuvg/ruopulv is mounted on /mnt; on-line resizing required</span><br><span class="line">resize2fs: On-line shrinking not supported</span><br><span class="line"><span class="meta">#</span><span class="bash">resize2fs命令不能使用小数点，如1.5G，所以这里改为1500M，也就是将LV空间缩减为1500M。另外，使用此命令进行缩减时不能在LV已挂载的情况下做。</span></span><br><span class="line">[root@bogon ~]# umount /mnt</span><br><span class="line">[root@bogon ~]# resize2fs /dev/ruopuvg/ruopulv 1500M</span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Please run 'e2fsck -f /dev/ruopuvg/ruopulv' first.</span><br><span class="line"><span class="meta">#</span><span class="bash">系统要求我们先进行磁盘检查</span></span><br><span class="line">[root@bogon ~]# e2fsck -f /dev/ruopuvg/ruopulv </span><br><span class="line">e2fsck 1.42.9 (28-Dec-2013)</span><br><span class="line">Pass 1: Checking inodes, blocks, and sizes</span><br><span class="line">Pass 2: Checking directory structure</span><br><span class="line">Pass 3: Checking directory connectivity</span><br><span class="line">Pass 4: Checking reference counts</span><br><span class="line">Pass 5: Checking group summary information</span><br><span class="line">/dev/ruopuvg/ruopulv: 2467/197200 files (0.2% non-contiguous), 30101/819200 blocks</span><br><span class="line">[root@bogon ~]# resize2fs /dev/ruopuvg/ruopulv 1500M</span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Resizing the filesystem on /dev/ruopuvg/ruopulv to 384000 (4k) blocks.</span><br><span class="line">The filesystem on /dev/ruopuvg/ruopulv is now 384000 blocks long.</span><br><span class="line">[root@bogon ~]# mount /dev/ruopuvg/ruopulv /mnt</span><br><span class="line">[root@bogon ~]# df -h /mnt</span><br><span class="line">Filesystem                   Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/ruopuvg-ruopulv  1.5G   38M  1.3G   3% /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash">这样就缩减成功了</span></span><br><span class="line">[root@bogon ~]# lvdisplay </span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ruopuvg/ruopulv</span><br><span class="line">  LV Name                ruopulv</span><br><span class="line">  VG Name                ruopuvg</span><br><span class="line">  LV UUID                7Nxeng-bsdp-i3OA-ckl2-0YiQ-TOKi-Ng03JH</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time bogon, 2018-10-09 11:39:05 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line"><span class="meta">  #</span><span class="bash"> open                 1</span></span><br><span class="line">  LV Size                3.12 GiB</span><br><span class="line">  Current LE             200</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:2</span><br><span class="line"><span class="meta">#</span><span class="bash">但此时LV并没有缩减</span></span><br><span class="line">[root@bogon ~]# lvresize -L -1.6G /dev/ruopuvg/ruopulv </span><br><span class="line">  Rounding size to boundary between physical extents: 1.59 GiB.</span><br><span class="line">  WARNING: Reducing active and open logical volume to 1.53 GiB.</span><br><span class="line">  THIS MAY DESTROY YOUR DATA (filesystem etc.)</span><br><span class="line">Do you really want to reduce ruopuvg/ruopulv? [y/n]: y</span><br><span class="line">  Size of logical volume ruopuvg/ruopulv changed from 3.12 GiB (200 extents) to 1.53 GiB (98 extents).</span><br><span class="line">  Logical volume ruopuvg/ruopulv successfully resized.</span><br><span class="line"><span class="meta">#</span><span class="bash">这里将LV缩减1.6G</span></span><br><span class="line">[root@bogon ~]# lvdisplay </span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ruopuvg/ruopulv</span><br><span class="line">  LV Name                ruopulv</span><br><span class="line">  VG Name                ruopuvg</span><br><span class="line">  LV UUID                7Nxeng-bsdp-i3OA-ckl2-0YiQ-TOKi-Ng03JH</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time bogon, 2018-10-09 11:39:05 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line"><span class="meta">  #</span><span class="bash"> open                 1</span></span><br><span class="line">  LV Size                1.53 GiB</span><br><span class="line">  Current LE             98</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:2</span><br><span class="line"><span class="meta">#</span><span class="bash">这样LV也缩减完成了。</span></span><br><span class="line">[root@bogon ~]# pvdisplay </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sdb1</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  PV Size               1.00 GiB / not usable 16.00 MiB</span><br><span class="line">  Allocatable           yes </span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              63</span><br><span class="line">  Free PE               63</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               totx56-SkbA-AXtb-gpUS-MGW2-1rdZ-XTrUQn</span><br><span class="line">   </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sdb2</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  PV Size               1.00 GiB / not usable 16.00 MiB</span><br><span class="line">  Allocatable           yes </span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              63</span><br><span class="line">  Free PE               63</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               zL5fa0-hfxX-zfnH-VAGf-Eu09-2uoz-ZNFj12</span><br><span class="line">   </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sdb3</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  PV Size               1.00 GiB / not usable 16.00 MiB</span><br><span class="line">  Allocatable           yes </span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              63</span><br><span class="line">  Free PE               63</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               ljRtmq-e75k-xz00-SJkC-W569-1Ge7-9quZB7</span><br><span class="line">   </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sdb5</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  PV Size               &lt;9.00 GiB / not usable 14.00 MiB</span><br><span class="line">  Allocatable           yes </span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              575</span><br><span class="line">  Free PE               477</span><br><span class="line">  Allocated PE          98</span><br><span class="line">  PV UUID               CJgQ6x-4oRB-WD3i-bKaf-jRdB-Sz93-Xeoqpm</span><br><span class="line">   </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sdc1</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  PV Size               1.00 GiB / not usable 16.00 MiB</span><br><span class="line">  Allocatable           yes </span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              63</span><br><span class="line">  Free PE               63</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               lIAqor-XGnw-PTYo-L6yY-ld6y-AeNz-41imsu</span><br><span class="line"><span class="meta">  #</span><span class="bash">可以看到，sdb1,sdb2,sdb3,sdc1的PE都是空闲的了</span></span><br><span class="line">  [root@bogon ~]# pvmove /dev/sdb5 /dev/sdb1</span><br><span class="line">  Insufficient free space: 98 extents needed, but only 63 available</span><br><span class="line">  Unable to allocate mirror extents for ruopuvg/pvmove0.</span><br><span class="line">  Failed to convert pvmove LV to mirrored</span><br><span class="line"><span class="meta">  #</span><span class="bash">如果要转移PE，可以使用此命令，但这里因为一共有98个PE要转移，而sdb1上只有63个PE而无法完成转移</span></span><br><span class="line">  [root@bogon ~]# pvscan </span><br><span class="line">  PV /dev/sdb1   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb2   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb3   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb5   VG ruopuvg         lvm2 [8.98 GiB / 7.45 GiB free]</span><br><span class="line">  PV /dev/sdc1   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;31.00 GiB / 4.00 MiB free]</span><br><span class="line">  Total: 6 [&lt;43.92 GiB] / in use: 6 [&lt;43.92 GiB] / in no VG: 0 [0   ]</span><br><span class="line">[root@bogon ~]# vgreduce ruopuvg /dev/sdb1</span><br><span class="line">  Removed "/dev/sdb1" from volume group "ruopuvg"</span><br><span class="line"><span class="meta">#</span><span class="bash">将分区从VG中移除</span></span><br><span class="line">[root@bogon ~]# pvscan </span><br><span class="line">  PV /dev/sdb2   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb3   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb5   VG ruopuvg         lvm2 [8.98 GiB / 7.45 GiB free]</span><br><span class="line">  PV /dev/sdc1   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;31.00 GiB / 4.00 MiB free]</span><br><span class="line">  PV /dev/sdb1                      lvm2 [1.00 GiB]</span><br><span class="line">  Total: 6 [43.93 GiB] / in use: 5 [42.93 GiB] / in no VG: 1 [1.00 GiB]</span><br><span class="line"><span class="meta">#</span><span class="bash">可以看到sdb1已经没有了</span></span><br><span class="line">[root@bogon ~]# pvremove /dev/sdb1</span><br><span class="line">  Labels on physical volume "/dev/sdb1" successfully wiped.</span><br><span class="line"><span class="meta">#</span><span class="bash">最后将sdb1从PV中移除。这样系统以及实际的LV与VG都变小了，sdb1可以进行其他工作了</span></span><br></pre></td></tr></table></figure>
<h2 id="快照"><a href="#快照" class="headerlink" title="快照"></a>快照</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">快照卷就是为LV卷创建的快照，创建时快照卷就会有与原LV卷相同的内容，当原LV卷改变时，会将改变前的数据保存到快照卷，而新内容是与快照卷共享的。如果出现问题，可以将快照卷的内容恢复到上一次改变时的内容。但不要让快照卷的使用超过100%，如果超过100%，快照卷就自动销毁了。</span><br><span class="line">如果将原本的LV卷当备份资料，将快照卷当实际使用的磁盘，添加删除数据都在快照卷中进行，测试完后可将数据删除，而原LV卷不会有影响，如果快照卷有问题，可以删除并重新创建，也可制作多个一样的快照卷。</span><br><span class="line">* 创建</span><br><span class="line">[root@bogon ~]# vgdisplay </span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  System ID             </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        4</span><br><span class="line">  Metadata Sequence No  7</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                1</span><br><span class="line">  Open LV               1</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                4</span><br><span class="line">  Act PV                4</span><br><span class="line">  VG Size               &lt;11.94 GiB</span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              764</span><br><span class="line">  Alloc PE / Size       98 / 1.53 GiB</span><br><span class="line">  Free  PE / Size       666 / &lt;10.41 GiB</span><br><span class="line">  VG UUID               DAWGEA-EGjX-tsd0-DHoL-2MOq-R4SV-VaTHcT</span><br><span class="line">[root@bogon ~]# pvcreate /dev/sdb1</span><br><span class="line">  Physical volume "/dev/sdb1" successfully created.</span><br><span class="line">[root@bogon ~]# vgextend ruopuvg /dev/sdb1</span><br><span class="line">  Volume group "ruopuvg" successfully extended</span><br><span class="line">[root@bogon ~]# vgdisplay </span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  System ID             </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        5</span><br><span class="line">  Metadata Sequence No  8</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                1</span><br><span class="line">  Open LV               1</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                5</span><br><span class="line">  Act PV                5</span><br><span class="line">  VG Size               12.92 GiB</span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              827</span><br><span class="line">  Alloc PE / Size       98 / 1.53 GiB</span><br><span class="line">  Free  PE / Size       729 / 11.39 GiB</span><br><span class="line">  VG UUID               DAWGEA-EGjX-tsd0-DHoL-2MOq-R4SV-VaTHcT  </span><br><span class="line">[root@bogon ~]# lvcreate -L 1.53G -s -n ruopuss1 /dev/ruopuvg/ruopulv </span><br><span class="line">  Using default stripesize 64.00 KiB.</span><br><span class="line">  Logical volume "ruopuss" created.</span><br><span class="line"><span class="meta">#</span><span class="bash">-s表示是snapshot快照功能之意；-n后面接快照区的设备名称， /dev/.... 则是要被快照的 LV 完整名称。-l 后面则是接使用多少个 PE 来作为这个快照区使用。这里创建快照卷时尽量将快照卷与原LV创建成一样大的空间，以便对原LV中的数据进行快照</span></span><br><span class="line">[root@bogon ~]# vgdisplay</span><br><span class="line">	--- Logical volume ---</span><br><span class="line">  LV Path                /dev/ruopuvg/ruopuss1</span><br><span class="line">  LV Name                ruopuss1</span><br><span class="line">  VG Name                ruopuvg</span><br><span class="line">  LV UUID                2OBmjd-WnN7-V1c5-p90S-E8MM-6xN8-uOcmlF</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time bogon, 2018-10-10 15:29:25 +0800</span><br><span class="line">  LV snapshot status     active destination for ruopulv</span><br><span class="line">  LV Status              available</span><br><span class="line"><span class="meta">  #</span><span class="bash"> open                 0</span></span><br><span class="line">  LV Size                1.53 GiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">被快照的原LV磁盘容量</span></span><br><span class="line">  Current LE             98</span><br><span class="line">  COW-table size         1.53 GiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">快照区的实际容量</span></span><br><span class="line">  COW-table LE           98</span><br><span class="line"><span class="meta">  #</span><span class="bash">快照区占用的PE数量</span></span><br><span class="line">  Allocated to snapshot  0.00%</span><br><span class="line">  Snapshot chunk size    4.00 KiB</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:7</span><br><span class="line">[root@bogon ~]# mount /dev/ruopuvg/ruopuss /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash">挂载快照卷</span></span><br><span class="line">[root@bogon ~]# df -h</span><br><span class="line">Filesystem                    Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/centos-root        30G  2.0G   29G   7% /</span><br><span class="line">devtmpfs                      234M     0  234M   0% /dev</span><br><span class="line">tmpfs                         245M     0  245M   0% /dev/shm</span><br><span class="line">tmpfs                         245M   29M  216M  12% /run</span><br><span class="line">tmpfs                         245M     0  245M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1                    1014M  125M  890M  13% /boot</span><br><span class="line">tmpfs                          49M     0   49M   0% /run/user/0</span><br><span class="line">/dev/mapper/ruopuvg-ruopuss   1.5G   38M  1.3G   3% /mnt</span><br><span class="line">/dev/mapper/ruopuvg-ruopulv   1.5G   38M  1.3G   3% /media</span><br><span class="line"><span class="meta">#</span><span class="bash">这里显示快照卷与原LV是一样大的，里面的数据也是一样大的，因为共享了一样的数据且数据尚没有变更</span></span><br><span class="line">[root@bogon ~]# umount /mnt</span><br><span class="line"></span><br><span class="line">* 利用快照区复原系统</span><br><span class="line">[root@bogon ~]# df /media</span><br><span class="line">Filesystem                   1K-blocks  Used Available Use% Mounted on</span><br><span class="line">/dev/mapper/ruopuvg-ruopulv   1479424 38088   1357064   3% /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash">原LV卷的磁盘信息</span></span><br><span class="line">[root@bogon ~]# ll /media</span><br><span class="line">total 20</span><br><span class="line">drwxr-xr-x. 80 root root  4096 Oct  9 11:45 etc</span><br><span class="line">drwx------.  2 root root 16384 Oct  9 11:44 lost+found</span><br><span class="line">[root@bogon ~]# rm -rf /media/etc</span><br><span class="line">[root@bogon ~]# cp -ar /boot/ /sbin/ /media</span><br><span class="line">[root@bogon ~]# ll /media</span><br><span class="line">total 40</span><br><span class="line">dr-xr-xr-x.  5 root root  4096 Oct  8 14:29 boot</span><br><span class="line">drwx------.  2 root root 16384 Oct  9 11:44 lost+found</span><br><span class="line">dr-xr-xr-x.  2 root root 16384 Oct  8 16:28 sbin</span><br><span class="line">[root@bogon ~]# lvdisplay /dev/ruopuvg/ruopuss</span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ruopuvg/ruopuss</span><br><span class="line">  LV Name                ruopuss1</span><br><span class="line">  VG Name                ruopuvg</span><br><span class="line">  LV UUID                2OBmjd-WnN7-V1c5-p90S-E8MM-6xN8-uOcmlF</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time bogon, 2018-10-10 15:29:25 +0800</span><br><span class="line">  LV snapshot status     active destination for ruopulv</span><br><span class="line">  LV Status              available</span><br><span class="line"><span class="meta">  #</span><span class="bash"> open                 1</span></span><br><span class="line">  LV Size                1.53 GiB</span><br><span class="line">  Current LE             98</span><br><span class="line">  COW-table size         1.53 GiB</span><br><span class="line">  COW-table LE           98</span><br><span class="line">  Allocated to snapshot  43.44%</span><br><span class="line"><span class="meta">  #</span><span class="bash">快照卷使用情况</span></span><br><span class="line">  Snapshot chunk size    4.00 KiB</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:7</span><br><span class="line">[root@bogon ~]# mount /dev/ruopuvg/ruopuss /mnt</span><br><span class="line">[root@bogon ~]# df</span><br><span class="line">Filesystem                  1K-blocks    Used Available Use% Mounted on</span><br><span class="line">/dev/mapper/centos-root      31433732 1133104  30300628   4% /</span><br><span class="line">devtmpfs                       238980       0    238980   0% /dev</span><br><span class="line">tmpfs                          250036       0    250036   0% /dev/shm</span><br><span class="line">tmpfs                          250036    4500    245536   2% /run</span><br><span class="line">tmpfs                          250036       0    250036   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1                     1038336  127400    910936  13% /boot</span><br><span class="line">tmpfs                           50008       0     50008   0% /run/user/0</span><br><span class="line">/dev/mapper/ruopuvg-ruopulv    999320  137356    793152  15% /media</span><br><span class="line">/dev/mapper/ruopuvg-ruopuss    999320   35444    895064   4% /mnt</span><br><span class="line">[root@bogon ~]# mkdir -p /backups</span><br><span class="line">[root@bogon ~]# cd /mnt</span><br><span class="line">[root@bogon mnt]# tar -zcf /backups/lvm.tar.gz *</span><br><span class="line">[root@bogon ~]# umount /mnt</span><br><span class="line">[root@bogon ~]# lvremove /dev/ruopuvg/ruopuss </span><br><span class="line">Do you really want to remove active logical volume ruopuvg/ruopuss? [y/n]: y</span><br><span class="line">  Logical volume "ruopuss" successfully removed</span><br><span class="line">[root@bogon ~]# umount /mnt</span><br><span class="line">[root@bogon ~]# mkfs.ext4 /dev/ruopuvg/ruopulv</span><br><span class="line">[root@bogon ~]# mount /dev/ruopuvg/ruopulv /media</span><br><span class="line">[root@bogon ~]# tar xf /backups/lvm.tar.gz -C /media</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/30/jdyc测试环境搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/30/jdyc测试环境搭建/" itemprop="url">
                  jdyc测试环境搭建
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-30 10:56:33 / 修改時間：11:59:11" itemprop="dateCreated datePublished" datetime="2018-09-30T10:56:33+08:00">2018-09-30</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/test/" itemprop="url" rel="index"><span itemprop="name">test</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h1><p>IP：10.5.5.242</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ansible</span><br><span class="line">vim /etc/ansible/hosts</span><br><span class="line">	[ansible]</span><br><span class="line">    10.5.5.242</span><br><span class="line"></span><br><span class="line">    [web]</span><br><span class="line">    10.5.5.223</span><br><span class="line"></span><br><span class="line">    [netty]</span><br><span class="line">    10.5.5.221</span><br><span class="line">    10.5.5.222</span><br><span class="line"></span><br><span class="line">    [wechat]</span><br><span class="line">    10.5.5.224</span><br><span class="line">    10.5.5.227</span><br><span class="line"></span><br><span class="line">    [processor]</span><br><span class="line">    10.5.5.228</span><br><span class="line">    10.5.5.229</span><br><span class="line"></span><br><span class="line">    [mysql]</span><br><span class="line">    10.5.5.238</span><br><span class="line">    10.5.5.239</span><br><span class="line"></span><br><span class="line">    [kafka]</span><br><span class="line">    10.5.5.232</span><br><span class="line">    10.5.5.233</span><br><span class="line">    10.5.5.234</span><br><span class="line"></span><br><span class="line">    [redis]</span><br><span class="line">    10.5.5.235</span><br><span class="line">    10.5.5.236</span><br><span class="line">    10.5.5.237</span><br><span class="line"></span><br><span class="line">ssh-keygen -t rsa -P ''</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub 10.5.5.237</span><br><span class="line"><span class="meta">#</span><span class="bash">将密钥复制到ansible中加入的所有主机，实现无密钥登录</span></span><br><span class="line">ansible web,wechat,processor -m shell -a "yum install -y java-1.8.0-openjdk-devel"</span><br><span class="line">ansible web,wechat,processor -m shell -a "rpm -q java-1.8.0-openjdk-devel"</span><br><span class="line">ansible redis -m shell -a "yum install -y epel-release"</span><br><span class="line">ansible redis -m shell -a "yum install -y redis"</span><br><span class="line">ansible web,wechat,processor -m shell -a "yum install -y epel-release"</span><br><span class="line">ansible web,wechat,processor -m shell -a "yum install -y nginx"</span><br><span class="line"></span><br><span class="line">* web</span><br><span class="line">mkdir -pv /root/nginx/&#123;web,wechat&#125;</span><br><span class="line">vim /root/nginx/web/web.conf</span><br><span class="line">	proxy_cache_path /etc/nginx/cache levels=1:2:2 keys_zone=web_cache:10m max_size=2g;</span><br><span class="line">    server&#123;</span><br><span class="line">       server_name web.jdyichong.com;</span><br><span class="line">       index index.html index.htm;</span><br><span class="line">       charset utf-8;</span><br><span class="line">       proxy_cache web_cache;</span><br><span class="line">       proxy_cache_key $request_uri;</span><br><span class="line">       proxy_cache_methods GET HEAD;</span><br><span class="line">       proxy_cache_min_uses 1;</span><br><span class="line">       proxy_cache_valid 200 302 10m;</span><br><span class="line">       proxy_cache_valid 400 1m;</span><br><span class="line">       proxy_cache_use_stale http_502;</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">            proxy_pass http://10.5.5.223:8081;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">ansible web -m copy -a "src=/root/nginx/web/web.conf dest=/etc/nginx/conf.d"</span><br><span class="line">ansible web -m command -a "systemctl start nginx"</span><br><span class="line">ansible web -m command -a "systemctl enable nginx"</span><br><span class="line"><span class="meta">#</span><span class="bash">设置web服务器上的nginx启动并加入开机启动。测试时这里有报错，不能启动nginx，原因是使用了OpenVZ的模板，此模板中安装了httpd服务，并且开机启动，需要关闭。</span></span><br></pre></td></tr></table></figure>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><p>IP：10.5.5.223</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/27/iptables使用方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/27/iptables使用方法/" itemprop="url">
                  iptables使用方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-27 10:49:11" itemprop="dateCreated datePublished" datetime="2018-09-27T10:49:11+08:00">2018-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-09-29 16:24:36" itemprop="dateModified" datetime="2018-09-29T16:24:36+08:00">2018-09-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="防火墙概念"><a href="#防火墙概念" class="headerlink" title="防火墙概念"></a>防火墙概念</h1><blockquote>
<p>&emsp;&emsp;iptables是工作在linux内核中的网络防火墙，iptables和netfilter是一组工具，真正起到防火墙作用的是netfilter，netfilter是内核中的一個過濾框架，iptables是一個生成防火牆規則，並能將其符加在netfilter上，真正實現數據報文過濾、NAT、mangle等規則生成的工具。</p>
<p>&emsp;&emsp;防火牆工作在主機或網絡的邊緣，對進出的數據報文進行檢查監控，按事先定義的規則進行相應處理。防火牆可以是硬件或軟件，規則實施防火，規則包括匹配標準和處理辦法。</p>
<p>&emsp;Framework:</p>
<p>&emsp;默認規則：</p>
<p>&emsp;如果防火牆默認是全部開放的，那就用堵的辦法</p>
<p>&emsp;如果防火牆默認是全部關閉的，那就用通的辦法</p>
<p>&emsp;&emsp;防火牆規則必須放在內核上，因爲我們是不能和內核打交道的，有人在內核的TCP/IP協議棧上開放了幾個位置，開放給用戶空間的應用程序</p>
<p>&emsp;&emsp;netfile就是內核中可以放規則的位置；iptables是工作在用戶空間可以寫規則並可通過系統調用放置在內核相應位置的應用程序；報文流向有三種：進來的，出去的和轉發的，在/proc/sys/net/ipv4/ip_forward中就是定義是否轉發的；根據IP地址完成路由表中的路由決策，無論從哪進來的只要到了TCPIP協議棧後的下一個就是路由決策</p>
</blockquote>
<h1 id="iptables概念"><a href="#iptables概念" class="headerlink" title="iptables概念"></a>iptables概念</h1><blockquote>
<ul>
<li><p>hook function：鈎子函數，有五個位置。分別是input（進）, output（出）, forward（轉發）, prerouting（路由做出前）, postrouting（路由之後再發出）</p>
</li>
<li><p>鈎子函數的規則鏈：INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING；</p>
</li>
<li><p>filter（過濾）：表：INPUT，OUTPUT，FORWARD；</p>
</li>
<li><p>nat（地址轉換）：表：PREROUTING，POSTROUTING，OUTPUT；</p>
</li>
<li><p>mangle（拆開、修改、封裝報文首部）：表：INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING；</p>
</li>
<li><p>過濾與mangle是不能放在一起的；</p>
</li>
<li><p>raw()：表：PREROUTING，OUTPUT</p>
</li>
<li>IINPUT、OUTPUT是從內核空間到用戶空間實現過濾的，是主機防火牆設置，通過本機轉發的通過FORWARD鏈，是網絡防火牆的設置。路由的轉發功能可以是一臺主機上的兩個網段的地址.一臺交換機上可以配置多個網段的地址，但它們之間不能通信，但如果不同網段的主機的網關指向了一臺網關服務器上一塊網卡的兩個不同網段的地址，且服務器上開通了路由的功能，那麼就可以通信了；因爲IP地址不是屬於網卡的，而是屬於主機的，所以一塊網卡可以邊接兩個網絡</li>
<li>啓用了ip_forward鏈，默認所有報文都要轉發</li>
<li><p>應該隔離可以被公網訪問的主機與不能被公網訪問的主機，如在網關服務器上放三塊網卡，其中一塊是面對互聯網的，另一塊是面對內網的，最後一塊面對服務器，開放互聯網訪問時只能從面對互聯網的網卡到面對服務器的網卡；所有在面對內網網卡上的報文要想進來必須得是一個響應，其他不允許，網關服務器被叫做三宿主的主機</p>
</li>
<li><p>netfilter:是一個框架，在TCP/IP協議橈上有5個鈎子函數分別對應5個規則鏈，工作在內核中。不能手動向netfilter中添加數據，要用iptables編寫規則送達netfilter的某個鏈上，但它必須先屬於某張表。默認表是filter，還有nat、mangle表</p>
</li>
<li><p>目標地址轉換在進入時改，源地址轉換在出去的時候改。</p>
</li>
<li><p>可以使用自定義鏈，但只在被默認鏈調用時才能發揮作用，而且如果沒有自定義鏈中的任何規則匹配，還應該有返回機制。用戶可以刪除自定義的空鏈，默認鏈不能刪除。</p>
</li>
<li><p>每個規則都有兩個內置的計數器，一個記錄被匹配的報文個數，一個記錄被匹配的報文大小之和</p>
</li>
<li><p>NAT：Network Address Translation</p>
</li>
<li>DNAT：目標地址轉換，轉換IP報文中的目標IP地址。目標地址轉換DNAT，指在返回結果時將地址轉換爲請求的地址。如一臺服務器上沒有服務，但将其設置成轉換到后端兩臺服務器的地址，一臺80一臺21,用户訪問時訪問的是這臺沒有服務的主機，但返回結果是有服務的兩臺主機的內容，在返回結果時就要將地址轉換成沒有服務的主機的IP。也就是当用户访问一个地址时，这个地址本没有服务，但可将此请求转到相应的地址服务上，并在服务返回结果时自动将源地址转为用户请求的地址，这就是目标地址转换。源地址转换与目标地址转换效果相反。我们只操作一半，另一半转换由服务器自动完成</li>
<li>SNAT：源地址轉換，轉換IP報文中的源IP地址（可在POSTROUTING或OUTPUT上做，對網關來講只在POSTROUTING上作）。雖然稱爲源地址轉換，但目標IP地址也會轉換，只不過回程的目標地址會轉換</li>
<li>在互聯網上發送報文的時候，無論經過任何路由設備源IP與目標IP是不會改變的</li>
<li>對linux主機而言，IP地址是屬於主機的，不屬於網卡,配在什麼網卡上並不重要，關鍵是是否屬於這臺主機，無論是否打開轉發功能。這裏所說指一臺主機ping自己的網關地址，在網關這臺主機上的IP網關地址即使不在一個網段上也沒有開轉發功能，同樣可以被ping通。只有在ping第三臺網關指向這臺網關主機另一個網段IP的主機時，才需要轉發。</li>
<li>對linux主機而言，IP地址是屬於主機的，不屬於網卡,配在什麼網卡上並不重要，關鍵是是否屬於這臺主機，無論是否打開轉發功能。這裏所說指一臺主機ping自己的網關地址，在網關這臺主機上的IP網關地址即使不在一個網段上也沒有開轉發功能，同樣可以被ping通。只有在ping第三臺網關指向了這臺網關主機另一個網段IP的主機時，才需要轉發。</li>
<li>涉及到轉發與本機無關時一定是在FORWARD鏈上做</li>
<li>iptables在二三四層上進行過濾</li>
<li></li>
</ul>
</blockquote>
<h2 id="四表五链"><a href="#四表五链" class="headerlink" title="四表五链"></a>四表五链</h2><ul>
<li><p>filter表——过滤数据包</p>
</li>
<li><p>Nat表——用于网络地址转换（IP、端口）</p>
</li>
<li><p>Mangle表——修改数据包的服务类型、TTL、并且可以配置路由实现QOS</p>
</li>
<li><p>Raw表——决定数据包是否被状态跟踪机制处理</p>
</li>
</ul>
<ul>
<li>INPUT链——进来的数据包应用此规则链中的策略</li>
<li>OUTPUT链——外出的数据包应用此规则链中的策略</li>
<li>FORWARD链——转发数据包时应用此规则链中的策略</li>
<li>PREROUTING链——对数据包作路由选择前应用此链中的规则（所有的数据包进来的时侯都先由这个链处理）</li>
<li>POSTROUTING链——对数据包作路由选择后应用此链中的规则（所有的数据包出来的时侯都先由这个链处理）</li>
</ul>
<p><img src="/images/iptables/四表五链详细.jpg" alt=""></p>
<p><img src="/images/iptables/四表五链.png" alt=""></p>
<p><img src="/images/iptables/四表五链鸟哥.jpg" alt=""></p>
<h2 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h2><p>NEW：新連接請求。主机连接目标主机，在目标主机上看到的第一个想要连接的包<br>ESTABLISHED：已建立的連接。主机已与目标主机进行通信，判断标准只要目标主机回应了第一个包，就进入该状态。<br>INVALID：非法連接請求。无效的封包，例如数据破损的封包状态<br>RELATED：相關聯的。主机已与目标主机进行通信，目标主机发起新的链接方式，例如ftp</p>
<h1 id="规则及语法"><a href="#规则及语法" class="headerlink" title="规则及语法"></a>规则及语法</h1><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t TABLE] COMMAND CHAIN [num] 匹配條件 -j 處理動作</span><br></pre></td></tr></table></figure>
<h2 id="規則：匹配標準"><a href="#規則：匹配標準" class="headerlink" title="規則：匹配標準"></a>規則：匹配標準</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">通用匹配：自身能夠檢查</span><br><span class="line">    -s, --src</span><br><span class="line">    #指定源地址</span><br><span class="line">    -d, --dst</span><br><span class="line">    #指定目標地址       </span><br><span class="line">    -p &#123;tcp|udp|icmp&#125;</span><br><span class="line">    #指定協議</span><br><span class="line">    -i eth* </span><br><span class="line">    #指定數據報文流入的接口，可用於自定義鏈，和以下鏈PREROUTING，INPUT，FORWARD</span><br><span class="line">    -o INTERFACE</span><br><span class="line">    #指定數據報文流出的接口，可用於標準定義的鏈和以下鏈OUTPUT,POSTROUTING,FORWARD</span><br><span class="line"></span><br><span class="line">擴展匹配：依賴模塊才能檢查，在/lib/iptables下的.so擴展模塊</span><br><span class="line">	隱含擴展：不用特別指明由哪個模塊進行的擴展，因爲此時使用-p &#123;tcp|udp|icmp&#125;</span><br><span class="line">	-p tcp</span><br><span class="line">		--sport PORT [-PORT]</span><br><span class="line"><span class="meta">		#</span><span class="bash">源端口；可使用連續端口</span></span><br><span class="line">		--dport PORT [-PORT]</span><br><span class="line"><span class="meta">		#</span><span class="bash">目標端口</span></span><br><span class="line">		--tcp-flags mask comp</span><br><span class="line"><span class="meta">		#</span><span class="bash">只檢查mask指定的標志位，是逗號分隔的標志位列表；comp：此列表中出現的標記位必須爲1；comp中沒出現，而mask中出現的，必須爲0；如：</span></span><br><span class="line">		--tcp-flags SYN，FIN，ACK，RST SYN，ACK 等同 --syn選項</span><br><span class="line"><span class="meta">		#</span><span class="bash">檢查tcp報文的 SYN，FIN，ACK，RST標志位，這些標志位中只能是SYN，ACK爲1，其他爲0</span></span><br><span class="line">		--syn：三次握手的第一次</span><br><span class="line">	-p icmp</span><br><span class="line">		--icmp-type</span><br><span class="line"><span class="meta">		#</span><span class="bash">icmp協議報文的類型，主要有0和8兩種,我們ping別人的時候出去的是8進來的是0,別人ping我們的時候進來的是8出去的是0</span></span><br><span class="line">		0：echo-reply	</span><br><span class="line"><span class="meta">		#</span><span class="bash">響應報文</span></span><br><span class="line">		8：echo-request    </span><br><span class="line"><span class="meta">		#</span><span class="bash">請求報文</span></span><br><span class="line">	-p udp</span><br><span class="line">		--sport</span><br><span class="line">		--dport</span><br><span class="line"></span><br><span class="line">	顯式擴展：必須指明由哪個模塊進行的擴展，在iptables中使用-m選項可完成此功能</span><br><span class="line">	-m EXTESTION_NAME -specific-opt(-m 擴展名 擴展選項)</span><br><span class="line">		* state：#狀態擴展</span><br><span class="line">			--state</span><br><span class="line">			結合ip_conntrack追蹤會話的狀態，有四種，跟據IP、連接追蹤</span><br><span class="line">			NEW：#新連接請求</span><br><span class="line">			ESTABLISHED：#已建立的連接</span><br><span class="line">			INVALID：#非法連接請求</span><br><span class="line">			RELATED：#相關聯的</span><br><span class="line">		例：</span><br><span class="line">		-m state --state NEW -j ACCEPT		</span><br><span class="line"><span class="meta">		#</span><span class="bash">只檢查NEW狀態，狀態爲NEW的可以通過</span></span><br><span class="line">		-m state --state NEW,ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">		#</span><span class="bash">狀態爲NEW和ESTABLISHED的全部放行，與地址，協誶無關</span></span><br><span class="line"></span><br><span class="line">		* multiport：#多端口匹配擴展，可實現離散的多端口匹配</span><br><span class="line">			--source-ports：#源端口</span><br><span class="line">			--destination-ports：#目標端口</span><br><span class="line">			--ports：#不論是上面兩種哪一種端口；另外多個端口可用逗號隔開，但最多只能有15個</span><br><span class="line">		例：</span><br><span class="line">		-m multiport --destination-ports 21,22,80 -j ACCEPT</span><br><span class="line">			</span><br><span class="line">		* iprange：#指定IP範圍</span><br><span class="line">			--src-range</span><br><span class="line">			--dst-range</span><br><span class="line">		例：</span><br><span class="line">		iptables -A INPUT -p tcp -m iprange --src-range 172.16.100.3-172.16.100.100 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT			</span><br><span class="line"><span class="meta">		#</span><span class="bash">源IP是100.3到100的，可以訪問目標端口22,狀態要是NEW或ESTABLISHED</span></span><br><span class="line"></span><br><span class="line">		* connlimit：#連接數限定，也就是線程數，如只能使用5個連接請求</span><br><span class="line">			! --connlimit-above n：#connlimit的上限，但這裏是達到n個</span><br><span class="line">		例：本機的web服務器最多允許同時發起兩個請求進來</span><br><span class="line">        iptables -A INPUT -d 172.16.100.7 -p tcp --dport 80 -m connlimit ! --connlimit-above 2 -j ACCEPT</span><br><span class="line">        #這是沒達到2個就允許，所以一般要在--connlimit-above前加！號。如果不加！号，可改ACCEPT的狀態爲DROP或REJECT了</span><br><span class="line"></span><br><span class="line">		* limit</span><br><span class="line">        	--limit RATE：給的是一個速率，如每秒多少人</span><br><span class="line">            --limit-burst：給的是一個上限，第一批可放行多少個</span><br><span class="line">		例：</span><br><span class="line">		iptables -I INPUT -d 172.16.100.7 -p tcp --dport 22 -m limit --limit 3/minute --limit-burst 3 -j ACCEPT	</span><br><span class="line"><span class="meta">		#</span><span class="bash">每分鍾放行3個，最多一次擁入3個</span></span><br><span class="line">		iptables -R INPUT 3 -d 172.6.100.7 -p icmp --icmp-type 8 -m limit --limit 5/minute --limit-burst 6 -j ACCEPT		</span><br><span class="line"><span class="meta">		#</span><span class="bash">修改第三條規則爲限定每分種5個ping請求，但前6個是很快的</span></span><br><span class="line">		測試，連續打開多個ssh連接服務器</span><br><span class="line"></span><br><span class="line">		* string </span><br><span class="line">        	--algo &#123;bm|kmp&#125;：#指定算法</span><br><span class="line">            --string "STRING"：#指定字符串，支持正則</span><br><span class="line">        例：</span><br><span class="line">        vim /var/www/html/test.html</span><br><span class="line">        	h7n9 </span><br><span class="line">            hello world</span><br><span class="line">		iptables -I INPUT -d 172.16.100.7 -m string --algo kmp --string "h7n9" -j REJECT</span><br><span class="line"><span class="meta">		#</span><span class="bash">上面這條是匹配不到的，因爲當用戶的請求中沒有h7n9，請求頁面時，我們響應的報文是從OUTPUT響應出去的，所以應將規則寫在OUTPUT上</span></span><br><span class="line">		iptables -R OUTPUT 1 -s 172.16.100.7 -m string --algo kmp --string "h7n9" -j REJECT</span><br><span class="line"><span class="meta">		#</span><span class="bash">不能訪問有h7n9的頁面 ,-R選項是修改之意。</span></span><br><span class="line"><span class="meta">		#</span><span class="bash">iptables -L -n -v顯示信息中的pkts是匹配到的規則</span></span><br></pre></td></tr></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">管理規則</span><br><span class="line">    -A：#附加一條規則，在鏈的尾部追加</span><br><span class="line">    -I CHAIN [num]：#插入一條規則，可以指定添加在什麼位置，插入爲對應CHAIN上的第num條，如果省略num則插入爲第一條</span><br><span class="line">    -D CHAIN [num]：#刪除指定鏈中的第num條規則；</span><br><span class="line">    -R CHAIN [num]：#替換指定的規則</span><br><span class="line"></span><br><span class="line">管理鏈</span><br><span class="line">    -F [CHAIN]：#flush：清空指定規則鏈，如果省略CHAIN，則可以實現刪除對應表中的所有鏈</span><br><span class="line">    -p CHAIN：#設定指定鏈的默認策略</span><br><span class="line">    -N：#自定義一個新的空鏈</span><br><span class="line">    -X：#刪除一個自定議的空鏈</span><br><span class="line">    -Z：#置零指定鏈中所有規則的計數器</span><br><span class="line">    -E：#重命名自定義的鏈</span><br><span class="line"></span><br><span class="line">查看類</span><br><span class="line">    -L：#顯示指定表中的規則</span><br><span class="line">    -n：#以數字格式顯示主機地址和端口號，與-L一起使用</span><br><span class="line">    -v：#顯示鏈及規則的詳細信息</span><br><span class="line">    -vv：#顯示更詳細的信息</span><br><span class="line">    -x：#顯示計數器的精確值</span><br><span class="line">    --line-numbers：#顯示規則號碼</span><br></pre></td></tr></table></figure>
<h2 id="動作（target）"><a href="#動作（target）" class="headerlink" title="動作（target）"></a>動作（target）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-j TARGET:跳轉</span><br><span class="line">    ACCEPT：#放行</span><br><span class="line">    DROP：#丟棄</span><br><span class="line">    REJECT：#拒絕</span><br><span class="line">    DNAT：#目標地址轉換</span><br><span class="line">    SNAT：#源地址轉換</span><br><span class="line">    REDIRECT：#端口重定向</span><br><span class="line">    MASQUERADE：#地址僞裝</span><br><span class="line">    LOG：#記錄日志</span><br><span class="line">    MARK：#給報文加上標記</span><br><span class="line">注：只要有允許或拒絕，是做過濾的，一定在filter表上</span><br><span class="line"></span><br><span class="line">-j SNAT：#源地址轉換</span><br><span class="line">	--to-source：#轉換成哪個源地址</span><br><span class="line">	</span><br><span class="line">-j MASQUERADE		</span><br><span class="line"><span class="meta">#</span><span class="bash">外網地址是動態獲取時用此選項，它不需要—to-source選項，可以自動查到上外網的地址。</span></span><br><span class="line"></span><br><span class="line">-j DNAT</span><br><span class="line">	--to-destination IP[:port]</span><br></pre></td></tr></table></figure>
<h2 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables規則保存位置，/etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables.tus		</span><br><span class="line"><span class="meta">#</span><span class="bash">保存方法</span></span><br><span class="line">iptables-restore &lt; /etc/sysconfig/iptables.tus		</span><br><span class="line"><span class="meta">#</span><span class="bash">此爲載入方法</span></span><br></pre></td></tr></table></figure>
<h1 id="例"><a href="#例" class="headerlink" title="例"></a>例</h1><h2 id="查看规则"><a href="#查看规则" class="headerlink" title="查看规则"></a>查看规则</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">例：</span><br><span class="line">	iptables -L -n			</span><br><span class="line"><span class="meta">	#</span><span class="bash">默認顯示filter表</span></span><br><span class="line">	iptables -t filter -L -n</span><br><span class="line">	iptables -t nat -L -n</span><br><span class="line">	iptables -t mangle -L -n</span><br><span class="line"><span class="meta">	#</span><span class="bash">顯示內容中的Chain INPUT一項中沒有寫哪個表，默認就是filter表中的規則，policy表示默認策略，ACCEPT表示其爲默認值時只拒絕已知的壞蛋，如果是DROP就是只接受已知的好人。pkts表示被某一條規則所匹配到的數據包的個數，bytes表示字節數</span></span><br></pre></td></tr></table></figure>
<h2 id="测试1"><a href="#测试1" class="headerlink" title="测试1"></a>测试1</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.7 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -t filter -A OUTPUT -s 172.16.100.7 -d 172.16.0.0/16 -p tcp --sport 22 -j ACCEPT</span><br><span class="line">yum install -y httpd vsftpd mysql-server </span><br><span class="line">service httpd start		</span><br><span class="line"><span class="meta">#</span><span class="bash">啓動服務</span></span><br><span class="line">browser測試是否可以打開ip地址</span><br><span class="line"><span class="meta">#</span><span class="bash">修改默認設置爲都不能訪問本機，之前寫的兩條可以訪問本機22端口ssh服務的規則是爲了不讓遠程連接斷開，如果先寫下面的默認規則會使遠程連接斷開，造成麻煩</span></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP</span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -L -n</span><br><span class="line"><span class="meta">#</span><span class="bash">允計所有外部主機訪問本機的80端口，如果web服務比ssh服務訪問量大要放在其上面，所以這裏用-I選項，默認插入在第一行。當地址爲0.0.0.0的時候可以不寫，所以這裏沒有寫-s選項</span></span><br><span class="line">iptables -I INPUT -d 172.16.100.7 -p tcp --dport 80 -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">進規則</span></span><br><span class="line">iptables -L -n		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看規則</span></span><br><span class="line">iptables -L OUTPUT -s 172.16.100.7 -p tcp --sport 80 -j ACCEPT     </span><br><span class="line"><span class="meta">#</span><span class="bash">出規則</span></span><br><span class="line">echo hello &gt; /var/www/html/index.html		</span><br><span class="line"><span class="meta">#</span><span class="bash">添加默認網頁並測試</span></span><br><span class="line"><span class="meta">#</span><span class="bash">因ping請求使用的是icmp協議，所以這時是不能ping通的。因爲ping命令要先從OUTPUT鏈出去再從INPUT鏈進來，所以用本機ping 127.0.0.1也是不通的</span></span><br><span class="line">iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -i lo -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">-i選項是指定從哪個接口流入的請求</span></span><br><span class="line">iptables -A OUTPUT -s 127.0.0.1 -d 127.0.0.1 -o lo -j ACCEPT  </span><br><span class="line"><span class="meta">#</span><span class="bash">-o選項指定從哪個接口流出</span></span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p icmp --icmp-type 8 -j ACCEPT</span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p icmp --icmp-type 0 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">ping別人的時候，出去的是8,進來的是0，別人ping我們的時候，進來的是8,出去的是0；這樣就可以實現我們ping外面的主機了，但別人是ping不了我們的</span></span><br></pre></td></tr></table></figure>
<h2 id="测试2"><a href="#测试2" class="headerlink" title="测试2"></a>测试2</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -j DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">來自172.16.0.0/16網段的報文無論訪問本機哪個地址都被丟棄。-A表示添加一條規則</span></span><br><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.7  -j DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">來自172.16.0.0/16網段訪問100.7的經過INPUT鏈的都被丟棄</span></span><br><span class="line"></span><br><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.7 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -t filter -A OUTPUT -s 172.16.100.7 -d 172.16.0.0/16 -p tcp --sport 22 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##這兩條命令第一條是進第二條是出，在寫規則時一定要把進出都寫上，意思是放行172.16.0.0/16網段的地址訪問172.16.100.7的22號端口ssh服務</span></span></span><br><span class="line"></span><br><span class="line">iptables -L -n -v</span><br><span class="line"><span class="meta">#</span><span class="bash">lsmod命令可以查看啓動的模塊，這裏查看iptables模塊是否啓動，四個表：iptable_mangle、iptable_nat、iptable_raw、iptable_filter</span></span><br><span class="line">modprobe -r 模塊名			</span><br><span class="line"><span class="meta">#</span><span class="bash">注銷或裝載一個模塊</span></span><br><span class="line"><span class="meta">#</span><span class="bash">iptables不是服務，但有服務腳本；服務腳本的主要作用在於管理保存規則，它保存在內核的內存空間上。可以使用lsmod查看iptables的相關模塊是否加載，啓動與停止服務就是裝載及移除iptables/netfilter相關的內核模塊。模塊一般有：iptables_nat, iptables_filter, iptables_mangle, iptables_raw, ip_nat, ip_conntrack； ip_conntrack是當我們啓用nat功能時，每一個地址轉換的相應的返回的報文是要自動管理的，要追蹤每一個地址轉換的報文的，這就是ip_conntrack的功能。</span></span><br></pre></td></tr></table></figure>
<h2 id="测试3"><a href="#测试3" class="headerlink" title="测试3"></a>测试3</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">我們是一個DNS服務器，用戶請求不是我們負責的域，我們就到互聯網找出結果；默認策略INPUT,OUTPUT,FORWARD都是DORP的話，該怎麼寫規則</span><br><span class="line"><span class="meta">#</span><span class="bash">我們是DNS服務器，應該監聽在UDP的53號端口上，當一個客戶端到我們這來請求解析的時候，我們要允許這個請求進來，源地址是客戶端，目標地址是我們的主機，目標端口是53，這應該放行；出去時原端口是53，目標地址是客戶機；但別人請求的是一個不是我們的主機負責的域時，服務器要去找根，它找根時就不是服務器端了，而是客戶端，這就要放行目標端口；當我們作爲客戶端時與這個服務器就沒關系了。這要寫四條規則，而且這只是UDP，它還要監聽在TCP上，所以一共要写八條规则。</span></span><br><span class="line"></span><br><span class="line">作爲web服務器，只開放80端口的響應與放行就可以避免決大多數的攻擊了，80端口應該是只有別人請求進來，它才響應出去。只有這樣反彈式木馬在沒有人請求時才不能響應出去。這種功能在iptables中叫連接追蹤的功能，叫ip_conntrack，這是一個內核模塊，它能時時記錄着主機上客戶端，服務器端彼此正在建立的連接關系，並能追蹤到哪一個連接與其他連接之間處於什麼狀態並有什麼關系，所以上面的情況就可以判定只允許本地主機出去的連接必須爲某一種狀態，必須處於已經建立的連接，也就是必須是對別人的響應我們才允許出去，如果不是響應是決不放行的，這就靠ip_conntrack實現，ip_conntrack可根據IP報文來追蹤TCP和UDP與ICMP的連接。它可以根據請求方與響應方處理什麼過程。在/proc/sys/net/ipv4/ip_conntrack內核文件，它是位於內存當中的，因爲它在proc系統上，這個文件保存有當前系統上每一個客戶端和當前主機與每一個其他主機所建立的連接關系 </span><br><span class="line">cat /proc/sys/net/ipv4/ip_conntrack</span><br><span class="line"><span class="meta">#</span><span class="bash">顯示內容中每條記錄兩個來回的兩個通道的信息，並保存了當前會話所處的狀態。ip_conntrack的這種功能是靠ip_conntrack模塊實現的</span></span><br><span class="line"><span class="meta">#</span><span class="bash">用iptstate命令也可查看到這些信息</span></span><br><span class="line">iptstate -t		</span><br><span class="line"><span class="meta">#</span><span class="bash">顯示當前所有連接的個數</span></span><br><span class="line"><span class="meta">#</span><span class="bash">/proc/sys/net/ipv4/ip_conntrack_max是設置ip_conntrack的同時追蹤的最大值，默認是32768個，超出的連接會被超時丟棄，使用戶無法連接，如果訪問量過大最好不要啓動此模塊，如果不大最好調大此項的值，這個模塊是追蹤已連接的地址的。在iptables停止的狀態下，如果執行iptables -t nat -L命令就要激活ip_conntrack和nfnetlink模塊。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">iptables重啓會清空規則，重新加載/etc/sysconfig/iptables目錄中的文件，使用命令service iptables save可以保存規則。</span></span><br><span class="line"></span><br><span class="line">保存規則：</span><br><span class="line">service iptables save		</span><br><span class="line"><span class="meta">#</span><span class="bash">保存規則</span></span><br><span class="line"><span class="meta">#</span><span class="bash">默認保存在/etc/sysconfig/iptables</span></span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables.***		</span><br><span class="line"><span class="meta">#</span><span class="bash">手動指定保存位置</span></span><br><span class="line">iptables-restore &lt; /etc/sysconfig/iptables.***		</span><br><span class="line"><span class="meta">#</span><span class="bash">因爲手動指定保存位置所以無法加載，要用此條命令指定加載位置</span></span><br></pre></td></tr></table></figure>
<h2 id="開通服務器的sshd-httpd訪問端口"><a href="#開通服務器的sshd-httpd訪問端口" class="headerlink" title="開通服務器的sshd, httpd訪問端口"></a>開通服務器的sshd, httpd訪問端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">一臺服務器，地址172.16.100.7</span><br><span class="line">iptables -F		</span><br><span class="line"><span class="meta">#</span><span class="bash">清空規則</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">放行所有狀態是NEW,ESTABLISHED的訪問22號端口的連接，因爲是進來所以有NEW狀態</span></span><br><span class="line">lsmod | grep ip</span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p tcp --sport 22 -m state –state ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">這是出去所有只有ESTABLISHED已連接狀態</span></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">改變默認策略爲不允許連接</span></span><br><span class="line">iptables -L -n		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看現在的規則</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">再改80端口爲相同的規則</span></span><br><span class="line">iptstate		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看連接狀態</span></span><br><span class="line">sysctl -w net.ipv4.ip_conntrack_max=65536		</span><br><span class="line"><span class="meta">#</span><span class="bash">改最大值，臨時生效，要永久生效要寫在/etc/sysctl.conf中</span></span><br><span class="line">cat /proc/sys/net/ipv4/ip_conntrack_max		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看 </span></span><br><span class="line"><span class="meta">#</span><span class="bash">在/proc/sys/net/ipv4/netfilter目錄中保存了ip_conntrack的很多設置的值，其中的ip_conntrack_tcp_timeout_established中有tcp連接的保持時間，是120小時，這裏的默認單位的秒，建議將此值改小。ip_conntrack是可以追蹤三種協議tcp，udp，icmp，只是對udp，icmp只追蹤超時。</span></span><br><span class="line"></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p icmp --icmp-type 8 -m state --state NEW,ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">進規則</span></span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p icmp --icmp-type 0 -m state --state ESTABLISHED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">出規則</span></span><br><span class="line"><span class="meta">#</span><span class="bash">寫規則時按邏輯寫，像上面兩條是允許外面的主機ping我們的主機，所以要先寫進來的規則再寫出去</span></span><br><span class="line">iptables -L -n --line-numbers		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看規則，--line-numbers是顯示行號</span></span><br><span class="line">iptables -I OUTPUT -s 172.16.100.7 -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">用這一條規則可以檢查所有出去的響應，也就是不用再寫其他出去的規則了，這樣雖然默認的規則是DROP，但這條規則可以規定所有出去的規則</span></span><br><span class="line">iptables -D OUTPUT 2		</span><br><span class="line"><span class="meta">#</span><span class="bash">刪除OUTPUT的第二條</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT		</span><br><span class="line">iptables -A OUTPUT -o lo -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">放行本機的回環地址，因爲ftp服務要通過本機回環地址在mysql數據庫中查詢用戶名密碼，所以要放行才能使用ftp服務或iptables對ftp服務的規則才能生效;ftp服務中PORT表示主動模式，PASV表示被動模式，要使用被動模式因端口是隨機的，所以要使用iptables狀態中的RELATED（相關聯的，與之前的命令有關系）狀態在規則中。如：</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p tcp -m state --state RELATED -j ACCEPT</span><br><span class="line">iptables -R OUTPUT 1 -s 172.16.100.7 -m state --state ESTABLISHED,RELATED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">修改OUTPUT中的第一條</span></span><br><span class="line">iptables -R INPUT 6 -d 172.16.100.7 -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">修改INPUT中的第六條，因爲第一次加這條規則時沒有指明ESTABLISHED狀態，使ftp服務連接後不能查看數據。最後，要先裝載ip_conntrack_ftp和ip_nat_ftp模塊才可進行下面的步驟，裝載方法如下：</span></span><br><span class="line">vim /etc/sysconfig/iptables-config		</span><br><span class="line"><span class="meta">#</span><span class="bash">編輯此文件</span></span><br><span class="line">	IPTABLES_MODULES="ip_nat_ftp ip_conntrack_ftp"   </span><br><span class="line">iptables -I INPUT -d 172.16.100.7 -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">用這一條規則先來判斷連接的狀態，符合的就放行，這樣可以讓之後的規則不必再寫這兩種狀態</span></span><br><span class="line">service iptables save</span><br><span class="line">vim /etc/sysconfig/iptables		</span><br><span class="line"><span class="meta">#</span><span class="bash">直接編輯此文件來修改規則，刪除INPUT其他規則中的RELATED和ESTABLISHED</span></span><br><span class="line">service iptables reload</span><br><span class="line">iptables -L -n</span><br><span class="line">iptables -I INPUT 2 -d 172.16.100.7 -p tcp -m multiport --destination-ports 21,22,80 -m state --state NEW -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">加入到INPUT中的第二條，只要是21,22,80端口爲NEW狀態的就放行；另外，之前所有命令中都可以用！號取反，如：</span></span><br><span class="line">    -s ！ 172.16.100.7		</span><br><span class="line">    #表示除了100.7都可以</span><br><span class="line">	</span><br><span class="line">	-j TARGET</span><br><span class="line">		LOG：記錄日志信息，log與DROP、ACCEPT使用時要放在前面</span><br><span class="line">            --log-prefix "STRING"		</span><br><span class="line">            #指定LOG日志的前綴</span><br><span class="line"><span class="meta">			#</span><span class="bash">記日志最好加上速率限定，不然記錄太多，產生大量磁盤IO,使性能下降</span></span><br><span class="line">例：</span><br><span class="line">iptables -I INPUT 4 -d 172.16.100.7 -p icmp --icmp-type 8 -j LOG --logprefix "--firewall log for icmp--"</span><br><span class="line"><span class="meta">#</span><span class="bash">記錄ping本機的日志，在日志中加上一個字符串<span class="string">"--firewall log for icmp--"</span></span></span><br></pre></td></tr></table></figure>
<h2 id="自定義規則鏈並在主鏈中被調用"><a href="#自定義規則鏈並在主鏈中被調用" class="headerlink" title="自定義規則鏈並在主鏈中被調用"></a>自定義規則鏈並在主鏈中被調用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">iptables -N clean_in			</span><br><span class="line"><span class="meta">#</span><span class="bash">新建一條叫clean_in的規則鏈，其中references表示引用，也就是被主鏈調用</span></span><br><span class="line">iptables -A clean_in -d 255.255.255.255 -p icmp -j DROP         </span><br><span class="line"><span class="meta">#</span><span class="bash">添加一條規則</span></span><br><span class="line">iptables -L -n –line-numbers</span><br><span class="line">iptables -A clean_in -d 172.168.255.255 -p icmp -j DROP</span><br><span class="line">iptables -A clean_in -p tcp ! --syn -m state --state NEW -j DROP</span><br><span class="line">iptables -A clean_in -p tcp --tcp-flags ALL ALL -j DROP</span><br><span class="line">iptables -A clean_in -p tcp --tcp-flags ALL NONE -j DROP</span><br><span class="line">iptables -A clean_in -d 172.16.100.7 -j RETURN		</span><br><span class="line"><span class="meta">#</span><span class="bash">返回到主鏈上去</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -j clean_in</span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -o lo -j ACCEPT</span><br><span class="line">iptables -A INPUT -i eth0 -m multiport -p tcp --dports 53,113,135,137,139,445 -j DROP</span><br><span class="line">iptables -A INPUT -i eth0 -m multiport -p udp --dports 53,113.135.137.139.445 -j DROP</span><br><span class="line">iptables -A INPUT -i eth0 -p udp --dport 1026 -j DROP</span><br><span class="line">iptables -A INPUT -i eth0 -m multiport -p tcp --dports 1433,4899 -j DROP</span><br><span class="line">iptables -A INPUT -p icmp -m limit --limit 10/second -j ACCEPT</span><br><span class="line">iptables -I INPUT -j clean_in      </span><br><span class="line"><span class="meta">#</span><span class="bash">無論什麼地址，先交給clean_in處理一遍，clean_in如果沒有問題再返回主鏈第二條進行處理；如果要刪除自定義鏈要先刪除其中的鏈規則，再刪除自定義的鏈</span></span><br></pre></td></tr></table></figure>
<h2 id="利用iptables的recent模块来抵御DOS攻击"><a href="#利用iptables的recent模块来抵御DOS攻击" class="headerlink" title="利用iptables的recent模块来抵御DOS攻击"></a>利用iptables的recent模块来抵御DOS攻击</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ssh远程连接</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 3 -j DROP</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">利用connlimit模块将单IP的并发设置为3，会误杀使用NAT上网的用户，可以根据实际情况增大该值</span></span><br><span class="line"><span class="meta">#</span><span class="bash">利用recent和state模块限制单IP在300s内只能与本机建立3个新连接，被限制五分钟后即可恢复访问</span></span><br><span class="line">下面对最后两名做一个说明：</span><br><span class="line"><span class="meta">#</span><span class="bash">第二句是记录访问tcp22端口的新连接，记录名为SSH。--<span class="built_in">set</span>记录数据包的来源IP，如果IP已经存在将更新已经存在的条目</span></span><br><span class="line"><span class="meta">#</span><span class="bash">第三句是指SSH记录中的IP，300s内发起超过3次连接则拒绝此IP的连接。--update是指每次建立连接都更新列表；--seconds必须与--rcheck或者--update同时使用；--hitcount必须与--rcheck或者--update同时使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash">iptables的记录：/proc/net/ipt_recent/SSH</span></span><br><span class="line"><span class="meta">#</span><span class="bash">也可以使用下面的这句记录日志：</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --name SSH --second 300 --hitcount 3 -j LOG --log-prefix "SSH Attack"</span><br></pre></td></tr></table></figure>
<h2 id="测试4"><a href="#测试4" class="headerlink" title="测试4"></a>测试4</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">試驗在虛擬機中建三臺主機，一臺linux主機，一塊網卡橋接；一臺linux路由，一塊網卡橋接，地址172，一塊網卡用HOST ONLY,地址192；一臺win主機，網卡用HOST ONLY；這時linux主機可與linux路由通信，因爲都是橋接網卡；win主機也可與linux路由通信，因爲是HOST ONLY；而且兩臺主機可以ping通路由上的任一個地址，因爲路由上的兩個地址在一臺主機上，即使不在一個網段也可以通信。但linux主機不能與win主機通信，因爲沒有路由，這時改路由的/proc/sys/net/ipv4/ip_forward項爲1，那麼這臺主機就具有了路由功能。再將兩臺主機的網關指向路由的兩個IP地址，這時就能通信了，這時是用不到NAT功能的。因爲要與公網通信，私網地址不能在公網上路由，所以才用NAT；需要轉換時路由的NAT功能會自動完成，在做源地址轉換時也會做目標地址轉換，只是目標地址轉換是自動進行的</span><br></pre></td></tr></table></figure>
<h2 id="源地址转换"><a href="#源地址转换" class="headerlink" title="源地址转换"></a>源地址转换</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j SNAT --to-source 172.16.100.7	</span><br><span class="line"><span class="meta">#</span><span class="bash">要在nat表中創建，鏈是POSTROUTING。此条命令指對服務器來講，任何源地址是192.168.10.0/24網段的地址都轉換爲172.16.100.7。--to-source選項可指定一個地址範圍，如****-****，兩個地址間用橫線隔開來表示</span></span><br><span class="line">tcpdump -i eth0 -nn -X icmp</span><br><span class="line"><span class="meta">#</span><span class="bash">到10.7抓包</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT –to-source 123.2.3.2</span><br><span class="line"><span class="meta">#</span><span class="bash">在服務器上寫一條規則，讓所有同學可以訪問互聯網的任一網絡，公網IP地址是123.2.3.2</span></span><br></pre></td></tr></table></figure>
<h2 id="测试5"><a href="#测试5" class="headerlink" title="测试5"></a>测试5</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -s 192.168.10.0/24 -p icmp -j REJECT		</span><br><span class="line"><span class="meta">#</span><span class="bash">禁止192.168.10.0/24網段主機ping外網，此規則只是禁止了主機之間的ping，而沒有進入中間的防火牆服務器，所以不經過INPUT或OUTPUT進入服務器，而只是經過服務器轉發FORWARD</span></span><br></pre></td></tr></table></figure>
<h2 id="测试6"><a href="#测试6" class="headerlink" title="测试6"></a>测试6</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -A FORWARD -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">如果是已建立的連接都放行</span></span><br><span class="line">iptables -A FORWARD -s 192.168.10.0/24 -p tcp --dport 80 -m state --state NEW -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">出去的規則，如果訪問的是web服務都放行，這是只能從內網出去的，外網是進不來的</span></span><br><span class="line">IPTABLES -A FORWARD -s 192.168.10.0/24 -p icmp --icmp-type 8 -m state --state NEW -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">放行ping，可以ping其他主機。這是只能從內網出去的，外網是進不來的</span></span><br><span class="line">iptables -A FORWARD -s 192.168.10.0/24 -p tcp --dport 21 -m state --state NEW -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">放行ftp服務</span></span><br><span class="line">iptables -R FORWARD 1 -m state --state ESTABLISHED,RELATED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">用上面兩條規則可開放ftp服務，但不要忘記在/etc/sysconfig/iptables-config中加載ip_nat_ftp和ip_nat模塊</span></span><br></pre></td></tr></table></figure>
<h2 id="目标地址转换"><a href="#目标地址转换" class="headerlink" title="目标地址转换"></a>目标地址转换</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -d 172.16.100.7 -p tcp --dport 80 -j DNAT --to-destination 192.168.10.22		</span><br><span class="line"><span class="meta">#</span><span class="bash">目標地址轉換要在PREROUTING上做。訪問172主機80端口都以192的80端口返回結果，且只在請求80服務時才轉發</span></span><br><span class="line">iptables -t nat -R PREROUTING 1 -d 172.16.100.7 -p tcp --dport 80 -j DNAT --to-destination 192.168.10.22:8080	</span><br><span class="line"><span class="meta">#</span><span class="bash">改上一條規則，訪問172主機80端口的訪問結果都以192的8080端口返回，這就是PNAT：Port NAT 端口映射或端口轉換</span></span><br><span class="line">iptables -A FORWARD -m string --algo kmp --string "h7n9" -j DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">涉及到轉發與本機無關時一定是在FORWARD鏈上。這時沒有寫協議，所以是禁止訪問任何內容中有h7n9的</span></span><br></pre></td></tr></table></figure>
<h2 id="iptables脚本"><a href="#iptables脚本" class="headerlink" title="iptables脚本"></a>iptables脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">ipt=/usr/sbin/iptables</span><br><span class="line">einterface=eth1</span><br><span class="line">iinterface=eth0</span><br><span class="line"></span><br><span class="line">eip=172.16.100.7</span><br><span class="line">iip=192.168.10.6</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -t nat -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -t filter -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -t mangle -F</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -N clean_up</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -A clean_up -d 255.255.255.255 -p icmp -j DROP</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -A clean_up -j RETURN</span></span><br></pre></td></tr></table></figure>
<h2 id="测试7"><a href="#测试7" class="headerlink" title="测试7"></a>测试7</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -j LOG --log-prefix "Denied ICMP:" --log-level 7</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">每秒只响应一次ping，超过的记录日志并丢弃</span></span><br><span class="line">iptables -A INPUT -i eth0 -p icmp --icmp-type echo-request -m statistic --mode nth --every 2 --packet 0 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">每两个<span class="built_in">echo</span>-request就丢弃一个</span></span><br></pre></td></tr></table></figure>
<h2 id="测试8"><a href="#测试8" class="headerlink" title="测试8"></a>测试8</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">不允许接受icmp数据包到本地</span></span><br><span class="line">iptables -A INPUT -p all -m state --state INVALID -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">不允许发送未知数据包到本地</span></span><br><span class="line">iptables -A INPUT all -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">允许已经允许过的连接和被动请求数据包发送到本地</span></span><br><span class="line">iptables -A INPUT -p tcp --syn --dport 22 -m state --state NEW -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">检查该连接中第一个数据包，并检查该数据包是否包含syn标记，符合两项条件才允许进入。</span></span><br><span class="line">iptables -A INPUT -p tcp --syn -m state --state NEW -m multiport --dport 21,22,23,24,25 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">使用Multiport模块一次添加多个端口</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL SYN,FIN -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">检查所有 TCP-Flags，但只有syn及fin两个标记同时为1时，数据包才会被筛选出来</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">检查所有 TCP-Flags中syn及fin两个标记同时为1时，数据包才会被筛选出来</span></span><br></pre></td></tr></table></figure>
<h2 id="数据指添加"><a href="#数据指添加" class="headerlink" title="数据指添加"></a>数据指添加</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /root/mac_list.txt | while read MAC</span><br><span class="line">do     </span><br><span class="line">	MAC=$( echo $MAC | awk '&#123;print $1&#125;' )      </span><br><span class="line">	iptables -t filter -A FORWARD -i eth1 -o eth0 -m mac --mac-source $MAC -j ACCEPT</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="mangle表用法-MARK模块匹配（单数据包）"><a href="#mangle表用法-MARK模块匹配（单数据包）" class="headerlink" title="mangle表用法 MARK模块匹配（单数据包）"></a>mangle表用法 MARK模块匹配（单数据包）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -A PREROUTING -p tcp --dport 80 -j MARK --set-mark 80</span><br><span class="line">iptables -A FORWARD -p all -m mark --mark 80 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="管理用户或组模块"><a href="#管理用户或组模块" class="headerlink" title="管理用户或组模块"></a>管理用户或组模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A　OUTPUT -p tcp -m owner --uid--owner tom --dport 80 -j ACCEPT</span><br><span class="line">iptables -A　OUTPUT -p udp -m owner --uid--owner tom --dport 53 -j ACCEPT</span><br><span class="line">iptables -A　OUTPUT -p all -m owner --uid--owner tom -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="使用iprange模块添加ip范围"><a href="#使用iprange模块添加ip范围" class="headerlink" title="使用iprange模块添加ip范围"></a>使用iprange模块添加ip范围</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m iprange --src-range 192.168.0.2-192.168.0.61 -j DROP</span><br><span class="line">iptables -A INPUT -m iprange --dst-range 192.168.0.2-192.168.0.61 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="ttl值匹配模块"><a href="#ttl值匹配模块" class="headerlink" title="ttl值匹配模块"></a>ttl值匹配模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m ttl --ttl-eq 64 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash">--ttl<span class="_">-eq</span> 等于</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--ttl<span class="_">-lt</span> 小于</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--ttl<span class="_">-gt</span> 大于</span></span><br></pre></td></tr></table></figure>
<h2 id="IPSEC-SPI-值控制模块"><a href="#IPSEC-SPI-值控制模块" class="headerlink" title="IPSEC SPI 值控制模块"></a>IPSEC SPI 值控制模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -p ah -m ah --ahspi 300 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p esp -m esp --espspi 200 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h2 id="pkttype模块"><a href="#pkttype模块" class="headerlink" title="pkttype模块"></a>pkttype模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -p icmp -m pkttype --pky-type broadcast -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">unicast:数据包发送的对象时特定的，如主机A传输给主机B即为unicast类型</span></span><br><span class="line"><span class="meta">#</span><span class="bash">broadcast:数据包传送的对象为广播地址，如192.168.0.255</span></span><br><span class="line"><span class="meta">#</span><span class="bash">multicast:通常应用于网络的“音频”或“视频”广播，而Multicast数据包的特点是，其Source IP一定介于224.0.0.0/24之间。</span></span><br></pre></td></tr></table></figure>
<h2 id="length模块"><a href="#length模块" class="headerlink" title="length模块"></a>length模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp -type 8 -m length --length 92 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp -type 8 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">MTU=(IP包+ICMP包+DATA)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--length 50 匹配MTU值刚好为50字节的数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--length :100 匹配MTU值小于100个字节的数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--length 50:100 匹配MTU值介于50-100个字节的数据包</span></span><br></pre></td></tr></table></figure>
<h2 id="limit数据包重复率匹配"><a href="#limit数据包重复率匹配" class="headerlink" title="limit数据包重复率匹配"></a>limit数据包重复率匹配</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -m limit --limit 6/m --limit-burst 10 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">一分钟进入10个数据包以上，就会限制一分钟进入6个数据包，直到6*10s内没有收到数据包，将会解除</span></span><br></pre></td></tr></table></figure>
<h2 id="recent模块"><a href="#recent模块" class="headerlink" title="recent模块"></a>recent模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -m recent --name icmp_db --rcheck --second 60 --hitcount 6 -j DROP</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -m recent --set --name icmp_db</span><br><span class="line">cat /proc/net/xt_recent/icmp_db</span><br><span class="line">modprobe xt_recent ip_list_tot=1024 ip_pkt_list_tot=50</span><br><span class="line"><span class="meta">#</span><span class="bash">ip_list_tot设置ip上限条数，默认100</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ip_pkt_list_tot设置数据存储空间，默认20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">--name 设置跟踪数据库的文件名</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--<span class="built_in">set</span>将符合条件的来源数据添加到数据库中，但如果来源端数据已经存在，则更新数据库中的记录信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--rcheck只进行数据库中信息的匹配，并不会对已存在的数据做任何变更操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--update如果来源端的数据已存在，则将其更新；若不存在，则不做任何处理</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--remove如果来源端数据已存在，则将其删除，若不存在，则不做任何处理</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--seconds seconds当事件发生时，只会匹配数据库中前“几秒”内的记录，--seconds必须与--rcheck或--update参数共用</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--hitcount hits匹配重复发生次数，必须与--rcheck或--update参数共用</span></span><br></pre></td></tr></table></figure>
<h2 id="string模块-匹配字符串"><a href="#string模块-匹配字符串" class="headerlink" title="string模块 匹配字符串"></a>string模块 匹配字符串</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp -d $WEB_SERVER --dport 80 -m string --algo bm --string "system32" -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">--algo 字符串匹配算法的选择，string模块提供了两种不同的算法，分别是bm(Boyer-Moore)及kmp(Knuth-Pratt-Morris),其中bm算法平均速度会比kmp快，不过，你也不必太在意，因为我们匹配的对象不会太大，因此用哪种都差不多</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--from、--to设置匹配字符串的范围，我们可以使用--from来设置匹配的起点，并以--to来设置匹配的终点，其单位为字节，如--from 10意为从第10个字符串开始匹配，如果没有设置这个参数，那么匹配的范围将是整个数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--string匹配条件，如--string <span class="string">"system32"</span>是指要匹配的字符串为system32</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--hex-string匹配条件，但不同于--string参数的地方在于--hex-string是以16进制的方式进行匹配，特别适合用于非ascii字符串的匹配，其匹配条件的表示方法为--hex-string <span class="string">"|2e2f303132333435|"</span>，请注意实际匹配条件为2e2f303132333435，但其左右要使用<span class="string">"|"</span>符号</span></span><br></pre></td></tr></table></figure>
<h2 id="connlimit模块-匹配连接数"><a href="#connlimit模块-匹配连接数" class="headerlink" title="connlimit模块 匹配连接数"></a>connlimit模块 匹配连接数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp --syn -d $Web_Server --dport 80 -m connlimit --connlimit-above 30 --connlimit-mask 32 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--connlimit-above 指定最大连接数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--connlimit-mask 此参数为子网络掩码，用于匹配范围，例如 8A 16B 24C 25 1/2个c 32代表单一个IP</span></span><br></pre></td></tr></table></figure>
<h2 id="connbytes模块限制每个连接中所能传输的数据量"><a href="#connbytes模块限制每个连接中所能传输的数据量" class="headerlink" title="connbytes模块限制每个连接中所能传输的数据量"></a>connbytes模块限制每个连接中所能传输的数据量</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -p tcp -d $Web_Server --dport 80 -m connbytes --connbytes-dir reply --connbytes-mode bytes --connbytes 20971520: -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--connbytes-dir original来源方向 reply应答方向 both双向</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--connbytes-mode packets以数据包的数量来计算 bytes以数据量来计算</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--connbytes 10:匹配10个以上的单位量 :50匹配50个一下的单位量 10:50匹配10个-50个之间的单位量</span></span><br></pre></td></tr></table></figure>
<h2 id="quota模块-匹配每个ip限制流量（不会清除纪录，要刷新纪录）"><a href="#quota模块-匹配每个ip限制流量（不会清除纪录，要刷新纪录）" class="headerlink" title="quota模块 匹配每个ip限制流量（不会清除纪录，要刷新纪录）"></a>quota模块 匹配每个ip限制流量（不会清除纪录，要刷新纪录）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp --sport 80 -m quota --quota 524288000 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp --sport 80 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="time模块-设置规则生效时间"><a href="#time模块-设置规则生效时间" class="headerlink" title="time模块 设置规则生效时间"></a>time模块 设置规则生效时间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -o eth1 -d $SRV_FARM -m time --weekdays Mon,Tue,Wed,Thu,Fri --timestart 09:00 --timestop 21:00 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -o eth1 -d $SRV_FARM -j DROP </span><br><span class="line"><span class="meta">#</span><span class="bash">--datestart:YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--datestop</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--timestart:hh:mm[:ss]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--timestop</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--monthdays:day[,day]...1,2,3,4,5,6,7,8,9,10,31</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--weekdays:day[,day]...Mon,Tue,Wed,Thu,Fri,Sat,Sun</span></span><br></pre></td></tr></table></figure>
<h2 id="connmark模块匹配mark值（整条连接）"><a href="#connmark模块匹配mark值（整条连接）" class="headerlink" title="connmark模块匹配mark值（整条连接）"></a>connmark模块匹配mark值（整条连接）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m connmark --mark 1 -j DROP </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">conntrack模块匹配数据包状态，是state模块的加强版</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctstate:匹配数据包的状态，状态列表分别为NEW,ESTABLISHED,RELATED,INVALID,DNAT,SNAT</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctproto:用于匹配OSI七层中第四层的通信层，其功能与用法就如同iptables中的-p参数，如-p tcp,-p udp,-p 47等。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigsrc匹配连接发起方向的来源端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigdst匹配连接发起方向的目的端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctreplsrc匹配数据包应答方向的来源端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctrepldst匹配数据包应答方向的目的端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigsrcport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigdstport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctreplsrcport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctrepldstport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctexpire连接在Netfilter Conntrack数据库(/porc/net/nf_conntrack)的存活时间，使用方法如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">匹配特定的存活时间--ctexpire time</span></span><br><span class="line"><span class="meta">#</span><span class="bash">匹配特定区间的存活时间--ctexpire time:time</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--ctdir设置要匹配那个方向的数据包，使用方法如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">只匹配连接发起方向的数据包--ctdir ORIGINAL</span></span><br><span class="line"><span class="meta">#</span><span class="bash">只匹配数据包应答方向的数据包--ctdir REPLY</span></span><br><span class="line"><span class="meta">#</span><span class="bash">若没有设置这个参数，默认会匹配双向的所有数据包</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">iptables -F</span><br><span class="line">modprobe nf_conntrack_ftp</span><br><span class="line">iptables -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -s 192.168.1.0/24 --dport 21 -m state --state NEW -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 21 -j DROP </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">iptables -F</span><br><span class="line">modprobe nf_conntrack_ftp</span><br><span class="line">iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -m conntrack --ctproto tcp --ctorigsrc 192.168.1.0/24 --ctorigdstport 21 --ctstate NEW -j ACCEPT</span><br><span class="line">iptables -A INTPU -p tcp --dport 21 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="statistic模块进行比例匹配"><a href="#statistic模块进行比例匹配" class="headerlink" title="statistic模块进行比例匹配"></a>statistic模块进行比例匹配</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">以随机方式丢弃50%的数据包</span><br><span class="line">iptables -A INPUT -p icmp -m statistic --mode random --probability 0.5 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">按一定规律在每10个icmp包中丢弃1个icmp包</span></span><br><span class="line">iptables -A INPUT -p icmp -m statistic --mode nth --every 10 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">--mode:random以随机方式丢弃数据包，nth按一定规律丢弃数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--probability:此参数需结合random模式使用，例如--probability 0.4 即代表丢弃40%的数据，其中的数值为0-1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--every此参数需结合nth模式使用，例如--every 10代表在每10个数据包中要丢弃1个数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--packet此参数需要在nth模式与--every参数结合使用，例如--every 10 --packet5</span></span><br></pre></td></tr></table></figure>
<h2 id="layer7-–-17"><a href="#layer7-–-17" class="headerlink" title="layer7 – 17"></a>layer7 – 17</h2>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/27/iptables概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/27/iptables概念/" itemprop="url">
                  iptables概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-27 10:49:11" itemprop="dateCreated datePublished" datetime="2018-09-27T10:49:11+08:00">2018-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-15 10:11:00" itemprop="dateModified" datetime="2019-01-15T10:11:00+08:00">2019-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="防火墙概念"><a href="#防火墙概念" class="headerlink" title="防火墙概念"></a>防火墙概念</h1><ul>
<li><p>主机防火墙：针对于单个主机进行防护。</p>
</li>
<li><p>网络防火墙：往往处于网络入口或边缘，针对于网络入口进行防护，服务于防火墙背后的本地局域网。网络防火墙和主机防火墙并不冲突，可以理解为，网络防火墙主外（集体）， 主机防火墙主内（个人）。</p>
</li>
<li><p>iptables是工作在linux内核中的网络防火墙，netfilter才是防火墙真正的安全框架（framework），iptables和netfilter是一组工具，真正起到防火墙作用的是netfilter，netfilter是内核中的一個過濾框架，iptables是一個生成防火牆規則，並能將其符加在netfilter上，真正實現數據報文過濾、NAT、mangle等規則生成的工具。</p>
</li>
<li><p>防火牆工作在主機或網絡的邊緣，對進出的數據報文進行檢查監控，按事先定義的規則進行相應處理。防火牆可以是硬件或軟件，規則包括匹配標準和處理辦法。</p>
</li>
<li><p>防火牆規則必須放在內核上，因爲我們是不能和內核打交道的，有人在內核的TCP/IP協議棧上開放了幾個位置，開放給用戶空間的應用程序</p>
</li>
<li><p>netfile就是內核中可以放規則的位置；iptables是工作在用戶空間可以寫規則並可通過系統調用放置在內核相應位置的應用程序；報文流向有三種：進來的，出去的和轉發的，在<code>/proc/sys/net/ipv4/ip_forward</code>中就是定義是否轉發的；根據IP地址完成路由表中的路由決策，無論從哪進來的只要到了TCPIP協議棧後，下一個就是路由決策</p>
</li>
<li><p>Netfilter是Linux操作系统核心层内部的一个数据包处理模块，它具有如下功能：</p>
<p>网络地址转换(Network Address Translate)</p>
<p>数据包内容修改</p>
<p>以及数据包过滤的防火墙功能</p>
</li>
</ul>
<h1 id="iptables概念"><a href="#iptables概念" class="headerlink" title="iptables概念"></a>iptables概念</h1><ul>
<li>当客户端访问服务器的web服务时，客户端发送报文到网卡，而tcp/ip协议栈是属于内核的一部分，所以，客户端的信息会通过内核的TCP协议传输到用户空间中的web服务中，而此时，客户端报文的目标终点为web服务所监听的套接字（IP：Port）上，当web服务需要响应客户端请求时，web服务发出的响应报文的目标终点则为客户端，这个时候，web服务所监听的IP与端口反而变成了原点，我们说过，netfilter才是真正的防火墙，它是内核的一部分，所以，如果我们想要防火墙能够达到”防火”的目的，则需要在内核中设置关卡，所有进出的报文都要通过这些关卡，经过检查后，符合放行条件的才能放行，符合阻拦条件的则需要被阻止，于是，就出现了input关卡和output关卡，而这些关卡在iptables中不被称为”关卡”,而被称为”链”。当客户端发来的报文访问的目标地址是其他服务器时，本机的内核要支持IP_FORWARD，我们就可以将报文转发给其他服务器，所以，这个时候，我们就会提到iptables中的其他”链”，他们就是  “路由前”、”转发”、”路由后”，他们的英文名是：PREROUTING、FORWARD、POSTROUTING。如果报文需要转发，那么报文则不会经过input链发往用户空间，而是直接在内核空间中经过forward链和postrouting链转发出去的。</li>
</ul>
<p><img src="/images/iptables/朱双印2.jpg"></p>
<ul>
<li><p>报文的流向：</p>
<p>到本机某进程的报文：PREROUTING –&gt; INPUT</p>
<p>由本机转发的报文：PREROUTING –&gt; FORWARD –&gt; POSTROUTING</p>
<p>由本机的某进程发出报文（通常为响应报文）：OUTPUT –&gt; POSTROUTING</p>
</li>
<li><p>将具有相同功能的规则放在一起就是“表”</p>
</li>
<li><p>hook function：鈎子函數，有五個位置。分別是input（進）, output（出）, forward（轉發）, prerouting（路由做出前）, postrouting（路由之後再發出）</p>
</li>
<li><p>鈎子函數的規則鏈：INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING；</p>
</li>
<li><p>PREROUTING的规则可以存在于：raw表，mangle表，nat表。</p>
<p>INPUT的规则可以存在于：mangle表，filter表，（centos7中还有nat表，centos6中没有）。</p>
<p>FORWARD的规则可以存在于：mangle表，filter表。</p>
<p>OUTPUT的规则可以存在于：raw表，mangle表，nat表，filter表。</p>
<p>POSTROUTING的规则可以存在于：mangle表，nat表。</p>
</li>
<li><p>filter表：INPUT，OUTPUT，FORWARD；负责过滤功能；内核模块：iptables_filter</p>
</li>
<li><p>nat表：PREROUTING，POSTROUTING，OUTPUT（centos7中还有INPUT，centos6中没有）；network address translation，网络地址转换功能；内核模块：iptable_nat</p>
</li>
<li><p>mangle表：INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING；拆解报文，做出修改，并重新封装報文首部的功能；内核模块：iptable_mangle</p>
</li>
<li><p>過濾與mangle是不能放在一起的；</p>
</li>
<li><p>raw表：PREROUTING，OUTPUT；关闭nat表上启用的连接追踪机制；iptable_raw</p>
</li>
<li><p>iptables为我们定义了4张”表”,当他们处于同一条”链”时，执行的优先级如下。</p>
<p>优先级次序（由高而低）：</p>
<p>raw –&gt; mangle –&gt; nat –&gt; filter</p>
<p>某些链天生就不能使用某些表中的规则，所以，4张表中的规则处于同一条链的目前只有output链</p>
</li>
<li><p>数据转发流程</p>
</li>
</ul>
<p><img src="/images/iptables/朱双印数据转发流程.jpg"></p>
<ul>
<li>INPUT、OUTPUT是從內核空間到用戶空間實現過濾的，是主機防火牆設置，通過本機轉發的通過FORWARD鏈，是網絡防火牆的設置。路由的轉發功能可以是一臺主機上的兩個網段的地址。一臺交換機上可以配置多個網段的地址，但它們之間不能通信，但如果不同網段的主機的網關指向了一臺網關服務器上一塊網卡的兩個不同網段的地址，且服務器上開通了路由的功能，那麼就可以通信了；因爲IP地址不是屬於網卡的，而是屬於主機的，所以一塊網卡可以连接兩個網絡</li>
<li>啓用了ip_forward鏈，默認所有報文都要轉發</li>
<li>應該隔離可以被公網訪問的主機與不能被公網訪問的主機，如在網關服務器上放三塊網卡，其中一塊是面對互聯網的，另一塊是面對內網的，最後一塊面對服務器，開放互聯網訪問時只能從面對互聯網的網卡到面對服務器的網卡；所有在面對內網網卡上的報文要想進來必須得是一個響應，其他不允許，網關服務器被叫做三宿主的主機</li>
<li>netfilter：是一個框架，在TCP/IP協議橈上有5個鈎子函數分別對應5個規則鏈，工作在內核中。不能手動向netfilter中添加數據，要用iptables編寫規則送達netfilter的某個鏈上，但它必須先屬於某張表。默認表是filter，還有nat、mangle表</li>
<li>目標地址轉換在進入時改，源地址轉換在出去的時候改。</li>
<li>可以使用自定義鏈，但只在被默認鏈調用時才能發揮作用，而且如果沒有自定義鏈中的任何規則匹配，還應該有返回機制。用戶可以刪除自定義的空鏈，默認鏈不能刪除。</li>
<li>每個規則都有兩個內置的計數器，一個記錄被匹配的報文個數，一個記錄被匹配的報文大小之和</li>
<li>DNAT：目標地址轉換，轉換IP報文中的目標IP地址。目標地址轉換DNAT，指在返回結果時將地址轉換爲請求的地址。如一臺服務器上沒有服務，但将其設置成轉換到后端兩臺服務器的地址，一臺80一臺21,用户訪問時訪問的是這臺沒有服務的主機，但返回結果是有服務的兩臺主機的內容，在返回結果時就要將地址轉換成沒有服務的主機的IP。也就是当用户访问一个地址时，这个地址本没有服务，但可将此请求转到相应的地址服务上，并在服务返回结果时自动将源地址转为用户请求的地址，这就是目标地址转换。源地址转换与目标地址转换效果相反。我们只操作一半，另一半转换由服务器自动完成</li>
<li>SNAT：源地址轉換，轉換IP報文中的源IP地址（可在POSTROUTING或OUTPUT上做，對網關來講只在POSTROUTING上作）。雖然稱爲源地址轉換，但目標IP地址也會轉換，只不過回程的目標地址會轉換</li>
<li>在互聯網上發送報文的時候，無論經過任何路由設備源IP與目標IP是不會改變的</li>
<li>對linux主機而言，IP地址是屬於主機的，不屬於網卡,配在什麼網卡上並不重要，關鍵是是否屬於這臺主機，無論是否打開轉發功能。這裏所說指一臺主機ping自己的網關地址，在網關這臺主機上的IP網關地址即使不在一個網段上也沒有開轉發功能，同樣可以被ping通。只有在ping第三臺網關指向這臺網關主機另一個網段IP的主機時，才需要轉發。</li>
<li>對linux主機而言，IP地址是屬於主機的，不屬於網卡,配在什麼網卡上並不重要，關鍵是是否屬於這臺主機，無論是否打開轉發功能。這裏所說指一臺主機ping自己的網關地址，在網關這臺主機上的IP網關地址即使不在一個網段上也沒有開轉發功能，同樣可以被ping通。只有在ping第三臺網關指向了這臺網關主機另一個網段IP的主機時，才需要轉發。</li>
<li>涉及到轉發與本機無關時一定是在FORWARD鏈上做</li>
<li>iptables在二三四層上進行過濾</li>
</ul>
<h2 id="处理动作"><a href="#处理动作" class="headerlink" title="处理动作"></a>处理动作</h2><ul>
<li><p>ACCEPT：允许数据包通过。</p>
</li>
<li><p>DROP：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应。</p>
</li>
<li><p>REJECT：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。</p>
</li>
<li><p>SNAT：源地址转换，解决内网用户用同一个公网地址上网的问题。</p>
</li>
<li><p>MASQUERADE：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上。</p>
</li>
<li><p>DNAT：目标地址转换。</p>
</li>
<li><p>REDIRECT：在本机做端口映射。</p>
</li>
<li><p>LOG：在/var/log/messages文件中记录日志信息，然后将数据包传递给下一条规则，也就是说除了记录以外不对数据包做任何其他操作，仍然让下一条规则去匹配。</p>
</li>
</ul>
<h2 id="四表五链"><a href="#四表五链" class="headerlink" title="四表五链"></a>四表五链</h2><ul>
<li><p>filter表——过滤数据包</p>
</li>
<li><p>Nat表——用于网络地址转换（IP、端口）</p>
</li>
<li><p>Mangle表——修改数据包的服务类型、TTL、并且可以配置路由实现QOS</p>
</li>
<li><p>Raw表——决定数据包是否被状态跟踪机制处理</p>
</li>
</ul>
<ul>
<li>INPUT链——进来的数据包应用此规则链中的策略</li>
<li>OUTPUT链——外出的数据包应用此规则链中的策略</li>
<li>FORWARD链——转发数据包时应用此规则链中的策略</li>
<li>PREROUTING链——对数据包作路由选择前应用此链中的规则（所有的数据包进来的时侯都先由这个链处理）</li>
<li>POSTROUTING链——对数据包作路由选择后应用此链中的规则（所有的数据包出来的时侯都先由这个链处理）</li>
</ul>
<p><img src="/images/iptables/四表五链详细.jpg" alt=""></p>
<p><img src="/images/iptables/四表五链.png" alt=""></p>
<p><img src="/images/iptables/四表五链鸟哥.jpg" alt=""></p>
<h2 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h2><ul>
<li>NEW：新連接請求。主机连接目标主机，在目标主机上看到的第一个想要连接的包</li>
<li>ESTABLISHED：已建立的連接。主机已与目标主机进行通信，判断标准只要目标主机回应了第一个包，就进入该状态。</li>
<li>INVALID：非法連接請求。无效的封包，例如数据破损的封包状态</li>
<li>RELATED：相關聯的。主机已与目标主机进行通信，目标主机发起新的链接方式，例如ftp</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">101</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">77</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
