<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/8/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/04/Python基础练习-列表元组与冒泡法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/04/Python基础练习-列表元组与冒泡法/" itemprop="url">
                  Python基础练习-列表元组与冒泡法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-09-04 13:18:11" itemprop="dateCreated datePublished" datetime="2019-09-04T13:18:11+08:00">2019-09-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-10-21 17:57:20" itemprop="dateModified" datetime="2019-10-21T17:57:20+08:00">2019-10-21</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="列表-依次接收用户输入的3个数，排序后打印"><a href="#列表-依次接收用户输入的3个数，排序后打印" class="headerlink" title="列表-依次接收用户输入的3个数，排序后打印"></a>列表-依次接收用户输入的3个数，排序后打印</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">===============================================</span><br><span class="line">   示例，最笨拙的方法。从小到大排列，i1最小，i3最大</span><br><span class="line">===============================================</span><br><span class="line">nums = []</span><br><span class="line"><span class="comment"># 需要先定义出nums这个变量，不然会提示"nums not deni"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    nums.append(int(input(<span class="string">'&#123;&#125;:'</span>.format(i))))</span><br><span class="line"><span class="comment"># '&#123;&#125;:'是取其后面format()中变量的值，这时format中是i，'&#123;&#125;:'是显示的提示信息，</span></span><br><span class="line"><span class="comment"># 输入的值会被int处理后追加到nums列表中。结果如下：</span></span><br><span class="line"><span class="comment"># 0:1   第0次，输入的是1</span></span><br><span class="line"><span class="comment"># 0   这里打印了一次i</span></span><br><span class="line"><span class="comment"># [1]   这里打印一次nums</span></span><br><span class="line"><span class="comment"># 1:3   第1次输入的是3</span></span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="comment"># [1, 3]   nums现在就是两个数字了</span></span><br><span class="line"><span class="comment"># 2:4</span></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># [1, 3, 4]</span></span><br><span class="line"><span class="keyword">if</span> nums[<span class="number">0</span>] &gt; nums[<span class="number">1</span>]:</span><br><span class="line">    <span class="keyword">if</span> nums[<span class="number">0</span>] &gt; nums[<span class="number">2</span>]:</span><br><span class="line">        i3 = nums[<span class="number">0</span>]   <span class="comment"># 上面先比较索引0是否大于索引1和2，如果大于，就把索引0的数字给i3。</span></span><br><span class="line">        <span class="keyword">if</span> nums[<span class="number">1</span>] &gt; nums[<span class="number">2</span>]:</span><br><span class="line">            i2 = nums[<span class="number">1</span>]</span><br><span class="line">            i1 = nums[<span class="number">2</span>]    </span><br><span class="line"><span class="comment"># 继续判断，这时已判断完索引0了，再判断索引1是否大于索引2，如果大于，就把索引1给i2，索引2给i1。否则，就把</span></span><br><span class="line"><span class="comment"># 索引2给i2，索引1给i1。</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            i2 = nums[<span class="number">2</span>]</span><br><span class="line">            i1 = nums[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        i2 = nums[<span class="number">0</span>]</span><br><span class="line">        i3 = nums[<span class="number">2</span>]</span><br><span class="line">        i1 = nums[<span class="number">1</span>]</span><br><span class="line"><span class="comment"># 如果上面判断索引0不大于索引2，就表示索引2最大，给i3，索引1最小，给i1。</span></span><br><span class="line"><span class="keyword">else</span>:  <span class="comment"># 0&lt;1</span></span><br><span class="line">    <span class="keyword">if</span> nums[<span class="number">0</span>] &gt; nums[<span class="number">2</span>]:</span><br><span class="line">        i3 = nums[<span class="number">1</span>]</span><br><span class="line">        i2 = nums[<span class="number">0</span>]</span><br><span class="line">        i1 = nums[<span class="number">2</span>]</span><br><span class="line"><span class="comment"># 如果最开始判断的索引0小于索引1，再判断索引 0是否大于索引2，如果大于，就表示索引2最小，索引1最大。</span></span><br><span class="line"><span class="comment"># 下面的判断道理是一样的</span></span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># 0&lt;2</span></span><br><span class="line">        <span class="keyword">if</span> nums[<span class="number">1</span>] &lt; nums[<span class="number">2</span>]: <span class="comment"># 1&lt;2</span></span><br><span class="line">            i1 = nums[<span class="number">0</span>]</span><br><span class="line">            i2 = nums[<span class="number">1</span>]</span><br><span class="line">            i3 = nums[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># 1 &gt; 2</span></span><br><span class="line">            i1 = nums[<span class="number">0</span>]</span><br><span class="line">            i2 = nums[<span class="number">2</span>]</span><br><span class="line">            i3 = nums[<span class="number">1</span>]</span><br><span class="line">print(i1,i2,i3)</span><br><span class="line"><span class="comment"># 这里主要看六种变化，1. 索引0大于索引1和索引2，索引1大于索引2；2. 索引0大于索引1和索引2，索引2大于索引1；</span></span><br><span class="line"><span class="comment"># 3. 索引2大于索引0和索引1，索引0大于索引1；4. 索引2大于索引0和索引1，索引1大于索引0；5. 索引1大于索引0和索引2，索引0大于索引2；6. 索引1大于索引0和索引2，索引2大于索引0</span></span><br><span class="line"></span><br><span class="line">===================</span><br><span class="line">   改进，从大到小排列</span><br><span class="line">===================</span><br><span class="line">nums = []</span><br><span class="line">out = <span class="keyword">None</span>   <span class="comment"># 定义空列表，将None改为[]也可以。</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    nums.append(int(input(<span class="string">'&#123;&#125;:'</span>.format(i))))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> nums[<span class="number">0</span>] &gt; nums[<span class="number">1</span>]:</span><br><span class="line">    <span class="keyword">if</span> nums[<span class="number">0</span>] &gt; nums[<span class="number">2</span>]:</span><br><span class="line">        <span class="keyword">if</span> nums[<span class="number">1</span>] &gt; nums[<span class="number">2</span>]:</span><br><span class="line">            out = [<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>]   <span class="comment"># 这里的[2,1,0]指的是索引，保存在out变量中</span></span><br><span class="line"><span class="comment"># out是为了保存索引的顺序</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            out = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        out = [<span class="number">1</span>,<span class="number">0</span>,<span class="number">2</span>]</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># 0&lt;1</span></span><br><span class="line">    <span class="keyword">if</span> nums[<span class="number">0</span>] &gt; nums[<span class="number">2</span>]:</span><br><span class="line">        out = [<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># 0&lt;2</span></span><br><span class="line">        <span class="keyword">if</span> nums[<span class="number">1</span>] &lt; nums[<span class="number">2</span>]:   <span class="comment"># 1&lt;2</span></span><br><span class="line">            out = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># 1&gt;2</span></span><br><span class="line">            out = [<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br><span class="line">out.reverse()</span><br><span class="line"><span class="comment"># reverse()是为了将out列表中的元素整个反过来，原本是从小到大排列，变成从大到小排列。</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> out:</span><br><span class="line">    print(nums[i],end=<span class="string">', '</span>)</span><br><span class="line"><span class="comment"># 最后将out中的三个数字依次传给i，i中保存的实际就是索引编号，再把i带入到nums列表，</span></span><br><span class="line"><span class="comment"># 这样就从小到大打印出结果了</span></span><br><span class="line"></span><br><span class="line">================</span><br><span class="line">  max min的实现</span><br><span class="line">================</span><br><span class="line">nums = []</span><br><span class="line">out = <span class="keyword">None</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    nums.append(int(input(<span class="string">'&#123;&#125;:'</span>.format(i))))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    cur = min(nums)</span><br><span class="line"><span class="comment"># 死循环，用min把列表中最小的数字选出</span></span><br><span class="line">    print(cur)</span><br><span class="line"><span class="comment"># 打印最小的数字</span></span><br><span class="line">    nums.remove(cur)</span><br><span class="line"><span class="comment"># 将最小的数字删除，因为上面for循环定义了循环3次，所以这里while循环可以循环两次，最后一次用下面的代码执行</span></span><br><span class="line">    <span class="keyword">if</span> len(nums) == <span class="number">1</span>:</span><br><span class="line"><span class="comment"># 判断nums列表中是否只有1个元素，如果不是，就继续上面的循环</span></span><br><span class="line">        print(nums[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 打印出最后一个元素后就退出循环</span></span><br><span class="line"></span><br><span class="line">==============</span><br><span class="line">  列表sort实现</span><br><span class="line">==============</span><br><span class="line">nums = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    nums.append(int(input(<span class="string">'&#123;&#125;:'</span>.format(i))))</span><br><span class="line">    </span><br><span class="line">nums.sort()</span><br><span class="line"><span class="comment"># sort() 函数用于对原列表进行排序</span></span><br><span class="line">print(nums)</span><br></pre></td></tr></table></figure>
<h3 id="元组习题"><a href="#元组习题" class="headerlink" title="元组习题"></a>元组习题</h3><h4 id="冒泡法"><a href="#冒泡法" class="headerlink" title="冒泡法"></a>冒泡法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">numlist = [[<span class="number">1</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>],[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>]]</span><br><span class="line"><span class="comment"># 定义一个列表，列表中有两个元素</span></span><br><span class="line">nums = numlist[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># 设置nums等于列表中的第一个元素</span></span><br><span class="line">print(nums)</span><br><span class="line"><span class="comment"># 打印一次nums</span></span><br><span class="line">length = len(nums)</span><br><span class="line"><span class="comment"># 计算nums的长度，这是为了计算出要比较交换的次数，长度就是比较交换的次数</span></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line"><span class="comment"># 统计交换的次数，也就是两个数相比，如果两个数对调过一次，这里就会加1。</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="comment"># 统计一共进入比较多少次，进入比较后不一定会交换，因为前面的数比后面的数小是不用交换的。</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(length):  </span><br><span class="line"><span class="comment"># 这是整个要比较的次数。如第1个数与第2个数比较，一直比较到最后一个数。这就是一次比较</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(length-i<span class="number">-1</span>):</span><br><span class="line"><span class="comment"># 这是每次要比较几个数，总是从0到n。因为第1次比较完，最大的数就排列在最后了，下一次比较就不用再和最后一个数比较了。-1是因为range()是从0开始的。</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line"><span class="comment"># 统计进入比较的次数，每进入一次就加1。进入比较后不一定会交换，因为前面的数比后面的数小是不用交换的。</span></span><br><span class="line">        <span class="keyword">if</span> nums[j] &gt; nums[j+<span class="number">1</span>]:</span><br><span class="line"><span class="comment"># 第1次比较索引0和索引1两个数字，如果索引0比索引1大，就向下执行</span></span><br><span class="line">            tmp = nums[j]</span><br><span class="line"><span class="comment"># 将索引0的数赋值给tmp，临时存放</span></span><br><span class="line">            nums[j] = nums[j+<span class="number">1</span>]</span><br><span class="line"><span class="comment"># 把索引1的数赋值给索引0,这时小的数字就向前移了</span></span><br><span class="line">            nums[j+<span class="number">1</span>] = tmp</span><br><span class="line"><span class="comment"># 再把临时存放的大的数字给索引1，这样大的数字就向后移了</span></span><br><span class="line">            count_swap += <span class="number">1</span></span><br><span class="line"><span class="comment"># 记录1次交换</span></span><br><span class="line">print(nums,count_swap,count)</span><br><span class="line"><span class="comment"># 最后打印排列好的结果，进入比较的次数，实际交换的次数。</span></span><br><span class="line"><span class="comment"># 输出结果：</span></span><br><span class="line"><span class="comment"># [1, 9, 8, 5, 6, 7, 4, 3, 2]</span></span><br><span class="line"><span class="comment"># [1, 2, 3, 4, 5, 6, 7, 8, 9] 25 36</span></span><br><span class="line"></span><br><span class="line">=======</span><br><span class="line">    优化</span><br><span class="line">=======</span><br><span class="line"><span class="comment"># 冒泡法代码实现二，优化实现</span></span><br><span class="line">num_list = [[<span class="number">1</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>],[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>],[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">9</span>,<span class="number">8</span>]]</span><br><span class="line">nums = num_list[<span class="number">2</span>]</span><br><span class="line">print(nums)</span><br><span class="line">length = len(nums)</span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(length):</span><br><span class="line">    flag = <span class="keyword">False</span></span><br><span class="line"><span class="comment"># 每次每个数比较之前都加一个标记</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(length-i<span class="number">-1</span>):</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[j] &gt; nums[j+<span class="number">1</span>]:</span><br><span class="line">            tmp = nums[j]</span><br><span class="line">            nums[j] = nums[j+<span class="number">1</span>]</span><br><span class="line">            nums[j+<span class="number">1</span>] = tmp</span><br><span class="line">            flag = <span class="keyword">True</span></span><br><span class="line">            <span class="comment"># 如果前面的数字比后面的大，进行了交换，就将flag改为True</span></span><br><span class="line">            count_swap += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> flag:   </span><br><span class="line"><span class="comment"># 如果not flag为真，就break。这里也可以写成if flag，如果写成这样，那么上面两处对flag的定义就要转过来，把</span></span><br><span class="line"><span class="comment"># False变成True，True变成False。</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 当flag为False时，证明没有交换，也就证明没必要再进行之后的动作，顺序已经排好了。</span></span><br><span class="line">print(nums, count_swap, count)</span><br><span class="line"><span class="comment"># 输出结果：</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">8</span>]</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>] <span class="number">1</span> <span class="number">15</span></span><br></pre></td></tr></table></figure>
<h4 id="命名元组"><a href="#命名元组" class="headerlink" title="命名元组"></a>命名元组</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 帮助文档中,查阅namedtuple,有使用例程</span></span><br><span class="line"><span class="comment"># namedtuple(typename, field_names, verbose=False, rename=False)</span></span><br><span class="line">	<span class="comment"># 命名元组,返回一个元组的子类,并定义了字段</span></span><br><span class="line">	<span class="comment"># field_names可以是空白符或逗号分割的字段的字符串,可以是字段的列表</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line">Point = namedtuple(<span class="string">'_Point'</span>,[<span class="string">'x'</span>,<span class="string">'y'</span>]) </span><br><span class="line"><span class="comment"># Point为返回的类</span></span><br><span class="line">p = Point(<span class="number">11</span>, <span class="number">22</span>)</span><br><span class="line">print(p)</span><br><span class="line">输出：_Point(x=<span class="number">11</span>, y=<span class="number">22</span>)</span><br><span class="line"></span><br><span class="line">Student = namedtuple(<span class="string">'Student'</span>, <span class="string">'name age'</span>)</span><br><span class="line">tom = Student(<span class="string">'tom'</span>, <span class="number">20</span>)</span><br><span class="line">jerry = Student(<span class="string">'jerry'</span>, <span class="number">18</span>)</span><br><span class="line">tom.name</span><br><span class="line">输出：<span class="string">'tom'</span></span><br><span class="line">jerry.age</span><br><span class="line">输出：<span class="number">18</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/26/logstash基础知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/26/logstash基础知识/" itemprop="url">
                  logstash基础知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-26 14:20:40 / 修改時間：17:39:57" itemprop="dateCreated datePublished" datetime="2019-06-26T14:20:40+08:00">2019-06-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="配置语法"><a href="#配置语法" class="headerlink" title="配置语法"></a>配置语法</h3><p>Logstash 设计了自己的 DSL，包括有区域，注释，数据类型(布尔值，字符串，数值，数组，哈希)，条件判断，字段引用等。</p>
<h4 id="区段-section"><a href="#区段-section" class="headerlink" title="区段(section)"></a>区段(section)</h4><p>Logstash 用 <code>{}</code> 来定义区域。区域内可以包括插件区域定义，你可以在一个区域内定义多个插件。插件区域内则可以定义键值对设置。示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    stdin &#123;&#125;</span><br><span class="line">    syslog &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h4><p>Logstash 支持少量的数据值类型：</p>
<ul>
<li>bool</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug =&gt; true</span><br></pre></td></tr></table></figure>
<ul>
<li>string</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host =&gt; <span class="string">"hostname"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>number</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">port =&gt; 514</span><br></pre></td></tr></table></figure>
<ul>
<li>array</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match =&gt; ["datetime", "UNIX", "ISO8601"]</span><br></pre></td></tr></table></figure>
<ul>
<li>hash</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">options =&gt; &#123;</span><br><span class="line">    key1 =&gt; "value1",</span><br><span class="line">    key2 =&gt; "value2"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：如果你用的版本低于 1.2.0，<em>哈希</em>的语法跟<em>数组</em>是一样的，像下面这样写：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match =&gt; [ "field1", "pattern1", "field2", "pattern2" ]</span><br></pre></td></tr></table></figure>
<h4 id="字段引用-field-reference"><a href="#字段引用-field-reference" class="headerlink" title="字段引用(field reference)"></a>字段引用(field reference)</h4><p>字段是 <code>Logstash::Event</code> 对象的属性。我们之前提过事件就像一个哈希一样，所以你可以想象字段就像一个键值对。</p>
<p><em>小贴士：我们叫它字段，因为 Elasticsearch 里是这么叫的。</em></p>
<p>如果你想在 Logstash 配置中使用字段的值，只需要把字段的名字写在中括号 <code>[]</code> 里就行了，这就叫<strong>字段引用</strong>。</p>
<p>对于 <strong>嵌套字段</strong>(也就是多维哈希表，或者叫哈希的哈希)，每层的字段名都写在 <code>[]</code> 里就可以了。比如，你可以从 geoip 里这样获取 <em>longitude</em> 值(是的，这是个笨办法，实际上有单独的字段专门存这个数据的)：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">geoip</span>][<span class="symbol">location</span>][<span class="string">0</span>]</span><br></pre></td></tr></table></figure>
<p><em>小贴士：logstash 的数组也支持倒序下标，即 [geoip][location][-1] 可以获取数组最后一个元素的值。</em></p>
<p>Logstash 还支持变量内插，在字符串里使用字段引用的方法是这样：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"the longitude is %&#123;[<span class="string">geoip</span>][<span class="symbol">location</span>][<span class="string">0</span>]&#125;"</span><br></pre></td></tr></table></figure>
<h4 id="条件判断-condition"><a href="#条件判断-condition" class="headerlink" title="条件判断(condition)"></a>条件判断(condition)</h4><p>Logstash从 1.3.0 版开始支持条件判断和表达式。</p>
<p>表达式支持下面这些操作符：</p>
<ul>
<li>equality, etc: ==, !=, &lt;, &gt;, &lt;=, &gt;=</li>
<li>regexp: =~, !~</li>
<li>inclusion: in, not in</li>
<li>boolean: and, or, nand, xor</li>
<li>unary: !()</li>
</ul>
<p>通常来说，你都会在表达式里用到字段引用。比如：</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">"_grokparsefailure"</span> <span class="keyword">not</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> [status] !~ <span class="regexp">/^2\d\d/</span> <span class="keyword">and</span> [url] == <span class="string">"/noc.gif"</span> &#123;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h3><p>Logstash 提供了一个 shell 脚本叫 <code>logstash</code> 方便快速运行。它支持以下参数：</p>
<ul>
<li>-e</li>
</ul>
<p>意即<em>执行</em>。我们在 “Hello World” 的时候已经用过这个参数了。事实上你可以不写任何具体配置，直接运行 <code>bin/logstash -e &#39;&#39;</code> 达到相同效果。这个参数的默认值是下面这样：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">input </span>&#123;</span><br><span class="line">    <span class="class">stdin </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class">output </span>&#123;</span><br><span class="line">    <span class="class">stdout </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>–config 或 -f</li>
</ul>
<p>意即<em>文件</em>。真实运用中，我们会写很长的配置，甚至可能超过 shell 所能支持的 1024 个字符长度。所以我们必把配置固化到文件里，然后通过 <code>bin/logstash -f agent.conf</code> 这样的形式来运行。</p>
<p>此外，logstash 还提供一个方便我们规划和书写配置的小功能。你可以直接用 <code>bin/logstash -f /etc/logstash.d/</code> 来运行。logstash 会自动读取 <code>/etc/logstash.d/</code> 目录下所有的文本文件，然后在自己内存里拼接成一个完整的大配置文件，再去执行。</p>
<ul>
<li>–configtest 或 -t</li>
</ul>
<p>意即<em>测试</em>。用来测试 Logstash 读取到的配置文件语法是否能正常解析。Logstash 配置语法是用 grammar.treetop 定义的。尤其是使用了上一条提到的读取目录方式的读者，尤其要提前测试。</p>
<ul>
<li>–log 或 -l</li>
</ul>
<p>意即<em>日志</em>。Logstash 默认输出日志到标准错误。生产环境下你可以通过 <code>bin/logstash -l logs/logstash.log</code> 命令来统一存储日志。</p>
<ul>
<li>–filterworkers 或 -w</li>
</ul>
<p>意即<em>工作线程</em>。Logstash 会运行多个线程。你可以用 <code>bin/logstash -w 5</code> 这样的方式强制 Logstash 为<strong>过滤</strong>插件运行 5 个线程。</p>
<p><em>注意：Logstash目前还不支持输入插件的多线程。而输出插件的多线程需要在配置内部设置，这个命令行参数只是用来设置过滤插件的！</em></p>
<p><strong>提示：Logstash 目前不支持对过滤器线程的监测管理。如果 filterworker 挂掉，Logstash 会处于一个无 filter 的僵死状态。这种情况在使用 filter/ruby 自己写代码时非常需要注意，很容易碰上 NoMethodError: undefined method ‘*‘ for nil:NilClass 错误。需要妥善处理，提前判断。</strong></p>
<ul>
<li>–pluginpath 或 -P</li>
</ul>
<p>可以写自己的插件，然后用 <code>bin/logstash --pluginpath /path/to/own/plugins</code> 加载它们。</p>
<ul>
<li>–verbose</li>
</ul>
<p>输出一定的调试日志。</p>
<p><em>小贴士：如果你使用的 Logstash 版本低于 1.3.0，你只能用 bin/logstash -v 来代替。</em></p>
<ul>
<li>–debug</li>
</ul>
<p>输出更多的调试日志。</p>
<p><em>小贴士：如果你使用的 Logstash 版本低于 1.3.0，你只能用 bin/logstash -vv 来代替。</em></p>
<h3 id="输入插件-Input"><a href="#输入插件-Input" class="headerlink" title="输入插件(Input)"></a>输入插件(Input)</h3><p>Logstash 配置一定要有一个 input 和一个 output。</p>
<h4 id="标准输入-Stdin"><a href="#标准输入-Stdin" class="headerlink" title="标准输入(Stdin)"></a>标准输入(Stdin)</h4><h5 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/logstash/conf.d/system.conf</span><br><span class="line">input &#123;</span><br><span class="line">        stdin &#123;</span><br><span class="line">                add_field =&gt; &#123;"key" =&gt; "value"&#125;</span><br><span class="line">                codec =&gt; "plain"</span><br><span class="line">                tags =&gt; ["add"]</span><br><span class="line">                type =&gt; "std"</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">        stdout &#123;</span><br><span class="line">            # 这样写会输出到屏幕</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@A5_SW_3552P ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf </span><br><span class="line">WARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class="line">[WARN ] 2019-06-26 16:05:08.173 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified</span><br><span class="line">[INFO ] 2019-06-26 16:05:08.213 [LogStash::Runner] runner - Starting Logstash &#123;"logstash.version"=&gt;"6.5.4"&#125;</span><br><span class="line">[INFO ] 2019-06-26 16:05:14.564 [Converge PipelineAction::Create&lt;main&gt;] pipeline - Starting pipeline &#123;:pipeline_id=&gt;"main", "pipeline.workers"=&gt;2, "pipeline.batch.size"=&gt;125, "pipeline.batch.delay"=&gt;50&#125;</span><br><span class="line">[INFO ] 2019-06-26 16:05:14.930 [[main]&gt;worker1] stdin - Automatically switching from plain to line codec &#123;:plugin=&gt;"stdin"&#125;</span><br><span class="line">[INFO ] 2019-06-26 16:05:15.043 [Converge PipelineAction::Create&lt;main&gt;] pipeline - Pipeline started successfully &#123;:pipeline_id=&gt;"main", :thread=&gt;"#&lt;Thread:0x55fda7a3 run&gt;"&#125;</span><br><span class="line">The stdin plugin is now waiting for input:</span><br><span class="line">[INFO ] 2019-06-26 16:05:15.171 [Ruby-0-Thread-1: /usr/share/logstash/lib/bootstrap/environment.rb:6] agent - Pipelines running &#123;:count=&gt;1, :running_pipelines=&gt;[:main], :non_running_pipelines=&gt;[]&#125;</span><br><span class="line">[INFO ] 2019-06-26 16:05:15.646 [Api Webserver] agent - Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</span><br><span class="line">hello world</span><br><span class="line">&#123;</span><br><span class="line">       "message" =&gt; "hello world",</span><br><span class="line">    "@timestamp" =&gt; 2019-06-26T08:05:23.027Z,</span><br><span class="line">      "@version" =&gt; "1",</span><br><span class="line">          "host" =&gt; "A5_SW_3552P",</span><br><span class="line">           "key" =&gt; "value",</span><br><span class="line">          "tags" =&gt; [</span><br><span class="line">        [0] "add"</span><br><span class="line">    ],</span><br><span class="line">          "type" =&gt; "std"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h5><p><em>type</em> 和 <em>tags</em> 是 logstash 事件中两个特殊的字段。通常来说我们会在<em>输入区段</em>中通过 <em>type</em> 来标记事件类型 —— 我们肯定是提前能知道这个事件属于什么类型的。而 <em>tags</em> 则是在数据处理过程中，由具体的插件来添加或者删除的。</p>
<p>最常见的用法是像下面这样：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    stdin &#123;</span><br><span class="line">        type =&gt; "web"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    if [type] == "web" &#123;</span><br><span class="line">        grok &#123;</span><br><span class="line">            match =&gt; ["message", %&#123;COMBINEDAPACHELOG&#125;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    if "_grokparsefailure" in [tags] &#123;</span><br><span class="line">        nagios_nsca &#123;</span><br><span class="line">            nagios_status =&gt; "1"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="读取文件-File"><a href="#读取文件-File" class="headerlink" title="读取文件(File)"></a>读取文件(File)</h4><p>​    Logstash 使用一个名叫 <em>FileWatch</em> 的 Ruby Gem 库来监听文件变化。这个库支持 glob 展开文件路径，而且会记录一个叫 <em>.sincedb</em> 的数据库文件来跟踪被监听的日志文件的当前读取位置。所以，不要担心 logstash 会漏过你的数据。</p>
<p>​    <em>sincedb 文件中记录了每个被监听的文件的 inode, major number, minor number 和 pos。</em></p>
<h5 id="配置示例-1"><a href="#配置示例-1" class="headerlink" title="配置示例"></a>配置示例</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">input</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; ["/var/log/*.log", "/var/log/message"]</span><br><span class="line">        type =&gt; "system"</span><br><span class="line">        start_position =&gt; "beginning"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="解释-1"><a href="#解释-1" class="headerlink" title="解释"></a>解释</h5><p>有一些比较有用的配置项，可以用来指定 <em>FileWatch</em> 库的行为：</p>
<ul>
<li>discover_interval</li>
</ul>
<p>logstash 每隔多久去检查一次被监听的 <code>path</code> 下是否有新文件。默认值是 15 秒。</p>
<ul>
<li>exclude</li>
</ul>
<p>不想被监听的文件可以排除出去，这里跟 <code>path</code> 一样支持 glob 展开。</p>
<ul>
<li>sincedb_path</li>
</ul>
<p>如果你不想用默认的 <code>$HOME/.sincedb</code>(Windows 平台上在 <code>C:\Windows\System32\config\systemprofile\.sincedb</code>)，可以通过这个配置定义 sincedb 文件到其他位置。</p>
<ul>
<li>sincedb_write_interval</li>
</ul>
<p>logstash 每隔多久写一次 sincedb 文件，默认是 15 秒。</p>
<ul>
<li>stat_interval</li>
</ul>
<p>logstash 每隔多久检查一次被监听文件状态（是否有更新），默认是 1 秒。</p>
<ul>
<li>start_position</li>
</ul>
<p>logstash 从什么位置开始读取文件数据，默认是结束位置，也就是说 logstash 进程会以类似 <code>tail -F</code> 的形式运行。如果你是要导入原有数据，把这个设定改成 “beginning”，logstash 进程就从头开始读取，有点类似 <code>cat</code>，但是读到最后一行不会终止，而是继续变成 <code>tail -F</code>。</p>
<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><ol>
<li>通常你要导入原有数据进 Elasticsearch 的话，你还需要 <a href="https://doc.yonyoucloud.com/doc/logstash-best-practice-cn/filter/date.html" target="_blank" rel="noopener">filter/date</a> 插件来修改默认的”@timestamp” 字段值。</li>
<li><em>FileWatch</em> 只支持文件的<strong>绝对路径</strong>，而且会不自动递归目录。所以有需要的话，请用数组方式写明具体哪些文件。</li>
<li><em>LogStash::Inputs::File</em> 只是在进程运行的注册阶段初始化一个 <em>FileWatch</em> 对象。所以它不能支持类似 fluentd 那样的 <code>path =&gt; &quot;/path/to/%{+yyyy/MM/dd/hh}.log&quot;</code> 写法。达到相同目的，你只能写成 <code>path =&gt; &quot;/path/to/*/*/*/*.log&quot;</code>。</li>
<li><code>start_position</code> 仅在该文件从未被监听过的时候起作用。如果 sincedb 文件中已经有这个文件的 inode 记录了，那么 logstash 依然会从记录过的 pos 开始读取数据。所以重复测试的时候每回需要删除 sincedb 文件。使用locate查询，文件路径在/var/lib/logstash/plugins/inputs/file/目录下，也有一说在用户家目录中，但没有找到。</li>
<li>因为 windows 平台上没有 inode 的概念，Logstash 某些版本在 windows 平台上监听文件不是很靠谱。windows 平台上，推荐考虑使用 nxlog 作为收集端。</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/26/ElasticSearch概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/26/ElasticSearch概念/" itemprop="url">
                  ElasticSearch概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-26 13:00:55 / 修改時間：14:16:45" itemprop="dateCreated datePublished" datetime="2019-06-26T13:00:55+08:00">2019-06-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><h4 id="索引-Index"><a href="#索引-Index" class="headerlink" title="索引(Index)"></a>索引(Index)</h4><p>​    ElasticSearch把数据存放到一个或者多个索引(indices)中。如果用关系型数据库模型对比，索引(index)的地位与数据库实例(database)相当。索引存放和读取的基本单元是文档(Document)。我们也一再强调，ElasticSearch内部用Apache Lucene实现索引中数据的读写。读者应该清楚的是：在ElasticSearch中被视为单独的一个索引(index)，在Lucene中可能不止一个。这是因为在分布式体系中，ElasticSearch会用到分片(shards)和备份(replicas)机制将一个索引(index)存储多份。</p>
<h4 id="文档-Document"><a href="#文档-Document" class="headerlink" title="文档(Document)"></a>文档(Document)</h4><p>​    在ElasticSearch的世界中，文档(Document)是主要的存在实体(在Lucene中也是如此)。所有的ElasticSearch应用需求到最后都可以统一建模成一个检索模型：检索相关文档。文档(Document)由一个或者多个域(Field)组成，每个域(Field)由一个域名(此域名非彼域名)和一个或者多个值组成(有多个值的值称为多值域(multi-valued))。在ElasticSeach中，每个文档(Document)都可能会有不同的域(Field)集合；也就是说文档(Document)是没有固定的模式和统一的结构。文档(Document)之间保持结构的相似性即可(Lucene中的文档(Document)也秉持着相同的规定)。实际上，ElasticSearch中的文档(Document)就是Lucene中的文档(Document)。从客户端的角度来看，文档(Document)就是一个JSON对象。</p>
<h4 id="参数映射-Mapping"><a href="#参数映射-Mapping" class="headerlink" title="参数映射(Mapping)"></a>参数映射(Mapping)</h4><p>​    所有的文档(Document)在存储之前都必须经过分析(analyze)流程。用户可以配置输入文本分解成Token的方式；哪些Token应该被过滤掉；或者其它的处理流程，比如去除HTML标签。此外，ElasticSearch提供的各种特性，比如排序的相关信息。保存上述的配置信息，这就是参数映射(Mapping)在ElasticSearch中扮演的角色。尽管ElasticSearch可以根据域的值自动识别域的类型(field type)，在生产应用中，都是需要自己配置这些信息以避免一些问题发生。要保证应用的可控性。</p>
<h4 id="文档类型-Type"><a href="#文档类型-Type" class="headerlink" title="文档类型(Type)"></a>文档类型(Type)</h4><p>​    每个文档在ElasticSearch中都必须设定它的类型。文档类型使得同一个索引中在存储结构不同的文档时，只需要依据文档类型就可以找到对应的参数映射(Mapping)信息，方便文档的存取。</p>
<h4 id="节点-Node"><a href="#节点-Node" class="headerlink" title="节点(Node)"></a>节点(Node)</h4><p>​    单独一个ElasticSearch服务器实例称为一个节点。对于许多应用场景来说，部署一个单节点的ElasticSearch服务器就足够了。但是考虑到容错性和数据过载，配置多节点的ElasticSearch集群是明智的选择。</p>
<h4 id="集群-Cluster"><a href="#集群-Cluster" class="headerlink" title="集群(Cluster)"></a>集群(Cluster)</h4><p>​    集群是多个ElasticSearch节点的集合。这些节点齐心协力应对单个节点无法处理的搜索需求和数据存储需求。集群同时也是应对由于部分机器(节点)运行中断或者升级导致无法提供服务这一问题的利器。ElasticSearch提供的集群各个节点几乎是无缝连接（所谓无缝连接，即集群对外而言是一个整体，增加一个节点或者去掉一个节点对用户而言是透明的）。在ElasticSearch中配置一个集群非常简单，在我们看来，这是在与同类产品中竞争所体现出的最大优势。</p>
<h4 id="分片索引-Shard"><a href="#分片索引-Shard" class="headerlink" title="分片索引(Shard)"></a>分片索引(Shard)</h4><p>​    前面已经提到，集群能够存储超出单机容量的信息。为了实现这种需求，ElasticSearch把数据分发到多个存储Lucene索引的物理机上。这些Lucene索引称为分片索引，这个分发的过程称为索引分片(Sharding)。在ElasticSearch集群中，索引分片(Sharding)是自动完成的，而且所有分片索引(Shard)是作为一个整体呈现给用户的。需要注意的是，尽管索引分片这个过程是自动的，但是在应用中需要事先调整好参数。因为集群中分片的数量需要在索引创建前配置好，而且服务器启动后是无法修改的，至少目前无法修改。</p>
<h4 id="索引副本-Replica"><a href="#索引副本-Replica" class="headerlink" title="索引副本(Replica)"></a>索引副本(Replica)</h4><p>​    通过索引分片机制(Sharding)可以向ElasticSearch集群中导入超过单机容量的数据，客户端操作任意一个节点即可实现对集群数据的读写操作。当集群负载增长，用户搜索请求阻塞在单个节点上时，通过索引副本(Replica)机制就可以解决这个问题。索引副本(Replica)机制的的思路很简单：为索引分片创建一份新的拷贝，它可以像原来的主分片一样处理用户搜索请求。同时也顺便保证了数据的安全性。即如果主分片数据丢失，ElasticSearch通过索引副本使得数据不丢失。索引副本可以随时添加或者删除，所以用户可以在需要的时候动态调整其数量。</p>
<h4 id="时间之门-Gateway"><a href="#时间之门-Gateway" class="headerlink" title="时间之门(Gateway)"></a>时间之门(Gateway)</h4><p>​    在运行的过程中，ElasticSearch会收集集群的状态、索引的参数等信息。这些数据被存储在Gateway中。</p>
<h3 id="ElasticSearch背后的核心理念"><a href="#ElasticSearch背后的核心理念" class="headerlink" title="ElasticSearch背后的核心理念"></a>ElasticSearch背后的核心理念</h3><p>​    ElasticSearch是构建在极少数的几个概念之上的。ElasticSearch的开发团队希望它能够快速上手，可扩展性强。而且这些核心特性体现在ElasticSearch的各个方面。从架构的角度来看，这些主要特性是：</p>
<ul>
<li>开箱即用。安装好ElasticSearch后，所有参数的默认值都自动进行了比较合理的设置，基本不需要额外的调整。包括内置的发现机制(比如Field类型的自动匹配)和自动化参数配置。</li>
<li>天生集群。ElasticSearch默认工作在集群模式下。节点都将视为集群的一部分，而且在启动的过程中自动连接到集群中。</li>
<li>自动容错。ElasticSearch通过P2P网络进行通信，这种工作方式消除了单点故障。节点自动连接到集群中的其它机器，自动进行数据交换及以节点之间相互监控。索引分片</li>
<li>扩展性强。无论是处理能力和数据容量上都可以通过一种简单的方式实现扩展，即增添新的节点。</li>
<li>近实时搜索和版本控制。由于ElasticSearch天生支持分布式，所以延迟和不同节点上数据的短暂性不一致无可避免。ElasticSearch通过版本控制(versioning)的机制尽量减少问题的出现。</li>
</ul>
<h3 id="ElasticSearch的工作原理"><a href="#ElasticSearch的工作原理" class="headerlink" title="ElasticSearch的工作原理"></a>ElasticSearch的工作原理</h3><h4 id="启动过程"><a href="#启动过程" class="headerlink" title="启动过程"></a>启动过程</h4><p>​    当ElasticSearch的节点启动后，它会利用多播（multicast）（或者单播，如果用户更改了配置）寻找集群中的其它节点，并与之建立连接。这个过程如下图所示</p>
<p><img src="/images/elasticsearch/elasticsearch1.png" alt=""></p>
<p>​    在集群中，一个节点被选举成主节点(master node)。这个节点负责管理集群的状态，当群集的拓扑结构改变时把索引分片分派到相应的节点上。</p>
<p>​    需要注意的是，从用户的角度来看，主节点在ElasticSearch中并没有占据着重要的地位，这与其它的系统（比如数据库系统）是不同的。实际上用户并不需要知道哪个节点是主节点；所有的操作需求可以分发到任意的节点，ElasticSearch内部会完成这些让用户感到不明白的工作。在必要的情况下，任何节点都可以并发地把查询子句分发到其它的节点，然后合并各个节点返回的查询结果。最后返回给用户一个完整的数据集。所有的这些工作都不需要经过主节点转发(节点之间通过P2P的方式通信)。</p>
<p>​    主节点会去读取集群状态信息；在必要的时候，会进行恢复工作。在这个阶段，主节点会去检查哪些分片可用，决定哪些分片作为主分片。处理完成后，集群就会转入到黄色状态。</p>
<p>​    这意味着集群已经可以处理搜索请求了，但是还没有火力全开（这主要是由于所有的主索引分片（primary shard）都已经分配好了，但是索引副本还没有）。接下来需要做的事情就是找到复制好的分片，并设置成索引副本。当一个分片的副本数量太少时，主节点会决定将缺少的分片放置到哪个节点中，并且依照主分片创建副本。所有工作完成后，集群就会变成绿色的状态（表示所有的主分片的索引副本都已经分配完成）。</p>
<h4 id="探测失效节点"><a href="#探测失效节点" class="headerlink" title="探测失效节点"></a>探测失效节点</h4><p>​    在正常工作时，主节点会监控所有的节点，查看各个节点是否工作正常。如果在指定的时间里面，节点无法访问，该节点就被视为出故障了，接下来错误处理程序就会启动。集群需要重新均衡——由于该节点出现故障，分配到该节点的索引分片丢失。其它节点上相应的分片就会把工作接管过来。换句话说，对于每个丢失的主分片，新的主分片将从剩余的分片副本(Replica)中选举出来。重新安置新的分片和副本的这个过程可以通过配置来满足用户需求。</p>
<p>​    由于只是展示ElasticSearch的工作原理，我们就以下图三个节点的集群为例。集群中有一个主节点和两个数据节点。主节点向其它的节点发送Ping命令然后等待回应。如果没有得到回应（实际上可能得不到回复的Ping命令个数取决于用户配置），该节点就会被移出集群。</p>
<p><img src="/images/elasticsearch/elasticsearch2.png" alt=""></p>
<h4 id="与ElasticSearch进行通信"><a href="#与ElasticSearch进行通信" class="headerlink" title="与ElasticSearch进行通信"></a>与ElasticSearch进行通信</h4><p>​    我们已经探讨了ElasticSearch是如何构建起来的，但是归根到底，最重要的是如何往ElasticSearch中添加数据以及如何查询数据。为了实现上述的需求，ElasticSearch提供了精心设计的API。这些主要的API都是基于REST风格(参看<a href="http://en.wikipedia.org/wiki/Pepresentational_state_transfer" target="_blank" rel="noopener">http://en.wikipedia.org/wiki/Pepresentational_state_transfer</a> )。而且这些API非常容易与其它能够处理HTTP请求的系统进行集成。</p>
<p>​    ElasticSearch认为数据应该伴随在URL中，或者作为请求的主体(request body)，以一种JSON格式的文档发送给服务器。如果读者用Java或者其它运行在JVM虚拟机上的语言，应该关注一下Java API，它除了是群集中内置的REST风格API外，功能与URL请求是一样的。</p>
<p>​    值得一提的是在ElasticSearch内部，节点之间的通信也是用相关的Java API。</p>
<h4 id="索引数据"><a href="#索引数据" class="headerlink" title="索引数据"></a>索引数据</h4><p>​    ElasticSearch提供了4种索引数据的办法。最简单的是使用索引API。通过它可以将文档添加到指定的索引中去。比如，通过curl工具(访问<a href="http://curl.haxx.se/" target="_blank" rel="noopener">http://curl.haxx.se/</a> )，我们可以通过如下的命令创建一个新的文档：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT http:<span class="comment">//localhost:9200/blog/article/1 '&#123;"title": "New</span></span><br><span class="line">version <span class="keyword">of</span> Elastic Search released!<span class="string">", "</span>content<span class="string">": "</span>...<span class="string">","</span>tags<span class="string">":</span></span><br><span class="line"><span class="string">["</span>announce<span class="string">", "</span>elasticsearch<span class="string">", "</span>release<span class="string">"] &#125;'</span></span><br></pre></td></tr></table></figure>
<p>​    第2种和第3种办法可以通过bulk API和UDP bulk API批量添加文档。通常的bulk API采用HTTP协议，UDP bulk API采用非连接的数据包协议。UDP协议传输速度会更快，但是可靠性要差一点。最后一种办法就是通过river插件。river运行在ElasticSearch集群的节点上，能够从外部系统中获取数据。</p>
<p>​    有一点需要注意，索引数据的操作只会发生在主分片(primary shard)上，而不会发生在分片副本(Replica) 上。如果索引数据的请求发送到的节点没有合适的分片或者分片是副本，那么请求会被转发到含有主分片的节点。</p>
<p><img src="/images/elasticsearch/elasticsearch3.png" alt=""></p>
<h4 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h4><p>​    查询API在ElasticSearch中有着很大的比重。通过使用Query DSL（基于JSON，用来构建复杂查询的语言），我们能够：</p>
<ul>
<li>使用各种类型的查询方式，包括：简单的关键词查询(termquery) 、短语(phrase)、区间(range)、布尔(boolean)、模糊(fuzzy)、跨度(span)、通配符(wildcard)、地理位置(spatial)等其它类型的查询方式。</li>
<li>通过组合简单查询构建出复杂的查询。</li>
<li>过滤文档，去除不符合标准的文档而且不影响打分排序。</li>
<li>查找给定文档的相似文档。</li>
<li>查找给定短语的搜索建议和查询短语修正。</li>
<li>通过faceting构建动态的导航和数据统计</li>
<li>使用prospective search而且找到匹配写定文档的查询语句。(关于prospective search，似乎是一种推送方式。即把用户的查询语句存储到索引中，如果新的文档添加到索引中，就把文档关联到匹配的查询语句中。这种查询适合于新闻、博客等会定时更新的应用场景)</li>
</ul>
<p>​    关于数据查询，其核心点在于查询过程不是一个简单、单一的流程。通常这个过程分为两个阶段：查询分发阶段和结果汇总阶段。在查询分发阶段，会从各个分片中查询数据；在结果汇总阶段，会把从各个分片上查询到的结果进行合并、排序等其它处理过程，然后返回给用户。</p>
<p><img src="/images/elasticsearch/elasticsearch4.png" alt=""></p>
<p>​    用户可以通过指定搜索类型来控制查询的分发和汇总过程，目前搜索类型只有6种可选值。在Packt出版的《ElasticSearch Server》一书中，已经讲述了查询范围(query scope)这一知识点.</p>
<h4 id="索引参数设置"><a href="#索引参数设置" class="headerlink" title="索引参数设置"></a>索引参数设置</h4><p>​    前面已经提到ElasticSearch索引参数的自动化配置和文档结构及域类型的自动识别。当然，ElasticSearch也允许用户自行修改默认配置。用户可以自行配置很多参数，比如通过mapping配置索引中的文档结构，设置分片(shard)和副本(replica)的的个数，设置文本分析组件……</p>
<h4 id="集群管理和监控"><a href="#集群管理和监控" class="headerlink" title="集群管理和监控"></a>集群管理和监控</h4><p>​    通过管理和监控部分的API，用户可以更改集群的设置。比如调整节点发现机制(discovery mechanism) 或者更改索引的分片策略。用户可以查看集群状态信息，或者每个节点和索引和统计信息。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/26/Lucene介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/26/Lucene介绍/" itemprop="url">
                  Lucene介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-26 11:02:50" itemprop="dateCreated datePublished" datetime="2019-06-26T11:02:50+08:00">2019-06-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-01-15 12:29:09" itemprop="dateModified" datetime="2020-01-15T12:29:09+08:00">2020-01-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>​    为了更深入地理解ElasticSearch的工作原理，特别是索引和查询这两个过程，理解Lucene的工作原理至关重要。本质上，ElasticSearch是用Lucene来实现索引的查询功能的。</p>
<p>​    Lucene是一个成熟的、高性能的、可扩展的、轻量级的，而且功能强大的搜索引擎包。Lucene的核心jar包只有一个文件，而且不依赖任何第三方jar包。更重要的是，它提供的索引数据和检索数据的功能开箱即用。当然，Lucene也提供了多语言支持，具有拼写检查、高亮等功能；但是如果你不需要这些功能，你只需要下载Lucene的核心jar包，应用到你的项目中就可以了。</p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li><p><strong>analyzer</strong>：Analyzer是分析器，它的作用是把一个字符串按某种规则划分成一个个词语，并去除其中的无效词语，这里说的无效词语是指英文中的“of”、“the”，中文中的“的”、“地”等词语，这些词语在文章中大量出现，但是本身不包含什么关键信息，去掉有利于缩小索引文件、提高效率与命中率。分词的规则千变万化，但目的只有一个：按语义划分。这点在英文中比较容易实现，因为英文本身就是以单词为单位的，已经用空格分开；而中文则必须以某种方法将连成一片的句子划分成一个个词语</p>
</li>
<li><p><strong>Document</strong>：一个Document代表索引库中的一条记录（书目录中的其中一个条目），也叫做文档。要搜索的信息封装成Document后通过IndexWriter写入索引库。调用Searcher接口按关键词搜索后，返回的也是一个封装后的Document列表。它是在索引和搜索过程中数据的主要表现形式，或者称“载体”，承载着我们索引和搜索的数据，它由一个或者多个域(Field)组成。用户提供的源是一条条记录，它们可以是文本文件、字符串或者数据库表的一条记录等等。一条记录经过索引之后，就是以一个Document的形式存储在索引文件中的。用户进行搜索，也是以Document列表的形式返回。</p>
</li>
<li><strong>Field</strong>：它是Document的组成部分，由两部分组成，名称(name)和值(value)。一个Document可以包含多个信息域，一个Document可以包含多个列，叫做Field。例如一篇文章可以包含“标题”、“正文”、“最后修改时间”等信息域，这些信息域就是通过Field在Document中存储的。Field有两个属性可选：存储和索引。通过存储属性你可以控制是否对这个Field进行存储；通过索引属性你可以控制是否对该Field进行索引。这看起来似乎有些废话，事实上对这两个属性的正确组合很重要，下面举例说明：还是以刚才的文章为例子，我们需要对标题和正文进行全文搜索，所以我们要把索引属性设置为真，同时我们希望能直接从搜索结果中提取文章标题，所以我们把标题域的存储属性设置为真，但是由于正文域太大了，我们为了缩小索引文件大小，将正文域的存储属性设置为假，当需要时再直接读取文件；我们只是希望能从搜索结果中提取最后修改时间，不需要对它进行搜索，所以我们把最后修改时间域的存储属性设置为真，索引属性设置为假。上面的三个域涵盖了两个属性的三种组合，还有一种全为假的没有用到，事实上Field不允许你那么设置，因为既不存储又不索引的域是没有意义的。</li>
<li><strong>Term</strong>：term是搜索的最小单位，它表示文档的一个词语，term由两部分组成：它表示的词语和这个词语所出现的field。</li>
<li><strong>Token</strong>：Analyzer返回的结果就是一串Token。Token包含一个代表词本身含义的字符串（也就是词本身）和该词在文章中相应的起止偏移位置，Token还包含一个用来存储词类型的字符串。token是term的一次出现，它包含term文本和相应的起止偏移，以及一个类型字符串。一句话中可以出现多次相同的词语，它们都用同一个term表示，但是用不同的token，每个token标记该词语出现的地方。</li>
<li><strong>segment</strong>：添加索引时并不是每个document都马上添加到同一个索引文件，它们首先被写入到不同的小文件，然后再合并成一个大索引文件，这里每个小文件都是一个segment。</li>
</ul>
<p>​    Apache Lucene把所有的信息都写入到一个称为<strong>倒排索引</strong>的数据结构中。这种数据结构把索引中的每个Term与相应的Document映射起来，这与关系型数据库存储数据的方式有很大的不同。读者可以把倒排索引想象成这样的一种数据结构：数据以Term为导向，而不是以Document为导向。下面看看一个简单的倒排索引是什么样的，假定我们的Document只有title域(Field)被编入索引，Document如下：</p>
<ul>
<li><p>ElasticSearch Server (document 1)</p>
</li>
<li><p>Mastering ElasticSearch (document 2)</p>
</li>
<li><p>Apache Solr 4 Cookbook (document 3)</p>
</li>
</ul>
<p>所以索引(以一种直观的形式)展现如下：</p>
<table>
<thead>
<tr>
<th>Term</th>
<th>count</th>
<th>Docs</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>1</td>
<td><3></3></td>
</tr>
<tr>
<td>Apache</td>
<td>1</td>
<td><3></3></td>
</tr>
<tr>
<td>Cookbook</td>
<td>1</td>
<td><3></3></td>
</tr>
<tr>
<td>ElasticSearch</td>
<td>2</td>
<td><1> <2></2></1></td>
</tr>
<tr>
<td>Mastering</td>
<td>1</td>
<td><2></2></td>
</tr>
<tr>
<td>Server</td>
<td>1</td>
<td><1></1></td>
</tr>
<tr>
<td>Solr</td>
<td>1</td>
<td><3></3></td>
</tr>
</tbody>
</table>
<p>​    正如所看到的那样，每个词都指向它所在的文档号(Document Number/Document ID)。这样的存储方式使得高效的信息检索成为可能，比如基于词的检索(term-based query)。此外，每个词映射着一个数值(Count)，它代表着Term在文档集中出现的频繁程度。</p>
<p>​    当然，Lucene创建的真实索引远比上文复杂和先进。这是因为在Lucene中，<strong>词向量</strong>(由单独的一个Field形成的小型倒排索引，通过它能够获取这个特殊Field的所有Token信息)可以存储；所有Field的原始信息可以存储；删除Document的标记信息可以存储……。核心在于了解数据的组织方式，而非存储细节。</p>
<p>​    每个索引被分成了多个段(Segment)，段具有一次写入，多次读取的特点。只要形成了，段就无法被修改。例如：被删除文档的信息被存储到一个单独的文件，但是其它的段文件并没有被修改。</p>
<p>​    需要注意的是，多个段是可以合并的，这个合并的过程称为<strong>segments merge</strong>。经过强制合并或者Lucene的合并策略触发的合并操作后，原来的多个段就会被Lucene创建的更大的一个段所代替了。很显然，段合并的过程是一个I/O密集型的任务。这个过程会清理一些信息，比如会删除.del文件。除了精减文件数量，段合并还能够提高搜索的效率，毕竟同样的信息在一个段中读取会比在多个段中读取要快得多。但是，由于段合并是I/O密集型任务，建议不要强制合并，小心地配置好合并策略就可以了。</p>
<h4 id="分析你的文本"><a href="#分析你的文本" class="headerlink" title="分析你的文本"></a>分析你的文本</h4><p>​    问题到这里就变得稍微复杂了一些。传入到Document中的数据是如何转变成倒排索引的？查询语句是如何转换成一个个Term使高效率文本搜索变得可行？这种转换数据的过程就称为文本分析(analysis)</p>
<p>​    文本分析工作由<strong>analyzer</strong>组件负责。analyzer由一个分词器(tokenizer)和0个或者多个过滤器(filter)组成,也可能会有0个或者多个字符映射器(character mappers)组成。</p>
<p>​    Lucene中的<strong>tokenizer</strong>用来把文本拆分成一个个的Token。Token包含了比较多的信息，比如Term在文本的中的位置及Term原始文本，以及Term的长度。文本经过<strong>tokenizer</strong>处理后的结果称为token stream。token stream其实就是一个个Token的顺序排列。token stream将等待着filter来处理。</p>
<p>​    除了<strong>tokenizer</strong>外，Lucene的另一个重要组成部分就是filter链，filter链将用来处理Token Stream中的每一个token。这些处理方式包括删除Token，改变Token，甚至添加新的Token。Lucene中内置了许多filter，读者也可以轻松地自己实现一个filter。有如下内置的filter：</p>
<ul>
<li><p><strong>Lowercase filter</strong>：把所有token中的字符都变成小写</p>
</li>
<li><p><strong>ASCII folding filter</strong>：去除tonken中非ASCII码的部分</p>
</li>
<li><p><strong>Synonyms filter</strong>：根据同义词替换规则替换相应的token</p>
</li>
<li><p><strong>Multiple language-stemming filters</strong>：把Token(实际上是Token的文本内容)转化成词根或者词干的形式。</p>
<p>所以通过Filter可以让analyzer有几乎无限的处理能力：因为新的需求添加新的Filter就可以了。</p>
</li>
</ul>
<h4 id="索引和查询"><a href="#索引和查询" class="headerlink" title="索引和查询"></a>索引和查询</h4><p>​    在我们用Lucene实现搜索功能时，也许会有读者不明白：上述的原理是如何对索引过程和搜索过程产生影响？</p>
<p>​    索引过程：Lucene用用户指定好的analyzer解析用户添加的Document。当然Document中不同的Field可以指定不同的analyzer。如果用户的Document中有title和description两个Field，那么这两个Field可以指定不同的analyzer。</p>
<p>​    搜索过程：用户的输入查询语句将被选定的查询解析器(query parser)所解析，生成多个Query对象。当然用户也可以选择不解析查询语句，使查询语句保留原始的状态。在ElasticSearch中，有的Query对象会被解析(analyzed)，有的不会，比如：前缀查询(prefix query)就不会被解析，精确匹配查询(match query)就会被解析。对用户来说，理解这一点至关重要。</p>
<p>​    对于索引过程和搜索过程的数据解析这一环节，我们需要把握的重点在于：倒排索引中词应该和查询语句中的词正确匹配。如果无法匹配，那么Lucene也不会返回我们想要的结果。举个例子：如果在索引阶段对文本进行了转小写(lowercasing)和转变成词根形式(stemming)处理，那么查询语句也必须进行相同的处理，不然搜索结果就会是竹篮打水一场空。</p>
<h3 id="Lucene查询语言"><a href="#Lucene查询语言" class="headerlink" title="Lucene查询语言"></a>Lucene查询语言</h3><h4 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h4><p>​    用户使用Lucene进行查询操作时，输入的查询语句会被分解成一个或者多个Term以及逻辑运算符号。一个Term，在Lucene中可以是一个词，也可以是一个短语(用双引号括起来的多个词)。如果事先设定规则：解析查询语句，那么指定的analyzer就会用来处理查询语句的每个term形成Query对象。</p>
<p>​    一个Query对象中会存在多个布尔运算符，这些布尔运算符将多个Term关联起来形成查询子句。布尔运算符号有如下类型：</p>
<ul>
<li><p>AND(与)：给定两个Term(左运算对象和右运算对象)，形成一个查询表达式。只有两个Term都匹配成功，查询子句才匹配成功。比如：查询语句”apache AND lucene”的意思是匹配含apache且含lucene的文档。</p>
</li>
<li><p>OR(或)：给定的多个Term，只要其中一个匹配成功，其形成的查询表达式就匹配成功。比如查询表达式”apache OR lucene”能够匹配包含“apache”的文档，也能匹配包含”lucene”的文档，还能匹配同时包含这两个Term的文档。</p>
</li>
<li><p>NOT(非)：这意味着对于与查询语句匹配的文档，NOT运算符后面的Term就不能在文档中出现。例如：查询表达式“lucene NOT elasticsearch”就只能匹配包含lucene但是不含elasticsearch的文档。</p>
<p>此外，我们也许会用到如下的运算符：</p>
</li>
<li><p><strong>+</strong>：如果想要查询语句与文档匹配，那么给定的Term必须出现在文档中。例如：希望搜索到包含关键词lucene，最好能包含关键词apache的文档，可以用如下的查询表达式：”+lucene apache”。</p>
</li>
<li><p><strong>-</strong>：如果想要查询语句与文档匹配，那么给定的Term不能出现在文档中。例如：希望搜索到包含关键词lucene，但是不含关键词elasticsearch的文档，可以用如下的查询表达式：”+lucene -elasticsearch”。</p>
<p>如果在Term前没有指定运算符，那么默认使用OR运算符。</p>
<p>此外，也是最后一点：查询表达式可以用小括号组合起来，形成复杂的查询表达式。比如：</p>
</li>
</ul>
<figure class="highlight plain"><figcaption><span>AND (mastering OR book)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 多域查询</span><br><span class="line"></span><br><span class="line">​	当然，跟ElasticSearch一样，Lucene中的所有数据都是存储在一个个的Field中，多个Field形成一个Document。如果希望查询指定的Field，就需要在查询表达式中指定Field Name(此域名非彼域名)，后面接一个冒号，紧接着一个查询表达式。例如：查询title域中包含关键词elasticsearch的文档，查询表达式如下：</span><br><span class="line"></span><br><span class="line">```title:elasticsearch</span><br></pre></td></tr></table></figure>
<p>​    也可以把多个查询表达式用于一个域中。例如：查询title域中含关键词elasticsearch并且含短语“mastering book”的文档，查询表达式如下：</p>
<figure class="highlight plain"><figcaption><span>+"mastering book")```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">​	当然，也可以换一种写法，作用是一样的：</span><br><span class="line"></span><br><span class="line">```+title:elasticsearch +title:&quot;mastering book&quot;)</span><br></pre></td></tr></table></figure>
<p>​    另外，Lucene支持模糊查询(fuzzy query)和邻近查询(proximity query)。语法规则是查询表达式后面接一个~号，后面紧跟一个整数。如果查询表达式是单独一个Term，这表示我们的搜索关键词可以由Term变形（替换一个字符，添加一个字符，删除一个字符）而来，即与Term是相似的。这种搜索方式称为模糊搜索(fuzzy query)。在~符号后面的整数表示最大编辑距离。例如：执行查询表达式“writer~2”能够搜索到含writer和writers的文档。</p>
<p>​    当~符号用于一个短语时，~后面的整数表示短语中可接收的最大的词编辑距离（短语中替换一个词，添加一个词，删除一个词）。举个例子，查询表达式<figure class="highlight plain"><figcaption><span>elasticsearch"```只能匹配title域中含"mastering elasticsearch"的文档，而无法匹配含"mastering book elasticsearch"的文档。但是如果查询表达式变成```title:"mastering elasticsearch"~2```，那么两种文档就都能够成功匹配了。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">​	另外，我们还可以使用加权（boosting）机制来改变关键词的重要程度。加权机制的语法是一个^符号后面接一个浮点数表示权重。如果权重小于1，就会降低关键词的重要程度。同理，如果权重大于1就会增加关键词的重要程度。默认的加权值为1。</span><br><span class="line"></span><br><span class="line">​	除了上述的功能外，Lucene还支持区间查询（range scarching），其语法是用中括号或者&#125;表示区间。例如：如果我们查询一个数值域（numeric field），可以用如下查询表达式：</span><br><span class="line"></span><br><span class="line">```price:[10.00 TO 15.00]</span><br></pre></td></tr></table></figure></p>
<p>​    这条查询表达式能查询到price域的值在10.00到15.00之间的所有文档。</p>
<p>​    对于string类型的field，区间查询也同样适用。例如：</p>
<figure class="highlight plain"><figcaption><span>TO Adria]```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">​	这条查询表达式能查询到name域中含关键词Adam到关键词Adria之间关键词（字符串升序，且闭区间）的文档。</span><br><span class="line"></span><br><span class="line">​	如果希望区间的边界值不会被搜索到，那么就需要用大括号替换原来的中括号。例如，查询price域中价格在10.00(10.00要能够被搜索到)到15.00(15.00不能被搜索到)之间的文档，就需要用如下的查询表达式：</span><br><span class="line"></span><br><span class="line">```price:[10.00 TO 15.00&#125;</span><br></pre></td></tr></table></figure>
<h4 id="处理特殊字符"><a href="#处理特殊字符" class="headerlink" title="处理特殊字符"></a>处理特殊字符</h4><p>​    如果在搜索关键词中出现了如下字符集合中的任意一个字符，就需要用反斜杠(\)进行转义。字符集合如下： +, -, &amp;&amp;, || , ! , (,) , { } , [ ] , ^, “ , ~, *, ?, : , \, / 。例如，查询关键词 abc”efg 就需要转义成 abc\”efg。</p>
<p>请注意出于性能考虑，默认的通配符不能是关键词的首字母。</p>
<p>![img](<a href="https://doc.yonyoucloud.com/doc/mastering-elasticsearch/notes/rm.png" target="_blank" rel="noopener">https://doc.yonyoucloud.com/doc/mastering-elasticsearch/notes/rm.png</a></p>
<p>此外，Lucene支持模糊查询(fuzzy query)和邻近查询(proximity query)。语法规则是查询表达式后面接一个~符号，后面紧跟一个整数。如果查询表达式是单独一个Term，这表示我们的搜索关键词可以由Term变形(替换一个字符，添加一个字符，删除一个字符)而来，即与Term是相似的。这种搜索方式称为模糊搜索(fuzzy search)。在~符号后面的整数表示最大编辑距离。例如：执行查询表达式 “writer~2”能够搜索到含writer和writers的文档。</p>
<p>当~符号用于一个短语时，~后面的整数表示短语中可接收的最大的词编辑距离(短语中替换一个词，添加一个词，删除一个词)。举个例子,查询表达式title:”mastering elasticsearch”只能匹配title域中含”mastering elasticsearch”的文档，而无法匹配含”mastering book elasticsearch”的文档。但是如果查询表达式变成title:”mastering elasticsearch”~2,那么两种文档就都能够成功匹配了。</p>
<p>此外，我们还可以使用加权(boosting)机制来改变关键词的重要程度。加权机制的语法是一个^符号后面接一个浮点数表示权重。如果权重小于1，就会降低关键词的重要程度。同理，如果权重大于1就会增加关键词的重要程度。默认的加权值为1。可以参考 第2章 活用用户查询语言 的 Lucene默认打分规则详解 章节部分的内容来了解更多关于加权(boosting)是如何影响打分排序的。</p>
<p>除了上述的功能外，Lucene还支持区间查询(range searching),其语法是用中括号或者}表示区间。例如：如果我们查询一个数值域(numeric field)，可以用如下查询表达式：</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/20/varnish使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/20/varnish使用/" itemprop="url">
                  varnish使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-20 10:16:40 / 修改時間：11:54:26" itemprop="dateCreated datePublished" datetime="2019-06-20T10:16:40+08:00">2019-06-20</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/缓存服务/" itemprop="url" rel="index"><span itemprop="name">缓存服务</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">yum install -y varnish </span><br><span class="line">yum install -y varnish-docs.x86_64</span><br></pre></td></tr></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/varnish:</span><br><span class="line">NFILES=131072        # 所能够打开的最大文件数</span><br><span class="line">MEMLOCK=82000       # 用多大内存空间保存日志信息</span><br><span class="line">NPROCS="unlimited"</span><br><span class="line">DAEMON_COREFILE_LIMIT="unlimited"    # 进程核心转储所使用的内存空间，unlimited表示无上限</span><br><span class="line">RELOAD_VCL=1        # 重新启动服务时是否重新读取VCL并重新编译的</span><br><span class="line">VARNISH_VCL_CONF=/etc/varnish/config/default.vcl        # 默认读取的VCL文件</span><br><span class="line">VARNISH_LISTEN_PORT=6081        # 监听的端口，默认监听6081</span><br><span class="line">VARNISH_ADMIN_LISTEN_ADDRESS=127.0.0.1        # 管理接口监听的地址</span><br><span class="line">VARNISH_ADMIN_LISTEN_PORT=6082        # 管理接口监听的端口</span><br><span class="line">VARNISH_SECRET_FILE=/etc/varnish/secret        # 使用的密钥文件</span><br><span class="line">VARNISH_MIN_THREADS=50        # 最少线程数</span><br><span class="line">VARNISH_MAX_THREADS=1000        # 最大线程数</span><br><span class="line">VARNISH_THREAD_TIMEOUT=120        # 线程的超时时间</span><br><span class="line">VARNISH_STORAGE_SIZE=2046M        # 存储文件的大小</span><br><span class="line">VARNISH_STORAGE="malloc,$&#123;VARNISH_STORAGE_SIZE&#125;"        # 存储的文件格式</span><br><span class="line"><span class="meta">#</span><span class="bash"> file：单个文件，不支持持久机制</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> malloc：内存</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> persistent：基于文件的持久存储</span></span><br><span class="line">VARNISH_TTL=120       # 联系后端服务器的超时时间</span><br><span class="line">DAEMON_OPTS="-a $&#123;VARNISH_LISTEN_ADDRESS&#125;:$&#123;VARNISH_LISTEN_PORT&#125; \</span><br><span class="line">             -f $&#123;VARNISH_VCL_CONF&#125; \</span><br><span class="line">             -T $&#123;VARNISH_ADMIN_LISTEN_ADDRESS&#125;:$&#123;VARNISH_ADMIN_LISTEN_PORT&#125; \</span><br><span class="line">             -t $&#123;VARNISH_TTL&#125; \</span><br><span class="line">             -p thread_pool_min=$&#123;VARNISH_MIN_THREADS&#125; \</span><br><span class="line">             -p thread_pool_max=$&#123;VARNISH_MAX_THREADS&#125; \</span><br><span class="line">             -p thread_pool_timeout=$&#123;VARNISH_THREAD_TIMEOUT&#125; \</span><br><span class="line">             -u varnish -g varnish \</span><br><span class="line">             -S $&#123;VARNISH_SECRET_FILE&#125; \</span><br><span class="line">             -s $&#123;VARNISH_STORAGE&#125;"       # 使用定义的各高级配置的参数</span><br></pre></td></tr></table></figure>
<h4 id="vcl文件"><a href="#vcl文件" class="headerlink" title="vcl文件"></a>vcl文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/varnish/default.vcl</span><br><span class="line">vcl 4.0;</span><br><span class="line"></span><br><span class="line">backend default &#123;</span><br><span class="line">    .host = "192.168.1.109";		# 后端服务器地址</span><br><span class="line">    .port = "80";		# 后端服务器端口</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 目前只测试varnish是否可以正常工作，尚未定义缓存属性信息</span></span><br><span class="line">systemctl start varnish</span><br></pre></td></tr></table></figure>
<h4 id="安装配置web服务"><a href="#安装配置web服务" class="headerlink" title="安装配置web服务"></a>安装配置web服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y httpd php php-mysql</span><br><span class="line">vim /var/www/html/index.html</span><br><span class="line">&lt;h1&gt;www.abc.com and varnish of backend&lt;/h1&gt;</span><br><span class="line">&lt;h2&gt;node1.abc.com&lt;/h2&gt;</span><br><span class="line">systemctl start httpd</span><br><span class="line">访问IP:80</span><br><span class="line">访问IP:6081</span><br></pre></td></tr></table></figure>
<h4 id="设置响应是否命中"><a href="#设置响应是否命中" class="headerlink" title="设置响应是否命中"></a>设置响应是否命中</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim default.vcl</span><br><span class="line">sub vcl_deliver &#123;</span><br><span class="line">    if (obj.hits &gt; 0)&#123;</span><br><span class="line">        set resp.http.X-Cache = "HIT from";</span><br><span class="line">        # 判断如果命中了就在http响应首部设置X-Cache为HIT</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        set resp.http.X-Cache = "MISS";</span><br><span class="line">        # 否则就在http响应首部设置X-Cache为MISS</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的语法是<span class="keyword">if</span>(条件)&#123;方法&#125;<span class="keyword">else</span>&#123;方法&#125;，如果满足<span class="keyword">if</span>后面小括号中的条件，就执行小括号后面大括号中的方法，否则执行<span class="keyword">else</span>后面大括号中的方法。</span></span><br><span class="line">varnishadm -S /etc/varnish/secret -T 127.0.0.1:6082</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接varnish，进入varnish的命令操作</span></span><br><span class="line">vcl.load test1 /etc/varnish/default.vcl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在命令行中输入上面命令，加载default.vcl文件，test1是自定义的名称，这应该是一个策略的名称，策略的名称每次都不能一样。</span></span><br><span class="line">vcl.list</span><br><span class="line">vcl.show test1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看test1的策略内容</span></span><br><span class="line">访问IP:6081，之后按F12查看是否有X-Cache一项，如果没有此项，可以重启一下varnish。之后可以看到X-Cache一项为MISS，再次刷新后，此项变为HIT。</span><br></pre></td></tr></table></figure>
<h4 id="指定某些文件不能查缓存"><a href="#指定某些文件不能查缓存" class="headerlink" title="指定某些文件不能查缓存"></a>指定某些文件不能查缓存</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim default.vcl</span><br><span class="line">vcl 4.0;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Default backend definition. Set this to point to your content server.</span></span><br><span class="line">backend default &#123;</span><br><span class="line">    .host = "192.168.1.109";</span><br><span class="line">    .port = "80";</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_recv &#123;</span><br><span class="line"> if (req.url ~ "test.html")&#123;</span><br><span class="line">   return(pass);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">return</span>(lookup);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里不可以加<span class="built_in">return</span>(lookup)，因为varnish4中使用<span class="built_in">return</span>(<span class="built_in">hash</span>)代替了<span class="built_in">return</span>(lookup)。</span></span><br><span class="line">vcl.load test2 /etc/varnish/default.vcl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加载策略</span></span><br><span class="line">访问IP:6081/test.html，无论如何刷新，F12中的x-cache都是MISS</span><br></pre></td></tr></table></figure>
<h4 id="vcl配置文件"><a href="#vcl配置文件" class="headerlink" title="vcl配置文件"></a>vcl配置文件</h4><h5 id="VCL中内置预设变量"><a href="#VCL中内置预设变量" class="headerlink" title="VCL中内置预设变量"></a>VCL中内置预设变量</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">req：The request object，请求到达时可用的变量(客户端发送的请求对象)</span><br><span class="line">bereq：The backend request object，向后端主机请求时可用的变量</span><br><span class="line">beresp：The backend response object，从后端主机获取内容时可用的变量(后端响应请求对象)</span><br><span class="line">resp：The HTTP response object，对客户端响应时可用的变量(返回给客户端的响应对象)</span><br><span class="line">obj：存储在内存中时对象属性相关的可用的变量(高速缓存对象，缓存后端响应请求内容)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">预设变量是系统固定的，请求进入对应的vcl子程序后便生成，这些变量可以方便子程序提取，当然也可以自定义一些全局变量。</span><br><span class="line">当前时间：</span><br><span class="line">now :作用：返回当前时间戳。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">客户端：（客户端基本信息）</span><br><span class="line">client.ip：返回客户端IP地址。</span><br><span class="line">注：原client.port已经弃用，如果要取客户端请求端口号使用 std.port(client.ip)，需要import std;才可以使用std</span><br><span class="line">client.identity：用于装载客户端标识码。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">服务器：（服务器基本信息）</span><br><span class="line">注：原server.port已经弃用，如果要取服务器端口号使用 std.port(server.ip)，需要import std;才可以使用std</span><br><span class="line">server.hostname：服务器主机名。</span><br><span class="line">server.identity：服务器身份标识。</span><br><span class="line">server.ip：返回服务器端IP地址。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">req :（客户端发送的请求对象）</span><br><span class="line">req：整个HTTP请求数据结构</span><br><span class="line">req.backend_hint：指定请求后端节点，设置后 bereq.backend 才能获取后端节点配置数据</span><br><span class="line">req.can_gzip：客户端是否接受GZIP传输编码。</span><br><span class="line">req.hash_always_miss：是否强制不命中高速缓存，如果设置为true，则高速缓存不会命中，一直会从后端获取新数据。</span><br><span class="line">req.hash_ignore_busy：忽略缓存中忙碌的对象，多台缓存时可以避免死锁。</span><br><span class="line">req.http：对应请求HTTP的header。</span><br><span class="line">req.method：请求类型（如 GET , POST）。</span><br><span class="line">req.proto：客户端使用的HTTP协议版本。</span><br><span class="line">req.restarts：重新启动次数。默认最大值是4</span><br><span class="line">req.ttl：缓存有剩余时间。</span><br><span class="line">req.url：请求的URL。</span><br><span class="line">req.xid：唯一ID。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bereq：（发送到后端的请求对象，基于req对象）</span><br><span class="line">bereq：整个后端请求后数据结构。</span><br><span class="line">bereq.backend：所请求后端节点配置。</span><br><span class="line">bereq.between_bytes_timeout：从后端每接收一个字节之间的等待时间（秒）。</span><br><span class="line">bereq.connect_timeout：连接后端等待时间（秒），最大等待时间。</span><br><span class="line">bereq.first_byte_timeout：等待后端第一个字节时间（秒），最大等待时间。</span><br><span class="line">bereq.http：对应发送到后端HTTP的header信息。</span><br><span class="line">bereq.method：发送到后端的请求类型（如：GET , POST）。</span><br><span class="line">bereq.proto：发送到后端的请求的HTTP版本。</span><br><span class="line">bereq.retries：相同请求重试计数。</span><br><span class="line">bereq.uncacheable：无缓存这个请求。</span><br><span class="line">bereq.url：发送到后端请求的URL。</span><br><span class="line">bereq.xid：请求唯一ID。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">beresp：（后端响应请求对象）</span><br><span class="line">beresp：整个后端响应HTTP数据结构。</span><br><span class="line">beresp.backend.ip：后端响应的IP。</span><br><span class="line">beresp.backend.name：响应后端配置节点的name。</span><br><span class="line">beresp.do_gunzip：默认为 false 。缓存前解压该对象</span><br><span class="line">beresp.do_gzip：默认为 false 。缓存前压缩该对象</span><br><span class="line">beresp.grace：设置当前对象缓存过期后可额外宽限时间，用于特殊请求加大缓存时间，当并发量巨大时，不易设置过大否则会堵塞缓存，一般可设置 1m 左右，当beresp.ttl=0s时该值无效。</span><br><span class="line">beresp.http：对应的HTTP请求header</span><br><span class="line">beresp.keep：对象缓存后带保持时间</span><br><span class="line">beresp.proto：响应的HTTP版本</span><br><span class="line">beresp.reason：由服务器返回的HTTP状态信息</span><br><span class="line">beresp.status：由服务器返回的状态码</span><br><span class="line">beresp.storage_hint：指定保存的特定存储器</span><br><span class="line">beresp.ttl：该对象缓存的剩余时间，指定统一缓存剩余时间。</span><br><span class="line">beresp.uncacheable：继承bereq.uncacheable，是否不缓存</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OBJ ：（高速缓存对象，缓存后端响应请求内容）</span><br><span class="line">obj.grace：该对象额外宽限时间</span><br><span class="line">obj.hits：缓存命中次数，计数器从1开始，当对象缓存该值为1，一般可以用于判断是否有缓存，当前该值大于0时则为有缓存。</span><br><span class="line">obj.http：对应HTTP的header</span><br><span class="line">obj.proto：HTTP版本</span><br><span class="line">obj.reason：服务器返回的HTTP状态信息</span><br><span class="line">obj.status：服务器返回的状态码</span><br><span class="line">obj.ttl：该对象缓存剩余时间（秒）</span><br><span class="line">obj.uncacheable：不缓存对象</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">resp :（返回给客户端的响应对象）</span><br><span class="line">resp：整个响应HTTP数据结构。</span><br><span class="line">resp.http：对应HTTP的header。</span><br><span class="line">resp.proto：编辑响应的HTTP协议版本。</span><br><span class="line">resp.reason：将要返回的HTTP状态信息。</span><br><span class="line">resq.status：将要返回的HTTP状态码。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">存储 ：</span><br><span class="line">storage.&lt;name&gt;.free_space：存储可用空间（字节数）。</span><br><span class="line">storage.&lt;name&gt;.used_space：存储已经使用空间（字节数）。</span><br><span class="line">storage.&lt;name&gt;.happy：存储健康状态。</span><br></pre></td></tr></table></figure>
<h5 id="特定功能性语句"><a href="#特定功能性语句" class="headerlink" title="特定功能性语句"></a>特定功能性语句</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">ban(expression)：清除指定对象缓存</span><br><span class="line">call(subroutine)：调用子程序，如：call(name);</span><br><span class="line">hash_data(input)：生成hash键，用于制定hash键值生成结构，只能在vcl_hash子程序中使用。调用hash_data(input) 后，即这个hash为当前页面的缓存hash键值，无需其它获取或操作，如:</span><br><span class="line">=======================================================================================</span><br><span class="line">sub vcl_hash&#123;</span><br><span class="line">       hash_data(client.ip);</span><br><span class="line">       return(lookup);</span><br><span class="line">&#125;</span><br><span class="line">=======================================================================================</span><br><span class="line">注意：return(lookup);是默认返回值，所以可以不写。</span><br><span class="line">new()：创建一个vcl对象，只能在vcl_init子程序中使用。</span><br><span class="line">return()：结束当前子程序，并指定继续下一步动作，如：return (ok); 每个子程序可指定的动作均有不同。</span><br><span class="line">rollback()：恢复HTTP头到原来状态，已经弃用，使用 std.rollback() 代替。</span><br><span class="line">synthetic(STRING)：合成器，用于自定义一个响应内容，比如当请求出错时，可以返回自定义 404 内容，而不只是默认头信息，只能在 vcl_synth 与 vcl_backend_error 子程序中使用，如：</span><br><span class="line">=======================================================================================</span><br><span class="line">sub vcl_synth &#123;</span><br><span class="line">    //自定义内容</span><br><span class="line">    synthetic (&#123;"</span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;</span><br><span class="line">&lt;html lang="zh-cn"&gt;</span><br><span class="line">   &lt;head&gt;</span><br><span class="line">   &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt;</span><br><span class="line">      &lt;title&gt;error&lt;/title&gt;</span><br><span class="line">   &lt;/head&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">      &lt;h1&gt;Error&lt;/h1&gt;</span><br><span class="line">      &lt;h3&gt;这只是一个测试自定义响应异常内容&lt;/h3&gt;</span><br><span class="line">   &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">    "&#125;);</span><br><span class="line">    //只交付自定义内容</span><br><span class="line">    return(deliver);</span><br><span class="line">=======================================================================================</span><br><span class="line">regsub(str, regex, sub)：使用正则替换第一次出现的字符串，第一个参数为待处理字符串，第二个参数为正则表达式，第三个为替换为字符串。</span><br><span class="line">regsuball(str, regex, sub)：使用正则替换所有匹配字符串。参数与regsuball相同。</span><br><span class="line">具体变量详见：</span><br><span class="line">https://www.varnish-cache.org/docs/4.0/reference/vcl.html#reference-vcl</span><br></pre></td></tr></table></figure>
<h5 id="return-语句"><a href="#return-语句" class="headerlink" title="return 语句"></a>return 语句</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">return 语句是终止子程序并返回动作，所有动作都根据不同的vcl子程序限定来选用。</span><br><span class="line">https://www.varnish-cache.org/docs/4.0/users-guide/vcl-built-in-subs.html</span><br><span class="line"></span><br><span class="line">语法：return(action);</span><br><span class="line">常用的动作：</span><br><span class="line">abandon  放弃处理，并生成一个错误。</span><br><span class="line">deliver  交付处理</span><br><span class="line">fetch  从后端取出响应对象</span><br><span class="line">hash  哈希缓存处理</span><br><span class="line">lookup 查找缓存对象</span><br><span class="line">ok 继续执行</span><br><span class="line">pass  进入pass非缓存模式</span><br><span class="line">pipe 进入pipe非缓存模式</span><br><span class="line">purge 清除缓存对象，构建响应</span><br><span class="line">restart 重新开始</span><br><span class="line">retry 重试后端处理</span><br><span class="line">synth(status code,reason) 合成返回客户端状态信息</span><br></pre></td></tr></table></figure>
<h5 id="varnish中内置子程序"><a href="#varnish中内置子程序" class="headerlink" title="varnish中内置子程序"></a>varnish中内置子程序</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">注意：varnish内置子程序均有自己限定的返回动作  return （动作）;  不同的动作将调用对应下一个子程序。</span><br><span class="line"></span><br><span class="line">vcl_recv子程序：</span><br><span class="line">开始处理请求，通过 return (动作); 选择varnish处理模式，默认进入hash缓存模式（即return(hash);），缓存时间为配置项default_ttl（默认为 120秒）过期保持时间default_grace（默认为10秒）。该子程序一般用于模式选择，请求对象缓存及信息修改，后端节点修改，终止请求等操作。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line">pass  进入pass模式，并进入vcl_pass子程序。</span><br><span class="line">pipe  进入pipe模式，并进入vcl_pipe子程序。</span><br><span class="line">hash  进入hash缓存模式，并进入vcl_hash子程序，默认返回值。</span><br><span class="line">purge  清除缓存等数据，子程序先从vcl_hash再到vcl_purge。</span><br><span class="line"></span><br><span class="line">vcl_pipe子程序：</span><br><span class="line">pipe模式处理，该模式主要用于直接取后端响应内容返回客户端，可定义响应内容返回客户端。该子程序一般用于需要及时且不作处理的后端信息，取出后端响应内容后直接交付到客户端不进入vcl_deliver子程序处理。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，bereq，req，storage</span><br><span class="line">写：client，bereq，req</span><br><span class="line">返回值：</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line">pipe  继续pipe模式，进入后端vcl_backend_fetch子程序，默认返回值。</span><br><span class="line"></span><br><span class="line">vcl_pass子程序：</span><br><span class="line">pass模式处理，该模式类似hash缓存模式，仅不做缓存处理。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line">fetch  继续pass模式，进入后端vcl_backend_fetch子程序，默认返回值。</span><br><span class="line"></span><br><span class="line">vcl_hit子程序：</span><br><span class="line">hash缓存模式时，存在hash缓存时调用，用于缓存处理，可放弃或修改缓存。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，obj，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">restart 重启请求。</span><br><span class="line">deliver 交付缓存内容，进入vcl_deliver子程序处理，默认返回值。</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line"></span><br><span class="line">vcl_miss子程序：</span><br><span class="line">hash缓存模式时，不存在hash缓存时调用，用于判断性的选择进入后端取响应内容，可以修改为pass模式。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">restart 重启请求。</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line">pass 切换到pass模式，进入vcl_pass子程序。</span><br><span class="line">fetch  正常取后端内容再缓存，进入vcl_backend_fetch子程序，默认返回值。</span><br><span class="line"></span><br><span class="line">vcl_hash子程序：</span><br><span class="line">hash缓存模式，生成hash值作为缓存查找键名提取缓存内容，主要用于缓存hash键值处理，可使用hash_data(string)指定键值组成结构，可在同一个页面通过IP或cookie生成不同的缓存键值。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">lookup 查找缓存对象，存在缓存进入vcl_hit子程序，不存在缓存进入vcl_miss子程序，当使用了purge清理模式时会进入vcl_purge子程序，默认返回值。</span><br><span class="line"></span><br><span class="line">vcl_purge子程序：</span><br><span class="line">清理模式，当查找到对应的缓存时清除并调用，用于请求方法清除缓存，并报告.</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line">restart 重启请求。</span><br><span class="line"></span><br><span class="line">vcl_deliver子程序：</span><br><span class="line">客户端交付子程序，在vcl_backend_response子程序后调用（非pipe模式），或vcl_hit子程序后调用，可用于追加响应头信息，cookie等内容。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，resp，obj，storage</span><br><span class="line">写：client，req，resp</span><br><span class="line">返回值：</span><br><span class="line">deliver 正常交付后端或缓存响应内容，默认返回值。</span><br><span class="line">restart 重启请求。</span><br><span class="line"></span><br><span class="line">vcl_backend_fetch子程序：</span><br><span class="line">发送后端请求之前调用，可用于改变请求地址或其它信息，或放弃请求。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：server，bereq，storage</span><br><span class="line">写：bereq</span><br><span class="line">返回值：</span><br><span class="line">fetch 正常发送请求到到后端取出响应内容，进入vcl_backend_response子程序，默认返回值。</span><br><span class="line">abandon 放弃后端请求，并生成一个错误，进入vcl_backend_error子程序。</span><br><span class="line"></span><br><span class="line">vcl_backend_response子程序：</span><br><span class="line">后端响应后调用，可用于修改缓存时间及缓存相关信息。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：server，bereq，beresp，storage</span><br><span class="line">写：bereq，beresp</span><br><span class="line">返回值：</span><br><span class="line">deliver 正常交付后端响应内容，进入vcl_deliver子程序，默认返回值。</span><br><span class="line">abandon 放弃后端请求，并生成一个错误，进入vcl_backend_error子程序。</span><br><span class="line">retry 重试后端请求，重试计数器加1，当超过配置中max_retries值时会报错并进入vcl_backend_error子程序。</span><br><span class="line"></span><br><span class="line">vcl_backend_error子程序：</span><br><span class="line">后端处理失败调用，异常页面展示效果处理，可自定义错误响应内容，或修改beresp.status与beresp.http.Location重定向等。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：server，bereq，beresp，storage</span><br><span class="line">写：bereq，beresp</span><br><span class="line">返回值：</span><br><span class="line">deliver 只交付 sysnthetic(string) 自定义内容，默认返回后端异常标准错误内容。</span><br><span class="line">retry 重试后端请求，重试计数器加1，当超过配置中max_retries值时会报错并进入vcl_backend_error子程序。</span><br><span class="line"></span><br><span class="line">vcl_synth子程序：</span><br><span class="line">自定义响应内容。可以通过synthetic（）和返回值 synth调用，这里可以自定义异常显示内容，也可以修改resp.status与resp.http.Location重定向。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，resp，storage</span><br><span class="line">写：req，resp</span><br><span class="line">返回值：</span><br><span class="line">deliver 只交付 sysnthetic(string) 自定义内容，默认返回 sysnth 异常指定状态码与错误内容。</span><br><span class="line">restart 重启请求。</span><br><span class="line"></span><br><span class="line">vcl_init子程序：</span><br><span class="line">加载vcl时最先调用，用于初始化VMODs，该子程序不参与请求处理，仅在vcl加载时调用一次。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：server</span><br><span class="line">写：无</span><br><span class="line">返回值：</span><br><span class="line">ok 正常返回，进入vcl_recv子程序，默认返回值。</span><br><span class="line"></span><br><span class="line">vcl_fini子程序：</span><br><span class="line">卸载当前vcl配置时调用，用于清理VMODs，该子程序不参与请求处理，仅在vcl正常丢弃后调用。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：server</span><br><span class="line">写：无</span><br><span class="line">返回值：</span><br><span class="line">ok 正常返回，本次vcl将释放，默认返回值。</span><br></pre></td></tr></table></figure>
<p>varnish子程序调用流程图，通过大部分子程序的return返回值进入下一步行动：</p>
<p><img src="/images/varnish/varnish子程序return返回值.png" alt=""></p>
<h5 id="优雅模式-Garce-mode"><a href="#优雅模式-Garce-mode" class="headerlink" title="优雅模式(Garce mode)"></a>优雅模式(Garce mode)</h5><p>Varnish中的请求合并</p>
<p>当几个客户端请求同一个页面的时候，varnish只发送一个请求到后端服务器，然后让其他几个请求挂起并等待返回结果；获得结果后，其它请求再复制后端的结果发送给客户端；</p>
<p>但如果同时有数以千计的请求，那么这个等待队列将变得庞大，这将导致2类潜在问题：</p>
<p>惊群问题(thundering herd problem)，即突然释放大量的线程去复制后端返回的结果，将导致负载急速上升；没有用户喜欢等待；</p>
<p>为了解决这类问题，可以配置varnish在缓存对象因超时失效后再保留一段时间，以给那些等待的请求返回过去的文件内容(stale content)，配置案例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sub vcl_recv &#123;</span><br><span class="line">if (! req.backend.healthy) &#123;</span><br><span class="line">set req.grace = 5m;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">set req.grace = 15s;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">sub vcl_fetch &#123;</span><br><span class="line">set beresp.grace = 30m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上配置表示varnish将会将失效的缓存对象再多保留30分钟，此值等于最大的req.grace值即可；</p>
<p>而根据后端主机的健康状况，varnish可向前端请求分别提供5分钟内或15秒内的过期内容</p>
<h5 id="后端服务器地址池配置及后端服务器健康检查"><a href="#后端服务器地址池配置及后端服务器健康检查" class="headerlink" title="后端服务器地址池配置及后端服务器健康检查"></a>后端服务器地址池配置及后端服务器健康检查</h5><h6 id="后端服务器定义"><a href="#后端服务器定义" class="headerlink" title="后端服务器定义"></a>后端服务器定义</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">命令：backend。这个定义为最基本的反向入口定义，用于varnish连接对应的服务器，如果没有定义或定义错误则用户无法访问正常页面。</span><br><span class="line">语法格式：</span><br><span class="line">backend name&#123;</span><br><span class="line">    .attribute = "value";</span><br><span class="line">&#125;</span><br><span class="line">说明：backend 是定义后端关键字，name 是当前后端节点的别名，多个后端节点时，name 名不能重复，否则覆盖。花括号里面定义当前节点相关的属性（键=值）。除默认节点外其它节点定义后必需有调用，否则varnish无法启动。后端是否正常可以通过std.healthy(backend)判断。</span><br><span class="line"></span><br><span class="line">支持运算符:</span><br><span class="line">=   （赋值运算）</span><br><span class="line">==  （相等比较）</span><br><span class="line">~    （匹配，可以使用正则表达式，或访问控制列表）</span><br><span class="line">!~    （不匹配，可以使用正则表达式，或访问控制列表）</span><br><span class="line">！  （非）</span><br><span class="line">&amp;&amp;   （逻辑与）</span><br><span class="line">||   （逻辑或）</span><br><span class="line"></span><br><span class="line">属性列表：</span><br><span class="line">.host="xxx.xxx.xxx.xxx";      //要转向主机（即后端主机）的IP或域名，必填键/值对。</span><br><span class="line">.port="8080";        //主机连接端口号或协议名（HTTP等），默认80</span><br><span class="line">.host_header='';    //请示主机头追加内容</span><br><span class="line">.connect_timeout=1s;     //连接后端的超时时间</span><br><span class="line">.first_byte_timeout=5s;    //等待从后端返回的第一个字节时间</span><br><span class="line">.between_bytes_timeout=2s;     //每接收一个字节之间等待时间</span><br><span class="line">.probe=probe_name;        //监控后端主机的状态,指定外部监控name或者内部直接添加</span><br><span class="line">.max_connections=200;    //设置最大并发连接数，超过这个数后连接就会失败</span><br><span class="line"></span><br><span class="line">例：（下面两个例子结果是一样的，但第二个例子中更适用于集群，可以方便批量修改）</span><br><span class="line">backend web&#123;</span><br><span class="line">    .host="192.168.197.180";</span><br><span class="line">    .port="80";</span><br><span class="line">    .probe=&#123;          //直接追加监控块.probe是一个的参数</span><br><span class="line">        .url="/";</span><br><span class="line">        .timeout=2s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">或</span><br><span class="line">probe web_probe&#123;   //监控必需定义在前面，否则后端调用找不到监控块。</span><br><span class="line">    .url="/";</span><br><span class="line">    .timeout=2s;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">backend web&#123;</span><br><span class="line">    .host="192.168.197.180";</span><br><span class="line">    .port="80";</span><br><span class="line">    .probe=web_probe;   //调用外部共用监控块</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="监视器定义"><a href="#监视器定义" class="headerlink" title="监视器定义"></a>监视器定义</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">命令：probe 。监控可以循环访问指定的地址，通过响应时间判定服务器是否空闲或正常。这类命令非常适用于集群中某些节点服务器崩溃或负载过重，而禁止访问这台节点服务器。</span><br><span class="line">语法格式：</span><br><span class="line">probe name&#123;</span><br><span class="line">    .attribute = "value";</span><br><span class="line">&#125;</span><br><span class="line">说明：probe 是定义监控关键字，name 是当前监控点的别名，多个监控节点时，name 名不能重复，否则覆盖。花括号里面定义当前节点相关的属性（键=值）。</span><br><span class="line">没有必填属性，因为默认值就可以正常执行操作。</span><br><span class="line"></span><br><span class="line">属性列表：</span><br><span class="line">.url="/";    //指定监控入口URL地址，默认为"/"</span><br><span class="line">.request="";   //指定监控请求入口地址，比 .url 优先级高。</span><br><span class="line">.expected_response="200";   //请求响应代码，默认是 200</span><br><span class="line">.timeout=2s;   //请求超时时间。</span><br><span class="line">.interval=5s;     //每次轮询请求间隔时间,默认为 5s 。</span><br><span class="line">.initial=-1;     //初始启动时以.window轮询次数中几次良好后续才能使用这个后端服务器节点，默认为 -1 ，则轮询完 .window 所有次数良好判定为正常。</span><br><span class="line">.window=8;   //指定多少轮询次数，用于判定服务器正常，默认是 8。</span><br><span class="line">.threshold=3;   //必须多少次轮询正常才算该后端节点服务器正常,默认是 3。</span><br><span class="line"></span><br><span class="line">例：创建健康监测，定义健康检查名称为backend_healthcheck</span><br><span class="line">probe backend_healthcheck &#123;</span><br><span class="line">        .url = "/";</span><br><span class="line">        .timeout = 1s;</span><br><span class="line">        .interval = 5s;</span><br><span class="line">        .window = 5;</span><br><span class="line">        .threshold = 3;</span><br><span class="line">    &#125;</span><br><span class="line">在上面的例子中varnish将每5s检测后端，超时设为1s。每个检测将会发送get /的请求。如果5个检测中大于3个是成功，varnish就认为后端是健康的，反之，后端就有问题了。</span><br></pre></td></tr></table></figure>
<h6 id="集群负载均衡directors"><a href="#集群负载均衡directors" class="headerlink" title="集群负载均衡directors"></a>集群负载均衡directors</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">varnish可以定义多个后端，也可以将几个后端放在一个后端集群里面已达到负载均衡的目的。</span><br><span class="line">你也可以将几个后端组成一组后端。这个组被叫做Directors。可以提高性能和弹性。</span><br><span class="line">directors是varnish负载均衡模块，使用前必需引入directors模块，directors模块主要包含：</span><br><span class="line">round_robin，random，hash，fallback负载均衡模式。</span><br><span class="line">round_robin : 循环依次逐个选择后端服务器。</span><br><span class="line">random ： 随机选择后端服务器，可设置每个后端权重增加随机率。</span><br><span class="line">hash :  通过散列随机选择对应的后端服务器且保持选择对应关系，下次则直接找对应的后端服务器。</span><br><span class="line">Fallback:后备</span><br><span class="line">注意：random，hash有权重值设置，用于提高随机率。每个后端最好都配置监控器（后端服务器正常监测）以便directors自动屏蔽不正常后端而不进入均衡列队中。</span><br><span class="line">这些操作需要你载入VMOD（varnish module），然后在vcl_init中调用这个VMOD。</span><br><span class="line"></span><br><span class="line">import directors;                # load the directors</span><br><span class="line">backend web1 &#123;</span><br><span class="line">.host = "192.168.197.175";</span><br><span class="line">.port = "80";</span><br><span class="line">.probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">backend web2 &#123;</span><br><span class="line">.host = "192.168.197.176";</span><br><span class="line">.port = "80";</span><br><span class="line">.probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">//初始化处理</span><br><span class="line">sub vcl_init &#123;            //调用vcl_init初始化子程序创建后端主机组，即directors</span><br><span class="line">    new  web_cluster = directors.round_robin(); //使用new关键字创建drector对象,使用round_robin算法</span><br><span class="line">    web_cluster.add_backend(web1);   //添加后端服务器节点</span><br><span class="line">web_cluster.add_backend(web2);</span><br><span class="line">&#125;</span><br><span class="line">//开始处理请求</span><br><span class="line">sub vcl_recv &#123;                     //调用vcl_recv子程序，用于接收和处理请求</span><br><span class="line">    set  req.backend_hint = web_cluster.backend();     //选取后端</span><br><span class="line">&#125;</span><br><span class="line">说明：</span><br><span class="line">set命令是设置变量</span><br><span class="line">unset命令是删除变量</span><br><span class="line">web_cluster.add_backend( backend , real);  添加后端服务器节点，backend 为后端配置别名，real 为权重值，随机率计算公式：100 * (当前权重 / 总权重)。</span><br><span class="line">req.backend_hint是varnish的预定义变量，作用是指定请求后端节点</span><br><span class="line">vcl对象需要使用new关键字创建，所有可创建对象都是内定的，使用前必需import，所有new操作只能在vcl_init子程序中。</span><br><span class="line"></span><br><span class="line">扩展：varnish将不同的url发送到不同的后端server</span><br><span class="line">import directors;                # load the directors</span><br><span class="line">backend web1 &#123;</span><br><span class="line">.host = "192.168.197.175";</span><br><span class="line">.port = "80";</span><br><span class="line">.probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">backend web2 &#123;</span><br><span class="line">.host = "192.168.197.176";</span><br><span class="line">.port = "80";</span><br><span class="line">.probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">backend img1 &#123;</span><br><span class="line">    .host = "img1.lnmmp.com";</span><br><span class="line">    .port = "80";</span><br><span class="line">    .probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">backend img2 &#123;</span><br><span class="line">    .host = "img2.lnmmp.com";</span><br><span class="line">    .port = "80";</span><br><span class="line">    .probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">//初始化处理</span><br><span class="line">sub vcl_init &#123;            //调用vcl_init初始化子程序创建后端主机组，即directors</span><br><span class="line">    new  web_cluster = directors.round_robin(); //使用new关键字创建drector对象,使用round_robin算法</span><br><span class="line">    web_cluster.add_backend(web1);   //添加后端服务器节点</span><br><span class="line">web_cluster.add_backend(web2);</span><br><span class="line">new img_cluster = directors.random();</span><br><span class="line">img_cluster.add_backend(img1,2);   //添加后端服务器节点，并且设置权重值</span><br><span class="line">img_cluster.add_backend(img2,5);</span><br><span class="line">&#125;</span><br><span class="line">//根据不同的访问域名，分发至不同的后端主机组</span><br><span class="line">sub vcl_recv &#123;</span><br><span class="line">if (req.http.host  ~  "(?i)^(www.)?benet.com$") &#123; </span><br><span class="line">        set  req.http.host = "www.benet.com";</span><br><span class="line">        set  req.backend_hint = web_cluster.backend();  //选取后端</span><br><span class="line">    &#125; elsif (req.http.host  ~  "(?i)^images.benet.com$") &#123;</span><br><span class="line">        set  req.backend_hint = img_cluster.backend();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">说明：中的i就是忽略大小写的意思。(?i)表示开启忽略大小写，而(?-i)表示关闭忽略大小写</span><br></pre></td></tr></table></figure>
<h6 id="访问控制列表（ACL）"><a href="#访问控制列表（ACL）" class="headerlink" title="访问控制列表（ACL）"></a>访问控制列表（ACL）</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">创建一个地址列表，用于后面的判断，可以是域名或IP集合。这个可以用于指定某些地址请求入口，防止恶意请求等。</span><br><span class="line">语法格式：</span><br><span class="line">acl  purgers  &#123;</span><br><span class="line">    "127.0.0.1";</span><br><span class="line">"localhost";</span><br><span class="line">“192.168.134.0/24”</span><br><span class="line">    !"192.168.134.1";</span><br><span class="line">&#125;</span><br><span class="line">说明：acl 是访问列表关键字（必需小写），name 是该列表的别名用于调用，花括号内部是地址集。</span><br><span class="line">注意：如果列表中包含了无法解析的主机地址，它会匹配任何地址。</span><br><span class="line">如果不想让它匹配可以在前添加一个 ! 符号，如上面 !"192.168.134.1"; </span><br><span class="line">使用ACL只需要用匹配运算符 ~ 或 !~  如：</span><br><span class="line">sub  vcl_recv &#123;</span><br><span class="line">    if  (req.method == "PURGE") &#123;    //PURGE请求的处理</span><br><span class="line">         if  (client.ip  ~  purgers) &#123;     </span><br><span class="line">              return(purge);</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">            return(synth(403, "Access denied."));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="缓存规则配置"><a href="#缓存规则配置" class="headerlink" title="缓存规则配置"></a>缓存规则配置</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">sub vcl_recv &#123;</span><br><span class="line">  // PURGE请求的处理</span><br><span class="line">  if (req.method == "PURGE") &#123;</span><br><span class="line">    if (!client.ip ~ purgers) &#123;</span><br><span class="line">      return (synth(405, "Not Allowed."));</span><br><span class="line">    &#125;</span><br><span class="line">    return (purge);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  set req.backend_hint = web.backend();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  //将php、asp等动态内容访问请求直接发给后端服务器，不缓存。</span><br><span class="line">  if (req.url ~ "\.(php|asp|aspx|jsp|do|ashx|shtml)($|\?)") &#123;</span><br><span class="line">    return (pass);</span><br><span class="line">  &#125;</span><br><span class="line">  //将非GET和HEAD访问请求直接发给后端服务器，不缓存。例如POST请求。</span><br><span class="line">  if (req.method != "GET" &amp;&amp; req.method != "HEAD") &#123;</span><br><span class="line">        return (pass);</span><br><span class="line">  &#125;</span><br><span class="line">  //如果varnish看到header中有'Authorization'头，它将pass请求。</span><br><span class="line">  if (req.http.Authorization) &#123;</span><br><span class="line">        return (pass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  //带cookie首部的GET请求也缓存</span><br><span class="line">  if (req.url ~ "\.(css|js|html|htm|bmp|png|gif|jpg|jpeg|ico|gz|tgz|bz2|tbz|zip|rar|mp3|mp4|ogg|swf|flv)($|\?)") &#123;</span><br><span class="line">    unset req.http.cookie;</span><br><span class="line">    return (hash);</span><br><span class="line">  &#125;</span><br><span class="line">说明：默认情况，varnish不缓存从后端响应的http头中带有Set-Cookie的对象。如果客户端发送的请求带有Cookie header，varnish将忽略缓存，直接将请求传递到后端。</span><br><span class="line">为发往后端主机的请求添加X-Forward-For首部,首次访问增加X-Forwarded-For 头信息,方便后端程序获取客户端ip，而不是varnish地址</span><br><span class="line"></span><br><span class="line">if (req.restarts == 0) &#123;</span><br><span class="line">        if (req.http.x-forwarded-for) &#123;//如果设置过此header则要再次附加上用逗号隔开</span><br><span class="line">            set req.http.X-Forwarded-For = req.http.X-Forwarded-For + ", " + client.ip;</span><br><span class="line">        &#125; else &#123;//如果只有一层代理的话,就无需设置了</span><br><span class="line">            set req.http.X-Forwarded-For = client.ip;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">说明：X-Forwarded-For是用来识别通过HTTP代理或负载均衡方式连接到Web服务器的客户端最原始的IP地址的HTTP请求头字段</span><br><span class="line">子程序：</span><br><span class="line">子程序是一种类似C的函数，但是程序没有调用参数，子程序以 sub 关键字定义。在VCL里子程序是用于管理程序。</span><br><span class="line">注意：所有VCL内置的程序都是以 vcl_ 开头，并已经预置好，在VCL文件中只要声明对应的内置子程序，都会在对应的流程中调用。</span><br></pre></td></tr></table></figure>
<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line">vcl 4.0;		# 使用varnish版本4的格式.</span><br><span class="line">import std;		# 标准日志需要加载此模块</span><br><span class="line">import directors;		# 加载后端轮询模块，为了可以使用下面的vcl_init</span><br><span class="line"><span class="meta">#</span><span class="bash"> import表示加载varnish模块(VMODs)</span></span><br><span class="line">backend server1 &#123; # Define one backend。定义后端主机，server1是自定义的后端主机名称</span><br><span class="line">  .host = "10.129.14.4";    # Gateway on dl-gw-01</span><br><span class="line">  .port = "8090";           # Port Apache or whatever is listening</span><br><span class="line">  .max_connections = 30000; # That's it</span><br><span class="line"></span><br><span class="line">  .probe = &#123;</span><br><span class="line">    #.url = "/"; # short easy way (GET /)</span><br><span class="line">    # We prefer to only do a HEAD /</span><br><span class="line">    .request =</span><br><span class="line">      "HEAD / HTTP/1.1"</span><br><span class="line">      "Host: localhost"</span><br><span class="line">      "Connection: close"</span><br><span class="line">      "User-Agent: Varnish Health Probe";</span><br><span class="line"></span><br><span class="line">    .interval  = 5s; # check the health of each backend every 5 seconds</span><br><span class="line">    .timeout   = 1s; # timing out after 1 second.</span><br><span class="line">    .window    = 5;  # If 3 out of the last 5 polls succeeded the backend is considered healthy, otherwise it will be marked as sick</span><br><span class="line">    .threshold = 3;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .first_byte_timeout     = 300s;   # How long to wait before we receive a first byte from our backend?</span><br><span class="line">  .connect_timeout        = 5s;     # How long to wait for a backend connection?</span><br><span class="line">  .between_bytes_timeout  = 2s;     # How long to wait between bytes received from our backend?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">backend server2 &#123; # Define one backend</span><br><span class="line">  .host = "10.129.14.5";    #  Gateway on dl-gw-01</span><br><span class="line">  .port = "8090";           # Port Apache or whatever is listening</span><br><span class="line">  .max_connections = 30000; # That's it</span><br><span class="line"></span><br><span class="line">  .probe = &#123;</span><br><span class="line">    #.url = "/"; # short easy way (GET /)</span><br><span class="line">    # We prefer to only do a HEAD /</span><br><span class="line">    .request =</span><br><span class="line">      "HEAD / HTTP/1.1"</span><br><span class="line">      "Host: localhost"</span><br><span class="line">      "Connection: close"</span><br><span class="line">      "User-Agent: Varnish Health Probe";</span><br><span class="line"></span><br><span class="line">    .interval  = 5s; # check the health of each backend every 5 seconds</span><br><span class="line">    .timeout   = 1s; # timing out after 1 second.</span><br><span class="line">    .window    = 5;  # If 3 out of the last 5 polls succeeded the backend is considered healthy, otherwise it will be marked as sick</span><br><span class="line">    .threshold = 3;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .first_byte_timeout     = 300s;   # How long to wait before we receive a first byte from our backend?</span><br><span class="line">  .connect_timeout        = 5s;     # How long to wait for a backend connection?</span><br><span class="line">  .between_bytes_timeout  = 2s;     # How long to wait between bytes received from our backend?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">acl purge &#123;		# 定义允许清理缓存的IP</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ACL we<span class="string">'ll use later to allow purges</span></span></span><br><span class="line">  "localhost";</span><br><span class="line">  "127.0.0.1";</span><br><span class="line">  "::1";</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_init &#123;		# 配置后端集群事件</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called when VCL is loaded, before any requests pass through it.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Typically used to initialize VMODs.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 后端集群有4种模式 random, round-robin, fallback, <span class="built_in">hash</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> random         随机</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> round-robin    轮询</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> fallback        后备</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="built_in">hash</span>        固定后端 根据url(req.http.url) 或用户cookie(req.http.cookie) 或用户session(req.http.sticky)(这个还有其他要配合)</span></span><br><span class="line">  new vdir = directors.round_robin();</span><br><span class="line">  vdir.add_backend(server1);</span><br><span class="line">  vdir.add_backend(server2);</span><br><span class="line"><span class="meta">  #</span><span class="bash"> vdir.add_backend(server...);</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> vdir.add_backend(servern);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_recv &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called at the beginning of a request, after the complete request has been received and parsed.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Its purpose is to decide whether or not to serve the request, how to <span class="keyword">do</span> it, and, <span class="keyword">if</span> applicable,</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="built_in">which</span> backend to use.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> also used to modify the request</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 请求入口，这里一般用作路由处理，判断是否读取缓存和指定该请求使用哪个后端</span></span><br><span class="line">  set req.backend_hint = vdir.backend(); # send all traffic to the vdir director</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Normalize the header, remove the port (<span class="keyword">in</span> <span class="keyword">case</span> you<span class="string">'re testing this on various TCP ports)</span></span></span><br><span class="line">  set req.http.Host = regsub(req.http.Host, ":[0-9]+", "");</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Remove the proxy header (see https://httpoxy.org/<span class="comment">#mitigate-varnish)</span></span></span><br><span class="line">  unset req.http.proxy;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Normalize the query arguments</span></span><br><span class="line">  set req.url = std.querysort(req.url);</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Allow purging</span></span><br><span class="line">  if (req.method == "PURGE") &#123;</span><br><span class="line">    if (!client.ip ~ purge) &#123; # purge is the ACL defined at the begining</span><br><span class="line">      # Not from an allowed IP? Then die with an error.</span><br><span class="line">      return (synth(405, "This IP is not allowed to send PURGE requests."));</span><br><span class="line">    &#125;</span><br><span class="line">    # If you got this stage (and didn't error out above), purge the cached result</span><br><span class="line">    return (purge);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果不是指定IP执行PURGE方法会报错，否则就执行</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Only deal with <span class="string">"normal"</span> types</span></span><br><span class="line">  if (req.method != "GET" &amp;&amp;</span><br><span class="line">      req.method != "HEAD" &amp;&amp;</span><br><span class="line">      req.method != "PUT" &amp;&amp;</span><br><span class="line">      req.method != "POST" &amp;&amp;</span><br><span class="line">      req.method != "TRACE" &amp;&amp;</span><br><span class="line">      req.method != "OPTIONS" &amp;&amp;</span><br><span class="line">      req.method != "PATCH" &amp;&amp;</span><br><span class="line">      req.method != "DELETE") &#123;</span><br><span class="line">    /* Non-RFC2616 or CONNECT which is weird. */</span><br><span class="line">    /*Why send the packet upstream, while the visitor is using a non-valid HTTP method? */</span><br><span class="line">    return (synth(404, "Non-valid HTTP method!"));</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果使用上面指定的方法就报错。</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Only cache GET or HEAD requests. This makes sure the POST requests are always passed.</span></span><br><span class="line">  if (req.method != "GET" &amp;&amp; req.method != "HEAD") &#123;</span><br><span class="line">   return (pass);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (req.url ~ "/aquapaas/rest/usertags/") </span><br><span class="line">		&#123; return (hash); &#125;  </span><br><span class="line"><span class="meta">  #</span><span class="bash"> 如果请求的地址中包含/aquapaas/rest/usertags/，就缓存。</span></span><br><span class="line">  return (pass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The data on <span class="built_in">which</span> the hashing will take place</span></span><br><span class="line">sub vcl_hash &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called after vcl_recv to create a <span class="built_in">hash</span> value <span class="keyword">for</span> the request. This is used as a key</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> to look up the object <span class="keyword">in</span> Varnish.</span></span><br><span class="line"></span><br><span class="line">  hash_data(req.url);</span><br><span class="line"> </span><br><span class="line">  return (lookup);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Handle the HTTP request coming from our backend</span></span><br><span class="line">sub vcl_backend_response &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called after the response headers has been successfully retrieved from the backend.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Sometimes, a 301 or 302 redirect formed via Apache<span class="string">'s mod_rewrite can mess with the HTTP port that is being passed along.</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> This often happens with simple rewrite rules <span class="keyword">in</span> a scenario <span class="built_in">where</span> Varnish runs on :80 and Apache on :8080 on the same box.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> A redirect can <span class="keyword">then</span> often redirect the end-user to a URL on :8080, <span class="built_in">where</span> it should be :80.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> This may need finetuning on your setup.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> To prevent accidental replace, we only filter the 301/302 redirects <span class="keyword">for</span> now.</span></span><br><span class="line">  if (beresp.status == 301 || beresp.status == 302) &#123;</span><br><span class="line">    set beresp.http.Location = regsub(beresp.http.Location, ":[0-9]+", "");</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Don<span class="string">'t cache 50x responses</span></span></span><br><span class="line">  if (beresp.status == 500 || beresp.status == 502 || beresp.status == 503 || beresp.status == 504) &#123;</span><br><span class="line">    return (abandon);        # abandon  放弃处理，并生成一个错误。</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Set 2min cache <span class="keyword">if</span> <span class="built_in">unset</span> <span class="keyword">for</span> static files</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="keyword">if</span> (beresp.ttl &lt;= 0s || beresp.http.Set-Cookie || beresp.http.Vary == <span class="string">"*"</span>) &#123;</span></span><br><span class="line">    # set beresp.ttl = 120s; # Important, you shouldn't rely on this, SET YOUR HEADERS in the backend</span><br><span class="line">    # set beresp.uncacheable = true;</span><br><span class="line">    # return (deliver);</span><br><span class="line"><span class="meta">  #</span><span class="bash"> &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Allow stale content, <span class="keyword">in</span> <span class="keyword">case</span> the backend goes down.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> make Varnish keep all objects <span class="keyword">for</span> 24000 hours beyond their TTL</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="built_in">set</span> beresp.ttl = 5m;</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="built_in">set</span> beresp.grace = 24000h;</span></span><br><span class="line">  </span><br><span class="line">  if ( beresp.status == 200 ) &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash">只有返回状态为200 OK的数据才考虑缓存。</span></span><br><span class="line">	if (bereq.url ~ "/aquapaas/rest/usertags/") &#123; </span><br><span class="line"><span class="meta">		#</span><span class="bash">AAA数据缓存30秒，过期后缓存0秒。</span></span><br><span class="line">		set beresp.ttl = 30s;</span><br><span class="line">		set beresp.grace = 0s;</span><br><span class="line">		&#125; </span><br><span class="line"> &#125; else &#123;</span><br><span class="line"><span class="meta"> #</span><span class="bash">其余数据不缓存。</span></span><br><span class="line"> set beresp.ttl = 0s;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> return (deliver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The routine when we deliver the HTTP request to the user</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Last chance to modify headers that are sent to the client</span></span><br><span class="line">sub vcl_deliver &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called before a cached object is delivered to the client.</span></span><br><span class="line"></span><br><span class="line">  if (obj.hits &gt; 0) &#123; # Add debug header to see if it's a HIT/MISS and the number of hits, disable when not needed</span><br><span class="line">    set resp.http.X-Cache = "HIT";</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    set resp.http.X-Cache = "MISS";</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Please note that obj.hits behaviour changed <span class="keyword">in</span> 4.0, now it counts per objecthead, not per object</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> and obj.hits may not be reset <span class="keyword">in</span> some cases <span class="built_in">where</span> bans are <span class="keyword">in</span> use. See bug 1492 <span class="keyword">for</span> details.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> So take hits with a grain of salt</span></span><br><span class="line">  set resp.http.X-Cache-Hits = obj.hits;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Remove some headers: PHP version</span></span><br><span class="line">  unset resp.http.X-Powered-By;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Remove some headers: Apache version &amp; OS</span></span><br><span class="line">  unset resp.http.Server;</span><br><span class="line">  unset resp.http.X-Drupal-Cache;</span><br><span class="line">  unset resp.http.X-Varnish;</span><br><span class="line">  unset resp.http.Via;</span><br><span class="line">  unset resp.http.Link;</span><br><span class="line">  unset resp.http.X-Generator;</span><br><span class="line"></span><br><span class="line">  return (deliver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_purge &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Only handle actual PURGE HTTP methods, everything <span class="keyword">else</span> is discarded</span></span><br><span class="line">  if (req.method == "PURGE") &#123;</span><br><span class="line">    # restart request</span><br><span class="line">    set req.http.X-Purge = "Yes";</span><br><span class="line">    return (restart);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_synth &#123;</span><br><span class="line">  if (resp.status == 720) &#123;</span><br><span class="line">    # We use this special error status 720 to force redirects with 301 (permanent) redirects</span><br><span class="line">    # To use this, call the following from anywhere in vcl_recv: return (synth(720, "http://host/new.html"));</span><br><span class="line">    set resp.http.Location = resp.reason;</span><br><span class="line">    set resp.status = 301;</span><br><span class="line">    return (deliver);</span><br><span class="line">  &#125; elseif (resp.status == 721) &#123;</span><br><span class="line">    # And we use error status 721 to force redirects with a 302 (temporary) redirect</span><br><span class="line">    # To use this, call the following from anywhere in vcl_recv: return (synth(720, "http://host/new.html"));</span><br><span class="line">    set resp.http.Location = resp.reason;</span><br><span class="line">    set resp.status = 302;</span><br><span class="line">    return (deliver);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return (deliver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_hit &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called when a cache lookup is successful.</span></span><br><span class="line"></span><br><span class="line">  if (obj.ttl &gt;= 0s) &#123;</span><br><span class="line">    # A pure unadultered hit, deliver it</span><br><span class="line">    return (deliver);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> https://www.varnish-cache.org/docs/trunk/users-guide/vcl-grace.html</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> When several clients are requesting the same page Varnish will send one request to the backend and place the others on hold <span class="keyword">while</span> fetching one copy from the backend. In some products this is called request coalescing and Varnish does this automatically.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> If you are serving thousands of hits per second the queue of waiting requests can get huge. There are two potential problems - one is a thundering herd problem - suddenly releasing a thousand threads to serve content might send the load sky high. Secondly - nobody likes to <span class="built_in">wait</span>. To deal with this we can instruct Varnish to keep the objects <span class="keyword">in</span> cache beyond their TTL and to serve the waiting requests somewhat stale content.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> (!std.healthy(req.backend_hint) &amp;&amp; (obj.ttl + obj.grace &gt; 0s)) &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   <span class="built_in">return</span> (deliver);</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   <span class="built_in">return</span> (miss);</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> We have no fresh fish. Lets look at the stale ones.</span></span><br><span class="line">  if (std.healthy(req.backend_hint)) &#123;</span><br><span class="line">    # Backend is healthy. Limit age to 10s.</span><br><span class="line">    if (obj.ttl + 10s &gt; 0s) &#123;</span><br><span class="line">      #set req.http.grace = "normal(limited)";</span><br><span class="line">      return (deliver);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      # No candidate for grace. Fetch a fresh object.</span><br><span class="line">      return (fetch);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    # backend is sick - use full grace</span><br><span class="line">      if (obj.ttl + obj.grace &gt; 0s) &#123;</span><br><span class="line">      #set req.http.grace = "full";</span><br><span class="line">      return (deliver);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      # no graced object.</span><br><span class="line">      return (fetch);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> fetch &amp; deliver once we get the result</span></span><br><span class="line">  return (fetch); # Dead code, keep as a safeguard</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_miss &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called after a cache lookup <span class="keyword">if</span> the requested document was not found <span class="keyword">in</span> the cache. Its purpose</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> is to decide whether or not to attempt to retrieve the document from the backend, and <span class="built_in">which</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> backend to use.</span></span><br><span class="line"></span><br><span class="line">  return (fetch);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_fini &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called when VCL is discarded only after all requests have exited the VCL.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Typically used to clean up VMODs.</span></span><br><span class="line"></span><br><span class="line">  return (ok);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/20/python基础练习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/20/python基础练习/" itemprop="url">
                  python基础练习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-20 09:15:56" itemprop="dateCreated datePublished" datetime="2019-06-20T09:15:56+08:00">2019-06-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-11-27 17:54:17" itemprop="dateModified" datetime="2019-11-27T17:54:17+08:00">2019-11-27</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="打印一个边长为n的正方形"><a href="#打印一个边长为n的正方形" class="headerlink" title="打印一个边长为n的正方形"></a>打印一个边长为n的正方形</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">5</span>    <span class="comment"># 设置打印边长的星号数</span></span><br><span class="line">print(<span class="string">'*'</span>*n)    <span class="comment"># 打印第一行</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> (<span class="string">'*'</span>*(n<span class="number">-2</span>)):     <span class="comment"># 设置循环为减去上下两条边的数量</span></span><br><span class="line">    print(<span class="string">'*'</span>+<span class="string">' '</span>*(n<span class="number">-2</span>)+<span class="string">'*'</span>)    </span><br><span class="line">    <span class="comment"># 先打印前面一个星号，再打印减去了前后两个星号的空格，最后打印最后一个星号</span></span><br><span class="line">print(<span class="string">'*'</span>*n)    <span class="comment"># 打印最下面一行的*</span></span><br><span class="line"></span><br><span class="line">n = <span class="number">6</span></span><br><span class="line">e = -n//<span class="number">2</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(e,n+e):</span><br><span class="line">    <span class="keyword">if</span> i == e <span class="keyword">or</span> i == n+e<span class="number">-1</span>:</span><br><span class="line">        print(<span class="string">'*'</span>*n)    <span class="comment"># 上面判断的是要打印上下两条边</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'*'</span> + <span class="string">' '</span>*(n<span class="number">-2</span>) + <span class="string">'*'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 上面的代码等价于下面的代码</span></span><br><span class="line">n = <span class="number">5</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span> <span class="keyword">or</span> i == n<span class="number">-1</span>:</span><br><span class="line">        print(<span class="string">'*'</span>*n)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'*'</span>+<span class="string">' '</span>*(n<span class="number">-2</span>)+<span class="string">'*'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="求100以内所有奇数的和"><a href="#求100以内所有奇数的和" class="headerlink" title="求100以内所有奇数的和"></a>求100以内所有奇数的和</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sum = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>,<span class="number">2</span>):</span><br><span class="line">    sum += i</span><br><span class="line">print(sum)</span><br></pre></td></tr></table></figure>
<h3 id="求1到5的阶乘之和"><a href="#求1到5的阶乘之和" class="headerlink" title="求1到5的阶乘之和"></a>求1到5的阶乘之和</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法1</span></span><br><span class="line">n = <span class="number">5</span>    <span class="comment"># 控制阶乘的边界</span></span><br><span class="line">sum = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,n+<span class="number">1</span>):</span><br><span class="line">    tmp = <span class="number">1</span>    <span class="comment"># 第一次1的阶乘还是1</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,i+<span class="number">1</span>):</span><br><span class="line">        tmp *= j    <span class="comment"># 第一次1的阶乘是1×1</span></span><br><span class="line">    sum += tmp    <span class="comment"># 第一次sum=0+1</span></span><br><span class="line">print(sum)</span><br><span class="line"><span class="comment"># 1+1*2+1*2*3+1*2*3*4+1*2*3*4*5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法2</span></span><br><span class="line">nums = <span class="number">1</span></span><br><span class="line">sum = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">6</span>):</span><br><span class="line">    nums *= n</span><br><span class="line"><span class="comment"># 这里是乘等，第一次是1×1,第二次是1×1×2,第三次是1×1×2×3，这样就实现了阶乘，再使用下面的方法将每次循环的结果加在一起就形成了阶乘之和。</span></span><br><span class="line">    sum += nums</span><br><span class="line">print(sum)</span><br></pre></td></tr></table></figure>
<h3 id="给一个半径，求圆的面积和周长。圆周率3-14"><a href="#给一个半径，求圆的面积和周长。圆周率3-14" class="headerlink" title="给一个半径，求圆的面积和周长。圆周率3.14"></a>给一个半径，求圆的面积和周长。圆周率3.14</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r=int(input(<span class="string">'r='</span>))</span><br><span class="line">print(<span class="string">'area='</span>+str(<span class="number">3.14</span>*r*r))</span><br><span class="line">print(<span class="string">'circumference='</span>+str(<span class="number">2</span>*<span class="number">3.14</span>*r))</span><br></pre></td></tr></table></figure>
<h3 id="输入两个数，比较大小后，从小到大升序打印"><a href="#输入两个数，比较大小后，从小到大升序打印" class="headerlink" title="输入两个数，比较大小后，从小到大升序打印"></a>输入两个数，比较大小后，从小到大升序打印</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a = input(<span class="string">'first: '</span>)</span><br><span class="line">b = input(<span class="string">'second: '</span>)</span><br><span class="line"><span class="keyword">if</span> a &gt; b:</span><br><span class="line">    print(b, a)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(a, b)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 三元表达式</span></span><br><span class="line">print(b,a) <span class="keyword">if</span> a&gt;b <span class="keyword">else</span> print(a,b)</span><br></pre></td></tr></table></figure>
<h3 id="获取最大值"><a href="#获取最大值" class="headerlink" title="获取最大值"></a>获取最大值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 请输入若干个整数，打印出最大值</span></span><br><span class="line">m = int(input(<span class="string">'Input first number &gt;&gt;&gt;'</span>))</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    c = input(<span class="string">'Input a number &gt;&gt;&gt;'</span>)</span><br><span class="line">    <span class="keyword">if</span> c:</span><br><span class="line">        n = int(c)</span><br><span class="line">        <span class="keyword">if</span> n &gt; m:</span><br><span class="line">            m = n</span><br><span class="line">        print(<span class="string">'Max is'</span>, m)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># m是保存最大值的，c保存每次输入的数字并传给n，用n和m比较。这实际还是在做两个数的比较</span></span><br></pre></td></tr></table></figure>
<h3 id="输入n个数，求每次输入后的算数平均数"><a href="#输入n个数，求每次输入后的算数平均数" class="headerlink" title="输入n个数，求每次输入后的算数平均数"></a>输入n个数，求每次输入后的算数平均数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">0</span>    <span class="comment"># 次数</span></span><br><span class="line">sum = <span class="number">0</span>    <span class="comment"># 和</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    i = input(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="string">'quit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    n += <span class="number">1</span></span><br><span class="line">    sum += int(i)</span><br><span class="line">    avg = sum/n</span><br><span class="line">    print(avg)</span><br></pre></td></tr></table></figure>
<h3 id="打印九九乘法表"><a href="#打印九九乘法表" class="headerlink" title="打印九九乘法表"></a>打印九九乘法表</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">     <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">         print(<span class="string">"%d*%d=%2d"</span> % (i,j,i*j),end=<span class="string">" "</span>)</span><br><span class="line">     print(<span class="string">""</span>)</span><br><span class="line"><span class="number">1</span>*<span class="number">1</span>= <span class="number">1</span> <span class="number">1</span>*<span class="number">2</span>= <span class="number">2</span> <span class="number">1</span>*<span class="number">3</span>= <span class="number">3</span> <span class="number">1</span>*<span class="number">4</span>= <span class="number">4</span> <span class="number">1</span>*<span class="number">5</span>= <span class="number">5</span> <span class="number">1</span>*<span class="number">6</span>= <span class="number">6</span> <span class="number">1</span>*<span class="number">7</span>= <span class="number">7</span> <span class="number">1</span>*<span class="number">8</span>= <span class="number">8</span> <span class="number">1</span>*<span class="number">9</span>= <span class="number">9</span> </span><br><span class="line"><span class="number">2</span>*<span class="number">1</span>= <span class="number">2</span> <span class="number">2</span>*<span class="number">2</span>= <span class="number">4</span> <span class="number">2</span>*<span class="number">3</span>= <span class="number">6</span> <span class="number">2</span>*<span class="number">4</span>= <span class="number">8</span> <span class="number">2</span>*<span class="number">5</span>=<span class="number">10</span> <span class="number">2</span>*<span class="number">6</span>=<span class="number">12</span> <span class="number">2</span>*<span class="number">7</span>=<span class="number">14</span> <span class="number">2</span>*<span class="number">8</span>=<span class="number">16</span> <span class="number">2</span>*<span class="number">9</span>=<span class="number">18</span> </span><br><span class="line"><span class="number">3</span>*<span class="number">1</span>= <span class="number">3</span> <span class="number">3</span>*<span class="number">2</span>= <span class="number">6</span> <span class="number">3</span>*<span class="number">3</span>= <span class="number">9</span> <span class="number">3</span>*<span class="number">4</span>=<span class="number">12</span> <span class="number">3</span>*<span class="number">5</span>=<span class="number">15</span> <span class="number">3</span>*<span class="number">6</span>=<span class="number">18</span> <span class="number">3</span>*<span class="number">7</span>=<span class="number">21</span> <span class="number">3</span>*<span class="number">8</span>=<span class="number">24</span> <span class="number">3</span>*<span class="number">9</span>=<span class="number">27</span> </span><br><span class="line"><span class="number">4</span>*<span class="number">1</span>= <span class="number">4</span> <span class="number">4</span>*<span class="number">2</span>= <span class="number">8</span> <span class="number">4</span>*<span class="number">3</span>=<span class="number">12</span> <span class="number">4</span>*<span class="number">4</span>=<span class="number">16</span> <span class="number">4</span>*<span class="number">5</span>=<span class="number">20</span> <span class="number">4</span>*<span class="number">6</span>=<span class="number">24</span> <span class="number">4</span>*<span class="number">7</span>=<span class="number">28</span> <span class="number">4</span>*<span class="number">8</span>=<span class="number">32</span> <span class="number">4</span>*<span class="number">9</span>=<span class="number">36</span> </span><br><span class="line"><span class="number">5</span>*<span class="number">1</span>= <span class="number">5</span> <span class="number">5</span>*<span class="number">2</span>=<span class="number">10</span> <span class="number">5</span>*<span class="number">3</span>=<span class="number">15</span> <span class="number">5</span>*<span class="number">4</span>=<span class="number">20</span> <span class="number">5</span>*<span class="number">5</span>=<span class="number">25</span> <span class="number">5</span>*<span class="number">6</span>=<span class="number">30</span> <span class="number">5</span>*<span class="number">7</span>=<span class="number">35</span> <span class="number">5</span>*<span class="number">8</span>=<span class="number">40</span> <span class="number">5</span>*<span class="number">9</span>=<span class="number">45</span> </span><br><span class="line"><span class="number">6</span>*<span class="number">1</span>= <span class="number">6</span> <span class="number">6</span>*<span class="number">2</span>=<span class="number">12</span> <span class="number">6</span>*<span class="number">3</span>=<span class="number">18</span> <span class="number">6</span>*<span class="number">4</span>=<span class="number">24</span> <span class="number">6</span>*<span class="number">5</span>=<span class="number">30</span> <span class="number">6</span>*<span class="number">6</span>=<span class="number">36</span> <span class="number">6</span>*<span class="number">7</span>=<span class="number">42</span> <span class="number">6</span>*<span class="number">8</span>=<span class="number">48</span> <span class="number">6</span>*<span class="number">9</span>=<span class="number">54</span> </span><br><span class="line"><span class="number">7</span>*<span class="number">1</span>= <span class="number">7</span> <span class="number">7</span>*<span class="number">2</span>=<span class="number">14</span> <span class="number">7</span>*<span class="number">3</span>=<span class="number">21</span> <span class="number">7</span>*<span class="number">4</span>=<span class="number">28</span> <span class="number">7</span>*<span class="number">5</span>=<span class="number">35</span> <span class="number">7</span>*<span class="number">6</span>=<span class="number">42</span> <span class="number">7</span>*<span class="number">7</span>=<span class="number">49</span> <span class="number">7</span>*<span class="number">8</span>=<span class="number">56</span> <span class="number">7</span>*<span class="number">9</span>=<span class="number">63</span> </span><br><span class="line"><span class="number">8</span>*<span class="number">1</span>= <span class="number">8</span> <span class="number">8</span>*<span class="number">2</span>=<span class="number">16</span> <span class="number">8</span>*<span class="number">3</span>=<span class="number">24</span> <span class="number">8</span>*<span class="number">4</span>=<span class="number">32</span> <span class="number">8</span>*<span class="number">5</span>=<span class="number">40</span> <span class="number">8</span>*<span class="number">6</span>=<span class="number">48</span> <span class="number">8</span>*<span class="number">7</span>=<span class="number">56</span> <span class="number">8</span>*<span class="number">8</span>=<span class="number">64</span> <span class="number">8</span>*<span class="number">9</span>=<span class="number">72</span> </span><br><span class="line"><span class="number">9</span>*<span class="number">1</span>= <span class="number">9</span> <span class="number">9</span>*<span class="number">2</span>=<span class="number">18</span> <span class="number">9</span>*<span class="number">3</span>=<span class="number">27</span> <span class="number">9</span>*<span class="number">4</span>=<span class="number">36</span> <span class="number">9</span>*<span class="number">5</span>=<span class="number">45</span> <span class="number">9</span>*<span class="number">6</span>=<span class="number">54</span> <span class="number">9</span>*<span class="number">7</span>=<span class="number">63</span> <span class="number">9</span>*<span class="number">8</span>=<span class="number">72</span> <span class="number">9</span>*<span class="number">9</span>=<span class="number">81</span> </span><br><span class="line"><span class="comment"># 这种方法没有考虑到边界的问题</span></span><br><span class="line"></span><br><span class="line">方法一：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> j &lt;= i:</span><br><span class="line">            print(j,<span class="string">"*"</span>,i,<span class="string">"="</span>,i*j,end=<span class="string">" "</span>)</span><br><span class="line">    print(<span class="string">" "</span>)   </span><br><span class="line">    <span class="comment"># 循环完一小轮之后要打印一个空行</span></span><br><span class="line"><span class="number">1</span> * <span class="number">1</span> = <span class="number">1</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">2</span> = <span class="number">2</span> <span class="number">2</span> * <span class="number">2</span> = <span class="number">4</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">3</span> = <span class="number">3</span> <span class="number">2</span> * <span class="number">3</span> = <span class="number">6</span> <span class="number">3</span> * <span class="number">3</span> = <span class="number">9</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">4</span> = <span class="number">4</span> <span class="number">2</span> * <span class="number">4</span> = <span class="number">8</span> <span class="number">3</span> * <span class="number">4</span> = <span class="number">12</span> <span class="number">4</span> * <span class="number">4</span> = <span class="number">16</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">5</span> = <span class="number">5</span> <span class="number">2</span> * <span class="number">5</span> = <span class="number">10</span> <span class="number">3</span> * <span class="number">5</span> = <span class="number">15</span> <span class="number">4</span> * <span class="number">5</span> = <span class="number">20</span> <span class="number">5</span> * <span class="number">5</span> = <span class="number">25</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">6</span> = <span class="number">6</span> <span class="number">2</span> * <span class="number">6</span> = <span class="number">12</span> <span class="number">3</span> * <span class="number">6</span> = <span class="number">18</span> <span class="number">4</span> * <span class="number">6</span> = <span class="number">24</span> <span class="number">5</span> * <span class="number">6</span> = <span class="number">30</span> <span class="number">6</span> * <span class="number">6</span> = <span class="number">36</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">7</span> = <span class="number">7</span> <span class="number">2</span> * <span class="number">7</span> = <span class="number">14</span> <span class="number">3</span> * <span class="number">7</span> = <span class="number">21</span> <span class="number">4</span> * <span class="number">7</span> = <span class="number">28</span> <span class="number">5</span> * <span class="number">7</span> = <span class="number">35</span> <span class="number">6</span> * <span class="number">7</span> = <span class="number">42</span> <span class="number">7</span> * <span class="number">7</span> = <span class="number">49</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">8</span> = <span class="number">8</span> <span class="number">2</span> * <span class="number">8</span> = <span class="number">16</span> <span class="number">3</span> * <span class="number">8</span> = <span class="number">24</span> <span class="number">4</span> * <span class="number">8</span> = <span class="number">32</span> <span class="number">5</span> * <span class="number">8</span> = <span class="number">40</span> <span class="number">6</span> * <span class="number">8</span> = <span class="number">48</span> <span class="number">7</span> * <span class="number">8</span> = <span class="number">56</span> <span class="number">8</span> * <span class="number">8</span> = <span class="number">64</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">9</span> = <span class="number">9</span> <span class="number">2</span> * <span class="number">9</span> = <span class="number">18</span> <span class="number">3</span> * <span class="number">9</span> = <span class="number">27</span> <span class="number">4</span> * <span class="number">9</span> = <span class="number">36</span> <span class="number">5</span> * <span class="number">9</span> = <span class="number">45</span> <span class="number">6</span> * <span class="number">9</span> = <span class="number">54</span> <span class="number">7</span> * <span class="number">9</span> = <span class="number">63</span> <span class="number">8</span> * <span class="number">9</span> = <span class="number">72</span> <span class="number">9</span> * <span class="number">9</span> = <span class="number">81</span></span><br><span class="line"></span><br><span class="line">方法二：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(i,<span class="number">10</span>):</span><br><span class="line">        print(<span class="string">'&#123;&#125;x&#123;&#125;=&#123;&#125;\t'</span>.format(i, j, i*j), end=<span class="string">' '</span>)</span><br><span class="line"><span class="comment">#        print(str(i)+'*'+str(j)+'='+str(i*j),end=' ')</span></span><br><span class="line"><span class="comment">#        print(i,'*',j,'=',i*j,end=' ')</span></span><br><span class="line"><span class="comment"># 上面这样打印也可以，只是很难看</span></span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    <span class="comment"># 最后一行打印的是一个换行符</span></span><br><span class="line"><span class="number">1</span> * <span class="number">1</span> = <span class="number">1</span> <span class="number">1</span> * <span class="number">2</span> = <span class="number">2</span> <span class="number">1</span> * <span class="number">3</span> = <span class="number">3</span> <span class="number">1</span> * <span class="number">4</span> = <span class="number">4</span> <span class="number">1</span> * <span class="number">5</span> = <span class="number">5</span> <span class="number">1</span> * <span class="number">6</span> = <span class="number">6</span> <span class="number">1</span> * <span class="number">7</span> = <span class="number">7</span> <span class="number">1</span> * <span class="number">8</span> = <span class="number">8</span> <span class="number">1</span> * <span class="number">9</span> = <span class="number">9</span> </span><br><span class="line"><span class="number">2</span> * <span class="number">2</span> = <span class="number">4</span> <span class="number">2</span> * <span class="number">3</span> = <span class="number">6</span> <span class="number">2</span> * <span class="number">4</span> = <span class="number">8</span> <span class="number">2</span> * <span class="number">5</span> = <span class="number">10</span> <span class="number">2</span> * <span class="number">6</span> = <span class="number">12</span> <span class="number">2</span> * <span class="number">7</span> = <span class="number">14</span> <span class="number">2</span> * <span class="number">8</span> = <span class="number">16</span> <span class="number">2</span> * <span class="number">9</span> = <span class="number">18</span> </span><br><span class="line"><span class="number">3</span> * <span class="number">3</span> = <span class="number">9</span> <span class="number">3</span> * <span class="number">4</span> = <span class="number">12</span> <span class="number">3</span> * <span class="number">5</span> = <span class="number">15</span> <span class="number">3</span> * <span class="number">6</span> = <span class="number">18</span> <span class="number">3</span> * <span class="number">7</span> = <span class="number">21</span> <span class="number">3</span> * <span class="number">8</span> = <span class="number">24</span> <span class="number">3</span> * <span class="number">9</span> = <span class="number">27</span> </span><br><span class="line"><span class="number">4</span> * <span class="number">4</span> = <span class="number">16</span> <span class="number">4</span> * <span class="number">5</span> = <span class="number">20</span> <span class="number">4</span> * <span class="number">6</span> = <span class="number">24</span> <span class="number">4</span> * <span class="number">7</span> = <span class="number">28</span> <span class="number">4</span> * <span class="number">8</span> = <span class="number">32</span> <span class="number">4</span> * <span class="number">9</span> = <span class="number">36</span> </span><br><span class="line"><span class="number">5</span> * <span class="number">5</span> = <span class="number">25</span> <span class="number">5</span> * <span class="number">6</span> = <span class="number">30</span> <span class="number">5</span> * <span class="number">7</span> = <span class="number">35</span> <span class="number">5</span> * <span class="number">8</span> = <span class="number">40</span> <span class="number">5</span> * <span class="number">9</span> = <span class="number">45</span> </span><br><span class="line"><span class="number">6</span> * <span class="number">6</span> = <span class="number">36</span> <span class="number">6</span> * <span class="number">7</span> = <span class="number">42</span> <span class="number">6</span> * <span class="number">8</span> = <span class="number">48</span> <span class="number">6</span> * <span class="number">9</span> = <span class="number">54</span> </span><br><span class="line"><span class="number">7</span> * <span class="number">7</span> = <span class="number">49</span> <span class="number">7</span> * <span class="number">8</span> = <span class="number">56</span> <span class="number">7</span> * <span class="number">9</span> = <span class="number">63</span> </span><br><span class="line"><span class="number">8</span> * <span class="number">8</span> = <span class="number">64</span> <span class="number">8</span> * <span class="number">9</span> = <span class="number">72</span> </span><br><span class="line"><span class="number">9</span> * <span class="number">9</span> = <span class="number">81</span> </span><br><span class="line"></span><br><span class="line">方法三：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">1</span>,i):</span><br><span class="line">        print(end=<span class="string">"\t "</span>)    </span><br><span class="line">        <span class="comment"># 这行就是为了打印前面的空行的，这里需要一个Tab键加一个空格键才能让输出对齐</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(i,<span class="number">10</span>):</span><br><span class="line">        print(<span class="string">'&#123;&#125;x&#123;&#125;=&#123;&#125;\t'</span>.format(i, j, i*j), end=<span class="string">' '</span>)</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line"><span class="number">1</span>x1=<span class="number">1</span>	 <span class="number">1</span>x2=<span class="number">2</span>	 <span class="number">1</span>x3=<span class="number">3</span>	 <span class="number">1</span>x4=<span class="number">4</span>	 <span class="number">1</span>x5=<span class="number">5</span>	 <span class="number">1</span>x6=<span class="number">6</span>	 <span class="number">1</span>x7=<span class="number">7</span>	 <span class="number">1</span>x8=<span class="number">8</span>	 <span class="number">1</span>x9=<span class="number">9</span>	 </span><br><span class="line">	 <span class="number">2</span>x2=<span class="number">4</span>	 <span class="number">2</span>x3=<span class="number">6</span>	 <span class="number">2</span>x4=<span class="number">8</span>	 <span class="number">2</span>x5=<span class="number">10</span>	 <span class="number">2</span>x6=<span class="number">12</span>	 <span class="number">2</span>x7=<span class="number">14</span>	 <span class="number">2</span>x8=<span class="number">16</span>	 <span class="number">2</span>x9=<span class="number">18</span>	 </span><br><span class="line">	 	 <span class="number">3</span>x3=<span class="number">9</span>	 <span class="number">3</span>x4=<span class="number">12</span>	 <span class="number">3</span>x5=<span class="number">15</span>	 <span class="number">3</span>x6=<span class="number">18</span>	 <span class="number">3</span>x7=<span class="number">21</span>	 <span class="number">3</span>x8=<span class="number">24</span>	 <span class="number">3</span>x9=<span class="number">27</span>	 </span><br><span class="line">	 	 	 <span class="number">4</span>x4=<span class="number">16</span>	 <span class="number">4</span>x5=<span class="number">20</span>	 <span class="number">4</span>x6=<span class="number">24</span>	 <span class="number">4</span>x7=<span class="number">28</span>	 <span class="number">4</span>x8=<span class="number">32</span>	 <span class="number">4</span>x9=<span class="number">36</span>	 </span><br><span class="line">	 	 	 	 <span class="number">5</span>x5=<span class="number">25</span>	 <span class="number">5</span>x6=<span class="number">30</span>	 <span class="number">5</span>x7=<span class="number">35</span>	 <span class="number">5</span>x8=<span class="number">40</span>	 <span class="number">5</span>x9=<span class="number">45</span>	 </span><br><span class="line">	 	 	 	 	 <span class="number">6</span>x6=<span class="number">36</span>	 <span class="number">6</span>x7=<span class="number">42</span>	 <span class="number">6</span>x8=<span class="number">48</span>	 <span class="number">6</span>x9=<span class="number">54</span>	 </span><br><span class="line">	 	 	 	 	 	 <span class="number">7</span>x7=<span class="number">49</span>	 <span class="number">7</span>x8=<span class="number">56</span>	 <span class="number">7</span>x9=<span class="number">63</span>	 </span><br><span class="line">	 	 	 	 	 	 	 <span class="number">8</span>x8=<span class="number">64</span>	 <span class="number">8</span>x9=<span class="number">72</span>	 </span><br><span class="line">	 	 	 	 	 	 	 	 <span class="number">9</span>x9=<span class="number">81</span>	</span><br><span class="line"><span class="comment"># 实际输出要更整齐一些</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">方法四：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>-i):</span><br><span class="line">        print(end=<span class="string">"\t "</span>)            <span class="comment"># 打印每一行前面的Tab键，第一行就要打印9个</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,i+<span class="number">1</span>):</span><br><span class="line">        print(<span class="string">"&#123;&#125;*&#123;&#125;=&#123;&#125;"</span>.format(i,j,i*j), end=<span class="string">"\t "</span>)</span><br><span class="line">        <span class="comment"># \t放在end=""中好像更容易理解</span></span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">	 	 	 	 	 	 	 	 <span class="number">1</span>*<span class="number">1</span>=<span class="number">1</span>	 </span><br><span class="line">	 	 	 	 	 	 	 <span class="number">2</span>*<span class="number">1</span>=<span class="number">2</span>	 <span class="number">2</span>*<span class="number">2</span>=<span class="number">4</span>	 </span><br><span class="line">	 	 	 	 	 	 <span class="number">3</span>*<span class="number">1</span>=<span class="number">3</span>	 <span class="number">3</span>*<span class="number">2</span>=<span class="number">6</span>	 <span class="number">3</span>*<span class="number">3</span>=<span class="number">9</span>	 </span><br><span class="line">	 	 	 	 	 <span class="number">4</span>*<span class="number">1</span>=<span class="number">4</span>	 <span class="number">4</span>*<span class="number">2</span>=<span class="number">8</span>	 <span class="number">4</span>*<span class="number">3</span>=<span class="number">12</span>	 <span class="number">4</span>*<span class="number">4</span>=<span class="number">16</span>	 </span><br><span class="line">	 	 	 	 <span class="number">5</span>*<span class="number">1</span>=<span class="number">5</span>	 <span class="number">5</span>*<span class="number">2</span>=<span class="number">10</span>	 <span class="number">5</span>*<span class="number">3</span>=<span class="number">15</span>	 <span class="number">5</span>*<span class="number">4</span>=<span class="number">20</span>	 <span class="number">5</span>*<span class="number">5</span>=<span class="number">25</span>	 </span><br><span class="line">	 	 	 <span class="number">6</span>*<span class="number">1</span>=<span class="number">6</span>	 <span class="number">6</span>*<span class="number">2</span>=<span class="number">12</span>	 <span class="number">6</span>*<span class="number">3</span>=<span class="number">18</span>	 <span class="number">6</span>*<span class="number">4</span>=<span class="number">24</span>	 <span class="number">6</span>*<span class="number">5</span>=<span class="number">30</span>	 <span class="number">6</span>*<span class="number">6</span>=<span class="number">36</span>	 </span><br><span class="line">	 	 <span class="number">7</span>*<span class="number">1</span>=<span class="number">7</span>	 <span class="number">7</span>*<span class="number">2</span>=<span class="number">14</span>	 <span class="number">7</span>*<span class="number">3</span>=<span class="number">21</span>	 <span class="number">7</span>*<span class="number">4</span>=<span class="number">28</span>	 <span class="number">7</span>*<span class="number">5</span>=<span class="number">35</span>	 <span class="number">7</span>*<span class="number">6</span>=<span class="number">42</span>	 <span class="number">7</span>*<span class="number">7</span>=<span class="number">49</span>	 </span><br><span class="line">	 <span class="number">8</span>*<span class="number">1</span>=<span class="number">8</span>	 <span class="number">8</span>*<span class="number">2</span>=<span class="number">16</span>	 <span class="number">8</span>*<span class="number">3</span>=<span class="number">24</span>	 <span class="number">8</span>*<span class="number">4</span>=<span class="number">32</span>	 <span class="number">8</span>*<span class="number">5</span>=<span class="number">40</span>	 <span class="number">8</span>*<span class="number">6</span>=<span class="number">48</span>	 <span class="number">8</span>*<span class="number">7</span>=<span class="number">56</span>	 <span class="number">8</span>*<span class="number">8</span>=<span class="number">64</span>	 </span><br><span class="line"><span class="number">9</span>*<span class="number">1</span>=<span class="number">9</span>	 <span class="number">9</span>*<span class="number">2</span>=<span class="number">18</span>	 <span class="number">9</span>*<span class="number">3</span>=<span class="number">27</span>	 <span class="number">9</span>*<span class="number">4</span>=<span class="number">36</span>	 <span class="number">9</span>*<span class="number">5</span>=<span class="number">45</span>	 <span class="number">9</span>*<span class="number">6</span>=<span class="number">54</span>	 <span class="number">9</span>*<span class="number">7</span>=<span class="number">63</span>	 <span class="number">9</span>*<span class="number">8</span>=<span class="number">72</span>	 <span class="number">9</span>*<span class="number">9</span>=<span class="number">81</span></span><br><span class="line"></span><br><span class="line">方法五：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,i+<span class="number">1</span>):</span><br><span class="line">        print(<span class="string">'&#123;&#125;*&#123;&#125;=&#123;&#125;'</span>.format(i,j,i*j), end=<span class="string">""</span>)</span><br><span class="line">    <span class="comment"># 这种把算式打印在前面，之后再加分隔符的方法中，分隔符使用什么都可以，可以是空格或Tab键或什么也不加</span></span><br><span class="line">    print()</span><br><span class="line"><span class="number">1</span>*<span class="number">1</span>=<span class="number">1</span>	 </span><br><span class="line"><span class="number">2</span>*<span class="number">1</span>=<span class="number">2</span>	<span class="number">2</span>*<span class="number">2</span>=<span class="number">4</span>	 </span><br><span class="line"><span class="number">3</span>*<span class="number">1</span>=<span class="number">3</span>	<span class="number">3</span>*<span class="number">2</span>=<span class="number">6</span>	<span class="number">3</span>*<span class="number">3</span>=<span class="number">9</span>	 </span><br><span class="line"><span class="number">4</span>*<span class="number">1</span>=<span class="number">4</span>	<span class="number">4</span>*<span class="number">2</span>=<span class="number">8</span>	<span class="number">4</span>*<span class="number">3</span>=<span class="number">12</span>	<span class="number">4</span>*<span class="number">4</span>=<span class="number">16</span>	 </span><br><span class="line"><span class="number">5</span>*<span class="number">1</span>=<span class="number">5</span>	<span class="number">5</span>*<span class="number">2</span>=<span class="number">10</span>	<span class="number">5</span>*<span class="number">3</span>=<span class="number">15</span>	<span class="number">5</span>*<span class="number">4</span>=<span class="number">20</span>	<span class="number">5</span>*<span class="number">5</span>=<span class="number">25</span>	 </span><br><span class="line"><span class="number">6</span>*<span class="number">1</span>=<span class="number">6</span>	<span class="number">6</span>*<span class="number">2</span>=<span class="number">12</span>	<span class="number">6</span>*<span class="number">3</span>=<span class="number">18</span>	<span class="number">6</span>*<span class="number">4</span>=<span class="number">24</span>	<span class="number">6</span>*<span class="number">5</span>=<span class="number">30</span>	<span class="number">6</span>*<span class="number">6</span>=<span class="number">36</span>	 </span><br><span class="line"><span class="number">7</span>*<span class="number">1</span>=<span class="number">7</span>	<span class="number">7</span>*<span class="number">2</span>=<span class="number">14</span>	<span class="number">7</span>*<span class="number">3</span>=<span class="number">21</span>	<span class="number">7</span>*<span class="number">4</span>=<span class="number">28</span>	<span class="number">7</span>*<span class="number">5</span>=<span class="number">35</span>	<span class="number">7</span>*<span class="number">6</span>=<span class="number">42</span>	<span class="number">7</span>*<span class="number">7</span>=<span class="number">49</span>	 </span><br><span class="line"><span class="number">8</span>*<span class="number">1</span>=<span class="number">8</span>	<span class="number">8</span>*<span class="number">2</span>=<span class="number">16</span>	<span class="number">8</span>*<span class="number">3</span>=<span class="number">24</span>	<span class="number">8</span>*<span class="number">4</span>=<span class="number">32</span>	<span class="number">8</span>*<span class="number">5</span>=<span class="number">40</span>	<span class="number">8</span>*<span class="number">6</span>=<span class="number">48</span>	<span class="number">8</span>*<span class="number">7</span>=<span class="number">56</span>	<span class="number">8</span>*<span class="number">8</span>=<span class="number">64</span>	 </span><br><span class="line"><span class="number">9</span>*<span class="number">1</span>=<span class="number">9</span>	<span class="number">9</span>*<span class="number">2</span>=<span class="number">18</span>	<span class="number">9</span>*<span class="number">3</span>=<span class="number">27</span>	<span class="number">9</span>*<span class="number">4</span>=<span class="number">36</span>	<span class="number">9</span>*<span class="number">5</span>=<span class="number">45</span>	<span class="number">9</span>*<span class="number">6</span>=<span class="number">54</span>	<span class="number">9</span>*<span class="number">7</span>=<span class="number">63</span>	<span class="number">9</span>*<span class="number">8</span>=<span class="number">72</span>	<span class="number">9</span>*<span class="number">9</span>=<span class="number">81</span></span><br></pre></td></tr></table></figure>
<h3 id="打印100以内的斐波那契数列及打印第101项"><a href="#打印100以内的斐波那契数列及打印第101项" class="headerlink" title="打印100以内的斐波那契数列及打印第101项"></a>打印100以内的斐波那契数列及打印第101项</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 费波那契数列由0和1开始，之后的费波那契系数就是由之前的两数相加而得出。首几个费波那契系数是：</span></span><br><span class="line"><span class="comment"># 0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233……（OEIS中的数列A000045）</span></span><br><span class="line"><span class="comment"># 特别指出：0不是第一项，而是第零项。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印100以内的斐波那契数</span></span><br><span class="line">a=<span class="number">0</span></span><br><span class="line">b=<span class="number">1</span></span><br><span class="line">print(a)</span><br><span class="line">print(b)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    c = a + b</span><br><span class="line">    <span class="keyword">if</span> c &gt; <span class="number">100</span>:</span><br><span class="line">    	<span class="keyword">break</span></span><br><span class="line">    print(c)</span><br><span class="line">    a=b</span><br><span class="line">    b=c</span><br><span class="line"><span class="comment"># 如果小于100就打印，大于100就停止。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印101项斐波那契数</span></span><br><span class="line">a = <span class="number">0</span></span><br><span class="line">b = <span class="number">1</span></span><br><span class="line"><span class="comment"># 手动打印前两项</span></span><br><span class="line">print(<span class="string">'&#123;&#125;,&#123;&#125;'</span>.format(<span class="number">0</span>, a))</span><br><span class="line">print(<span class="string">'&#123;&#125;,&#123;&#125;'</span>.format(<span class="number">1</span>, b))</span><br><span class="line">index = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    c = a + b</span><br><span class="line">    a = b</span><br><span class="line">    b = c</span><br><span class="line">    index += <span class="number">1</span></span><br><span class="line">    print(<span class="string">'&#123;&#125;,&#123;&#125;'</span>.format(index, c))</span><br><span class="line">    <span class="comment"># 这里的index就是显示中前面的序号</span></span><br><span class="line">    <span class="keyword">if</span> index == <span class="number">101</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 只打印第101项</span></span><br><span class="line">a=<span class="number">0</span></span><br><span class="line">b=<span class="number">1</span></span><br><span class="line"><span class="comment">#print(a)</span></span><br><span class="line"><span class="comment">#print(b)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">101</span>):</span><br><span class="line">    c = a + b</span><br><span class="line">    a=b</span><br><span class="line">    b=c</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">100</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    print(c)</span><br><span class="line">    <span class="comment"># 打印一定要放在最后，因为如果放在c = a + b下方，那么就无法将if判断加入进去了</span></span><br><span class="line">    </span><br><span class="line">a = <span class="number">0</span></span><br><span class="line">b = <span class="number">1</span></span><br><span class="line"><span class="comment"># print('&#123;&#125;,&#123;&#125;'.format(0,a))</span></span><br><span class="line"><span class="comment"># print('&#123;&#125;,&#123;&#125;'.format(1,b))</span></span><br><span class="line">index = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    c = a + b</span><br><span class="line">    a,b = b,c</span><br><span class="line">    index += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> index == <span class="number">101</span>:</span><br><span class="line">        print(<span class="string">'&#123;&#125;,&#123;&#125;'</span>.format(index,c))</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h3 id="求素数"><a href="#求素数" class="headerlink" title="求素数"></a>求素数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">方法<span class="number">1</span></span><br><span class="line"><span class="comment"># 最简单的思路，按照定义来，假设有一个数n(n&gt;1)，从2开始判断，一直判断到n-1</span></span><br><span class="line">n = <span class="number">12577</span> <span class="comment"># 避开3、5、10、2的倍数</span></span><br><span class="line">flag = <span class="keyword">False</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,n):</span><br><span class="line">    <span class="keyword">if</span> n % i == <span class="number">0</span>:    <span class="comment"># 找到条件是什么</span></span><br><span class="line">        flag = <span class="keyword">True</span></span><br><span class="line">        print(i)	<span class="comment"># 这里打印的是可以整除的数字</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    print(n, <span class="string">'is not a prime number. '</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(n, <span class="string">'is a prime number. '</span>)</span><br><span class="line">    </span><br><span class="line">方法<span class="number">2</span></span><br><span class="line">n = <span class="number">1577</span> <span class="comment"># 避开3、5、10、2的倍数</span></span><br><span class="line"><span class="comment"># 对这个数从2开始测试到n-1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,n):</span><br><span class="line">    <span class="keyword">if</span> n % i == <span class="number">0</span>:    <span class="comment"># 找到条件是什么</span></span><br><span class="line">        print(n, <span class="string">'is not a prime number. '</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(n, <span class="string">'is a prime number'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="求10万内的所有素数"><a href="#求10万内的所有素数" class="headerlink" title="求10万内的所有素数"></a>求10万内的所有素数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 质数（Prime number），又称素数，指在大于1的自然数中，除了1和该数自身外，无法被其他自然数整除的数（也可定义为只有1与该数本身两个正因数的数）。</span></span><br><span class="line"><span class="comment"># 大于1的自然数若不是素数，则称之为合数（也称为合成数）。</span></span><br><span class="line"><span class="comment"># 算术基本定理确立了素数于数论里的核心地位：任何大于1的整数均可被表示成一串唯一素数之乘积。</span></span><br><span class="line"><span class="comment"># 为了确保该定理的唯一性，1被定义为不是素数，因为在因式分解中可以有任意多个1（如3、1×3、1×1×3等都是3的有效约数分解）。</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">t = [<span class="number">2</span>]    <span class="comment"># 素数是从2开始的</span></span><br><span class="line">t0 = time.time()</span><br><span class="line">count = <span class="number">1</span></span><br><span class="line"><span class="comment"># 去掉所有偶数，从3开始迭代，步进为2</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">3</span>,<span class="number">100001</span>,<span class="number">2</span>):</span><br><span class="line">    <span class="keyword">if</span> x &gt; <span class="number">5</span> <span class="keyword">and</span> x % <span class="number">10</span> == <span class="number">5</span>:</span><br><span class="line"><span class="comment"># 所有大于10的质数中，个位数只有1、3、7、9，大于5且以5结尾的整数都能被5整除，这里首先过滤掉大于5且以5结尾的整数</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>, int(x ** <span class="number">0.5</span>) + <span class="number">1</span>, <span class="number">2</span>):    </span><br><span class="line"><span class="comment"># 这里的int最后加1,是因为前包后不包，所以要加1. 这一步就是为了测试当前的数字是否可以被i这个数字整除。</span></span><br><span class="line"><span class="comment"># 比如这时x是49,那么就要测试49是否可以被从3开始，到49开平方后加1的数字，并且去除了偶数，也就是剩下的这些数字整除，如果不能就是素数。</span></span><br><span class="line"><span class="comment"># 这一步是想表达，如果一个整数可以被其平方根因子前面的数整除就一定可以被平方根因子后面的数整除，所以只算平方根因子前面的数就可以了。</span></span><br><span class="line"><span class="comment"># 一个整数的前后对应的两个因子的乘积等于这个整数，所以一个整数如果平方根之前有一个因子，那平方根之后肯定有一个对应的因子，中间是平方根</span></span><br><span class="line"><span class="comment"># 上面所说的“一个整数的前后对应的两个因子的乘积等于这个整数”，是想表示如2*50=100，100就是那个整个，2就是前面的因子，50是后面的因子</span></span><br><span class="line"><span class="comment"># 平方根就在这两个因子之间。</span></span><br><span class="line">        <span class="keyword">if</span> x % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        t.append(x)</span><br><span class="line"><span class="comment"># 这个else是for语句的，当x可以整除i时，就跳出循环，否则就在count中加一个计数，并将x回到t列表中</span></span><br><span class="line">print(t)</span><br><span class="line">print(<span class="string">'花费时间: &#123;&#125;'</span>.format(time.time() - t0))</span><br><span class="line">print(<span class="string">'质数个数: &#123;&#125;'</span>.format(count))</span><br><span class="line">print(<span class="string">'质数个数: &#123;&#125;'</span>.format(len(t)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 讲解:</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">100</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">100</span> % i:    <span class="comment"># 如果100与i取余不为1,那么就打印</span></span><br><span class="line">        print(i)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 100 = 2 x 50</span></span><br><span class="line"><span class="comment"># 100 = 4 x 25</span></span><br><span class="line"><span class="comment"># 100 = 5 x 20</span></span><br><span class="line"><span class="comment"># 100 = 10 x 10</span></span><br><span class="line"><span class="comment"># 这样很容易看出，在平方根10之前，如果100有一个因子，那么平方根后面一定有一个对应的因子，而平方根`10x10`是临界点。</span></span><br><span class="line"><span class="comment"># 所以被除数可以从平方根处砍掉后面的部分。</span></span><br><span class="line"><span class="comment"># 上面的意思是想说明，2*50=100和50*2=100是一个意思，所以在平方根上面的因子计算完就可以了，可以忽略掉平方根下面的因子</span></span><br><span class="line"><span class="comment"># 由于相差一个指数，一个整数的平方根通常都比自身小很多，数值越大，相差越大。</span></span><br><span class="line"><span class="comment"># 比如100比10大90，10000比100大9900，这样看就发现数据量减少了不止一星半点。</span></span><br></pre></td></tr></table></figure>
<h3 id="打印菱形"><a href="#打印菱形" class="headerlink" title="打印菱形"></a>打印菱形</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 思路：</span></span><br><span class="line"><span class="comment"># 行号	个数		前空格		总空格数</span></span><br><span class="line"><span class="comment">#  1	   1		3			6</span></span><br><span class="line"><span class="comment">#  2	   3		2			4</span></span><br><span class="line"><span class="comment">#  3	   5		1			2</span></span><br><span class="line"><span class="comment">#  4	   7		0			0</span></span><br><span class="line"><span class="comment">#  5	   5		1			2</span></span><br><span class="line"><span class="comment">#  6	   3		2			4</span></span><br><span class="line"><span class="comment">#  7	   1		3			6</span></span><br><span class="line"><span class="comment"># 这是中心对称的</span></span><br><span class="line"><span class="comment"># 我们关注的是一行如果打满星号总共的数量与前空格一列，每行菱形前面的空格从3-0,再从0-3</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">-3</span>,<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">0</span>:</span><br><span class="line">        prespace = -i</span><br><span class="line">        <span class="comment"># 这里是将数字变为正数</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        prespace = i</span><br><span class="line">    print(<span class="string">' '</span>*prespace+<span class="string">'*'</span>*(<span class="number">7</span>-prespace*<span class="number">2</span>))</span><br><span class="line">    <span class="comment"># 这是发现的公式。' '*prespace是要打印的空格数，'*'*(7-prespace*2))是要打印几个星号。</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 三目运算符方法</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">-3</span>,<span class="number">4</span>):</span><br><span class="line">    prespace=-i <span class="keyword">if</span> i &lt; <span class="number">0</span> <span class="keyword">else</span> i</span><br><span class="line">    <span class="comment"># 这里不能写成prespace=-i if (i &lt; 0) else prespace=i，这样会报语法错误。</span></span><br><span class="line">    print(<span class="string">' '</span>*prespace+<span class="string">'*'</span>*(<span class="number">7</span>-prespace*<span class="number">2</span>))</span><br></pre></td></tr></table></figure>
<h3 id="打印对顶三角形"><a href="#打印对顶三角形" class="headerlink" title="打印对顶三角形"></a>打印对顶三角形</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 思路：</span></span><br><span class="line"><span class="comment"># 行号	对称序列	  星号数	  总空格数	前置空格数		后置空格数</span></span><br><span class="line"><span class="comment">#  1		3			7			0		0				0	   </span></span><br><span class="line"><span class="comment">#  2		2			5			2		1				1</span></span><br><span class="line"><span class="comment">#  3		1			3			4		2				2</span></span><br><span class="line"><span class="comment">#  4		0			1			6		3				3</span></span><br><span class="line"><span class="comment">#  5		1			3			4		2				2</span></span><br><span class="line"><span class="comment">#  6		2			5			2		1				1</span></span><br><span class="line"><span class="comment">#  7		3			7			0		0				0</span></span><br><span class="line"><span class="comment"># 可以看出，只与前置空格、起点、终点有关</span></span><br><span class="line">n = <span class="number">7</span></span><br><span class="line">e = n//<span class="number">2</span>		<span class="comment"># 因为是对称问题所以除2？</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(-e, n-e):</span><br><span class="line">    prespace = -i <span class="keyword">if</span> i&lt;<span class="number">0</span> <span class="keyword">else</span> i     <span class="comment"># 这一步是将数字都变为正数</span></span><br><span class="line">    print(<span class="string">' '</span>*(e-prespace) + <span class="string">'*'</span>*(<span class="number">2</span>*prespace+<span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<h3 id="打印闪电"><a href="#打印闪电" class="headerlink" title="打印闪电"></a>打印闪电</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 思路：</span></span><br><span class="line"><span class="comment"># 行号	个数		前空格		后空格数	总空格数	数据</span></span><br><span class="line"><span class="comment">#  1	   1		3			3			6		-3</span></span><br><span class="line"><span class="comment">#  2	   2		2			3			5		-2</span></span><br><span class="line"><span class="comment">#  3	   3		1			3			4		-1</span></span><br><span class="line"><span class="comment">#  4	   7		0			0			0		0</span></span><br><span class="line"><span class="comment">#  5	   3		3			1			4		1</span></span><br><span class="line"><span class="comment">#  6	   2		3			2			5		2</span></span><br><span class="line"><span class="comment">#  7	   1		3			3			6		3</span></span><br><span class="line"><span class="comment"># 看一下上面数据一列</span></span><br><span class="line">方法<span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">-3</span>,<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">' '</span>*(-i)+<span class="string">'*'</span>*(<span class="number">4</span>+i))</span><br><span class="line">    <span class="keyword">elif</span> i &gt; <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">' '</span>*<span class="number">3</span>+<span class="string">'*'</span>*(<span class="number">4</span>-i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'*'</span>*<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">方法<span class="number">2</span></span><br><span class="line">j = <span class="string">'*'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">-3</span>,<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        print(j*<span class="number">7</span>)</span><br><span class="line">    print(<span class="string">" "</span>*(-i) + j*(i+<span class="number">4</span>)) <span class="keyword">if</span> i&lt;<span class="number">0</span> <span class="keyword">else</span> print(<span class="number">3</span>*<span class="string">" "</span> + j*(<span class="number">3</span>-i))</span><br></pre></td></tr></table></figure>
<h3 id="解决猴子吃桃问题"><a href="#解决猴子吃桃问题" class="headerlink" title="解决猴子吃桃问题"></a>解决猴子吃桃问题</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 猴子第一天摘下若干个桃子，当即吃了一半，还不过瘾，又多吃了一个。第二天早上又将剩下的桃子吃掉一半，又多吃了一个。以后每天早上都吃了前一天剩下的一半零一个。到了第10天早上想吃时，只剩下一个桃子了。求第一天共摘了多少个桃子。</span></span><br><span class="line"><span class="comment"># 猴子应该第九天吃完时就已经知道只剩下一个桃子了。</span></span><br><span class="line">n=<span class="number">1</span>    <span class="comment"># 这是最后剩下的桃子的数目</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):   </span><br><span class="line"><span class="comment"># 如果是一个不关心或没用的变量可以使用下划线代替，这个变量在这里只是为了迭代使用的。</span></span><br><span class="line">    n=(n+<span class="number">1</span>)*<span class="number">2</span></span><br><span class="line">    print(n)</span><br><span class="line"><span class="comment"># 从题目中得出公式：x/2-1=n，x是桃子的总数，n是剩下桃子的数目，反过来就得到(n+1)*2就是总的桃子的数目。将这个公式迭代9次就是总的数目。</span></span><br><span class="line"><span class="comment"># 所以用range(1,10)</span></span><br></pre></td></tr></table></figure>
<h3 id="杨辉三角"><a href="#杨辉三角" class="headerlink" title="杨辉三角"></a>杨辉三角</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line">-----------</span><br><span class="line">  方法一</span><br><span class="line">-----------</span><br><span class="line">triangle=[[<span class="number">1</span>],[<span class="number">1</span>,<span class="number">1</span>]]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">6</span>):    </span><br><span class="line"><span class="comment"># 从2开始是因为前两个列表已经有了，所以从2开始</span></span><br><span class="line">    cur = [<span class="number">1</span>]           </span><br><span class="line"><span class="comment"># 这是每个元素的第一个1</span></span><br><span class="line">    pre = triangle[i<span class="number">-1</span>]     </span><br><span class="line"><span class="comment"># 这里定义的pre是要计算的列表元素的上一个元素，也就是triangle列表中的哪个小的列表。如第一次要计算的就是</span></span><br><span class="line"><span class="comment"># 第三个元素，所以pre就是第二个。说明pre等于triangle列表中的第几个列表，如i等于1，那么，pre就等于</span></span><br><span class="line"><span class="comment"># triangle[0]，因为这是triangle中的第一个列表。当第一次i等于2时这里是[1,1]</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(pre)<span class="number">-1</span>):         </span><br><span class="line"><span class="comment"># len(pre)是计算pre这个列表中有几个元素。这个循环就是在凑前后两个1中间的部分。第一次循环时，len(pre)的</span></span><br><span class="line"><span class="comment"># 结果是2，减去1后j等于0。这里这样做是因为在杨辉三角中每行的行号与这一行中元素的个数是一样的。如第三行</span></span><br><span class="line"><span class="comment"># 的列表中就有三个元素，这里减1是因为上面的cur已经定义了每个元素的第一个1，最后的1还没追加，所以减去1</span></span><br><span class="line"><span class="comment"># 就是两个1中间的元素的个数了</span></span><br><span class="line">        cur.append(pre[j]+pre[j+<span class="number">1</span>])        </span><br><span class="line"><span class="comment"># pre[j]+pre[j+1]第一次计算的结果是2，也就是pre[0]+pre[0+1]，这时的pre等于[1,1]，所以pre的第0个</span></span><br><span class="line"><span class="comment"># 和第1个元素都是1，所以相加得2。之后将pre[2]追加到了cur中，cur这时是[1]，所以结果就是[1,2]。再加上</span></span><br><span class="line"><span class="comment"># 下面追加的1，就成了第三个元素[1,2,1]</span></span><br><span class="line">    cur.append(<span class="number">1</span>)   </span><br><span class="line"><span class="comment"># 这是向cur的一个列表中插入1，如原来是[1]，插入后就是[1,1]，这插入的应该是每个元素最后一个1。上面的循环</span></span><br><span class="line"><span class="comment"># 结束到这一步，也就意味着一个元素计算完毕，下面追加到triangle列表中，之后就可以进入下个循环了。</span></span><br><span class="line">    triangle.append(cur)        </span><br><span class="line"><span class="comment"># 这里再将cur追加到现在的triangle中，就有了[[1], [1, 1], [1, 2, 1]]</span></span><br><span class="line">print(triangle)</span><br><span class="line"><span class="comment"># 输出结果：[[1], [1, 1], [1, 2, 1], [1, 3, 3, 1], [1, 4, 6, 4, 1], [1, 5, 10, 10, 5, 1]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法一变体</span></span><br><span class="line">triangle=[]</span><br><span class="line">n = <span class="number">4</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">    row = [<span class="number">1</span>]</span><br><span class="line"><span class="comment"># 这是每一个元素的第一个1</span></span><br><span class="line">    triangle.append(row)</span><br><span class="line"><span class="comment"># 追加row到triangle列表中</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(i<span class="number">-1</span>):    </span><br><span class="line"><span class="comment"># 当i是2的时候会进入这个循环，计算两个1中间的部分，这里j是0</span></span><br><span class="line">        row.append(triangle[i<span class="number">-1</span>][j]+triangle[i<span class="number">-1</span>][j+<span class="number">1</span>])</span><br><span class="line"><span class="comment"># triangle[i-1][j]中的[i-1]表示triangle中的第几个小列表，之后的[j]表示列表中的第几个元素。如果</span></span><br><span class="line"><span class="comment"># i是2的话，那么triangle[i-1]就是triangle中的第1个小列表，也就是[1,1]，这时j等于0,</span></span><br><span class="line"><span class="comment"># triangle[i-1][j]的结果就是1，triangle[i-1][j+1]的结果也是1，但它们表示[1,1]中前后两个不同的1，</span></span><br><span class="line"><span class="comment"># 再将它们相加就是2，这就算出了两个1中间的部分。当i等于3时，这里会循环两次，所以能算出两个3</span></span><br><span class="line">    row.append(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 这是每个元素的最后一个1</span></span><br><span class="line">print(triangle)</span><br><span class="line"><span class="comment"># 输出结果：[[1], [1, 1], [1, 2, 1], [1, 3, 3, 1]]</span></span><br><span class="line"></span><br><span class="line">======================================================================================</span><br><span class="line">triangle = []</span><br><span class="line">row = [<span class="number">1</span>]</span><br><span class="line">triangle.append(row)</span><br><span class="line">row.append(<span class="number">1</span>)</span><br><span class="line">row.append(<span class="number">999</span>)</span><br><span class="line">print(triangle)</span><br><span class="line"><span class="comment"># 发现这样的问题，虽然按顺序执行会先将row插入到triangle中，但之后再向row中插入一个1和999，这时triangle</span></span><br><span class="line"><span class="comment"># 不会是[[1]]，而是[[1,1,999]]。可以向列表中的元素列表中直接添加子元素</span></span><br><span class="line">======================================================================================</span><br><span class="line"></span><br><span class="line">-------------------</span><br><span class="line"> 方法二-<span class="keyword">while</span></span><br><span class="line">-------------------</span><br><span class="line">n = <span class="number">6</span></span><br><span class="line">oldline = []        </span><br><span class="line"><span class="comment"># oldline就是为了凑每行的[1]和1之后的部分</span></span><br><span class="line">newline = [<span class="number">1</span>]</span><br><span class="line"><span class="comment"># length = 0</span></span><br><span class="line">print(newline)      </span><br><span class="line"><span class="comment"># 先打印出第一行的[1]</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,n):        </span><br><span class="line"><span class="comment"># 这里会循环1-5</span></span><br><span class="line">    oldline = newline.copy()</span><br><span class="line"><span class="comment"># 这是浅拷贝。先把每行的第一个1凑出来。第二次循环时，这里的oldline就会复制成了[1,1]，因为newline变了</span></span><br><span class="line">    oldline.append(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 尾部加0，这时的oldline是[1,0]，向oldline中追加0是为了下面计算各元素的值</span></span><br><span class="line">    newline.clear()     </span><br><span class="line"><span class="comment"># 清空newline，这时的newline是[]</span></span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> offset &lt;= i:  <span class="comment"># 满足条件进入循环，这里计算的是从第二行开始的数据</span></span><br><span class="line">        newline.append(oldline[offset - <span class="number">1</span>] + oldline[offset])</span><br><span class="line"><span class="comment"># 这里开始凑每行中的所有内容，第一次i是1，offset是0，oldline[0-1] + oldline[0]，这时oldline[-1]</span></span><br><span class="line"><span class="comment"># 是0，oldline[0]是1，这两个数相加也就是[1]，把[1]追加到newline中，下面offset自增加1，因为offset</span></span><br><span class="line"><span class="comment"># 和i都是1，所以还会进一次循环，newline现在是[1]，oldline[1-1] + oldline[1]，这时oldline[0]是1，oldline[1]是0，这两个数相加也是[1]，追加到newline这个列表中，这时newline是[1,1]。之后offset</span></span><br><span class="line"><span class="comment"># 再增加1，这时offset大于i，退出循环。最后就打印出了第二行的[1,1]</span></span><br><span class="line">        offset += <span class="number">1</span></span><br><span class="line">    print(newline)</span><br><span class="line">    </span><br><span class="line">----------------</span><br><span class="line"> 方法二-<span class="keyword">for</span></span><br><span class="line">----------------</span><br><span class="line">n = <span class="number">6</span></span><br><span class="line">oldline = []</span><br><span class="line">newline = [<span class="number">1</span>]</span><br><span class="line"><span class="comment"># length = 0</span></span><br><span class="line">print(newline)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,n):</span><br><span class="line">    oldline = newline.copy()</span><br><span class="line"><span class="comment"># 这是浅拷贝</span></span><br><span class="line">    oldline.append(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 尾部加0,相当于两端加0</span></span><br><span class="line">    newline.clear()</span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(i+<span class="number">1</span>):</span><br><span class="line">        newline.append(oldline[j<span class="number">-1</span>]+oldline[j])</span><br><span class="line">    print(newline)</span><br><span class="line"><span class="comment"># 这个方法与上面的while方面的思路是一样的。</span></span><br><span class="line"></span><br><span class="line">======================================================================================</span><br><span class="line"><span class="comment"># 如何比较两段代码的效率？效率一是看时间，一是看进入循环的次数</span></span><br><span class="line"><span class="comment"># 算10以内的质数-1</span></span><br><span class="line"><span class="keyword">import</span> datetime         </span><br><span class="line"><span class="comment"># 要装载这个模块</span></span><br><span class="line">n = <span class="number">100000</span></span><br><span class="line">pn = []</span><br><span class="line">count = <span class="number">0</span>       </span><br><span class="line"><span class="comment"># 这是为了计数。用count计算进入循环的次数</span></span><br><span class="line">start = datetime.datetime.now()     </span><br><span class="line"><span class="comment"># 设置一个开始时间</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">2</span>,n):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pn:        </span><br><span class="line"><span class="comment"># 通过这样的方式，向pn列表中添加元素。第一次pn是空，2会被添加到pn中。之后随着pn的增长，x会与pn中所</span></span><br><span class="line"><span class="comment"># 有的数字进行取余，如果结果是0就跳出与pn列表中数字取余的循环。否则，这个与pn列表中数字取余的数字x</span></span><br><span class="line"><span class="comment"># 就是质数</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> x % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pn.append(x)</span><br><span class="line"><span class="comment">#print(pn)</span></span><br><span class="line">delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line"><span class="comment"># 用现在的时间减去开始时间，.total_seconds计算全部时间差。</span></span><br><span class="line">print(len(pn))</span><br><span class="line">print(count)</span><br><span class="line">print(delta)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 算质数-2</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line">n = <span class="number">100000</span></span><br><span class="line">pn = []</span><br><span class="line">flag = <span class="keyword">False</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line">start = datetime.datetime.now()</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">2</span>,n):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pn:</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> x % i == <span class="number">0</span>:   </span><br><span class="line"><span class="comment"># 这是如果进来了，就不是质数。实际与2、3、5等取余为0的都会在这个条件下被屏蔽掉。</span></span><br><span class="line">            flag = <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> i &gt;= math.ceil(x**<span class="number">0.5</span>):    </span><br><span class="line"><span class="comment"># 这里如果进来了，就是质数。ceil() 函数返回数字的上入整数。x**0.5就是对x开方。到这里的都是筛选过一</span></span><br><span class="line"><span class="comment"># 次的数字了</span></span><br><span class="line">            flag = <span class="keyword">False</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 先用x与i取余，如果是0,就表示不是质数。如果结果都不为0,再用</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">        pn.append(x)</span><br><span class="line"><span class="comment"># print(pn)</span></span><br><span class="line">delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">print(len(pn))    </span><br><span class="line"><span class="comment"># 计算打印的个数</span></span><br><span class="line">print(count)</span><br><span class="line">print(delta)</span><br><span class="line">======================================================================================</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  方法三</span><br><span class="line">------------</span><br><span class="line"><span class="comment"># 尾部追加效率最高</span></span><br><span class="line"><span class="comment"># 能不能一次性开辟空间。所谓一次性开辟，就是将一列先算出来，不断向后追加，直到追加完最后一个1。中间部分先用数字填充，下面两例使用0或1来填充。如[1,0,1] [1,1,1,1]</span></span><br><span class="line"><span class="comment"># 列表解析式</span></span><br><span class="line"><span class="comment"># 循环迭代</span></span><br><span class="line"><span class="comment"># 能不能少算一半的数字</span></span><br><span class="line"><span class="comment"># 思路：先开辟新列表，把列表中元素的个数先定下来，之后再改。下面计算包括中间点向左部分的数字，</span></span><br><span class="line"><span class="comment"># 也就是range(1,i//2+1)，之后每计算出中间点向左部分的数字时，都会用if判断语句在反方向相对应的位置加入</span></span><br><span class="line"><span class="comment"># 相同的一个数字。最后修改的是中间部分的数字。</span></span><br><span class="line">triangle = []</span><br><span class="line">n = <span class="number">6</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):      </span><br><span class="line"><span class="comment"># 这里的循环从0-5</span></span><br><span class="line">    row = [<span class="number">1</span>]       </span><br><span class="line"><span class="comment"># 开始的1</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(i):      </span><br><span class="line"><span class="comment"># 当i是0的时候，不会执行for k in循环下面的语句，因为k是空。</span></span><br><span class="line">        row.append(<span class="number">1</span>) <span class="keyword">if</span> k == i<span class="number">-1</span> <span class="keyword">else</span> row.append(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 如果k等于i-1，那么就向row后追加1，否则就追加0。上面这条语句是在中间填0，尾部填1</span></span><br><span class="line">    triangle.append(row)        </span><br><span class="line"><span class="comment"># 第一次因为i是0，所以直接到这里，将row插入到triangle列表中，之后到下面的语句，当i为0时跳出此轮循环，</span></span><br><span class="line"><span class="comment"># 返回到循环的首部。第二次因为i是1，所以执行上面循环的语句，向row中插入1，row变成了[1,1]</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,i//<span class="number">2</span>+<span class="number">1</span>):       </span><br><span class="line"><span class="comment"># 当i是1时，这里是for j in range(1,1)，因为是range(1,1)所以不会向下执行。i=2时，也就是计算到第三行</span></span><br><span class="line"><span class="comment"># 才能进来。这是少算一半数字吗？只算中点以前的数字，然后根据结果追加数字，在中间点的数字前或后，所以这里</span></span><br><span class="line"><span class="comment"># 要除2再加1，因为是前包后不包，所以要加1</span></span><br><span class="line"><span class="comment"># 当i是4时，这里循环两次，j是1时，triangle[3][0] + triangle[3][1]，就是[1,3,3,1]，可以算出左半边</span></span><br><span class="line"><span class="comment"># 的4，下面把row[1]=4，这时row是[1,4,1,1,1]，再向下执行到if语句时，会在反方向对应的位置加入相同的数</span></span><br><span class="line"><span class="comment"># 字，也就成了[1,4,1,4,1]，j是2时，triangle[3][1]+triangle[3][2]，就是[1,3,3,1]中的3加3，也就</span></span><br><span class="line"><span class="comment"># 是中间的数字6被计算出来了。</span></span><br><span class="line">        val = triangle[i<span class="number">-1</span>][j<span class="number">-1</span>] + triangle[i<span class="number">-1</span>][j]</span><br><span class="line">        row[j] = val</span><br><span class="line">        <span class="keyword">if</span> i != <span class="number">2</span>*j:   </span><br><span class="line"><span class="comment"># 条件满足，修改中点以后数据的值，从后向前数，偶数行都会满足这里的条件，或者说，每行中前后两个数字能有对</span></span><br><span class="line"><span class="comment"># 称的，都会满足这里的条件，只有计算到奇数的中间点数字时，不能满足这里的条件</span></span><br><span class="line">            row[-j<span class="number">-1</span>] = val</span><br><span class="line">print(triangle)</span><br><span class="line"><span class="comment"># 这个方法就是先将一列计算出来，中间部分先用数字填充，最后再一个一个修改中间的数字。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法三变体</span></span><br><span class="line">triangle = []</span><br><span class="line">n = <span class="number">6</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">    row = [<span class="number">1</span>] * (i+<span class="number">1</span>)       </span><br><span class="line"><span class="comment"># 一次性开辟</span></span><br><span class="line">    triangle.append(row)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,i//<span class="number">2</span>+<span class="number">1</span>):       </span><br><span class="line"><span class="comment"># i=2第三行才能进来</span></span><br><span class="line">        val = triangle[i<span class="number">-1</span>][j<span class="number">-1</span>] + triangle[i<span class="number">-1</span>][j]</span><br><span class="line">        row[j] = val</span><br><span class="line">        <span class="keyword">if</span> i != <span class="number">2</span>*j:        </span><br><span class="line"><span class="comment"># 奇数个数的中间点数字跳过，也就是只有计算偶数行时才会进入这里，因为计算奇数行时，i一定是一个偶数</span></span><br><span class="line">            row[-j<span class="number">-1</span>] = val</span><br><span class="line">print(triangle)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/19/varnish概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/19/varnish概念/" itemprop="url">
                  varnish概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-19 14:03:23" itemprop="dateCreated datePublished" datetime="2019-06-19T14:03:23+08:00">2019-06-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-20 10:16:23" itemprop="dateModified" datetime="2019-06-20T10:16:23+08:00">2019-06-20</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/缓存服务/" itemprop="url" rel="index"><span itemprop="name">缓存服务</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ol>
<li><p>varnish的基本介绍</p>
<p>​        Varnish与一般服务器软件类似，就是一个web缓存代理服务器，分为master(management)进程和child(worker，主要做cache的工作)进程。master进程读入命令，进行一些初始化，然后fork(分流)并监控child进程。child进程分配若干线程进行工作，主要包括一些管理线程和很多woker线程。</p>
<p>​        Management进程主要实现应用新的配置、编译VCL、监控varnish、初始化varnish以及提供一个命令行接口等。 Management进程会每隔几秒钟探测一下Child进程以判断其是否正常运行，如果在指定的时长内未得到Child进程的回应，Management将会重启此Child进程。</p>
<p>Child进程包含多种类型的线程，常见的如：</p>
<p>​       Acceptor线程：接收新的连接请求并响应；</p>
<p>​       Worker线程：child进程会为每个会话启动一个worker线程，因此，在高并发的场景中可能会出现数百个worker线程甚至更多；</p>
<p>​       Expiry线程：从缓存中清理过期内容；</p>
<p>​        Varnish依赖“工作区(workspace)”以降低线程在申请或修改内存时出现竞争的可能性。在varnish内部有多种不同的工作区，其中最关键的当属用于管理会话数据的session工作区。</p>
</li>
<li><p>varnish与squid的区别</p>
<p>​        varnish和squid在中小规模的应用上，varnish足够轻量级，足够好用，但是在巨大的并发请求来说，单个varnish所能够承载的并发 访问量大概在5000个连接请求左右，超出5000个可能就得不稳定了；而在这里squid就能表现出良好的性能了，因此在大规模的企业级应用中仍然是以squid居多，而在中小规模的自己公司的反向代理缓存中varnish居多；</p>
</li>
</ol>
<p>   Varnish的优势</p>
<ul>
<li>Varnish的稳定性很高，两者在完成相同负荷的工作时，Squid服务器发生故障的几率要高于Varnish，因为使用Squid要经常重启；</li>
<li>Varnish访问速度更快，因为采用了“Visual Page Cache”技术，所有缓存数据都直接从内存读取，而squid是从硬盘读取，因而Varnish在访问速度方面会更快；</li>
<li>Varnish可以支持更多的并发连接，因为Varnish的TCP连接释放要比Squid快，因而在高并发连接情况下可以支持更多TCP连接；</li>
<li>Varnish可以通过管理端口，使用正则表达式批量的清除部分缓存，而Squid是做不到的；</li>
<li>squid属于是单进程使用单核CPU，但Varnish是通过fork形式打开多进程来做处理，所以可以合理的使用所有核来处理相应的请求；</li>
</ul>
<p>   Varnish的劣势</p>
<ul>
<li>varnish进程一旦Hang、Crash或者重启，缓存数据都会从内存中完全释放，此时所有请求都会发送到后端服务器，在高并发情况下，会给后端服务器造成很大压力；</li>
<li>在varnish使用中如果单个url的请求通过HA/F5等负载均衡，则每次请求落在不同的varnish服务器中，造成请求都会被穿透到后端；而且同样的请求在多台服务器上缓存，也会造成varnish的缓存的资源浪费，造成性能下降；</li>
</ul>
<p>   Varnish劣势的解决方案</p>
<ul>
<li>针 对劣势一：在访问量很大的情况下推荐使用varnish的内存缓存方式启动，而且后面需要跟多台squid服务器。主要为了防止前面的varnish服 务、服务器被重启的情况下，大量请求穿透varnish，这样squid可以就担当第二层CACHE，而且也弥补了varnish缓存在内存中重启都会释 放的问题；</li>
<li>针对劣势二：可以在负载均衡上做url哈希，让单个url请求固定请求到一台varnish服务器上;</li>
</ul>
<ol start="3">
<li><p>varnish的日志说明</p>
<p>​        为了与系统的其它部分进行交互，Child进程使用了可以通过文件系统接口进行访问的共享内存日志(shared memory log)，因此，如果某线程需要记录信息，其仅需要持有一个锁，而后向共享内存中的某内存区域写入数据，再释放持有的锁即可。而为了减少竞争，每个 worker线程都使用了日志数据缓存。</p>
<p>​        共享内存日志大小一般为90M，其分为两部分，前一部分为计数器，后半部分为客户端请求的数据。varnish提供了多个不同的工具如 varnishlog、varnishncsa或varnishstat等来分析共享内存日志中的信息并能够以指定的方式进行显示。</p>
</li>
<li><p>VCL基本介绍</p>
<p>​        Varnish Configuration Language (VCL)是varnish配置缓存策略的工具，它是一种基于“域”(domain specific)的简单编程语言，它支持有限的算术运算和逻辑运算操作、允许使用正则表达式进行字符串匹配、允许用户使用set自定义变量、支持if判断语句，也有内置的函数和变量等。使用VCL编写的缓存策略通常保存至.vcl文件中，其需要编译成二进制的格式后才能由varnish调用。事实上，整个缓存策略就是由几个特定的子例程如vcl_recv、vcl_fetch等组成，它们分别在不同的位置(或时间)执行，如果没有事先为某个位置自定义子例程，varnish将会执行默认的定义。</p>
<p>​        VCL策略在启用前，会由management进程将其转换为C代码，而后再由gcc编译器将C代码编译成二进制程序。编译完成后，management负责将其连接至varnish实例，即child进程。正是由于编译工作在child进程之外完成，它避免了装载错误格式VCL 的风险。因此，varnish修改配置的开销非常小，其可以同时保有几份尚在引用的旧版本配置，也能够让新的配置即刻生效。编译后的旧版本配置通常在 varnish重启时才会被丢弃，如果需要手动清理，则可以使用varnishadm的vcl.discard命令完成。</p>
</li>
<li><p>varnish的后端存储</p>
<p>​        varnish的缓存对象在每次服务重启时都会被清空并重新建立，所以这些服务器都是不应该随便去重启的，varnish为了把数据更持久化的存储，引入了更多的存储机制，所以varnish支持多种不同的后端存储；</p>
<p>​        varnish支持多种不同类型的后端存储，这可以在varnishd启动时使用-s选项指定。后端存储的类型包括：</p>
<ul>
<li><p>file：使用特定的文件存储全部的缓存数据，并通过操作系统的mmap()系统调用将整个缓存文件映射至内存区域(如果条件允许)；</p>
</li>
<li><p>malloc：使用malloc()库调用在varnish启动时向操作系统申请指定大小的内存空间以存储缓存对象；</p>
</li>
<li><p>persistent(experimental)：与file的功能相同，但可以持久存储数据(即重启varnish数据时不会被清除)；仍处于测试期；</p>
</li>
</ul>
<p>​        varnish无法追踪某缓存对象是否存入了缓存文件，从而也就无从得知磁盘上的缓存文件是否可用，因此，file存储方法在varnish停止或重启时会清除数据。而persistent方法的出现对此有了一个弥补，但persistent仍处于测试阶段，例如目前尚无法有效处理要缓存对象总体大小超出缓存空间的情况，所以，其仅适用于有着巨大缓存空间的场景。</p>
<p>​        选择使用合适的存储方式有助于提升系统性，从经验的角度来看，建议在内存空间足以存储所有的缓存对象时使用malloc的方法，反之，file存储将有着更好的性能的表现。然而，需要注意的是，varnishd实际上使用的空间比使用-s选项指定的缓存空间更大，一般说来，其需要为每个缓存对象多使用差不多1K左右的存储空间，这意味着，对于100万个缓存对象的场景来说，其使用的缓存空间将超出指定大小1G左右。另外，为了保存数据结构等，varnish自身也会占去不小的内存空间。</p>
</li>
<li><p>涉及VCL语法的改变点</p>
<ul>
<li>vcl配置文件需明确指定版本：即在vcl文件的第一行写上 vcl 4.0;</li>
<li>vcl_fetch函数被vcl_backend_response代替，且req.*不再适用vcl_backend_response；</li>
<li>后端源服务器组director成为varnish模块，需import directors后再在vcl_init子例程中定义；</li>
<li>自定义的子例程(即一个sub)不能以vcl_开头，调用使用call sub_name；</li>
<li>error()函数被synth()替代；</li>
<li>return(lookup)被return(hash)替代；</li>
<li>使用beresp.uncacheable创建hit_for_pss对象；</li>
<li>变量req.backend.healty被std.healthy(req.backend)替代；</li>
<li>变量req.backend被req.backend_hint替代；</li>
<li>关键字remove被unset替代；</li>
</ul>
<p>详见：<a href="https://www.varnish-cache.org/docs/4.0/whats-new/index.html#whats-new-index" target="_blank" rel="noopener">https://www.varnish-cache.org/docs/4.0/whats-new/index.html#whats-new-index</a></p>
</li>
<li><p>架构及文件缓存的工作流程</p>
<p><img src="/images/varnish/varnish文件缓存.png" alt=""></p>
<ul>
<li>Varnish 分为 master 进程和 child 进程；</li>
<li>Master 进程读入存储配置文件，调用合适的存储类型，然后创建 / 读入相应大小的缓存文件，接着 master 初始化管理该存储空间的结构体，然后 fork 并监控 child 进程；</li>
<li>Child 进程在主线程的初始化的过程中，将前面打开的存储文件整个 mmap 到内存中，此时创建并初始化空闲结构体，挂到存储管理结构体，以待分配；</li>
<li>对外管理接口分为3种，分别是命令行接口、Telnet接口和Web接口；</li>
<li>同时在运行过程中修改的配置，可以由VCL编译器编译成C语言，并组织成共享对象(Shared Object)交由Child进程加载使用；</li>
</ul>
<p><img src="/images/varnish/varnish文件缓存2.png" alt=""></p>
<p>Child 进程分配若干线程进行工作，主要包括一些管理线程和很多 worker 线程，可分为：</p>
<ul>
<li>Accept线程：接受请求，将请求挂在overflow队列上；</li>
<li>Work线程：有多个，负责从overflow队列上摘除请求，对请求进行处理，直到完成，然后处理下一个请求；</li>
<li>Epoll线程：一个请求处理称为一个session，在session周期内，处理完请求后，会交给Epoll处理，监听是否还有事件发生；</li>
<li>Expire线程：对于缓存的object，根据过期时间，组织成二叉堆，该线程周期检查该堆的根，处理过期的文件，对过期的数据进行删除或重取操作；</li>
</ul>
</li>
<li><p>varnish的工作原理及工作流程</p>
<p>官方提供的工作流程图:</p>
<p><img src="/images/varnish/varnish架构.jpg" alt=""></p>
<p>vcl的工作方式是基于状态引擎(state engine)来实现的；上图说明：</p>
<p>​        vcl_recv的结果如果可以查询缓存并可以识别，那就要到vcl_hash这步了，如果无法识别那就通过pipe(管道)送给vcl_pipe，如果能识别，但不是一个可缓存的对象，那就通过pass送到vcl_pass去。vcl_hash之后就可查看缓存中有没有了，有这个请求的对象就表示命中 (vcl_hit)，如果没有那就表示未命中(vcl_miss)，如果命中的就可以直接通过deliver直接送给vcl_deliver响应了，如果未命中就通过fetch交给vcl_fatch去后端服务器上去取数据，取回数据之后如果数据可以缓存就缓存(cache)，本地缓存完之后再构建响应，如果不可以缓存就不做缓存交给vcl_deliver响应了；而如果命中了交给vcl_pass，交给pass之后就要到Fetch objet from backend后端服务器上去取数据了，这是因为这个命中的对象可能是过期或者是要做单独额外的处理的；这就是vcl的状态引擎过程。</p>
</li>
<li><p>Varnish 处理 HTTP 请求的过程如下</p>
<ol>
<li>Receive 状态（vcl_recv）：也就是请求处理的入口状态，根据 VCL 规则判断该请求应该 pass（vcl_pass）或是 pipe（vcl_pipe），还是进入 lookup（本地查询）；</li>
<li>Lookup 状态：进入该状态后，会在 hash 表中查找数据，若找到，则进入 hit（vcl_hit）状态，否则进入 miss（vcl_miss）状态；</li>
<li>Pass（vcl_pass）状态：在此状态下，会直接进入后端请求，即进入 fetch（vcl_fetch）状态；</li>
<li>Fetch（vcl_fetch）状态：在 fetch 状态下，对请求进行后端获取，发送请求，获得数据，并根据设置进行本地存储；</li>
<li>Deliver（vcl_deliver）状态：将获取到的数据发给客户端，然后完成本次请求；</li>
</ol>
<p>注：Varnish4中在vcl_fetch部分略有出入，已独立为vcl_backend_fetch和vcl_backend_response2个函数；</p>
</li>
<li><p>内置函数(也叫子例程)</p>
<ul>
<li>vcl_recv：用于接收和处理请求；当请求到达并成功接收后被调用，通过判断请求的数据来决定如何处理请求；</li>
<li>vcl_pipe：此函数在进入pipe模式时被调用，用于将请求直接传递至后端主机，并将后端响应原样返回客户端；</li>
<li>vcl_pass：此函数在进入pass模式时被调用，用于将请求直接传递至后端主机，但后端主机的响应并不缓存直接返回客户端；</li>
<li>vcl_hit：在执行 lookup 指令后，在缓存中找到请求的内容后将自动调用该函数；</li>
<li>vcl_miss：在执行 lookup 指令后，在缓存中没有找到请求的内容时自动调用该方法，此函数可用于判断是否需要从后端服务器获取内容；</li>
<li>vcl_hash：在vcl_recv调用后为请求创建一个hash值时，调用此函数；此hash值将作为varnish中搜索缓存对象的key；</li>
<li>vcl_purge：pruge操作执行后调用此函数，可用于构建一个响应；</li>
<li>vcl_deliver：将在缓存中找到请求的内容发送给客户端前调用此方法；</li>
<li>vcl_backend_fetch：向后端主机发送请求前，调用此函数，可修改发往后端的请求；</li>
<li>vcl_backend_response：获得后端主机的响应后，可调用此函数；</li>
<li>vcl_backend_error：当从后端主机获取源文件失败时，调用此函数；</li>
<li>vcl_init：VCL加载时调用此函数，经常用于初始化varnish模块(VMODs)</li>
<li>vcl_fini：当所有请求都离开当前VCL，且当前VCL被弃用时，调用此函数，经常用于清理varnish模块；</li>
</ul>
</li>
<li><p>VCL中内置公共变量</p>
<p>变量(也叫object)适用范围</p>
<p><img src="/images/varnish/varnish内置公共变量.jpg" alt=""></p>
</li>
<li><p>变量类型详解</p>
<p><img src="/images/varnish/varnish变量类型详解.jpg" alt=""></p>
<ul>
<li>req：The request object，请求到达时可用的变量</li>
<li>bereq：The backend request object，向后端主机请求时可用的变量</li>
<li>beresp：The backend response object，从后端主机获取内容时可用的变量</li>
<li>resp：The HTTP response object，对客户端响应时可用的变量</li>
<li>obj：存储在内存中时对象属性相关的可用的变量</li>
</ul>
<p>具体变量详见：<a href="https://www.varnish-cache.org/docs/4.0/reference/vcl.html#reference-vcl" target="_blank" rel="noopener">https://www.varnish-cache.org/docs/4.0/reference/vcl.html#reference-vcl</a></p>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/11/mysql问题解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/11/mysql问题解决/" itemprop="url">
                  mysql问题解决
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-11 16:59:50 / 修改時間：17:08:18" itemprop="dateCreated datePublished" datetime="2019-06-11T16:59:50+08:00">2019-06-11</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="登录数据库后无法对数据库操作"><a href="#登录数据库后无法对数据库操作" class="headerlink" title="登录数据库后无法对数据库操作"></a>登录数据库后无法对数据库操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 登录数据库后无法对数据库操作，使用任何命令都会提示“You must reset your password using ALTER USER statement before executing this statement.”</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 有一说是因为密码过期，所以会这样。解决方法如下：</span></span><br><span class="line">vim /usr/lib/systemd/system/mysqld.service </span><br><span class="line">ExecStart=/usr/sbin/mysqld --daemonize --skip-grant-tables --skip-networking --pid-file=/var/run/mysqld/mysqld.pid $MYSQLD_OPTS</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入--skip-grant-tables --skip-networking，可以免密码登录</span></span><br><span class="line">mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 登录</span></span><br><span class="line">use mysql；</span><br><span class="line">desc user；</span><br><span class="line">authentication_string  | text                              | YES  |     | NULL                  |       |</span><br><span class="line">| password_expired       | enum('N','Y')                     | NO   |     | N </span><br><span class="line"><span class="meta">#</span><span class="bash"> 说是从上面两条信息可以看出password_expired过期。</span></span><br><span class="line">UPDATE user SET authentication_string=PASSWORD('DaaS_mysql_201!'),password_expired='N' WHERE User='root'; </span><br><span class="line">select authentication_string,password_expired from user where user='root';</span><br><span class="line">+-------------------------------------------+------------------+</span><br><span class="line">| authentication_string                     | password_expired |</span><br><span class="line">+-------------------------------------------+------------------+</span><br><span class="line">| *5ECB9CC025100F03131724B02A092F02D9417C96 | N                |</span><br><span class="line">+-------------------------------------------+------------------+</span><br><span class="line">desc user;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此命令又看了一次，与上面查询的没有区别。所以不知道如何证明是过期了？</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 之后将上面的免密码登录恢复回去。再操作就正常了。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/30/解决服务器千兆网卡显示只有百兆速度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/30/解决服务器千兆网卡显示只有百兆速度/" itemprop="url">
                  解决服务器千兆网卡显示只有百兆速度
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-05-30 16:02:47" itemprop="dateCreated datePublished" datetime="2019-05-30T16:02:47+08:00">2019-05-30</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-11 11:33:01" itemprop="dateModified" datetime="2019-06-11T11:33:01+08:00">2019-06-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">ethtool eno1</span><br><span class="line">Settings for eno1:</span><br><span class="line">        Supported ports: [ TP ]</span><br><span class="line">        Supported link modes:   10baseT/Half 10baseT/Full </span><br><span class="line">                                100baseT/Half 100baseT/Full </span><br><span class="line">                                1000baseT/Full </span><br><span class="line">        Supported pause frame use: Symmetric</span><br><span class="line">        Supports auto-negotiation: Yes</span><br><span class="line">        Advertised link modes:  10baseT/Half 10baseT/Full </span><br><span class="line">                                100baseT/Half 100baseT/Full </span><br><span class="line">                                1000baseT/Full </span><br><span class="line">        Advertised pause frame use: Symmetric</span><br><span class="line">        Advertised auto-negotiation: Yes</span><br><span class="line">        Speed: 100Mb/s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用命令查看时，虽然显示是千兆网卡，但Speed只有100Mb/s</span></span><br><span class="line">ethtool -s eno1 speed 1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用上面命令可能将网卡重新设置为1000Mb/s</span></span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-eno1</span><br><span class="line">ETHTOOL_OPTS="speed 1000 duplex full autoneg off"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在网卡配置中加入上面一行，可以强制将网卡设置为千兆。</span></span><br><span class="line"></span><br><span class="line">==============================================================================================</span><br><span class="line">ethtool命令的简单使用</span><br><span class="line">ethtool ethX</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看网卡信息</span></span><br><span class="line">ethtool –h		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示ethtool的命令帮助(<span class="built_in">help</span>)</span></span><br><span class="line">ethtool –i ethX </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询ethX网口的相关信息</span></span><br><span class="line">ethtool –d ethX </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询ethX网口注册性信息</span></span><br><span class="line">ethtool –r ethX </span><br><span class="line"><span class="meta">#</span><span class="bash"> 重置ethX网口到自适应模式</span></span><br><span class="line">ethtool –S ethX </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询ethX网口收发包统计</span></span><br><span class="line">ethtool –s ethX [speed 10|100|1000] [duplex half|full] [autoneg on|off] [port tp|aui|bnc|mii] </span><br><span class="line"><span class="meta">#</span><span class="bash"> [speed 10|100|1000]     设置网口速率10/100/1000M</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [duplex half|full]     设置网口半/全双工</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [autoneg on|off]     设置网口是否自协商</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [port tp|aui|bnc|mii]      设置网口类型</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/29/Tilix连接远程主机/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/29/Tilix连接远程主机/" itemprop="url">
                  Tilix连接远程主机
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-05-29 17:19:42" itemprop="dateCreated datePublished" datetime="2019-05-29T17:19:42+08:00">2019-05-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-09-30 11:43:10" itemprop="dateModified" datetime="2019-09-30T11:43:10+08:00">2019-09-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>打开首选项–&gt;书签–&gt;添加书签</li>
</ol>
<p><img src="/images/tilix/tillix添加书签.png" alt=""></p>
<ol start="2">
<li>输入信息</li>
</ol>
<p><img src="/images/tilix/tillix添加书签2.png" alt=""></p>
<ol start="3">
<li>连接测试</li>
</ol>
<p><img src="/images/tilix/tillix连接1.png" alt=""></p>
<p><img src="/images/tilix/tillix连接2.png" alt=""></p>
<p><img src="/images/tilix/tillix连接3.png" alt=""></p>
<ol start="4">
<li>创建密码，在确定添加时可能会要求输入密码，不然无法添加</li>
</ol>
<p><img src="/images/tilix/tillix创建密码1.png" alt=""></p>
<p><img src="/images/tilix/tillix创建密码2.png" alt=""></p>
<p><img src="/images/tilix/tillix创建密码3.png" alt=""></p>
<p><img src="/images/tilix/tillix创建密码4.png" alt=""></p>
<ol start="5">
<li>连接时，选择书签中创建的远程服务器成功后，可以再从助手中选择创建的密码，这样就可以连接上远程服务器了。如果之前就将本机的公钥发送到了远程的主机，就不需要再选择密码了，选择远程主机时就可以连接上了。</li>
<li>如果创建的远程连接信息有误，可以到Profiles -&gt; Edit Profile -&gt; Bookmarks中修改或删除</li>
<li>如果连接时需要密钥对，需要在输入完Name、Host、User后，在Parameters中输入-i “awsTest.pem”。这样就可以登录了。另外，如登录aws时，官方还会提供登录的方法。如登录时Redhat系统要使用ec2-user用户，ubuntu系统使用ubuntu，看一下官方的提示信息。进入系统后可以使用sudo passwd修改root密码。如果连接时的密钥没有了，可以在aws页面中的密钥对页面里重新创建。下图为官方提供的方法与tilix的配置方法</li>
</ol>
<p><img src="/images/tilix/aws登录方法0" alt=""></p>
<p><img src="/images/tilix/aws登录方法1" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">211</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">157</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
