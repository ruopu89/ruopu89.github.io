<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/7/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/09/python基础学习-序列化和反序列化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/09/python基础学习-序列化和反序列化/" itemprop="url">
                  python基础学习-序列化和反序列化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-09 16:50:48" itemprop="dateCreated datePublished" datetime="2020-01-09T16:50:48+08:00">2020-01-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="为什么要序列化"><a href="#为什么要序列化" class="headerlink" title="为什么要序列化"></a>为什么要序列化</h3><p>内存中的字典、列表、集合以及各种对象，如何保存到一个文件中？</p>
<p>如果是自己定义的类的实例，如何保存到一个文件中？</p>
<p>如何从文件中读取数据，并让它们在内存中再次变成自己对应的类的实例？</p>
<p>要设计一套协议，按照某种规则，把内存中数据保存到文件中。文件是一个字节序列，所以必须把数据转换成字节序列，输出到文件。这就是序列化。反之，从文件的字节序列恢复到内存，就是反序列化。</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>serialization 序列化</p>
<p>将内存中对象存储下来，把它变成一个个字节。 -&gt; 二进制</p>
<p>deserialization 反序列化</p>
<p>将文件的一个个字节恢复成内存中对象。 &lt;- 二进制</p>
<p>序列化保存到文件就是持久化。</p>
<p>可以将数据序列化后持久化，或者网络传输；也可以将从文件中或者网络接收到的字节序列反序列化。</p>
<p>Python提供了pickle库</p>
<h3 id="pickle库"><a href="#pickle库" class="headerlink" title="pickle库"></a>pickle库</h3><p>Python中的序列化、反序列化模块。</p>
<p>dumps 对象序列化为bytes对象</p>
<p>dump 对象序列化到文件对象，就是存入文件</p>
<p>loads 从bytes对象反序列化</p>
<p>load 对象反序列化，从文件读取数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件序列化和反序列化</span></span><br><span class="line">filename = <span class="string">'o:/set'</span></span><br><span class="line"></span><br><span class="line">d = &#123;<span class="string">'a'</span>:<span class="number">1</span>,<span class="string">'b'</span>:<span class="string">'abc'</span>,<span class="string">'c'</span>:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]&#125;</span><br><span class="line">l = list(<span class="string">'123'</span>)</span><br><span class="line">i = <span class="number">99</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(filename,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(d,f)   <span class="comment"># 格式是把哪些内容写入哪个文件</span></span><br><span class="line">    pickle.dump(l,f)</span><br><span class="line">    pickle.dump(i,f)  <span class="comment"># 这是追加写入的？</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> open(filename,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    print(f.read(),f.seek(<span class="number">0</span>))  <span class="comment"># 读取所有内容，并将指针调整到最开始的位置</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        x = pickle.load(f)   <span class="comment"># 反序列化f中的内容并打印出来</span></span><br><span class="line">        print(type(x),x)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="comment"># 对象序列化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span>:</span></span><br><span class="line">    tttt = <span class="string">'ABC'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'abc'</span>)</span><br><span class="line">        </span><br><span class="line">a1 = AA()</span><br><span class="line"></span><br><span class="line">sr = pickle.dumps(a1)</span><br><span class="line">print(<span class="string">'sr=&#123;&#125;'</span>.format(sr))   <span class="comment"># AA</span></span><br><span class="line"></span><br><span class="line">a2 = pickle.loads(sr)</span><br><span class="line">print(a2.tttt)</span><br><span class="line">a2.show()</span><br></pre></td></tr></table></figure>
<p>上面的例子中，其实就保存了一个类名，因为所有的其他东西都是类定义的东西，是不变的，所以只序列化一个AA类名。反序列化的时候找到类就可以恢复一个对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AAA</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.tttt = <span class="string">'abc'</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 创建AA类的实例</span></span><br><span class="line">a1 = AAA()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化</span></span><br><span class="line">ser = pickle.dumps(a1)</span><br><span class="line">print(<span class="string">'ser=&#123;&#125;'</span>.format(ser))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反序列化</span></span><br><span class="line">a2 = pickle.loads(ser)</span><br><span class="line">print(a2,type(a2))</span><br><span class="line">print(a2.tttt)</span><br><span class="line">print(id(a1),id(a2))</span><br></pre></td></tr></table></figure>
<p>可以看出这回除了必须保存的AAA，还序列化了tttt和abc，因为这是每一个对象自己的属性，每一个对象不一样的，所以这些数据需要序列化。</p>
<h3 id="序列化、反序列化实验"><a href="#序列化、反序列化实验" class="headerlink" title="序列化、反序列化实验"></a>序列化、反序列化实验</h3><p>定义类AAA，并序列化到文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="comment"># 实验</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AAA</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.tttt = <span class="string">'abc'</span></span><br><span class="line">        </span><br><span class="line">aaa = AAA()</span><br><span class="line">sr = pickle.dumps(aaa)</span><br><span class="line">print(len(sr))</span><br><span class="line"></span><br><span class="line">file = <span class="string">'o:/ser'</span></span><br><span class="line"><span class="keyword">with</span> open(file,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(aaa,f)</span><br></pre></td></tr></table></figure>
<p>将产生的序列化文件发送到其他节点上。增加一个x.py文件，内容如下。最后执行这个脚本 <code>python x.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'ser'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    a = pickle.load(f)   <span class="comment"># 异常</span></span><br></pre></td></tr></table></figure>
<p>会抛出异常 <code>AttributeError: Can&#39;t get attribute &#39;AAA&#39; on &lt;module &#39;__main__&#39; from &#39;t.py&#39;&gt;</code>。</p>
<p>这个异常实际上是找不到类AAA的定义，增加类定义即可解决。</p>
<p>反序列化的时候要找到AAA类的定义，才能成功。否则就会抛出异常。</p>
<p>可以这样理解：反序列化的时候，类是模子，二进制序列就是铁水。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AAA</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'xyz'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'ser'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    a = pickle.load(f)</span><br><span class="line">    print(a)</span><br><span class="line">    a.show()</span><br></pre></td></tr></table></figure>
<p>这里定义了类AAA，并且上面的代码也能成功的执行。</p>
<p>注意：这里的AAA定义和原来完全不同了。</p>
<p>因此，序列化、反序列化必须保证使用同一套类的定义，否则会带来不可预料的结果。</p>
<h3 id="序列化应用"><a href="#序列化应用" class="headerlink" title="序列化应用"></a>序列化应用</h3><p>一般来说，本地序列化的情况，应用较少。大多数场景都应用在网络传输中。将数据序列化后通过网络传输到远程节点，远程服务器上的服务将接收到的数据反序列化后，就可以使用了。但是，要注意一点，远程接收端，反序列化时必须有对应的数据类型，否则就会报错。尤其是自定义类，必须远程得有一致的定义。现在，大多数项目，都不是单机的，也不是单服务的。需要通过网络将数据传送到其他节点上去，这就需要大量的序列化、反序列化过程。但是，问题是，Python程序之间还可以都使用pickle解决序列化、反序列化，如果是跨平台、跨语言、跨协议，pickle就不太适合了，就需要公共的协议。例如XML、Json、Protocol Buffer等。不同的协议，效率不同、学习曲线不同，适用不同场景，要根据不同的情况分析选型。</p>
<h3 id="Json"><a href="#Json" class="headerlink" title="Json"></a>Json</h3><p>JSON(JavaScript Object Notation，JS对象标记)是一种轻量级的数据交换格式。它基于ECMAScript（w3c制定的JS规范）的一个子集，采用完全独立于编程语言的文本格式来存储和表示数据。</p>
<p><a href="http://json.org" target="_blank" rel="noopener">http://json.org</a></p>
<h3 id="Json的数据类型"><a href="#Json的数据类型" class="headerlink" title="Json的数据类型"></a>Json的数据类型</h3><ul>
<li>值</li>
</ul>
<p><strong><em>双引号</em></strong>引起来的字符串，数值，true和false，null，对象，数组，这些都是值</p>
<p><img src="/images/python序列化与反序列化/json1.png" alt=""></p>
<ul>
<li>字符串</li>
</ul>
<p>由双引号包围起来的任意字符的组合，可以有转义字符。</p>
<ul>
<li>数值</li>
</ul>
<p>有正负，有整数、浮点数。</p>
<ul>
<li>对象</li>
</ul>
<p>无序的键值对的集合</p>
<p>格式：<code>{key1:value1,...,keyn:valuen}</code></p>
<p>key必须是一个字符串，需要双引号包围这个字符串。</p>
<p>value可以是任意合法的值</p>
<p><img src="/images/python序列化与反序列化/json2.png" alt=""></p>
<ul>
<li>数组</li>
</ul>
<p>有序的值的集合</p>
<p>格式：<code>[val1,...,valn]</code></p>
<p><img src="/images/python序列化与反序列化/json3.png" alt=""></p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"person"</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="string">"name"</span>:<span class="string">"tom"</span>,</span><br><span class="line">         <span class="string">"age"</span>:<span class="number">18</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="string">"name"</span>:<span class="string">"jerry"</span>,</span><br><span class="line">         <span class="string">"age"</span>:<span class="number">16</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"total"</span>:<span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Json模块"><a href="#Json模块" class="headerlink" title="Json模块"></a><strong><em>Json模块</em></strong></h3><h4 id="Python与Json"><a href="#Python与Json" class="headerlink" title="Python与Json"></a>Python与Json</h4><p>Python支持少量内建数据类型到Json类型的转换。</p>
<table>
<thead>
<tr>
<th>Python类型</th>
<th>Json类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>True</td>
<td>true</td>
</tr>
<tr>
<td>False</td>
<td>false</td>
</tr>
<tr>
<td>None</td>
<td>null</td>
</tr>
<tr>
<td>str</td>
<td>string</td>
</tr>
<tr>
<td>int</td>
<td>integer</td>
</tr>
<tr>
<td>float</td>
<td>float</td>
</tr>
<tr>
<td>list</td>
<td>array</td>
</tr>
<tr>
<td>dict</td>
<td>object</td>
</tr>
</tbody>
</table>
<h4 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h4><table>
<thead>
<tr>
<th>Python类型</th>
<th>Json类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>dumps</td>
<td>json编码</td>
</tr>
<tr>
<td>dump</td>
<td>json编码并存入文件</td>
</tr>
<tr>
<td>loads</td>
<td>json解码</td>
</tr>
<tr>
<td>load</td>
<td>json解码，从文件读取数据</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">d = &#123;<span class="string">'name'</span>:<span class="string">'Tom'</span>,<span class="string">'age'</span>:<span class="number">20</span>,<span class="string">'interest'</span>:[<span class="string">'music'</span>,<span class="string">'movie'</span>]&#125;</span><br><span class="line">j = json.dumps(d)</span><br><span class="line">print(j)   <span class="comment"># 请注意引号的变化</span></span><br><span class="line"></span><br><span class="line">d1 = json.loads(j)</span><br><span class="line">print(d1)</span><br></pre></td></tr></table></figure>
<p>一般json编码的数据很少落地，数据都是通过网络传输。传输的时候，要考虑压缩它。本质上来说它就是个文本，就是个字符串。json很简单，几乎语言编程都支持Json，所以应用范围十分广泛。</p>
<h3 id="MessagePack"><a href="#MessagePack" class="headerlink" title="MessagePack"></a>MessagePack</h3><p>MessagePack是一个基于二进制高效的对象序列化类库，可用于跨语言通信。它可以像JSON那样，在许多种语言之间交换结构对象。但是它比JSON更快速也更轻巧。支持Python、Ruby、Java、C/C++等众多语言。宣称比Google Protocol还要快4倍。兼容json和pickle。</p>
<p><img src="/images/python序列化与反序列化/messagepack1.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 72 bytes</span></span><br><span class="line">&#123;<span class="string">"person"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"tom"</span>,<span class="string">"age"</span>:<span class="number">18</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"jerry"</span>,<span class="string">"age"</span>:<span class="number">16</span>&#125;],<span class="string">"total"</span>:<span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 48 bytes</span></span><br><span class="line"><span class="comment"># 82 a6 70 65 72 73 6f 6e 92 82 a4 6e 61 6d 65 a3 74 6f 6d a3 61 67 65 12 82 a4 64</span></span><br><span class="line"><span class="number">61</span> <span class="number">6</span>d <span class="number">65</span> a5 <span class="number">6</span>a <span class="number">65</span> <span class="number">72</span> <span class="number">72</span> <span class="number">79</span> a3 <span class="number">61</span> <span class="number">67</span> <span class="number">65</span> <span class="number">10</span> a5 <span class="number">74</span> <span class="number">6</span>f <span class="number">74</span> <span class="number">61</span> <span class="number">6</span>c <span class="number">02</span></span><br></pre></td></tr></table></figure>
<p>可以看出，大大的节约了空间。</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><code>pip install msgpack-python</code></p>
<h4 id="常用方法-1"><a href="#常用方法-1" class="headerlink" title="常用方法"></a>常用方法</h4><p>packb序列化对象。提供了dumps来兼容pickle和json。</p>
<p>unpackb 反序列化对象。提供了loads来兼容。</p>
<p>pack 序列化对象保存到文件对象。提供了dump来兼容。</p>
<p>unpack 反序列化对象保存到文件对象。提供了load来兼容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> msgpack</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 源数据</span></span><br><span class="line">d = &#123;<span class="string">'person'</span>:[&#123;<span class="string">'name'</span>:<span class="string">'tom'</span>,<span class="string">'age'</span>:<span class="number">18</span>&#125;,&#123;<span class="string">'name'</span>:<span class="string">'jerry'</span>,<span class="string">'age'</span>:<span class="number">16</span>&#125;],<span class="string">'total'</span>:<span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line">j = json.dumps(d)</span><br><span class="line">m = msgpack.dumps(d)   <span class="comment"># 本质上就是packb</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"json = &#123;&#125;,msgpack = &#123;&#125;"</span>.format(len(j),len(m)))</span><br><span class="line">print(j.encode(),len(j.encode()))   <span class="comment"># json和msgpack的比较</span></span><br><span class="line">print(m,len(m))</span><br><span class="line"></span><br><span class="line">u = msgpack.unpackb(m)</span><br><span class="line">print(type(u),u)</span><br><span class="line"></span><br><span class="line">u = msgpack.unpackb(m, encoding=<span class="string">'utf8'</span>)</span><br><span class="line">print(type(u),u)</span><br></pre></td></tr></table></figure>
<p>MessagePack简单易用，高效压缩，支持语言丰富。</p>
<p>所以，用它序列化也是一种很好的选择。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/09/python基础学习-处理csv与ini文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/09/python基础学习-处理csv与ini文件/" itemprop="url">
                  python基础学习-处理csv与ini文件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-09 11:57:38" itemprop="dateCreated datePublished" datetime="2020-01-09T11:57:38+08:00">2020-01-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="CSV文件简介"><a href="#CSV文件简介" class="headerlink" title="CSV文件简介"></a>CSV文件简介</h3><p>参考RFC 4180</p>
<p><a href="http://www.ietf.org/rfc/rfc4180.txt" target="_blank" rel="noopener">http://www.ietf.org/rfc/rfc4180.txt</a></p>
<p>逗号分隔值 Comma-Separated Values。</p>
<p>CSV是一个被行分隔符、列分隔符划分成行和列的文本文件。</p>
<p>CSV不指定字符编码</p>
<p>行分隔符为\r\n，最后一行可以没有换行符</p>
<p>列分隔符常为逗号或者制表符</p>
<p>每一行称为一条记录record</p>
<p>字段可以使用双引号括起来，也可以不使用。如果字段中出现了双引号、逗号、换行符必须使用双引号括起来。如果字段的值是双引号，使用两个双引号表示一个转义。</p>
<p>表头可选，和字段列对齐就行了。</p>
<h3 id="手动生成CSV文件"><a href="#手动生成CSV文件" class="headerlink" title="手动生成CSV文件"></a>手动生成CSV文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">p = Path(<span class="string">'o:/tmp/mycsv/test.csv'</span>)</span><br><span class="line">parent = p.parent</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> parent.exists():</span><br><span class="line"><span class="comment"># exists()表示此路径是否指向一个已存在的文件或目录</span></span><br><span class="line">    parent.mkdir(parents=<span class="keyword">True</span>)</span><br><span class="line">    </span><br><span class="line">csv_body = <span class="string">'''\</span></span><br><span class="line"><span class="string">id,name,age,comment</span></span><br><span class="line"><span class="string">1,zs,18,"I'm 18"</span></span><br><span class="line"><span class="string">2,ls,20,"this is a ""test""string."</span></span><br><span class="line"><span class="string">3,ww,23,"你好</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">计算机</span></span><br><span class="line"><span class="string">"</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p.write_text(csv_body)</span><br></pre></td></tr></table></figure>
<h3 id="CSV模块"><a href="#CSV模块" class="headerlink" title="CSV模块"></a>CSV模块</h3><p><code>reader(csvfile,dialect=&#39;excel&#39;,**fmtparams)</code></p>
<p>返回DictReader对象，是一个行迭代器。</p>
<p>delimiter 列分隔符，逗号</p>
<p>lineterminator 行分隔符\r\n</p>
<p>quotechar 字段的引用符号，缺省为”，双引号</p>
<p>双引号的处理：</p>
<p>doublequote 双引号的处理，默认为True。如果和quotechar为同一个，True则使用2个双引号表示，False表示使用转义字符将作为双引号的前缀。</p>
<p>escapechar 一个转义字符，默认为None。</p>
<p>quoting 指定双引号的规则。QUOTE_ALL 所有字段；QUOTE_MINIMAL 特殊字符字段；QUOTE_NONNUMERIC 非数字字段；QUOTE_NONE都不使用引号。</p>
<p><code>writer(csvfile, dialect=&#39;excel&#39;, **fmtparams)</code></p>
<p>返回DictWriter的实例。对于 <code>Writer</code> 对象，<em>行</em> 必须是（一组可迭代的）字符串或数字。</p>
<p>主要方法有 writerow、writerows。</p>
<ul>
<li><p><code>csvwriter.writerow</code>(<em>row</em>)</p>
<p>将参数 <em>row</em> 写入 writer 的文件对象，并根据当前设置的变种进行格式化。本方法的返回值就是底层文件对象 <em>write</em> 方法的返回值。在 3.5 版更改: 开始支持任意类型的迭代器。</p>
</li>
<li><p><code>csvwriter.writerows</code>(<em>rows</em>)</p>
<p>将 <em>rows\</em>（即能迭代出多个上述 <em>row</em> 对象的迭代器）中的所有元素写入 writer 的文件对象，并根据当前设置的变种进行格式化。</p>
</li>
</ul>
<p>writerow(iterable)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line">p = Path(<span class="string">'o:/tmp/mycsv/test.csv'</span>)</span><br><span class="line"><span class="keyword">with</span> open(str(p)) <span class="keyword">as</span> f:</span><br><span class="line">    reader = csv.reader(f)</span><br><span class="line">    print(next(reader))</span><br><span class="line">    print(next(reader))</span><br><span class="line">    </span><br><span class="line">rows = [</span><br><span class="line">	[<span class="number">4</span>,<span class="string">'tom'</span>,<span class="number">22</span>,<span class="string">'tom'</span>],</span><br><span class="line">	(<span class="number">5</span>,<span class="string">'jerry'</span>,<span class="number">24</span>,<span class="string">'jerry'</span>),</span><br><span class="line">	(<span class="number">6</span>,<span class="string">'justin'</span>,<span class="number">22</span>,<span class="string">'just\t"in'</span>),</span><br><span class="line">	<span class="string">"abcdefghi"</span>,</span><br><span class="line">	((<span class="number">1</span>,),(<span class="number">2</span>,))</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 不要忘记每个元素后面的逗号</span></span><br><span class="line">row = rows[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">with</span> open(str(p),<span class="string">'a'</span>) <span class="keyword">as</span> f:   <span class="comment"># 向test.csv中追加内容</span></span><br><span class="line">    writer = csv.writer(f)</span><br><span class="line">    writer.writerow(row)  <span class="comment"># 写入一行</span></span><br><span class="line">    writer.writerows(rows)  <span class="comment"># 写入多行</span></span><br></pre></td></tr></table></figure>
<h3 id="ini文件处理"><a href="#ini文件处理" class="headerlink" title="ini文件处理"></a>ini文件处理</h3><p>作为配置文件，ini文件格式很流行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">a = test</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /dbserver/data</span><br><span class="line">port = <span class="number">33060</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line">sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span><br></pre></td></tr></table></figure>
<p>中括号里面的部分称为section，译作节、区、段。</p>
<p>每一个section内，都是key=value形成的键值对，key称为option选项。</p>
<p>注意，这里的DEFAULT是缺省section的名字，必须大写。</p>
<h3 id="configparser"><a href="#configparser" class="headerlink" title="configparser"></a>configparser</h3><p>configparser模块的ConfigParser类就是用来操作的。</p>
<p>可以将section当做key，section存储着键值对组成的字典，可以把ini配置文件当做一个嵌套的字典。默认使用的是有序字典。</p>
<p><code>read(filenames, encoding=None)</code></p>
<p>读取ini文件，可以是单个文件，也可以是文件列表。可以指定文件编码。</p>
<p><code>sections()</code> 返回section列表。缺省section不包括在内。</p>
<p><code>add_section(section_name)</code>增加一个section</p>
<p><code>has_section(section_name)</code> 判断section是否存在</p>
<p><code>options(section)</code> 返回section的所有option，会追加缺省section的option</p>
<p><code>has_option(section, option)</code> 判断section是否存在这个option</p>
<p><code>get(section, option, *, raw=False, vars=None[, fallback])</code> 从指定的段的选项上取值，如果找到返回，如果没有找到就去找DEFAULT段有没有。</p>
<p><code>getint(section, option, *, raw=False, vars=None[, fallback])</code></p>
<p><code>getfloat(section, option, *, raw=False, vars=None[, fallback])</code></p>
<p><code>getboolean(section, option, *, raw=False, vars=None[, fallback])</code></p>
<p>上面三个方法和get一样，返回指定类型数据。</p>
<p><code>items(raw=False, vars=None)</code></p>
<p><code>items(section, raw=False, vars=None)</code></p>
<p>没有section，则返回所有section名字及其对象；如果指定section，则返回这个指定的section的键值对组成二元组。</p>
<p><code>set(section, option, value)</code>  section存在的情况下，写入option=value，要求option、value必须是字符串。</p>
<p><code>remove_section(section)</code> 移除section及其所有option</p>
<p><code>remove_option(section, option)</code>  移除section下的option。</p>
<p><code>write(fileobject, space_around_delimiters=True)</code> 将当前config的所有内容写入fileobject中，一般open函数使用w模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> configparser <span class="keyword">import</span> ConfigParser</span><br><span class="line"></span><br><span class="line">filename = <span class="string">'test.ini'</span></span><br><span class="line">newfilename = <span class="string">'mysql.ini'</span></span><br><span class="line"></span><br><span class="line">cfg = ConfigParser()</span><br><span class="line">cfg.read(filename)</span><br><span class="line">print(cfg.sections())</span><br><span class="line">print(cfg.has_section(<span class="string">'client'</span>))</span><br><span class="line"></span><br><span class="line">print(cfg.items(<span class="string">'mysqld'</span>))</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> cfg.items():</span><br><span class="line">    print(k,type(v))</span><br><span class="line">    print(k,cfg.items(k))</span><br><span class="line">tmp = cfg.get(<span class="string">'mysqld'</span>,<span class="string">'port'</span>)</span><br><span class="line">print(type(tmp),tmp)</span><br><span class="line">print(cfg.get(<span class="string">'mysqld'</span>,<span class="string">'a'</span>))</span><br><span class="line"><span class="comment"># print(cfg.get('mysqld','magedu'))</span></span><br><span class="line">print(cfg.get(<span class="string">'mysqld'</span>,<span class="string">'magedu'</span>,fallback=<span class="string">'python'</span>))</span><br><span class="line"></span><br><span class="line">tmp = cfg.getint(<span class="string">'mysqld'</span>,<span class="string">'port'</span>)</span><br><span class="line">print(type(tmp),tmp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cfg.has_section(<span class="string">'test'</span>):</span><br><span class="line">    cfg.remove_section(<span class="string">'test'</span>)</span><br><span class="line">    </span><br><span class="line">cfg.add_section(<span class="string">'test'</span>)</span><br><span class="line">cfg.set(<span class="string">'test'</span>,<span class="string">'test1'</span>,<span class="string">'1'</span>)</span><br><span class="line">cfg.set(<span class="string">'test'</span>,<span class="string">'test2'</span>,<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(newfilename,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cfg.write(f)</span><br><span class="line">    </span><br><span class="line">print(cfg.getint(<span class="string">'test'</span>,<span class="string">'test2'</span>))</span><br><span class="line">cfg.remove_option(<span class="string">'test'</span>,<span class="string">'test2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字典操作更简单</span></span><br><span class="line">cfg[<span class="string">'test'</span>][<span class="string">'x'</span>] = <span class="string">'100'</span>   <span class="comment"># key不存在</span></span><br><span class="line">cfg[<span class="string">'test2'</span>] = &#123;<span class="string">'test2'</span>:<span class="string">'1000'</span>&#125;   <span class="comment"># section不存在</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'x'</span> <span class="keyword">in</span> cfg[<span class="string">'test'</span>])</span><br><span class="line">print(<span class="string">'x'</span> <span class="keyword">in</span> cfg[<span class="string">'test2'</span>])</span><br><span class="line"></span><br><span class="line">print(cfg._dict)   <span class="comment"># 返回默认字典类型，内部使用有序字典</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改后需要再次写入</span></span><br><span class="line"><span class="keyword">with</span> open(newfilename,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cfg.write(f)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/09/nmcli命令使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/09/nmcli命令使用/" itemprop="url">
                  nmcli命令使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-09 08:51:42" itemprop="dateCreated datePublished" datetime="2020-01-09T08:51:42+08:00">2020-01-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>nmcli命令 是 NetworkManager client 网络管理客户端。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p><code>nmcli [OPTIONS] OBJECT { COMMAND | help }</code></p>
<h4 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h4><p>OBJECT和COMMAND可以用全称也可以用简称，最少可以只用一个字母，建议用头三个字母。OBJECT里面我们平时用的最多的就是connection和device。device叫网络接口，是物理设备。connection是连接，偏重于逻辑设置。多个connection可以应用到同一个device，但同一时间只能启用其中一个connection。这样的好处是针对一个网络接口，我们可以设置多个网络连接，比如静态IP和动态IP，再根据需要up相应connection。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS   </span><br><span class="line">-t[erse]                                  # terse output 简洁的输出   </span><br><span class="line">-p[retty]                                 # pretty output 漂亮的输出   </span><br><span class="line">-m[ode] tabular|multiline                 # output mode  输出模式   </span><br><span class="line">-f[ields] &lt;field1,field2,...&gt;|all|common  # specify fields to output 指定要输出的字段   </span><br><span class="line">-e[scape] yes|no                          # escape columns separators in values 在值中转义列分隔符   </span><br><span class="line">-n[ocheck]                                # 不要检查nmcli和NetworkManager版本   </span><br><span class="line">-a[sk]                                    # 要求缺少参数   </span><br><span class="line">-w[ait] &lt;seconds&gt;                         # 设置超时等待整理操作   </span><br><span class="line">-v[ersion]                                # 显示程序版本   </span><br><span class="line">-h[elp]                                   # 打印此帮助  </span><br><span class="line"></span><br><span class="line">OBJECT   </span><br><span class="line">g[eneral]       # NetworkManager的一般状态和操作   </span><br><span class="line">n[etworking]    # 整体组网控制   </span><br><span class="line">r[adio]         # NetworkManager切换开关   </span><br><span class="line">c[onnection]    # NetworkManager的连接   </span><br><span class="line">d[evice]        # 由NetworkManager管理的设备   </span><br><span class="line">a[gent]         # NetworkManager秘密代理或polkit代理</span><br></pre></td></tr></table></figure>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">***修改网卡的IP地址并添加DNS***</span><br><span class="line">nmcli connection modify enp0s3 ipv4.method manual autoconnect yes ipv4.addresses 192.168.1.115/24 gw4 192.168.1.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改现在网卡的IP地址，并设置为静态地址。指定地址要用ipv4.addresses选项，不能用选项。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> autoconnect yes是控制配置文件中的ONBOOT是yes还是no的。配置文件就是</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/sysconfig/network-scripts/ifcfg-enp0s3。</span></span><br><span class="line">nmcli connection modify enp0s3 ipv4.dns 114.114.114.114</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定dns地址。改变地址与DNS都需要重启接口</span></span><br><span class="line">nmcli con up enp0s3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启，立即生效。不要使用nmcli con down enp0s3后再使用nmcli con up enp0s3，如果这样操作的话，会</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在现有的网卡上再添加一个地址。立即生效的方法还有nmcli dev reapply enp0s3和nmcli dev connect enp0s3，未测试</span></span><br><span class="line"></span><br><span class="line">删除网卡上的IP地址</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在网卡有多个IP地址时可以删除，也可以使用加号添加</span></span><br><span class="line">nmcli connection modify enp0s3 -ipv4.addresses 192.168.1.112/24</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用加减号来控制添加或删除一个地址，如上面就是删除一个地址</span></span><br><span class="line">nmcli con up enp0s3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启才能生效</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">给现有网卡添加一个新的地址</span><br><span class="line">nmcli con modify enp0s3 ip4 192.168.1.105/24 gw4 192.168.1.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给现在的接口添加一个新ip地址，这样网卡就有两个地址了</span></span><br><span class="line">nmcli con up enp0s3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试发现，如果通过编辑配置文件修改地址后，要先重启NetworkManager再使用此命令启动网卡，才能使地址生</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 效，不然直接使用此命令是无法使地址生效的。</span></span><br><span class="line"></span><br><span class="line">***给现有网卡创建一个新的connection***</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样创建后，一块网卡就会有多个配置，这样就可以用不同配置启动网卡了，但只能有一个connection是连接的</span></span><br><span class="line">nmcli con add con-name dhcp type ethernet ifname eno16777728</span><br><span class="line"><span class="meta">#</span><span class="bash"> 动态获取IP方式的网络连接配置</span></span><br><span class="line">nmcli con add con-name static ifname eno16777728 autoconnect yes type ethernet ip4 10.1.254.254/16 gw4 10.1.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定静态IP方式的网络连接配置，添加新的连接，连接名用con-name指定为eno16777728，<span class="built_in">type</span>指定类型，ifname指定接口名</span></span><br><span class="line"></span><br><span class="line">nmcli net on/off</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用/关闭所有的网络连接</span></span><br><span class="line">nmcli dev dis eno33554960</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用网络设备并防止自动激活</span></span><br><span class="line">nmcli con add help</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看添加网络连接配置的帮助</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改网络连接单项参数</span></span><br><span class="line">nmcli con mod IF-NAME connection.autoconnect yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改为自动连接</span></span><br><span class="line">nmcli con mod IF-NAME ipv4.method manual | dhcp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改IP地址是静态还是DHCP</span></span><br><span class="line">nmcli con mod IF-NAME ipv4.addresses “172.25.X.10/24 172.25.X.254”</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改IP配置及网关</span></span><br><span class="line">nmcli con mod IF-NAME ipv4.gateway 10.1.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改默认网关</span></span><br><span class="line">nmcli con mod IF-NAME +ipv4.addresses 10.10.10.10/16</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加第二个IP地址</span></span><br><span class="line">nmcli con mod IF-NAME ipv4.dns 114.114.114.114</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加dns1</span></span><br><span class="line">nmcli con mod IF-NAME +ipv4.dns  8.8.8.8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加dns2</span></span><br><span class="line">nmcli con mod IF-NAME -ipv4.dns  8.8.8.8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除dns</span></span><br><span class="line"></span><br><span class="line">nmcli connection show           </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前连接状态 </span></span><br><span class="line">nmcli connection show --active       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示活动的网络连接 </span></span><br><span class="line">nmcli connection show eno16777736    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示指定网络连接的详情 </span></span><br><span class="line">nmcli device status                </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示网络设备状态 </span></span><br><span class="line">nmcli device show eno16777736   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示指定网络设备的详情</span></span><br><span class="line">nmcli device show               </span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示全部网络接口属性 </span></span><br><span class="line">nmcli con up static             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用static连接配置 </span></span><br><span class="line">nmcli con up default            </span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用default连接配置  </span></span><br><span class="line">nmcli con add help              </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看帮助</span></span><br><span class="line">nmcli con up eno16777728</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用网络连接</span></span><br><span class="line">nmcli con down eno33554960</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停用网络连接（可被自动激活）</span></span><br><span class="line">nmcli con del eno33554960</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除网络连接的配置文件</span></span><br><span class="line">nmcli con reload</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新加载配置网络配置文件</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/02/python基础学习-路径操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/02/python基础学习-路径操作/" itemprop="url">
                  python基础学习-路径操作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-02 17:42:12" itemprop="dateCreated datePublished" datetime="2020-01-02T17:42:12+08:00">2020-01-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-06-24 14:51:45" itemprop="dateModified" datetime="2020-06-24T14:51:45+08:00">2020-06-24</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="路径操作模块"><a href="#路径操作模块" class="headerlink" title="路径操作模块"></a>路径操作模块</h3><h4 id="3-4版本之前"><a href="#3-4版本之前" class="headerlink" title="3.4版本之前"></a>3.4版本之前</h4><ul>
<li>os.path模块</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">p = path.join(<span class="string">'/etc'</span>,<span class="string">'network'</span>,<span class="string">'interfaces'</span>)</span><br><span class="line"><span class="comment"># 构建一个目录</span></span><br><span class="line">print(type(p),p)</span><br><span class="line"><span class="comment"># 如果是windows系统，这里的/会有问题</span></span><br><span class="line">print(path.exists(p))  <span class="comment"># 返回一个布尔型数据</span></span><br><span class="line"><span class="comment"># 判断目录是否存在</span></span><br><span class="line">print(path.split(p))   <span class="comment"># (head,tail)</span></span><br><span class="line"><span class="comment"># 路径切割，把最后一个/后面的内容和其前面的路径切分开。输出如：'/etc/network', 'interfaces'</span></span><br><span class="line">print(path.abspath(<span class="string">'.'</span>))</span><br><span class="line"><span class="comment"># 查看绝对路径，点代表当前路径</span></span><br><span class="line">p = path.join(<span class="string">'o:/'</span>,p,<span class="string">'test.txt'</span>)</span><br><span class="line">print(path.dirname(p))</span><br><span class="line"><span class="comment"># 取最后一个/前面的部分，输出：/etc/network</span></span><br><span class="line">print(path.basename(p))</span><br><span class="line"><span class="comment"># 取最后一个/后面的部分，输出：interfaces</span></span><br><span class="line">print(path.splitdrive(p))</span><br><span class="line"><span class="comment"># 驱动器，输出：('', '/etc/network/interfaces')</span></span><br><span class="line"></span><br><span class="line">p1 = path.abspath(__file__)</span><br><span class="line">print(p1,path.basename(p1))</span><br><span class="line"><span class="keyword">while</span> p1 ~= path.dirname(p1):</span><br><span class="line">    p1 = path.dirname(p1)</span><br><span class="line">    print(p1,path.basename(p1))</span><br></pre></td></tr></table></figure>
<h4 id="3-4版本开始"><a href="#3-4版本开始" class="headerlink" title="3.4版本开始"></a>3.4版本开始</h4><p>建议使用pathlib模块，提供Path对象来操作。包括目录和文件。</p>
<h3 id="pathlib模块"><a href="#pathlib模块" class="headerlink" title="pathlib模块"></a>pathlib模块</h3><p><code>from pathlib import Path</code></p>
<h3 id="目录操作"><a href="#目录操作" class="headerlink" title="目录操作"></a>目录操作</h3><p>初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">p = Path()   <span class="comment"># 当前目录</span></span><br><span class="line">type(p)</span><br><span class="line"><span class="comment"># 这时p的类型就不是字符串了，而是pathlib下的一个类型，系统不同，这个类型也不同</span></span><br><span class="line">p = Path(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c/d'</span>)   <span class="comment"># 当前目录下的a/b/c/d。用逗号分隔，不需要使用/</span></span><br><span class="line">p = Path(<span class="string">'/etc'</span>)   <span class="comment"># 根下的etc目录</span></span><br><span class="line">p.absolute()</span><br><span class="line"><span class="comment"># 查看绝对路径</span></span><br><span class="line">p = p.joinpath(<span class="string">'a'</span>,<span class="string">'b'</span>)</span><br><span class="line"><span class="comment"># 做一个a/b目录路径</span></span><br><span class="line">p.absolute()</span><br><span class="line"><span class="comment"># 查看上面做的路径，但目录并没有创建 </span></span><br><span class="line">p = p / <span class="string">'c'</span> / <span class="string">'d'</span></span><br><span class="line">p</span><br><span class="line"><span class="comment"># 输出：PosixPath('a/b/c/d')</span></span><br><span class="line">p /= <span class="string">'e'</span></span><br><span class="line"><span class="comment"># 这相当于加等，输出：PosixPath('a/b/c/d/e')</span></span><br><span class="line">p1 = Path(<span class="string">'/etc'</span>)</span><br><span class="line"><span class="comment"># 做一个绝对路径</span></span><br><span class="line">p1.absolute()</span><br><span class="line"><span class="comment"># 查看绝对路径 </span></span><br><span class="line">p2 = <span class="string">'/'</span> / <span class="string">'etc'</span> / <span class="string">'sysconfig'</span></span><br><span class="line"><span class="comment"># 这样是不对的，会报错。因为字符串拼接要用加号，这里用/表示除号，所以报错</span></span><br><span class="line">p2 = Path(<span class="string">''</span>)</span><br><span class="line"><span class="comment"># 这是定义p2为当前目录，也就是点</span></span><br><span class="line">p2 = <span class="string">'/etc'</span> / <span class="string">'sysconfig'</span></span><br><span class="line"><span class="comment"># 这样还是会报错，问题和上面一样</span></span><br><span class="line">p2 = p2 / <span class="string">'/etc'</span> / <span class="string">'sysconfig'</span></span><br><span class="line"><span class="comment"># 只有加上当前的路径，再加后面的字符串才可以。这相当于用/etc/sysconfig覆盖p2的路径，原因是p2后面使用的路径是/etc，如果只是etc，那么就是在p2的路径上拼接了</span></span><br><span class="line">p2.parts</span><br><span class="line"><span class="comment"># 分解路径，以/为分隔符。输出：('/', 'etc', 'sysconfig')</span></span><br><span class="line">p2.joinpath(<span class="string">'a/b'</span>,<span class="string">'c'</span>)</span><br><span class="line"><span class="comment"># 路径拼接</span></span><br><span class="line">str(p2)</span><br><span class="line"><span class="comment"># 获取字符串</span></span><br><span class="line">bytes(p2)</span><br><span class="line">p2.parent</span><br><span class="line"><span class="comment"># 显示父目录 </span></span><br><span class="line">p2.parent.parent</span><br><span class="line"><span class="comment"># 如果p2是当前路径，这样做的话，当前路径的父目录还是当前路径，要用p2.absolute().parent才可以</span></span><br><span class="line"></span><br><span class="line">list(p2.parents)</span><br><span class="line">输出：</span><br><span class="line">[PosixPath(<span class="string">'/etc/sysconfig/a/b/c/etc'</span>), PosixPath(<span class="string">'/etc/sysconfig/a/b/c'</span>), PosixPath(<span class="string">'/etc/sysconfig/a/b'</span>), PosixPath(<span class="string">'/etc/sysconfig/a'</span>), PosixPath(<span class="string">'/etc/sysconfig'</span>), PosixPath(<span class="string">'/etc'</span>), PosixPath(<span class="string">'/'</span>)]</span><br><span class="line">p2 /= <span class="string">'a/b/c/d'</span></span><br><span class="line">list(p2.parents)</span><br><span class="line"><span class="comment"># 迭代目录组成列表</span></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">[PosixPath(<span class="string">'/etc/sysconfig/a/b/c/etc/sysconfig/a/b/c'</span>), PosixPath(<span class="string">'/etc/sysconfig/a/b/c/etc/sysconfig/a/b'</span>), PosixPath(<span class="string">'/etc/sysconfig/a/b/c/etc/sysconfig/a'</span>), PosixPath(<span class="string">'/etc/sysconfig/a/b/c/etc/sysconfig'</span>), PosixPath(<span class="string">'/etc/sysconfig/a/b/c/etc'</span>), PosixPath(<span class="string">'/etc/sysconfig/a/b/c'</span>), PosixPath(<span class="string">'/etc/sysconfig/a/b'</span>), PosixPath(<span class="string">'/etc/sysconfig/a'</span>), PosixPath(<span class="string">'/etc/sysconfig'</span>), PosixPath(<span class="string">'/etc'</span>), PosixPath(<span class="string">'/'</span>)]</span><br><span class="line">next(iter(p2.parents))</span><br><span class="line"><span class="comment"># 先用iter将p2.parents的值变成迭代器，再用next拿一个。如果对象没有parents，也就是没有父目录，那么这</span></span><br><span class="line"><span class="comment"># 样使用会报错，没法再拿路径了</span></span><br></pre></td></tr></table></figure>
<p>路径拼接和分解</p>
<p><strong><em>操作符<code>/</code></em></strong></p>
<p>Path对象 / Path对象</p>
<p>Path对象 / 字符串 或者 字符串 / Path对象</p>
<p><strong><em>分解</em></strong></p>
<p>parts属性，可以返回路径中的每一个部分</p>
<p><strong><em>joinpath</em></strong></p>
<p><code>joinpath(*other)</code>连接多个字符串到Path对象中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p = Path()</span><br><span class="line">p = p / <span class="string">'a'</span></span><br><span class="line">p1 = <span class="string">'b'</span> / p</span><br><span class="line">p2 = Path(<span class="string">'c'</span>)</span><br><span class="line">p3 = p2 / p1</span><br><span class="line">print(p3.parts)</span><br><span class="line">print(p3.parts[<span class="number">2</span>])  <span class="comment"># 也可以这样，只取路径中的某一段</span></span><br><span class="line">pe.joinpath(<span class="string">'etc'</span>,<span class="string">'init.d'</span>,Path(<span class="string">'httpd'</span>))</span><br></pre></td></tr></table></figure>
<p>获取路径</p>
<p>str 获取路径字符串</p>
<p>bytes 获取路径字符串的bytes</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">'/etc'</span>)</span><br><span class="line">print(str(p),bytes(p))</span><br></pre></td></tr></table></figure>
<p>父目录</p>
<p>parent 目录的逻辑父目录</p>
<p>parents 父目录序列，索引0是直接的父，不会显示当前的目录名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">'/a/b/c/d'</span>)</span><br><span class="line">print(p.parent.parent)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> p.parents:  <span class="comment"># 从parents的索引0到索引n-1，依次打印，路径是从最长到最短，也可以直播使用p.parents[1]这种方式取得路径</span></span><br><span class="line">    print(x)</span><br><span class="line">输出：</span><br><span class="line">a/b/c</span><br><span class="line">a/b</span><br><span class="line">a</span><br><span class="line">.</span><br></pre></td></tr></table></figure>
<p>name、stem、suffix、suffixes、with_suffix(suffix)、with_name(name)</p>
<p>name：目录的最后一个部分</p>
<p>suffix：目录中最后一个部分的扩展名</p>
<p>stem：目录最后一个部分，没有后缀</p>
<p>suffixes：返回多个扩展名列表</p>
<p>with_suffix(suffix)：补充扩展名到路径尾部，返回新的路径，之前存在扩展名也被视为无效</p>
<p>with_name(name)：替换目录最后一个部分并返回一个新的路径</p>
<p><strong>Path的方法拿到的大多数是对象，所以可以使用对象的方法拼接路径，这更方便。返回对象后方便对前面的结果继续处理，如使用<code>p2.parent.parent</code></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">'/magedu/mysqlinstall/mysql.tar.gz'</span>)</span><br><span class="line">print(p.name)</span><br><span class="line">print(p.suffix)</span><br><span class="line">print(p.suffixes)</span><br><span class="line">print(p.stem)</span><br><span class="line">print(p.with_name(<span class="string">'mysql-5.tgz'</span>))</span><br><span class="line">p = Path(<span class="string">'README'</span>)</span><br><span class="line">print(p.with_suffix(<span class="string">'.txt'</span>))</span><br></pre></td></tr></table></figure>
<p>cwd()：返回当前工作目录</p>
<p>home()：返回当前家目录</p>
<p>is_dir()：是否是目录，目录存在返回True</p>
<p>is_file()：是否是普通文件，文件存在返回True</p>
<p>is_symlink()：是否是软链接</p>
<p>is_socket()：是否是socket文件</p>
<p>is_block_device()：是否是块设备</p>
<p>is_char_device()：是否是字符设备</p>
<p>is_absolute()：是否是绝对路径</p>
<p>resolve()：返回一个新的路径，这个新路径就是当前Path对象的绝对路径，如果是软链接则直接被解析</p>
<p>absolute()：也可以获取绝对路径，但是推荐使用resolve()</p>
<p>exists()：目录或文件是否存在</p>
<p>rmdir()：删除空目录。没有提供判断目录为空的方法</p>
<p>touch(mode=0o666,exist_ok=True)：创建一个文件</p>
<p>as_uri()：将路径返回成URI，例如：file:///etc/passwd</p>
<p>mkdir(mode=0o777,parents=False,exist_ok=False)</p>
<p>parents：是否创建父目录，True等同于mkdir -p；False时，父目录不存在，则抛出FileNotFoundError；exist_ok参数，在3.5版本加入。False时，路径存在，抛出FileExistsError；True时，FileExistsError被忽略</p>
<p>iterdir()：迭代当前目录</p>
<p>这里有几点需要注意</p>
<ul>
<li><code>p.parents</code>的类型是pathlib._PathParents，这种类型是没有iterdir()方法的，所以使用<code>p.parents.iterdir()</code>会报错</li>
<li><code>p.parents[*]</code>的类型是pathlib.PosixPath，这种类型才可以使用iterdir()方法，如<code>p.parents[0].iterdir()</code></li>
<li><code>p.parents[len(p.parents)-1]</code>实际就是根目录，也就是p.parents[*]中，索引最大时，路径是最短的时候，也就是根目录，所以无法p的路径有多长，使用这个方法都可以取行根目录，再配以iterdir()方法，就可以迭代根目录下的所有目录了。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">p = Path()</span><br><span class="line">p /= <span class="string">'a/b/c/d'</span></span><br><span class="line">p.exists()   <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">p.mkdir()   <span class="comment"># FileNotFoundError</span></span><br><span class="line">p.mkdir(parents=<span class="keyword">True</span>)</span><br><span class="line">p.exists()   <span class="comment"># True</span></span><br><span class="line">p.mkdir(parents=<span class="keyword">True</span>)</span><br><span class="line">p.mkdir(parents=<span class="keyword">True</span>,exist_ok=<span class="keyword">True</span>)</span><br><span class="line">p /= <span class="string">'readme.txt'</span></span><br><span class="line">p.parent.rmdir()  <span class="comment"># 如果p的父目录是空，就删除</span></span><br><span class="line">p.parent.exists()   <span class="comment"># False 'a/b/c'</span></span><br><span class="line">p.mkdir()   <span class="comment"># FileNotFoundError</span></span><br><span class="line">p.mkdir(parents=<span class="keyword">True</span>)   <span class="comment"># 成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历，并判断文件类型，如果是目录是否可以判断其是否为空？</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> p.parents[len(p.parents)<span class="number">-1</span>].iterdir():  <span class="comment"># 这里迭代的是根目录中的每一个目录，len(p.parents)-1就是根目录</span></span><br><span class="line"><span class="comment"># 迭代所有路径</span></span><br><span class="line">    print(x,end=<span class="string">'\t'</span>)</span><br><span class="line">    <span class="keyword">if</span> x.is_dir():</span><br><span class="line">        flag = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> x.iterdir():</span><br><span class="line"><span class="comment"># 如果能进来迭代，就证明目录不为空，下面就可以判断，如果是flag = false就是空目录，如果是True就不是空目录</span></span><br><span class="line">            flag = <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># for 循环是否可以使用else子句</span></span><br><span class="line">        print(<span class="string">'dir'</span>,<span class="string">'Not Empty'</span> <span class="keyword">if</span> flag <span class="keyword">else</span> <span class="string">'Empty'</span>,sep=<span class="string">'\t'</span>)</span><br><span class="line">    <span class="keyword">elif</span> x.is_file():</span><br><span class="line">        print(<span class="string">'file'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'other file'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h4><p>glob(pattern)：通配给定的模式</p>
<p>rglob(pattern)：通配给定的模式，递归目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回一个生成器</span></span><br><span class="line">list(p.glob(<span class="string">'test*'</span>))   <span class="comment"># 返回当前目录对象下的test开头的文件</span></span><br><span class="line">list(p.glob(<span class="string">'**/*.py'</span>))   <span class="comment"># 递归所有目录，等同rglob</span></span><br><span class="line"><span class="comment"># 如果是*/*.py表示当前层，因为/前是一个星号。如果是**/*.py表示从当前路径算起往下所有目录，任意层次目录都要查找。.py前面的*表示任意个字符，/前的一个*表示任意一级，如果/前是两个*，表示任意个字符任意级</span></span><br><span class="line">g = p.rglob(<span class="string">'*.py'</span>)   <span class="comment"># 生成器，rglob表示递归查找</span></span><br><span class="line">next(g)</span><br></pre></td></tr></table></figure>
<h4 id="匹配"><a href="#匹配" class="headerlink" title="匹配"></a>匹配</h4><p>match(pattern)：模式匹配，成功返回True</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Path(<span class="string">'a/b.py'</span>).match(<span class="string">'*.py'</span>)   <span class="comment"># True</span></span><br><span class="line">Path(<span class="string">'/a/b/c.py'</span>).match(<span class="string">'b/*.py'</span>)   <span class="comment"># True</span></span><br><span class="line">Path(<span class="string">'/a/b/c.py'</span>).match(<span class="string">'a/*.py'</span>)   <span class="comment"># False</span></span><br><span class="line">Path(<span class="string">'/a/b/c.py'</span>).match(<span class="string">'a/*/*.py'</span>)   <span class="comment"># True</span></span><br><span class="line">Path(<span class="string">'/a/b/c.py'</span>).match(<span class="string">'z/**/*.py'</span>)   <span class="comment"># True</span></span><br><span class="line">Path(<span class="string">'/a/b/c.py'</span>).match(<span class="string">'**/*.py'</span>)   <span class="comment"># True</span></span><br></pre></td></tr></table></figure>
<p>stat()：相当于stat命令</p>
<p>lstat()同stat()，但如果是符号链接，则显示符号链接本身的文件信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ln -s test t</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">p = Path(<span class="string">'test'</span>)</span><br><span class="line">p.stat()</span><br><span class="line">p1 = Path(<span class="string">'t'</span>)</span><br><span class="line">p1.stat()</span><br><span class="line">p1.lstat()</span><br></pre></td></tr></table></figure>
<h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><p><code>open(mode=&#39;r&#39;,buffering=-1,encoding=None,errors=None,newline=None)</code></p>
<p>使用方法类似内建函数open。返回一个文件对象</p>
<p>3.5增加的新函数</p>
<p>read_bytes()：以’rb’读取路径对应文件，并返回二进制流。看源码</p>
<p>read_text(encoding=None,errors=None)：以’rt’方式读取路径对应文件，返回文本</p>
<p>Path.write_bytes(data)：以’wb’方式写入数据到路径对应文件</p>
<p>write_text(data,encoding=None,errors=None)：以’wt’方式写入字符串到路径对应文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">'my_binary_file'</span>)</span><br><span class="line">p.write_bytes(<span class="string">b'Binary file contents'</span>)</span><br><span class="line">p.read_bytes()   <span class="comment"># b'Binary file contents'</span></span><br><span class="line"></span><br><span class="line">p = Path(<span class="string">'my_text_file'</span>)</span><br><span class="line">p.write_text(<span class="string">'Text file contents'</span>)</span><br><span class="line">p.read_text()   <span class="comment"># 'Text file contents'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">p = Path(<span class="string">'o:test.py'</span>)</span><br><span class="line">p.write_text(<span class="string">'hello python'</span>)</span><br><span class="line">print(p.read_text())</span><br><span class="line"><span class="keyword">with</span> p.open() <span class="keyword">as</span> f:</span><br><span class="line">    print(f.read(<span class="number">5</span>))</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/02/python基础学习-StringIO和BytesIO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/02/python基础学习-StringIO和BytesIO/" itemprop="url">
                  python基础学习-StringIO和BytesIO
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-02 17:24:53" itemprop="dateCreated datePublished" datetime="2020-01-02T17:24:53+08:00">2020-01-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="StringIO"><a href="#StringIO" class="headerlink" title="StringIO"></a>StringIO</h3><ul>
<li>io模块中的类<ul>
<li>from io import StringIO</li>
</ul>
</li>
<li>内存中，开辟的一个文本模式的buffer，可以像文件对象一样操作它</li>
<li><p>当close方法被调用的时候，这个buffer会被释放</p>
</li>
<li><p>getvalue() 获取全部内容。跟文件指针没有关系</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="comment"># 内存中构建</span></span><br><span class="line">sio = StringIO()   <span class="comment"># 像文件对象一样操作</span></span><br><span class="line">print(sio.readable(),sio.writable(),sio.seekable())</span><br><span class="line"><span class="comment"># 输出：True True True，表示可读，可写，也可seek</span></span><br><span class="line">sio.write(<span class="string">"magedu\nPython"</span>)</span><br><span class="line">sio.seek(<span class="number">0</span>)</span><br><span class="line">print(sio.readline())</span><br><span class="line">print(sio.getvalue())   <span class="comment"># 无视指针，输出全部内容</span></span><br><span class="line"><span class="comment"># getvalue()和sio.read()的效果是一样的，但getvalue()是无视指针的，无需使用seek到开头</span></span><br><span class="line">sio.close()</span><br></pre></td></tr></table></figure>
<ul>
<li>好处<ul>
<li>一般来说，磁盘的操作比内存的操作要慢得多，内存足够的情况下，一般的优化思想是少落地，减少磁盘IO的过程，可以大大提高程序的运行效率</li>
</ul>
</li>
</ul>
<h3 id="BytesIO"><a href="#BytesIO" class="headerlink" title="BytesIO"></a>BytesIO</h3><ul>
<li>io模块中的类<ul>
<li>from io import BytesIO</li>
</ul>
</li>
<li>内存中，开辟的一个二进制模式的buffer，可以像文件对象一样操作它</li>
<li>当close方法被调用的时候，这个buffer会被释放</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO   <span class="comment"># 内存中构建</span></span><br><span class="line">bio = BytesIO()</span><br><span class="line">print(bio.readable(),bio.writable(),bio.seekable())</span><br><span class="line">bio.write(<span class="string">b"magedu\nPython"</span>)</span><br><span class="line">bio.seek(<span class="number">0</span>)</span><br><span class="line">print(bio.readline())</span><br><span class="line">print(bio.getvalue())   <span class="comment"># 无视指针，输出全部内容</span></span><br><span class="line">bio.close()</span><br></pre></td></tr></table></figure>
<h3 id="file-like对象"><a href="#file-like对象" class="headerlink" title="file-like对象"></a>file-like对象</h3><ul>
<li>类文件对象，可以像文件对象一样操作</li>
<li>socket对象、输入输出对象(stdin、stdout) 都是类文件对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdout</span><br><span class="line">f = stdout</span><br><span class="line">print(type(f))</span><br><span class="line">f.write(<span class="string">'magedu.com'</span>)  <span class="comment"># 这是在屏幕输出的</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/02/python基础学习-转：面向对象编程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/02/python基础学习-转：面向对象编程/" itemprop="url">
                  python基础学习-转：面向对象编程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-02 17:22:27" itemprop="dateCreated datePublished" datetime="2020-01-02T17:22:27+08:00">2020-01-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017495723838528" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/1016959663602400/1017495723838528</a></p>
<p>面向对象编程——Object Oriented Programming，简称OOP，是一种程序设计思想。OOP把对象作为程序的基本单元，一个对象包含了数据和操作数据的函数。</p>
<p>面向过程的程序设计把计算机程序视为一系列的命令集合，即一组函数的顺序执行。为了简化程序设计，面向过程把函数继续切分为子函数，即把大块函数通过切割成小块函数来降低系统的复杂度。</p>
<p>而面向对象的程序设计把计算机程序视为一组对象的集合，而每个对象都可以接收其他对象发过来的消息，并处理这些消息，计算机程序的执行就是一系列消息在各个对象之间传递。</p>
<p>在Python中，所有数据类型都可以视为对象，当然也可以自定义对象。自定义的对象数据类型就是面向对象中的类（Class）的概念。</p>
<p>我们以一个例子来说明面向过程和面向对象在程序流程上的不同之处。</p>
<p>假设我们要处理学生的成绩表，为了表示一个学生的成绩，面向过程的程序可以用一个dict表示：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">std1</span> = &#123; <span class="string">'name'</span>: <span class="string">'Michael'</span>, <span class="string">'score'</span>: <span class="number">98</span> &#125;</span><br><span class="line"><span class="attr">std2</span> = &#123; <span class="string">'name'</span>: <span class="string">'Bob'</span>, <span class="string">'score'</span>: <span class="number">81</span> &#125;</span><br></pre></td></tr></table></figure>
<p>而处理学生成绩可以通过函数实现，比如打印学生的成绩：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_score</span><span class="params">(std)</span>:</span></span><br><span class="line">    print(<span class="string">'%s: %s'</span> % (std[<span class="string">'name'</span>], std[<span class="string">'score'</span>]))</span><br></pre></td></tr></table></figure>
<p>如果采用面向对象的程序设计思想，我们首选思考的不是程序的执行流程，而是<code>Student</code>这种数据类型应该被视为一个对象，这个对象拥有<code>name</code>和<code>score</code>这两个属性（Property）。如果要打印一个学生的成绩，首先必须创建出这个学生对应的对象，然后，给对象发一个<code>print_score</code>消息，让对象自己把自己的数据打印出来。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="title">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, name, score)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">self</span>.score = score</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print_score</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        print(<span class="string">'%s: %s'</span> % (<span class="keyword">self</span>.name, <span class="keyword">self</span>.score))</span><br></pre></td></tr></table></figure>
<p>给对象发消息实际上就是调用对象对应的关联函数，我们称之为对象的方法（Method）。面向对象的程序写出来就像这样：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bart = Student('Bart Simpson', 59)</span><br><span class="line">lisa = Student('Lisa Simpson', 87)</span><br><span class="line">bart.print_score()</span><br><span class="line">lisa.print_score()</span><br></pre></td></tr></table></figure>
<p>面向对象的设计思想是从自然界中来的，因为在自然界中，类（Class）和实例（Instance）的概念是很自然的。Class是一种抽象概念，比如我们定义的Class——Student，是指学生这个概念，而实例（Instance）则是一个个具体的Student，比如，Bart Simpson和Lisa Simpson是两个具体的Student。</p>
<p>所以，面向对象的设计思想是抽象出Class，根据Class创建Instance。</p>
<p>面向对象的抽象程度又比函数要高，因为一个Class既包含数据，又包含操作数据的方法。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>数据封装、继承和多态是面向对象的三大特点</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/02/python基础学习-转：[翻译]理解Python的with语句/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/02/python基础学习-转：[翻译]理解Python的with语句/" itemprop="url">
                  python基础学习-转：[翻译]理解Python的with语句
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-02 09:06:50" itemprop="dateCreated datePublished" datetime="2020-01-02T09:06:50+08:00">2020-01-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="转：-翻译-理解Python的With语句"><a href="#转：-翻译-理解Python的With语句" class="headerlink" title="转：[翻译] 理解Python的With语句"></a>转：[翻译] 理解Python的With语句</h1><p><a href="http://linbo.github.io/2013/01/08/python-with#comments" target="_blank" rel="noopener">http://linbo.github.io/2013/01/08/python-with#comments</a>)</p>
<h2 id="With语句是什么？"><a href="#With语句是什么？" class="headerlink" title="With语句是什么？"></a>With语句是什么？</h2><p>Python’s with statement provides a very convenient way of dealing with the situation where you have to do a setup and teardown to make something happen. A very good example for this is the situation where you want to gain a handler to a file, read data from the file and the close the file handler.</p>
<p>有一些任务，可能事先需要设置，事后做清理工作。对于这种场景，Python的with语句提供了一种非常方便的处理方式。一个很好的例子是文件处理，你需要获取一个文件句柄，从文件中读取数据，然后关闭文件句柄。</p>
<p>Without the with statement, one would write something along the lines of:</p>
<p>如果不用with语句，代码如下：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">file</span> = <span class="built_in">open</span>(<span class="string">"/tmp/foo.txt"</span>)</span><br><span class="line">data = <span class="built_in">file</span>.<span class="built_in">read</span>()</span><br><span class="line"><span class="built_in">file</span>.<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure>
<p>There are two annoying things here. First, you end up forgetting to close the file handler. The second is how to handle exceptions that may occur once the file handler has been obtained. One could write something like this to get around this:</p>
<p>这里有两个问题。一是可能忘记关闭文件句柄；二是文件读取数据发生异常，没有进行任何处理。下面是处理异常的加强版本：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">file</span> = <span class="built_in">open</span>(<span class="string">"/tmp/foo.txt"</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    data = <span class="built_in">file</span>.<span class="built_in">read</span>()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="built_in">file</span>.<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure>
<p>While this works well, it is unnecessarily verbose. This is where with is useful. The good thing about with apart from the better syntax is that it is very good handling exceptions. The above code would look like this, when using with:</p>
<p>虽然这段代码运行良好，但是太冗长了。这时候就是with一展身手的时候了。除了有更优雅的语法，with还可以很好的处理上下文环境产生的异常。下面是with版本的代码：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"/tmp /foo.txt"</span>) <span class="keyword">as</span> <span class="built_in">file</span>:</span><br><span class="line">    data = <span class="built_in">file</span>.<span class="built_in">read</span>()</span><br></pre></td></tr></table></figure>
<p>with如何工作？ —— —</p>
<p>while this might look like magic, the way Python handles with is more clever than magic. The basic idea is that the statement after with has to evaluate an object that responds to an <strong>enter</strong>() as well as an <strong>exit</strong>() function.</p>
<p>这看起来充满魔法，但不仅仅是魔法，Python对with的处理还很聪明。基本思想是with所求值的对象必须有一个<strong>enter</strong>()方法，一个<strong>exit</strong>()方法。</p>
<p>After the statement that follows with is evaluated, the <strong>enter</strong>() function on the resulting object is called. The value returned by this function is assigned to the variable following as. After every statement in the block is evaluated, the <strong>exit</strong>() function is called.</p>
<p>紧跟with后面的语句被求值后，返回对象的<strong>enter</strong>()方法被调用，这个方法的返回值将被赋值给as后面的变量。当with后面的代码块全部被执行完之后，将调用前面返回对象的<strong>exit</strong>()方法。</p>
<p>This can be demonstrated with the following example:</p>
<p>下面例子可以具体说明with如何工作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># with_example01.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sample</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"In __enter__()"</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Foo"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, type, value, trace)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"In __exit__()"</span></span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_sample</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Sample()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> get_sample() <span class="keyword">as</span> sample:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"sample:"</span>, sample</span><br></pre></td></tr></table></figure>
<p>When executed, this will result in:<br>行代码，输出如下</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash-<span class="number">3.2</span>$ ./with_example01.py</span><br><span class="line"><span class="built_in">In</span> <span class="variable">__enter__</span>()</span><br><span class="line">sample: Foo</span><br><span class="line"><span class="built_in">In</span> <span class="variable">__exit__</span>()</span><br></pre></td></tr></table></figure>
<p>As you can see, The <strong>enter</strong>() function is executed The value returned by it - in this case “Foo” is assigned to sample The body of the block is executed, thereby printing the value of sample ie. “Foo” The <strong>exit</strong>() function is called. What makes with really powerful is the fact that it can handle exceptions. You would have noticed that the <strong>exit</strong>() function for Sample takes three arguments - val, type and trace. These are useful in exception handling. Let’s see how this works by modifying the above example.</p>
<p>正如你看到的，</p>
<ol>
<li><strong>enter</strong>()方法被执行</li>
<li><strong>enter</strong>()方法返回的值 - 这个例子中是”Foo”，赋值给变量’sample’</li>
<li>执行代码块，打印变量”sample”的值为 “Foo”</li>
<li><strong>exit</strong>()方法被调用</li>
</ol>
<p>with真正强大之处是它可以处理异常。可能你已经注意到Sample类的<strong>exit</strong>方法有三个参数- val, type 和 trace。 这些参数在异常处理中相当有用。我们来改一下代码，看看具体如何工作的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># with_example02.py</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sample</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, type, value, trace)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"type:"</span>, type</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"value:"</span>, value</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"trace:"</span>, trace</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_something</span><span class="params">(self)</span>:</span></span><br><span class="line">        bar = <span class="number">1</span>/<span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> bar + <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Sample() <span class="keyword">as</span> sample:</span><br><span class="line">    sample.do_something()</span><br></pre></td></tr></table></figure>
<p>Notice how in this example, instead of get_sample(), with takes Sample(). It does not matter, as long as the statement that follows with evaluates to an object that has an <strong>enter</strong>() and <strong>exit</strong>() functions. In this case, Sample()’s <strong>enter</strong>() returns the newly created instance of Sample and that is what gets passed to sample.</p>
<p>这个例子中，with后面的get_sample()变成了Sample()。这没有任何关系，只要紧跟with后面的语句所返回的对象有 <strong>enter</strong>()和<strong>exit</strong>()方法即可。此例中，Sample()的<strong>enter</strong>()方法返回新创建的Sample对象，并赋值给变量sample。</p>
<p>When executed:</p>
<p>代码执行后：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bash<span class="number">-3.2</span>$ ./with_example02.py</span><br><span class="line">type: &lt;type <span class="string">'exceptions.ZeroDivisionError'</span>&gt;</span><br><span class="line"><span class="built_in">value</span>: <span class="keyword">integer</span> division <span class="keyword">or</span> modulo <span class="keyword">by</span> <span class="literal">zero</span></span><br><span class="line">trace: &lt;traceback object <span class="keyword">at</span> <span class="number">0x1004a8128</span>&gt;</span><br><span class="line">Traceback (most recent call <span class="keyword">last</span>):</span><br><span class="line">  File <span class="string">"./with_example02.py"</span>, <span class="built_in">line</span> <span class="number">19</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    sample.do_somet hing()</span><br><span class="line">  File <span class="string">"./with_example02.py"</span>, <span class="built_in">line</span> <span class="number">15</span>, <span class="keyword">in</span> do_something</span><br><span class="line">    bar = <span class="number">1</span>/<span class="number">0</span></span><br><span class="line">ZeroDivisionError: <span class="keyword">integer</span> division <span class="keyword">or</span> modulo <span class="keyword">by</span> <span class="literal">zero</span></span><br></pre></td></tr></table></figure>
<p>Essentially, if there are exceptions being thrown from anywhere inside the block, the <strong>exit</strong>() function for the object is called. As you can see, the type, value and the stack trace associated with the exception thrown is passed to this function. In this case, you can see that there was a ZeroDivisionError exception being thrown. People implementing libraries can write code that clean up resources, close files etc. in their <strong>exit</strong>() functions.</p>
<p>实际上，在with后面的代码块抛出任何异常时，<strong>exit</strong>()方法被执行。正如例子所示，异常抛出时，与之关联的type，value和stack trace传给<strong>exit</strong>()方法，因此抛出的ZeroDivisionError异常被打印出来了。开发库时，清理资源，关闭文件等等操作，都可以放在<strong>exit</strong>方法当中。</p>
<p>Thus, Python’s with is a nifty construct that makes code a little less verbose and makes cleaning up during exceptions a bit easier.</p>
<p>因此，Python的with语句是提供一个有效的机制，让代码更简练，同时在异常产生时，清理工作更简单。</p>
<p>I have put the code examples given here on <a href="https://github.com/sdqali/python_dojo/tree/master/with%20Github" target="_blank" rel="noopener">Github</a>.</p>
<p>示例代码可以在<a href="https://github.com/sdqali/python_dojo/tree/master/with%20Github" target="_blank" rel="noopener">Github</a>上面找到。</p>
<p>译注：<a href="http://blog.sdqali.in/blog/2012/07/09/understanding-pythons-with/" target="_blank" rel="noopener">本文原文见</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/31/python基础学习-文件操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/31/python基础学习-文件操作/" itemprop="url">
                  python基础学习-文件操作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-12-31 15:42:08" itemprop="dateCreated datePublished" datetime="2019-12-31T15:42:08+08:00">2019-12-31</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-06-29 17:52:10" itemprop="dateModified" datetime="2020-06-29T17:52:10+08:00">2020-06-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><h4 id="冯诺依曼体系架构"><a href="#冯诺依曼体系架构" class="headerlink" title="冯诺依曼体系架构"></a>冯诺依曼体系架构</h4><p><img src="/images/python文件操作/冯诺依曼体系架构.png" alt=""></p>
<ul>
<li>CPU由运算器和控制器组成<ul>
<li>运算器，完成各种算数运算、逻辑运算、数据传输等数据加工处理</li>
<li>控制器，控制程序的执行</li>
<li>存储器，用于记忆程序和数据，例如内存</li>
<li>输入设备，将数据或者程序输入到计算机中，例如键盘、鼠标</li>
<li>输出设备，将数据或程序的处理结果展示给用户，例如显示器、打印机等</li>
</ul>
</li>
</ul>
<p>一般说IO操作，指的是文件IO，如果指的是网络IO，都会直接说网络IO</p>
<h3 id="文件IO常用操作"><a href="#文件IO常用操作" class="headerlink" title="文件IO常用操作"></a>文件IO常用操作</h3><table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>open</td>
<td>打开</td>
</tr>
<tr>
<td>read</td>
<td>读取</td>
</tr>
<tr>
<td>write</td>
<td>写入</td>
</tr>
<tr>
<td>close</td>
<td>关闭</td>
</tr>
<tr>
<td>readline</td>
<td>行读取</td>
</tr>
<tr>
<td>readlines</td>
<td>多行读取</td>
</tr>
<tr>
<td>seek</td>
<td>文件指针操作</td>
</tr>
<tr>
<td>tell</td>
<td>指针位置</td>
</tr>
</tbody>
</table>
<h4 id="打开操作"><a href="#打开操作" class="headerlink" title="打开操作"></a>打开操作</h4><p><code>open(file,mode=&#39;r&#39;,buffering=-1,encoding=None,errors=None,newline=None,closefd=True,opener=None)</code></p>
<p>打开一个文件，返回一个文件对象(流对象)和文件描述符。打开文件失败，则返回异常</p>
<p>基本使用：</p>
<p>创建一个文件test，然后打开它，用完关闭</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开ipython</span></span><br><span class="line">f = open(<span class="string">"test"</span>)   <span class="comment"># file对象</span></span><br><span class="line"><span class="comment"># windows &lt;_io.TextIOWrapper name='test' mode='r' encoding='cp936'&gt;</span></span><br><span class="line"><span class="comment"># linux &lt;_io.TextIOWrapper name='test' mode='r' encoding='UTF-8'&gt;</span></span><br><span class="line">print(f.read())   <span class="comment"># 读取文件</span></span><br><span class="line">f.close()   <span class="comment"># 关闭文件</span></span><br></pre></td></tr></table></figure>
<p>文件操作中，最常用的操作就是读和写。</p>
<p>文件访问的模式有两种：文本模式和二进制模式。不同模式下，操作函数不尽相同，表现的结果也不一样。</p>
<h5 id="open的参数"><a href="#open的参数" class="headerlink" title="open的参数"></a>open的参数</h5><h6 id="file"><a href="#file" class="headerlink" title="file"></a>file</h6><p>打开或者要创建的文件名。如果不指定路径，默认是当前路径</p>
<h6 id="mode模式"><a href="#mode模式" class="headerlink" title="mode模式"></a>mode模式</h6><table>
<thead>
<tr>
<th>描述字符</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>r</td>
<td>缺省的，表示只读打开</td>
</tr>
<tr>
<td>w</td>
<td>只写打开</td>
</tr>
<tr>
<td>x</td>
<td>创建并写入一个新文件</td>
</tr>
<tr>
<td>a</td>
<td>写入打开，如果文件存在，则追加</td>
</tr>
<tr>
<td>b</td>
<td>二进制模式</td>
</tr>
<tr>
<td>t</td>
<td>缺省的，文本模式</td>
</tr>
<tr>
<td>+</td>
<td>读写打开一个文件。给原来只读、只写方式打开提供缺失的读或者写能力</td>
</tr>
</tbody>
</table>
<p>在上面的例子中，可以看到默认是文本打开模式，且是只读的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># r模式</span></span><br><span class="line">f = open(<span class="string">'test'</span>)   <span class="comment"># 只读还是只写？</span></span><br><span class="line">f.read()</span><br><span class="line">f.write(<span class="string">'abc'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 因为默认是只读打开，所以这里不能写入，这样执行会报错:"UnsupportedOperation: not writable"</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test'</span>,<span class="string">'r'</span>)   <span class="comment"># 只读</span></span><br><span class="line">f.write(<span class="string">'abc'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 这里明确指出了只读打开，写入时也会报错</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test1'</span>,<span class="string">'r'</span>)   <span class="comment"># 只读，文件不存在</span></span><br><span class="line"><span class="comment"># 文件不存在，报错:"FileNotFoundError: [Errno 2] No such file or directory: 'test'"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># w模式</span></span><br><span class="line">f = open(<span class="string">'test'</span>,<span class="string">'w'</span>)   <span class="comment"># 只写打开</span></span><br><span class="line">f.write(<span class="string">'abc'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 使用jupter测试发现，如果test文件不存在，也会创建新的test文件，并写入内容。如果有test文件且其中有内</span></span><br><span class="line"><span class="comment"># 容，这样写入会覆盖里面的内容。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test   <span class="comment"># 看看内容</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test'</span>,mode=<span class="string">'w'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 这样操作文件后，文件会被清空</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test   <span class="comment"># 看看内容</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test1'</span>,mode=<span class="string">'w'</span>)</span><br><span class="line">f.write(<span class="string">'123'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 创建test1文件，并写入123。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test1   <span class="comment"># 看看内容</span></span><br></pre></td></tr></table></figure>
<p>open默认是以只读模式r打开已经存在的文件。</p>
<p>r</p>
<p>只读打开文件，如果使用write方法，会抛异常。</p>
<p>如果文件不存在，抛出FileNotFoundError异常</p>
<p>w</p>
<p>表示只写方式打开，如果读取则抛出异常</p>
<p>如果文件不存在，则直接创建文件</p>
<p>如果文件存在，则清空文件内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'test2'</span>,<span class="string">'x'</span>)</span><br><span class="line"><span class="comment"># f.read()</span></span><br><span class="line"><span class="comment"># 使用x打开的文件，这里用read方法会报错:UnsupportedOperation: not readable"。这是没有读权限，但</span></span><br><span class="line"><span class="comment"># 这并不影响上面创建test2文件</span></span><br><span class="line">f.write(<span class="string">'abcd'</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>x</p>
<p>文件不存在，创建文件，并以只写方式打开</p>
<p>文件存在，抛出FileExistsError异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'test2'</span>,<span class="string">'a'</span>)</span><br><span class="line">f.read()</span><br><span class="line"><span class="comment"># 这里依然会报错，因为没有读权限</span></span><br><span class="line">f.write(<span class="string">'abcde'</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test2</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test2'</span>,<span class="string">'a'</span>)</span><br><span class="line">f.write(<span class="string">'\n hello'</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test2</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test3'</span>,<span class="string">'a'</span>)</span><br><span class="line">f.write(<span class="string">'test3'</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test3</span><br></pre></td></tr></table></figure>
<p>a</p>
<p>文件存在，只写打开，追加内容</p>
<p>文件不存在，则创建后，只写打开，追加内容</p>
<p>r是只读，wxa都是只写。</p>
<p>wxa都可以产生新文件，w不管文件存在与否，都会生成全新内容的文件；a不管文件是否存在，都能在打开的文件尾部追加；x必须要求文件事先不存在，自己造一个新文件</p>
<p>文本模式t</p>
<p>字符流，将文件的字节按照某种字符编码理解，按照字符操作。open的默认mode就是rt。</p>
<p>二进制模式b</p>
<p>字节流，将文件就按照字节理解，与字符编码无关。二进制模式操作时，字节操作使用bytes类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">"test3"</span>,<span class="string">'rb'</span>)   <span class="comment"># 二进制只读</span></span><br><span class="line">s = f.read()</span><br><span class="line">print(type(s))   <span class="comment"># bytes</span></span><br><span class="line">print(s) <span class="comment"># b'test3'</span></span><br><span class="line">f.close()   <span class="comment"># 关闭文件</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"test3"</span>,<span class="string">'wb'</span>)   <span class="comment"># IO对象</span></span><br><span class="line">s = f.write(<span class="string">"马哥教育"</span>.encode())</span><br><span class="line">print(s)   <span class="comment"># 是什么，输出是12</span></span><br><span class="line">f.close()</span><br><span class="line">cat test3</span><br><span class="line"><span class="comment"># 输出：马哥教育</span></span><br></pre></td></tr></table></figure>
<p>思考：windows下，执行下面的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">"test3"</span>,<span class="string">'rw'</span>)</span><br><span class="line"><span class="comment"># 不可以这样打开文件，会报错："ValueError: must have exactly one of create/read/write/append mode"</span></span><br><span class="line">f = open(<span class="string">"test3"</span>,<span class="string">'r+'</span>)</span><br><span class="line">s = f.read()</span><br><span class="line">f.write(<span class="string">"马哥教育"</span>)</span><br><span class="line">print(f.read())   </span><br><span class="line"><span class="comment"># 没有显示，为什么？因为f.read()的值已经保存到s变量中了，所以这里没有显示。如果注释s = f.read()一行</span></span><br><span class="line"><span class="comment"># ，这里就可以显示出内容了。或在这里打印s的值也可以。</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"test3"</span>,<span class="string">'r+'</span>)</span><br><span class="line">s = f.write(<span class="string">"magedu"</span>)</span><br><span class="line">print(f.read())</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 这里不会打印出magedu，只有在使用cat test3查看时才能显示magedu。是因为f.write("magedu")的结果保</span></span><br><span class="line"><span class="comment"># 存到了s变量中，在关闭文件时才会写入吗？并且这里的写入功能是追加的效果</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test3</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test3'</span>,<span class="string">'w+'</span>)</span><br><span class="line">r.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 使用read方法查看不会有输出，因为使用w将文件清空了</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test3</span><br><span class="line"><span class="comment"># 文件被清空了</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test3'</span>,<span class="string">'a+'</span>)</span><br><span class="line">f.write(<span class="string">'mag'</span>)</span><br><span class="line">f.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test3</span><br><span class="line"><span class="comment"># 输出：mag</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test3'</span>,<span class="string">'a+'</span>)</span><br><span class="line">f.write(<span class="string">'edu'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test3</span><br><span class="line"><span class="comment"># 输出：magedu</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test3'</span>,<span class="string">'x+'</span>)</span><br><span class="line"><span class="comment"># 因为文件已存在，报错："FileExistsError: [Errno 17] File exists: 'test3'"</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'x+'</span>)</span><br><span class="line">f.write(<span class="string">'python'</span>)</span><br><span class="line">f.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cat test4</span><br><span class="line"><span class="comment"># 输出：python</span></span><br></pre></td></tr></table></figure>
<p>+</p>
<p>为r、w、a、x提供缺失的读写功能，但是，获取文件对象依旧按照r、w、a、x自己的特征。</p>
<p>+不能单独使用，可以认为它是为前面的模式字符做增强功能的。</p>
<h3 id="文件指针"><a href="#文件指针" class="headerlink" title="文件指针"></a>文件指针</h3><p>上面的例子中，已经说明了有一个指针。</p>
<p>文件指针，指向当前字节位置</p>
<p>mode=r，指针起始在0</p>
<p>mode=a，指针起始在EOF</p>
<p><code>tell()</code>显示指针当前位置</p>
<p><code>seek(offset[,whence])</code>移动文件指针位置。offset偏移多少字节，whence从哪里开始。</p>
<p>文件模式下</p>
<p>whence 0 缺省值，表示从头开始，offset只能正整数</p>
<p>whence 1 表示从当前位置，offset只接受0</p>
<p>whence 2表示从EOF开始，offset只接受0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文本模式</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'r+'</span>)</span><br><span class="line">f.tell()   <span class="comment"># 起始</span></span><br><span class="line">f.read()</span><br><span class="line">f.tell()   <span class="comment"># EOF</span></span><br><span class="line">f.seek(<span class="number">0</span>)   <span class="comment"># 起始</span></span><br><span class="line">f.read()</span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">f.read()</span><br><span class="line"><span class="comment"># 上面seek设置从索引2开始，跳过0个字符后，这里输出：thon</span></span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">1</span>)   <span class="comment"># offset必须为0</span></span><br><span class="line"><span class="comment"># 报错：“UnsupportedOperation: can't do nonzero cur-relative seeks”</span></span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">2</span>)   <span class="comment"># offset必须为0</span></span><br><span class="line"><span class="comment"># 报错：“UnsupportedOperation: can't do nonzero cur-relative seeks”</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 中文 </span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'w+'</span>)</span><br><span class="line">f.write(<span class="string">'马哥教育'</span>)</span><br><span class="line">f.tell()</span><br><span class="line">f.close()</span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'r+'</span>)</span><br><span class="line">f.read(<span class="number">3</span>)</span><br><span class="line"><span class="comment"># 输出：'马哥教'，f.read(3)表示只显示前三个字符，下面再使用read方法时就不会再显示前三个字符了，但如果</span></span><br><span class="line"><span class="comment"># 这里读了多于整个字符数量的值，如f.read(7)，下面就不能再读出任何内容了。</span></span><br><span class="line">f.seek(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 输出：1，表示当前位置是1。这里如果使用f.seek(3)就可以显示出第二个中文了，所以说明三个字节是一个中文。并且使用f.read()显示的是后三个中文，也就是跳过了第一个中文。</span></span><br><span class="line">f.tell()</span><br><span class="line"><span class="comment"># 这里输出的二进制的位置？</span></span><br><span class="line">f.read()</span><br><span class="line"><span class="comment"># 报错："UnicodeDecodeError: 'utf-8' codec can't decode byte 0xa9 in position 0: invalid start byte"，因为是二进制方式输入的，上面又移动的指针位置，所以这里报错</span></span><br><span class="line">f.seek(<span class="number">2</span>) <span class="comment"># f.seek(3)</span></span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>文本模式支持从开头向后偏移的方式。</p>
<p>whence为1表示从当前位置开始偏移，但是只支持偏移0，相当于原地不动，所以没什么用。</p>
<p>whence为2表示从EOF开始，只支持偏移0，相当于移动文件指针到EOF。</p>
<p>seek是按照字节偏移的。</p>
<p>二进制模式下</p>
<p>whence 0 缺省值，表示从头开始，offset只能正整数</p>
<p>whence 1 表示从当前位置，offset可正可负</p>
<p>whence 2 表示从EOF开始，offset可正可负</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 二进制模式</span></span><br><span class="line">f = open(<span class="string">'test'</span>,<span class="string">'rb+'</span>)</span><br><span class="line">f.tell()   <span class="comment"># 起始</span></span><br><span class="line">f.read()</span><br><span class="line">f.tell()   <span class="comment"># EOF</span></span><br><span class="line">f.write(<span class="string">b'abc'</span>)</span><br><span class="line">f.seek(<span class="number">0</span>)   <span class="comment"># 起始</span></span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">1</span>)   <span class="comment"># 从当前指针开始，向后2</span></span><br><span class="line">f.read()</span><br><span class="line">f.seek(<span class="number">-2</span>,<span class="number">2</span>)   <span class="comment"># 从当前指针开始，向前2</span></span><br><span class="line"></span><br><span class="line">f.seek(<span class="number">2</span>,<span class="number">2</span>)   <span class="comment"># 从EOF开始，向后2</span></span><br><span class="line">f.seek(<span class="number">0</span>)</span><br><span class="line">f.seek(<span class="number">-2</span>,<span class="number">2</span>)   <span class="comment"># 从EOF开始，向前2</span></span><br><span class="line">f.read()</span><br><span class="line"></span><br><span class="line">f.seek(<span class="number">-20</span>,<span class="number">2</span>)   <span class="comment"># OSError</span></span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>二进制模式支持任意起点的偏移，从头、从尾、从中间位置开始。</p>
<p>向后seek可以超界，但是向前seek的时候，不能超界，否则抛异常。</p>
<h3 id="buffering：缓冲区"><a href="#buffering：缓冲区" class="headerlink" title="buffering：缓冲区"></a>buffering：缓冲区</h3><p>-1 表示使用缺省大小的buffer。如果是二进制模式，使用io.DEFAULT_BUFFER_SIZE值，默认是4096或者8192。如果是文本模式，如果是终端设备，是行缓存方式，如果不是，则使用二进制模式的策略。</p>
<ul>
<li>0 只在二进制模式使用，表示关buffer</li>
<li>1 只在文本模式使用，表示使用行缓冲。意思就是见到换行符就flush</li>
<li>大于1用于指定buffer的大小</li>
</ul>
<p>buffer缓冲区</p>
<p>缓冲区一个内存空间，一般来说是一个FIFO队列，到缓冲区满了或者达到阈值，数据才会flush到磁盘。</p>
<p><code>flush()</code>将缓冲区数据写入磁盘</p>
<p><code>close()</code>关闭前会调用<code>flush()</code></p>
<p><code>io.DEFAULT_BUFFER_SIZE</code>缺省缓冲区大小，字节</p>
<p>二进制模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'w+b'</span>)</span><br><span class="line">print(io.DEFAULT_BUFFER_SIZE)</span><br><span class="line"><span class="comment"># 输出是8192</span></span><br><span class="line">f.write(<span class="string">"magedu.com"</span>.encode())</span><br><span class="line"><span class="comment"># cat test4</span></span><br><span class="line"><span class="comment"># 输出是magedu.com，但上面如果不使用f.close()关闭文件，这里是查看不到的。</span></span><br><span class="line">f.seek(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">"www.magedu.com"</span>.encode())</span><br><span class="line">f.flush()</span><br><span class="line"><span class="comment"># 使用flush方法后，就可以使用cat查看文件了，无需使用close方法关闭文件</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'w+b'</span>,<span class="number">4</span>)</span><br><span class="line">f.write(<span class="string">b"mag"</span>)</span><br><span class="line"><span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b'edu'</span>)</span><br><span class="line"><span class="comment"># cat test4</span></span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>文本模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># buffering=1，使用行缓冲</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'w+'</span>,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 读写方式打开test4，使用行缓冲</span></span><br><span class="line">f.write(<span class="string">"mag"</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">"magedu"</span>*<span class="number">4</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">'\n'</span>)   <span class="comment"># cat test4</span></span><br><span class="line"><span class="comment"># 写入一个换行符</span></span><br><span class="line">f.write(<span class="string">'Hello\nPython'</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># buffering&gt;1，使用指定大小的缓冲区</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'w+'</span>,<span class="number">15</span>)</span><br><span class="line">f.write(<span class="string">"mag"</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">'edu'</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">'Hello\n'</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">'\nPython'</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">'a'</span> * (io.DEFAULT_BUFFER_SIZE - <span class="number">20</span>))   </span><br><span class="line"><span class="comment"># 设置为大于1没什么用，这里的io.DEFAULT_BUFFER_SIZE还是8192</span></span><br><span class="line">f.write(<span class="string">'\nwww.magedu.com/python'</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># buffering=0 这是一种特殊的二进制模式，不需要内存的buffer，可以看做是一个FIFO的文件</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'wb+'</span>,<span class="number">0</span>)</span><br><span class="line">f.write(<span class="string">b"m"</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b"a"</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b"g"</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b"magedu"</span>*<span class="number">4</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b'\n'</span>)   <span class="comment"># cat test4</span></span><br><span class="line">f.write(<span class="string">b'Hello\nPython'</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>buffering</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>buffering=-1</td>
<td>t和b，都是io.DEFAULT_BUFFER_SIZE</td>
</tr>
<tr>
<td>buffering=0</td>
<td>b：关闭缓冲区；t：不支持</td>
</tr>
<tr>
<td>buffering=1</td>
<td>b：就1个字节；t：行缓冲，遇到换行符才flush</td>
</tr>
<tr>
<td>buffering&gt;1</td>
<td>b模式表示行缓冲大小。缓冲区的值可以超过io.DEFAULT_BUFFER_SIZE，直到设定的值超出后才把缓冲区flush；t模式，是io.DEFAULT_BUFFER_SIZE，flush完后把当前字符串也写入磁盘</td>
</tr>
</tbody>
</table>
<p>似乎看起来很麻烦，一般来说，只需要记得：</p>
<ol>
<li>文本模式，一般都用默认缓冲区大小</li>
<li>二进制模式，是一个个字节的操作，可以指定buffer的大小</li>
<li>一般来说，默认缓冲区大小是个比较好的选择，除非明确知道，否则不调整它</li>
<li>一般编程中，明确知道需要写磁盘了，都会手动调用一次flush，而不是等到自动flush或者close的时候</li>
</ol>
<h3 id="encoding：编码，仅文本模式使用"><a href="#encoding：编码，仅文本模式使用" class="headerlink" title="encoding：编码，仅文本模式使用"></a>encoding：编码，仅文本模式使用</h3><p>None表示使用缺省编码，依赖操作系统。windows、linux下测试如下代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'test1'</span>,<span class="string">'w'</span>)</span><br><span class="line">f.write(<span class="string">'啊'</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>windows下缺省GBK(0xB0A1)，linux下缺省UTF-8(0xE5 95 8A)</p>
<h3 id="其他参数"><a href="#其他参数" class="headerlink" title="其他参数"></a>其他参数</h3><h4 id="errors"><a href="#errors" class="headerlink" title="errors"></a>errors</h4><p>什么样的编码错误将被捕获</p>
<p>None和strict表示有编码错误将抛出ValueError异常；ignore表示忽略</p>
<h4 id="newline"><a href="#newline" class="headerlink" title="newline"></a>newline</h4><p>文本模式中，换行的转换。可以为<code>None、&#39;&#39;空串、&#39;\r&#39;、&#39;\n&#39;、&#39;\r\n&#39;</code></p>
<p>读时，None表示<code>&#39;\r&#39;、&#39;\n&#39;、&#39;\r\n&#39;</code>都被转换为<code>&#39;\n&#39;</code>；’’表示不会自动转换通用换行符；其他合法字符表示换行符就是指定字符，就会按照指定字符分行</p>
<p>写时，None表示<code>&#39;\n&#39;</code>都会被替换为系统缺省行分隔符os.linesep；<code>&#39;\n&#39;</code>或表示<code>&#39;\n&#39;</code>不替换；其他合法字符表示<code>&#39;\n&#39;</code>会被替换为指定的字符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'o:/test'</span>,<span class="string">'w'</span>)</span><br><span class="line">f.write(<span class="string">'python\rwww.python.org\nwww.magedu.com\r\npython3'</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 测试中，上面的第一个\r没起作用，\r前的内容没被写入test文件</span></span><br><span class="line"></span><br><span class="line">newlines = [<span class="keyword">None</span>,<span class="string">''</span>,<span class="string">'\n'</span>,<span class="string">'\r\n'</span>]</span><br><span class="line"><span class="keyword">for</span> n1 <span class="keyword">in</span> newlines:</span><br><span class="line">    f = open(<span class="string">'o:/test'</span>,<span class="string">'r+'</span>,newline=n1)   <span class="comment"># 缺省替换所有换行符</span></span><br><span class="line">    print(f.readlines())</span><br><span class="line">    f.close()</span><br><span class="line"><span class="comment"># 输出中分隔符不同，结果也不同</span></span><br><span class="line"><span class="comment"># ['abc\n', 'www.python.org\n', 'www.magedu.com\n', 'python3']</span></span><br><span class="line"><span class="comment"># ['abc\r', 'www.python.org\n', 'www.magedu.com\r\n', 'python3']</span></span><br><span class="line"><span class="comment"># ['abc\rwww.python.org\n', 'www.magedu.com\r\n', 'python3']</span></span><br><span class="line"><span class="comment"># ['abc\rwww.python.org\nwww.magedu.com\r\n', 'python3']</span></span><br></pre></td></tr></table></figure>
<h4 id="closefd"><a href="#closefd" class="headerlink" title="closefd"></a>closefd</h4><p>关闭文件描述符，True表示关闭它。False会在文件关闭后保持这个描述符。<code>fileobj.fileno()</code>查看</p>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><p><code>read(size=-1)</code>，size表示读取的多少个字符或字节；负数或者None表示读取到EOF</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'o:/test4'</span>,<span class="string">'r+'</span>,<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 这里不能把buffer设置为0，使其关闭，因为这是以文本方式打开的，所以这里报错：</span></span><br><span class="line"><span class="comment"># "ValueError: can't have unbuffered text I/O"</span></span><br><span class="line">f.write(<span class="string">"magedu"</span>)</span><br><span class="line">f.write(<span class="string">'\n'</span>)</span><br><span class="line">f.write(<span class="string">'马哥教育'</span>)</span><br><span class="line">f.seek(<span class="number">0</span>)</span><br><span class="line">f.read(<span class="number">7</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 二进制</span></span><br><span class="line">f = open(<span class="string">'test4'</span>,<span class="string">'rb+'</span>)</span><br><span class="line">f.read(<span class="number">7</span>)</span><br><span class="line">f.read(<span class="number">1</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<h3 id="行读取"><a href="#行读取" class="headerlink" title="行读取"></a>行读取</h3><p><code>readline(size=-1)</code>一行行读取文件内容。size设置一次能读取行内几个字符或字节</p>
<p><code>readlines(hint=-1)</code>读取所有行的列表。指定hint则返回指定的行数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按行迭代</span></span><br><span class="line">f = open(<span class="string">'test'</span>)   <span class="comment"># 返回可迭代对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">    print(line)</span><br><span class="line"><span class="comment"># 这与readline方法的效果一样，输出一行内容    </span></span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># abc</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># www.python.org</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># www.magedu.com</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># python3</span></span><br><span class="line"><span class="comment"># &lt;function TextIOWrapper.close()&gt;</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test'</span>)</span><br><span class="line">f.readlines()</span><br><span class="line"><span class="comment"># 输出：['abc\n', 'www.python.org\n', 'www.magedu.com\n', 'python3']</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'test'</span>)</span><br><span class="line">f.readline()</span><br><span class="line"><span class="comment"># 输出：'abc\n'，这是test文件的第一行内容</span></span><br></pre></td></tr></table></figure>
<h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><p>write(s)，把字符串s写入到文件中并返回字符的个数</p>
<p><code>writelines(lines)</code>，将字符串列表写入文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'test'</span>,<span class="string">'w+'</span>)</span><br><span class="line"></span><br><span class="line">lines = [<span class="string">'abc'</span>,<span class="string">'123\n'</span>,<span class="string">'magedu'</span>]   <span class="comment"># 提供换行符</span></span><br><span class="line">f.writelines(lines)</span><br><span class="line"></span><br><span class="line">f.seek(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 写入后，记得要将指针移动到开头，不然指针是在最后的，什么也打印不出来</span></span><br><span class="line">print(f.read())</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># abc123</span></span><br><span class="line"><span class="comment"># magedu</span></span><br></pre></td></tr></table></figure>
<h3 id="close"><a href="#close" class="headerlink" title="close"></a>close</h3><p>flush并关闭文件对象。文件已经关闭，再次关闭没有任何效果。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><code>seekable()</code>是否可seek</p>
<p><code>readable()</code>是否可读</p>
<p><code>writable()</code>是否可写</p>
<p><code>closed</code>是否已经关闭</p>
<h3 id="上下文管理"><a href="#上下文管理" class="headerlink" title="上下文管理"></a>上下文管理</h3><h4 id="问题的引出"><a href="#问题的引出" class="headerlink" title="问题的引出"></a>问题的引出</h4><p>在linux中，执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面必须这么写</span></span><br><span class="line">lst = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">2000</span>):</span><br><span class="line">    lst.append(open(<span class="string">'test'</span>))</span><br><span class="line"><span class="comment"># OSError: [Errno 24] Too many open files: 'test'</span></span><br><span class="line"></span><br><span class="line">print(len(lst))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># 978</span></span><br><span class="line"><span class="comment"># The history saving thread hit an unexpected error (OperationalError('unable to open database file')).History will not be written to the database.</span></span><br><span class="line"></span><br><span class="line">lsof 列出打开的文件。没有就用yum install lsof</span><br><span class="line"><span class="comment"># 查看打开test文件的PID号，比如是用jupeter打开的，可以用lsof | grep jupeter查看PID，第二列就是PID</span></span><br><span class="line"><span class="comment"># 因为是打开test文件但没有关闭引起的报错，所以这里要查看打开test文件的PID号</span></span><br><span class="line">lsof -p <span class="number">1427</span> | grep test | wc -l</span><br><span class="line"><span class="comment"># 通过PID查看一共打开了多少次test</span></span><br><span class="line">lsof -p 进程号</span><br><span class="line">ulimit -a 查看所有限制。其中open files或file descriptors就是打开文件数的限制，默认<span class="number">1024</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> lst:</span><br><span class="line">    x.close()</span><br><span class="line"><span class="comment"># 将文件一次关闭，然后就可以继续打开了。再看一次lsof</span></span><br></pre></td></tr></table></figure>
<p><strong><em>有一些任务，可能事先需要设置，事后做清理工作。对于这种场景，Python的with语句提供了一种非常方便的处理方式。一个很好的例子是文件处理，你需要获取一个文件句柄，从文件中读取数据，然后关闭文件句柄。</em></strong></p>
<p>如何解决？</p>
<ol>
<li>异常处理</li>
</ol>
<p>当出现异常的时候，拦截异常。但是，因为很多代码都可能出现OSError异常，还不好判断异常就是因为资源限制产生的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'test'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    f.write(<span class="string">"abc"</span>)   <span class="comment"># 文件只读，写入失败</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    f.close()    <span class="comment"># 这样才行</span></span><br><span class="line"><span class="comment"># 使用finally可以保证打开的文件可以被关闭</span></span><br><span class="line"><span class="comment"># 虽然这段代码运行良好，但是太冗长了。这时候就是with一展身手的时候了。除了有更优雅的语法，with还可以很</span></span><br><span class="line"><span class="comment"># 好的处理上下文环境产生的异常。</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>上下文管理</li>
</ol>
<p>一种特殊的语法，交给解释器去释放文件对象</p>
<p>with工作原理</p>
<ul>
<li><p>基本思想是with所求值的对象必须有一个<code>__enter__()</code>方法，一个<code>__exit__()</code>方法。</p>
</li>
<li><p>紧跟with后面的语句被求值后，返回对象的<code>__enter__()</code>方法被调用，这个方法的返回值将被赋值给as后面的变量；</p>
</li>
<li>当with后面的代码块全部被执行完之后，将调用前面返回对象的<code>__exit__()</code>方法。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> f</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'test'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">"abc"</span>)   <span class="comment">#  文件只读，写入失败</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 测试f是否关闭</span></span><br><span class="line">f.closed   <span class="comment"># f的作用域</span></span><br><span class="line"><span class="comment"># 输出："TypeError: 'bool' object is not callable"，因为已经关闭了，所以报错</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果有多项，可以写成</span></span><br><span class="line">With open(<span class="string">'1.txt'</span>) <span class="keyword">as</span> f1, open(<span class="string">'2.txt'</span>) <span class="keyword">as</span>  f2:</span><br><span class="line">    do something</span><br></pre></td></tr></table></figure>
<p>上下文管理</p>
<ol>
<li>使用with … as 关键字</li>
<li>上下文管理的语句块并不会开启新的作用域</li>
<li>with 语句块执行完的时候，会自动关闭文件对象</li>
</ol>
<p>另一种写法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">f1 = open(<span class="string">'test'</span>)</span><br><span class="line"><span class="keyword">with</span> f1:</span><br><span class="line">    f1.write(<span class="string">"abc"</span>)   <span class="comment"># 文件只读，写入失败</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 测试f是否关闭</span></span><br><span class="line">f1.closed   <span class="comment"># f1的作用域</span></span><br></pre></td></tr></table></figure>
<p>对于类似于文件对象的IO对象，一般来说都需要在不使用的时候关闭、注销、以释放资源。IO被打开的时候，会获得一个文件描述符。计算机资源是有限的，所以操作系统都会做限制。就是为了保护计算机的资源不要被完全耗尽，计算资源是共享的，不是独占的。一般情况下，除非特别明确的知道资源情况，否则不要提高资源的限制值来解决问题。</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><h4 id="指定一个源文件，实现copy到目标目录"><a href="#指定一个源文件，实现copy到目标目录" class="headerlink" title="指定一个源文件，实现copy到目标目录"></a>指定一个源文件，实现copy到目标目录</h4><p>例如把/tmp/test.txt拷贝到/tmp/test1.txt</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">filename1 = <span class="string">'/tmp/test.txt'</span></span><br><span class="line">filename2 = <span class="string">'/tmp/test1.txt'</span></span><br><span class="line"></span><br><span class="line">f = open(filename1, <span class="string">'w+'</span>)</span><br><span class="line">lines = [<span class="string">'abc'</span>,<span class="string">'123'</span>,<span class="string">'magedu'</span>]</span><br><span class="line">f.writelines(<span class="string">'\n'</span>.join(lines))</span><br><span class="line"><span class="comment"># 使用\n作为分隔符将lines列表中的元素连接起来，这时通过join方法已经将连接下来的元素变成了字符串。再把</span></span><br><span class="line"><span class="comment"># 这个字符串写入filename1文件中</span></span><br><span class="line">f.seek(<span class="number">0</span>)</span><br><span class="line">print(f.read())</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy</span><span class="params">(src,dest)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(src) <span class="keyword">as</span> f1:</span><br><span class="line">        <span class="keyword">with</span> open(dest, <span class="string">'w'</span>) <span class="keyword">as</span> f2:</span><br><span class="line">            f2.write(f1.read())</span><br><span class="line"><span class="comment"># 定义一个函数，设置两个参数，使用目录文件的写方法写入从源文件中读取到的内容            </span></span><br><span class="line">copy(filename1, filename2)</span><br></pre></td></tr></table></figure>
<h4 id="有一个文件，对其进行单词统计，不区分大小写，并显示单词重复最多的10个单词"><a href="#有一个文件，对其进行单词统计，不区分大小写，并显示单词重复最多的10个单词" class="headerlink" title="有一个文件，对其进行单词统计，不区分大小写，并显示单词重复最多的10个单词"></a>有一个文件，对其进行单词统计，不区分大小写，并显示单词重复最多的10个单词</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">简单处理后，大概的得数如下：</span><br><span class="line">the, <span class="number">136</span></span><br><span class="line"><span class="keyword">is</span>, <span class="number">60</span></span><br><span class="line">a, <span class="number">54</span></span><br><span class="line">path, <span class="number">52</span></span><br><span class="line"><span class="keyword">if</span>, <span class="number">42</span></span><br><span class="line"><span class="keyword">and</span>, <span class="number">39</span></span><br><span class="line">to, <span class="number">34</span></span><br><span class="line">of, <span class="number">33</span></span><br><span class="line">on, <span class="number">32</span></span><br><span class="line"><span class="keyword">return</span>, <span class="number">30</span></span><br><span class="line"><span class="comment"># 上面是以空格为分隔的结果，这里的path与下面统计的数量不一样，因为分隔符不一样</span></span><br><span class="line">实际上有效的path很多，作为合法的单词path统计应该有<span class="number">100</span>多个。对单词做进一步处理后，统计如下：</span><br><span class="line">path, <span class="number">137</span></span><br><span class="line">the, <span class="number">136</span></span><br><span class="line"><span class="keyword">is</span>, <span class="number">60</span></span><br><span class="line">a, <span class="number">59</span></span><br><span class="line">os, <span class="number">50</span></span><br><span class="line"><span class="keyword">if</span>, <span class="number">43</span></span><br><span class="line"><span class="keyword">and</span>, <span class="number">40</span></span><br><span class="line">to, <span class="number">34</span></span><br><span class="line">of, <span class="number">33</span></span><br><span class="line">on, <span class="number">33</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最好使用字典来实现此题，到目前为止学过的时间复杂度为O(1)的数据结构只有set和dict</span></span><br><span class="line"><span class="comment"># 大的数据统计都用字典这种数据结构，关键是如何分词，如果断开，英文一般用空格。中文要用分词库，比较麻烦。</span></span><br><span class="line"></span><br><span class="line">复制sample.txt文件到指定目录</span><br><span class="line">d = &#123;&#125;</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'sample'</span>, encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        words = line.split()   <span class="comment"># 以默认的空白字符串作为分隔符将line分开，放入words列表中</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> map(str.lower, words):  </span><br><span class="line">            <span class="comment"># lower表示全部小写，map将words都改为小写，再重组成元组，之后迭代这个元组</span></span><br><span class="line">            <span class="comment"># print(12345, word)</span></span><br><span class="line"><span class="comment"># word是一个个以空格分隔后的单词或字符</span></span><br><span class="line">            d[word] = d.get(word,<span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">print(sorted(d.items(), key=<span class="keyword">lambda</span> item:item[<span class="number">1</span>], reverse=<span class="keyword">True</span>))</span><br><span class="line"><span class="comment"># 这里的item是自定义的名称，也可以定义成其他名字</span></span><br><span class="line"><span class="comment"># 1. 定义一个空字典</span></span><br><span class="line"><span class="comment"># 2. 以utf8编码打开目标文件</span></span><br><span class="line"><span class="comment"># 3. 循环目录文件中的每一行，将循环的结果以默认的空白字符串作为分隔符将line分开，并将生成的字符串放入</span></span><br><span class="line"><span class="comment"># words列表中。这是将每一行生成一个列表并对其中的每个单词进行处理。</span></span><br><span class="line"><span class="comment"># 4. 使用字符串的lower将words列表中的所有字母变为小写，再用map生成一个元组，并进行循环。map函数会使用</span></span><br><span class="line"><span class="comment"># 参数中定义的str.lower方法，把第二个参数送进来的列表或字符串中的元素变成一个个单独的元素，并再次组成列</span></span><br><span class="line"><span class="comment"># 表。因为str的方法本来就会把字符串分成一个个单独的元素。</span></span><br><span class="line"><span class="comment"># 5. 从字典d中获取word这个键的值，如果没有值就将值设置为0加1，因为最少也会出现一次，所以这样设置，如果</span></span><br><span class="line"><span class="comment"># 将默认值设置为1，那么再加任何值都不能符合出现的单词的数量的实际情况</span></span><br><span class="line"><span class="comment"># 6. 最后使用sorted将d的键值排序，排序的标准使用item[1]也就是键值对中的值进行排序，reverse=True表示</span></span><br><span class="line"><span class="comment"># 降序排列，默认是升序</span></span><br><span class="line"><span class="comment"># 对于sorted(d.items(), key=lambda item:item[1], reverse=True，找到一条解释，sorted(d.items(), key=lambda x: x[1]) 中 d.items() 为待排序的对象；key=lambda x: x[1] 为对前面的对象中的第二维数据（即value）的值进行排序。 key=lambda 变量：变量[维数] 。维数可以按照自己的需要进行设置。举例：sorted(d.items(), key = lambda d:len(d[1]), reverse = True)，似乎在sorted函数中可以通过lambda s:s[1]这种方式使用匿名函数，在这里s就相当于要排序的元素，索引值指定了要按哪一项排序</span></span><br><span class="line"></span><br><span class="line">=======================================================================================</span><br><span class="line">map()函数测试</span><br><span class="line">a=(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">b=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">c=<span class="string">"zhangkang"</span></span><br><span class="line"></span><br><span class="line">la=map(str,a)</span><br><span class="line">lb=map(str,b)</span><br><span class="line">lc=map(str,c)</span><br><span class="line"></span><br><span class="line">print(la)</span><br><span class="line">print(lb)</span><br><span class="line">print(lc)</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>]</span><br><span class="line">[<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>]</span><br><span class="line">[<span class="string">'z'</span>, <span class="string">'h'</span>, <span class="string">'a'</span>, <span class="string">'n'</span>, <span class="string">'g'</span>, <span class="string">'k'</span>, <span class="string">'a'</span>, <span class="string">'n'</span>, <span class="string">'g'</span>]</span><br><span class="line"><span class="comment"># str()是python的内置函数，这个例子是把列表/元组/字符串的每个元素变成了str类型，然后以列表的形式返回。当然我们也可以传入自定义的函数，看下面的例子。</span></span><br><span class="line">=======================================================================================</span><br><span class="line"><span class="comment"># 得数如下：</span></span><br><span class="line"><span class="comment"># the, 136</span></span><br><span class="line"><span class="comment"># is, 60</span></span><br><span class="line"><span class="comment"># a, 54</span></span><br><span class="line"><span class="comment"># path, 52</span></span><br><span class="line"><span class="comment"># if, 42</span></span><br><span class="line"><span class="comment"># and, 39</span></span><br><span class="line"><span class="comment"># to, 34</span></span><br><span class="line"><span class="comment"># of, 33</span></span><br><span class="line"><span class="comment"># on, 32</span></span><br><span class="line"><span class="comment"># return, 30</span></span><br></pre></td></tr></table></figure>
<p>这是帮助文档中python的文档，path应该很多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> d.keys():</span><br><span class="line">    <span class="keyword">if</span> k.find(<span class="string">'path'</span>) &gt; <span class="number">-1</span>:</span><br><span class="line">        print(k)</span><br></pre></td></tr></table></figure>
<p>使用上面的代码，就可以看到path非常多</p>
<p>os.path.exists(path) 可以认为含有2个path。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makekey</span><span class="params">(s:str)</span>:</span>  <span class="comment"># 这里送进来的参数一定是字符串</span></span><br><span class="line">    chars = set(<span class="string">r"""!'"#./\()[],*-"""</span>)   <span class="comment"># 定义一个集合，其中的字符不要转义</span></span><br><span class="line">    key = s.lower()</span><br><span class="line"><span class="comment"># 这里的s已经是被下面的方法使用空白字符串分割过一次的单词的列表了</span></span><br><span class="line">    ret = []</span><br><span class="line">    <span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(key):  <span class="comment"># 给每个元素加上序号</span></span><br><span class="line"><span class="comment"># 因为送进来的s的值是一个个单独的字符串元素，所以这里加入序号后进行判断，如果属于chars变量中定义的内容</span></span><br><span class="line"><span class="comment"># 就向ret列表中追加一个空格，否则追加元素本身的值。最后再用空字符串将ret中的元素连接起来，以空格为分割</span></span><br><span class="line"><span class="comment"># 符，这样就等于重新组合了一次s送进来的值，也就将os.path.sameopenfile(fp1这样的值分的更细了，因为这</span></span><br><span class="line"><span class="comment"># 本身就是一堆不同的单词用符号连接起来了</span></span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> chars:</span><br><span class="line">            ret.append(<span class="string">' '</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ret.append(c)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(ret).split()</span><br><span class="line"></span><br><span class="line">d = &#123;&#125;</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'sample'</span>,encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        words = line.split()</span><br><span class="line">        <span class="keyword">for</span> wordlist <span class="keyword">in</span> map(makekey,words):</span><br><span class="line">            <span class="comment"># 这里使用上面定义的makekey来分割words中的字符串元素，再组成一个新列表</span></span><br><span class="line">            <span class="comment"># 这等于将line分割了两次，第一次用空白字符串，第二次用makekey函数中的方法</span></span><br><span class="line">            <span class="keyword">for</span> word <span class="keyword">in</span> wordlist:</span><br><span class="line">                d[word] = d.get(word,<span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">                </span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> sorted(d.items(),key=<span class="keyword">lambda</span> item: item[<span class="number">1</span>],reverse=<span class="keyword">True</span>):</span><br><span class="line">	print(k,v)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 对单词做进一步处理后，统计如下：</span></span><br><span class="line">path, <span class="number">137</span></span><br><span class="line">the, <span class="number">136</span></span><br><span class="line"><span class="keyword">is</span>, <span class="number">60</span></span><br><span class="line">a, <span class="number">59</span></span><br><span class="line">os, <span class="number">50</span></span><br><span class="line"><span class="keyword">if</span>, <span class="number">43</span></span><br><span class="line"><span class="keyword">and</span>, <span class="number">40</span></span><br><span class="line">to, <span class="number">34</span></span><br><span class="line">of, <span class="number">33</span></span><br><span class="line">on, <span class="number">33</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>分割key的另一种思路</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makekey</span><span class="params">(s:str)</span>:</span></span><br><span class="line">    chars = set(<span class="string">r"""!'"#./\()[],*-"""</span>)</span><br><span class="line">    key = s.lower()   <span class="comment"># 这个key是一个字符串类型</span></span><br><span class="line">    ret = []</span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    length = len(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(key):</span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> chars: <span class="comment"># 这是把find的过程变成了一遍遍历完</span></span><br><span class="line">            <span class="keyword">if</span> start == i:   <span class="comment"># 如果紧挨着还是特殊字符，start一定等于i</span></span><br><span class="line">            	start += <span class="number">1</span>   <span class="comment"># 加1并continue</span></span><br><span class="line">            	<span class="keyword">continue</span></span><br><span class="line">        	ret.append(key[start:i])</span><br><span class="line">        	start = i + <span class="number">1</span>   <span class="comment"># 加1是跳过这个不需要的特殊字符c</span></span><br><span class="line"><span class="comment"># 这里进行判断，如果c属于chars这个变量中的特殊符号，那么就向下再判断，如果start变量和i变量相等，就把</span></span><br><span class="line"><span class="comment"># start加1并跳出循环。这时的情况是，如果传入的第一个c元素是标点符号，就把start变量加1并跳出循环，如果</span></span><br><span class="line"><span class="comment"># 这里不是特殊符号，不考虑下面的语句那么就会跳过，重新进入循环，直到再次需到特殊符号，这时再判断时，</span></span><br><span class="line"><span class="comment"># start与i变量一定是不相等的，也就可以追加从start到i的值到ret列表中了，这时这段追加的内容就是非特殊符</span></span><br><span class="line"><span class="comment"># 号的索引值。这时的start是上一个特殊符号的索引值加1，i的值是现在的特殊符号的索引值，前包后不包的原则，</span></span><br><span class="line"><span class="comment"># 追加的就是非特殊符号的字符串元素。如果第一个字符串元素不是特殊符号，那么就会跳过本次循环，直到需到特殊</span></span><br><span class="line"><span class="comment"># 符号，这时就可以以从start到i的值为索引值追加元素到列表了。追加后还要新start的值调整为目前的i值加1，</span></span><br><span class="line"><span class="comment"># 这是标记了下一个索引值起始的位置。大部分的非特殊符号都是从这里追加到列表中的。</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> start &lt; len(key):   <span class="comment"># 小于，说明还有有效的字符，而且一直到末尾</span></span><br><span class="line">            ret.append(key[start:])</span><br><span class="line"><span class="comment"># 如果不符合上面的条件，这时的start应该已经到了最后的非特殊字符的索引位置了，如果这个索引值比字符串整体</span></span><br><span class="line"><span class="comment"># 的长度小，加为start一直是加1的，所以应该和字符串的长度是一样的。这时就把从start这个索引值到最后的所</span></span><br><span class="line"><span class="comment"># 有字符串元素追加到列表中。这一段就是处理最后一段非特殊符号元素的，这里已经和上面的i和c变量没关系了，也</span></span><br><span class="line"><span class="comment"># 就是循环都正常执行完后，会再执行一次这段代码。</span></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">print(makekey(<span class="string">'os.path.exists(path)'</span>))</span><br><span class="line">print(makekey(<span class="string">'os.path.-exists(path)'</span>))</span><br><span class="line">print(makekey(<span class="string">'path.os...'</span>))</span><br><span class="line">print(makekey(<span class="string">'path'</span>))</span><br><span class="line">print(makekey(<span class="string">'path-p'</span>))</span><br><span class="line">print(makekey(<span class="string">'***...'</span>))</span><br><span class="line">print(makekey(<span class="string">''</span>))</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/03/nginx问题解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/03/nginx问题解决/" itemprop="url">
                  nginx问题解决
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-12-03 17:00:29" itemprop="dateCreated datePublished" datetime="2019-12-03T17:00:29+08:00">2019-12-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="反向代理二级域名"><a href="#反向代理二级域名" class="headerlink" title="反向代理二级域名"></a>反向代理二级域名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 172.24.211.110;</span><br><span class="line">    root /usr/share/nginx/html;</span><br><span class="line">    access_log /var/log/nginx/access-oss.log;</span><br><span class="line">    location /bajia-images/ &#123;</span><br><span class="line">        proxy_pass  http://bajia-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /chaowai-images/ &#123;</span><br><span class="line">        proxy_pass http://chaowai-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    location /miyun-images/ &#123;</span><br><span class="line">        proxy_pass http://miyun-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /zhihuixiangcun-images/ &#123;</span><br><span class="line">        proxy_pass http://zhihuixiangcun-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-music/ &#123;</span><br><span class="line">        proxy_pass http://family-music.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-photo/ &#123;</span><br><span class="line">        proxy_pass http://family-photo20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-user/ &#123;</span><br><span class="line">        proxy_pass http://family-user20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-video/ &#123;</span><br><span class="line">        proxy_pass http://family-video20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location /wxfwh-images/ &#123;</span><br><span class="line">        proxy_pass http://wxfwh-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里需要注意的是，proxy_pass的地址最后一定要有/，这样访问二级域名时，就会被反向代理到其对应的地址。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如访问http://172.16.211.110/wxfwh-images/就会被反向代理到</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://wxfwh-images.oss-cn-beijing-internal.aliyuncs.com/，如果不加反向代理地址最后的/，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 那么就会到反向代理地址下找二级域名</span></span><br></pre></td></tr></table></figure>
<h3 id="通过域名解析访问"><a href="#通过域名解析访问" class="headerlink" title="通过域名解析访问"></a>通过域名解析访问</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 问题：以上面的配置文件为例，当使用hosts文件解析域名后，无法通过域名访问反向代理，只能通过IP访问</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name *.gehua.net.cn;</span><br><span class="line">    root /usr/share/nginx/html;</span><br><span class="line">    access_log /var/log/nginx/access-oss.log;</span><br><span class="line">    location /bajia-images/ &#123;</span><br><span class="line">        proxy_pass  http://bajia-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /chaowai-images/ &#123;</span><br><span class="line">        proxy_pass http://chaowai-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    location /miyun-images/ &#123;</span><br><span class="line">        proxy_pass http://miyun-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /zhihuixiangcun-images/ &#123;</span><br><span class="line">        proxy_pass http://zhihuixiangcun-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-music/ &#123;</span><br><span class="line">        proxy_pass http://family-music.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-photo/ &#123;</span><br><span class="line">        proxy_pass http://family-photo20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-user/ &#123;</span><br><span class="line">        proxy_pass http://family-user20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /family-video/ &#123;</span><br><span class="line">        proxy_pass http://family-video20191202.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location /wxfwh-images/ &#123;</span><br><span class="line">        proxy_pass http://wxfwh-images.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为是为oss对象存储做反向代理，希望通过<span class="string">"域名+bucket名+路径"</span>的方式访问，因为域名较多，所以这里使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 泛域名，这样配置后，可以实现以.gehua.net.cn结尾的域名访问，但是之前的IP地址就无法访问了。</span></span><br></pre></td></tr></table></figure>
<h3 id="不同域名反向代理"><a href="#不同域名反向代理" class="headerlink" title="不同域名反向代理"></a>不同域名反向代理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name bajia-images.endpoint.gehua.net.cn;</span><br><span class="line">    access_log /var/log/nginx/access-upload-bajia.log;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://baes.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name chaowai-images.endpoint.gehua.net;</span><br><span class="line">    access_log /var/log/nginx/access-upload-chaowai.log;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://chaages.oss-cn-beijing-internal.aliyuncs.com/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以写成多个server段，第一段使用相同的端口，但使用不同的域名。</span></span><br></pre></td></tr></table></figure>
<h3 id="server-name名称过长"><a href="#server-name名称过长" class="headerlink" title="server_name名称过长"></a>server_name名称过长</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server_name的名称过长，检查配置文件会提示：nginx: [emerg] could not build server_names_hash, you should increase server_names_hash_bucket_size: 64，且无法重新启动。解决方法如下：</span><br><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    server_names_hash_bucket_size 128;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/27/python基础练习-装饰器的应用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/27/python基础练习-装饰器的应用/" itemprop="url">
                  python基础练习-装饰器的应用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-11-27 17:53:16" itemprop="dateCreated datePublished" datetime="2019-11-27T17:53:16+08:00">2019-11-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-06-29 17:57:28" itemprop="dateModified" datetime="2020-06-29T17:57:28+08:00">2020-06-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="装饰器的应用"><a href="#装饰器的应用" class="headerlink" title="装饰器的应用"></a>装饰器的应用</h3><h4 id="一、实现一个cache装饰器，实现可过期被清除的功能"><a href="#一、实现一个cache装饰器，实现可过期被清除的功能" class="headerlink" title="一、实现一个cache装饰器，实现可过期被清除的功能"></a>一、实现一个cache装饰器，实现可过期被清除的功能</h4><p>简化设计，函数的形参定义不包含可变位置参数、可变关键字参数和keyword-only参数，如<code>def add(x=[],y=5)</code>，这样会提示list是不能hash的，可变类型不可作为参数。可以不考虑缓存满了之后的换出问题。</p>
<h4 id="数据类型的选择"><a href="#数据类型的选择" class="headerlink" title="数据类型的选择"></a>数据类型的选择</h4><p>缓存的应用场景，是有数据需要频繁查询，且每次查询都需要大量计算或者等待时间之后才能返回结果的情况，使用缓存来提高查询速度，用空间换取时间。压缩是用时间换空间</p>
<h4 id="cache应该选用什么数据结构？"><a href="#cache应该选用什么数据结构？" class="headerlink" title="cache应该选用什么数据结构？"></a>cache应该选用什么数据结构？</h4><p>便于查询的，且能快速找到数据的数据结构。</p>
<p>每次查询的时候，只要输入一致，就应该得到同样的结果（顺序也一致，例如减法函数，参数顺序不一致，结果不一样）</p>
<p>基于上面的分析，此数据结构应该是字典。</p>
<p>通过一个key，对应一个value。</p>
<p>key是参数列表组成的结构，value是函数返回值。难点在于key如何处理。</p>
<h4 id="key的存储"><a href="#key的存储" class="headerlink" title="key的存储"></a>key的存储</h4><p>key必须是hashable，不把可变类型作为参数</p>
<p>key能接收到位置参数和关键字参数传参</p>
<p>位置参数是被收集在一个tuple中的，本身就有顺序</p>
<p>关键字参数被收集在一个字典中，本身无序，这会带来一个问题，传参的顺序未必是字典中保存的顺序。如何解决？</p>
<p>OrderedDict行吗？可以，它可以记录顺序</p>
<p>不用OrderedDict行吗？可以，用一个tuple保存排过序的字典的item的kv对。</p>
<h4 id="key的异同"><a href="#key的异同" class="headerlink" title="key的异同"></a>key的异同</h4><p>什么才算是相同的key呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="meta">@functools.lru_cache()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,y)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure>
<p>定义一个加法函数，那么传参方式就应该有以下4种：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> add(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line"><span class="number">2.</span> add(<span class="number">4</span>,y=<span class="number">5</span>)</span><br><span class="line"><span class="number">3.</span> add(y=<span class="number">4</span>,x=<span class="number">5</span>)</span><br><span class="line"><span class="number">4.</span> add(x=<span class="number">5</span>,y=<span class="number">4</span>)  <span class="comment"># 测试使用python3.7版本，发现这4种情况都不同，都不使用缓存，只在两次执行add时的参数顺序完全一致时才使用缓存</span></span><br></pre></td></tr></table></figure>
<p>上面4种，可以有下面两种理解：</p>
<p>第一种：3和4相同，1、2、3都不同</p>
<p>第二种：1、2、3、4全部相同</p>
<p>lru_cache实现了第一种，可以看出单独的处理了位置参数和关键字参数。但是函数定义为def add(4,y=5)，使用了默认值，如何理解add(4,5)和add(4)是否一样呢？如果认为一样，那么lru_cache无能为力。就需要使用inspect来自己实现算法</p>
<h4 id="key的要求"><a href="#key的要求" class="headerlink" title="key的要求"></a><strong><em>key的要求</em></strong></h4><p><strong>key必须是hashable</strong>。由于key是所有实参组合而成，而且最好要作为key的，key一定要可以hash，但是如果key有不可hash类型数据，就无法完成。lru_cache就不可以。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add1</span><span class="params">(x,y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> y</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;add1([],<span class="number">5</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@functools.lru_cache()   # 使用缓存时必须可hash，不然会报错。下面分析列表不可hash的原因</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,y=<span class="number">5</span>)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> y</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;add(<span class="number">4</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;add([],<span class="number">5</span>)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">TypeError                                 Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input<span class="number">-4</span><span class="number">-5316606</span>bdb94&gt; <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">      <span class="number">7</span>     <span class="keyword">return</span> y</span><br><span class="line">      <span class="number">8</span> </span><br><span class="line">----&gt; 9 add1([],5)</span><br><span class="line"></span><br><span class="line">TypeError: unhashable type: <span class="string">'list'</span></span><br><span class="line">        </span><br><span class="line">=======================================================================================    </span><br><span class="line"><span class="comment"># class _HashedSeq(list):</span></span><br><span class="line"><span class="comment">#     __slots__ = 'hashvalue'</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#     def __init__(self,tup,hash=hash):</span></span><br><span class="line"><span class="comment">#         self[:] = tup # 这里虽然没有定义过self，但隐含调用了list</span></span><br><span class="line"><span class="comment">#         self.hashvalus = hash(tup)</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#     def __hash__(self):</span></span><br><span class="line"><span class="comment">#         return self.hashvalue</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 要创建一个类的对象，实际就是调用了list，自己创建了自己，这样就把自己创建成列表了，相当于执行了lst = []。然后再执行lst[:] = (1,2)</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># lst = []</span></span><br><span class="line"><span class="comment"># lst[:] = (1,2)</span></span><br><span class="line"><span class="comment"># lst</span></span><br><span class="line"><span class="comment"># lst[1:] = (1,2)   # 一般不用这种方式，容易搞乱</span></span><br><span class="line"><span class="comment"># lst</span></span><br><span class="line"><span class="comment"># 当每次调用hash函数时，实际执行的是__hash__(self)这个方法 ，如执行key = _HashedSeq(list)会调用</span></span><br><span class="line"><span class="comment"># _HashedSeq(list)并返回一个列表，列表本来是不可hash的，如果调用hash，就会调用__hash__(self)这个</span></span><br><span class="line"><span class="comment"># 函数，就会返回self.hashvalue，self.bashvalue就是self.hashvalus = hash(tup)，tup就是tuple元</span></span><br><span class="line"><span class="comment"># 组，这是在创建时把hash(tup)的值保留下来了，所以就可以hash列表了</span></span><br></pre></td></tr></table></figure>
<p>缓存必须使用key，但是key必须可hash，所以只能适用实参是不可变类型的函数调用。</p>
<h4 id="key算法设计"><a href="#key算法设计" class="headerlink" title="key算法设计"></a>key算法设计</h4><p>inspect模块获取函数签名后，会得到parameters，这是一个有序字典，会保存所有参数的信息。我们用得到的有序字典构建一个params_dict，按照位置顺序从args中取出的参数与params_dict中的key是依次对应的，params_dict是参数名，args中是传入的实参，组成kv对，存入params_dict中。</p>
<p>如果是kwargs的值，就update到params_dict中。这是字典的更新方法</p>
<p>如果使用了缺省值的参数，不会出现在实参params_dict中，会出现在签名的取parameters中，缺省值也在定义中。</p>
<h4 id="调用的方式"><a href="#调用的方式" class="headerlink" title="调用的方式"></a>调用的方式</h4><p>普通的函数调用可以，但是过于明显，最好类似lru_cache的方式，让调用者无察觉的使用缓存。使用装饰器函数。</p>
<p>代码模板如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mag_cache</span><span class="params">(fn)</span>:</span></span><br><span class="line">    local_cache = &#123;&#125;   </span><br><span class="line"><span class="comment"># 对不同函数名是不同的cache，用一个普通字典，最后用sorted排序，这是一个二元组，就可以向tuple里放了</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 参数处理，构建key</span></span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@mag_cache</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,y,z=<span class="number">6</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y + z</span><br></pre></td></tr></table></figure>
<p>目标</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,z,y=<span class="number">6</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y + z</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">add(<span class="number">4</span>,z=<span class="number">5</span>)</span><br><span class="line">add(<span class="number">4</span>,y=<span class="number">6</span>,z=<span class="number">5</span>)</span><br><span class="line">add(y=<span class="number">6</span>,z=<span class="number">5</span>,x=<span class="number">4</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line"><span class="comment"># 目标是上面几种都等价，也就是key一样，这样都可以缓存。只有位置参数匹配完才会匹配关键字参数，所以不能用</span></span><br><span class="line"><span class="comment"># add(4,y=9)这样的形式调用，会提示缺少参数z</span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">8</span>,y=<span class="number">5</span>)</span><br><span class="line"><span class="comment"># 这样也可以，4和8会被args接收，kwargs接收y=5，这里就会覆盖y=5，所以不会这样使用</span></span><br></pre></td></tr></table></figure>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>完成了key的生成。注意，这里使用了普通字典params_dict，先把位置参数的对应好，再填充关键字参数，最后补充缺省值，然后再排序生成key。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mag_cache</span><span class="params">(fn)</span>:</span></span><br><span class="line">    local_cache = &#123;&#125;</span><br><span class="line"><span class="comment"># 对不同函数名是不同的cache，这个字典是保存构建的key和得到的add计算的值的。这个字典是无序的</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kwargs)</span>:</span>   <span class="comment"># 接收各种参数，kwargs普通字典参数无序</span></span><br><span class="line">        <span class="comment"># 参数处理，构建key。</span></span><br><span class="line">        sig = inspect.signature(fn)   <span class="comment"># 获取签名</span></span><br><span class="line">        params = sig.parameters   <span class="comment"># 把签名的有序字典放到params中</span></span><br><span class="line">        </span><br><span class="line">        param_names = [key <span class="keyword">for</span> key <span class="keyword">in</span> params.keys()]   <span class="comment"># list(params.keys())</span></span><br><span class="line">        params_dict = &#123;&#125;   </span><br><span class="line">        <span class="comment"># 这是构造key用的，用一个普通字典，最后用sorted排序，这是一个二元组，就可以向tuple里放了</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i,v <span class="keyword">in</span> enumerate(args):</span><br><span class="line">            k = param_names[i]</span><br><span class="line">            params_dict[k] = v</span><br><span class="line">        <span class="comment"># 这里要用索引把值对应上去，所以用了enumerate</span></span><br><span class="line">        <span class="comment"># for k,v in kwargs.items():</span></span><br><span class="line">        <span class="comment"># params_dict[k] = v</span></span><br><span class="line">        params_dict.update(kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 缺省值处理，在构造key前放入这个判断即可</span></span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> params.items():   <span class="comment"># params是我们定义的最长的</span></span><br><span class="line">            <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> params_dict.keys():   <span class="comment"># 如果params的key不在params_dict字典里</span></span><br><span class="line">                params_dict[k] = v.default   <span class="comment"># 就把params的value的默认值加进来</span></span><br><span class="line"></span><br><span class="line">        key = tuple(sorted(params_dict.items()))</span><br><span class="line">        <span class="comment"># 判断是否需要缓存</span></span><br><span class="line"></span><br><span class="line">        ret = fn(*args,**kwargs)  <span class="comment"># 下面返回的是ret的结果，这里是把fn(*args,**kwargs)的结果赋值给了ret，fn(*args,**kwargs)的结果就是return x + y + z</span></span><br><span class="line">        <span class="keyword">return</span> key,ret   <span class="comment"># 这里返回的就是最后得到的结果</span></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@mag_cache</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,z,y=<span class="number">6</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y + z</span><br><span class="line"></span><br><span class="line">result = []</span><br><span class="line">result.append(add(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,z=<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,y=<span class="number">6</span>,z=<span class="number">5</span>))</span><br><span class="line">result.append(add(y=<span class="number">6</span>,z=<span class="number">5</span>,x=<span class="number">4</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>))</span><br><span class="line">print(result)</span><br><span class="line">print(add(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>), (((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>), (((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>), (((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>), (((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)]</span><br><span class="line">(<span class="number">15</span>, ((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)))</span><br></pre></td></tr></table></figure>
<p>使用缓存</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实现过程：</span></span><br><span class="line"><span class="comment"># 1. 创建一个本地缓存，之后取函数的签名并生成有序字典，把有序字典的key放入一个列表中，再创建一个空字典</span></span><br><span class="line"><span class="comment"># 用来保存传入的参数</span></span><br><span class="line"><span class="comment"># 2. 取传入的位置参数、关键字参数和默认值，都保存到空字典中</span></span><br><span class="line"><span class="comment"># 3. 把空字典排序并生成tuple</span></span><br><span class="line"><span class="comment"># 4. 判断tuple中的值是否在本地的缓存字典中，如果不在就加入到缓存字典中，如果在就返回</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mag_cache</span><span class="params">(fn)</span>:</span></span><br><span class="line">    local_cache = &#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kwargs)</span>:</span>   <span class="comment"># 接收各种参数，kwargs普通字典参数无序</span></span><br><span class="line">        <span class="comment"># 参数处理，构建key。</span></span><br><span class="line">        sig = inspect.signature(fn)   <span class="comment"># 取签名</span></span><br><span class="line">        params = sig.parameters   <span class="comment"># 只读有序字典</span></span><br><span class="line">        </span><br><span class="line">        param_names = [key <span class="keyword">for</span> key <span class="keyword">in</span> params.keys()]   <span class="comment"># list(params.keys())</span></span><br><span class="line">        params_dict = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 处理位置参数</span></span><br><span class="line">        <span class="keyword">for</span> i,v <span class="keyword">in</span> enumerate(args):</span><br><span class="line">            k = param_names[i]</span><br><span class="line">            params_dict[k] = v</span><br><span class="line"><span class="comment"># 这里可以直接将值赋给params_dict[k]是因为params是有序字典，并且param_names产生于params的keys，</span></span><br><span class="line"><span class="comment"># 从param_names中有顺序地取出值并赋值给k，再按这个k的顺序保存位置参数的值就没有问题了。</span></span><br><span class="line">		</span><br><span class="line">    	<span class="comment"># 处理关键字参数</span></span><br><span class="line">        <span class="comment"># for k,v in kwargs.items():</span></span><br><span class="line">        <span class="comment"># params_dict[k] = v</span></span><br><span class="line">        params_dict.update(kwargs)</span><br><span class="line"><span class="comment"># 这一行代码相当于其上面注释的两行代码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 缺省值处理</span></span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> params.items():</span><br><span class="line">            <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> params_dict.keys():</span><br><span class="line">                params_dict[k] = v.default</span><br><span class="line"></span><br><span class="line">        key = tuple(sorted(params_dict.items()))</span><br><span class="line">        <span class="comment"># 判断是否需要缓存</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> local_cache.keys():</span><br><span class="line">            local_cache[key] = fn(*args,**kwargs)</span><br><span class="line">        <span class="comment"># 判断key是否在local_cache中，如果没有才缓存，有就执行下面的语句直接返回</span></span><br><span class="line"><span class="comment"># local_cache的值如：&#123;(('x', 4), ('y', 6), ('z', 5)): 15&#125;，因为key是经过排序的元</span></span><br><span class="line"><span class="comment"># 组，所以调用add函数时的参数会在排序后与local_cache.keys比较，如果一样就直接返回结果。这</span></span><br><span class="line"><span class="comment"># 样就实现了缓存的功能</span></span><br><span class="line">        <span class="keyword">return</span> key,local_cache[key]</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@mag_cache</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,z,y=<span class="number">6</span>)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y + z</span><br><span class="line"></span><br><span class="line">result = []</span><br><span class="line">result.append(add(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,z=<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,y=<span class="number">6</span>,z=<span class="number">5</span>))</span><br><span class="line">result.append(add(y=<span class="number">6</span>,z=<span class="number">5</span>,x=<span class="number">4</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>))</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> result:</span><br><span class="line">    print(x)</span><br><span class="line">输出：</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)</span><br></pre></td></tr></table></figure>
<p>增加logger装饰器查看/打印执行时间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mag_cache</span><span class="params">(fn)</span>:</span></span><br><span class="line">    local_cache = &#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kwargs)</span>:</span>   <span class="comment"># 接收各种参数，kwargs普通字典参数无序</span></span><br><span class="line">        <span class="comment"># 参数处理，构建key。</span></span><br><span class="line">        sig = inspect.signature(fn)</span><br><span class="line">        params = sig.parameters   <span class="comment"># 只读有序字典</span></span><br><span class="line">        </span><br><span class="line">        param_names = [key <span class="keyword">for</span> key <span class="keyword">in</span> params.keys()]   <span class="comment"># list(params.keys())</span></span><br><span class="line">        params_dict = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i,v <span class="keyword">in</span> enumerate(args):</span><br><span class="line">            k = param_names[i]</span><br><span class="line">            params_dict[k] = v</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># for k,v in kwargs.items():</span></span><br><span class="line">        <span class="comment"># params_dict[k] = v</span></span><br><span class="line">        params_dict.update(kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 缺省值处理</span></span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> params.items():</span><br><span class="line">            <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> params_dict.keys():</span><br><span class="line">                params_dict[k] = v.default</span><br><span class="line"></span><br><span class="line">        key = tuple(sorted(params_dict.items()))</span><br><span class="line">        <span class="comment"># 这里创建一个tuple，如(('x', 4), ('y', 6), ('z', 5))</span></span><br><span class="line">        <span class="comment"># 判断是否需要缓存</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> local_cache.keys():</span><br><span class="line">            local_cache[key] = fn(*args,**kwargs)</span><br><span class="line"><span class="comment"># 第一次判断时，local_cache中应该是空字典，local_cache.keys()的值是dict_keys([])，这时的key一定</span></span><br><span class="line"><span class="comment"># 不在这个local_cache中，所以这里就给local_cache[key]赋值15，也就是local_cache[(('x', 4), ('y', 6), ('z', 5))] = 15</span></span><br><span class="line">        <span class="keyword">return</span> key,local_cache[key]</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(fn.__name__,delta)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="meta">@mag_cache</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,z,y=<span class="number">6</span>)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y + z</span><br><span class="line"></span><br><span class="line">result = []</span><br><span class="line">result.append(add(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,z=<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,y=<span class="number">6</span>,z=<span class="number">5</span>))</span><br><span class="line">result.append(add(y=<span class="number">6</span>,z=<span class="number">5</span>,x=<span class="number">4</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>))</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> result:</span><br><span class="line">    print(x)</span><br><span class="line">输出：</span><br><span class="line">add <span class="number">3.013066</span></span><br><span class="line">add <span class="number">0.000177</span></span><br><span class="line">add <span class="number">0.000122</span></span><br><span class="line">add <span class="number">0.000113</span></span><br><span class="line">add <span class="number">0.00011</span>   <span class="comment"># 从这以上的执行的时间，是在logger函数中打印的。下面是最后执行的结果</span></span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), <span class="number">15</span>)</span><br></pre></td></tr></table></figure>
<h4 id="过期功能"><a href="#过期功能" class="headerlink" title="过期功能"></a>过期功能</h4><p>一般缓存系统都有过期功能</p>
<p>过期什么</p>
<p>它是某一个key过期。可以对每一个key单独设置过期时间，也可以对这些key统一设定过期时间。本次的实现就简单点，统一设定key的过期时间，当key生存超过了这个时间，就自动被清除。注意：这里并没有考虑多线程等问题。而且这种过期机制，每一次都要遍历所有数据，大量数据的时候，遍历可能有效率问题。</p>
<p>在上面的装饰器中增加一个参数，需要用到带参装饰器</p>
<p><code>@mag_cache(5)</code>代表key生存5秒钟后过期。</p>
<p>带参装饰等于在原来的装饰器外面再嵌套一层</p>
<p>清除的时机，何时清除过期key？</p>
<ol>
<li>用到某个key之前，先判断是否过期，如果过期重新调用函数生成新的key对应value值</li>
<li>一个线程清除过期的key，这个以后实现。本次在创建key之前，清除所有过期的key。</li>
</ol>
<p>value的设计</p>
<ol>
<li>key -&gt; (v, createtimestamp)</li>
</ol>
<p>适合key过期时间都是统一的设定</p>
<ol start="2">
<li>key -&gt; (v, createtimestamp, duration)</li>
</ol>
<p>duration是过期时间，这样每一个key就可以单独控制过期时间。在这种设计中，-1可以表示永不过期，0可以表示立即过期，正整数表示持续一段时间过期。</p>
<p>本次采用第一种实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mag_cache</span><span class="params">(duration)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_cache</span><span class="params">(fn)</span>:</span></span><br><span class="line">        local_cache = &#123;&#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">        @wraps(fn)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span>  <span class="comment"># 接收各种参数，kwargs普通字典参数无序</span></span><br><span class="line">            <span class="comment"># 清除过期的key</span></span><br><span class="line">            expire_keys = []  <span class="comment"># 过期key保存容器</span></span><br><span class="line">            <span class="keyword">for</span> k,(_,stamp) <span class="keyword">in</span> local_cache.items():</span><br><span class="line">                now = datetime.datetime.now().timestamp()  <span class="comment"># timestamp()表示获取时间戳</span></span><br><span class="line">                <span class="keyword">if</span> now - stamp &gt; duration:</span><br><span class="line">                    expire_keys.append(k)</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> expire_keys:</span><br><span class="line">                local_cache.pop(k)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 参数处理，构建key</span></span><br><span class="line">            sig = inspect.signature(fn)</span><br><span class="line">            params = sig.parameters  <span class="comment"># 只读有序字典</span></span><br><span class="line"></span><br><span class="line">            param_names = [key <span class="keyword">for</span> key <span class="keyword">in</span> params.keys()]</span><br><span class="line">            params_dict = &#123;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i,v <span class="keyword">in</span> enumerate(args):</span><br><span class="line">                k = param_names[i]</span><br><span class="line">                params_dict[k] = v</span><br><span class="line">            <span class="comment"># for k,v in kwargs.items():</span></span><br><span class="line">            <span class="comment">#     params_dict[k] = v</span></span><br><span class="line">            params_dict.update(kwargs)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 缺省值处理</span></span><br><span class="line">            <span class="keyword">for</span> k,v <span class="keyword">in</span> params.items():</span><br><span class="line">                <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> params_dict.keys():</span><br><span class="line">                    params_dict[k] = v.default</span><br><span class="line"></span><br><span class="line">            key = tuple(sorted(params_dict.items()))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 判断是否需要缓存</span></span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> local_cache.keys():</span><br><span class="line">                local_cache[key] = (fn(*args, **kwargs), datetime.datetime.now().timestamp())</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> key, local_cache[key]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> _cache</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(fn.__name__, delta)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="meta">@mag_cache(10)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, z, y=<span class="number">6</span>)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y + z</span><br><span class="line"></span><br><span class="line">result = []</span><br><span class="line">result.append(add(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>, z=<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>, y=<span class="number">6</span>, z=<span class="number">5</span>))</span><br><span class="line">result.append(add(y=<span class="number">6</span>, z=<span class="number">5</span>, x=<span class="number">4</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> result:</span><br><span class="line">    print(x)</span><br><span class="line">    </span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br><span class="line">result = []</span><br><span class="line">result.append(add(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>, z=<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>, y=<span class="number">6</span>, z=<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,<span class="number">6</span>))</span><br></pre></td></tr></table></figure>
<p>抽象函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mag_cache</span><span class="params">(duration)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_cache</span><span class="params">(fn)</span>:</span></span><br><span class="line">        local_cache = &#123;&#125;  <span class="comment"># 对不同函数名是不同的cache</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">        @wraps(fn)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">clear_expire</span><span class="params">(cache)</span>:</span>  <span class="comment"># 接收各种参数，kwargs普通字典参数无序</span></span><br><span class="line">                <span class="comment"># 清除过期的key</span></span><br><span class="line">                expire_keys = []</span><br><span class="line">                <span class="keyword">for</span> k,(_,stamp) <span class="keyword">in</span> cache.items():</span><br><span class="line">                    now = datetime.datetime.now().timestamp()</span><br><span class="line">                    <span class="keyword">if</span> now - stamp &gt; duration:</span><br><span class="line">                        expire_keys.append(k)</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> expire_keys:</span><br><span class="line">                    cache.pop(k)</span><br><span class="line">                    </span><br><span class="line">            clear_expire(local_cache)</span><br><span class="line">            </span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">make_key</span><span class="params">()</span>:</span></span><br><span class="line">                <span class="comment"># 参数处理，构建key</span></span><br><span class="line">                sig = inspect.signature(fn)</span><br><span class="line">                params = sig.parameters  <span class="comment"># 只读有序字典</span></span><br><span class="line">                </span><br><span class="line">                param_names = [key <span class="keyword">for</span> key <span class="keyword">in</span> params.keys()]</span><br><span class="line">                params_dict = &#123;&#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> i, v <span class="keyword">in</span> enumerate(args):</span><br><span class="line">                    k = param_names[i]</span><br><span class="line">                    params_dict[k] = v</span><br><span class="line">                    </span><br><span class="line">                <span class="comment"># for k,v in kwargs.items():</span></span><br><span class="line">            	<span class="comment">#     params_dict[k] = v</span></span><br><span class="line">            	params_dict.update(kwargs)</span><br><span class="line"></span><br><span class="line">            	<span class="comment"># 缺省值处理</span></span><br><span class="line">            	<span class="keyword">for</span> k,v <span class="keyword">in</span> params.items():</span><br><span class="line">                	<span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> params_dict.keys():</span><br><span class="line">                    	params_dict[k] = v.default</span><br><span class="line">                        </span><br><span class="line">                <span class="keyword">return</span> tuple(sorted(params_dict.items()))</span><br><span class="line"></span><br><span class="line">            key = make_key()</span><br><span class="line">            <span class="comment"># 判断是否需要缓存</span></span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> local_cache.keys():</span><br><span class="line">                local_cache[key] = (fn(*args, **kwargs), datetime.datetime.now().timestamp()) <span class="comment"># 时间戳</span></span><br><span class="line"><span class="comment"># local_cache[key]的值如：(15, 1593331180.041528)，这里要区分local_cache.keys()，</span></span><br><span class="line"><span class="comment"># local_cache.values()，local_cache.values()的值与local_cache[key]是一样的，local_cache[key]中</span></span><br><span class="line"><span class="comment"># 的key是一个变量，是上面创建出来的排好序的元组，local_cache[key]是要取字典中key对应的值</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> key, local_cache[key]</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> _cache</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(fn.__name__, delta)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="meta">@mag_cache(10)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, z, y=<span class="number">6</span>)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y + z</span><br><span class="line"></span><br><span class="line">result = []</span><br><span class="line">result.append(add(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>, z=<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>, y=<span class="number">6</span>, z=<span class="number">5</span>))</span><br><span class="line">result.append(add(y=<span class="number">6</span>, z=<span class="number">5</span>, x=<span class="number">4</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> result:</span><br><span class="line">    print(x)</span><br><span class="line">    </span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br><span class="line">result = []</span><br><span class="line">result.append(add(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>, z=<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>, y=<span class="number">6</span>, z=<span class="number">5</span>))</span><br><span class="line">result.append(add(<span class="number">4</span>,<span class="number">6</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span> &#123;((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)): (<span class="number">15</span>, <span class="number">1593333606.289463</span>)&#125;</span><br><span class="line"><span class="number">2</span> (<span class="number">15</span>, <span class="number">1593333606.289463</span>)</span><br><span class="line"><span class="number">3</span> dict_keys([((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>))])</span><br><span class="line"><span class="number">4</span> dict_values([(<span class="number">15</span>, <span class="number">1593333606.289463</span>)])</span><br><span class="line">add <span class="number">3.00226</span></span><br><span class="line">add <span class="number">0.000143</span></span><br><span class="line">add <span class="number">7.6e-05</span></span><br><span class="line">add <span class="number">6.5e-05</span></span><br><span class="line">add <span class="number">6e-05</span></span><br><span class="line"><span class="number">1</span> &#123;((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)): (<span class="number">15</span>, <span class="number">1593333606.289463</span>), ((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">6</span>)): (<span class="number">16</span>, <span class="number">1593333609.293278</span>)&#125;</span><br><span class="line"><span class="number">2</span> (<span class="number">16</span>, <span class="number">1593333609.293278</span>)</span><br><span class="line"><span class="number">3</span> dict_keys([((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), ((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">6</span>))])</span><br><span class="line"><span class="number">4</span> dict_values([(<span class="number">15</span>, <span class="number">1593333606.289463</span>), (<span class="number">16</span>, <span class="number">1593333609.293278</span>)])</span><br><span class="line">add <span class="number">3.003368</span></span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), (<span class="number">15</span>, <span class="number">1593333606.289463</span>))</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), (<span class="number">15</span>, <span class="number">1593333606.289463</span>))</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), (<span class="number">15</span>, <span class="number">1593333606.289463</span>))</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), (<span class="number">15</span>, <span class="number">1593333606.289463</span>))</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">5</span>)), (<span class="number">15</span>, <span class="number">1593333606.289463</span>))</span><br><span class="line">(((<span class="string">'x'</span>, <span class="number">4</span>), (<span class="string">'y'</span>, <span class="number">6</span>), (<span class="string">'z'</span>, <span class="number">6</span>)), (<span class="number">16</span>, <span class="number">1593333609.293278</span>))</span><br><span class="line">add <span class="number">0.000179</span></span><br><span class="line">add <span class="number">0.000147</span></span><br><span class="line">add <span class="number">0.000128</span></span><br><span class="line">add <span class="number">0.00014</span></span><br></pre></td></tr></table></figure>
<p>如果使用OrderedDict，要注意，顺序要以签名声明的顺序为准。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_key</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 参数处理，构建key</span></span><br><span class="line">    sig = inspect.signature(fn)</span><br><span class="line">    params = sig.parameters  <span class="comment"># 只读有序字典</span></span><br><span class="line">    param_names = [key <span class="keyword">for</span> key <span class="keyword">in</span> params.keys()]</span><br><span class="line">    params_dict = OrderedDict()  <span class="comment"># &#123;&#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i,v <span class="keyword">in</span> eumerate(args):</span><br><span class="line">        k = param_names[i]</span><br><span class="line">        params_dict[k] = v</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># for k,v in kwargs.items():</span></span><br><span class="line">    <span class="comment">#     params_dict[k] = v</span></span><br><span class="line">    <span class="comment"># params_dict.update(kwargs)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 缺省值和关键字参数处理</span></span><br><span class="line">    <span class="comment"># 如果在params_dict中，说明是位置参数</span></span><br><span class="line">    <span class="comment"># 如果不在params_dict中，如果在kwargs中，使用kwargs的值，如果也不在kwargs中，就使用缺省值</span></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> params.items():  <span class="comment"># 顺序由签名的顺序定</span></span><br><span class="line">        <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> params_dict.keys():</span><br><span class="line">            <span class="keyword">if</span> k <span class="keyword">in</span> kwargs.keys():</span><br><span class="line">                params_dict[k] = kwargs[k]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                params_dict[k] = v.default</span><br><span class="line">    <span class="keyword">return</span> tuple(params_dict.items())</span><br></pre></td></tr></table></figure>
<h3 id="装饰器应用练习"><a href="#装饰器应用练习" class="headerlink" title="装饰器应用练习"></a>装饰器应用练习</h3><h4 id="一、实现一个cache装饰器，实现可过期被清除的功能-1"><a href="#一、实现一个cache装饰器，实现可过期被清除的功能-1" class="headerlink" title="一、实现一个cache装饰器，实现可过期被清除的功能"></a>一、实现一个cache装饰器，实现可过期被清除的功能</h4><ul>
<li>简化设计，函数的形参定义不包含可变位置参数、可变关键词参数和keyword-only参数</li>
<li>可以不考虑缓存满了之后的换出问题</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写代码时，先把主干写出来，把核心算法写出来以后，再一点点往上加功能</span></span><br><span class="line"><span class="comment"># 缓存必须使用key，key必须可hash</span></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">m_cache</span><span class="params">(duration)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_cache</span><span class="params">(fn)</span>:</span></span><br><span class="line">        local_cache = &#123;&#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">        @wraps(fn)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kwargs)</span>:</span></span><br><span class="line">    <span class="comment">#         print(args,kwargs)</span></span><br><span class="line">            expire_keys = []</span><br><span class="line">            <span class="keyword">for</span> k,(_,ts) <span class="keyword">in</span> local_cache.items():</span><br><span class="line"><span class="comment"># local_cache有没有过期的key。value中我们只关心时间，所以只保留ts，时间前面的东西我们不需要，所</span></span><br><span class="line"><span class="comment"># 以用下划线。因为value是我们在下面 </span></span><br><span class="line"><span class="comment"># local_cache[key] = (ret,datetime.datetime.now().timestamp()) 里保存的元组，所以这里可以这样做</span></span><br><span class="line"><span class="comment"># local_cache[key]的值：(15, 1593333606.289463)，ts是上一次将key保存到local_cache时的时间戳</span></span><br><span class="line">                <span class="keyword">if</span> datetime.datetime.now().timestamp() - ts &gt; duration:</span><br><span class="line"><span class="comment"># 这里判断当前时间减去key生成的时间是否大于duration，如果大于就说明超过了我们设置的缓存时间duration，就把</span></span><br><span class="line"><span class="comment"># 这个key干掉。下面的带参装饰器@m_cache(6)里的6就表示缓存6秒。这里的问题是使用时间戳与秒对比</span></span><br><span class="line">                    expire_keys.append(k)</span><br><span class="line"><span class="comment"># 这里不能直接用local_cache.pop(k)这样的方法把key干掉，因为这是迭代，这样做会影响之前的字典？</span></span><br><span class="line"><span class="comment"># 这里如果不将k加入到一个列表，再迭代列表，从缓存字典中删除指定的过期key，而是从这里直接从缓存字典中删除指定</span></span><br><span class="line"><span class="comment"># 的key，会提示："RuntimeError: dictionary changed size during iteration"，意思是："运行时错误：</span></span><br><span class="line"><span class="comment"># 字典在迭代期间更改了大小"，这是因为，如果在这里直接从字典中删除了指定的key，那么下一次循环时字典就被改变</span></span><br><span class="line"><span class="comment"># 了，循环就是在迭代字典，所以会报错。</span></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> expire_keys:</span><br><span class="line">                local_cache.pop(k)</span><br><span class="line">            </span><br><span class="line">            key_dict = &#123;&#125;   <span class="comment"># sorted</span></span><br><span class="line">            sig = inspect.signature(fn)</span><br><span class="line">            params = sig.parameters  <span class="comment"># 有序字典</span></span><br><span class="line"></span><br><span class="line">            param_list = list(params.keys())   <span class="comment"># 把有序字典的key放到list中还是有序的</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 位置参数</span></span><br><span class="line">            <span class="keyword">for</span> i,v <span class="keyword">in</span> enumerate(args):</span><br><span class="line">                print(i,v)</span><br><span class="line">                k = param_list[i]</span><br><span class="line">                key_dict[k] = v</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 关键字参数</span></span><br><span class="line">    <span class="comment">#         for k,v in kwargs.items():</span></span><br><span class="line">    <span class="comment">#             key_dict[k] = v</span></span><br><span class="line">            key_dict.update(kwargs)   <span class="comment"># 这里是乱序的</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 缺省值处理</span></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> params.keys():</span><br><span class="line">                <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> key_dict.keys():</span><br><span class="line">                    key_dict[k] = params[k].default   <span class="comment"># 把params的缺省值放到key_dict[k]中</span></span><br><span class="line"></span><br><span class="line">            key = tuple(sorted(key_dict.items()))   <span class="comment"># 对二元组进行排序</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> local_cache.keys():</span><br><span class="line">                ret = fn(*args,**kwargs)</span><br><span class="line">                local_cache[key] = (ret,datetime.datetime.now().timestamp())   </span><br><span class="line"><span class="comment"># 加一个时间戳到local_cache，加入时间戳是为了知道什么时候key被加入的，以此判断key的过期时间，时间戳是</span></span><br><span class="line"><span class="comment"># 一个flood类型，加括号说明是一个元组，缓存是为了查询的，是不可以变的，所以这里用了tuple而不是List。</span></span><br><span class="line"><span class="comment"># 这里用元组形成key，再用一个元组形成value</span></span><br><span class="line">            <span class="keyword">return</span> local_cache[key]</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> _cache</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(delta)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="meta">@m_cache(6)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,y=<span class="number">5</span>)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    ret = x + y</span><br><span class="line">    print(ret)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">4</span>))</span><br><span class="line">print(add(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">print(add(<span class="number">4</span>,y=<span class="number">5</span>))</span><br><span class="line">print(add(x=<span class="number">4</span>,y=<span class="number">5</span>))</span><br><span class="line">print(add(y=<span class="number">5</span>,x=<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">4</span>))</span><br><span class="line">print(add(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">print(add(<span class="number">4</span>,y=<span class="number">5</span>))</span><br><span class="line">print(add(x=<span class="number">4</span>,y=<span class="number">5</span>))</span><br><span class="line">print(add(y=<span class="number">5</span>,x=<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">=======================================================================================</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把上面的代码重新封装一下</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">m_cache</span><span class="params">(duration)</span>:</span>   <span class="comment"># duration是传入的过期时间</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_cache</span><span class="params">(fn)</span>:</span>   <span class="comment"># fn是传入的add函数</span></span><br><span class="line">        local_cache = &#123;&#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">        @wraps(fn)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kwargs)</span>:</span></span><br><span class="line">    <span class="comment">#         print(args,kwargs)</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">clear_expire</span><span class="params">(cache)</span>:</span></span><br><span class="line"><span class="comment"># 这里将下面功能封装成clear_expire函数，之后再调用。因为clear_expire用到了外面的local_cache，所以</span></span><br><span class="line"><span class="comment"># 定义时要有形参cache，调用时往这里传一个参数local_cache</span></span><br><span class="line">                expire_keys = []   <span class="comment"># 到期的key定义为一个列表</span></span><br><span class="line">                <span class="keyword">for</span> k,(_,ts) <span class="keyword">in</span> local_cache.items():</span><br><span class="line"><span class="comment"># local_cache有没有过期的key，local_cache中保存的值如：</span></span><br><span class="line"><span class="comment"># &#123;(('x', 4), ('y', 5)): (9, 1577244610.220823)&#125;，key是根据传入的位置参数、关键字参数和默认值生</span></span><br><span class="line"><span class="comment"># 成的字典，value有两个内容，前面的是x+y的结果，后面是当前时间的秒数，我们这里只取key和value中的时间</span></span><br><span class="line">                    <span class="keyword">if</span> datetime.datetime.now().timestamp() - ts &gt; duration:</span><br><span class="line"><span class="comment"># 在计算机中，时间实际上是用数字表示的。我们把1970年1月1日 00:00:00 UTC+00:00时区的时刻称为</span></span><br><span class="line"><span class="comment"># epoch time，记为0（1970年以前的时间timestamp为负数），当前时间就是相对于epoch time的秒数，称为</span></span><br><span class="line"><span class="comment"># timestamp。可见timestamp的值与时区毫无关系，因为timestamp一旦确定，其UTC时间就确定了，转换到任意时区</span></span><br><span class="line"><span class="comment"># 的时间也是完全确定的，这就是为什么计算机存储的当前时间是以timestamp表示的，因为全球各地的计算机在任意时刻</span></span><br><span class="line"><span class="comment"># 的timestamp都是完全相同的（假定时间已校准）。</span></span><br><span class="line"><span class="comment"># 这里是判断当前时间的秒数与存入缓存时的秒数是否大于duration，也就是是否大于传入的过期时间，如果过了，</span></span><br><span class="line"><span class="comment"># 就把这个local_cache中的key加到expire_keys过期列表中，再用下面的循环将这个key从缓存中删除。这个</span></span><br><span class="line"><span class="comment"># cache就是clear_expire的参数，也就是从外部传入的local_cache。</span></span><br><span class="line">                        expire_keys.append(k)</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> expire_keys:</span><br><span class="line"><span class="comment"># expire_keys是列表，是不能调用的，所以没有加括号，如果调用会提示不可hash。</span></span><br><span class="line">                    local_cache.pop(k)</span><br><span class="line">            clear_expire(local_cache)</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">make_key</span><span class="params">()</span>:</span></span><br><span class="line">                key_dict = &#123;&#125;   <span class="comment"># sorted</span></span><br><span class="line">                sig = inspect.signature(fn)</span><br><span class="line">                params = sig.parameters  <span class="comment"># 有序字典</span></span><br><span class="line"></span><br><span class="line">                param_list = list(params.keys())   <span class="comment"># 把有序字典的key放到list中还是有序的</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 位置参数</span></span><br><span class="line">                <span class="keyword">for</span> i,v <span class="keyword">in</span> enumerate(args):</span><br><span class="line">                    print(i,v)</span><br><span class="line">                    k = param_list[i]</span><br><span class="line">                    key_dict[k] = v</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 关键字参数</span></span><br><span class="line">        <span class="comment">#         for k,v in kwargs.items():</span></span><br><span class="line">        <span class="comment">#             key_dict[k] = v</span></span><br><span class="line">                key_dict.update(kwargs)   <span class="comment"># 这里是乱序的</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 缺省值处理</span></span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> params.keys():</span><br><span class="line">                    <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> key_dict.keys():</span><br><span class="line">                        key_dict[k] = params[k].default   </span><br><span class="line">                        <span class="comment"># 把params的缺省值放到key_dict[k]中</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> tuple(sorted(key_dict.items()))</span><br><span class="line"></span><br><span class="line">            key = make_key()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> local_cache.keys():</span><br><span class="line">                ret = fn(*args,**kwargs)</span><br><span class="line">                local_cache[key] = (ret,datetime.datetime.now().timestamp())   </span><br><span class="line">                <span class="comment"># 加一个时间戳到local_cache，也就是当前的秒数</span></span><br><span class="line">                <span class="comment"># 缓存是为了查询的，是不可以变的，所以这里用了tuple而不是List</span></span><br><span class="line"><span class="comment"># 如果key不在local_cache字典中，就将ret和时间戳加入到local_cache中，否则直接返回local_cache[key]，</span></span><br><span class="line"><span class="comment"># 也就是说，这里就是判断是否使用缓存的地方</span></span><br><span class="line">            <span class="keyword">return</span> local_cache[key]</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> _cache</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(delta)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="meta">@m_cache(6)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,y=<span class="number">5</span>)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    ret = x + y</span><br><span class="line">    print(ret)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">4</span>))</span><br><span class="line">print(add(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">print(add(<span class="number">4</span>,y=<span class="number">5</span>))</span><br><span class="line">print(add(x=<span class="number">4</span>,y=<span class="number">5</span>))</span><br><span class="line">print(add(y=<span class="number">5</span>,x=<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">4</span>))</span><br><span class="line">print(add(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">print(add(<span class="number">4</span>,y=<span class="number">5</span>))</span><br><span class="line">print(add(x=<span class="number">4</span>,y=<span class="number">5</span>))</span><br><span class="line">print(add(y=<span class="number">5</span>,x=<span class="number">4</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">0</span> <span class="number">4</span>  <span class="comment"># 这是148行print(i,v)所输出，使用位置参数传参时这里才会打印，如print(add(4,y=5))只会打印0 4</span></span><br><span class="line"><span class="number">9</span>  <span class="comment"># 这是191行print(ret)所输出</span></span><br><span class="line"><span class="number">3.001474</span>  <span class="comment"># 这是182行print(delta)所输出</span></span><br><span class="line">(<span class="number">9</span>, <span class="number">1593350889.257828</span>)  <span class="comment"># 这是194行print(add(4))所输出</span></span><br><span class="line"><span class="number">0</span> <span class="number">4</span></span><br><span class="line"><span class="number">1</span> <span class="number">5</span></span><br><span class="line"><span class="number">0.000145</span></span><br><span class="line">(<span class="number">9</span>, <span class="number">1593350889.257828</span>)</span><br><span class="line"><span class="number">0</span> <span class="number">4</span></span><br><span class="line"><span class="number">8.2e-05</span></span><br><span class="line">(<span class="number">9</span>, <span class="number">1593350889.257828</span>)</span><br><span class="line"><span class="number">7e-05</span></span><br><span class="line">(<span class="number">9</span>, <span class="number">1593350889.257828</span>)</span><br><span class="line"><span class="number">6.6e-05</span></span><br><span class="line">(<span class="number">9</span>, <span class="number">1593350889.257828</span>)</span><br><span class="line"><span class="number">0</span> <span class="number">4</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">3.002381</span></span><br><span class="line">(<span class="number">9</span>, <span class="number">1593350898.264219</span>)</span><br><span class="line"><span class="number">0</span> <span class="number">4</span></span><br><span class="line"><span class="number">1</span> <span class="number">5</span></span><br><span class="line"><span class="number">0.000207</span></span><br><span class="line">(<span class="number">9</span>, <span class="number">1593350898.264219</span>)</span><br><span class="line"><span class="number">0</span> <span class="number">4</span></span><br><span class="line"><span class="number">9.3e-05</span></span><br><span class="line">(<span class="number">9</span>, <span class="number">1593350898.264219</span>)</span><br><span class="line"><span class="number">6.7e-05</span></span><br><span class="line">(<span class="number">9</span>, <span class="number">1593350898.264219</span>)</span><br><span class="line"><span class="number">6e-05</span></span><br><span class="line">(<span class="number">9</span>, <span class="number">1593350898.264219</span>)</span><br></pre></td></tr></table></figure>
<h4 id="二、写一个命令分发器"><a href="#二、写一个命令分发器" class="headerlink" title="二、写一个命令分发器"></a>二、写一个命令分发器</h4><ul>
<li>程序员可以方便的注册函数到某一个命令，用户输入命令时，路由到注册的函数</li>
<li>如果此命令没有对应的注册函数，执行默认函数</li>
<li>用户输入用input(“&gt;&gt;&gt;”)</li>
</ul>
<h5 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h5><p>输入命令映射到一个函数，并执行这个函数。应该是cmd_tbl[cmd] = fn的形式，字典正好合适。如果输入了某一个cmd命令后，没有找到函数，就要调用缺省的函数执行，这正好是字典缺省参数。</p>
<p>cmd是字符串</p>
<h5 id="基础框架"><a href="#基础框架" class="headerlink" title="基础框架"></a>基础框架</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建全局字典</span></span><br><span class="line">cmd_tbl = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(cmd, fn)</span>:</span></span><br><span class="line">    cmd_tbl[cmd] = fn</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 缺省函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">default_func</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Unknown command'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 调度器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        cmd = input(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">        <span class="comment"># 退出条件</span></span><br><span class="line">        <span class="keyword">if</span> cmd.strip() == <span class="string">''</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        cmd_tbl.get(cmd, default_func)()</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 自定义函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'magedu'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'python'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 注册函数</span></span><br><span class="line">reg(<span class="string">'mag'</span>, foo1)</span><br><span class="line">reg(<span class="string">'py'</span>, foo2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调度循环</span></span><br><span class="line">dispatcher()</span><br></pre></td></tr></table></figure>
<p>这个代码有些弊端：</p>
<ol>
<li>函数的注册太丑</li>
<li>所有的函数和字典都在全局中定义，不好</li>
</ol>
<p>如何改进？</p>
<h5 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h5><p>将reg函数封装成装饰器，并用它来注册函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注册函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(cmd)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_reg</span><span class="params">(fn)</span>:</span></span><br><span class="line">        cmd_tbl[cmd] = fn</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line">    <span class="keyword">return</span> _reg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义函数</span></span><br><span class="line"><span class="meta">@reg('mag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'magedu'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@reg('py')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'python'</span>)</span><br></pre></td></tr></table></figure>
<p>是否能把字典、reg、dispatcher等封装起来，因为外面只要使用调度和注册就可以了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">command_dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 构建全局字典</span></span><br><span class="line">    cmd_tbl = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(cmd)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_reg</span><span class="params">(fn)</span>:</span></span><br><span class="line">            cmd_tbl[cmd] = fn</span><br><span class="line">            <span class="keyword">return</span> fn</span><br><span class="line">        <span class="keyword">return</span> _reg</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 缺省函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">default_func</span><span class="params">()</span>:</span></span><br><span class="line">        print(<span class="string">'Unknown command'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 调度器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            cmd = input(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">            <span class="comment"># 退出条件</span></span><br><span class="line">            <span class="keyword">if</span> cmd.strip() == <span class="string">''</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            cmd_tbl.get(cmd, default_func)()</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> reg, dispatcher</span><br><span class="line"></span><br><span class="line">reg,dispatcher = command_dispatcher()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义函数</span></span><br><span class="line"><span class="meta">@reg('mag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'magedu'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@reg('py')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'python'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 调度循环</span></span><br><span class="line">dispatcher()</span><br></pre></td></tr></table></figure>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><h6 id="重复注册的问题"><a href="#重复注册的问题" class="headerlink" title="重复注册的问题"></a>重复注册的问题</h6><p>如果一个函数使用同样的cmd名称注册，就等于覆盖了原来的cmd到fn的关系，这样的逻辑也是合理的。</p>
<p>也可以加一个判断，如果key已经存在，重复注册，抛出异常。看业务要求。</p>
<h6 id="注销"><a href="#注销" class="headerlink" title="注销"></a>注销</h6><p>有注册就应该有注销</p>
<p>一般来说注销是要有权限的，但是什么样的人拥有注销的权限，看业务要求</p>
<h5 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">commands = &#123;&#125;</span><br><span class="line"><span class="comment"># 保存命令，不需要有序，就是为了查询的，这是命令和函数存储的地方</span></span><br><span class="line"><span class="comment"># 注册</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(name,fn)</span>:</span></span><br><span class="line">    commands[name] = fn</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">defaultfunc</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Unkown command"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        cmd = input(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">        <span class="keyword">if</span> cmd.strip() == <span class="string">'quit'</span>:</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line">        commands.get(cmd,defaultfunc)()  <span class="comment"># 从字典中get一个值cmd，如果cmd不存在就用默认值defaultfunc，得到了函数后再调用这个函数，得到值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义函数，注册</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'welcome magedu'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'welcome magedu111'</span>)</span><br><span class="line">     </span><br><span class="line">reg(<span class="string">'mag'</span>,foo1)</span><br><span class="line">reg(<span class="string">'py'</span>,foo2)</span><br><span class="line">dispatcher()</span><br><span class="line">输出：</span><br><span class="line">&gt;&gt;&gt;mag</span><br><span class="line">welcome magedu</span><br><span class="line">&gt;&gt;&gt;foo1</span><br><span class="line">Unkown command</span><br><span class="line">&gt;&gt;&gt;py</span><br><span class="line">welcome magedu111</span><br><span class="line"><span class="comment"># 注册后，再调用dispatcher，输入注册过的函数的名称，会显示相应的内容，否则显示Unkown command</span></span><br><span class="line">=======================================================================================</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmds_dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">    commands = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 注册</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(name)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_reg</span><span class="params">(fn)</span>:</span></span><br><span class="line">            commands[name] = fn</span><br><span class="line">            <span class="keyword">return</span> fn</span><br><span class="line">        <span class="keyword">return</span> _reg</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">defaultfunc</span><span class="params">()</span>:</span></span><br><span class="line">        print(<span class="string">"Unkown command"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            cmd = input(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">            <span class="keyword">if</span> cmd.strip() == <span class="string">'quit'</span>:</span><br><span class="line"><span class="comment"># strip是字符串的方法，可以去掉前后指定的字符，如果括号中没有内容，就是去掉前后的空格，这里判断如果</span></span><br><span class="line"><span class="comment"># cmd.strip()去掉前后的空格后等于quit，那么就返回None。</span></span><br><span class="line">                <span class="keyword">return</span> </span><br><span class="line">            commands.get(cmd,defaultfunc)()</span><br><span class="line">    <span class="keyword">return</span> reg, dispatcher   <span class="comment"># 返回一个元组</span></span><br><span class="line">reg,dis = cmds_dispatcher()</span><br><span class="line"><span class="comment"># r,d = cmds_dispatcher()   </span></span><br><span class="line"><span class="comment"># 解构元组。但这样写不易懂，所以一般不这样用。调用cmds_dispatcher返回的是reg和dispatcher函数，再将</span></span><br><span class="line"><span class="comment"># reg和dispatcher函数赋值给reg和dispatcher函数，或赋值给上面说的r和d函数，所以这里的reg和</span></span><br><span class="line"><span class="comment"># dispatcher和上面同名的函数不是同一个，下面的@reg和@dispatcher也是新的函数，不是上面的函数</span></span><br><span class="line"><span class="comment"># 这里要将三个函数封装成一个函数，是因为它们是完成一个业务的，注册与查询</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义函数，注册</span></span><br><span class="line"><span class="meta">@reg('mag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'welcome magedu'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@reg('py')    </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'welcome magedu222'</span>)</span><br><span class="line">     </span><br><span class="line"><span class="comment"># 这个函数的意思是先把指定的函数注册进去，也就是上面的 @reg('mag')，之后再调用dispatcher函数，这时会</span></span><br><span class="line"><span class="comment"># 要求输入函数，如果是上面注册过的两个函数，就会显示注册函数应该显示的内容。如果没有注册过，就会显示Unkown command</span></span><br><span class="line">dis()</span><br><span class="line"><span class="comment"># 这里使用的是外面调用cmds_dispatcher函数后重新赋值的dis，调用cmds_dispatcher函数将内部的函数功能</span></span><br><span class="line"><span class="comment"># 释放出来，使用户可以在外层调用内部的函数。正常只可以从内部调用外部的函数。上面的装饰器函数reg也是使用</span></span><br><span class="line"><span class="comment"># 释放出来的内部函数的功能</span></span><br><span class="line">输出：</span><br><span class="line">&gt;&gt;&gt;py</span><br><span class="line">welcome magedu2222</span><br><span class="line">&gt;&gt;&gt;mag</span><br><span class="line">welcome magedu</span><br><span class="line">&gt;&gt;&gt;abc</span><br><span class="line">Unkown command</span><br><span class="line">&gt;&gt;&gt;aaa</span><br><span class="line">Unkown command</span><br><span class="line">&gt;&gt;&gt;quit</span><br></pre></td></tr></table></figure>
<h4 id="三、实现base64解码"><a href="#三、实现base64解码" class="headerlink" title="三、实现base64解码"></a>三、实现base64解码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">alphabet = <span class="string">b"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base64decode</span><span class="params">(src:bytes)</span>:</span></span><br><span class="line">    ret = bytearray()   <span class="comment"># 生成的字节一定是bytearray，可变的，ret的值：bytearray(b'')</span></span><br><span class="line">    length = len(src)</span><br><span class="line"><span class="comment">#     print(length)</span></span><br><span class="line">    </span><br><span class="line">    step = <span class="number">4</span>   <span class="comment"># 对齐的，每次取4个</span></span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> range(<span class="number">0</span>,length,step):</span><br><span class="line">        tmp = <span class="number">0x00</span></span><br><span class="line">        block = src[offset:offset + step]   <span class="comment"># block为保存每四位取出来的字节</span></span><br><span class="line"><span class="comment">#         print(block)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 开始移位计算</span></span><br><span class="line">        <span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(reversed(block)):</span><br><span class="line"><span class="comment"># 这里用reversed方法把字节逆向处理</span></span><br><span class="line">            <span class="comment"># 替换字符为序号</span></span><br><span class="line">            index = alphabet.find(c)  <span class="comment"># 用find方法的好处是不抛异常，找到就返回索引，找不到返回-1</span></span><br><span class="line">            <span class="keyword">if</span> index == <span class="number">-1</span>:   <span class="comment"># 上面找不到时就是-1</span></span><br><span class="line">                <span class="keyword">continue</span>   </span><br><span class="line">            tmp += index &lt;&lt; i*<span class="number">6</span></span><br><span class="line"><span class="comment"># 第一次i是0，所以这里不会移位。因为是从后向前处理，所以第一次处理就是最后的字节，也就是最低的6位，不需要移</span></span><br><span class="line"><span class="comment"># 位。因为是用6位表示一个字节，所以第二次就要向左移6位了，这时的i也正好是1。之后以此类推，分别移两个、三个</span></span><br><span class="line"><span class="comment"># 6位。移位之后再与之前的值相加，如第一次是111111，第二次移位后是111111 000000，这两个数相加后</span></span><br><span class="line"><span class="comment"># 是111111 111111，这就是二进制加法</span></span><br><span class="line">        ret.extend(tmp.to_bytes(<span class="number">3</span>, <span class="string">'big'</span>))</span><br><span class="line">    <span class="keyword">return</span> bytes(ret.rstrip(<span class="string">b'\x00'</span>))   <span class="comment"># 把最右边的\x00去掉，不可变</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># base64的decode</span></span><br><span class="line"><span class="comment"># txt = "TWFu"</span></span><br><span class="line"><span class="comment"># txt = "TWE="</span></span><br><span class="line"><span class="comment"># txt = "TQ=="</span></span><br><span class="line">txt = <span class="string">"TWFuTWE="</span></span><br><span class="line"><span class="comment"># txt = "TWFuTQ=="</span></span><br><span class="line">txt = txt.encode()</span><br><span class="line">print(txt)</span><br><span class="line">print(base64decode(txt).decode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># base64实现</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">print(base64.b64decode(txt).decode())</span><br><span class="line">输出：</span><br><span class="line"><span class="string">b'TWFuTWE='</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="string">b'TWFu'</span></span><br><span class="line"><span class="string">b'TWE='</span></span><br><span class="line">ManMa</span><br><span class="line">ManMa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改进</span></span><br><span class="line"><span class="comment"># 1. reversed可以不需要</span></span><br><span class="line"><span class="comment"># 2. alphabet.find效率低</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"></span><br><span class="line">base_tb1 = <span class="string">b"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span></span><br><span class="line">alphabet = OrderedDict(zip(base_tb1,range(<span class="number">64</span>)))   <span class="comment"># 用有序字典记录顺序和查询提升效率</span></span><br><span class="line"><span class="comment"># 查询用字典效率更高。用有序字典是为了看打印的顺序，使用普通字典也可以。</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base64decode</span><span class="params">(src:bytes)</span>:</span></span><br><span class="line">    ret = bytearray()</span><br><span class="line">    length = len(src)</span><br><span class="line">    </span><br><span class="line">    step = <span class="number">4</span>   <span class="comment"># 对齐的，每次取4次</span></span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> range(<span class="number">0</span>,length,step):</span><br><span class="line">        tmp = <span class="number">0x00</span></span><br><span class="line">        block = src[offset:offset + step]</span><br><span class="line"><span class="comment"># 以TWFu为例，这里第次取值都会少一个字节，如第一次是TWFu，第二次是TWF，这样是为了下面的block[-i-1]从</span></span><br><span class="line"><span class="comment"># 后向前取一个字节。</span></span><br><span class="line">        <span class="comment"># 开始移位计算</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">            index = alphabet.get(block[-i<span class="number">-1</span>])</span><br><span class="line"><span class="comment"># 查询block中从后向前取出的一段，如：TWFu，第一次取出的就是u。get方法如果不给缺省值时，返回的是None，也就是说，当block中得到的是等号时，因为在base64字典中找不到等号，就会返回None。</span></span><br><span class="line">            <span class="keyword">if</span> index <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line"><span class="comment"># 一般取对象的话，只需要写成if None。这里的index有可能为0，因为base64字典中是有0的，所以这里要这样写，是0也可以进来，否则写成if index的话，0就进不来了</span></span><br><span class="line">                tmp += index &lt;&lt; i*<span class="number">6</span></span><br><span class="line">            <span class="comment"># 找不到，不用移位相加了</span></span><br><span class="line">            </span><br><span class="line">        ret.extend(tmp.to_bytes(<span class="number">3</span>,<span class="string">'big'</span>))</span><br><span class="line"><span class="comment"># to_bytes指把数变成bytes   </span></span><br><span class="line">    <span class="keyword">return</span> bytes(ret.rstrip(<span class="string">b'\x00'</span>))   <span class="comment"># 把最右边的\x00去掉，不可变</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># base64的decode</span></span><br><span class="line"><span class="comment"># txt = "TWFu"</span></span><br><span class="line"><span class="comment"># txt = "TWE="</span></span><br><span class="line"><span class="comment"># txt = "TQ=="</span></span><br><span class="line">txt = <span class="string">"TWFuTWE="</span></span><br><span class="line"><span class="comment"># txt = "TWFuTQ=="</span></span><br><span class="line">txt = txt.encode()</span><br><span class="line">print(txt)</span><br><span class="line">print(base64decode(txt).decode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># base64实现</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">print(base64.b64decode(txt).decode())</span><br><span class="line">输出：</span><br><span class="line"><span class="string">b'TWFuTWE='</span></span><br><span class="line">ManMa</span><br><span class="line">ManMa</span><br></pre></td></tr></table></figure>
<h4 id="四、完善命令分发器"><a href="#四、完善命令分发器" class="headerlink" title="四、完善命令分发器"></a>四、完善命令分发器</h4><ul>
<li>实现函数可以带任意参数（可变参数除外），解析参数并要求用户输入</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 即解决下面的问题</span></span><br><span class="line"><span class="comment"># 自定义函数</span></span><br><span class="line"><span class="meta">@reg('mag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span><span class="params">(x,y)</span>:</span></span><br><span class="line">    print(<span class="string">'magedu'</span>,x,y)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@reg('py')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span><span class="params">(a,b=<span class="number">100</span>)</span>:</span></span><br><span class="line">    print(<span class="string">'python'</span>,a,b)</span><br><span class="line">    </span><br><span class="line">思路：</span><br><span class="line">可以有两种方式</span><br><span class="line"><span class="number">1.</span> 注册的时候，固定死，@ret(<span class="string">'py'</span>,<span class="number">200</span>,<span class="number">100</span>)，可以认为@ret(<span class="string">'py'</span>,<span class="number">200</span>,<span class="number">100</span>)和@reg(<span class="string">'py'</span>,<span class="number">300</span>,<span class="number">100</span>)是不</span><br><span class="line">同的函数，可以用partial函数。</span><br><span class="line"><span class="number">2.</span> 运行时，在输入cmd的时候，逗号分割，获取参数。至于函数的验证，以后实现。一般用户都喜欢使用单纯一个命令</span><br><span class="line">如mag，然后直接显示想要的结果，所以采用第一种方式</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="comment"># 自定义函数可以有任意函数，可变参数、keyword-only除外</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">command_dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 构建全局字典</span></span><br><span class="line">    cmd_tb1 = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 注册函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(cmd,*args,**kwargs)</span>:</span></span><br><span class="line"><span class="comment"># 这里定义一个带参装饰器，传入三个参数cmd,*args,**kwargs，另外把fn函数代入</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_reg</span><span class="params">(fn)</span>:</span></span><br><span class="line">            func = partial(fn,*args,**kwargs)</span><br><span class="line"><span class="comment"># 用partial方法把fn函数的两个参数固定</span></span><br><span class="line">            cmd_tb1[cmd] = func</span><br><span class="line"><span class="comment"># 把func函数加入到全局字典中，以备查询</span></span><br><span class="line">            <span class="keyword">return</span> func</span><br><span class="line">        <span class="keyword">return</span> _reg</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 缺省函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">default_func</span><span class="params">()</span>:</span></span><br><span class="line">        print(<span class="string">'Unknow command'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 调度器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            cmd = input(<span class="string">'Please input cmd &gt;&gt;&gt;'</span>)</span><br><span class="line">            <span class="comment"># 退出条件</span></span><br><span class="line">            <span class="keyword">if</span> cmd.strip() == <span class="string">''</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            cmd_tb1.get(cmd,default_func)()</span><br><span class="line"><span class="comment"># 这里我之前差不多，准备接收用户输入的函数，如果可以在字典中查询到就返回相应内容，如果查不到就返回不知道的命令            </span></span><br><span class="line">    <span class="keyword">return</span> reg,dispatcher</span><br><span class="line"></span><br><span class="line">reg,dispatcher = command_dispatcher()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义函数</span></span><br><span class="line"><span class="meta">@reg('mag',z=200,y=300,x=100)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span><span class="params">(x,y,z)</span>:</span></span><br><span class="line">    print(<span class="string">'magedu'</span>,x,y,z)</span><br><span class="line"><span class="comment"># 这里用reg装饰器传了cmd名和关键字参数，foo1函数没有定义默认值，所以打印内容就是带参装饰器传入的值    </span></span><br><span class="line"><span class="meta">@reg('py',300,b=400)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span><span class="params">(a,b=<span class="number">100</span>)</span>:</span></span><br><span class="line">    print(<span class="string">'python'</span>,a,b)</span><br><span class="line"><span class="comment"># 这里因为带参装饰器中设置了b的值，所以即使foo2函数中定义了b的值，也会被带参装饰器中的值覆盖，如果带参</span></span><br><span class="line"><span class="comment"># 装饰器中没有定义b的值，就会使用foo2函数中定义的默认值。</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 调度循环</span></span><br><span class="line">dispatcher()</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Please input cmd &gt;&gt;&gt;abc</span><br><span class="line">Unknow command</span><br><span class="line">Please input cmd &gt;&gt;&gt;py</span><br><span class="line">python <span class="number">300</span> <span class="number">400</span></span><br><span class="line">Please input cmd &gt;&gt;&gt;python</span><br><span class="line">Unknow command</span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="comment"># functools模块，partial方法</span></span><br><span class="line">functools.partial(func, *args, **keywords)</span><br><span class="line"><span class="comment"># partial 一定接受三个参数</span></span><br><span class="line">func: 需要被扩展的函数，返回的函数其实是一个类 func 的函数</span><br><span class="line">*args: 需要被固定的位置参数</span><br><span class="line">**kwargs: 需要被固定的关键字参数</span><br><span class="line"><span class="comment"># 如果在原来的函数 func 中关键字不存在，将会扩展，如果存在，则会覆盖</span></span><br><span class="line">例<span class="number">1</span>：</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    <span class="comment"># 打印位置参数</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> args:</span><br><span class="line">        print(n)</span><br><span class="line">    print(<span class="string">"-"</span>*<span class="number">20</span>)</span><br><span class="line">    <span class="comment"># 打印关键字参数</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">       print(<span class="string">'%s:%s'</span> % (k, v))</span><br><span class="line">    <span class="comment"># 暂不做返回，只看下参数效果，理解 partial 用法</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 普通调用</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, v1=<span class="number">10</span>, v2=<span class="number">20</span>)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">--------------------</span><br><span class="line">v1:<span class="number">10</span></span><br><span class="line">v2:<span class="number">20</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># partial</span></span><br><span class="line">add_partial = partial(add, <span class="number">10</span>, k1=<span class="number">10</span>, k2=<span class="number">20</span>)</span><br><span class="line">add_partial(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, k3=<span class="number">20</span>)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">--------------------</span><br><span class="line">k1:<span class="number">10</span></span><br><span class="line">k2:<span class="number">20</span></span><br><span class="line">k3:<span class="number">20</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 它返回一个偏函数对象，这个对象和 func 一样，可以被调用，同时在调用的时候可以指定位置参数 (args) 和 关键字参数(*kwargs)。如果有更多的位置参数提供调用，它们会被附加到 args 中。如果有额外的关键字参数提供，它们将会扩展并覆盖原有的关键字参数。partial() 是被用作 “冻结” 某些函数的参数或者关键字参数，同时会生成一个带有新标签的对象(即返回一个新的函数)。比如，partial() 可以用于合建一个类似 int() 的函数，同时指定 base 参数为2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>basetwo = partial(int, base=<span class="number">2</span>)</span><br><span class="line"><span class="comment"># 这相当于int('10010',base=2)</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>basetwo.__doc__ = <span class="string">'Convert base 2 string to an int.'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>basetwo(<span class="string">'10010'</span>)</span><br><span class="line">输出：</span><br><span class="line">Out[<span class="number">1</span>]: <span class="number">18</span></span><br><span class="line">    </span><br><span class="line">例<span class="number">2</span>:</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multiply</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x * y</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>multiply(<span class="number">3</span>, y=<span class="number">2</span>)</span><br><span class="line"><span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">double</span><span class="params">(x, y=<span class="number">2</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> multiply(x, y)</span><br><span class="line"><span class="comment"># 将y的值固定</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line">double = partial(multiply, y=<span class="number">2</span>)</span><br><span class="line"><span class="comment"># partial 接收函数 multiply 作为参数，固定 multiply 的参数 y=2，并返回一个新的函数给 double，这跟</span></span><br><span class="line"><span class="comment"># 我们自己定义 double 函数的效果是一样的。这里固定的是关键字参数，也可以固定位置参数</span></span><br><span class="line">===========================================================================================</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">247</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">176</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
