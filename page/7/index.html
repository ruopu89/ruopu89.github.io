<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/7/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/10/转：一文精通-crontab从入门到出坑/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/10/转：一文精通-crontab从入门到出坑/" itemprop="url">
                  转：一文精通 crontab从入门到出坑
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-10 09:03:04" itemprop="dateCreated datePublished" datetime="2020-02-10T09:03:04+08:00">2020-02-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/定时任务/" itemprop="url" rel="index"><span itemprop="name">定时任务</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一文精通-crontab从入门到出坑"><a href="#一文精通-crontab从入门到出坑" class="headerlink" title="一文精通 crontab从入门到出坑"></a>一文精通 crontab从入门到出坑</h1><p>地址：<a href="https://zhuanlan.zhihu.com/p/58719487" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/58719487</a></p>
<blockquote>
<p>这篇博文较长，涵盖了几乎所有crontab的坑。阅读时间会比较长，建议认真读完。</p>
</blockquote>
<p>此篇技术博文主要介绍的是crontab，Linux下的计划任务管理工具。涉及内容包括crontab使用配置、常见坑的分析和个人总结的错误调试方法。</p>
<p>我的理解，后台任务通常分为两种：常驻和定时。之前的文章《pm2进程管理工具使用总结》主要针对的是常驻任务。今天来谈谈crontab，主要针对的是定时任务。我的实验环境：centos7。</p>
<h2 id="介绍crontab"><a href="#介绍crontab" class="headerlink" title="介绍crontab"></a><strong>介绍crontab</strong></h2><p>crontab的服务进程名为crond，英文意为周期任务。顾名思义，crontab在Linux主要用于周期定时任务管理。通常安装操作系统后，默认已启动crond服务。crontab可理解为cron_table，表示cron的任务列表。类似crontab的工具还有at和anacrontab，但具体使用场景不同，可参见附录《让你学会Linux计划任务》一文了解更多。</p>
<p>关于crontab的用途很多，如</p>
<ul>
<li>定时系统检测；</li>
<li>定时数据采集；</li>
<li>定时日志备份；</li>
<li>定时更新数据缓存；</li>
<li>定时生成报表；<br>…<br>等等任务</li>
</ul>
<p>当然，更多使用场景是要以视具体情况而定了。毕竟是工具通常都是常用规则总结而成的产物。</p>
<p>确认crond服务已经安装与开启之后，下面开始具体说明</p>
<h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a><strong>简单示例</strong></h2><p>先来个简单示例体验一下。目标是每分钟向/tmp/time.txt文件下写入当前时间</p>
<p><strong>新建crontab任务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ crontab -e      // 打开crontab任务编辑</span><br><span class="line">* * * * * date &gt;&gt; /tmp/time.txt</span><br></pre></td></tr></table></figure>
<p>静静等待几分钟工作如下命令查看文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tmp/time.txt</span><br><span class="line">Do 29. Dez 22:45:01 CST 2016</span><br><span class="line">Do 29. Dez 22:46:01 CST 2016</span><br><span class="line">Do 29. Dez 22:47:01 CST 2016</span><br></pre></td></tr></table></figure>
<ul>
<li>从上面结果看出，每分钟执行了date并写入到/tmp/time.txt。</li>
</ul>
<p>简单示例演示成功。下面从细节深入说明crontab使用。</p>
<h2 id="使用选项"><a href="#使用选项" class="headerlink" title="使用选项"></a><strong>使用选项</strong></h2><p>上面的实验中使用了crontab命令的-e选项。我们来看看crontab命令中有哪些选项?</p>
<p><strong>-e 选项</strong> 表示打开当前用户的crontab任务列表配置文件。当然也可以直接打开，路径通常是在/var/spool/cron/下，文件以用户名命名，如/var/spool/cron/root。不过，采用-e方式打开，福利是可以帮助我们自动检查任务配置符合规则。</p>
<p><strong>-u 选项</strong> 指定某用户的任务列表，很好理解。比如我当前是root用户，想操作poloxue用户的任务列表。如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crontab -u poloxue -e</span><br></pre></td></tr></table></figure>
<p><strong>-l 选项</strong> 列出某用户的所有任务列表</p>
<p><strong>-r 选项</strong> 删除某用户的所有任务列表，这个选项使用小心为上，估计也只是自己实验时玩玩而已，正常不使用。</p>
<p>crontab命令的选项中，主要使用的就是以上几个，理解比较简单。</p>
<h2 id="任务配置"><a href="#任务配置" class="headerlink" title="任务配置"></a><strong>任务配置</strong></h2><p>说完了crontab的命令选项，下面开始正题，任务列表文件如何配置？</p>
<p>首先，看下crontab任务列表配置格式，示例文件如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更多细节 man 4 crontabs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计划任务定义的例子:</span></span><br><span class="line"><span class="comment"># .---------------- 分 (0 - 59)</span></span><br><span class="line"><span class="comment"># |  .------------- 时 (0 - 23)</span></span><br><span class="line"><span class="comment"># |  |  .---------- 日 (1 - 31)</span></span><br><span class="line"><span class="comment"># |  |  |  .------- 月 (1 - 12)</span></span><br><span class="line"><span class="comment"># |  |  |  |  .---- 星期 (0 - 7) (星期日可为0或7)</span></span><br><span class="line"><span class="comment"># |  |  |  |  |</span></span><br><span class="line"><span class="comment"># *  *  *  *  * 执行的命令</span></span><br><span class="line">* * * * * date &gt;&gt; /time.txt 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>从上面的示例文件可看出，crontab的任务列表主要由两部分组成：环境变量配置与定时任务配置。可能大家在工作中更多是只用到了任务配置部分。</p>
<h2 id="环境变量配置部分"><a href="#环境变量配置部分" class="headerlink" title="环境变量配置部分"></a><strong>环境变量配置部分</strong></h2><p>理解环境变量配置这部分可以帮助我们减少去踩一些不必要的坑。简单说明上面涉及的环境变量。</p>
<p><strong>SHELL</strong>为/bin/bash，表示使用/bin/bash解释执行命令</p>
<p><strong>PATH</strong>表示到哪些目录路径寻找命令程序，此环境变量的值说明了为什么我们在crontab中执行命令时，尽量要写命令全路径才能执行的原因。</p>
<p><strong>MAILTO</strong>变量作用是当任务执行有输出时，内容发送到哪个用户的邮箱。禁用可以设置MAILTO=””。</p>
<p>当我们在使用crontab时，发现某些定时任务不能顺利执行，但shell控制台执行成功，环境变量是否正确是我们需要首先关注的点之一。具体详情可以看后面关于环境变量坑的说明。</p>
<h2 id="定时任务配置部分"><a href="#定时任务配置部分" class="headerlink" title="定时任务配置部分"></a><strong>定时任务配置部分</strong></h2><p>这部分是crontab配置核心。</p>
<p><strong>基本配置</strong></p>
<p>如下所示配置共6列，前5列是关于执行时间配置，最后1列是具体执行命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.---------------- 分 (0 - 59)</span><br><span class="line">|  .------------- 时 (0 - 23)</span><br><span class="line">|  |  .---------- 日 (1 - 31) </span><br><span class="line">|  |  |  .------- 月 (1 - 12) </span><br><span class="line">|  |  |  |  .---- 星期 (0 - 6) (星期日可为0或7) </span><br><span class="line">|  |  |  |  | </span><br><span class="line">*  *  *  *  * 执行的命令</span><br></pre></td></tr></table></figure>
<p>第一列单位为分，表示每时第几分钟，范围为0-59；<br>第二列单位为时，表示每天第几小时，范围为0-23；<br>第三列单位为日，表示每月第几天，范围为1-31；<br>第四列单位为月，表示每年第几月，范围为1-12；<br>第五列单位为星期，表示每星期第几天，范围0-7，0与7表示星期日，其他分别为星期1-6；</p>
<p><strong>时间配置段类型</strong></p>
<p>根据时间列中值的不同设置方式，编者总结出以下五种类型：</p>
<p><strong>固定某值</strong>，指定固定值，如指定1月1日0时0分执行任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 1 * command</span><br></pre></td></tr></table></figure>
<p>月日时分都指定了固定数值。<br>注：*在crontab中表示任意值都满足条件。</p>
<p><strong>列表值</strong>，时间值是一个列表，如指定一个月内2、12、22日零时执行任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 2,12,22 * * command</span><br></pre></td></tr></table></figure>
<p>上述日指定多个值，2号、12号和22号，以逗号分隔；</p>
<p><strong>连续范围值</strong>，时间为连续范围的值，如指定每个月1至7号零时执行任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1-7 * * command</span><br></pre></td></tr></table></figure>
<p>上述日期为连续范围的值1-7时</p>
<p><strong>步长值</strong>，根据指定数值跳跃步长确定执行时间，如指定凌晨1时开始每割3个小时0分执行一次任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1-24/3 * * * command</span><br></pre></td></tr></table></figure>
<p>上述指定从凌晨1时每3个小时执行任务，如1点0分，4点0分，7点0分等。</p>
<p><strong>混合值</strong>，支持以上类型的组合，如指定每小时0至10分，22、33分以及0-60分钟每隔20分钟执行任务，如下</p>
<p>0-10,22,33,<em>/20 </em> <em> </em> * command</p>
<p>这里的分钟值采取了多种类型组合指定，包括连续范围值(0-7)，列表值(22,33)，步长值(*/20)。</p>
<p>说明：这几种时间配置类型是编者自己总结，希望能帮助大家更好理解。</p>
<h2 id="定时语句解析工具"><a href="#定时语句解析工具" class="headerlink" title="定时语句解析工具"></a><strong>定时语句解析工具</strong></h2><p>通常在使用crontab添加任务时，我们会依靠自己已有知识编写定时语句。当需要测试语句是否正确时，总需要一定时间等待证明其正确性。作为一名牛逼的程序员，这种方式就太不酷了。有没有一款工具，只要我们给出语句，其就能告诉具体执行时间呢？下面介绍一款老外开发的crontab在线解析工具。</p>
<p>工具地址：<a href="https://link.zhihu.com/?target=https%3A//crontab.guru/" target="_blank" rel="noopener">https://crontab.guru</a>，下面是工具的截图</p>
<p><img src="https://pic2.zhimg.com/80/v2-b9c9d6301f824594b33f408273436ae9_hd.jpg" alt="img"></p>
<p>从上面看出，我们输入的语句解析结果为每天的04：05执行任务。下面有这样一行文字“next at 2016-12-31 04:05:00”，告诉了我们最近一次的执行时间。</p>
<p>注：百度搜索“crontab在线解析”获得的工具有坑，某些语句解析结果错误。为避免大家受骗，这里提供具体地址：<a href="https://link.zhihu.com/?target=http%3A//tool.lu/crontab/" target="_blank" rel="noopener">http://tool.lu/crontab/</a></p>
<h2 id="使用有坑"><a href="#使用有坑" class="headerlink" title="使用有坑"></a><strong>使用有坑</strong></h2><p>crontab使用中常会遇到各种坑。下面列出编者在使用中曾遇到的一些问题。此处介绍两种坑，一种是基本功不足导致的配置错误，而另一种是多数人对crontab配置都存在的一个理解误区。</p>
<p><strong>整点时间设置错误</strong></p>
<p>其实这个错误不用单独说明，但是我在刚开始接触crontab时犯过，单独拿出来说明一下。<br>如设定每天3点执行一次某任务</p>
<p>下面列出错误方式，当我们听到每天3点执行一次某任务时，很多人会把重点放在3点，而忽略了执行一次的需求。下面是个错误的例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 3 * * * command</span><br></pre></td></tr></table></figure>
<p>这里会导致在三点的每分钟都会执行一次任务，也就是执行了60次。正确方式如下，每天3点0时执行任务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 3 * * * command</span><br></pre></td></tr></table></figure>
<p><strong>日与星期的关系误区</strong></p>
<p>这真的是个大误区，很多人都不知道的大误区。直接开始说明吧。首先做两个练习</p>
<p>设置任务一：每月的1-7每天零时执行某任务，答案如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1-7 * * date &gt;&gt; /tmp/date.txt</span><br></pre></td></tr></table></figure>
<p>设置任务二：每星期的星期一零时执行某任务，答案如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 * * 1 date &gt;&gt; /tmp/date.txt</span><br></pre></td></tr></table></figure>
<p>上面两个任务的设定都是正确的。下面提出第三个任务，设置每个月的第一个星期一零时执行某任务。</p>
<p>分解任务要求，首先，第一个星期就是每个月的1-7日，而星期一就是星期一。所以我们理解的crontab任务配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1-7 * 1 date &gt;&gt; /tmp/date.txt</span><br></pre></td></tr></table></figure>
<p>下面直接使用前面介绍的在线解析工具分析此语句，如下</p>
<p><img src="https://pic1.zhimg.com/80/v2-3685380c1c54a36717aa6f17e16778b0_hd.jpg" alt="img"></p>
<p>解析结果显示语句执行时间为每月的1至7日和每星期一。可以看到最近执行时间是“next at 2017-01-01 00:00:00”，这个时间也并非星期一。这是crontab的一个特别容易误解之处，下面直接给出结论:</p>
<p>当日和星期任一列包含时，日与星期两者为并且的关系；</p>
<p>当日和星期列中不包含时，日与星期两者为或者的关系；</p>
<p>请注意，前面提到的那个百度搜索出来的工具分析结果显示的确是每月第一个星期一，这是错误的。如有朋友持怀疑态度，可自行验证，如有错误，随时告知。</p>
<h2 id="环境变量问题"><a href="#环境变量问题" class="headerlink" title="环境变量问题"></a><strong>环境变量问题</strong></h2><p>当我们刚使用crontab时，有人会告知所有命令尽量都使用绝对路径，以防错误。为什么？这就和我们下面要谈的环境变量有关了。</p>
<p>首先，获取控制台环境变量看下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ env</span><br><span class="line">XDG_SESSION_ID=10</span><br><span class="line">HOSTNAME=localhost.localdomain</span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PERL_MB_OPT=--install_base /root/perl5</span><br><span class="line">USER=root</span><br><span class="line">MAIL=/var/spool/mail/root</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/usr/local/php5/bin</span><br><span class="line">PWD=/var/mail</span><br><span class="line">SHLVL=1</span><br><span class="line">HOME=/root</span><br><span class="line">LOGNAME=root</span><br><span class="line">XDG_RUNTIME_DIR=/run/user/0 </span><br><span class="line">_=/usr/bin/env</span><br></pre></td></tr></table></figure>
<p>考虑篇幅问题，上文输出有删减。</p>
<p>然后，获取crontab环境变量信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * /usr/bin/env &gt; /tmp/env.txt</span><br></pre></td></tr></table></figure>
<p>输出结果，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tmp/env.txt</span><br><span class="line">XDG_SESSION_ID=732</span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">USER=root</span><br><span class="line">PATH=/usr/bin:/bin</span><br><span class="line">PWD=/root</span><br><span class="line">LANG=de_DE.UTF-8</span><br><span class="line">SHLVL=1 HOME=/root</span><br><span class="line">LOGNAME=root</span><br><span class="line">XDG_RUNTIME_DIR=/run/user/0</span><br><span class="line">_=/usr/bin/en</span><br></pre></td></tr></table></figure>
<p>对比crontab与控制台输出，我们发现两者的环境变量差异很大。如果命令在控制台执行成功，而在crontab执行失败，我们需要考虑是否命令涉及的环境变量在crontab和控制台间存在差异。</p>
<p>明白crontab使用绝对路径执行命令原因了吗？我们知道命令默认查找路径是由PATH指定的。从上面输出结果可知，控制台的PATH值为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/usr/local/php/bin</span><br></pre></td></tr></table></figure>
<p>crontab的PATH值为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/usr/local/php/bin</span><br></pre></td></tr></table></figure>
<p>crontab的PATH值为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PATH=/usr/bin:/bin</span><br></pre></td></tr></table></figure>
<p>/usr/local/php/bin/下面存在php命令，在控制台执行成功<br>$ php index.php<br>因在crontab的PATH变量无/usr/local/php/bin/，其执行php命令则会失败。</p>
<p>如何解决？已知哪个环境变量导致问题，可以直接在crontab配置中加入变量配置。<br>不知哪个环境变量导致问题，终极大招是引入控制台环境变量，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * source /$HOME/.bash_profile &amp;&amp; command</span><br></pre></td></tr></table></figure>
<p>当然，对于某特定环境变量或有特定的处理方式，如PATH，命令使用绝对路径亦可解决。</p>
<h2 id="特殊符号"><a href="#特殊符号" class="headerlink" title="特殊符号%"></a><strong>特殊符号%</strong></h2><p>%在crontab是特殊符号，具体含义如下：</p>
<p>第一个%表示标准输入的开始，如下示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * cat &gt;&gt; /tmp/cat.txt 2&gt;&amp;1 % stdin input</span><br></pre></td></tr></table></figure>
<p>执行成功之后，查看/tmp/cat.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tmp/cat.txt</span><br><span class="line"> stdin input</span><br></pre></td></tr></table></figure>
<p>我们看到标准输入写入到了/tmp/cat.txt文件。理解上面示例，首先需知cat &gt;&gt; /tmp/cat.txt ，作用是将标准输入重定向至/tmp/cat.txt。</p>
<p>其余%表示换行符，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * cat &gt;&gt; /tmp/cat_line.txt 2&gt;&amp;1 % stdin input 1 % stdin input 2 % stdin input 3</span><br></pre></td></tr></table></figure>
<p>查看输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tmp/cat_line.txt</span><br><span class="line">stdin input 1</span><br><span class="line">stdin input 2</span><br><span class="line">stdin input 3</span><br></pre></td></tr></table></figure>
<p>可以发现这里有三行输出。那么如何解决？既然是特殊字符，自然而然就想到了使用\进行转义，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * cat &gt;&gt; /tmp/cat_special.txt 2&gt;&amp;1 % per cent is \%. 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>查看输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tmp/cat_special.txt</span><br><span class="line">per cent is %.</span><br></pre></td></tr></table></figure>
<p>执行成功了。自此，你就顺利爬出了%特殊字符问题的坑。关于这个问题的具体说明，可以参看附录中的《Crontab and %》。</p>
<h2 id="关于输出重定向"><a href="#关于输出重定向" class="headerlink" title="关于输出重定向"></a><strong>关于输出重定向</strong></h2><p>当我们不做输出重定向时，如任务有大量输出，或许有些无法解释的问题。</p>
<p>输出写入邮件，crontab任务输出默认写入到执行用户的邮件中，如下演示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * date</span><br></pre></td></tr></table></figure>
<p>命令输出当前日期，下面查看当前用户的邮件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat /var/spool/mail/$USER</span><br><span class="line">...</span><br><span class="line">Sat Dec 31 17:45:01 CST 2016</span><br></pre></td></tr></table></figure>
<p>由此可见，任务输出的日期信息写入到了用户邮件中。如任务有大量输出，会占用磁盘资源。但编者测试显示，如磁盘容量不足，任务也会执行，但输出不会写入邮件；</p>
<p>我们可以关闭邮箱功能。设置MAILTO环境变量为空。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MAILTO=&quot;&quot;</span><br><span class="line">* * * * * date</span><br></pre></td></tr></table></figure>
<p>是不是关闭邮件写入就好了？附录《Linux中的crontab与sendmail》博文表明，关闭mail功能，输出内容将写入到/var/spool/clientmqueue中，可能占满分区的inode资源，导致任务无法执行。inode资源使用情况可通过如下命令获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ df -i</span><br><span class="line">Filesystem Inodes   IUsed  IFree    IUse% Mounted on</span><br><span class="line">/dev/sda1  512000   378    511622   1%    /boot</span><br><span class="line">/dev/sda2  92672000 185351 92486649 1%    /</span><br></pre></td></tr></table></figure>
<p>抱歉！这种情况编者并未测出！但在公司的生产环境发现过未重定向则任务不执行的情况，加上后解决了问题。百度也搜索到了类似问题，如有朋友了解，欢迎指教，万分感谢。</p>
<p>当然，为了避免此类问题发生，建议任务都加上输出重定向，如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * date &gt;&gt; /dev/null/ 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>输出到/dev/null中，标准输入和标准错误都应处理。如大家对重定向有疑惑，附录中的Linux重定向的解释不错。在技术的世界，当我们不按常理做事，事情也不会按常理犯错。</p>
<h2 id="调试大招"><a href="#调试大招" class="headerlink" title="调试大招"></a><strong>调试大招</strong></h2><p>最后的福利，编者根据自己的总结而梳理出一套快速定位crontab错误的思路。两个角度：</p>
<p>一是任务是否执行</p>
<p>二看命令是否正确</p>
<h2 id="任务是否执行"><a href="#任务是否执行" class="headerlink" title="任务是否执行"></a><strong>任务是否执行</strong></h2><p>调试思路：首先，通过日志确认任务是否执行。然后，如未执行则分析定时语句。最后，定时没有问题，检查crond服务是否开启。</p>
<p>下面说明具体分析步骤。</p>
<p>调试错误，日志通常是个利器，crontab也有日志。我的服务器中crontab日志文件位置为/var/log/cron。</p>
<p><strong>查看日志</strong></p>
<p>日志中包含任务执行记录，配置错误提示，任务配置编辑重载记录，服务开启等记录。<br>下面是日志的部分内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vim /var/log/cron</span><br><span class="line">...</span><br><span class="line">Dec 31 19:17:01 localhost crond[1455]: (CRON) bad day-of-week (/var/spool/cron/root)</span><br><span class="line">Dec 31 19:17:01 localhost CROND[4409]: (root) CMD (date) ...</span><br></pre></td></tr></table></figure>
<p>这里截取了对调试比较重要的两条记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dec 31 19:17:01 localhost CROND[4409]: (root) CMD (date)</span><br></pre></td></tr></table></figure>
<p>显示12月21 19时17分1秒执行了date命令。</p>
<p><strong>配置错误</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dec 31 19:17:01 localhost crond[1455]: (CRON) bad day-of-week (/var/spool/cron/root)</span><br></pre></td></tr></table></figure>
<p>上面显示/var/spool/cron/root的任务配置有错，也就是root任务配置有错。错误原因：bad day-of-week，星期配置有错。语句是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * date &gt;&gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>明显缺少了星期时间段。</p>
<p>确认定时语句，通过上面的日志分析，如任务没有执行，使用定时语句在线分析工具分析定时是否正确，非常简单。</p>
<p>确认服务开启，如果定时语句也正确，检查服务是否开启。检测命令如下</p>
<p>Systemd方式(centos7及以上)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status crond.service</span><br></pre></td></tr></table></figure>
<p>SysVinit方式(centos7以下)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service crond status</span><br></pre></td></tr></table></figure>
<p>查看命令输出，如未开启，执行如下命令开启</p>
<p>Systemd方式(centos7及以上)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl start crond.service</span><br></pre></td></tr></table></figure>
<p>SysVinit方式(centos7以下)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service crond start</span><br></pre></td></tr></table></figure>
<p>确认任务成功后，如问题仍未解决，继续往下看。</p>
<h2 id="命令是否正确"><a href="#命令是否正确" class="headerlink" title="命令是否正确"></a><strong>命令是否正确</strong></h2><p>确认命令成功与否，这里总结步骤大致如下：</p>
<p>获取命令执行输出，crontab中的命令执行出错，多数人都不知道如何调试。我们知道在控制台执行命令时，可通过输出获取错误信息调试问题。这种方式在crontab同样适用，方法就是利用重新向获取输出，进行分析。示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * php /root/index.php &gt;&gt; /tmp/debug.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>这条任务总是执行失败，我们把输出重定向到/tmp/debug.log。查看debug.log，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tmp/debug.log </span><br><span class="line">/bin/sh: php: command not found</span><br><span class="line">/bin/sh: php: command not found</span><br></pre></td></tr></table></figure>
<p>显示php命令没有找到，很明显的可以确定是环境变量的问题。这种方式定位问题非常有效。</p>
<p>具体问题具体分析。有了命令执行的输出，下面就是具体问题具体分析了。或许是前面提到的各种坑，也或许是命令本身所独有的问题。</p>
<p>调试的方法到这里就说完了。但还是实践为王，需持续总结，同时也希望大家不要在同样的坑中重复犯错。</p>
<h2 id="参考附录"><a href="#参考附录" class="headerlink" title="参考附录"></a>参考附录</h2><p><a href="https://link.zhihu.com/?target=http%3A//os.51cto.com/art/201001/176402.htm" target="_blank" rel="noopener">让你学会Linux计划任务</a><br><a href="https://link.zhihu.com/?target=http%3A//www.server110.com/sendmail/201311/3125.html" target="_blank" rel="noopener">Linux中的crontab与sendmail</a><br><a href="https://link.zhihu.com/?target=http%3A//www.hcidata.info/crontab.htm" target="_blank" rel="noopener">Crontab and %</a><br><a href="https://link.zhihu.com/?target=http%3A//www.jb51.net/os/RedHat/1120.html" target="_blank" rel="noopener">Linux重定向</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/09/转：Nginx日志配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/09/转：Nginx日志配置/" itemprop="url">
                  转：Nginx日志配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-09 21:38:00" itemprop="dateCreated datePublished" datetime="2020-02-09T21:38:00+08:00">2020-02-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="超详细！Nginx-日志配置实践"><a href="#超详细！Nginx-日志配置实践" class="headerlink" title="超详细！Nginx 日志配置实践"></a>超详细！Nginx 日志配置实践</h2><p>地址：<a href="https://mp.weixin.qq.com/s/MzLHXwyl8Upt4eI9IjrNBw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/MzLHXwyl8Upt4eI9IjrNBw</a></p>
<p><strong>前言</strong></p>
<p>Nginx日志对于统计、系统服务排错很有用。</p>
<p><strong>Nginx日志主要分为两种：</strong>access_log(访问日志)和error_log(错误日志)。通过访问日志我们可以得到用户的IP地址、浏览器的信息，请求的处理时间等信息。错误日志记录了访问出错的信息，可以帮助我们定位错误的原因。</p>
<p><strong>本文将详细描述一下如何配置Nginx日志。</strong></p>
<h2 id="设置access-log"><a href="#设置access-log" class="headerlink" title="设置access_log"></a><strong>设置access_log</strong></h2><p>访问日志主要记录客户端的请求。客户端向Nginx服务器发起的每一次请求都记录在这里。客户端IP，浏览器信息，referer，请求处理时间，请求URL等都可以在访问日志中得到。当然具体要记录哪些信息，你可以通过log_format指令定义。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">access_log path <span class="comment">[format <span class="comment">[buffer=size]</span> <span class="comment">[gzip<span class="comment">[=level]</span>]</span> <span class="comment">[flush=time]</span> <span class="comment">[if=condition]</span>]</span>; # 设置访问日志</span><br><span class="line">access_log off; # 关闭访问日志</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>path 指定日志的存放位置。</li>
<li>format 指定日志的格式。默认使用预定义的combined。</li>
<li>buffer 用来指定日志写入时的缓存大小。默认是64k。</li>
<li>gzip 日志写入前先进行压缩。压缩率可以指定，从1到9数值越大压缩比越高，同时压缩的速度也越慢。默认是1。</li>
<li>flush 设置缓存的有效时间。如果超过flush指定的时间，缓存中的内容将被清空。</li>
<li>if 条件判断。如果指定的条件计算为0或空字符串，那么该请求不会写入日志。</li>
</ul>
</blockquote>
<p>另外，还有一个特殊的值off。如果指定了该值，当前作用域下的所有的请求日志都被关闭。</p>
<h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><p>可以应用access_log指令的作用域分别有http，server，location，limit_except。也就是说，在这几个作用域外使用该指令，Nginx会报错。</p>
<p>以上是access_log指令的基本语法和参数的含义。下面我们看一几个例子加深一下理解。</p>
<h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">access_log /var/logs/nginx-<span class="keyword">access</span>.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<p>该例子指定日志的写入路径为/var/logs/nginx-access.log，日志格式使用默认的combined。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">access_log /var/logs/nginx-access.log <span class="attribute">buffer</span>=32k gzip <span class="attribute">flush</span>=1m</span><br></pre></td></tr></table></figure>
<p>该例子指定日志的写入路径为/var/logs/nginx-access.log，日志格式使用默认的combined，指定日志的缓存大小为32k，日志写入前启用gzip进行压缩，压缩比使用默认值1，缓存数据有效时间为1分钟。</p>
<h2 id="使用log-format自定义日志格式"><a href="#使用log-format自定义日志格式" class="headerlink" title="使用log_format自定义日志格式"></a><strong>使用log_format自定义日志格式</strong></h2><p>Nginx预定义了名为combined日志格式，如果没有明确指定日志格式默认使用该格式：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> combined <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] '</span></span><br><span class="line">                    <span class="string">'"<span class="variable">$request</span>" <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> '</span></span><br><span class="line">                    <span class="string">'"<span class="variable">$http_referer</span>" "<span class="variable">$http_user_agent</span>"'</span>;</span><br></pre></td></tr></table></figure>
<p>如果不想使用Nginx预定义的格式，可以通过log_format指令来自定义。</p>
<h3 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h3><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_format name [<span class="built_in">escape</span>=<span class="keyword">default</span>|json] <span class="built_in">string</span> ...;</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>name 格式名称。在access_log指令中引用。</li>
<li>escape 设置变量中的字符编码方式是json还是default，默认是default。</li>
<li>string 要定义的日志格式内容。该参数可以有多个。参数中可以使用Nginx变量。</li>
</ul>
</blockquote>
<p>下面是log_format指令中常用的一些变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">bytes_sent</span></span><br><span class="line">发送给客户端的总字节数</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">body_bytes_sent</span></span><br><span class="line">发送给客户端的字节数，不包括响应头的大小</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">connection</span></span><br><span class="line">连接序列号</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">connection_requests</span></span><br><span class="line">当前通过连接发出的请求数量</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">msec</span></span><br><span class="line">日志写入时间，单位为秒，精度是毫秒</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">pipe</span></span><br><span class="line">如果请求是通过http流水线发送，则其值为"p"，否则为“."</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">request_length</span></span><br><span class="line">请求长度（包括请求行，请求头和请求体）</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">request_time</span></span><br><span class="line">请求处理时长，单位为秒，精度为毫秒，从读入客户端的第一个字节开始，直到把最后一个字符发送张客户端进行日志写入为止</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">status</span></span><br><span class="line">响应状态码</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">time_iso8601</span></span><br><span class="line">标准格式的本地时间,形如“2017-05-24T18:31:27+08:00”</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">time_local</span></span><br><span class="line">通用日志格式下的本地时间，如"24/May/2017:18:31:27 +0800"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">http_referer</span></span><br><span class="line">请求的referer地址。</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">http_user_agent</span></span><br><span class="line">客户端浏览器信息。</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">remote_addr</span></span><br><span class="line">客户端IP</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">http_x_forwarded_for</span></span><br><span class="line">当前端有代理服务器时，设置web节点记录客户端地址的配置，此参数生效的前提是代理服务器也要进行相关的x_forwarded_for设置。</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">request</span></span><br><span class="line">完整的原始请求行，如 "GET / HTTP/1.1"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">remote_user</span></span><br><span class="line">客户端用户名称，针对启用了用户认证的请求</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">request_uri</span></span><br><span class="line">完整的请求地址，如 "https://daojia.com/"</span><br></pre></td></tr></table></figure>
<p>下面演示一下自定义日志格式的使用：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">access_log</span> /var/logs/nginx-access.log main</span><br><span class="line">log_format  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                  <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                  <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br></pre></td></tr></table></figure>
<p>我们使用log_format指令定义了一个main的格式，并在access_log指令中引用了它。假如客户端有发起请求：<a href="https://suyunfe.com/，我们看一下我截取的一个请求的日志记录" target="_blank" rel="noopener">https://suyunfe.com/，我们看一下我截取的一个请求的日志记录</a>:</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">112.195</span>.<span class="number">209.90</span> - - [<span class="number">20</span>/Feb/<span class="number">2018</span>:<span class="number">12</span>:<span class="number">12</span>:<span class="number">14</span> +<span class="number">0800</span>] </span><br><span class="line"><span class="string">"GET / HTTP/1.1"</span> <span class="number">200</span> <span class="number">190</span> <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) </span></span><br><span class="line">AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">63.0</span>.<span class="number">3239.132</span> Mobile Safari/<span class="number">537.36</span><span class="string">" "</span>-<span class="string">"</span></span><br></pre></td></tr></table></figure>
<p>我们看到最终的日志记录中<code>$remote_user</code>、<code>$http_referer</code>、<code>$http_x_forwarded_for</code>都对应了一个<code>-</code>，这是因为这几个变量为空。</p>
<h2 id="设置error-log"><a href="#设置error-log" class="headerlink" title="设置error_log"></a><strong>设置error_log</strong></h2><p>错误日志在Nginx中是通过error_log指令实现的。该指令记录服务器和请求处理过程中的错误信息。</p>
<h3 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h3><p>配置错误日志文件的路径和日志级别。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">error_log <span class="built_in">file</span> [level];</span><br><span class="line">Default:    </span><br><span class="line">error_log logs/<span class="keyword">error</span>.<span class="built_in">log</span> <span class="keyword">error</span>;</span><br></pre></td></tr></table></figure>
<p>第一个参数指定日志的写入位置。</p>
<p>第二个参数指定日志的级别。level可以是debug, info, notice, warn, error, crit, alert,emerg中的任意值。可以看到其取值范围是按紧急程度从低到高排列的。只有日志的错误级别等于或高于level指定的值才会写入错误日志中。默认值是error。</p>
<h3 id="基本用法-1"><a href="#基本用法-1" class="headerlink" title="基本用法"></a>基本用法</h3><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_log /<span class="built_in">var</span>/logs/nginx/nginx-<span class="built_in">error</span>.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<p>它可以配置在：main， http, mail, stream, server, location作用域。</p>
<p>例子中指定了错误日志的路径为：<code>/var/logs/nginx/nginx-error.log</code>，日志级别使用默认的error。</p>
<h2 id="open-log-file-cache"><a href="#open-log-file-cache" class="headerlink" title="open_log_file_cache"></a><strong>open_log_file_cache</strong></h2><p>每一条日志记录的写入都是先打开文件再写入记录，然后关闭日志文件。如果你的日志文件路径中使用了变量，如<code>access_log /var/logs/$host/nginx-access.log</code>，为提高性能，可以使用open_log_file_cache指令设置日志文件描述符的缓存。</p>
<h3 id="语法-3"><a href="#语法-3" class="headerlink" title="语法"></a>语法</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_log_file_cache <span class="attribute">max</span>=N [<span class="attribute">inactive</span>=time] [<span class="attribute">min_uses</span>=N] [<span class="attribute">valid</span>=time];</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>max 设置缓存中最多容纳的文件描述符数量，如果被占满，采用LRU算法将描述符关闭。</li>
<li>inactive 设置缓存存活时间，默认是10s。</li>
<li>min_uses 在inactive时间段内，日志文件最少使用几次，该日志文件描述符记入缓存，默认是1次。</li>
<li>valid：设置多久对日志文件名进行检查，看是否发生变化，默认是60s。</li>
<li>off：不使用缓存。默认为off。</li>
</ul>
</blockquote>
<h3 id="基本用法-2"><a href="#基本用法-2" class="headerlink" title="基本用法"></a>基本用法</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_log_file_cache <span class="attribute">max</span>=1000 <span class="attribute">inactive</span>=20s <span class="attribute">valid</span>=1m <span class="attribute">min_uses</span>=2;</span><br></pre></td></tr></table></figure>
<p>它可以配置在http、server、location作用域中。</p>
<p>例子中，设置缓存最多缓存1000个日志文件描述符，20s内如果缓存中的日志文件描述符至少被被访问2次，才不会被缓存关闭。每隔1分钟检查缓存中的文件描述符的文件名是否还存在。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>Nginx中通过access_log和error_log指令配置访问日志和错误日志，通过log_format我们可以自定义日志格式。如果日志文件路径中使用了变量，我们可以通过open_log_file_cache指令来设置缓存，提升性能。</p>
<p>另外，在access_log和log_format中使用了很多变量，这些变量没有一一列举出来，详细的变量信息可以参考Nginx官方文档：<a href="http://nginx.org/en/docs/varindex.html" target="_blank" rel="noopener">http://nginx.org/en/docs/varindex.html</a></p>
<blockquote>
<p>作者：antwang</p>
<p>juejin.im/post/5aa09bb3f265da238f121b6c</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/09/转：HTTP请求方法：GET、HEAD、POST、PUT、DELETE、CONNECT、OPTIONS、TRACE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/09/转：HTTP请求方法：GET、HEAD、POST、PUT、DELETE、CONNECT、OPTIONS、TRACE/" itemprop="url">
                  转：HTTP请求方法：GET、HEAD、POST、PUT、DELETE、CONNECT、OPTIONS、TRACE
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-09 13:42:18" itemprop="dateCreated datePublished" datetime="2020-02-09T13:42:18+08:00">2020-02-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="HTTP请求方法：GET、HEAD、POST、PUT、DELETE、CONNECT、OPTIONS、TRACE"><a href="#HTTP请求方法：GET、HEAD、POST、PUT、DELETE、CONNECT、OPTIONS、TRACE" class="headerlink" title="HTTP请求方法：GET、HEAD、POST、PUT、DELETE、CONNECT、OPTIONS、TRACE"></a>HTTP请求方法：GET、HEAD、POST、PUT、DELETE、CONNECT、OPTIONS、TRACE</h1><p>原文：<a href="https://itbilu.com/other/relate/EkwKysXIl.html" target="_blank" rel="noopener">https://itbilu.com/other/relate/EkwKysXIl.html</a></p>
<p>超文本传输协议（HTTP, HyperText Transfer Protocol）是一种无状态的协议，它位于<a href="http://itbilu.com/nodejs/core/VkcdcFq9.html#OSI" target="_blank" rel="noopener">OSI七层模型</a>的传输层。HTTP客户端会根据需要构建合适的HTTP请求方法，而HTTP服务器会根据不同的HTTP请求方法做出不同的响应。</p>
<h3 id="1-HTTP版本与HTTP请求方法"><a href="#1-HTTP版本与HTTP请求方法" class="headerlink" title="1. HTTP版本与HTTP请求方法"></a>1. HTTP版本与HTTP请求方法</h3><p>在HTTP的发展过程中，出现了很多HTTP版本，其中的大部分协议都是向下兼容的。在进行HTTP请求时，客户端在请求时会告诉服务器它采用的协议版本号，而服务器则会在使用相同或者更早的协议版本进行响应。</p>
<h4 id="HTTP-0-9"><a href="#HTTP-0-9" class="headerlink" title="HTTP/0.9"></a>HTTP/0.9</h4><p>这是HTTP最早大规模使用的版，现已过时。在这个版本中 只有<code>GET</code>一种请求方法，在HTTP通讯也没有指定版本号，也不支持请求头信息。该版本不支持<code>POST</code>等方法，因此客户端向服务器传递信息的能力非常有限。<code>HTTP/0.9</code>的请求只有如下一行：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET www<span class="selector-class">.itbilu</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure>
<h4 id="HTTP-1-0"><a href="#HTTP-1-0" class="headerlink" title="HTTP/1.0"></a>HTTP/1.0</h4><p>这个版本是第一个在HTTP通讯中指定版本号的协议版本，<code>HTTP/1.0</code>至今仍被广泛采用，特别是在代理服务器中。</p>
<p><code>HTTP/1.0</code>支持：<code>GET</code>、<code>POST</code>、<code>HEAD</code>三种HTTP请求方法。</p>
<h4 id="HTTP-1-1"><a href="#HTTP-1-1" class="headerlink" title="HTTP/1.1"></a>HTTP/1.1</h4><p><code>HTTP/1.1</code>是当前正在使用的版本。该版本默认采用持久连接，并能很好地配合代理服务器工作。还支持以管道方式同时发送多个请求，以便降低线路负载，提高传输速度。</p>
<p><code>HTTP/1.1</code>新增了：<code>OPTIONS</code>、<code>PUT</code>、<code>DELETE</code>、<code>TRACE</code>、<code>CONNECT</code>五种HTTP请求方法。</p>
<h4 id="HTTP-2"><a href="#HTTP-2" class="headerlink" title="HTTP/2"></a>HTTP/2</h4><p>这个版本是最新发布的版本，于今年5月（2015年5月）做HTTP标准正式发布。<code>HTTP/2</code>通过支持请求与相应的多路重用来减少延迟，通过压缩HTTP头字段将协议开销降到最低，同时增加了对请求优先级和服务器端推送的支持。</p>
<h3 id="2-HTTP请求方法介绍"><a href="#2-HTTP请求方法介绍" class="headerlink" title="2. HTTP请求方法介绍"></a>2. HTTP请求方法介绍</h3><p><code>HTTP/1.1</code>协议中共定义了8种HTTP请求方法，HTTP请求方法也被叫做“请求动作”，不同的方法规定了不同的操作指定的资源方式。服务端也会根据不同的请求方法做不同的响应。</p>
<h4 id="GET"><a href="#GET" class="headerlink" title="GET"></a><code>GET</code></h4><p><code>GET</code>请求会<code>显示</code>请求指定的资源。一般来说<code>GET</code>方法应该只用于数据的读取，而不应当用于会产生副作用的<code>非幂等</code>的操作中。</p>
<p><code>GET</code>会方法请求指定的页面信息，并返回响应主体，<code>GET</code>被认为是不安全的方法，因为<code>GET</code>方法会被网络蜘蛛等任意的访问。</p>
<h4 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a><code>HEAD</code></h4><p><code>HEAD</code>方法与<code>GET</code>方法一样，都是向服务器发出指定资源的请求。但是，服务器在响应<code>HEAD</code>请求时不会回传资源的内容部分，即：响应主体。这样，我们可以不传输全部内容的情况下，就可以获取服务器的响应头信息。<code>HEAD</code>方法常被用于客户端查看服务器的性能。</p>
<h4 id="POST"><a href="#POST" class="headerlink" title="POST"></a><code>POST</code></h4><p><code>POST</code>请求会 向指定资源提交数据，请求服务器进行处理，如：表单数据提交、文件上传等，请求数据会被包含在请求体中。<code>POST</code>方法是<code>非幂等</code>的方法，因为这个请求可能会创建新的资源或/和修改现有资源。</p>
<h4 id="PUT"><a href="#PUT" class="headerlink" title="PUT"></a><code>PUT</code></h4><p><code>PUT</code>请求会身向指定资源位置上传其最新内容，<code>PUT</code>方法是<code>幂等</code>的方法。通过该方法客户端可以将指定资源的最新数据传送给服务器取代指定的资源的内容。</p>
<h4 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a><code>DELETE</code></h4><p><code>DELETE</code>请求用于请求服务器删除所请求<code>URI</code>（统一资源标识符，Uniform Resource Identifier）所标识的资源。<code>DELETE</code>请求后指定资源会被删除，<code>DELETE</code>方法也是<code>幂等</code>的。</p>
<h4 id="CONNECT"><a href="#CONNECT" class="headerlink" title="CONNECT"></a><code>CONNECT</code></h4><p><code>CONNECT</code>方法是<code>HTTP/1.1</code>协议预留的，能够将连接改为管道方式的代理服务器。通常用于<a href="http://itbilu.com/other/relate/N16Uaoyp.html" target="_blank" rel="noopener">SSL</a>加密服务器的链接与非加密的HTTP代理服务器的通信。</p>
<h4 id="OPTIONS"><a href="#OPTIONS" class="headerlink" title="OPTIONS"></a><code>OPTIONS</code></h4><p><code>OPTIONS</code>请求与<code>HEAD</code>类似，一般也是用于客户端查看服务器的性能。 这个方法会请求服务器返回该资源所支持的所有HTTP请求方法，该方法会用’*’来代替资源名称，向服务器发送<code>OPTIONS</code>请求，可以测试服务器功能是否正常。JavaScript的<a href="http://itbilu.com/javascript/js/VkiXuUcC.html" target="_blank" rel="noopener">XMLHttpRequest</a>对象进行<code>CORS</code>跨域资源共享时，就是使用<code>OPTIONS</code>方法发送嗅探请求，以判断是否有对指定资源的访问权限。 允许</p>
<h4 id="TRACE"><a href="#TRACE" class="headerlink" title="TRACE"></a><code>TRACE</code></h4><p><code>TRACE</code>请求服务器回显其收到的请求信息，该方法主要用于HTTP请求的测试或诊断。</p>
<p><strong>HTTP/1.1之后增加的方法</strong></p>
<p>在<code>HTTP/1.1</code>标准制定之后，又陆续扩展了一些方法。其中使用中较多的是 <code>PATCH</code> 方法：</p>
<h4 id="PATCH"><a href="#PATCH" class="headerlink" title="PATCH"></a><code>PATCH</code></h4><p><code>PATCH</code>方法出现的较晚，它在2010年的<a href="http://tools.ietf.org/html/rfc5789" target="_blank" rel="noopener">RFC 5789</a>标准中被定义。<code>PATCH</code>请求与<code>PUT</code>请求类似，同样用于资源的更新。二者有以下两点不同：</p>
<ul>
<li>但<code>PATCH</code>一般用于资源的部分更新，而<code>PUT</code>一般用于资源的整体更新。</li>
<li>当资源不存在时，<code>PATCH</code>会创建一个新的资源，而<code>PUT</code>只会对已在资源进行更新。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/08/python基础学习-转：Python中的if-name-main-该如何理解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/08/python基础学习-转：Python中的if-name-main-该如何理解/" itemprop="url">
                  python基础学习-转：Python中的if __name__ == '__main__'该如何理解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-08 20:39:03" itemprop="dateCreated datePublished" datetime="2020-02-08T20:39:03+08:00">2020-02-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Python-中的-if-name-39-main-39-该如何理解"><a href="#Python-中的-if-name-39-main-39-该如何理解" class="headerlink" title="Python 中的 if __name__ == &#39;__main__&#39;该如何理解"></a>Python 中的 <code>if __name__ == &#39;__main__&#39;</code>该如何理解</h1><p><em>Apr 24, 2017</em> |  <em>Python</em> |  <em>python</em></p>
<p>这个问题来自于<a href="https://www.zhihu.com/" target="_blank" rel="noopener">知乎</a>用户的<a href="https://www.zhihu.com/question/49136398" target="_blank" rel="noopener">提问</a>，当时看到这个问题，我只是做了下简单的回答。后来我发现，对于很多人来说，更准确的说应该是大部分的 Python 初学者，对这个问题理解的不是很深刻。所以这里我来做下总结，并试图把这个问题说明白。</p>
<h2 id="程序入口"><a href="#程序入口" class="headerlink" title="程序入口"></a>程序入口</h2><p>对于很多编程语言来说，程序都必须要有一个入口，比如 C，C++，以及完全面向对象的编程语言 Java，C# 等。如果你接触过这些语言，对于程序入口这个概念应该很好理解，C 和 C++ 都需要有一个 main 函数来作为程序的入口，也就是程序的运行会从 main 函数开始。同样，Java 和 C# 必须要有一个包含 Main 方法的主类来作为程序入口。</p>
<p>而 Python 则有不同，它属于脚本语言，不像编译型语言那样先将程序编译成二进制再运行，而是动态的逐行解释运行。也就是从脚本第一行开始运行，没有统一的入口。</p>
<p>一个 Python 源码文件除了可以被直接运行外，还可以作为模块（也就是库）被导入。不管是导入还是直接运行，最顶层的代码都会被运行（Python 用缩进来区分代码层次）。而实际上在导入的时候，有一部分代码我们是不希望被运行的。</p>
<p>举一个例子来说明一下，假设我们有一个 const.py 文件，内容如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PI = <span class="number">3.14</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"PI:"</span>, PI</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>
<p>我们在这个文件里边定义了一些常量，然后又写了一个 main 函数来输出定义的常量，最后运行 main 函数就相当于对定义做一遍人工检查，看看值设置的都对不对。然后我们直接执行该文件(python const.py),输出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PI: <span class="number">3.14</span></span><br></pre></td></tr></table></figure>
<p>现在，我们有一个 area.py 文件，用于计算圆的面积，该文件里边需要用到 const.py 文件中的 PI 变量，那么我们从 const.py 中把 PI 变量导入到 area.py 中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> const <span class="keyword">import</span> PI</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_round_area</span><span class="params">(radius)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> PI * (radius ** <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"round area: "</span>, calc_round_area(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>
<p>运行 area.py，输出结果：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">PI</span>: 3<span class="selector-class">.14</span></span><br><span class="line"><span class="selector-tag">round</span> <span class="selector-tag">area</span>:  12<span class="selector-class">.56</span></span><br></pre></td></tr></table></figure>
<p>可以看到，const 中的 main 函数也被运行了，实际上我们是不希望它被运行，提供 main 也只是为了对常量定义进行下测试。这时，<code>if __name__ == &#39;__main__&#39;</code> 就派上了用场。把 const.py 改一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PI = <span class="number">3.14</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"PI:"</span>, PI</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>然后再运行 area.py，输出如下：</p>
<figure class="highlight rsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">round</span> <span class="built_in">area</span>:  <span class="number">12.56</span></span><br></pre></td></tr></table></figure>
<p>再运行下 const.py，输出如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PI: <span class="number">3.14</span></span><br></pre></td></tr></table></figure>
<p>这才是我们想要的效果。</p>
<p><code>if __name__ == &#39;__main__&#39;</code> 就相当于是 Python <strong>模拟的程序入口</strong>。Python 本身并没有规定这么写，这只是一种编码习惯。由于模块之间相互引用，不同模块可能都有这样的定义，而入口程序只能有一个。到底哪个入口程序被选中，这取决于 <code>__name__</code> 的值。</p>
<h2 id="name"><a href="#name" class="headerlink" title="name"></a><strong>name</strong></h2><p><code>__name__</code> 是内置变量，用于表示当前模块的名字，同时还能反映一个包的结构。来举个例子，假设有如下一个包：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line">├── b</span><br><span class="line">│   ├── c.py</span><br><span class="line">│   └── __init__.py</span><br><span class="line">└── __init__.py</span><br></pre></td></tr></table></figure>
<p>目录中所有 py 文件的内容都为：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">print</span> __name__</span><br></pre></td></tr></table></figure>
<p>我们执行 <code>python -c &quot;import a.b.c&quot;</code>，输出结果：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line"><span class="selector-tag">a</span>.b</span><br><span class="line"><span class="selector-tag">a</span><span class="selector-class">.b</span><span class="selector-class">.c</span></span><br></pre></td></tr></table></figure>
<p>由此可见，<code>__name__</code> 可以清晰的反映一个模块在包中的层次。其实，所谓模块名就是 import 时需要用到的名字，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br></pre></td></tr></table></figure>
<p>这里的 tornado 和 tornado.web 就被称为模块的模块名。</p>
<p>如果一个模块被直接运行，则其没有包结构，其 <code>__name__</code> 值为 <code>__main__</code>。例如在上例中，我们直接运行 c.py 文件（python a/b/c.py），输出结果如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__main__</span><br></pre></td></tr></table></figure>
<p>所以，<code>if __name__ == &#39;__main__&#39;</code> 我们简单的理解就是： <strong>如果模块是被直接运行的，则代码块被运行，如果模块是被导入的，则代码块不被运行</strong>。</p>
<p>实际上，这个问题还可以衍生出其他的一些知识点，例如 <code>__main__.py</code> 文件与 Python 的 <code>-m</code> 参数。</p>
<h2 id="main-py-文件与-python-m"><a href="#main-py-文件与-python-m" class="headerlink" title="main.py 文件与 python -m"></a><strong>main</strong>.py 文件与 python -m</h2><p>Python 的 <code>-m</code> 参数用于将一个模块或者包作为一个脚本运行，而 <code>__main__.py</code> 文件则相当于是一个包的”入口程序“。</p>
<p>首先我们需要来看看 <code>python xxx.py</code> 与 <code>python -m xxx.py</code> 的区别。两种运行 Python 程序的方式的不同点在于，一种是直接运行，一种是当做模块来运行。</p>
<p>先来看一个简单的例子，假设有一个 Python 文件 run.py，其内容如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">print</span> sys.path</span><br></pre></td></tr></table></figure>
<p>我们用直接运行的方式启动（python run.py），输出结果(为了说明问题，输出结果只截取了重要部分，下同)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'/home/huoty/aboutme/pythonstudy/main'</span>, ...]</span><br></pre></td></tr></table></figure>
<p>然后以模块的方式运行（python -m run.py）:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">''</span>, ...]</span><br><span class="line">/usr/bin/python: No module named run.py</span><br></pre></td></tr></table></figure>
<p>由于输出结果只列出了关键的部分，应该很容易看出他们之间的差异。直接运行是把 run.py 文件所在的目录放到了 sys.path 属性中。以模块方式运行是把你输入命令的目录（也就是当前工作路径），放到了 sys.path 属性中。以模块方式运行还有一个不同的地方是，多出了一行 <code>No module named run.py</code> 的错误。实际上以模块方式运行时，Python 先对 run.py 执行一遍 import，所以 <code>print sys.path</code> 被成功执行，然后 Python 才尝试运行 run.py 模块，但是，在 path 变量中并没有 run.py 这个模块，所以报错。而正确的运行方式，应该是 <code>python -m run</code>.</p>
<p>这个例子并不能明显的说明问题。接着我们来看看 <code>__main__.py</code> 的作用。</p>
<p>仍然先看例子，有如下一个包：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span></span><br><span class="line">├── __init__.py</span><br><span class="line">└── __main__.py</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>init</strong>.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">print</span> <span class="string">"__init__"</span></span><br><span class="line"><span class="keyword">print</span> sys.path</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>main</strong>.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">print</span> <span class="string">"__main__"</span></span><br><span class="line"><span class="keyword">print</span> sys.path</span><br></pre></td></tr></table></figure>
<p>用 <code>python -m package</code> 运行结果：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__init__</span><br><span class="line">[<span class="string">''</span>, ...]</span><br><span class="line">__main__</span><br><span class="line">[<span class="string">''</span>, ...]</span><br></pre></td></tr></table></figure>
<p>用 <code>python package</code> 运行结果：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__main__</span><br><span class="line">[<span class="string">'package'</span>, ...]</span><br></pre></td></tr></table></figure>
<p>然后我们来总结一下：</p>
<ul>
<li>1、 <strong>加上 -m 参数时会把当前工作目录添加到 sys.path 中，而不加时则会把脚本所在目录添加到 sys.path 中</strong>。</li>
<li>2、 <strong>加上 -m 参数时 Python 会先将模块或者包导入，然后再执行</strong></li>
<li>3、 <strong><strong>main</strong>.py 文件是一个包或者目录的入口程序。</strong>不管是用 <code>python package</code> 还是用 <code>python -m package</code> 运行时，<strong>main</strong>.py 文件总是被执行。</li>
</ul>
<h2 id="后序"><a href="#后序" class="headerlink" title="后序"></a>后序</h2><p>我试图使用长篇大论来阐述，在 Python 中如何理解 <code>if __name__ == &#39;__main__&#39;</code> 这个问题，不知道我有没有描述得足够的明白。Python 的确是简单的，优雅的，但也有很多问题是不太容易理解的，例如很多高级的特性，像元类、生成器表达式、描述符、协程等。Python 并没有在太多的地方规定要如何如何，很多的用法只是惯用法，例如 self 和本文讨论的内容。这些用法或是为了让代码看起来更优雅，或是前人的经验。使用 Python 是有无限可能的，你可以写出很多简洁优雅的代码。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://www.tuicool.com/articles/jMzqYzF" target="_blank" rel="noopener">http://www.tuicool.com/articles/jMzqYzF</a></li>
<li><a href="http://stackoverflow.com/questions/4042905/what-is-main-py" target="_blank" rel="noopener">http://stackoverflow.com/questions/4042905/what-is-main-py</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/07/内网主机使用ossutil工具访问阿里OSS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/07/内网主机使用ossutil工具访问阿里OSS/" itemprop="url">
                  内网主机使用ossutil工具访问阿里OSS
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-07 20:01:55" itemprop="dateCreated datePublished" datetime="2020-02-07T20:01:55+08:00">2020-02-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>线下主机只能使用内网，并且无法只能使用NFS和FTP共享资源，因为这台主机要共享的目录也是挂载的其他主机的nfs服务，也就是说需要这台主机共享自己挂载的NFS目录，这样做好像是不可以的，因为使用exportfs -arv命令时一时提示此目录不支持NFS。所以就部署了FTP服务，阿里云主机通过专线访问FTP服务，并使用工具挂载FTP服务。如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">歌华分享vsftpd服务，阿里挂载</span><br><span class="line">线下</span><br><span class="line">yum install vsftpd</span><br><span class="line">useradd xorupload</span><br><span class="line">echo 'HELPbjcloud20190729!'|passwd --stdin xorupload</span><br><span class="line">vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">关闭匿名访问</span><br><span class="line">关闭使用本地用户</span><br><span class="line">local_root=/vod</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只需要改变这个默认的目录即可。这和用户的家目录没有关系，但还要用本地用户登录</span></span><br><span class="line">systemctl start vsftpd</span><br><span class="line">systemctl enable vsftpd</span><br><span class="line"></span><br><span class="line">阿里</span><br><span class="line">yum install curlftpfs</span><br><span class="line">curlftpfs -o codepage=utf8 ftp://xorupload:'HELPbjcloud20190729!'@172.16.201.44 /media</span><br><span class="line"><span class="meta">#</span><span class="bash"> 挂载</span></span><br><span class="line">fusermount -u /media</span><br><span class="line"><span class="meta">#</span><span class="bash"> 卸载</span></span><br></pre></td></tr></table></figure>
<p>这样做是可以实现功能的，但速度非常慢，阿里主机起的作用就是将线下的资源上传到阿里的OSS服务上，从本地上传或从本地使用lftp连接FTP服务下载的速度都没有问题，但要实现直接从FTP挂载点上传到阿里OSS上时，速度就马上降了下来。之后还考虑使用sshfs命令挂载文件系统，但线下不开放SSH服务给非内网主机，所以无法实现。最后想到使用阿里主机做代理，线下主机直接使用阿里的ossutil工具，通过代理上传资源到阿里OSS上，最后成功实现，方法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">   阿里ECS</span><br><span class="line">------------</span><br><span class="line">vim /etc/nginx/conf.d/ossreverse-internal.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name oss-cn-beijing-internal.aliyuncs.com;</span><br><span class="line">    access_log /var/log/nginx/endpoint.log;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://oss-cn-beijing-internal.aliyuncs.com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name bjy-edu.oss-cn-beijing-internal.aliyuncs.com;</span><br><span class="line">    access_log /var/log/nginx/endpoint.log;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://bjy-edu.oss-cn-beijing-internal.aliyuncs.com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里设置的nginx主机域名和实际的OSS的endpoint和域名是一样的</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">   线下主机</span><br><span class="line">------------</span><br><span class="line">下载ossutil64工具</span><br><span class="line">chmod +x ossutil64</span><br><span class="line">cp ossutil64 /sbin</span><br><span class="line">ossutil64 config</span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化，一直回车</span></span><br><span class="line">vim .ossutilconfig</span><br><span class="line">[Credentials]</span><br><span class="line">language=EN</span><br><span class="line">endpoint=http://oss-cn-beijing-internal.aliyuncs.com</span><br><span class="line">accessKeyID=LTAI4FnMoMFemG6j3KFbj</span><br><span class="line">accessKeySecret=AC8W0CB3AQ181oW9AF9aYzfXA</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置ossutile工具，注意，endpoint要使用内网，这样才能保证网速。另外要配置对bucket有权限控制的accesskey</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">172.16.211.110  oss-cn-beijing-internal.aliyuncs.com bjy-edu.oss-cn-beijing-internal.aliyuncs.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 把两个域名都解析到代理服务器上</span></span><br><span class="line">ossutil64 ls</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试是否可以使用了</span></span><br><span class="line">下面创建一个目录，这个目录保存了导出的节目清单，我们要从清单中取得节目的路径并上传到OSS上。这里设置保存</span><br><span class="line">的目录为/xor/data2/bjos</span><br><span class="line">vim /root/aliupload/filecheck.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">ls /xor/data2/bjos/target*.txt</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">    for i in `ls /xor/data2/bjos/target*`;do</span><br><span class="line">        if [ -f $i ] ;then</span><br><span class="line">	    awk -F '?' '&#123;print $1&#125;' $i | awk -F '/' '&#123;print "/"$4"/"$5"/"$6"/"$7"/"$8&#125;' &gt;&gt; /xor/data2/bjos/current_upload/upload_`basename $i|awk -F . '&#123;print $1&#125;'`_`date +%Y%m%d`.txt</span><br><span class="line">        fi</span><br><span class="line">        mv $i /xor/data2/bjos/old_upload</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在这里处理过target文件后，就直接移走。这比在最后一起移走的逻辑要严谨。因为可能在脚本执行中，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会有新的target文件生成，但并没有在这处理，但最后会被脚本一起移走，这样就会出现没处理过的target文件。</span></span><br><span class="line">    done</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        for j in `ls /xor/data2/bjos/current_upload/*`;do</span><br><span class="line">	    	if [ `grep -c '.m3u8' $j` -gt 0 ];then </span><br><span class="line">	    	# grep的-c选项只统计匹配到的行数，这里如果大于0说明找到了内容</span><br><span class="line">				cp $j $&#123;j&#125;_ts</span><br><span class="line">				sed -i -e 's@.m3u8@@g' -e 's@_@/@g' $&#123;j&#125;_ts</span><br><span class="line"><span class="meta">			#</span><span class="bash"> 匹配替换多个值</span></span><br><span class="line">	    	fi</span><br><span class="line">		done</span><br><span class="line">		for w in `ls /xor/data2/bjos/current_upload/*`;do</span><br><span class="line">            while read line;do</span><br><span class="line">                /root/aliupload/ossutil64 cp -rfu -j 5 --loglevel info $line oss://bjy-edu$line</span><br><span class="line"><span class="meta">#</span><span class="bash"> 直接使用ossutil64会有找不到命令的报错，但使用上并没有问题。也许是环境变量的问题，所以使用了绝对路径</span></span><br><span class="line">            done &lt; $w</span><br><span class="line">        done</span><br><span class="line">    fi</span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="keyword">for</span> l <span class="keyword">in</span> `ls /xor/data2/bjos/*`;<span class="keyword">do</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">        <span class="keyword">if</span> [ -f <span class="variable">$l</span> ];<span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">            mv <span class="variable">$l</span> /xor/data2/bjos/old_upload</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        <span class="keyword">fi</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="keyword">done</span>  <span class="comment"># 在这里才处理target文件会有上面所说的未处理的target文件被移走的问题</span></span></span><br><span class="line">    for m in `ls /xor/data2/bjos/current_upload/*`;do</span><br><span class="line">        mv $m /xor/data2/bjos/old_upload</span><br><span class="line">    done</span><br><span class="line">    #kill -9 `lsof /xor/data2/bjos|awk '&#123;print $2&#125;'|tail -1`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开始以为是有别的程序在操作/xor/data2/bjos这个目录，所以最后使用lsof查看哪个程序在使用这个目录，并</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 把它杀死。之后发现是定时任务有问题。</span></span><br><span class="line">    exit 0</span><br><span class="line">else</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">crontab -e</span><br><span class="line">1 */2 * * * /bin/bash /root/aliupload/filecheck.sh &gt;&gt;  /root/aliupload/upload.log 2&amp;&gt;1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试发现，在设置执行时间时如果不指定第一个值，似乎会每两小时的每分钟执行一次，所以/xor/data2/bjos目录中的文件一直有问题，放在这个目录下的.txt文件总会被移动到old_upload目录中。错误方法如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> * */2 * * * /bin/bash /root/aliupload/filecheck.sh &gt;&gt;  /root/aliupload/upload.log 2&amp;&gt;1</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-浏览器分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-浏览器分析/" itemprop="url">
                  python基础学习-浏览器分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:29:14" itemprop="dateCreated datePublished" datetime="2020-02-06T10:29:14+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="浏览器分析"><a href="#浏览器分析" class="headerlink" title="浏览器分析"></a>浏览器分析</h3><h4 id="useragent"><a href="#useragent" class="headerlink" title="useragent"></a>useragent</h4><p>这里指的是，软件按照一定的格式向远端的服务器提供一个标识自己的字符串。</p>
<p>在HTTP协议中，使用user-agent字段传送这个字符串。</p>
<p>注意：这个值可以被修改</p>
<p>格式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">现在浏览器的user-agent值格式一般如下：</span><br><span class="line">Mozilla/[version] ([system <span class="keyword">and</span> browser information]) [platform] ([platform details]) [extensions]</span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line">chrome</span><br><span class="line">Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">6.1</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">57.0</span><span class="number">.2987</span><span class="number">.133</span> Safari/<span class="number">537.36</span></span><br><span class="line"></span><br><span class="line">Firefox</span><br><span class="line">Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">6.1</span>; Win64; x64; rv:<span class="number">56.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">56.0</span></span><br><span class="line">Mozilla/<span class="number">5.0</span> (X11; Ubuntu; Linux x86_64; rv:<span class="number">52.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">52.0</span></span><br><span class="line"></span><br><span class="line">IE</span><br><span class="line">Mozilla/<span class="number">5.0</span> (compatible; MSIE <span class="number">10.0</span>; Windows NT <span class="number">6.1</span>; WOW64; Trident/<span class="number">6.0</span>; SLCC2; .NET CLR <span class="number">2.0</span><span class="number">.50727</span>; .NET CLR <span class="number">3.5</span><span class="number">.30729</span>; .NET CLR <span class="number">3.0</span><span class="number">.30729</span>; Media Center PC <span class="number">6.0</span>; .NET4<span class="number">.0</span>C; .NET4<span class="number">.0</span>E)</span><br></pre></td></tr></table></figure>
<h4 id="信息提取"><a href="#信息提取" class="headerlink" title="信息提取"></a>信息提取</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pyyaml、ua-parser、user-agents模块</span><br><span class="line">安装</span><br><span class="line">pip install pyaml ua-parser user-agents</span><br><span class="line">使用</span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">useragents = [</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:56.0) Gecko/20100101 Firefox/56.0"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E)"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> uastring <span class="keyword">in</span> useragents:</span><br><span class="line">    ua = parse(uastring)</span><br><span class="line">    print(ua.browser, ua.browser.family, ua.browser.version, ua.browser.version_string)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 运行结构</span></span><br><span class="line">Browser(family=<span class="string">'Chrome'</span>, version=(<span class="number">57</span>, <span class="number">0</span>, <span class="number">2987</span>), version_string=<span class="string">'57.0.2987'</span>) Chrome (<span class="number">57</span>, <span class="number">0</span>, <span class="number">2987</span>) <span class="number">57.0</span><span class="number">.2987</span></span><br><span class="line">Browser(family=<span class="string">'Firefox'</span>, version=(<span class="number">56</span>, <span class="number">0</span>), version_string=<span class="string">'56.0'</span>) Firefox (<span class="number">56</span>, <span class="number">0</span>) <span class="number">56.0</span></span><br><span class="line">Browser(family=<span class="string">'Firefox'</span>, version=(<span class="number">52</span>, <span class="number">0</span>), version_string=<span class="string">'52.0'</span>) Firefox (<span class="number">52</span>, <span class="number">0</span>) <span class="number">52.0</span></span><br><span class="line">Browser(family=<span class="string">'IE'</span>, version=(<span class="number">10</span>, <span class="number">0</span>), version_string=<span class="string">'10.0'</span> <span class="number">10.0</span>)</span><br></pre></td></tr></table></figure>
<p>ua.browser.family和ua.browser.version_string分别返回浏览器名称、版本号。</p>
<h4 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h4><p>ops 增加对useragent的处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> timestr: datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int,</span><br><span class="line">    <span class="string">'length'</span>:int,</span><br><span class="line">    <span class="string">'request'</span>:<span class="keyword">lambda</span> request:dict(zip((<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>),request.split())),</span><br><span class="line">    <span class="string">'useragent'</span>:<span class="keyword">lambda</span> useragent: parse(useragent)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> datestr: datetime.datetime.strptime(datestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int,</span><br><span class="line">    <span class="string">'size'</span>:int,</span><br><span class="line">    <span class="string">'useragent'</span>:<span class="keyword">lambda</span> ua: parse(ua)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加浏览器分析函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">browser_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    browsers = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        ua = item[<span class="string">'useragent'</span>]</span><br><span class="line">        key = (ua.browser.family, ua.browser.version_string)</span><br><span class="line">        browsers[key] = browsers.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> browsers</span><br></pre></td></tr></table></figure>
<p>注册handler，注意时间窗口宽度</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg(browser_handler, <span class="number">5</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>问题</p>
<p>如果想知道所有浏览器的统计，怎么办？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">allbrowsers = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器分析</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">browser_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    browsers = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        ua = item[<span class="string">'useragent'</span>]</span><br><span class="line">        key = (ua.browser.family, ua.browser.version_string)</span><br><span class="line">        browsers[key] = browsers.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        allbrowsers[key] = allbrowsers.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">    print(sorted(allbrowsers.items(), key=kambda x:x[<span class="number">1</span>], reverse=<span class="keyword">True</span>)[:<span class="number">10</span>])</span><br><span class="line">    <span class="keyword">return</span> browsers</span><br></pre></td></tr></table></figure>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据源</span></span><br><span class="line">PATTERN = <span class="string">'''(?P&lt;remote&gt;[\d\.]&#123;7,&#125;)\s-\s-\s\[(?P&lt;datetime&gt;[^\[\]]+)\]\s\</span></span><br><span class="line"><span class="string">"(?P&lt;method&gt;.*)\s(?P&lt;url&gt;.*)\s(?P&lt;protocol&gt;.*)"\s\</span></span><br><span class="line"><span class="string">(?P&lt;status&gt;\d&#123;3&#125;)\s(?P&lt;size&gt;\d+)\s"[^"]+"\s"(?P&lt;useragent&gt;[^"]+)'''</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(PATTERN) <span class="comment"># 编译</span></span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> datestr:datetime.datetime.strptime(datestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int</span><br><span class="line">    <span class="string">'size'</span>:int</span><br><span class="line">    <span class="string">'useragent'</span>:<span class="keyword">lambda</span> ua:parse(ua)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extrace</span><span class="params">(line:str)</span> -&gt; dict:</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">if</span> matcher:</span><br><span class="line">        <span class="keyword">return</span> &#123;name:ops.get(name, <span class="keyword">lambda</span> x:x)(data) <span class="keyword">for</span> name, data <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 装载文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openfile</span><span class="params">(path:str)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            fields = extract(line)</span><br><span class="line">            <span class="keyword">if</span> fields:</span><br><span class="line">                <span class="keyword">yield</span> fields</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># TODO 解析失败则抛弃或者记录日志</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(*path)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> paths:</span><br><span class="line">        p = Path(item)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.exists():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> p.is_dir():</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> p.iterdir():</span><br><span class="line">                <span class="keyword">if</span> file.is_file():</span><br><span class="line">                    <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(file))</span><br><span class="line">        <span class="keyword">elif</span> p.is_file():</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(p))</span><br><span class="line">                </span><br><span class="line"><span class="comment"># 数据处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(second=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""生成数据"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">'datetime'</span>:datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=<span class="number">8</span>))),</span><br><span class="line">            <span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(second)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 滑动窗口函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src:Queue, handler, width:int, interval:int)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    窗口函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param src: 数据源，缓存队列，用来拿数据</span></span><br><span class="line"><span class="string">    :param handler: 数据处理函数</span></span><br><span class="line"><span class="string">    :param width: 时间窗口宽度，秒</span></span><br><span class="line"><span class="string">    :param interval: 处理时间间隔，秒</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    start = datetime.datetime.strptime(<span class="string">'20170101 000000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'20170101 010000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    buffer = [] <span class="comment"># 窗口中的待计算数据</span></span><br><span class="line">    delta = datetime.timedelta(seconds=width-interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 从数据源获取数据</span></span><br><span class="line">        data = src.get()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data) <span class="comment"># 存入临时缓冲等待计算</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 每隔interval计算buffer中的数据一次</span></span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line">            ret = handler(buffer)</span><br><span class="line">            print(<span class="string">'&#123;&#125;'</span>.format(ret))</span><br><span class="line">            start = current</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 清除超出width的数据</span></span><br><span class="line">            buffer = [x <span class="keyword">for</span> x <span class="keyword">in</span> buffer <span class="keyword">if</span>  x[<span class="string">'datetiem'</span>] &gt; current - delta]</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 随机数平均数测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x:x[<span class="string">'value'</span>],iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">donothing_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> iterable</span><br><span class="line"><span class="comment"># 状态码占比</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">status_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    status = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        key = item[<span class="string">'status'</span>]</span><br><span class="line">        status[key] = status.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    <span class="comment"># total = sum(status.values())</span></span><br><span class="line">    total = len(iterable)</span><br><span class="line">    <span class="keyword">return</span> &#123;k:status[k]/total <span class="keyword">for</span> k,v <span class="keyword">in</span> status.items()&#125;</span><br><span class="line"></span><br><span class="line">allbrowsers = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器分析</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">browser_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    browsers = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        ua = item[<span class="string">'useragent'</span>]</span><br><span class="line">        key=(ua.browser.family, ua.browser.version_string)</span><br><span class="line">        browsers[key] = browsers.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        allbrowsers[key] = allbrowsers.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">    print(sorted(aoobrowsers.items(), key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>], reverse=<span class="keyword">True</span>)[:<span class="number">10</span>])</span><br><span class="line">    <span class="keyword">return</span> browsers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="comment"># 分发器中记录handler，同时保存各自的队列</span></span><br><span class="line">    handlers = []</span><br><span class="line">    queues = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(handler, width:int, interval:int)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        注册 窗口处理函数</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :param handler: 注册的数据处理函数</span></span><br><span class="line"><span class="string">        :param width: 时间窗口宽度</span></span><br><span class="line"><span class="string">        :param interval: 时间间隔</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        q = Queue()</span><br><span class="line">        queues.append(q)</span><br><span class="line">        </span><br><span class="line">        h = threading.Thread(target=window, args=(q, handler, width, interval))</span><br><span class="line">        handlers.append(h)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> handlers:</span><br><span class="line">            t.start() <span class="comment"># 启动线程处理数据</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> src: <span class="comment"># 将数据源取到的数据分发到所有队列中</span></span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> queues:</span><br><span class="line">                q.put(item)</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> reg, run</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"main"</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="comment"># path = sys.argv[1]</span></span><br><span class="line">    path = <span class="string">'test.log'</span></span><br><span class="line">    </span><br><span class="line">    reg, run = dispatcher(load(path))</span><br><span class="line"><span class="comment"># dispatcher()返回的是reg和run函数，把这两个函数赋值给reg和run，下面再调用这两个函数并传参</span></span><br><span class="line">    reg(donothing_handler, <span class="number">10</span>, <span class="number">5</span>) <span class="comment"># 注册处理函数</span></span><br><span class="line">    reg(browser_handler, <span class="number">5</span>, <span class="number">5</span>)</span><br><span class="line">    run() <span class="comment"># 运行</span></span><br></pre></td></tr></table></figure>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 代码在信息提取中</span></span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">u = <span class="string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert</span><span class="params">(u)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> parse(u)  <span class="comment"># 返回一个user-agent对象</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#  print(ua.browser)</span></span><br><span class="line">  <span class="comment">#  return (ua.browser.family, ua.browser.version_string)  # 这样可以取得浏览器名称与版本号</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-文件加载及分析器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-文件加载及分析器/" itemprop="url">
                  python基础学习-文件加载及分析器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:29:04" itemprop="dateCreated datePublished" datetime="2020-02-06T10:29:04+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="完成分析功能"><a href="#完成分析功能" class="headerlink" title="完成分析功能"></a>完成分析功能</h4><p>分析日志很重要，通过海量数据分析就能够知道是否遭受了攻击，是否被爬取及爬取高峰期，是否有盗链等。</p>
<p>百度（Baidu）爬虫名称（Baiduspider）</p>
<p>谷歌（Google）爬虫名称（Googlebot）</p>
<h4 id="状态码分析"><a href="#状态码分析" class="headerlink" title="状态码分析"></a>状态码分析</h4><p>状态码中包含了很多信息。例如</p>
<p>304，服务器收到客户端提交的请求参数，发现资源未变化，要求浏览器使用静态资源的缓存</p>
<p>404，服务器找不到请求的资源</p>
<p>304占比大，说明静态缓存效果明显。404占比大，说明网站出现了错误链接，或者尝试嗅探网站资源。</p>
<p>如果400、500占比突然开始增大，网站一定出问题了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 状态码占比</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">status_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="comment"># 时间窗口内的一批数据</span></span><br><span class="line">    status = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        key = item[<span class="string">'status'</span>]</span><br><span class="line">        status[key] = status.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        <span class="comment"># total = sum(status.values())</span></span><br><span class="line">        total = len(iterable)</span><br><span class="line">        <span class="keyword">return</span> &#123;k:status[k]/total <span class="keyword">for</span> k,v <span class="keyword">in</span> status.items()&#125;</span><br></pre></td></tr></table></figure>
<p>如果还需要什么分析，增加分析函数handler注册就行了</p>
<h4 id="日志文件的加载"><a href="#日志文件的加载" class="headerlink" title="日志文件的加载"></a>日志文件的加载</h4><p>目前实现的代码中，只能接受一个路径，修改为接受一批路径。</p>
<p>可以约定一下路径下文件的存入方式：</p>
<p>如果送来的是一批路径，就迭代其中路径。</p>
<p>如果路径是一个普通文件，就按照行读取内容。</p>
<p>如果路径是一个目录，就遍历路径下所有普通文件，每一个文件按照行处理。不递归处理子目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(*paths)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> paths:</span><br><span class="line">        p = Path(item)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.exists():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> p.is_dir():</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> p.iterdir():</span><br><span class="line">                <span class="keyword">if</span> file.is_file():</span><br><span class="line">                    <span class="keyword">pass</span> <span class="comment"># 和下面处理一样</span></span><br><span class="line">        <span class="keyword">elif</span> p.is_file():</span><br><span class="line">            <span class="keyword">with</span> open(str(p)) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                    fields = extract(line)</span><br><span class="line">                    <span class="keyword">if</span> fields:</span><br><span class="line">                        <span class="keyword">yield</span> fields</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">continue</span> <span class="comment"># TODO 解析失败则抛弃或者记录日志</span></span><br></pre></td></tr></table></figure>
<p>写的过程中发现重复的地方，把文件处理部分提出来写成函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openfile</span><span class="params">(path:str)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            fields = extract(line)</span><br><span class="line">            <span class="keyword">if</span> fields:</span><br><span class="line">                <span class="keyword">yield</span> fields</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># TODO 解析失败则抛弃或者记录日志</span></span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(*paths)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> paths:</span><br><span class="line">        p = Path(item)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.exists():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> p.is_dir():</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> p.iterdir():</span><br><span class="line">                <span class="keyword">if</span> file.is_file():</span><br><span class="line">                    <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(file))</span><br><span class="line">        <span class="keyword">elif</span> p.is_file():</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(p))</span><br></pre></td></tr></table></figure>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据源</span></span><br><span class="line">PATTERN = <span class="string">'''(?P&lt;remote&gt;[\d\.]&#123;7,&#125;)\s-\s-\s\[(?P&lt;datetime&gt;[^\[\]]+)\]\s\</span></span><br><span class="line"><span class="string">"(?P&lt;method&gt;.*)\s(?P&lt;url&gt;.*)\s(?P&lt;protocol&gt;.*)"\s\</span></span><br><span class="line"><span class="string">(?P&lt;status&gt;\d&#123;3&#125;)\s(?P&lt;size&gt;\d+)\s"[^"]+"\s"(?P&lt;useragent&gt;[^"]+)'''</span></span><br><span class="line">regex = re.compile(PATTERN)</span><br><span class="line"></span><br><span class="line">OPS = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> datestr: datetime.datetime.strptime(datestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int,</span><br><span class="line">    <span class="string">'size'</span>:int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(line:str)</span> -&gt; dict:</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">if</span> matcher:</span><br><span class="line">        <span class="keyword">return</span> &#123;name:ops.get(name, <span class="keyword">lambda</span> x:x)(data) <span class="keyword">for</span> name, data <span class="keyword">in</span> matcher.groupdict()items()&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 装载文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openfile</span><span class="params">(path:str)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            fields = extract(line)</span><br><span class="line">            <span class="keyword">if</span> fields:</span><br><span class="line">                <span class="keyword">yield</span> fields</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># TODO解析失败则抛弃或者记录日志</span></span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(*paths)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> paths:</span><br><span class="line">        p = Path(item)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.exists():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> p.is_dir():</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> p.iterdir():</span><br><span class="line">                <span class="keyword">if</span> file.is_file():</span><br><span class="line">                    <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(file))</span><br><span class="line">        <span class="keyword">elif</span> p.is_file():</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(p))</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 数据处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(second=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""生成数据"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">'datetime'</span>:datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=<span class="number">8</span>))),</span><br><span class="line">            <span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(second)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 滑动窗口函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src:Queue, handler, width:int, interval:int)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    窗口函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param src: 数据源，缓存队列，用来拿数据</span></span><br><span class="line"><span class="string">    :param handler: 数据处理函数</span></span><br><span class="line"><span class="string">    :param width: 时间窗口宽度，秒</span></span><br><span class="line"><span class="string">    :param interval: 处理时间间隔，秒</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    start = datetime.datetime.strptime(<span class="string">'20170101 000000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'20170101 010000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    buffer = [] <span class="comment"># 窗口中的待计算数据</span></span><br><span class="line">    delta = datetime.timedelta(seconds=width-interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 从数据源获取数据</span></span><br><span class="line">        data = src.get()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data) <span class="comment"># 存入临时缓冲等待计算</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 每隔interval计算buffer中的数据一次</span></span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line">            ret = handler(buffer)</span><br><span class="line">            print(<span class="string">'&#123;&#125;'</span>.format(ret))</span><br><span class="line">            start = current</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 清除超出width的数据</span></span><br><span class="line">            buffer = [x <span class="keyword">for</span> x <span class="keyword">in</span> buffer <span class="keyword">if</span> x[<span class="string">'datetime'</span>] &gt; current - delta]</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 随机数平均数测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x:x[<span class="string">'value'</span>], iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">donothing_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> iterable</span><br><span class="line"></span><br><span class="line"><span class="comment"># 状态码占比</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">status_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="comment"># 时间窗口内的一批数据</span></span><br><span class="line">    status = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        key = item[<span class="string">'status'</span>]</span><br><span class="line">        status[key] = status.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    <span class="comment"># total = sum(status.values())</span></span><br><span class="line">    total = len(iterable)</span><br><span class="line">    <span class="keyword">return</span> &#123;k:status[k]/total <span class="keyword">for</span> k,v <span class="keyword">in</span> status.items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="comment"># 分发器中记录handler，同时保存各自的队列</span></span><br><span class="line">    handlers = []</span><br><span class="line">    queues = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(handler, width:int, interval:int)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        注册 窗口处理函数</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :param handler: 注册的数据处理函数</span></span><br><span class="line"><span class="string">        :param width: 时间窗口宽度</span></span><br><span class="line"><span class="string">        :param interval: 时间间隔</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        q = Queue()</span><br><span class="line">        queues.append(q)</span><br><span class="line">        </span><br><span class="line">        h = threading.Thread(target=window, args=(q, handler, width, interval))</span><br><span class="line">        handlers.append(h)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> handlers:</span><br><span class="line">            t.start() <span class="comment"># 启动线程处理数据</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> src:</span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> queues:</span><br><span class="line">                q.put(item)</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> reg, run</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="comment">#path = sys.argv[1]</span></span><br><span class="line">    path = <span class="string">'test.log'</span></span><br><span class="line">    </span><br><span class="line">    reg, run = dispatcher(load(path))</span><br><span class="line">    reg(status_handler, <span class="number">10</span>, <span class="number">5</span>) <span class="comment"># 注册</span></span><br><span class="line">    run() <span class="comment"># 运行</span></span><br></pre></td></tr></table></figure>
<p>到这里，一个离线日志分析项目基本完成。</p>
<ol>
<li>可以指定文件或目录，对日志进行数据分析</li>
<li>分析函数可以动态注册</li>
<li>数据可以分发给不同的分析处理程序处理</li>
</ol>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 代码在信息提取中</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-数据分发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-数据分发/" itemprop="url">
                  python基础学习-数据分发
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:28:53" itemprop="dateCreated datePublished" datetime="2020-02-06T10:28:53+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="分发"><a href="#分发" class="headerlink" title="分发"></a>分发</h3><h4 id="生产者消费者模型"><a href="#生产者消费者模型" class="headerlink" title="生产者消费者模型"></a>生产者消费者模型</h4><p>对于一个监控系统，需要处理很多数据，包括日志。对其中已有数据的采集、分析。被监控对象就是数据的生产者producer，数据的处理程序就是数据的消费者consumer。</p>
<p>生产者消费者传统模型</p>
<p><img src="/images/python数据分发/数据分发1.png" alt=""></p>
<p>传统的生产者消费者模型，生产者生产，消费者消费。但这种模型有些问题。开发的代码耦合太高，如果生成规模扩大，不易扩展，生产和消费的速度很难匹配等。</p>
<p>思考一下，生产者和消费者的问题是什么？</p>
<p>举例：</p>
<p>卖包子的，如果包子卖不完，还要继续蒸包子，会怎么样？門可罗雀，包子成山。如果把包子先蒸一些，卖着，快卖完了，赶紧包，再蒸一些。不会有等包子的队伍。如果包子供不应求，还没有和面呢，包子都被预定了，出现排除等包子的情况。上面这些情况，最核心的问题，就是生产者和消费者速度要匹配的问题。但是，往往速度不能够很好的匹配。</p>
<p>解决的办法—队列queue</p>
<p>作用—解耦、缓冲</p>
<p><img src="/images/python数据分发/数据分发2.png" alt=""></p>
<p>日志生产者往往会部署好几个程序，日志产生的也很多，而消费者也会有多个程序，去提取日志分析处理。</p>
<p>数据的生产是不稳定的！会造成短时间数据的“潮涌”，需要缓冲。</p>
<p>消费者消费能力不一样，有快有慢，消费者可以自己决定消费缓冲区中的数据。</p>
<p>单机可以使用queue内奸的模块构建进程内的队列，满足多个线程间的生产消费需要。</p>
<p>大型系统可以使用第三方消息中间件：RabbitMQ、RocketMQ、Kafka</p>
<h4 id="queue模块—队列"><a href="#queue模块—队列" class="headerlink" title="queue模块—队列"></a>queue模块—队列</h4><p>queue模块提供了一个先进先出的队列Queue。</p>
<p>queue.Queue(maxsize=0)</p>
<p>创建FIFO队列，返回Queue对象。</p>
<p>maxsize小于等于0，队列长度没有限制</p>
<p>Queue.get(block=True, timeout=None)</p>
<p>从队列中移除元素并返回这个元素。</p>
<p>block为阻塞，timeout为超时。</p>
<p>如果block为True，是阻塞，timeout为None就是一直阻塞</p>
<p>如果block为True但是timeout有值，就阻塞到一定秒数抛出Empty异常</p>
<p>block为False，是非阻塞，timeout将被忽略，要么成功返回一个元素，要么抛出empty异常。</p>
<p>Queue.get_nowait()</p>
<p>等价于get(False)，也就是说要么成功返回一个元素，要么抛出empty异常。</p>
<p>但是queue的这种阻塞效果，需要多线程的时候演示。</p>
<p>Queue.put(item, block=True, timeout=None)</p>
<p>把一个元素加入到队列中去。</p>
<p>block=True, timeout=None, 一直阻塞直至有空位放元素。</p>
<p>block=True, timeout=5, 阻塞5秒就抛出Full异常。</p>
<p>block=False, timeout失效，立即返回，能塞进去就塞，不能则返回抛出Full异常。</p>
<p>Queue.put_nowait(item)</p>
<p>等价于put(item, False)，也就是能塞进去就塞，不能则返回抛出Full异常。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Queue测试</span></span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">q = Queue()</span><br><span class="line">q.put(random.randint(<span class="number">1</span>,<span class="number">100</span>))</span><br><span class="line">q.put(random.randint(<span class="number">1</span>,<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line"><span class="comment">#print(q.get()) # 阻塞</span></span><br><span class="line">print(q.get(timeout=<span class="number">3</span>)) <span class="comment"># 阻塞，但超时抛异常</span></span><br></pre></td></tr></table></figure>
<h4 id="分发器的实现"><a href="#分发器的实现" class="headerlink" title="分发器的实现"></a>分发器的实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">生产者（数据源）生产数据，缓冲到消息队列中</span><br><span class="line"></span><br><span class="line">数据处理流程：</span><br><span class="line">数据加载 -&gt; 提取 -&gt; 分析（滑动窗口函数）</span><br><span class="line"></span><br><span class="line">处理大量数据的时候，对于一个数据源来说，需要多个消费者处理。但是如何分配数据就是个问题了。</span><br><span class="line">需要一个分发器（调度器），把数据分发给不同的消费者处理。</span><br><span class="line">每一个消费者拿到数据后，有自己的处理函数。所以要有一种注册机制</span><br><span class="line"></span><br><span class="line">数据加载 -&gt; 提取 -&gt; 分发 -&gt; 分析函数1</span><br><span class="line">					 | -&gt; 分析函数2</span><br><span class="line">分析<span class="number">1</span>和分析<span class="number">2</span>是不同的handler，不同的窗口宽度、间隔时间</span><br><span class="line"></span><br><span class="line">如何分发？</span><br><span class="line">这里就简单一点，轮询策略。</span><br><span class="line">一对多的副本发送，一个数据通过分发器，发送到n个消费者。分发器如何知道有哪些消费者属于它管理呢，这就涉及到了注册</span><br><span class="line"></span><br><span class="line">消息队列</span><br><span class="line">在生产者和消费者之间使用消息队列，那么所有消费者共用一个消息队列，还是各自拥有一个消息队列呢？</span><br><span class="line">共用一个消息队列也可以，但是需要解决争抢的问题。相对来说每一个消费者自己拥有一个队列，较为容易。</span><br><span class="line"></span><br><span class="line">如何注册？</span><br><span class="line">在调度器内部记录有哪些消费者，每一个消费者拥有自己的队列。</span><br><span class="line"></span><br><span class="line">线程</span><br><span class="line">由于一条数据会被多个不同的注册过的handler处理，所以最好的方式是多线程。</span><br><span class="line"></span><br><span class="line">线程使用举例：</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义线程</span></span><br><span class="line"><span class="comment"># target线程中运行的函数；args这个函数运行时需要的实参的元组</span></span><br><span class="line">t = threading.Thread(target=window, args=(src, handler, width, interval))</span><br><span class="line"><span class="comment"># t是一个线程对象，之后用线程模块threading启动一个线程，这个线程Thread只是被定义了，真正启动是下面的</span></span><br><span class="line"><span class="comment"># t.start()，window是自定义的函数，这个线程就是执行这个函数的，后面的args中的是给函数的传参，这是用元组传参。</span></span><br><span class="line"><span class="comment"># 启动线程</span></span><br><span class="line">t.start()</span><br></pre></td></tr></table></figure>
<h4 id="分发器代码实现"><a href="#分发器代码实现" class="headerlink" title="分发器代码实现"></a>分发器代码实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(second=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""生成数据"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">'datetime'</span>:datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=<span class="number">8</span>))),</span><br><span class="line">            <span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(second)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src:Queue, handler, width:int, interval:int)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    窗口函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param src：数据源，缓存队列，用来拿数据</span></span><br><span class="line"><span class="string">    :param handler：数据处理函数</span></span><br><span class="line"><span class="string">    :param width：时间窗口宽度，秒</span></span><br><span class="line"><span class="string">    :param interval：处理时间间隔，秒</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    start = datetime.datetime.strptime(<span class="string">'20170101 000000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'20170101 010000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    buffer = [] <span class="comment"># 窗口中的待计算数据</span></span><br><span class="line">    delta =datetime.timedelta(seconds=width-interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 从数据源获取数据</span></span><br><span class="line">        data = src.get()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data) <span class="comment"># 存入临时缓冲等待计算</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 每隔interval计算buffer中的数据一次</span></span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line">            ret =handler(buffer)</span><br><span class="line">            print(<span class="string">'&#123;:.2f&#125;'</span>.format(ret))</span><br><span class="line">            start = current</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 清除超出width的数据</span></span><br><span class="line">            buffer = [x <span class="keyword">for</span> x <span class="keyword">in</span> buffer <span class="keyword">if</span> x[<span class="string">'datetime'</span>] &gt; current - delta]</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x:x[<span class="string">'value'</span>],iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="comment"># 分发器中记录handler，同时保存各自的队列</span></span><br><span class="line">    handlers = []</span><br><span class="line">    queues = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(handler, width:int, interval:int)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        注册 窗口处理函数</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :param handler：注册的数据处理函数</span></span><br><span class="line"><span class="string">        :param width：时间窗口宽度</span></span><br><span class="line"><span class="string">        :param interval：时间间隔</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        q = Queue()</span><br><span class="line">        queues.append(q)</span><br><span class="line">        </span><br><span class="line">        h = threading.Thread(target=window, args=(q, handler, width, interval))</span><br><span class="line">        handlers.append(h)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> handlers:</span><br><span class="line">            t.start() <span class="comment"># 启动线程处理数据</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> src: <span class="comment"># 将数据源取到的数据分发到所有队列中</span></span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> queues:</span><br><span class="line">                q.put(item)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> reg,run</span><br><span class="line"></span><br><span class="line">reg, run = dispatcher(source())</span><br><span class="line"></span><br><span class="line">reg(handler, <span class="number">10</span>, <span class="number">5</span>) <span class="comment"># 注册</span></span><br><span class="line">run() <span class="comment"># 运行</span></span><br></pre></td></tr></table></figure>
<p>注意，以上代码也只是现阶段所学知识的一种实现，项目中建议使用消息队列服务的”订阅”模式，消费者各自消费自己的队列的数据。</p>
<h4 id="整合代码"><a href="#整合代码" class="headerlink" title="整合代码"></a>整合代码</h4><p>load函数就是从日志中提取合格的数据的生成器函数。</p>
<p>它可以作为dispatcher函数的数据源。</p>
<p>原来写的handler函数处理一个字典的’datetime’字段，不能处理日志抽取函数extract返回的字典，提供一个新的函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据源</span></span><br><span class="line">PATTERN = <span class="string">'''(?P&lt;remote&gt;[\d\.]&#123;7,&#125;)\s-\s-\s\[(?P&lt;datetime&gt;[^\[\]]+)\]\s\</span></span><br><span class="line"><span class="string">"(?P&lt;method&gt;.*)\s(?P&lt;url&gt;.*)\s(?P&lt;protocol&gt;.*)"\s\</span></span><br><span class="line"><span class="string">(?P&lt;status&gt;\d&#123;3&#125;)\s(?P&lt;size&gt;\d+)\s"[^"]+"\s"(?P&lt;useragent&gt;[^"]+)'''</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(PATTERN) <span class="comment"># 编译</span></span><br><span class="line"></span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> datestr:datetime.datetime.strptime(datestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int</span><br><span class="line">    <span class="string">'size'</span>:int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extrace</span><span class="params">(line:str)</span> -&gt; dict:</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">if</span> matcher:</span><br><span class="line">        <span class="keyword">return</span> &#123;name:ops.get(name, <span class="keyword">lambda</span> x:x)(data) <span class="keyword">for</span> name, data <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="string">"""装载日志文件"""</span></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            fields = extract(line)</span><br><span class="line">            <span class="keyword">if</span> fields:</span><br><span class="line">                <span class="keyword">yield</span> fields</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># TODO 解析失败则抛弃或者记录日志</span></span><br><span class="line">                </span><br><span class="line"><span class="comment"># 数据处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(second=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""生成数据"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">'datetime'</span>:datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=<span class="number">8</span>))),</span><br><span class="line">            <span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(second)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 滑动窗口函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src:Queue, handler, width:int, interval:int)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    窗口函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param src: 数据源，缓存队列，用来拿数据</span></span><br><span class="line"><span class="string">    :param handler: 数据处理函数</span></span><br><span class="line"><span class="string">    :param width: 时间窗口宽度，秒</span></span><br><span class="line"><span class="string">    :param interval: 处理时间间隔，秒</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    start = datetime.datetime.strptime(<span class="string">'20170101 000000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'20170101 010000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    buffer = [] <span class="comment"># 窗口中的待计算数据</span></span><br><span class="line">    delta = datetime.timedelta(seconds=width-interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 从数据源获取数据</span></span><br><span class="line">        data = src.get()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data) <span class="comment"># 存入临时缓冲等待计算</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 每隔interval计算buffer中的数据一次</span></span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line">            ret = handler(buffer)</span><br><span class="line">            print(<span class="string">'&#123;&#125;'</span>.format(ret))</span><br><span class="line">            start = current</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 清除超出width的数据</span></span><br><span class="line">            buffer = [x <span class="keyword">for</span> x <span class="keyword">in</span> buffer <span class="keyword">if</span>  x[<span class="string">'datetiem'</span>] &gt; current - delta]</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 随机数平均数测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x:x[<span class="string">'value'</span>],iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">donothing_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> iterable</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="comment"># 分发器中记录handler，同时保存各自的队列</span></span><br><span class="line">    handlers = []</span><br><span class="line">    queues = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(handler, width:int, interval:int)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        注册 窗口处理函数</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :param handler: 注册的数据处理函数</span></span><br><span class="line"><span class="string">        :param width: 时间窗口宽度</span></span><br><span class="line"><span class="string">        :param interval: 时间间隔</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        q = Queue()</span><br><span class="line">        queues.append(q)</span><br><span class="line">        </span><br><span class="line">        h = threading.Thread(target=window, args=(q, handler, width, interval))</span><br><span class="line">        handlers.append(h)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> handlers:</span><br><span class="line">            t.start() <span class="comment"># 启动线程处理数据</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> src: <span class="comment"># 将数据源取到的数据分发到所有队列中</span></span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> queues:</span><br><span class="line">                q.put(item)</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> reg, run</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"main"</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="comment"># path = sys.argv[1]</span></span><br><span class="line">    path = <span class="string">'test.log'</span></span><br><span class="line">    </span><br><span class="line">    reg, run = dispatcher(load(path))</span><br><span class="line">    reg(donothing_handler, <span class="number">10</span>, <span class="number">5</span>) <span class="comment"># 注册处理函数</span></span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实例代码在信息提取中</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-滑动窗口/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-滑动窗口/" itemprop="url">
                  python基础学习-滑动窗口
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:28:42" itemprop="dateCreated datePublished" datetime="2020-02-06T10:28:42+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="滑动窗口"><a href="#滑动窗口" class="headerlink" title="滑动窗口"></a>滑动窗口</h3><h4 id="数据载入"><a href="#数据载入" class="headerlink" title="数据载入"></a>数据载入</h4><p>对于本项目来说，数据就是日志的一行行记录，载入数据就是文件 IO的读取。将获取数据的方法封装成函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="string">"""装载日志文件"""</span></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            fields = extract(line)</span><br><span class="line">            <span class="keyword">if</span> fields:</span><br><span class="line">                <span class="keyword">yield</span> fields</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># TODO 解析失败就抛弃，或者打印日志</span></span><br></pre></td></tr></table></figure>
<h3 id="时间窗口分析"><a href="#时间窗口分析" class="headerlink" title="时间窗口分析"></a>时间窗口分析</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>很多数据，例如日志，都是和时间相关的，都是按照时间顺序产生的。</p>
<p>产生的数据分析的时候，要按照时间求值</p>
<p>interval 表示每一次求值的时间间隔</p>
<p>width 时间窗口宽度，指的一次求值的时间窗口宽度</p>
<h5 id="当width-gt-interval"><a href="#当width-gt-interval" class="headerlink" title="当width &gt; interval"></a>当width &gt; interval</h5><p><img src="/images/python滑动窗口/滑动窗口1.png" alt=""></p>
<p>数据求值时会有重叠。当走一个interval间隔后，用当前位置减去width宽度秒就是要采集的数据的起始位置。c2=c1-delta，delta=width-interval。当delta=0时，width=interval</p>
<h5 id="当width-interval"><a href="#当width-interval" class="headerlink" title="当width = interval"></a>当width = interval</h5><p><img src="/images/python滑动窗口/滑动窗口2.png" alt=""></p>
<p>数据求值没有重叠</p>
<h5 id="当width-lt-interval"><a href="#当width-lt-interval" class="headerlink" title="当width &lt; interval"></a>当width &lt; interval</h5><p>一般不采纳这种方案，会有数据缺失</p>
<h4 id="时序数据"><a href="#时序数据" class="headerlink" title="时序数据"></a>时序数据</h4><p>运维环境中，日志、监控等产生的数据都是与时间相关的数据，按照时间先后产生并记录下来的数据，所以一般按照时间对数据进行分析。</p>
<h5 id="数据分析基本程序结构"><a href="#数据分析基本程序结构" class="headerlink" title="数据分析基本程序结构"></a>数据分析基本程序结构</h5><p>无限的生成随机数函数，产生时间相关的数据，返回时间和随机数的字典</p>
<p>每次取3个数据，求平均值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;<span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>),<span class="string">'datetime'</span>:datetime.datetime.now()&#125;</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 获取数据</span></span><br><span class="line">s = source()</span><br><span class="line">items = [next(s) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> item:item[<span class="string">'value'</span>],iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line">print(items)</span><br><span class="line">print(<span class="string">"&#123;:.2f&#125;"</span>.format(handler(items)))</span><br></pre></td></tr></table></figure>
<p>上面代码模拟了，一段时间内产生了数据，等了一段固定的时间取数据来计算平均值。</p>
<h5 id="窗口函数实现"><a href="#窗口函数实现" class="headerlink" title="窗口函数实现"></a>窗口函数实现</h5><p>将上面的获取数据的程序扩展为window函数。使用重叠的方案</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(second=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""生成数据"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">'datetime'</span>:datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=<span class="number">8</span>))),</span><br><span class="line">            <span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>) 			</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(second)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(iterator, handler, width:int, interval:int)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    窗口函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param iterator：数据源，生成器，用来拿数据</span></span><br><span class="line"><span class="string">    :param handler：数据处理函数</span></span><br><span class="line"><span class="string">    :param width：时间窗口宽度，秒</span></span><br><span class="line"><span class="string">    :param interval：处理时间间隔，秒</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    start = datetime.datetime.strptime(<span class="string">'20170101 000000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'20170101 010000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    buffer = [] <span class="comment"># 窗口中的待计算数据</span></span><br><span class="line">    delta = datetime.timedelta(seconds=width-interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 从数据源获取数据</span></span><br><span class="line">        data = next(iterator)</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data) <span class="comment"># 存入临时缓冲等待计算</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 每隔interval计算buffer中的数据一次</span></span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line"><span class="comment"># 当现在的时间减去开始时间大于等于间隔时间时就处理一下buffer中的数据，第一次处理数据时因为start和</span></span><br><span class="line"><span class="comment"># current都设置成了1970年，所以buffer中存储一条data数据后就会对buffer数据进行处理，之后buffer中会</span></span><br><span class="line"><span class="comment"># 存储两条数据才被处理</span></span><br><span class="line"></span><br><span class="line">            ret = handler(buffer)</span><br><span class="line">            print(<span class="string">'&#123;:.2f&#125;'</span>.format(ret))</span><br><span class="line">            start = current</span><br><span class="line">            <span class="comment"># 清除超出width的数据</span></span><br><span class="line">            buffer = [x <span class="keyword">for</span> x <span class="keyword">in</span> buffer <span class="keyword">if</span> x[<span class="string">'datetime'</span>] &gt; current - delta]</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x:x[<span class="string">'value'</span>],iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line">window(source(), handler, <span class="number">10</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>时间的计算</p>
<p><img src="/images/python滑动窗口/滑动窗口3.png" alt=""></p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 无限产出随机数</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime   <span class="comment"># 时序数据与时间相关，所以导入此模块</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> datetime.datetime.now(),random.randint(<span class="number">1</span>,<span class="number">100</span>)  </span><br><span class="line">        <span class="comment"># 如果要yield出去，要将yield放在一个函数中，这就是一个生成器函数</span></span><br><span class="line">        <span class="comment"># now()的格式与其他语言可能不太一样，所以使用时间戳更好</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># src = source()  # 这里返回一个生成器对象</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> source():   <span class="comment"># 这样使用时source()中的数据就不会再变动了</span></span><br><span class="line">    print(x)</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> i&gt;<span class="number">10</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面拿三个数据        </span></span><br><span class="line">src = source()</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">lst = [next(src) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>)]</span><br><span class="line"><span class="comment"># lst.append(next(src))</span></span><br><span class="line"><span class="comment"># lst.append(next(src)) </span></span><br><span class="line"><span class="comment"># lst.append(next(src)) </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(iterable) // len(iterable)</span><br><span class="line">=======================================================================================</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime   <span class="comment"># 时序数据与时间相关，所以导入此模块</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> datetime.datetime.now(),random.randint(<span class="number">1</span>,<span class="number">100</span>) </span><br><span class="line">        </span><br><span class="line">src = source()</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">lst = [next(src) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src, handler, width:int, interval:int)</span>:</span></span><br><span class="line">	i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> src</span><br><span class="line">		i += <span class="number">1</span></span><br><span class="line">    	print(x)</span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">window(load(<span class="string">'test.log'</span>),<span class="keyword">None</span>,<span class="number">0.0</span>)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-信息提取/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-信息提取/" itemprop="url">
                  python基础学习-信息提取
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:28:32" itemprop="dateCreated datePublished" datetime="2020-02-06T10:28:32+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-07-06 16:20:12" itemprop="dateModified" datetime="2020-07-06T16:20:12+08:00">2020-07-06</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>生产中会生成大量的系统日志、应用程序日志、安全日志等等日志，通过对日志的分析可以了解服务器的负载、健康状况，可以分析客户的分布情况、客户的行为，甚至基于这些分析可以做出预测。</p>
<p>一般采集流程</p>
<p>日志产出 -&gt; 采集（Logstash、Flume、Scribe）-&gt; 存储 -&gt; 分析 -&gt; 存储（数据库、NoSQL）-&gt; 可视化</p>
<p>开源实时日志分析ELK平台</p>
<p>Logstash收集日志，并存放到ElasticSearch集群中，Kibana则从ES集群中查询数据生成图表，返回浏览器端</p>
<h4 id="分析的前提"><a href="#分析的前提" class="headerlink" title="分析的前提"></a>分析的前提</h4><h5 id="半结构化数据"><a href="#半结构化数据" class="headerlink" title="半结构化数据"></a>半结构化数据</h5><p>日志是半结构化数据，是有组织的，有格式的数据。可以分割成行和列，就可以当做表理解和处理了，当然也可以分析里面的数据。</p>
<h5 id="文本分析"><a href="#文本分析" class="headerlink" title="文本分析"></a>文本分析</h5><p>日志是文本文件，需要依赖文件IO、字符串操作、正则表达式等技术。</p>
<p>通过这些技术就能够把日志中需要的数据提取出来。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">182.60.21.153 - - [19/Feb/2013:10:23:29 +0800] "GET /o2o/media.html?menu=3 HTTP/1.1" 200 16691 "-" "Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)"</span><br></pre></td></tr></table></figure>
<p>这是最常见的日志，nginx、tomcat等WEB Server都会产生这样的日志。如何提取出数据？这里面每一段有效的数据对后期的分析都是必须的。</p>
<h5 id="提取数据"><a href="#提取数据" class="headerlink" title="提取数据"></a>提取数据</h5><p>一、空格分割</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'xxx.log'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> line.split():</span><br><span class="line">            print(field)</span><br></pre></td></tr></table></figure>
<p>缺点：</p>
<p>数据并没有按照业务分割好，比如时间就被分开了，URL相关的也被分开了，User Agent的空格最多，被分割了。所以，定义的时候不选用这种在filed中出现的字符就可以省很多事，例如使用’\x01’这个不可见的ASCII，<code>print(&#39;\x01&#39;)</code>试一试</p>
<p>能否依旧是空格分割，但是遇到双引号、中括号特殊处理一下？</p>
<p>思路：</p>
<p>先按照空格切分，然后一个个字符迭代，但如果发现是[或者”，则就不判断是否空格，直到]或者”结尾，这个区间获取的就是时间等数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">line = <span class="string">'''182.60.21.153 - - [19/Feb/2013:10:23:29 +0800] \</span></span><br><span class="line"><span class="string">"GET /o2o/media.html?menu=3 HTTP/1.1" 200 16691 "-" \</span></span><br><span class="line"><span class="string">"Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)"'''</span></span><br><span class="line"></span><br><span class="line">CHARS = set(<span class="string">" \t"</span>)  <span class="comment"># 定义CHARS为空格或\t，这是分隔符</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makekey</span><span class="params">(line:str)</span>:</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    skip = <span class="keyword">False</span></span><br><span class="line"><span class="comment"># 用判断是否有中括号或双引号，再判断是否有空格或\t，</span></span><br><span class="line">    <span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(line):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> skip <span class="keyword">and</span> c <span class="keyword">in</span> <span class="string">'"['</span>: <span class="comment"># [ 或第一个引号</span></span><br><span class="line"><span class="comment"># 如果skip是False并且c是前一个双引号或左中括号</span></span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line"><span class="comment"># 这里记录的是双引号或中括号中内容的起始索引值</span></span><br><span class="line">            skip = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> skip <span class="keyword">and</span> c <span class="keyword">in</span> <span class="string">'"]'</span>: <span class="comment"># 第二个引号或]</span></span><br><span class="line">            skip = <span class="keyword">False</span></span><br><span class="line">            <span class="keyword">yield</span> line[start:i]</span><br><span class="line"><span class="comment"># i这时就是双引号或中括号中内容的结束索引值，这里就是取双引号或中括号中的内容</span></span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line"><span class="comment"># 再修正start的下一个起始位置</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"><span class="comment"># 如果中括号或双引号都匹配过了，这里就跳出本轮循环。</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> skip: <span class="comment"># 如果遇到[或第一个引号就跳过</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"><span class="comment"># 如果skip是True这里就跳出本轮循环，什么条件下会出现这种情况？是否是匹配了左侧中括号或左双引号后，还没有匹配</span></span><br><span class="line"><span class="comment"># 右中括号或右双引号时，就会执行到这里？进入这里判断时，skip是True，而c又是左双引号或左中括号时，也就是上面</span></span><br><span class="line"><span class="comment"># 的判断中满足第一个条件就会到这里，所以这时要跳出本轮循环。也就是匹配了左括号，要跳出本轮循环，因为上面没有跳</span></span><br><span class="line"><span class="comment"># 出的设置，所以这里通过对skip的判断跳出本轮循环。如：[19/Feb/2013:10:23:29 +0800]这样的值，在上面就会</span></span><br><span class="line"><span class="comment"># 被判断出来，最后按一个元素返回。</span></span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> CHARS:</span><br><span class="line"><span class="comment"># 不是中括号或双引号的内容会到这里判断，如果不是空格或\t就会进入下一次循环，看下一个c是否是空格或\t</span></span><br><span class="line">            <span class="keyword">if</span> start == i:   </span><br><span class="line"><span class="comment"># start的值与i的值从开始就是一致的</span></span><br><span class="line">                start = i + <span class="number">1</span></span><br><span class="line"><span class="comment"># 修正start的值和下一次的i值一样大，并进入下一轮循环 </span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"><span class="comment"># 这个判断是为了去除单独的空白元素的，如果不加这个判断，会返回下面的结果，可以看到有''也是一个元素</span></span><br><span class="line"><span class="comment">#['182.60.21.153', '-', '-', '19/Feb/2013:10:23:29 +0800', '', 'GET /o2o/media.html?menu=3 HTTP/1.1', '', '200', '16691', '-', '', 'Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)']</span></span><br><span class="line"><span class="comment"># 加入这个判断后，就不会有''这样的元素了。因为i的值起码要比start大1，这样才说明匹配到了一个非符号的元素值，</span></span><br><span class="line"><span class="comment"># 比如一个字母或数字，如：a 32，如果匹配到a，那么i一定是比start大1的</span></span><br><span class="line">            <span class="keyword">yield</span> line[start:i]</span><br><span class="line"><span class="comment"># 返回从start到i的内容，因为c属于CHARS，说明遇到了空白。上面start == i是第一次遇到空白，这里是再次遇到空</span></span><br><span class="line"><span class="comment"># 白，两次中间就是我们要取的字符串部分</span></span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> start &lt; len(line):</span><br><span class="line">            <span class="keyword">yield</span> line[start:]</span><br><span class="line"><span class="comment"># 当上面的循环结束后，如果start比字符串的总长度小，说明还没有到字符串的结尾，还有没取完的元素，所以就把start到结尾的值取出             </span></span><br><span class="line">print(list(makekey(line)))</span><br></pre></td></tr></table></figure>
<h5 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h5><p>fields中的数据是有类型的，例如时间、状态码等。对不同的field要做不同的类型转换，甚至是自定义的转换</p>
<p><strong>时间转换</strong></p>
<p>19/Feb/2013:10:23:29 +0800   对应格式是</p>
<p>%d/%b/%Y:%H:%M:%S %z</p>
<p>使用的函数是datetime类的strptime方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_time</span><span class="params">(timestr)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>)</span><br></pre></td></tr></table></figure>
<p>上面的代码可以转换为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lambda</span> timestr:datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>)</span><br></pre></td></tr></table></figure>
<p><strong>状态码和字节数</strong></p>
<p>都是整型，使用int函数转换</p>
<h5 id="请求信息的解析"><a href="#请求信息的解析" class="headerlink" title="请求信息的解析"></a>请求信息的解析</h5><p>GET /o2o/media.html?menu=3 HTTP/1.1</p>
<p>method url protocol 三部分都非常重要</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_request</span><span class="params">(request:str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> dict(zip([<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>],request.split()))</span><br></pre></td></tr></table></figure>
<p>上面的代码可以转换为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lambda</span> request:dict(zip([<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>],request.split()))</span><br></pre></td></tr></table></figure>
<h5 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h5><p>对每一个字段命名，然后与值和类型转换的方法对应。解析每一行是有顺序的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">line = <span class="string">'''182.60.21.153 - - [19/Feb/2013:10:23:29 +0800] \</span></span><br><span class="line"><span class="string">"GET /o2o/media.html?menu=3 HTTP/1.1" 200 16691 "-" \</span></span><br><span class="line"><span class="string">"Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)"'''</span></span><br><span class="line"></span><br><span class="line">CHARS = set(<span class="string">" \t"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makekey</span><span class="params">(line:str)</span>:</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    skip = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(line):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> skip <span class="keyword">and</span> c <span class="keyword">in</span> <span class="string">'"['</span>:</span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line">            skip = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> skip <span class="keyword">and</span> c <span class="keyword">in</span> <span class="string">'"]'</span>:</span><br><span class="line">            skip = <span class="keyword">False</span></span><br><span class="line">            <span class="keyword">yield</span> line[start:i]</span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> skip:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> CHARS:</span><br><span class="line">            <span class="keyword">if</span> start == i:</span><br><span class="line">                start = i + <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">yield</span> line[start:i]</span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> start &lt; len(line):</span><br><span class="line">            <span class="keyword">yield</span> line[start:]</span><br><span class="line">            </span><br><span class="line">names = (<span class="string">'remote'</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">'datetime'</span>,<span class="string">'request'</span>,<span class="string">'status'</span>,<span class="string">'length'</span>,<span class="string">''</span>,<span class="string">'useragent'</span>)</span><br><span class="line"></span><br><span class="line">ops = (<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">lambda</span> timestr:datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">      <span class="keyword">lambda</span> request: dict(zip([<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>],request.split())),</span><br><span class="line">      int,int,<span class="keyword">None</span>,<span class="keyword">None</span></span><br><span class="line">      )</span><br><span class="line"><span class="comment"># zip()函数先将列表与后面的字符串组合成元组，再用dict()将其转换为字典</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(line:str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> dict(map(<span class="keyword">lambda</span> item: (item[<span class="number">0</span>], item[<span class="number">2</span>](item[<span class="number">1</span>]) <span class="keyword">if</span> item[<span class="number">2</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">else</span> item[<span class="number">1</span>]),zip(names, makekey(line),ops)))</span><br><span class="line"><span class="comment"># map()函数会用其前面的函数参数处理其后面的数据参数，这里是用lambda函数处理后而把zip函数生成的数据。</span></span><br><span class="line"><span class="comment"># 这里zip()函数是将三个变量中对应位置的值组合在一起，如第一个值是('remote', '182.60.21.153', None)。</span></span><br><span class="line"><span class="comment"># lambda定义了匿名函数，如果传入的元素的第三个值不是None，就返回item[0], item[2](item[1])，这里</span></span><br><span class="line"><span class="comment"># item[2]实际是ops中设置的函数，item[2](item[1])就是用指定的函数再处理一次item[1]的数据。否则返回</span></span><br><span class="line"><span class="comment"># item[1]，item指的就是后面的zip生成的数据。这里的意思就是如果item[2]是None，返回的是item[0],item[2]</span></span><br><span class="line"><span class="comment"># (item[1])，否则返回item[0],item[1]。之后用map函数返回一个元组，map()函数可以根据提供的函数对指定的序</span></span><br><span class="line"><span class="comment"># 列做映射。最后用dict函数将元组变成字典。这里的方法就是使用map、zip、dict等函数将值都组合成字典</span></span><br><span class="line"></span><br><span class="line">print(extract(line))</span><br></pre></td></tr></table></figure>
<p>二、正则表达式提取</p>
<p>构造一个正则表达式提取需要的字段，改造extrace函数、names和ops</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">names = (<span class="string">'remote'</span>,<span class="string">'datetime'</span>,<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>,<span class="string">'status'</span>,<span class="string">'length'</span>,<span class="string">'useragent'</span>)</span><br><span class="line"></span><br><span class="line">ops = (<span class="keyword">None</span>, <span class="keyword">lambda</span> timestr: datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">      <span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,int,int,<span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">pattern = <span class="string">'''([\d.]&#123;7,&#125;) - - \[([/\w +:]+)\] "(\w+) (\S+) ([\w/\d.]+)" (\d+) (\d+) .+ "(.+)"'''</span></span><br></pre></td></tr></table></figure>
<p>能够使用命名分组</p>
<p>进一步改造pattern为命名分组，ops也就可以和名词对应了，names就没有必要存在了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>: <span class="keyword">lambda</span> timestr: datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int,</span><br><span class="line">    <span class="string">'length'</span>:int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pattern = <span class="string">'''(?P&lt;remote&gt;[\d.]&#123;7,&#125;) - - \[(?P&lt;datetime&gt;[/\w +:]+)\] \</span></span><br><span class="line"><span class="string">"(?P&lt;method&gt;\w+) (?P&lt;url&gt;\S+) (?P&lt;protocol&gt;[\w/\d.]+)" \</span></span><br><span class="line"><span class="string">(?P&lt;status&gt;\d+) (?P&lt;length&gt;\d+) .+ "(?P&lt;useragent&gt;.+)"'''</span></span><br></pre></td></tr></table></figure>
<p>改造后的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">line = <span class="string">'''182.60.21.153 - - [19/Feb/2013:10:23:29 +0800] \</span></span><br><span class="line"><span class="string">"GET /o2o/media.html?menu=3 HTTP/1.1" 200 16691 "-" </span></span><br><span class="line"><span class="string">"Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)"'''</span></span><br><span class="line"></span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>: <span class="keyword">lambda</span> timestr: datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int,</span><br><span class="line">    <span class="string">'length'</span>:int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pattern = <span class="string">'''(?P&lt;remote&gt;[\d.]&#123;7,&#125;) - - \[(?P&lt;datetime&gt;[/\w +:]+)\] \</span></span><br><span class="line"><span class="string">"(?P&lt;method&gt;\w+) (?P&lt;url&gt;\S+) (?P&lt;protocol&gt;[\w/\d.]+)" \</span></span><br><span class="line"><span class="string">(?P&lt;status&gt;\d+) (?P&lt;length&gt;\d+) .+ "(?P&lt;useragent&gt;.+)"'''</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(pattern)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(line:str)</span> -&gt; dict:</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">return</span> &#123;k:ops.get(k, <span class="keyword">lambda</span> x:x)(v) <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line"></span><br><span class="line">print(extract(line))</span><br></pre></td></tr></table></figure>
<h5 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h5><p>日志中不免会出现一些不匹配的行，需要处理。</p>
<p>这里使用re.match方法，有可能匹配不上。所以要增加一个判断</p>
<p>采用抛出异常的方式，让调用者获得异常并自行处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(logline:str)</span> -&gt; dict:</span></span><br><span class="line">    <span class="string">"""返回字段的字典，抛出异常说明匹配失败"""</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">if</span> matcher:</span><br><span class="line">        <span class="keyword">return</span> &#123;k:ops.get(k, <span class="keyword">lambda</span> x:x)(v) <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'No match'</span>)</span><br></pre></td></tr></table></figure>
<p>但是，也可以采用返回一个特殊值的方式，告知调用者没有匹配。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(logline:str)</span> -&gt; dict:</span></span><br><span class="line">    <span class="string">"""返回字段的字典，如果返回None说明匹配失败"""</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">if</span> matcher:</span><br><span class="line">        <span class="keyword">return</span> &#123;k:ops.get(k, <span class="keyword">lambda</span> x:x)(v) <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p>通过返回值，在函数外部获取了None，同样也可以采取一些措施。本次采用返回None的实现。</p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 137课开始讲日志分析的项目</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="comment"># 使用dict时，如果引用的Key不存在，就会抛出KeyError。如果希望key不存在时，返回一个默认值，就可以用defaultdict</span></span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">logline = <span class="string">'''182.60.21.153 - - [19/Feb/2013:10:23:29 +0800] \</span></span><br><span class="line"><span class="string">"GET /o2o/media.html?menu=3 HTTP/1.1" 200 16691 "-" \</span></span><br><span class="line"><span class="string">"Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)"'''</span></span><br><span class="line"></span><br><span class="line">pattern = <span class="string">'''(?P&lt;remote&gt;[\d\.]&#123;7,&#125;) - - \[(?P&lt;datetime&gt;[^\[\]]+)\] "(?P&lt;request&gt;[^"]+)" (?P&lt;status&gt;\d+) (?P&lt;size&gt;\d+) "[^"]+" "(?P&lt;useragent&gt;[^"]+)"'''</span></span><br><span class="line">regex = re.compile(pattern)</span><br><span class="line"><span class="comment"># 这两行代码因为编译一次就可以了  ，所以放在外面了</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(line)</span>:</span></span><br><span class="line">    matcher = regex.match(line)  <span class="comment"># 因为只处理一行，所以用match就可以。这一行里不会有重复</span></span><br><span class="line"><span class="comment"># 如果pattern没法与logline一一对应，那么这里会返回None，下面也没法使用groupdict()，会提</span></span><br><span class="line"><span class="comment"># 示："AttributeError: 'NoneType' object has no attribute 'groupdict'"</span></span><br><span class="line"><span class="comment">#    return matcher.groupdict()</span></span><br><span class="line">	<span class="keyword">if</span> matcher:</span><br><span class="line">		<span class="keyword">return</span> &#123;k:ops.get(k,<span class="keyword">lambda</span> x:x)(v) <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line"><span class="comment"># 分组的名称会被当作字典的键名，如remote，datetime等。这里直接返回字典解析式，就不用下面再返回了</span></span><br><span class="line"><span class="comment"># groupdict()是正则表达式的方法，它返回一个字典，包含所有经命名的匹配子群，键值是子群名。也就是将组名与</span></span><br><span class="line"><span class="comment"># 匹配到的内容组成字典。ops中没有的键值这里就直接返回字典中的值，如果是ops中有的键值，就用ops中的键处理</span></span><br><span class="line"><span class="comment"># 一下字典中的值，因为ops中有的键值都是函数。这里的k与ops中的键名是一样的，所以才可以查找相应的key</span></span><br><span class="line"><span class="comment"># 先从pattern中生成处理过一次的日志，再将这些日志用ops中的函数处理一次</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'No match'</span>)   <span class="comment"># 错误处理，如果matcher没有匹配到就返回None</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># def convert_time(timestr):</span></span><br><span class="line"><span class="comment">#     fmtstr = "%d/%b/%Y:%H:%M:%S %z"</span></span><br><span class="line"><span class="comment">#     dt = dtetime.datetime.strptime(timestr, fmtstr)</span></span><br><span class="line"><span class="comment"># 	print(type(dt))</span></span><br><span class="line"><span class="comment">#      return dt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def convert_request(request:str):</span></span><br><span class="line"><span class="comment">#     return dict(zip(('method','url','protocol'),request.split()))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># names = ['remote','','','datetime','request','status','size','','useragent']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ops = [None,None,None,convert_time,convert_request,int,int,None,None]</span></span><br><span class="line"></span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> timestr:datetime.datetime.strptime(timestr,<span class="string">"%d/%b/%Y:%H:%M:%S %z"</span>),  </span><br><span class="line">    <span class="comment">#  这一行lambda可以代理上面的convert_time函数</span></span><br><span class="line">    <span class="string">'status'</span>:int,  <span class="comment"># 用int函数处理数据。因为默认是字符串格式 ，所以这里要用int处理一下</span></span><br><span class="line">    <span class="string">'size'</span>:int,   <span class="comment"># 因为默认就是字符串，所以第一个remote就不用处理了</span></span><br><span class="line">    <span class="string">'request'</span>:<span class="keyword">lambda</span> request:dict(zip((<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>),request.split())),</span><br><span class="line">    <span class="comment"># 这一行lambda可以代替上面的convert_request函数</span></span><br><span class="line">    <span class="string">'useragent'</span>:<span class="keyword">lambda</span> useragent:parse(useragent)  <span class="comment"># 分析浏览器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># d = &#123;&#125;</span></span><br><span class="line"><span class="comment">#for k,v in extract(logline).items():   # k是每个fields的命名</span></span><br><span class="line"><span class="comment">#	d[k] = ops.get(k, lambda x:x)(v)</span></span><br><span class="line">    <span class="comment"># 这里如果可以查询到k的值，就用k值对应的函数处理v；如果没找到k值，就用lambda函数处理v，lambda函</span></span><br><span class="line">    <span class="comment"># 数在这里的意思是给什么就返回什么，也就是直接返回v。lambda的地方不能写成v，因为还要将这个默认值当</span></span><br><span class="line">    <span class="comment"># 函数去处理v，所以如果写成v，就会变成v(v)，这会报错。</span></span><br><span class="line"><span class="comment"># d = &#123;k:ops.get(k,lambda x:x)(v) for k,v in extract(logline).items()&#125;</span></span><br><span class="line"><span class="comment"># 上面的三行代码转换为这一行。让上面的extract函数直接返回这个字典解析式更好些</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openfile</span><span class="params">(path:str)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(str(path)) <span class="keyword">as</span> f:   <span class="comment"># open()方法里需要字符串，要用str()函数转一下</span></span><br><span class="line">		<span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        	d = extract(line)</span><br><span class="line">            <span class="keyword">if</span> d:</span><br><span class="line">            	<span class="keyword">yield</span> d</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># TODO  不合格数据有多少</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面的调用方法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(*path)</span>:</span>   <span class="comment"># 读一批路径。这是一个生成器函数，yield出来的是字典</span></span><br><span class="line">    <span class="string">"""文件装载"""</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> path:</span><br><span class="line">        p = Path(file)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.exists():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> p.is_dir():   <span class="comment"># 这里不递归处理子目录，也可以使用**/*log的方法</span></span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> p.iterdir():</span><br><span class="line">                <span class="keyword">if</span> x.is_file():</span><br><span class="line"><span class="comment">#                    with open(str(p)) as f:   # open()方法里需要字符串，要用str()函数转一下</span></span><br><span class="line"><span class="comment">#                        for line in f:</span></span><br><span class="line"><span class="comment">#                            d = extract(line)</span></span><br><span class="line"><span class="comment">#                            if d:</span></span><br><span class="line"><span class="comment">#                                yield d</span></span><br><span class="line"><span class="comment">#                            else:</span></span><br><span class="line"><span class="comment">#                                # TODO  不合格数据有多少</span></span><br><span class="line"><span class="comment">#                                continue</span></span><br><span class="line"><span class="comment">#					gen = openfile(str(x))</span></span><br><span class="line"><span class="comment">#    				for y in openfile(str(x)):</span></span><br><span class="line"><span class="comment">#            			yield y</span></span><br><span class="line"><span class="comment"># 这里不能使用return y，这样会有一个就扔出去了，我们需要的是攒起来一起处理，攒多少个是window函数的事</span></span><br><span class="line"><span class="comment"># openfile(str(x))不是普通的函数调用，它返回的是一个生成器对象，我们需要使用for循环或next拿，那么需</span></span><br><span class="line"><span class="comment"># 要迭代多少个合适呢，所以用yield，这样load就变成一个生成器函数了。有yield的就是生成器函数，返回的是生</span></span><br><span class="line"><span class="comment"># 成器对象。yield from后面是一个可迭代对象就行</span></span><br><span class="line">					<span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(x))  <span class="comment"># 将上面两行改为一行</span></span><br><span class="line">        <span class="keyword">elif</span> p.is_file():</span><br><span class="line"><span class="comment">#            with open(str(p)) as f:   # open()方法里需要字符串，要用str()函数转一下</span></span><br><span class="line"><span class="comment">#                for line in f:</span></span><br><span class="line"><span class="comment">#                    d = extract(line)</span></span><br><span class="line"><span class="comment">#                    if d:</span></span><br><span class="line"><span class="comment">#                        yield d</span></span><br><span class="line"><span class="comment">#                    else:</span></span><br><span class="line"><span class="comment">#                        # TODO  不合格数据有多少</span></span><br><span class="line"><span class="comment">#                        continue</span></span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(x))</span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src:Queue, handler, width:int, interval:int)</span>:</span>  <span class="comment"># 时间窗口</span></span><br><span class="line">    <span class="comment"># window函数只做移动窗口拿数据的工作，处理在handler函数中做</span></span><br><span class="line">    <span class="comment"># 函数的功能越单一越好。这里的src就是load函数生成的数据，src生成的是字典。load是生成器函数</span></span><br><span class="line"><span class="comment"># current是现在的时间，start是起始时间，width是宽度，表示一次求值的时间窗口宽度，窗口就是下面的</span></span><br><span class="line"><span class="comment"># buffer中的数据，主要是配合interval计算delta，interval是时间间隔，表示间隔多入处理一次数据</span></span><br><span class="line"><span class="comment">#	i = 0</span></span><br><span class="line"><span class="comment">#    for x in src</span></span><br><span class="line"><span class="comment">#		i += 1</span></span><br><span class="line"><span class="comment">#    	print(x)</span></span><br><span class="line"><span class="comment">#        if i &gt; 10:</span></span><br><span class="line"><span class="comment">#            break</span></span><br><span class="line">	start = datetime.datetime.strptime(<span class="string">'1970/01/01 01:01:01 +0800'</span>, <span class="string">'%Y/%m/%d %H:%M:%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'1970/01/01 01:01:02 +0800'</span>, <span class="string">'%Y/%m/%d %H:%M:%S %z'</span>)</span><br><span class="line">    delta = datetime.timedelta(seconds=width - interval)</span><br><span class="line">    </span><br><span class="line">    buffer = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># for x in src:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = src.get()  </span><br><span class="line"><span class="comment"># 这里传进来的src是一个Queue，src.get()就是从Queue队列中拿数据的方法。如果没有数据就会阻塞等待，等下</span></span><br><span class="line"><span class="comment"># 一个数据过来。所以上面也不能再用for循环了，而使用while True循环。这里拿到的是load生成器函数处理后</span></span><br><span class="line"><span class="comment"># yield出来的字典。</span></span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data)  </span><br><span class="line"><span class="comment"># 直接把字典放入buffer中，具体的处理工作由handler执行。不要把加入buffer中的值写死，那样的适用性会很差</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]   <span class="comment"># 当前时间应该是日志中的时间</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line">            ret = handler(buffer)</span><br><span class="line">            print(ret)</span><br><span class="line">            </span><br><span class="line">            start = current   <span class="comment"># 调整开始时间</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># buffer 的处理</span></span><br><span class="line">            <span class="comment"># tmp = []</span></span><br><span class="line">            <span class="comment"># for i in buffer:</span></span><br><span class="line">            <span class="comment">#     if i['datetime'] &gt; current - delta: </span></span><br><span class="line"><span class="comment"># 用拿到的时间与current减delta的时间比较，这就是有数据重叠的部分，现在的时间减去delta后的位置就成了处理过的数据要保留部分的起始位置，大于这个位置的数据都要保留，其他的就不要了。可以比对时间窗口的图查看</span></span><br><span class="line">            <span class="comment">#        tmp.append(i)</span></span><br><span class="line">            buffer = [i <span class="keyword">for</span> i <span class="keyword">in</span> buffer <span class="keyword">if</span> i[<span class="string">'datetime'</span>] &gt; current - delta]</span><br><span class="line">            <span class="comment"># 留下的数据形成了一个窗口，这是一个新建的buffer，和上面的buffer没关系</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">donothing_handler</span><span class="params">(iterable:list)</span>:</span>  <span class="comment"># 打印一下，不做其他</span></span><br><span class="line">    print(iterable)</span><br><span class="line">    <span class="keyword">return</span> iterable</span><br><span class="line"></span><br><span class="line"><span class="comment"># 状态码分析</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">status_handler</span><span class="params">(iterable:list)</span>:</span></span><br><span class="line">    d = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        key = item[<span class="string">'status'</span>]</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> d.keys():</span><br><span class="line">            d[key] = <span class="number">0</span></span><br><span class="line">        d[key] += <span class="number">1</span></span><br><span class="line">    total = sum(d.values())</span><br><span class="line">    <span class="comment"># print(d,'!!!')   # 这是字典</span></span><br><span class="line">    <span class="comment"># print(total,'@@@')   # 这是字典键值的和</span></span><br><span class="line">    <span class="comment"># &#123;200: 46, 500: 1&#125; !!!</span></span><br><span class="line">    <span class="comment"># 47 @ @ @</span></span><br><span class="line">    <span class="comment"># &#123;200: 97.87234042553192, 500: 2.127659574468085&#125;</span></span><br><span class="line">    <span class="comment"># &#123;200: 3, 301: 1&#125; !!!</span></span><br><span class="line">    <span class="comment"># 4 @ @ @</span></span><br><span class="line">    <span class="comment"># &#123;200: 75.0, 301: 25.0&#125;</span></span><br><span class="line">    <span class="comment"># &#123;200: 1&#125; !!!</span></span><br><span class="line">    <span class="comment"># 1 @ @ @</span></span><br><span class="line">    <span class="comment"># &#123;200: 100.0&#125;</span></span><br><span class="line"><span class="comment"># 可以计算字典中键值的和，下面再用键值除以键值的和再乘以100就是占比了</span></span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> &#123;k:v/total*<span class="number">100</span> <span class="keyword">for</span> k,v <span class="keyword">in</span> d.items()&#125;</span><br><span class="line"><span class="comment"># 乘以100是为了计算百分比</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器分析</span></span><br><span class="line">ua_dict = defaultdict(<span class="keyword">lambda</span> :<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 这一句从browser_handler函数中移到这里后，会记录所有处理后的结果，如果在browser_handler内，就只会记录一段处理的数据，之后会被重置</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">browser_handler</span><span class="params">(iterable:list)</span>:</span></span><br><span class="line"><span class="comment">#     ua_dict = defaultdict(lambda :0)</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        ua = item[<span class="string">'useragent'</span>]</span><br><span class="line">        <span class="comment"># ua = parse('')</span></span><br><span class="line">    	key = (ua.browser.family, ua.browser.version_string)   </span><br><span class="line">        <span class="comment"># 字典的key应该可hash，但ua.browser是不可hash的，family和version_string都是字符串</span></span><br><span class="line">        ua_dict[key] += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> ua_dict</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="comment"># def handler(iterable:list):</span></span><br><span class="line"><span class="comment">#     # TODO</span></span><br><span class="line"><span class="comment">#     return sum(iterable) // len(iterable)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def size_handler(iterable:list):</span></span><br><span class="line"><span class="comment">#     # TODO</span></span><br><span class="line"><span class="comment">#     pass</span></span><br><span class="line"><span class="comment"># handler是处理数据的，从外面传入，window函数只返回基本的数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># window(load('test.log'),donothing_handler,10,5)  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">(src)</span>:</span>   <span class="comment"># src是load函数生成的数据</span></span><br><span class="line">    <span class="comment"># 队列列表</span></span><br><span class="line">    queues = []   <span class="comment"># 这是容器，将结果保存下来</span></span><br><span class="line">    threads = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(handler, width, interval)</span>:</span>  <span class="comment"># 注册的是变化的东西，注册的过程就是传参的过程</span></span><br><span class="line">        q = Queue()   <span class="comment"># 每个线程各自用自己的queue</span></span><br><span class="line">        queues.append(q)   <span class="comment"># 注册一次就保存一个q到queues中</span></span><br><span class="line">        <span class="comment"># 注册就分配一个邮箱，为了能调用，把q放到一个队列列表中，不然，q用完就没了</span></span><br><span class="line">        <span class="comment"># window(q, handler, width, interval)</span></span><br><span class="line">        t = threading.Thread(target=window, args=(q, handler, width, interval))</span><br><span class="line"><span class="comment"># 这里是一个调用window函数的过程，每个window函数都应该有自己的q，q就是自定义的队列。因为q执行完会消失，所以在外面创建了queues队列保存q，queues列表中每个元素都是q队列，这个列表就是为了在下面的run函数中迭代用，在run函数中相当于把一份数据x给所有列表中的q一份，这样一份数据就变成了多份数据</span></span><br><span class="line">        threads.append(t)</span><br><span class="line">        <span class="comment"># 因为window函数会阻塞住，所以把它做到一个线程里去</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">            t.start()   <span class="comment"># 这里启动线程，上面的reg只是注册</span></span><br><span class="line">    </span><br><span class="line">    	<span class="keyword">for</span> x <span class="keyword">in</span> src:</span><br><span class="line"><span class="comment"># 这里的x就是load生成器函数yield出来的字典，把x这个字典放到q队列中</span></span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> queues:   <span class="comment"># 给副本，</span></span><br><span class="line">                q.put(x)   <span class="comment"># 给每个q里都送一个x</span></span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> reg,run</span><br><span class="line"></span><br><span class="line">reg,run = dispatcher(load(<span class="string">'test.log'</span>))  <span class="comment"># 从这里传参</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># reg注册窗口</span></span><br><span class="line">reg(donothing_handler, <span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line">reg(status_handler, <span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line">reg(browser_handler, <span class="number">5</span>, <span class="number">5</span>)   <span class="comment"># 这个窗口数据不需要重叠，所以用了两个一样的数字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">run()</span><br><span class="line">===============================================================================</span><br><span class="line"><span class="comment"># 定义了上面的extract函数后，下面的代码就没有用了</span></span><br><span class="line">fields = []</span><br><span class="line">flag = <span class="keyword">False</span></span><br><span class="line">tmp = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(fields[10:])</span></span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> logline.split():</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> flag: </span><br><span class="line">    	<span class="keyword">if</span> (word.startswith(<span class="string">'['</span>) <span class="keyword">or</span> word.startswith(<span class="string">'"'</span>)):  <span class="comment"># 以[或"开头</span></span><br><span class="line">        	tmp = word[<span class="number">1</span>:]</span><br><span class="line">        	<span class="keyword">if</span> word.endswith(<span class="string">']'</span>) <span class="keyword">or</span> word.endswith(<span class="string">'"'</span>):</span><br><span class="line">                tmp = word.strip(<span class="string">'[]"'</span>)</span><br><span class="line">                fields.append(tmp)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">        		flag = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">             fields.append(word)  </span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        <span class="keyword">if</span> word.endswith(<span class="string">']'</span>) <span class="keyword">or</span> word.endswith(<span class="string">'"'</span>):</span><br><span class="line">            tmp += <span class="string">" "</span> + word[:<span class="number">-1</span>]  <span class="comment"># word.strip[']"']</span></span><br><span class="line">            fields.append(tmp) </span><br><span class="line">            </span><br><span class="line">            tmp = <span class="string">""</span></span><br><span class="line">            flag = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tmp += <span class="string">" "</span> + word</span><br><span class="line">        <span class="keyword">continue</span> </span><br><span class="line">    <span class="comment"># lst.append(word)   # 如何处理[]与"。上面两个条件都用了continue，所以这句没有用了</span></span><br><span class="line">print(fields)</span><br><span class="line">d = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i,field <span class="keyword">in</span> enumerate(fields):</span><br><span class="line">    key = names[i]</span><br><span class="line">    print(ops[i])</span><br><span class="line">    <span class="keyword">if</span> ops[i]:   <span class="comment"># 如果ops[i]不是None</span></span><br><span class="line">        d[key] = ops[i](field)   </span><br><span class="line"><span class="comment">#  当ops[i]是convert_time时，将field传入convert_time函数进行处理。convert_time是我们上面自定义的函数</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">    	d[key] = field   <span class="comment"># 如果是None的情况</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">265</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">185</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
