<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/7/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-浏览器分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-浏览器分析/" itemprop="url">
                  python基础学习-浏览器分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:29:14" itemprop="dateCreated datePublished" datetime="2020-02-06T10:29:14+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="浏览器分析"><a href="#浏览器分析" class="headerlink" title="浏览器分析"></a>浏览器分析</h3><h4 id="useragent"><a href="#useragent" class="headerlink" title="useragent"></a>useragent</h4><p>这里指的是，软件按照一定的格式向远端的服务器提供一个标识自己的字符串。</p>
<p>在HTTP协议中，使用user-agent字段传送这个字符串。</p>
<p>注意：这个值可以被修改</p>
<p>格式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">现在浏览器的user-agent值格式一般如下：</span><br><span class="line">Mozilla/[version] ([system <span class="keyword">and</span> browser information]) [platform] ([platform details]) [extensions]</span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line">chrome</span><br><span class="line">Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">6.1</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">57.0</span><span class="number">.2987</span><span class="number">.133</span> Safari/<span class="number">537.36</span></span><br><span class="line"></span><br><span class="line">Firefox</span><br><span class="line">Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">6.1</span>; Win64; x64; rv:<span class="number">56.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">56.0</span></span><br><span class="line">Mozilla/<span class="number">5.0</span> (X11; Ubuntu; Linux x86_64; rv:<span class="number">52.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">52.0</span></span><br><span class="line"></span><br><span class="line">IE</span><br><span class="line">Mozilla/<span class="number">5.0</span> (compatible; MSIE <span class="number">10.0</span>; Windows NT <span class="number">6.1</span>; WOW64; Trident/<span class="number">6.0</span>; SLCC2; .NET CLR <span class="number">2.0</span><span class="number">.50727</span>; .NET CLR <span class="number">3.5</span><span class="number">.30729</span>; .NET CLR <span class="number">3.0</span><span class="number">.30729</span>; Media Center PC <span class="number">6.0</span>; .NET4<span class="number">.0</span>C; .NET4<span class="number">.0</span>E)</span><br></pre></td></tr></table></figure>
<h4 id="信息提取"><a href="#信息提取" class="headerlink" title="信息提取"></a>信息提取</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pyyaml、ua-parser、user-agents模块</span><br><span class="line">安装</span><br><span class="line">pip install pyaml ua-parser user-agents</span><br><span class="line">使用</span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">useragents = [</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:56.0) Gecko/20100101 Firefox/56.0"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E)"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> uastring <span class="keyword">in</span> useragents:</span><br><span class="line">    ua = parse(uastring)</span><br><span class="line">    print(ua.browser, ua.browser.family, ua.browser.version, ua.browser.version_string)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 运行结构</span></span><br><span class="line">Browser(family=<span class="string">'Chrome'</span>, version=(<span class="number">57</span>, <span class="number">0</span>, <span class="number">2987</span>), version_string=<span class="string">'57.0.2987'</span>) Chrome (<span class="number">57</span>, <span class="number">0</span>, <span class="number">2987</span>) <span class="number">57.0</span><span class="number">.2987</span></span><br><span class="line">Browser(family=<span class="string">'Firefox'</span>, version=(<span class="number">56</span>, <span class="number">0</span>), version_string=<span class="string">'56.0'</span>) Firefox (<span class="number">56</span>, <span class="number">0</span>) <span class="number">56.0</span></span><br><span class="line">Browser(family=<span class="string">'Firefox'</span>, version=(<span class="number">52</span>, <span class="number">0</span>), version_string=<span class="string">'52.0'</span>) Firefox (<span class="number">52</span>, <span class="number">0</span>) <span class="number">52.0</span></span><br><span class="line">Browser(family=<span class="string">'IE'</span>, version=(<span class="number">10</span>, <span class="number">0</span>), version_string=<span class="string">'10.0'</span> <span class="number">10.0</span>)</span><br></pre></td></tr></table></figure>
<p>ua.browser.family和ua.browser.version_string分别返回浏览器名称、版本号。</p>
<h4 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h4><p>ops 增加对useragent的处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> timestr: datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int,</span><br><span class="line">    <span class="string">'length'</span>:int,</span><br><span class="line">    <span class="string">'request'</span>:<span class="keyword">lambda</span> request:dict(zip((<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>),request.split())),</span><br><span class="line">    <span class="string">'useragent'</span>:<span class="keyword">lambda</span> useragent: parse(useragent)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> datestr: datetime.datetime.strptime(datestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int,</span><br><span class="line">    <span class="string">'size'</span>:int,</span><br><span class="line">    <span class="string">'useragent'</span>:<span class="keyword">lambda</span> ua: parse(ua)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加浏览器分析函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">browser_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    browsers = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        ua = item[<span class="string">'useragent'</span>]</span><br><span class="line">        key = (ua.browser.family, ua.browser.version_string)</span><br><span class="line">        browsers[key] = browsers.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> browsers</span><br></pre></td></tr></table></figure>
<p>注册handler，注意时间窗口宽度</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg(browser_handler, <span class="number">5</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>问题</p>
<p>如果想知道所有浏览器的统计，怎么办？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">allbrowsers = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器分析</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">browser_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    browsers = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        ua = item[<span class="string">'useragent'</span>]</span><br><span class="line">        key = (ua.browser.family, ua.browser.version_string)</span><br><span class="line">        browsers[key] = browsers.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        allbrowsers[key] = allbrowsers.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">    print(sorted(allbrowsers.items(), key=kambda x:x[<span class="number">1</span>], reverse=<span class="keyword">True</span>)[:<span class="number">10</span>])</span><br><span class="line">    <span class="keyword">return</span> browsers</span><br></pre></td></tr></table></figure>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据源</span></span><br><span class="line">PATTERN = <span class="string">'''(?P&lt;remote&gt;[\d\.]&#123;7,&#125;)\s-\s-\s\[(?P&lt;datetime&gt;[^\[\]]+)\]\s\</span></span><br><span class="line"><span class="string">"(?P&lt;method&gt;.*)\s(?P&lt;url&gt;.*)\s(?P&lt;protocol&gt;.*)"\s\</span></span><br><span class="line"><span class="string">(?P&lt;status&gt;\d&#123;3&#125;)\s(?P&lt;size&gt;\d+)\s"[^"]+"\s"(?P&lt;useragent&gt;[^"]+)'''</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(PATTERN) <span class="comment"># 编译</span></span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> datestr:datetime.datetime.strptime(datestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int</span><br><span class="line">    <span class="string">'size'</span>:int</span><br><span class="line">    <span class="string">'useragent'</span>:<span class="keyword">lambda</span> ua:parse(ua)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extrace</span><span class="params">(line:str)</span> -&gt; dict:</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">if</span> matcher:</span><br><span class="line">        <span class="keyword">return</span> &#123;name:ops.get(name, <span class="keyword">lambda</span> x:x)(data) <span class="keyword">for</span> name, data <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 装载文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openfile</span><span class="params">(path:str)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            fields = extract(line)</span><br><span class="line">            <span class="keyword">if</span> fields:</span><br><span class="line">                <span class="keyword">yield</span> fields</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># TODO 解析失败则抛弃或者记录日志</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(*path)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> paths:</span><br><span class="line">        p = Path(item)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.exists():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> p.is_dir():</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> p.iterdir():</span><br><span class="line">                <span class="keyword">if</span> file.is_file():</span><br><span class="line">                    <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(file))</span><br><span class="line">        <span class="keyword">elif</span> p.is_file():</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(p))</span><br><span class="line">                </span><br><span class="line"><span class="comment"># 数据处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(second=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""生成数据"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">'datetime'</span>:datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=<span class="number">8</span>))),</span><br><span class="line">            <span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(second)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 滑动窗口函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src:Queue, handler, width:int, interval:int)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    窗口函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param src: 数据源，缓存队列，用来拿数据</span></span><br><span class="line"><span class="string">    :param handler: 数据处理函数</span></span><br><span class="line"><span class="string">    :param width: 时间窗口宽度，秒</span></span><br><span class="line"><span class="string">    :param interval: 处理时间间隔，秒</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    start = datetime.datetime.strptime(<span class="string">'20170101 000000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'20170101 010000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    buffer = [] <span class="comment"># 窗口中的待计算数据</span></span><br><span class="line">    delta = datetime.timedelta(seconds=width-interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 从数据源获取数据</span></span><br><span class="line">        data = src.get()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data) <span class="comment"># 存入临时缓冲等待计算</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 每隔interval计算buffer中的数据一次</span></span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line">            ret = handler(buffer)</span><br><span class="line">            print(<span class="string">'&#123;&#125;'</span>.format(ret))</span><br><span class="line">            start = current</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 清除超出width的数据</span></span><br><span class="line">            buffer = [x <span class="keyword">for</span> x <span class="keyword">in</span> buffer <span class="keyword">if</span>  x[<span class="string">'datetiem'</span>] &gt; current - delta]</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 随机数平均数测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x:x[<span class="string">'value'</span>],iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">donothing_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> iterable</span><br><span class="line"><span class="comment"># 状态码占比</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">status_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    status = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        key = item[<span class="string">'status'</span>]</span><br><span class="line">        status[key] = status.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    <span class="comment"># total = sum(status.values())</span></span><br><span class="line">    total = len(iterable)</span><br><span class="line">    <span class="keyword">return</span> &#123;k:status[k]/total <span class="keyword">for</span> k,v <span class="keyword">in</span> status.items()&#125;</span><br><span class="line"></span><br><span class="line">allbrowsers = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器分析</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">browser_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    browsers = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        ua = item[<span class="string">'useragent'</span>]</span><br><span class="line">        key=(ua.browser.family, ua.browser.version_string)</span><br><span class="line">        browsers[key] = browsers.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        allbrowsers[key] = allbrowsers.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">    print(sorted(aoobrowsers.items(), key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>], reverse=<span class="keyword">True</span>)[:<span class="number">10</span>])</span><br><span class="line">    <span class="keyword">return</span> browsers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="comment"># 分发器中记录handler，同时保存各自的队列</span></span><br><span class="line">    handlers = []</span><br><span class="line">    queues = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(handler, width:int, interval:int)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        注册 窗口处理函数</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :param handler: 注册的数据处理函数</span></span><br><span class="line"><span class="string">        :param width: 时间窗口宽度</span></span><br><span class="line"><span class="string">        :param interval: 时间间隔</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        q = Queue()</span><br><span class="line">        queues.append(q)</span><br><span class="line">        </span><br><span class="line">        h = threading.Thread(target=window, args=(q, handler, width, interval))</span><br><span class="line">        handlers.append(h)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> handlers:</span><br><span class="line">            t.start() <span class="comment"># 启动线程处理数据</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> src: <span class="comment"># 将数据源取到的数据分发到所有队列中</span></span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> queues:</span><br><span class="line">                q.put(item)</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> reg, run</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"main"</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="comment"># path = sys.argv[1]</span></span><br><span class="line">    path = <span class="string">'test.log'</span></span><br><span class="line">    </span><br><span class="line">    reg, run = dispatcher(load(path))</span><br><span class="line"><span class="comment"># dispatcher()返回的是reg和run函数，把这两个函数赋值给reg和run，下面再调用这两个函数并传参</span></span><br><span class="line">    reg(donothing_handler, <span class="number">10</span>, <span class="number">5</span>) <span class="comment"># 注册处理函数</span></span><br><span class="line">    reg(browser_handler, <span class="number">5</span>, <span class="number">5</span>)</span><br><span class="line">    run() <span class="comment"># 运行</span></span><br></pre></td></tr></table></figure>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 代码在信息提取中</span></span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">u = <span class="string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert</span><span class="params">(u)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> parse(u)  <span class="comment"># 返回一个user-agent对象</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#  print(ua.browser)</span></span><br><span class="line">  <span class="comment">#  return (ua.browser.family, ua.browser.version_string)  # 这样可以取得浏览器名称与版本号</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-文件加载及分析器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-文件加载及分析器/" itemprop="url">
                  python基础学习-文件加载及分析器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:29:04" itemprop="dateCreated datePublished" datetime="2020-02-06T10:29:04+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="完成分析功能"><a href="#完成分析功能" class="headerlink" title="完成分析功能"></a>完成分析功能</h4><p>分析日志很重要，通过海量数据分析就能够知道是否遭受了攻击，是否被爬取及爬取高峰期，是否有盗链等。</p>
<p>百度（Baidu）爬虫名称（Baiduspider）</p>
<p>谷歌（Google）爬虫名称（Googlebot）</p>
<h4 id="状态码分析"><a href="#状态码分析" class="headerlink" title="状态码分析"></a>状态码分析</h4><p>状态码中包含了很多信息。例如</p>
<p>304，服务器收到客户端提交的请求参数，发现资源未变化，要求浏览器使用静态资源的缓存</p>
<p>404，服务器找不到请求的资源</p>
<p>304占比大，说明静态缓存效果明显。404占比大，说明网站出现了错误链接，或者尝试嗅探网站资源。</p>
<p>如果400、500占比突然开始增大，网站一定出问题了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 状态码占比</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">status_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="comment"># 时间窗口内的一批数据</span></span><br><span class="line">    status = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        key = item[<span class="string">'status'</span>]</span><br><span class="line">        status[key] = status.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        <span class="comment"># total = sum(status.values())</span></span><br><span class="line">        total = len(iterable)</span><br><span class="line">        <span class="keyword">return</span> &#123;k:status[k]/total <span class="keyword">for</span> k,v <span class="keyword">in</span> status.items()&#125;</span><br></pre></td></tr></table></figure>
<p>如果还需要什么分析，增加分析函数handler注册就行了</p>
<h4 id="日志文件的加载"><a href="#日志文件的加载" class="headerlink" title="日志文件的加载"></a>日志文件的加载</h4><p>目前实现的代码中，只能接受一个路径，修改为接受一批路径。</p>
<p>可以约定一下路径下文件的存入方式：</p>
<p>如果送来的是一批路径，就迭代其中路径。</p>
<p>如果路径是一个普通文件，就按照行读取内容。</p>
<p>如果路径是一个目录，就遍历路径下所有普通文件，每一个文件按照行处理。不递归处理子目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(*paths)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> paths:</span><br><span class="line">        p = Path(item)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.exists():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> p.is_dir():</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> p.iterdir():</span><br><span class="line">                <span class="keyword">if</span> file.is_file():</span><br><span class="line">                    <span class="keyword">pass</span> <span class="comment"># 和下面处理一样</span></span><br><span class="line">        <span class="keyword">elif</span> p.is_file():</span><br><span class="line">            <span class="keyword">with</span> open(str(p)) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                    fields = extract(line)</span><br><span class="line">                    <span class="keyword">if</span> fields:</span><br><span class="line">                        <span class="keyword">yield</span> fields</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">continue</span> <span class="comment"># TODO 解析失败则抛弃或者记录日志</span></span><br></pre></td></tr></table></figure>
<p>写的过程中发现重复的地方，把文件处理部分提出来写成函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openfile</span><span class="params">(path:str)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            fields = extract(line)</span><br><span class="line">            <span class="keyword">if</span> fields:</span><br><span class="line">                <span class="keyword">yield</span> fields</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># TODO 解析失败则抛弃或者记录日志</span></span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(*paths)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> paths:</span><br><span class="line">        p = Path(item)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.exists():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> p.is_dir():</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> p.iterdir():</span><br><span class="line">                <span class="keyword">if</span> file.is_file():</span><br><span class="line">                    <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(file))</span><br><span class="line">        <span class="keyword">elif</span> p.is_file():</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(p))</span><br></pre></td></tr></table></figure>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据源</span></span><br><span class="line">PATTERN = <span class="string">'''(?P&lt;remote&gt;[\d\.]&#123;7,&#125;)\s-\s-\s\[(?P&lt;datetime&gt;[^\[\]]+)\]\s\</span></span><br><span class="line"><span class="string">"(?P&lt;method&gt;.*)\s(?P&lt;url&gt;.*)\s(?P&lt;protocol&gt;.*)"\s\</span></span><br><span class="line"><span class="string">(?P&lt;status&gt;\d&#123;3&#125;)\s(?P&lt;size&gt;\d+)\s"[^"]+"\s"(?P&lt;useragent&gt;[^"]+)'''</span></span><br><span class="line">regex = re.compile(PATTERN)</span><br><span class="line"></span><br><span class="line">OPS = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> datestr: datetime.datetime.strptime(datestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int,</span><br><span class="line">    <span class="string">'size'</span>:int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(line:str)</span> -&gt; dict:</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">if</span> matcher:</span><br><span class="line">        <span class="keyword">return</span> &#123;name:ops.get(name, <span class="keyword">lambda</span> x:x)(data) <span class="keyword">for</span> name, data <span class="keyword">in</span> matcher.groupdict()items()&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 装载文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openfile</span><span class="params">(path:str)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            fields = extract(line)</span><br><span class="line">            <span class="keyword">if</span> fields:</span><br><span class="line">                <span class="keyword">yield</span> fields</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># TODO解析失败则抛弃或者记录日志</span></span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(*paths)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> paths:</span><br><span class="line">        p = Path(item)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.exists():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> p.is_dir():</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> p.iterdir():</span><br><span class="line">                <span class="keyword">if</span> file.is_file():</span><br><span class="line">                    <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(file))</span><br><span class="line">        <span class="keyword">elif</span> p.is_file():</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(p))</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 数据处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(second=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""生成数据"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">'datetime'</span>:datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=<span class="number">8</span>))),</span><br><span class="line">            <span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(second)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 滑动窗口函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src:Queue, handler, width:int, interval:int)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    窗口函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param src: 数据源，缓存队列，用来拿数据</span></span><br><span class="line"><span class="string">    :param handler: 数据处理函数</span></span><br><span class="line"><span class="string">    :param width: 时间窗口宽度，秒</span></span><br><span class="line"><span class="string">    :param interval: 处理时间间隔，秒</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    start = datetime.datetime.strptime(<span class="string">'20170101 000000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'20170101 010000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    buffer = [] <span class="comment"># 窗口中的待计算数据</span></span><br><span class="line">    delta = datetime.timedelta(seconds=width-interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 从数据源获取数据</span></span><br><span class="line">        data = src.get()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data) <span class="comment"># 存入临时缓冲等待计算</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 每隔interval计算buffer中的数据一次</span></span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line">            ret = handler(buffer)</span><br><span class="line">            print(<span class="string">'&#123;&#125;'</span>.format(ret))</span><br><span class="line">            start = current</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 清除超出width的数据</span></span><br><span class="line">            buffer = [x <span class="keyword">for</span> x <span class="keyword">in</span> buffer <span class="keyword">if</span> x[<span class="string">'datetime'</span>] &gt; current - delta]</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 随机数平均数测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x:x[<span class="string">'value'</span>], iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">donothing_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> iterable</span><br><span class="line"></span><br><span class="line"><span class="comment"># 状态码占比</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">status_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="comment"># 时间窗口内的一批数据</span></span><br><span class="line">    status = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        key = item[<span class="string">'status'</span>]</span><br><span class="line">        status[key] = status.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    <span class="comment"># total = sum(status.values())</span></span><br><span class="line">    total = len(iterable)</span><br><span class="line">    <span class="keyword">return</span> &#123;k:status[k]/total <span class="keyword">for</span> k,v <span class="keyword">in</span> status.items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="comment"># 分发器中记录handler，同时保存各自的队列</span></span><br><span class="line">    handlers = []</span><br><span class="line">    queues = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(handler, width:int, interval:int)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        注册 窗口处理函数</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :param handler: 注册的数据处理函数</span></span><br><span class="line"><span class="string">        :param width: 时间窗口宽度</span></span><br><span class="line"><span class="string">        :param interval: 时间间隔</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        q = Queue()</span><br><span class="line">        queues.append(q)</span><br><span class="line">        </span><br><span class="line">        h = threading.Thread(target=window, args=(q, handler, width, interval))</span><br><span class="line">        handlers.append(h)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> handlers:</span><br><span class="line">            t.start() <span class="comment"># 启动线程处理数据</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> src:</span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> queues:</span><br><span class="line">                q.put(item)</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> reg, run</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="comment">#path = sys.argv[1]</span></span><br><span class="line">    path = <span class="string">'test.log'</span></span><br><span class="line">    </span><br><span class="line">    reg, run = dispatcher(load(path))</span><br><span class="line">    reg(status_handler, <span class="number">10</span>, <span class="number">5</span>) <span class="comment"># 注册</span></span><br><span class="line">    run() <span class="comment"># 运行</span></span><br></pre></td></tr></table></figure>
<p>到这里，一个离线日志分析项目基本完成。</p>
<ol>
<li>可以指定文件或目录，对日志进行数据分析</li>
<li>分析函数可以动态注册</li>
<li>数据可以分发给不同的分析处理程序处理</li>
</ol>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 代码在信息提取中</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-数据分发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-数据分发/" itemprop="url">
                  python基础学习-数据分发
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:28:53" itemprop="dateCreated datePublished" datetime="2020-02-06T10:28:53+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="分发"><a href="#分发" class="headerlink" title="分发"></a>分发</h3><h4 id="生产者消费者模型"><a href="#生产者消费者模型" class="headerlink" title="生产者消费者模型"></a>生产者消费者模型</h4><p>对于一个监控系统，需要处理很多数据，包括日志。对其中已有数据的采集、分析。被监控对象就是数据的生产者producer，数据的处理程序就是数据的消费者consumer。</p>
<p>生产者消费者传统模型</p>
<p><img src="/images/python数据分发/数据分发1.png" alt=""></p>
<p>传统的生产者消费者模型，生产者生产，消费者消费。但这种模型有些问题。开发的代码耦合太高，如果生成规模扩大，不易扩展，生产和消费的速度很难匹配等。</p>
<p>思考一下，生产者和消费者的问题是什么？</p>
<p>举例：</p>
<p>卖包子的，如果包子卖不完，还要继续蒸包子，会怎么样？門可罗雀，包子成山。如果把包子先蒸一些，卖着，快卖完了，赶紧包，再蒸一些。不会有等包子的队伍。如果包子供不应求，还没有和面呢，包子都被预定了，出现排除等包子的情况。上面这些情况，最核心的问题，就是生产者和消费者速度要匹配的问题。但是，往往速度不能够很好的匹配。</p>
<p>解决的办法—队列queue</p>
<p>作用—解耦、缓冲</p>
<p><img src="/images/python数据分发/数据分发2.png" alt=""></p>
<p>日志生产者往往会部署好几个程序，日志产生的也很多，而消费者也会有多个程序，去提取日志分析处理。</p>
<p>数据的生产是不稳定的！会造成短时间数据的“潮涌”，需要缓冲。</p>
<p>消费者消费能力不一样，有快有慢，消费者可以自己决定消费缓冲区中的数据。</p>
<p>单机可以使用queue内奸的模块构建进程内的队列，满足多个线程间的生产消费需要。</p>
<p>大型系统可以使用第三方消息中间件：RabbitMQ、RocketMQ、Kafka</p>
<h4 id="queue模块—队列"><a href="#queue模块—队列" class="headerlink" title="queue模块—队列"></a>queue模块—队列</h4><p>queue模块提供了一个先进先出的队列Queue。</p>
<p>queue.Queue(maxsize=0)</p>
<p>创建FIFO队列，返回Queue对象。</p>
<p>maxsize小于等于0，队列长度没有限制</p>
<p>Queue.get(block=True, timeout=None)</p>
<p>从队列中移除元素并返回这个元素。</p>
<p>block为阻塞，timeout为超时。</p>
<p>如果block为True，是阻塞，timeout为None就是一直阻塞</p>
<p>如果block为True但是timeout有值，就阻塞到一定秒数抛出Empty异常</p>
<p>block为False，是非阻塞，timeout将被忽略，要么成功返回一个元素，要么抛出empty异常。</p>
<p>Queue.get_nowait()</p>
<p>等价于get(False)，也就是说要么成功返回一个元素，要么抛出empty异常。</p>
<p>但是queue的这种阻塞效果，需要多线程的时候演示。</p>
<p>Queue.put(item, block=True, timeout=None)</p>
<p>把一个元素加入到队列中去。</p>
<p>block=True, timeout=None, 一直阻塞直至有空位放元素。</p>
<p>block=True, timeout=5, 阻塞5秒就抛出Full异常。</p>
<p>block=False, timeout失效，立即返回，能塞进去就塞，不能则返回抛出Full异常。</p>
<p>Queue.put_nowait(item)</p>
<p>等价于put(item, False)，也就是能塞进去就塞，不能则返回抛出Full异常。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Queue测试</span></span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">q = Queue()</span><br><span class="line">q.put(random.randint(<span class="number">1</span>,<span class="number">100</span>))</span><br><span class="line">q.put(random.randint(<span class="number">1</span>,<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line"><span class="comment">#print(q.get()) # 阻塞</span></span><br><span class="line">print(q.get(timeout=<span class="number">3</span>)) <span class="comment"># 阻塞，但超时抛异常</span></span><br></pre></td></tr></table></figure>
<h4 id="分发器的实现"><a href="#分发器的实现" class="headerlink" title="分发器的实现"></a>分发器的实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">生产者（数据源）生产数据，缓冲到消息队列中</span><br><span class="line"></span><br><span class="line">数据处理流程：</span><br><span class="line">数据加载 -&gt; 提取 -&gt; 分析（滑动窗口函数）</span><br><span class="line"></span><br><span class="line">处理大量数据的时候，对于一个数据源来说，需要多个消费者处理。但是如何分配数据就是个问题了。</span><br><span class="line">需要一个分发器（调度器），把数据分发给不同的消费者处理。</span><br><span class="line">每一个消费者拿到数据后，有自己的处理函数。所以要有一种注册机制</span><br><span class="line"></span><br><span class="line">数据加载 -&gt; 提取 -&gt; 分发 -&gt; 分析函数1</span><br><span class="line">					 | -&gt; 分析函数2</span><br><span class="line">分析<span class="number">1</span>和分析<span class="number">2</span>是不同的handler，不同的窗口宽度、间隔时间</span><br><span class="line"></span><br><span class="line">如何分发？</span><br><span class="line">这里就简单一点，轮询策略。</span><br><span class="line">一对多的副本发送，一个数据通过分发器，发送到n个消费者。分发器如何知道有哪些消费者属于它管理呢，这就涉及到了注册</span><br><span class="line"></span><br><span class="line">消息队列</span><br><span class="line">在生产者和消费者之间使用消息队列，那么所有消费者共用一个消息队列，还是各自拥有一个消息队列呢？</span><br><span class="line">共用一个消息队列也可以，但是需要解决争抢的问题。相对来说每一个消费者自己拥有一个队列，较为容易。</span><br><span class="line"></span><br><span class="line">如何注册？</span><br><span class="line">在调度器内部记录有哪些消费者，每一个消费者拥有自己的队列。</span><br><span class="line"></span><br><span class="line">线程</span><br><span class="line">由于一条数据会被多个不同的注册过的handler处理，所以最好的方式是多线程。</span><br><span class="line"></span><br><span class="line">线程使用举例：</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义线程</span></span><br><span class="line"><span class="comment"># target线程中运行的函数；args这个函数运行时需要的实参的元组</span></span><br><span class="line">t = threading.Thread(target=window, args=(src, handler, width, interval))</span><br><span class="line"><span class="comment"># t是一个线程对象，之后用线程模块threading启动一个线程，这个线程Thread只是被定义了，真正启动是下面的</span></span><br><span class="line"><span class="comment"># t.start()，window是自定义的函数，这个线程就是执行这个函数的，后面的args中的是给函数的传参，这是用元组传参。</span></span><br><span class="line"><span class="comment"># 启动线程</span></span><br><span class="line">t.start()</span><br></pre></td></tr></table></figure>
<h4 id="分发器代码实现"><a href="#分发器代码实现" class="headerlink" title="分发器代码实现"></a>分发器代码实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(second=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""生成数据"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">'datetime'</span>:datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=<span class="number">8</span>))),</span><br><span class="line">            <span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(second)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src:Queue, handler, width:int, interval:int)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    窗口函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param src：数据源，缓存队列，用来拿数据</span></span><br><span class="line"><span class="string">    :param handler：数据处理函数</span></span><br><span class="line"><span class="string">    :param width：时间窗口宽度，秒</span></span><br><span class="line"><span class="string">    :param interval：处理时间间隔，秒</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    start = datetime.datetime.strptime(<span class="string">'20170101 000000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'20170101 010000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    buffer = [] <span class="comment"># 窗口中的待计算数据</span></span><br><span class="line">    delta =datetime.timedelta(seconds=width-interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 从数据源获取数据</span></span><br><span class="line">        data = src.get()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data) <span class="comment"># 存入临时缓冲等待计算</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 每隔interval计算buffer中的数据一次</span></span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line">            ret =handler(buffer)</span><br><span class="line">            print(<span class="string">'&#123;:.2f&#125;'</span>.format(ret))</span><br><span class="line">            start = current</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 清除超出width的数据</span></span><br><span class="line">            buffer = [x <span class="keyword">for</span> x <span class="keyword">in</span> buffer <span class="keyword">if</span> x[<span class="string">'datetime'</span>] &gt; current - delta]</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x:x[<span class="string">'value'</span>],iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="comment"># 分发器中记录handler，同时保存各自的队列</span></span><br><span class="line">    handlers = []</span><br><span class="line">    queues = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(handler, width:int, interval:int)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        注册 窗口处理函数</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :param handler：注册的数据处理函数</span></span><br><span class="line"><span class="string">        :param width：时间窗口宽度</span></span><br><span class="line"><span class="string">        :param interval：时间间隔</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        q = Queue()</span><br><span class="line">        queues.append(q)</span><br><span class="line">        </span><br><span class="line">        h = threading.Thread(target=window, args=(q, handler, width, interval))</span><br><span class="line">        handlers.append(h)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> handlers:</span><br><span class="line">            t.start() <span class="comment"># 启动线程处理数据</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> src: <span class="comment"># 将数据源取到的数据分发到所有队列中</span></span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> queues:</span><br><span class="line">                q.put(item)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> reg,run</span><br><span class="line"></span><br><span class="line">reg, run = dispatcher(source())</span><br><span class="line"></span><br><span class="line">reg(handler, <span class="number">10</span>, <span class="number">5</span>) <span class="comment"># 注册</span></span><br><span class="line">run() <span class="comment"># 运行</span></span><br></pre></td></tr></table></figure>
<p>注意，以上代码也只是现阶段所学知识的一种实现，项目中建议使用消息队列服务的”订阅”模式，消费者各自消费自己的队列的数据。</p>
<h4 id="整合代码"><a href="#整合代码" class="headerlink" title="整合代码"></a>整合代码</h4><p>load函数就是从日志中提取合格的数据的生成器函数。</p>
<p>它可以作为dispatcher函数的数据源。</p>
<p>原来写的handler函数处理一个字典的’datetime’字段，不能处理日志抽取函数extract返回的字典，提供一个新的函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据源</span></span><br><span class="line">PATTERN = <span class="string">'''(?P&lt;remote&gt;[\d\.]&#123;7,&#125;)\s-\s-\s\[(?P&lt;datetime&gt;[^\[\]]+)\]\s\</span></span><br><span class="line"><span class="string">"(?P&lt;method&gt;.*)\s(?P&lt;url&gt;.*)\s(?P&lt;protocol&gt;.*)"\s\</span></span><br><span class="line"><span class="string">(?P&lt;status&gt;\d&#123;3&#125;)\s(?P&lt;size&gt;\d+)\s"[^"]+"\s"(?P&lt;useragent&gt;[^"]+)'''</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(PATTERN) <span class="comment"># 编译</span></span><br><span class="line"></span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> datestr:datetime.datetime.strptime(datestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int</span><br><span class="line">    <span class="string">'size'</span>:int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extrace</span><span class="params">(line:str)</span> -&gt; dict:</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">if</span> matcher:</span><br><span class="line">        <span class="keyword">return</span> &#123;name:ops.get(name, <span class="keyword">lambda</span> x:x)(data) <span class="keyword">for</span> name, data <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="string">"""装载日志文件"""</span></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            fields = extract(line)</span><br><span class="line">            <span class="keyword">if</span> fields:</span><br><span class="line">                <span class="keyword">yield</span> fields</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># TODO 解析失败则抛弃或者记录日志</span></span><br><span class="line">                </span><br><span class="line"><span class="comment"># 数据处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(second=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""生成数据"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">'datetime'</span>:datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=<span class="number">8</span>))),</span><br><span class="line">            <span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(second)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 滑动窗口函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src:Queue, handler, width:int, interval:int)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    窗口函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param src: 数据源，缓存队列，用来拿数据</span></span><br><span class="line"><span class="string">    :param handler: 数据处理函数</span></span><br><span class="line"><span class="string">    :param width: 时间窗口宽度，秒</span></span><br><span class="line"><span class="string">    :param interval: 处理时间间隔，秒</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    start = datetime.datetime.strptime(<span class="string">'20170101 000000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'20170101 010000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    buffer = [] <span class="comment"># 窗口中的待计算数据</span></span><br><span class="line">    delta = datetime.timedelta(seconds=width-interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 从数据源获取数据</span></span><br><span class="line">        data = src.get()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data) <span class="comment"># 存入临时缓冲等待计算</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 每隔interval计算buffer中的数据一次</span></span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line">            ret = handler(buffer)</span><br><span class="line">            print(<span class="string">'&#123;&#125;'</span>.format(ret))</span><br><span class="line">            start = current</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 清除超出width的数据</span></span><br><span class="line">            buffer = [x <span class="keyword">for</span> x <span class="keyword">in</span> buffer <span class="keyword">if</span>  x[<span class="string">'datetiem'</span>] &gt; current - delta]</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 随机数平均数测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x:x[<span class="string">'value'</span>],iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">donothing_handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> iterable</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="comment"># 分发器中记录handler，同时保存各自的队列</span></span><br><span class="line">    handlers = []</span><br><span class="line">    queues = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(handler, width:int, interval:int)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        注册 窗口处理函数</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :param handler: 注册的数据处理函数</span></span><br><span class="line"><span class="string">        :param width: 时间窗口宽度</span></span><br><span class="line"><span class="string">        :param interval: 时间间隔</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        q = Queue()</span><br><span class="line">        queues.append(q)</span><br><span class="line">        </span><br><span class="line">        h = threading.Thread(target=window, args=(q, handler, width, interval))</span><br><span class="line">        handlers.append(h)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> handlers:</span><br><span class="line">            t.start() <span class="comment"># 启动线程处理数据</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> src: <span class="comment"># 将数据源取到的数据分发到所有队列中</span></span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> queues:</span><br><span class="line">                q.put(item)</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> reg, run</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"main"</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="comment"># path = sys.argv[1]</span></span><br><span class="line">    path = <span class="string">'test.log'</span></span><br><span class="line">    </span><br><span class="line">    reg, run = dispatcher(load(path))</span><br><span class="line">    reg(donothing_handler, <span class="number">10</span>, <span class="number">5</span>) <span class="comment"># 注册处理函数</span></span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实例代码在信息提取中</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-滑动窗口/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-滑动窗口/" itemprop="url">
                  python基础学习-滑动窗口
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:28:42" itemprop="dateCreated datePublished" datetime="2020-02-06T10:28:42+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="滑动窗口"><a href="#滑动窗口" class="headerlink" title="滑动窗口"></a>滑动窗口</h3><h4 id="数据载入"><a href="#数据载入" class="headerlink" title="数据载入"></a>数据载入</h4><p>对于本项目来说，数据就是日志的一行行记录，载入数据就是文件 IO的读取。将获取数据的方法封装成函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="string">"""装载日志文件"""</span></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            fields = extract(line)</span><br><span class="line">            <span class="keyword">if</span> fields:</span><br><span class="line">                <span class="keyword">yield</span> fields</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># TODO 解析失败就抛弃，或者打印日志</span></span><br></pre></td></tr></table></figure>
<h3 id="时间窗口分析"><a href="#时间窗口分析" class="headerlink" title="时间窗口分析"></a>时间窗口分析</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>很多数据，例如日志，都是和时间相关的，都是按照时间顺序产生的。</p>
<p>产生的数据分析的时候，要按照时间求值</p>
<p>interval 表示每一次求值的时间间隔</p>
<p>width 时间窗口宽度，指的一次求值的时间窗口宽度</p>
<h5 id="当width-gt-interval"><a href="#当width-gt-interval" class="headerlink" title="当width &gt; interval"></a>当width &gt; interval</h5><p><img src="/images/python滑动窗口/滑动窗口1.png" alt=""></p>
<p>数据求值时会有重叠。当走一个interval间隔后，用当前位置减去width宽度秒就是要采集的数据的起始位置。c2=c1-delta，delta=width-interval。当delta=0时，width=interval</p>
<h5 id="当width-interval"><a href="#当width-interval" class="headerlink" title="当width = interval"></a>当width = interval</h5><p><img src="/images/python滑动窗口/滑动窗口2.png" alt=""></p>
<p>数据求值没有重叠</p>
<h5 id="当width-lt-interval"><a href="#当width-lt-interval" class="headerlink" title="当width &lt; interval"></a>当width &lt; interval</h5><p>一般不采纳这种方案，会有数据缺失</p>
<h4 id="时序数据"><a href="#时序数据" class="headerlink" title="时序数据"></a>时序数据</h4><p>运维环境中，日志、监控等产生的数据都是与时间相关的数据，按照时间先后产生并记录下来的数据，所以一般按照时间对数据进行分析。</p>
<h5 id="数据分析基本程序结构"><a href="#数据分析基本程序结构" class="headerlink" title="数据分析基本程序结构"></a>数据分析基本程序结构</h5><p>无限的生成随机数函数，产生时间相关的数据，返回时间和随机数的字典</p>
<p>每次取3个数据，求平均值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;<span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>),<span class="string">'datetime'</span>:datetime.datetime.now()&#125;</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 获取数据</span></span><br><span class="line">s = source()</span><br><span class="line">items = [next(s) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> item:item[<span class="string">'value'</span>],iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line">print(items)</span><br><span class="line">print(<span class="string">"&#123;:.2f&#125;"</span>.format(handler(items)))</span><br></pre></td></tr></table></figure>
<p>上面代码模拟了，一段时间内产生了数据，等了一段固定的时间取数据来计算平均值。</p>
<h5 id="窗口函数实现"><a href="#窗口函数实现" class="headerlink" title="窗口函数实现"></a>窗口函数实现</h5><p>将上面的获取数据的程序扩展为window函数。使用重叠的方案</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(second=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""生成数据"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">'datetime'</span>:datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=<span class="number">8</span>))),</span><br><span class="line">            <span class="string">'value'</span>:random.randint(<span class="number">1</span>,<span class="number">100</span>) 			</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(second)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(iterator, handler, width:int, interval:int)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    窗口函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param iterator：数据源，生成器，用来拿数据</span></span><br><span class="line"><span class="string">    :param handler：数据处理函数</span></span><br><span class="line"><span class="string">    :param width：时间窗口宽度，秒</span></span><br><span class="line"><span class="string">    :param interval：处理时间间隔，秒</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    start = datetime.datetime.strptime(<span class="string">'20170101 000000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'20170101 010000 +0800'</span>, <span class="string">'%Y%m%d %H%M%S %z'</span>)</span><br><span class="line">    buffer = [] <span class="comment"># 窗口中的待计算数据</span></span><br><span class="line">    delta = datetime.timedelta(seconds=width-interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 从数据源获取数据</span></span><br><span class="line">        data = next(iterator)</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data) <span class="comment"># 存入临时缓冲等待计算</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 每隔interval计算buffer中的数据一次</span></span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line"><span class="comment"># 当现在的时间减去开始时间大于等于间隔时间时就处理一下buffer中的数据，第一次处理数据时因为start和</span></span><br><span class="line"><span class="comment"># current都设置成了1970年，所以buffer中存储一条data数据后就会对buffer数据进行处理，之后buffer中会</span></span><br><span class="line"><span class="comment"># 存储两条数据才被处理</span></span><br><span class="line"></span><br><span class="line">            ret = handler(buffer)</span><br><span class="line">            print(<span class="string">'&#123;:.2f&#125;'</span>.format(ret))</span><br><span class="line">            start = current</span><br><span class="line">            <span class="comment"># 清除超出width的数据</span></span><br><span class="line">            buffer = [x <span class="keyword">for</span> x <span class="keyword">in</span> buffer <span class="keyword">if</span> x[<span class="string">'datetime'</span>] &gt; current - delta]</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x:x[<span class="string">'value'</span>],iterable)) / len(iterable)</span><br><span class="line"></span><br><span class="line">window(source(), handler, <span class="number">10</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>时间的计算</p>
<p><img src="/images/python滑动窗口/滑动窗口3.png" alt=""></p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 无限产出随机数</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime   <span class="comment"># 时序数据与时间相关，所以导入此模块</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> datetime.datetime.now(),random.randint(<span class="number">1</span>,<span class="number">100</span>)  </span><br><span class="line">        <span class="comment"># 如果要yield出去，要将yield放在一个函数中，这就是一个生成器函数</span></span><br><span class="line">        <span class="comment"># now()的格式与其他语言可能不太一样，所以使用时间戳更好</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># src = source()  # 这里返回一个生成器对象</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> source():   <span class="comment"># 这样使用时source()中的数据就不会再变动了</span></span><br><span class="line">    print(x)</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> i&gt;<span class="number">10</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面拿三个数据        </span></span><br><span class="line">src = source()</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">lst = [next(src) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>)]</span><br><span class="line"><span class="comment"># lst.append(next(src))</span></span><br><span class="line"><span class="comment"># lst.append(next(src)) </span></span><br><span class="line"><span class="comment"># lst.append(next(src)) </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(iterable) // len(iterable)</span><br><span class="line">=======================================================================================</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> datetime   <span class="comment"># 时序数据与时间相关，所以导入此模块</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> datetime.datetime.now(),random.randint(<span class="number">1</span>,<span class="number">100</span>) </span><br><span class="line">        </span><br><span class="line">src = source()</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">lst = [next(src) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src, handler, width:int, interval:int)</span>:</span></span><br><span class="line">	i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> src</span><br><span class="line">		i += <span class="number">1</span></span><br><span class="line">    	print(x)</span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">window(load(<span class="string">'test.log'</span>),<span class="keyword">None</span>,<span class="number">0.0</span>)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-信息提取/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-信息提取/" itemprop="url">
                  python基础学习-信息提取
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:28:32" itemprop="dateCreated datePublished" datetime="2020-02-06T10:28:32+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-07-06 16:20:12" itemprop="dateModified" datetime="2020-07-06T16:20:12+08:00">2020-07-06</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>生产中会生成大量的系统日志、应用程序日志、安全日志等等日志，通过对日志的分析可以了解服务器的负载、健康状况，可以分析客户的分布情况、客户的行为，甚至基于这些分析可以做出预测。</p>
<p>一般采集流程</p>
<p>日志产出 -&gt; 采集（Logstash、Flume、Scribe）-&gt; 存储 -&gt; 分析 -&gt; 存储（数据库、NoSQL）-&gt; 可视化</p>
<p>开源实时日志分析ELK平台</p>
<p>Logstash收集日志，并存放到ElasticSearch集群中，Kibana则从ES集群中查询数据生成图表，返回浏览器端</p>
<h4 id="分析的前提"><a href="#分析的前提" class="headerlink" title="分析的前提"></a>分析的前提</h4><h5 id="半结构化数据"><a href="#半结构化数据" class="headerlink" title="半结构化数据"></a>半结构化数据</h5><p>日志是半结构化数据，是有组织的，有格式的数据。可以分割成行和列，就可以当做表理解和处理了，当然也可以分析里面的数据。</p>
<h5 id="文本分析"><a href="#文本分析" class="headerlink" title="文本分析"></a>文本分析</h5><p>日志是文本文件，需要依赖文件IO、字符串操作、正则表达式等技术。</p>
<p>通过这些技术就能够把日志中需要的数据提取出来。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">182.60.21.153 - - [19/Feb/2013:10:23:29 +0800] "GET /o2o/media.html?menu=3 HTTP/1.1" 200 16691 "-" "Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)"</span><br></pre></td></tr></table></figure>
<p>这是最常见的日志，nginx、tomcat等WEB Server都会产生这样的日志。如何提取出数据？这里面每一段有效的数据对后期的分析都是必须的。</p>
<h5 id="提取数据"><a href="#提取数据" class="headerlink" title="提取数据"></a>提取数据</h5><p>一、空格分割</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'xxx.log'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> line.split():</span><br><span class="line">            print(field)</span><br></pre></td></tr></table></figure>
<p>缺点：</p>
<p>数据并没有按照业务分割好，比如时间就被分开了，URL相关的也被分开了，User Agent的空格最多，被分割了。所以，定义的时候不选用这种在filed中出现的字符就可以省很多事，例如使用’\x01’这个不可见的ASCII，<code>print(&#39;\x01&#39;)</code>试一试</p>
<p>能否依旧是空格分割，但是遇到双引号、中括号特殊处理一下？</p>
<p>思路：</p>
<p>先按照空格切分，然后一个个字符迭代，但如果发现是[或者”，则就不判断是否空格，直到]或者”结尾，这个区间获取的就是时间等数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">line = <span class="string">'''182.60.21.153 - - [19/Feb/2013:10:23:29 +0800] \</span></span><br><span class="line"><span class="string">"GET /o2o/media.html?menu=3 HTTP/1.1" 200 16691 "-" \</span></span><br><span class="line"><span class="string">"Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)"'''</span></span><br><span class="line"></span><br><span class="line">CHARS = set(<span class="string">" \t"</span>)  <span class="comment"># 定义CHARS为空格或\t，这是分隔符</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makekey</span><span class="params">(line:str)</span>:</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    skip = <span class="keyword">False</span></span><br><span class="line"><span class="comment"># 用判断是否有中括号或双引号，再判断是否有空格或\t，</span></span><br><span class="line">    <span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(line):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> skip <span class="keyword">and</span> c <span class="keyword">in</span> <span class="string">'"['</span>: <span class="comment"># [ 或第一个引号</span></span><br><span class="line"><span class="comment"># 如果skip是False并且c是前一个双引号或左中括号</span></span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line"><span class="comment"># 这里记录的是双引号或中括号中内容的起始索引值</span></span><br><span class="line">            skip = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> skip <span class="keyword">and</span> c <span class="keyword">in</span> <span class="string">'"]'</span>: <span class="comment"># 第二个引号或]</span></span><br><span class="line">            skip = <span class="keyword">False</span></span><br><span class="line">            <span class="keyword">yield</span> line[start:i]</span><br><span class="line"><span class="comment"># i这时就是双引号或中括号中内容的结束索引值，这里就是取双引号或中括号中的内容</span></span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line"><span class="comment"># 再修正start的下一个起始位置</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"><span class="comment"># 如果中括号或双引号都匹配过了，这里就跳出本轮循环。</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> skip: <span class="comment"># 如果遇到[或第一个引号就跳过</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"><span class="comment"># 如果skip是True这里就跳出本轮循环，什么条件下会出现这种情况？是否是匹配了左侧中括号或左双引号后，还没有匹配</span></span><br><span class="line"><span class="comment"># 右中括号或右双引号时，就会执行到这里？进入这里判断时，skip是True，而c又是左双引号或左中括号时，也就是上面</span></span><br><span class="line"><span class="comment"># 的判断中满足第一个条件就会到这里，所以这时要跳出本轮循环。也就是匹配了左括号，要跳出本轮循环，因为上面没有跳</span></span><br><span class="line"><span class="comment"># 出的设置，所以这里通过对skip的判断跳出本轮循环。如：[19/Feb/2013:10:23:29 +0800]这样的值，在上面就会</span></span><br><span class="line"><span class="comment"># 被判断出来，最后按一个元素返回。</span></span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> CHARS:</span><br><span class="line"><span class="comment"># 不是中括号或双引号的内容会到这里判断，如果不是空格或\t就会进入下一次循环，看下一个c是否是空格或\t</span></span><br><span class="line">            <span class="keyword">if</span> start == i:   </span><br><span class="line"><span class="comment"># start的值与i的值从开始就是一致的</span></span><br><span class="line">                start = i + <span class="number">1</span></span><br><span class="line"><span class="comment"># 修正start的值和下一次的i值一样大，并进入下一轮循环 </span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"><span class="comment"># 这个判断是为了去除单独的空白元素的，如果不加这个判断，会返回下面的结果，可以看到有''也是一个元素</span></span><br><span class="line"><span class="comment">#['182.60.21.153', '-', '-', '19/Feb/2013:10:23:29 +0800', '', 'GET /o2o/media.html?menu=3 HTTP/1.1', '', '200', '16691', '-', '', 'Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)']</span></span><br><span class="line"><span class="comment"># 加入这个判断后，就不会有''这样的元素了。因为i的值起码要比start大1，这样才说明匹配到了一个非符号的元素值，</span></span><br><span class="line"><span class="comment"># 比如一个字母或数字，如：a 32，如果匹配到a，那么i一定是比start大1的</span></span><br><span class="line">            <span class="keyword">yield</span> line[start:i]</span><br><span class="line"><span class="comment"># 返回从start到i的内容，因为c属于CHARS，说明遇到了空白。上面start == i是第一次遇到空白，这里是再次遇到空</span></span><br><span class="line"><span class="comment"># 白，两次中间就是我们要取的字符串部分</span></span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> start &lt; len(line):</span><br><span class="line">            <span class="keyword">yield</span> line[start:]</span><br><span class="line"><span class="comment"># 当上面的循环结束后，如果start比字符串的总长度小，说明还没有到字符串的结尾，还有没取完的元素，所以就把start到结尾的值取出             </span></span><br><span class="line">print(list(makekey(line)))</span><br></pre></td></tr></table></figure>
<h5 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h5><p>fields中的数据是有类型的，例如时间、状态码等。对不同的field要做不同的类型转换，甚至是自定义的转换</p>
<p><strong>时间转换</strong></p>
<p>19/Feb/2013:10:23:29 +0800   对应格式是</p>
<p>%d/%b/%Y:%H:%M:%S %z</p>
<p>使用的函数是datetime类的strptime方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_time</span><span class="params">(timestr)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>)</span><br></pre></td></tr></table></figure>
<p>上面的代码可以转换为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lambda</span> timestr:datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>)</span><br></pre></td></tr></table></figure>
<p><strong>状态码和字节数</strong></p>
<p>都是整型，使用int函数转换</p>
<h5 id="请求信息的解析"><a href="#请求信息的解析" class="headerlink" title="请求信息的解析"></a>请求信息的解析</h5><p>GET /o2o/media.html?menu=3 HTTP/1.1</p>
<p>method url protocol 三部分都非常重要</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_request</span><span class="params">(request:str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> dict(zip([<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>],request.split()))</span><br></pre></td></tr></table></figure>
<p>上面的代码可以转换为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lambda</span> request:dict(zip([<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>],request.split()))</span><br></pre></td></tr></table></figure>
<h5 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h5><p>对每一个字段命名，然后与值和类型转换的方法对应。解析每一行是有顺序的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">line = <span class="string">'''182.60.21.153 - - [19/Feb/2013:10:23:29 +0800] \</span></span><br><span class="line"><span class="string">"GET /o2o/media.html?menu=3 HTTP/1.1" 200 16691 "-" \</span></span><br><span class="line"><span class="string">"Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)"'''</span></span><br><span class="line"></span><br><span class="line">CHARS = set(<span class="string">" \t"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makekey</span><span class="params">(line:str)</span>:</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    skip = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(line):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> skip <span class="keyword">and</span> c <span class="keyword">in</span> <span class="string">'"['</span>:</span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line">            skip = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> skip <span class="keyword">and</span> c <span class="keyword">in</span> <span class="string">'"]'</span>:</span><br><span class="line">            skip = <span class="keyword">False</span></span><br><span class="line">            <span class="keyword">yield</span> line[start:i]</span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> skip:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> CHARS:</span><br><span class="line">            <span class="keyword">if</span> start == i:</span><br><span class="line">                start = i + <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">yield</span> line[start:i]</span><br><span class="line">            start = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> start &lt; len(line):</span><br><span class="line">            <span class="keyword">yield</span> line[start:]</span><br><span class="line">            </span><br><span class="line">names = (<span class="string">'remote'</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">'datetime'</span>,<span class="string">'request'</span>,<span class="string">'status'</span>,<span class="string">'length'</span>,<span class="string">''</span>,<span class="string">'useragent'</span>)</span><br><span class="line"></span><br><span class="line">ops = (<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">lambda</span> timestr:datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">      <span class="keyword">lambda</span> request: dict(zip([<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>],request.split())),</span><br><span class="line">      int,int,<span class="keyword">None</span>,<span class="keyword">None</span></span><br><span class="line">      )</span><br><span class="line"><span class="comment"># zip()函数先将列表与后面的字符串组合成元组，再用dict()将其转换为字典</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(line:str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> dict(map(<span class="keyword">lambda</span> item: (item[<span class="number">0</span>], item[<span class="number">2</span>](item[<span class="number">1</span>]) <span class="keyword">if</span> item[<span class="number">2</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">else</span> item[<span class="number">1</span>]),zip(names, makekey(line),ops)))</span><br><span class="line"><span class="comment"># map()函数会用其前面的函数参数处理其后面的数据参数，这里是用lambda函数处理后而把zip函数生成的数据。</span></span><br><span class="line"><span class="comment"># 这里zip()函数是将三个变量中对应位置的值组合在一起，如第一个值是('remote', '182.60.21.153', None)。</span></span><br><span class="line"><span class="comment"># lambda定义了匿名函数，如果传入的元素的第三个值不是None，就返回item[0], item[2](item[1])，这里</span></span><br><span class="line"><span class="comment"># item[2]实际是ops中设置的函数，item[2](item[1])就是用指定的函数再处理一次item[1]的数据。否则返回</span></span><br><span class="line"><span class="comment"># item[1]，item指的就是后面的zip生成的数据。这里的意思就是如果item[2]是None，返回的是item[0],item[2]</span></span><br><span class="line"><span class="comment"># (item[1])，否则返回item[0],item[1]。之后用map函数返回一个元组，map()函数可以根据提供的函数对指定的序</span></span><br><span class="line"><span class="comment"># 列做映射。最后用dict函数将元组变成字典。这里的方法就是使用map、zip、dict等函数将值都组合成字典</span></span><br><span class="line"></span><br><span class="line">print(extract(line))</span><br></pre></td></tr></table></figure>
<p>二、正则表达式提取</p>
<p>构造一个正则表达式提取需要的字段，改造extrace函数、names和ops</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">names = (<span class="string">'remote'</span>,<span class="string">'datetime'</span>,<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>,<span class="string">'status'</span>,<span class="string">'length'</span>,<span class="string">'useragent'</span>)</span><br><span class="line"></span><br><span class="line">ops = (<span class="keyword">None</span>, <span class="keyword">lambda</span> timestr: datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">      <span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,int,int,<span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">pattern = <span class="string">'''([\d.]&#123;7,&#125;) - - \[([/\w +:]+)\] "(\w+) (\S+) ([\w/\d.]+)" (\d+) (\d+) .+ "(.+)"'''</span></span><br></pre></td></tr></table></figure>
<p>能够使用命名分组</p>
<p>进一步改造pattern为命名分组，ops也就可以和名词对应了，names就没有必要存在了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>: <span class="keyword">lambda</span> timestr: datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int,</span><br><span class="line">    <span class="string">'length'</span>:int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pattern = <span class="string">'''(?P&lt;remote&gt;[\d.]&#123;7,&#125;) - - \[(?P&lt;datetime&gt;[/\w +:]+)\] \</span></span><br><span class="line"><span class="string">"(?P&lt;method&gt;\w+) (?P&lt;url&gt;\S+) (?P&lt;protocol&gt;[\w/\d.]+)" \</span></span><br><span class="line"><span class="string">(?P&lt;status&gt;\d+) (?P&lt;length&gt;\d+) .+ "(?P&lt;useragent&gt;.+)"'''</span></span><br></pre></td></tr></table></figure>
<p>改造后的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">line = <span class="string">'''182.60.21.153 - - [19/Feb/2013:10:23:29 +0800] \</span></span><br><span class="line"><span class="string">"GET /o2o/media.html?menu=3 HTTP/1.1" 200 16691 "-" </span></span><br><span class="line"><span class="string">"Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)"'''</span></span><br><span class="line"></span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>: <span class="keyword">lambda</span> timestr: datetime.datetime.strptime(timestr, <span class="string">'%d/%b/%Y:%H:%M:%S %z'</span>),</span><br><span class="line">    <span class="string">'status'</span>:int,</span><br><span class="line">    <span class="string">'length'</span>:int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pattern = <span class="string">'''(?P&lt;remote&gt;[\d.]&#123;7,&#125;) - - \[(?P&lt;datetime&gt;[/\w +:]+)\] \</span></span><br><span class="line"><span class="string">"(?P&lt;method&gt;\w+) (?P&lt;url&gt;\S+) (?P&lt;protocol&gt;[\w/\d.]+)" \</span></span><br><span class="line"><span class="string">(?P&lt;status&gt;\d+) (?P&lt;length&gt;\d+) .+ "(?P&lt;useragent&gt;.+)"'''</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(pattern)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(line:str)</span> -&gt; dict:</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">return</span> &#123;k:ops.get(k, <span class="keyword">lambda</span> x:x)(v) <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line"></span><br><span class="line">print(extract(line))</span><br></pre></td></tr></table></figure>
<h5 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h5><p>日志中不免会出现一些不匹配的行，需要处理。</p>
<p>这里使用re.match方法，有可能匹配不上。所以要增加一个判断</p>
<p>采用抛出异常的方式，让调用者获得异常并自行处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(logline:str)</span> -&gt; dict:</span></span><br><span class="line">    <span class="string">"""返回字段的字典，抛出异常说明匹配失败"""</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">if</span> matcher:</span><br><span class="line">        <span class="keyword">return</span> &#123;k:ops.get(k, <span class="keyword">lambda</span> x:x)(v) <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'No match'</span>)</span><br></pre></td></tr></table></figure>
<p>但是，也可以采用返回一个特殊值的方式，告知调用者没有匹配。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(logline:str)</span> -&gt; dict:</span></span><br><span class="line">    <span class="string">"""返回字段的字典，如果返回None说明匹配失败"""</span></span><br><span class="line">    matcher = regex.match(line)</span><br><span class="line">    <span class="keyword">if</span> matcher:</span><br><span class="line">        <span class="keyword">return</span> &#123;k:ops.get(k, <span class="keyword">lambda</span> x:x)(v) <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p>通过返回值，在函数外部获取了None，同样也可以采取一些措施。本次采用返回None的实现。</p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 137课开始讲日志分析的项目</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="comment"># 使用dict时，如果引用的Key不存在，就会抛出KeyError。如果希望key不存在时，返回一个默认值，就可以用defaultdict</span></span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">logline = <span class="string">'''182.60.21.153 - - [19/Feb/2013:10:23:29 +0800] \</span></span><br><span class="line"><span class="string">"GET /o2o/media.html?menu=3 HTTP/1.1" 200 16691 "-" \</span></span><br><span class="line"><span class="string">"Mozilla/5.0 (compatible; EasouSpider; +http://www.easou.com/search/spider.html)"'''</span></span><br><span class="line"></span><br><span class="line">pattern = <span class="string">'''(?P&lt;remote&gt;[\d\.]&#123;7,&#125;) - - \[(?P&lt;datetime&gt;[^\[\]]+)\] "(?P&lt;request&gt;[^"]+)" (?P&lt;status&gt;\d+) (?P&lt;size&gt;\d+) "[^"]+" "(?P&lt;useragent&gt;[^"]+)"'''</span></span><br><span class="line">regex = re.compile(pattern)</span><br><span class="line"><span class="comment"># 这两行代码因为编译一次就可以了  ，所以放在外面了</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(line)</span>:</span></span><br><span class="line">    matcher = regex.match(line)  <span class="comment"># 因为只处理一行，所以用match就可以。这一行里不会有重复</span></span><br><span class="line"><span class="comment"># 如果pattern没法与logline一一对应，那么这里会返回None，下面也没法使用groupdict()，会提</span></span><br><span class="line"><span class="comment"># 示："AttributeError: 'NoneType' object has no attribute 'groupdict'"</span></span><br><span class="line"><span class="comment">#    return matcher.groupdict()</span></span><br><span class="line">	<span class="keyword">if</span> matcher:</span><br><span class="line">		<span class="keyword">return</span> &#123;k:ops.get(k,<span class="keyword">lambda</span> x:x)(v) <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items()&#125;</span><br><span class="line"><span class="comment"># 分组的名称会被当作字典的键名，如remote，datetime等。这里直接返回字典解析式，就不用下面再返回了</span></span><br><span class="line"><span class="comment"># groupdict()是正则表达式的方法，它返回一个字典，包含所有经命名的匹配子群，键值是子群名。也就是将组名与</span></span><br><span class="line"><span class="comment"># 匹配到的内容组成字典。ops中没有的键值这里就直接返回字典中的值，如果是ops中有的键值，就用ops中的键处理</span></span><br><span class="line"><span class="comment"># 一下字典中的值，因为ops中有的键值都是函数。这里的k与ops中的键名是一样的，所以才可以查找相应的key</span></span><br><span class="line"><span class="comment"># 先从pattern中生成处理过一次的日志，再将这些日志用ops中的函数处理一次</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'No match'</span>)   <span class="comment"># 错误处理，如果matcher没有匹配到就返回None</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># def convert_time(timestr):</span></span><br><span class="line"><span class="comment">#     fmtstr = "%d/%b/%Y:%H:%M:%S %z"</span></span><br><span class="line"><span class="comment">#     dt = dtetime.datetime.strptime(timestr, fmtstr)</span></span><br><span class="line"><span class="comment"># 	print(type(dt))</span></span><br><span class="line"><span class="comment">#      return dt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def convert_request(request:str):</span></span><br><span class="line"><span class="comment">#     return dict(zip(('method','url','protocol'),request.split()))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># names = ['remote','','','datetime','request','status','size','','useragent']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ops = [None,None,None,convert_time,convert_request,int,int,None,None]</span></span><br><span class="line"></span><br><span class="line">ops = &#123;</span><br><span class="line">    <span class="string">'datetime'</span>:<span class="keyword">lambda</span> timestr:datetime.datetime.strptime(timestr,<span class="string">"%d/%b/%Y:%H:%M:%S %z"</span>),  </span><br><span class="line">    <span class="comment">#  这一行lambda可以代理上面的convert_time函数</span></span><br><span class="line">    <span class="string">'status'</span>:int,  <span class="comment"># 用int函数处理数据。因为默认是字符串格式 ，所以这里要用int处理一下</span></span><br><span class="line">    <span class="string">'size'</span>:int,   <span class="comment"># 因为默认就是字符串，所以第一个remote就不用处理了</span></span><br><span class="line">    <span class="string">'request'</span>:<span class="keyword">lambda</span> request:dict(zip((<span class="string">'method'</span>,<span class="string">'url'</span>,<span class="string">'protocol'</span>),request.split())),</span><br><span class="line">    <span class="comment"># 这一行lambda可以代替上面的convert_request函数</span></span><br><span class="line">    <span class="string">'useragent'</span>:<span class="keyword">lambda</span> useragent:parse(useragent)  <span class="comment"># 分析浏览器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># d = &#123;&#125;</span></span><br><span class="line"><span class="comment">#for k,v in extract(logline).items():   # k是每个fields的命名</span></span><br><span class="line"><span class="comment">#	d[k] = ops.get(k, lambda x:x)(v)</span></span><br><span class="line">    <span class="comment"># 这里如果可以查询到k的值，就用k值对应的函数处理v；如果没找到k值，就用lambda函数处理v，lambda函</span></span><br><span class="line">    <span class="comment"># 数在这里的意思是给什么就返回什么，也就是直接返回v。lambda的地方不能写成v，因为还要将这个默认值当</span></span><br><span class="line">    <span class="comment"># 函数去处理v，所以如果写成v，就会变成v(v)，这会报错。</span></span><br><span class="line"><span class="comment"># d = &#123;k:ops.get(k,lambda x:x)(v) for k,v in extract(logline).items()&#125;</span></span><br><span class="line"><span class="comment"># 上面的三行代码转换为这一行。让上面的extract函数直接返回这个字典解析式更好些</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openfile</span><span class="params">(path:str)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(str(path)) <span class="keyword">as</span> f:   <span class="comment"># open()方法里需要字符串，要用str()函数转一下</span></span><br><span class="line">		<span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        	d = extract(line)</span><br><span class="line">            <span class="keyword">if</span> d:</span><br><span class="line">            	<span class="keyword">yield</span> d</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># TODO  不合格数据有多少</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面的调用方法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(*path)</span>:</span>   <span class="comment"># 读一批路径。这是一个生成器函数，yield出来的是字典</span></span><br><span class="line">    <span class="string">"""文件装载"""</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> path:</span><br><span class="line">        p = Path(file)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.exists():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> p.is_dir():   <span class="comment"># 这里不递归处理子目录，也可以使用**/*log的方法</span></span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> p.iterdir():</span><br><span class="line">                <span class="keyword">if</span> x.is_file():</span><br><span class="line"><span class="comment">#                    with open(str(p)) as f:   # open()方法里需要字符串，要用str()函数转一下</span></span><br><span class="line"><span class="comment">#                        for line in f:</span></span><br><span class="line"><span class="comment">#                            d = extract(line)</span></span><br><span class="line"><span class="comment">#                            if d:</span></span><br><span class="line"><span class="comment">#                                yield d</span></span><br><span class="line"><span class="comment">#                            else:</span></span><br><span class="line"><span class="comment">#                                # TODO  不合格数据有多少</span></span><br><span class="line"><span class="comment">#                                continue</span></span><br><span class="line"><span class="comment">#					gen = openfile(str(x))</span></span><br><span class="line"><span class="comment">#    				for y in openfile(str(x)):</span></span><br><span class="line"><span class="comment">#            			yield y</span></span><br><span class="line"><span class="comment"># 这里不能使用return y，这样会有一个就扔出去了，我们需要的是攒起来一起处理，攒多少个是window函数的事</span></span><br><span class="line"><span class="comment"># openfile(str(x))不是普通的函数调用，它返回的是一个生成器对象，我们需要使用for循环或next拿，那么需</span></span><br><span class="line"><span class="comment"># 要迭代多少个合适呢，所以用yield，这样load就变成一个生成器函数了。有yield的就是生成器函数，返回的是生</span></span><br><span class="line"><span class="comment"># 成器对象。yield from后面是一个可迭代对象就行</span></span><br><span class="line">					<span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(x))  <span class="comment"># 将上面两行改为一行</span></span><br><span class="line">        <span class="keyword">elif</span> p.is_file():</span><br><span class="line"><span class="comment">#            with open(str(p)) as f:   # open()方法里需要字符串，要用str()函数转一下</span></span><br><span class="line"><span class="comment">#                for line in f:</span></span><br><span class="line"><span class="comment">#                    d = extract(line)</span></span><br><span class="line"><span class="comment">#                    if d:</span></span><br><span class="line"><span class="comment">#                        yield d</span></span><br><span class="line"><span class="comment">#                    else:</span></span><br><span class="line"><span class="comment">#                        # TODO  不合格数据有多少</span></span><br><span class="line"><span class="comment">#                        continue</span></span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">from</span> openfile(str(x))</span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">window</span><span class="params">(src:Queue, handler, width:int, interval:int)</span>:</span>  <span class="comment"># 时间窗口</span></span><br><span class="line">    <span class="comment"># window函数只做移动窗口拿数据的工作，处理在handler函数中做</span></span><br><span class="line">    <span class="comment"># 函数的功能越单一越好。这里的src就是load函数生成的数据，src生成的是字典。load是生成器函数</span></span><br><span class="line"><span class="comment"># current是现在的时间，start是起始时间，width是宽度，表示一次求值的时间窗口宽度，窗口就是下面的</span></span><br><span class="line"><span class="comment"># buffer中的数据，主要是配合interval计算delta，interval是时间间隔，表示间隔多入处理一次数据</span></span><br><span class="line"><span class="comment">#	i = 0</span></span><br><span class="line"><span class="comment">#    for x in src</span></span><br><span class="line"><span class="comment">#		i += 1</span></span><br><span class="line"><span class="comment">#    	print(x)</span></span><br><span class="line"><span class="comment">#        if i &gt; 10:</span></span><br><span class="line"><span class="comment">#            break</span></span><br><span class="line">	start = datetime.datetime.strptime(<span class="string">'1970/01/01 01:01:01 +0800'</span>, <span class="string">'%Y/%m/%d %H:%M:%S %z'</span>)</span><br><span class="line">    current = datetime.datetime.strptime(<span class="string">'1970/01/01 01:01:02 +0800'</span>, <span class="string">'%Y/%m/%d %H:%M:%S %z'</span>)</span><br><span class="line">    delta = datetime.timedelta(seconds=width - interval)</span><br><span class="line">    </span><br><span class="line">    buffer = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># for x in src:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = src.get()  </span><br><span class="line"><span class="comment"># 这里传进来的src是一个Queue，src.get()就是从Queue队列中拿数据的方法。如果没有数据就会阻塞等待，等下</span></span><br><span class="line"><span class="comment"># 一个数据过来。所以上面也不能再用for循环了，而使用while True循环。这里拿到的是load生成器函数处理后</span></span><br><span class="line"><span class="comment"># yield出来的字典。</span></span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            buffer.append(data)  </span><br><span class="line"><span class="comment"># 直接把字典放入buffer中，具体的处理工作由handler执行。不要把加入buffer中的值写死，那样的适用性会很差</span></span><br><span class="line">            current = data[<span class="string">'datetime'</span>]   <span class="comment"># 当前时间应该是日志中的时间</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (current - start).total_seconds() &gt;= interval:</span><br><span class="line">            ret = handler(buffer)</span><br><span class="line">            print(ret)</span><br><span class="line">            </span><br><span class="line">            start = current   <span class="comment"># 调整开始时间</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># buffer 的处理</span></span><br><span class="line">            <span class="comment"># tmp = []</span></span><br><span class="line">            <span class="comment"># for i in buffer:</span></span><br><span class="line">            <span class="comment">#     if i['datetime'] &gt; current - delta: </span></span><br><span class="line"><span class="comment"># 用拿到的时间与current减delta的时间比较，这就是有数据重叠的部分，现在的时间减去delta后的位置就成了处理过的数据要保留部分的起始位置，大于这个位置的数据都要保留，其他的就不要了。可以比对时间窗口的图查看</span></span><br><span class="line">            <span class="comment">#        tmp.append(i)</span></span><br><span class="line">            buffer = [i <span class="keyword">for</span> i <span class="keyword">in</span> buffer <span class="keyword">if</span> i[<span class="string">'datetime'</span>] &gt; current - delta]</span><br><span class="line">            <span class="comment"># 留下的数据形成了一个窗口，这是一个新建的buffer，和上面的buffer没关系</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">donothing_handler</span><span class="params">(iterable:list)</span>:</span>  <span class="comment"># 打印一下，不做其他</span></span><br><span class="line">    print(iterable)</span><br><span class="line">    <span class="keyword">return</span> iterable</span><br><span class="line"></span><br><span class="line"><span class="comment"># 状态码分析</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">status_handler</span><span class="params">(iterable:list)</span>:</span></span><br><span class="line">    d = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        key = item[<span class="string">'status'</span>]</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> d.keys():</span><br><span class="line">            d[key] = <span class="number">0</span></span><br><span class="line">        d[key] += <span class="number">1</span></span><br><span class="line">    total = sum(d.values())</span><br><span class="line">    <span class="comment"># print(d,'!!!')   # 这是字典</span></span><br><span class="line">    <span class="comment"># print(total,'@@@')   # 这是字典键值的和</span></span><br><span class="line">    <span class="comment"># &#123;200: 46, 500: 1&#125; !!!</span></span><br><span class="line">    <span class="comment"># 47 @ @ @</span></span><br><span class="line">    <span class="comment"># &#123;200: 97.87234042553192, 500: 2.127659574468085&#125;</span></span><br><span class="line">    <span class="comment"># &#123;200: 3, 301: 1&#125; !!!</span></span><br><span class="line">    <span class="comment"># 4 @ @ @</span></span><br><span class="line">    <span class="comment"># &#123;200: 75.0, 301: 25.0&#125;</span></span><br><span class="line">    <span class="comment"># &#123;200: 1&#125; !!!</span></span><br><span class="line">    <span class="comment"># 1 @ @ @</span></span><br><span class="line">    <span class="comment"># &#123;200: 100.0&#125;</span></span><br><span class="line"><span class="comment"># 可以计算字典中键值的和，下面再用键值除以键值的和再乘以100就是占比了</span></span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> &#123;k:v/total*<span class="number">100</span> <span class="keyword">for</span> k,v <span class="keyword">in</span> d.items()&#125;</span><br><span class="line"><span class="comment"># 乘以100是为了计算百分比</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器分析</span></span><br><span class="line">ua_dict = defaultdict(<span class="keyword">lambda</span> :<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 这一句从browser_handler函数中移到这里后，会记录所有处理后的结果，如果在browser_handler内，就只会记录一段处理的数据，之后会被重置</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">browser_handler</span><span class="params">(iterable:list)</span>:</span></span><br><span class="line"><span class="comment">#     ua_dict = defaultdict(lambda :0)</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">        ua = item[<span class="string">'useragent'</span>]</span><br><span class="line">        <span class="comment"># ua = parse('')</span></span><br><span class="line">    	key = (ua.browser.family, ua.browser.version_string)   </span><br><span class="line">        <span class="comment"># 字典的key应该可hash，但ua.browser是不可hash的，family和version_string都是字符串</span></span><br><span class="line">        ua_dict[key] += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> ua_dict</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="comment"># def handler(iterable:list):</span></span><br><span class="line"><span class="comment">#     # TODO</span></span><br><span class="line"><span class="comment">#     return sum(iterable) // len(iterable)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def size_handler(iterable:list):</span></span><br><span class="line"><span class="comment">#     # TODO</span></span><br><span class="line"><span class="comment">#     pass</span></span><br><span class="line"><span class="comment"># handler是处理数据的，从外面传入，window函数只返回基本的数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># window(load('test.log'),donothing_handler,10,5)  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">(src)</span>:</span>   <span class="comment"># src是load函数生成的数据</span></span><br><span class="line">    <span class="comment"># 队列列表</span></span><br><span class="line">    queues = []   <span class="comment"># 这是容器，将结果保存下来</span></span><br><span class="line">    threads = []</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(handler, width, interval)</span>:</span>  <span class="comment"># 注册的是变化的东西，注册的过程就是传参的过程</span></span><br><span class="line">        q = Queue()   <span class="comment"># 每个线程各自用自己的queue</span></span><br><span class="line">        queues.append(q)   <span class="comment"># 注册一次就保存一个q到queues中</span></span><br><span class="line">        <span class="comment"># 注册就分配一个邮箱，为了能调用，把q放到一个队列列表中，不然，q用完就没了</span></span><br><span class="line">        <span class="comment"># window(q, handler, width, interval)</span></span><br><span class="line">        t = threading.Thread(target=window, args=(q, handler, width, interval))</span><br><span class="line"><span class="comment"># 这里是一个调用window函数的过程，每个window函数都应该有自己的q，q就是自定义的队列。因为q执行完会消失，所以在外面创建了queues队列保存q，queues列表中每个元素都是q队列，这个列表就是为了在下面的run函数中迭代用，在run函数中相当于把一份数据x给所有列表中的q一份，这样一份数据就变成了多份数据</span></span><br><span class="line">        threads.append(t)</span><br><span class="line">        <span class="comment"># 因为window函数会阻塞住，所以把它做到一个线程里去</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">            t.start()   <span class="comment"># 这里启动线程，上面的reg只是注册</span></span><br><span class="line">    </span><br><span class="line">    	<span class="keyword">for</span> x <span class="keyword">in</span> src:</span><br><span class="line"><span class="comment"># 这里的x就是load生成器函数yield出来的字典，把x这个字典放到q队列中</span></span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> queues:   <span class="comment"># 给副本，</span></span><br><span class="line">                q.put(x)   <span class="comment"># 给每个q里都送一个x</span></span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> reg,run</span><br><span class="line"></span><br><span class="line">reg,run = dispatcher(load(<span class="string">'test.log'</span>))  <span class="comment"># 从这里传参</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># reg注册窗口</span></span><br><span class="line">reg(donothing_handler, <span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line">reg(status_handler, <span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line">reg(browser_handler, <span class="number">5</span>, <span class="number">5</span>)   <span class="comment"># 这个窗口数据不需要重叠，所以用了两个一样的数字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">run()</span><br><span class="line">===============================================================================</span><br><span class="line"><span class="comment"># 定义了上面的extract函数后，下面的代码就没有用了</span></span><br><span class="line">fields = []</span><br><span class="line">flag = <span class="keyword">False</span></span><br><span class="line">tmp = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(fields[10:])</span></span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> logline.split():</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> flag: </span><br><span class="line">    	<span class="keyword">if</span> (word.startswith(<span class="string">'['</span>) <span class="keyword">or</span> word.startswith(<span class="string">'"'</span>)):  <span class="comment"># 以[或"开头</span></span><br><span class="line">        	tmp = word[<span class="number">1</span>:]</span><br><span class="line">        	<span class="keyword">if</span> word.endswith(<span class="string">']'</span>) <span class="keyword">or</span> word.endswith(<span class="string">'"'</span>):</span><br><span class="line">                tmp = word.strip(<span class="string">'[]"'</span>)</span><br><span class="line">                fields.append(tmp)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">        		flag = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">             fields.append(word)  </span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        <span class="keyword">if</span> word.endswith(<span class="string">']'</span>) <span class="keyword">or</span> word.endswith(<span class="string">'"'</span>):</span><br><span class="line">            tmp += <span class="string">" "</span> + word[:<span class="number">-1</span>]  <span class="comment"># word.strip[']"']</span></span><br><span class="line">            fields.append(tmp) </span><br><span class="line">            </span><br><span class="line">            tmp = <span class="string">""</span></span><br><span class="line">            flag = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tmp += <span class="string">" "</span> + word</span><br><span class="line">        <span class="keyword">continue</span> </span><br><span class="line">    <span class="comment"># lst.append(word)   # 如何处理[]与"。上面两个条件都用了continue，所以这句没有用了</span></span><br><span class="line">print(fields)</span><br><span class="line">d = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i,field <span class="keyword">in</span> enumerate(fields):</span><br><span class="line">    key = names[i]</span><br><span class="line">    print(ops[i])</span><br><span class="line">    <span class="keyword">if</span> ops[i]:   <span class="comment"># 如果ops[i]不是None</span></span><br><span class="line">        d[key] = ops[i](field)   </span><br><span class="line"><span class="comment">#  当ops[i]是convert_time时，将field传入convert_time函数进行处理。convert_time是我们上面自定义的函数</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">    	d[key] = field   <span class="comment"># 如果是None的情况</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/06/python基础学习-正则表达式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/python基础学习-正则表达式/" itemprop="url">
                  python基础学习-正则表达式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-02-06 10:28:22" itemprop="dateCreated datePublished" datetime="2020-02-06T10:28:22+08:00">2020-02-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-11-06 14:15:43" itemprop="dateModified" datetime="2020-11-06T14:15:43+08:00">2020-11-06</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="正则表达式-重要"><a href="#正则表达式-重要" class="headerlink" title="正则表达式(重要)"></a><strong>正则表达式(重要)</strong></h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>正则表达式，Regular Expression，缩写为regex、regexp、RE等。正则表达式是文本处理极为重要的技术，用它可以对字符串按照某种规则进行检索、替换。</p>
<p>1970年代，Unix之父Ken Thompson将正则表达式引入到Unix中文本编辑器ed和grep命令中，由此正则表达式普及开来。</p>
<p>1980年后，perl语言对Henry Spencer编写的库，扩展了很多新的特性。1997年开始，Philip Hazel开发出了PCRE(Perl Compatible Regular Expressions)，它被PHP和HTTPD等工具采用。</p>
<p>正则表达式应用极其广泛，shell中处理文本的命令、各种高级编程语言都支持正则表达式。</p>
<p>参考：<a href="https://www.w3cschool.cn/regex_rmjc/" target="_blank" rel="noopener">https://www.w3cschool.cn/regex_rmjc/</a></p>
<h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><ol>
<li>BRE</li>
</ol>
<p>基本正则表达式，grep、sed、vi等软件支持。vim有扩展。</p>
<ol start="2">
<li>ERE</li>
</ol>
<p>扩展正则表达式，egrep (grep -E)、sed -r等</p>
<ol start="3">
<li>PCRE</li>
</ol>
<p>几乎所有高级语言都是PCRE的方言或者变种。Python从1.6开始使用SRE正则表达式引擎，可以认为是PCRE的子集，见模块re。</p>
<h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><h4 id="元字符-metacharacter"><a href="#元字符-metacharacter" class="headerlink" title="元字符 metacharacter"></a>元字符 metacharacter</h4><table>
<thead>
<tr>
<th>代码</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>.</td>
<td>匹配除换行符外任意一个字符</td>
<td>.</td>
</tr>
<tr>
<td>[abc]</td>
<td>字符集合，只能表示一个字符位置。匹配所包含的任意一个字符</td>
<td>[abc]匹配plain中的’a’</td>
</tr>
<tr>
<td>[^abc]</td>
<td>字符集合，只能表示一个字符位置。匹配除云集合内字符的任意一个字符</td>
<td>[^abc]可以匹配plain中的’p’、’l’、’i’或者’n’</td>
</tr>
<tr>
<td>[a-z]</td>
<td>字符范围，也是个集合，表示一个字符位置。匹配所包含的任意一个字符</td>
<td>常用<code>[A-Z][0-9]</code>，不能使用[0-255]这样的方法，因为只能匹配一个字符，所以只能用[0-9]匹配1位数字</td>
</tr>
<tr>
<td>[^a-z]</td>
<td>字符范围，也是个集合，表示一个字符位置。匹配除去集合内字符的任意一个字符</td>
<td></td>
</tr>
<tr>
<td>\b</td>
<td>匹配单词的边界</td>
<td>\bb在文本中找到单词中b开头的b字符</td>
</tr>
<tr>
<td>\B</td>
<td>不匹配单词的边界</td>
<td>t\B包含t的单词但是不以t结尾的t字符，例如 write；\Bb不以b开头的含有b的单词，例如 able</td>
</tr>
<tr>
<td>\d</td>
<td>[0-9]匹配1位数字</td>
<td>一定要注意这一点，是0-9只匹配1位数字，如125，那么\d只能匹配1位数字，要匹配125就要用\d\d\d或\d{3}</td>
</tr>
<tr>
<td>\D</td>
<td><code>[^0-9]</code>匹配1位非数字</td>
<td></td>
</tr>
<tr>
<td>\s</td>
<td>匹配1位空白字符，包括换行符、制表符、空格。如：[\f\r\n\t\v]</td>
<td></td>
</tr>
<tr>
<td>\S</td>
<td>匹配1位非空白字符</td>
<td></td>
</tr>
<tr>
<td>\w</td>
<td>匹配[a-zA-Z0-9]，包括中文的字</td>
<td>\w</td>
</tr>
<tr>
<td>\W</td>
<td>匹配\w之外的字符</td>
</tr>
</tbody>
</table>
<h4 id="转义"><a href="#转义" class="headerlink" title="转义"></a>转义</h4><p>凡是在正则表达式中有特殊意义的符号，如果想使用它的本意，请使用<code>\</code>转义。反斜杠自身，得使用<code>\\</code>。</p>
<p>\r、\n还是转义后代表回车、换行</p>
<h4 id="重复"><a href="#重复" class="headerlink" title="重复"></a>重复</h4><table>
<thead>
<tr>
<th>代码</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>*</td>
<td>表示前面的正则表达式会重复0次或多次</td>
<td>e\w*单词中e后面可以有非空白字符</td>
</tr>
<tr>
<td>+</td>
<td>表示前面的正则表达式重复至少1次</td>
<td>e\w+单词中e后面至少有一个非空白字符</td>
</tr>
<tr>
<td>?</td>
<td>表示前面的正则表达式会重复0次或1次</td>
<td>e\w?单词中e后面至多有一个非空白字符</td>
</tr>
<tr>
<td>{n}</td>
<td>重复固定的n次</td>
<td>e\w{1}单词中e后面只能有一个非空白字符</td>
</tr>
<tr>
<td>{n,}</td>
<td>重复至少n次</td>
<td>e\w{1,}等价e\w+；e\w{0,}等价e\w*；e\w{0,1} 等价e\w?</td>
</tr>
<tr>
<td>{n,m}</td>
<td>重复n到m次</td>
<td>e\w{1,10} 单词中e后面至少1个，至多10个非空白字符</td>
</tr>
</tbody>
</table>
<h4 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h4><ol>
<li>匹配手机号码</li>
</ol>
<p>字符串为”手机号码13851888188”</p>
<p>答案：\d{11}</p>
<ol start="2">
<li>匹配中国座机</li>
</ol>
<p>字符串为”号码025-83105736、0543-5464432”</p>
<p>答案：\d{3,4}-\d{7,8}</p>
<table>
<thead>
<tr>
<th style="text-align:left">代码</th>
<th style="text-align:left">说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">x&#124;y</td>
<td style="text-align:left">匹配x或者y</td>
<td>wood took foot food使用w&#124;food或者(w&#124;f)ood</td>
</tr>
<tr>
<td style="text-align:left">捕获</td>
<td style="text-align:left"></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">(pattern)</td>
<td style="text-align:left">使用小括号指定一个子表达式，也叫分组。捕获后会自动分配组号从1开始可以改变优先级。匹配 pattern 并捕获该匹配的子表达式。可以使用 $0…$9 属性从结果“匹配”集合中检索捕获的匹配。若要匹配括号字符 ( )，请使用<code>“\(”</code>或者<code>“\)”</code>。<strong>这里所说的捕获指的是之后方便引用</strong></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">\数字</td>
<td style="text-align:left">匹配对应的分组</td>
<td>(very)\1匹配very very，但捕获的组group是very</td>
</tr>
<tr>
<td style="text-align:left">(?:pattern)</td>
<td style="text-align:left">如果仅仅为了改变优先级，就不需要捕获分组。匹配 pattern 但不获取匹配结果，也就是说这是一个非获取匹配，不进行存储供以后使用。这对于用“或”字符 (&#124;) 组合模式部件的情况很有用。例如，与“industry&#124;industries”相比，“industr(?:y&#124;ies)”是一个更加经济的表达式。<strong>在括号分组中需要选择且无需捕获时使用，这时不能用×&#124;×的方式，因为它只能是管道符两侧的值。</strong></td>
<td>(?:w&#124;f)ood，industr(?:y&#124;ies)等价industry&#124;industries</td>
</tr>
<tr>
<td style="text-align:left"><code>(?&lt;name&gt;exp)(?&#39;name&#39;exp)</code></td>
<td style="text-align:left">分组捕获，但是可以通过name访问分组。Python语法必须是<code>(?P&lt;name&gt;exp)</code></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">零宽断言</td>
<td style="text-align:left"></td>
<td>wood took foot food</td>
</tr>
<tr>
<td style="text-align:left">(?=exp)</td>
<td style="text-align:left">零宽度正预测先行断言，断言exp一定在匹配的右边出现，也就是说断言后面一定跟个exp。断言并不会被匹配</td>
<td>f(?=oo) f后面一定有oo出现</td>
</tr>
<tr>
<td style="text-align:left">(?&lt;=exp)</td>
<td style="text-align:left">零宽度正回顾后发断言，断言exp一定出现在匹配的左边出现，也就是说前面一定有个exp前缀</td>
<td>(?&lt;=f)ood、(?&lt;=t)ook分别匹配ood、ook，ook前面一定有t出现</td>
</tr>
<tr>
<td style="text-align:left">负向零宽断言</td>
<td style="text-align:left"></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">(?!exp)</td>
<td style="text-align:left">零宽度负预测先行断言，断言exp一定不会出现在右侧，也就是说断言后面一定不是exp</td>
<td>\d{3}(?!\d)匹配3位数字，断言3位数字后面一定不能是数字。foo(?!d)，foo后面一定不是d</td>
</tr>
<tr>
<td style="text-align:left">(?&lt;!exp)</td>
<td style="text-align:left">零宽度负回顾后发断言，断言exp一定不能出现在左侧，也就是说断言前面一定不能是exp</td>
<td>(?&lt;!f)ood，ood的左边一定不是f</td>
</tr>
<tr>
<td style="text-align:left">注释</td>
<td style="text-align:left"></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">(?#comment)</td>
<td style="text-align:left">注释</td>
<td>f(?=oo)(?#这个后断言不捕获)</td>
</tr>
</tbody>
</table>
<p>注意：</p>
<p>断言会不会捕获呢？也就是断言占不占分组号呢？</p>
<p>断言不占分组号。断言如同条件，只是要求匹配必须满足断言的条件。</p>
<p>分组和捕获是同一个意思</p>
<p>使用正则表达式时，能用简单表达式，就不要复杂的表达式</p>
<h4 id="贪婪与非贪婪"><a href="#贪婪与非贪婪" class="headerlink" title="贪婪与非贪婪"></a>贪婪与非贪婪</h4><p>默认是贪婪模式，也就是说尽量多匹配更长的字符串。</p>
<p>非贪婪很简单，在重复的符号后面加上一个?问号，就尽量的少匹配了。</p>
<table>
<thead>
<tr>
<th>代码</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>*?</td>
<td>匹配任意次，但尽量能少重复</td>
<td></td>
</tr>
<tr>
<td>+?</td>
<td>匹配至少1次，但尽可能少重复</td>
<td></td>
</tr>
<tr>
<td>??</td>
<td>匹配0次或1次，但尽可能少重复</td>
<td></td>
</tr>
<tr>
<td>{n,}?</td>
<td>匹配至少n次，但尽可能少重复</td>
<td></td>
</tr>
<tr>
<td>{n,m}?</td>
<td>匹配至少n次，至多m次，但尽可能少重复</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例：</span><br><span class="line">very very happy   使用v.*y和v.*?y</span><br></pre></td></tr></table></figure>
<p>引擎选项</p>
<table>
<thead>
<tr>
<th>代码</th>
<th>说明</th>
<th>Python</th>
</tr>
</thead>
<tbody>
<tr>
<td>IgnoreCase</td>
<td>匹配时忽略大小写</td>
<td>re.l、re.IGNORECASE</td>
</tr>
<tr>
<td>Singleline</td>
<td>单行模式，可以匹配所有字符，包括\n</td>
<td>re.S、re.DOTALL</td>
</tr>
<tr>
<td>Multiline</td>
<td>多行模式^行首、$行尾</td>
<td>re.M、re.MULTILINE</td>
</tr>
<tr>
<td>IgnorePatternWhitespace</td>
<td>忽略表达式中的空白字符，如果要使用空白字符用转义，#可以用来做注释</td>
<td>re.X、re.VERBOSE</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">单行模式：</span><br><span class="line">. 可以匹配所有字符，包括换行符</span><br><span class="line">^ 表示整个字符串的开头，$整个字符串的结尾</span><br><span class="line"></span><br><span class="line">多行模式：</span><br><span class="line">. 可以匹配除了换行符之外的字符</span><br><span class="line">^ 表示行首，$行尾</span><br><span class="line">^ 表示整个字符串的开始，$ 表示整个字符串的结尾。开始指的是\n后紧接着下一个字符，结束指的是\n前的字符</span><br><span class="line"></span><br><span class="line">可以认为，单行模式就如同看穿了换行符，所有文本就是一个长长的只有一行的字符串，所有^就是这一行字符串的行首，$就是这一行的行尾。</span><br><span class="line">多行模式，无法穿透换行符，^和$还是行首行尾的意思，只不过限于每一行</span><br><span class="line"></span><br><span class="line">注意：注意字符串中看不见的换行符，\r\n会影响e$的测试，e$只能匹配e\n</span><br><span class="line"></span><br><span class="line">举例</span><br><span class="line">very very happy</span><br><span class="line">harry key</span><br><span class="line"></span><br><span class="line">上面两行happy之后 ，有可能是\r\n结尾</span><br><span class="line"><span class="meta">y$</span><span class="bash">单行匹配key的y，多行匹配 happy和key的y。</span></span><br></pre></td></tr></table></figure>
<h4 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 匹配一个<span class="number">0</span><span class="number">-999</span>之间的任意数字</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">995</span></span><br><span class="line"><span class="number">9999</span></span><br><span class="line"><span class="number">102</span></span><br><span class="line"><span class="number">02</span></span><br><span class="line"><span class="number">003</span></span><br><span class="line"><span class="number">4</span>d</span><br><span class="line"></span><br><span class="line">参考：</span><br><span class="line">\d：<span class="number">1</span>位数</span><br><span class="line">[1-9]?\d：1-2位数</span><br><span class="line">^([1-9]\d\d?|\d)：1-3位数；^表示开头，小括号是分组，[1-9]是1-9中任意一个数字，\d表示一个数九数字，?表示匹配0至1次。|前面指的是数字开头，两到三位数字。|后面就是一位数字。</span><br><span class="line">^([1-9]\d\d?|\d)$：1-3位数的行</span><br><span class="line">^([1-9]\d\d?|\d)\r?$</span><br><span class="line">^([1-9]\d\d?|\d)(?!\d)：数字开头1-3位数且之后不能是数字</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> IP地址</span><br><span class="line">匹配合法的IP地址</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.150</span></span><br><span class="line"><span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span></span><br><span class="line"><span class="number">17.16</span><span class="number">.52</span><span class="number">.100</span></span><br><span class="line"><span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line"><span class="number">400.400</span><span class="number">.999</span><span class="number">.888</span></span><br><span class="line"><span class="number">001.002</span><span class="number">.003</span><span class="number">.000</span></span><br><span class="line"><span class="number">257.257</span><span class="number">.255</span><span class="number">.256</span></span><br><span class="line"></span><br><span class="line">参考：</span><br><span class="line">((\d&#123;<span class="number">1</span>,<span class="number">3</span>&#125;).)&#123;<span class="number">3</span>&#125;(\d&#123;<span class="number">1</span>,<span class="number">3</span>&#125;)</span><br><span class="line">(?:(\d&#123;1,3&#125;).)&#123;3&#125;(\d&#123;1,3&#125;)   # 400.400.999.888</span><br><span class="line"><span class="comment"># 这两个正则表达式都会匹配到不符合规则的地址，验证问题如下：</span></span><br><span class="line">对于IP地址验证的问题</span><br><span class="line">- 可以把数据提出来后，交给IP地址解析库处理，如果解析异常，就说明有问题，正则的验证只是一个初步的筛选，把明显错误过滤掉</span><br><span class="line">- 可以使用复杂的正则表达式验证地址正确性</span><br><span class="line">- 前导<span class="number">0</span>是可以的</span><br><span class="line">(?:([0-9]|[1-9]\d|[1-2]\d&#123;2&#125;).)&#123;3&#125;(([1-9]|[1-9]\d|[1-2][0-5]&#123;2&#125;))</span><br><span class="line"><span class="comment"># 这样匹配是否可以？测试可以匹配到999.888，为什么？这里的问题是，每段的IP值应该是0-255，所以使用\d好像不合适</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">nw = socket.inet_aton(<span class="string">'192.168.05.001'</span>)</span><br><span class="line">print(nw, socket.inet_ntoa(nw))</span><br><span class="line">输出：<span class="string">b'\xc0\xa8\x05\x01'</span> <span class="number">192.168</span><span class="number">.5</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">分析：</span><br><span class="line">每一段上可以写的数字有<span class="number">1</span>、<span class="number">01</span>、<span class="number">001</span>、<span class="number">000</span>、<span class="number">23</span>、<span class="number">023</span>、<span class="number">230</span>、<span class="number">100</span>，也就是说<span class="number">1</span>位就是<span class="number">0</span><span class="number">-9</span>，<span class="number">2</span>位每一位也是<span class="number">0</span><span class="number">-9</span>，<span class="number">3</span>位第一位只能<span class="number">0</span><span class="number">-2</span>，其余<span class="number">2</span>位都可以<span class="number">0</span><span class="number">-9</span>。</span><br><span class="line">(?:([0-2]\d&#123;2&#125;|\d&#123;1,2&#125;)\.)&#123;3&#125;([0-2]\d&#123;2&#125;|\d&#123;1,2&#125;)</span><br><span class="line"><span class="comment"># 解决超出200的问题，但是256呢？</span></span><br><span class="line"></span><br><span class="line"><span class="number">200</span>是特殊的，要再单独分情况处理</span><br><span class="line">25[0-5]|2[0-4]\d[01]?\d\d?   这就是每一段的逻辑</span><br><span class="line">(?:(25[0-5]|2[0-4]\d[01]?\d\d?)\.)&#123;3&#125;(25[0-5]|2[0-4]\d|[01]?\d\d?)</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 选出含有ftp的链接，且文件类型是gz或者xz的文件名</span><br><span class="line">ftp://ftp.astron.com/pub/file/file<span class="number">-5.14</span>.tar.gz</span><br><span class="line">ftp://ftp.gmplib.org/pub/gmp<span class="number">-5.1</span><span class="number">.2</span>/gmp<span class="number">-5.1</span><span class="number">.2</span>.tar.gz</span><br><span class="line">ftp://ftp.vim.org/pub/vim/unix/vim<span class="number">-7.3</span>.tar.bz2</span><br><span class="line">http://anduin.linuxfromscratch.org/sources/LFS/lfs-packages/conglomeration//iana-etc/iana-etc<span class="number">-2.30</span>.tar.bz2</span><br><span class="line">http://anduin.linuxfromscratch.org/sources/other/udev-lfs<span class="number">-205</span><span class="number">-1.</span>tar.bz2</span><br><span class="line">http://download.savannah.gnu.org/releases/libpipeline/libpipeline<span class="number">-1.2</span><span class="number">.4</span>.tar.gz</span><br><span class="line">http://download.savannah.gnu.org/releases/man-db<span class="number">-2.6</span><span class="number">.5</span>.tar.xz</span><br><span class="line">http://download.savannah.gnu.org/releases/sysvinit/sysvinit<span class="number">-2.88</span>dsf.tar.bz2</span><br><span class="line">http://ftp.altlinux.org/pub/people/legion/kbd/kbd<span class="number">-1.15</span><span class="number">.5</span>.tar.gz</span><br><span class="line">http://mirror.hust.edu.cn/gnu/autoconf/autoconf<span class="number">-2.69</span>.tar.xz</span><br><span class="line">http://mirror.hust.edu.cn/gnu/automake/autokake<span class="number">-1.14</span>.tar.xz</span><br><span class="line">    </span><br><span class="line">参考：</span><br><span class="line">.*ftp.*\.(?:gz|xz) # \是转义符，转义点符号</span><br><span class="line">ftp.*/(.*(?:gz|xz))</span><br><span class="line">.*ftp.*/([^/]*\.(?:gz|xz)) # 捕获文件名不分组</span><br><span class="line">(?&lt;=.*ftp.*/)[^/]*\.(?:gz|xz) # 断言文件名前一定还有ftp</span><br><span class="line">ftp:.*(gz|xz)</span><br></pre></td></tr></table></figure>
<h3 id="Python的正则表达式"><a href="#Python的正则表达式" class="headerlink" title="Python的正则表达式"></a>Python的正则表达式</h3><p>Python使用re模块提供了正则表达式处理的能力</p>
<h4 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h4><table>
<thead>
<tr>
<th>常量</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>re.M、re.MULTILINE</td>
<td>多行模式</td>
</tr>
<tr>
<td>re.S、re.DOTALL</td>
<td>单行模式</td>
</tr>
<tr>
<td>re.I、reIGNORECASE</td>
<td>忽略大小写</td>
</tr>
<tr>
<td>re.X、re.VERBOSE</td>
<td>忽略表达式中的空白字符</td>
</tr>
</tbody>
</table>
<p>使用<code>|位或</code>运算开启多种选项</p>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">re.compile(pattern, flags=<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 设定flags，编译模式，返回正则表达式对象regex。</span></span><br><span class="line"><span class="comment"># pattern就是正则表达式字符串，flags是选项。正则表达式需要被编译，为了提高效率，这些编译后的结果被保存，下</span></span><br><span class="line"><span class="comment"># 次使用同样的pattern的时候，就不需要再次编译。re的其他方法为了提高效率都调用了编译方法，就是为了提速。</span></span><br><span class="line">*** 先用re.compile(<span class="string">'pattern'</span>)方法编译并赋值给变量，再使用不同的方法（如：match、search、fullmatch）在指定的字符串内找被赋值的变量 ***</span><br><span class="line"></span><br><span class="line">group()</span><br><span class="line">返回一个或多个匹配的字串。如果只有一个参数，结果只有单个字符串；如果有多个参数，结果是一个元组，元组里每一项对</span><br><span class="line">应一个参数。没有参数，group()默认是<span class="number">0</span>（整个匹配串被返回）。如果group(N)参数是<span class="number">0</span>，对应的返回值是整个匹配串；如</span><br><span class="line">果它属于[<span class="number">1</span>，<span class="number">99</span>]，返回对应的一项括号分隔的群。如果参数是负数或大于模式串中定义的群数，IndexError异常会被抛</span><br><span class="line">出。如果模式串没有任何匹配，group返回<span class="keyword">None</span>；如果模式串多次匹配，group将返回最后一次匹配。</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.match(<span class="string">r"(\w+) (\w+)"</span>, <span class="string">"Isaac Newton, physicist"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">0</span>)       <span class="comment"># The entire match 整个匹配</span></span><br><span class="line"><span class="string">'Isaac Newton'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">1</span>)       <span class="comment"># The first parenthesized subgroup. 第一个括号分隔的子群</span></span><br><span class="line"><span class="string">'Isaac'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">2</span>)       <span class="comment"># The second parenthesized subgroup. 第二个括号分隔的子群</span></span><br><span class="line"><span class="string">'Newton'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">1</span>, <span class="number">2</span>)    <span class="comment"># Multiple arguments give us a tuple. 多个参数给我们一个元组</span></span><br><span class="line">(<span class="string">'Isaac'</span>, <span class="string">'Newton'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(m.group())  <span class="comment"># 同m.group(0)</span></span><br><span class="line">Isaac Newton</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: m = re.match(<span class="string">r"(..)+"</span>, <span class="string">"a1b2c3"</span>)  <span class="comment"># 三次匹配</span></span><br><span class="line">In [<span class="number">3</span>]: m.group(<span class="number">0</span>)                        <span class="comment"># 返回整个匹配串</span></span><br><span class="line">Out[<span class="number">3</span>]: <span class="string">'a1b2c3'</span>                          </span><br><span class="line">In [<span class="number">4</span>]: m.group(<span class="number">1</span>)                        <span class="comment"># 只返回最后一个匹配 </span></span><br><span class="line">Out[<span class="number">4</span>]: <span class="string">'c3'</span></span><br><span class="line">In [<span class="number">5</span>]: m.group(<span class="number">2</span>)  <span class="comment"># 因为没有第二组，所以报错</span></span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">IndexError                                Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input<span class="number">-5</span><span class="number">-9</span>b74dc8a1297&gt; <span class="keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 m.group(2)</span><br><span class="line">IndexError: no such group</span><br><span class="line">    </span><br><span class="line">groups()    </span><br><span class="line">它返回一个包含所有匹配子群的元组。如果匹配的是单个字符，要用group()方法</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.match(<span class="string">r"(\d+)\.(\d+)"</span>, <span class="string">"24.1632"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.groups()</span><br><span class="line">(<span class="string">'24'</span>, <span class="string">'1632'</span>)</span><br><span class="line"></span><br><span class="line">groupdict()</span><br><span class="line">它返回一个字典，包含所有经命名的匹配子群，键值是子群名。</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.match(<span class="string">r'(?P&lt;user&gt;\w+)@(?P&lt;website&gt;\w+)\.(?P&lt;extension&gt;\w+)'</span>,<span class="string">'myname@hackerrank.com'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.groupdict()</span><br><span class="line">&#123;<span class="string">'website'</span>: <span class="string">'hackerrank'</span>, <span class="string">'user'</span>: <span class="string">'myname'</span>, <span class="string">'extension'</span>: <span class="string">'com'</span>&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>方法</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>compile</td>
<td>编译正则表达式</td>
</tr>
<tr>
<td>match</td>
<td>必须从头开始匹配，只匹配一次，返回re.Match类型</td>
</tr>
<tr>
<td>search</td>
<td>只匹配一次，返回re.Match类型</td>
</tr>
<tr>
<td>fullmatch</td>
<td>要完全匹配，返回re.Match类型</td>
</tr>
<tr>
<td>findall</td>
<td>从头开始找，找到所有匹配，返回list类型</td>
</tr>
</tbody>
</table>
<p>注：如果没有匹配到，会返回NoneType，如果要取变量的<code>groups()</code>或<code>groupdict()</code>方法也会报错。所以这里可以在匹配后，用if判断一下，如果是NoneType就不处理了。如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">s = <span class="string">'''bo ttle\nbag\nbig\napple'''</span></span><br><span class="line">regex = re.compile(<span class="string">'(b\w+.*)'</span>)</span><br><span class="line">result = regex.fullmatch(s)</span><br><span class="line"><span class="keyword">if</span> result:</span><br><span class="line">    print(<span class="string">'OK'</span>, type(result), result.groups())</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'fuck'</span>, type(result))</span><br></pre></td></tr></table></figure>
<h5 id="单次匹配"><a href="#单次匹配" class="headerlink" title="单次匹配"></a>单次匹配</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">re.match(pattern, string, flags=<span class="number">0</span>)</span><br><span class="line">regex.match(string[, pos[, endpos]])</span><br><span class="line"><span class="comment"># match匹配从字符串的开头匹配，regex对象match方法可以重新设定开始位置和结束位置。返回match对象</span></span><br><span class="line"><span class="comment"># match只匹配开头的内容</span></span><br><span class="line"></span><br><span class="line">re.search(pattern, string, flags=<span class="number">0</span>)</span><br><span class="line">regex.search(string[, pos[, endpos]])</span><br><span class="line"><span class="comment"># 从头搜索直到第一个匹配，regex对象search方法可以重设定开始位置和结束位置，返回match对象</span></span><br><span class="line"></span><br><span class="line">re.fullmatch(mattern, string, flags=<span class="number">0</span>)</span><br><span class="line">regex.fullmatch(string[, pos[, endpos]])</span><br><span class="line"><span class="comment"># 整个字符串和正则表达式匹配，也就是索引值的开始与结束要与字符串保持一致，不然是匹配不到的</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">s = <span class="string">'''bottle\nbag\nbig\napple'''</span></span><br><span class="line"><span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(s,<span class="number">1</span>):   <span class="comment"># 括号中的1表示从1开始</span></span><br><span class="line">    print((i<span class="number">-1</span>,c),end=<span class="string">'\n'</span> <span class="keyword">if</span> i%<span class="number">8</span>==<span class="number">0</span> <span class="keyword">else</span> <span class="string">' '</span>)</span><br><span class="line">    <span class="comment"># 上面从1开始，是为了这里方便计算。如果i和8除余是0就用\n作为换行符，否则就以空白作为换行符。如果不</span></span><br><span class="line">    <span class="comment"># 加判断，将以回车作为换行符，结果中的每个括号都会占一行。</span></span><br><span class="line">    <span class="comment"># 前面括号中的i-1是为了保持enumerate函数从0开始的显示效果。</span></span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">(<span class="number">0</span>, <span class="string">'b'</span>) (<span class="number">1</span>, <span class="string">'o'</span>) (<span class="number">2</span>, <span class="string">'t'</span>) (<span class="number">3</span>, <span class="string">'t'</span>) (<span class="number">4</span>, <span class="string">'l'</span>) (<span class="number">5</span>, <span class="string">'e'</span>) (<span class="number">6</span>, <span class="string">'\n'</span>) (<span class="number">7</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="number">8</span>, <span class="string">'a'</span>) (<span class="number">9</span>, <span class="string">'g'</span>) (<span class="number">10</span>, <span class="string">'\n'</span>) (<span class="number">11</span>, <span class="string">'b'</span>) (<span class="number">12</span>, <span class="string">'i'</span>) (<span class="number">13</span>, <span class="string">'g'</span>) (<span class="number">14</span>, <span class="string">'\n'</span>) (<span class="number">15</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="number">16</span>, <span class="string">'p'</span>) (<span class="number">17</span>, <span class="string">'p'</span>) (<span class="number">18</span>, <span class="string">'l'</span>) (<span class="number">19</span>, <span class="string">'e'</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># match方法</span></span><br><span class="line">print(<span class="string">'--match--'</span>)</span><br><span class="line">result = re.match(<span class="string">'b'</span>, s)  <span class="comment"># 从s变量中找到一个就不找了</span></span><br><span class="line">print(<span class="number">1</span>, result) <span class="comment"># bottle</span></span><br><span class="line">输出：<span class="number">1</span> &lt;re.Match object; span=(<span class="number">0</span>, <span class="number">1</span>), match=<span class="string">'b'</span>&gt;</span><br><span class="line"><span class="comment"># span是配置到的字符串的索引值位置，span=(0, 1)是前包后不包，表示索引0</span></span><br><span class="line">result = re.match(<span class="string">'a'</span>, s) <span class="comment"># 没找到，返回None</span></span><br><span class="line">print(<span class="number">2</span>, result)</span><br><span class="line">result = re.match(<span class="string">'^a'</span>, s, re.M) <span class="comment"># 依然从头开始找，多行模式没有用，返回None</span></span><br><span class="line">print(<span class="number">3</span>, result)</span><br><span class="line">result = re.match(<span class="string">'^a'</span>, s, re.S) <span class="comment"># 依然从头开始找，返回None</span></span><br><span class="line">print(<span class="number">4</span>, result)</span><br><span class="line"><span class="comment"># 先编译，然后使用正则表达式对象</span></span><br><span class="line">regex = re.compile(<span class="string">'a'</span>) </span><br><span class="line"><span class="comment"># 先编译，查找有a的，结果保存到regex中。方便下面从regex中使用match方法查找</span></span><br><span class="line">result = regex.match(s) </span><br><span class="line"><span class="comment"># 依然从头开始找，这里只需要设定从r哪里找上面编译的正则表达式就可以了，也就是从s中找有regex的</span></span><br><span class="line">print(<span class="number">5</span>, result)  <span class="comment"># 返回None</span></span><br><span class="line">result = regex.match(s, <span class="number">15</span>) <span class="comment"># 把索引15作为查找的开始</span></span><br><span class="line">print(<span class="number">6</span>, result) <span class="comment"># 可以找到apple，返回：&lt;re.Match object; span=(15, 16), match='a'&gt;</span></span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># search方法</span></span><br><span class="line">print(<span class="string">'--search--'</span>)</span><br><span class="line">result = re.search(<span class="string">'a'</span>, s) <span class="comment"># 扫描找到匹配的第一个位置</span></span><br><span class="line">print(<span class="number">7</span>, result) <span class="comment"># &lt;re.Match object; span=(8, 9), match='a'&gt;，这里匹配到的应该是bag里的a。</span></span><br><span class="line">regex = re.compile(<span class="string">'b'</span>)</span><br><span class="line">result = regex.search(s, <span class="number">1</span>)  <span class="comment"># 从索引1开始查找</span></span><br><span class="line">print(<span class="number">8</span>, result) <span class="comment"># bag</span></span><br><span class="line">regex = re.compile(<span class="string">'^b'</span>, re.M)</span><br><span class="line">result = regex.search(s) <span class="comment"># 不管是不是多行，找到就返回</span></span><br><span class="line">print(<span class="number">8.5</span>, result) <span class="comment"># bottle，8.5 &lt;re.Match object; span=(7, 8), match='b'&gt;</span></span><br><span class="line">result = regex.search(s, <span class="number">8</span>)</span><br><span class="line">print(<span class="number">9</span>, result) <span class="comment"># big</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fullmatch方法</span></span><br><span class="line">print(<span class="string">'--fullmatch--'</span>)</span><br><span class="line">result = re.fullmatch(<span class="string">'bag'</span>, s)  <span class="comment"># 返回None</span></span><br><span class="line">print(<span class="number">10</span>, result)</span><br><span class="line">regex = re.compile(<span class="string">'bag'</span>)  <span class="comment"># 返回None</span></span><br><span class="line">result = regex.fullmatch(s)</span><br><span class="line">print(<span class="number">11</span>, result)</span><br><span class="line">result = regex.fullmatch(s, <span class="number">7</span>)  <span class="comment"># 返回None</span></span><br><span class="line">print(<span class="number">12</span>, result)</span><br><span class="line">result = regex.fullmatch(s, <span class="number">7</span>, <span class="number">10</span>)</span><br><span class="line">print(<span class="number">13</span>, result) <span class="comment"># 要完全匹配，多了少了都不行，[7,10)，前包后不包。&lt;re.Match object; span=(7, 10), match='bag'&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="全文搜索"><a href="#全文搜索" class="headerlink" title="全文搜索"></a>全文搜索</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">re.findall(pattern, string, flags=<span class="number">0</span>)</span><br><span class="line">regex.findall(string[, pos[, endpos]])</span><br><span class="line"><span class="comment"># 对整个字符串，从左至右匹配，返回所有匹配项的列表</span></span><br><span class="line"></span><br><span class="line">re.finditer(pattern, string, flags=<span class="number">0</span>)</span><br><span class="line">regex.finditer(string[, pos[, endpos]])</span><br><span class="line"><span class="comment"># 对整个字符串，从左至右匹配，返回所有匹配项，返回迭代器。</span></span><br><span class="line"><span class="comment"># 注意，每次迭代返回的是match对象。</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">s = <span class="string">'''bottle\nbag\nbig\nable'''</span></span><br><span class="line"><span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(s,<span class="number">1</span>):</span><br><span class="line">    print((i<span class="number">-1</span>, c), end=<span class="string">'\n'</span> <span class="keyword">if</span> i%<span class="number">8</span>==<span class="number">0</span> <span class="keyword">else</span> <span class="string">' '</span>)</span><br><span class="line">print()</span><br><span class="line">输出：</span><br><span class="line">(<span class="number">0</span>, <span class="string">'b'</span>) (<span class="number">1</span>, <span class="string">'o'</span>) (<span class="number">2</span>, <span class="string">'t'</span>) (<span class="number">3</span>, <span class="string">'t'</span>) (<span class="number">4</span>, <span class="string">'l'</span>) (<span class="number">5</span>, <span class="string">'e'</span>) (<span class="number">6</span>, <span class="string">'\n'</span>) (<span class="number">7</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="number">8</span>, <span class="string">'a'</span>) (<span class="number">9</span>, <span class="string">'g'</span>) (<span class="number">10</span>, <span class="string">'\n'</span>) (<span class="number">11</span>, <span class="string">'b'</span>) (<span class="number">12</span>, <span class="string">'i'</span>) (<span class="number">13</span>, <span class="string">'g'</span>) (<span class="number">14</span>, <span class="string">'\n'</span>) (<span class="number">15</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="number">16</span>, <span class="string">'b'</span>) (<span class="number">17</span>, <span class="string">'l'</span>) (<span class="number">18</span>, <span class="string">'e'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># findall方法</span></span><br><span class="line">print()</span><br><span class="line">print(<span class="string">'--findall--'</span>)</span><br><span class="line">result = re.findall(<span class="string">'b'</span>, s)  <span class="comment"># 1 ['b', 'b', 'b', 'b']</span></span><br><span class="line">print(<span class="number">1</span>, result)</span><br><span class="line">regex = re.compile(<span class="string">'^b'</span>)</span><br><span class="line">result = regex.findall(s)  <span class="comment"># 2 ['b']</span></span><br><span class="line">print(<span class="number">2</span>, result)</span><br><span class="line">regex = re.compile(<span class="string">'^b'</span>, re.M)  <span class="comment"># 使用多行模式，可以找到更多b开头的单词</span></span><br><span class="line">result = regex.findall(s,<span class="number">7</span>)  <span class="comment"># 3 ['b', 'b']</span></span><br><span class="line">print(<span class="number">3</span>, result) <span class="comment"># bag big</span></span><br><span class="line">regex = re.compile(<span class="string">'^b'</span>, re.S)</span><br><span class="line">result = regex.findall(s)  <span class="comment"># 4 ['b']</span></span><br><span class="line">print(<span class="number">4</span>, result) <span class="comment"># bottle</span></span><br><span class="line">regex = re.compile(<span class="string">'^b'</span>, re.M)</span><br><span class="line">result = regex.findall(s, <span class="number">7</span>, <span class="number">10</span>)  <span class="comment"># 5 ['b']</span></span><br><span class="line">print(<span class="number">5</span>, result) <span class="comment"># bag</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># finditer方法</span></span><br><span class="line">print(<span class="string">'--finditer--'</span>)</span><br><span class="line">result = regex.finditer(s)   <span class="comment"># 生成一个迭代器。</span></span><br><span class="line"><span class="comment"># result = re.finditer('b',s)</span></span><br><span class="line">print(type(result)) <span class="comment"># 类型是可调用的迭代器，callable_iterator。&lt;class 'callable_iterator'&gt;</span></span><br><span class="line">print(next(result))  <span class="comment"># &lt;re.Match object; span=(0, 1), match='b'&gt;</span></span><br><span class="line">print(next(result))  <span class="comment"># &lt;re.Match object; span=(7, 8), match='b'&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="匹配替换"><a href="#匹配替换" class="headerlink" title="匹配替换"></a>匹配替换</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">re.sub(pattern, replacement, string, count=<span class="number">0</span>, flags=<span class="number">0</span>)</span><br><span class="line">regex.sub(replacement, string, count=<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 使用pattern对字符串string进行匹配，对匹配项使用repl替换。replacement可以是string、bytes、function</span></span><br><span class="line"></span><br><span class="line">re.subn(pattern, replacement, string, count=<span class="number">0</span>, flags=<span class="number">0</span>)</span><br><span class="line">regex.subn(replacement, string, count=<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 同sub返回一个元组(new_string, number_of_subs_made)</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">s = <span class="string">'''bottle\nbag\nbig\napple'''</span></span><br><span class="line"><span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(s,<span class="number">1</span>):   <span class="comment"># 括号中的1表示从1开始</span></span><br><span class="line">    print((i<span class="number">-1</span>,c),end=<span class="string">'\n'</span> <span class="keyword">if</span> i%<span class="number">8</span>==<span class="number">0</span> <span class="keyword">else</span> <span class="string">' '</span>)</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">(<span class="number">0</span>, <span class="string">'b'</span>) (<span class="number">1</span>, <span class="string">'o'</span>) (<span class="number">2</span>, <span class="string">'t'</span>) (<span class="number">3</span>, <span class="string">'t'</span>) (<span class="number">4</span>, <span class="string">'l'</span>) (<span class="number">5</span>, <span class="string">'e'</span>) (<span class="number">6</span>, <span class="string">'\n'</span>) (<span class="number">7</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="number">8</span>, <span class="string">'a'</span>) (<span class="number">9</span>, <span class="string">'g'</span>) (<span class="number">10</span>, <span class="string">'\n'</span>) (<span class="number">11</span>, <span class="string">'b'</span>) (<span class="number">12</span>, <span class="string">'i'</span>) (<span class="number">13</span>, <span class="string">'g'</span>) (<span class="number">14</span>, <span class="string">'\n'</span>) (<span class="number">15</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="number">16</span>, <span class="string">'p'</span>) (<span class="number">17</span>, <span class="string">'p'</span>) (<span class="number">18</span>, <span class="string">'l'</span>) (<span class="number">19</span>, <span class="string">'e'</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换方法</span></span><br><span class="line">print()</span><br><span class="line">regex = re.compile(<span class="string">'b\wg'</span>)</span><br><span class="line">result = regex.sub(<span class="string">'magedu'</span>, s)</span><br><span class="line">print(<span class="number">1</span>, result) <span class="comment"># 被替换后的字符串</span></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># 1 bottle</span></span><br><span class="line"><span class="comment"># magedu</span></span><br><span class="line"><span class="comment"># magedu</span></span><br><span class="line"><span class="comment"># apple</span></span><br><span class="line">result = regex.sub(<span class="string">'magedu'</span>, s, <span class="number">1</span>) <span class="comment"># 替换1次</span></span><br><span class="line">print(<span class="number">2</span>, result) <span class="comment"># 被替换后的字符串</span></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># 2 bottle</span></span><br><span class="line"><span class="comment"># magedu</span></span><br><span class="line"><span class="comment"># big</span></span><br><span class="line"><span class="comment"># apple</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(<span class="string">'\s+'</span>)  <span class="comment"># \s匹配1位空白字符，包括换行符、制表符、空格。加号表示至少1次</span></span><br><span class="line">result = regex.subn(<span class="string">'\t'</span>, s)  <span class="comment"># 把s字符串中的regex变量替换成'\t'</span></span><br><span class="line">print(<span class="number">3</span>, result) <span class="comment"># 被替换后的字符串及替换次数的元组</span></span><br><span class="line"><span class="comment"># 输出：3 ('bottle\tbag\tbig\tapple', 3)</span></span><br></pre></td></tr></table></figure>
<h5 id="分割字符串"><a href="#分割字符串" class="headerlink" title="分割字符串"></a>分割字符串</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">字符串的分割函数，太难用，不能指定多个字符进行分割</span><br><span class="line">re.split(pattern, string, maxsplit=<span class="number">0</span>, flags=<span class="number">0</span>)</span><br><span class="line">re.split 分割字符串</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">s = <span class="string">'''01 bottle</span></span><br><span class="line"><span class="string">02 bag</span></span><br><span class="line"><span class="string">03       big1</span></span><br><span class="line"><span class="string">100        able'''</span></span><br><span class="line"><span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(s, <span class="number">1</span>):</span><br><span class="line">    print((i<span class="number">-1</span>, c), end=<span class="string">'\n'</span> <span class="keyword">if</span> i%<span class="number">8</span>==<span class="number">0</span> <span class="keyword">else</span> <span class="string">' '</span>)</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把每行单词提取出来</span></span><br><span class="line">print(s.split())</span><br><span class="line"><span class="comment"># 输出：['01','bottle','02','bag','03','big1','100','able']</span></span><br><span class="line">result = re.split(<span class="string">'[\s\d]+'</span>, s)  <span class="comment"># 以至少一个空格或一个数字为分隔符对s变量进行处理</span></span><br><span class="line">print(<span class="number">1</span>, result) <span class="comment"># 1 ['','bottle','bag','big','able']</span></span><br><span class="line">regex = re.compile(<span class="string">'^[\s\d]+'</span>) <span class="comment"># 字符串首</span></span><br><span class="line">result = regex.split(s)</span><br><span class="line">print(<span class="number">2</span>, result) <span class="comment"># ['','bottle\n02 bag\n03      big1\n100      able']</span></span><br><span class="line">regex = re.compile(<span class="string">'^[\s\d]+'</span>, re.M) <span class="comment"># 行首，多行匹配，也就是每一行都要匹配</span></span><br><span class="line">result = regex.split(s)</span><br><span class="line">print(<span class="number">3</span>, result) <span class="comment"># ['','bottle\n','bag\n','big1\n','able']</span></span><br><span class="line">regex = re.compile(<span class="string">'\s+\d+\s+'</span>)</span><br><span class="line">result = regex.split(<span class="string">' '</span> + s)</span><br><span class="line">print(<span class="number">4</span>, result)  <span class="comment"># 4 ['', 'bottle', 'bag', 'big1', 'able']</span></span><br><span class="line">result = regex.split(s)</span><br><span class="line">print(<span class="number">5</span>,result)  <span class="comment"># 5 ['01 bottle', 'bag', 'big1', 'able']</span></span><br></pre></td></tr></table></figure>
<h5 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">使用小括号的pattern捕获的数据被放到了组group中。</span><br><span class="line">match、search函数可以返回match对象；findall返回字符串列表；finditer返回一个个match对象</span><br><span class="line">如果pattern中使用了分组，如果有匹配的结果，会在match对象中</span><br><span class="line"><span class="number">1.</span> 使用group(N)方式返回对应分组，<span class="number">1</span>-N是对应的分组，<span class="number">0</span>返回整个匹配的字符串</span><br><span class="line"><span class="number">2.</span> 如果使用了命名分组，可以使用group(<span class="string">'name'</span>)的方式取分组</span><br><span class="line"><span class="number">3.</span> 也可以使用groups()返回所有组</span><br><span class="line"><span class="number">4.</span> 使用groupdict()返回所有命名的分组</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">s = <span class="string">'''bottle\nbag\nbig\napple'''</span></span><br><span class="line"><span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(s,<span class="number">1</span>):   <span class="comment"># 括号中的1表示从1开始</span></span><br><span class="line">    print((i<span class="number">-1</span>,c),end=<span class="string">'\n'</span> <span class="keyword">if</span> i%<span class="number">8</span>==<span class="number">0</span> <span class="keyword">else</span> <span class="string">' '</span>)</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">(<span class="number">0</span>, <span class="string">'b'</span>) (<span class="number">1</span>, <span class="string">'o'</span>) (<span class="number">2</span>, <span class="string">'t'</span>) (<span class="number">3</span>, <span class="string">'t'</span>) (<span class="number">4</span>, <span class="string">'l'</span>) (<span class="number">5</span>, <span class="string">'e'</span>) (<span class="number">6</span>, <span class="string">'\n'</span>) (<span class="number">7</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="number">8</span>, <span class="string">'a'</span>) (<span class="number">9</span>, <span class="string">'g'</span>) (<span class="number">10</span>, <span class="string">'\n'</span>) (<span class="number">11</span>, <span class="string">'b'</span>) (<span class="number">12</span>, <span class="string">'i'</span>) (<span class="number">13</span>, <span class="string">'g'</span>) (<span class="number">14</span>, <span class="string">'\n'</span>) (<span class="number">15</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="number">16</span>, <span class="string">'p'</span>) (<span class="number">17</span>, <span class="string">'p'</span>) (<span class="number">18</span>, <span class="string">'l'</span>) (<span class="number">19</span>, <span class="string">'e'</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 分组</span></span><br><span class="line">regex = re.compile(<span class="string">'(b\w+)'</span>)  <span class="comment"># 单词中b后面至少有一个非空白字符</span></span><br><span class="line">result = regex.match(s)  <span class="comment"># match匹配从字符串的开头匹配</span></span><br><span class="line">print()</span><br><span class="line">print(type(result))</span><br><span class="line">print(<span class="number">1</span>, <span class="string">'match'</span>, result.groups())</span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># &lt;class 're.Match'&gt;</span></span><br><span class="line"><span class="comment"># 1 match ('bottle',)</span></span><br><span class="line"></span><br><span class="line">result = regex.search(s, <span class="number">1</span>)</span><br><span class="line">print(<span class="number">2</span>, <span class="string">'search'</span>, result.groups())  <span class="comment"># 2 search ('bag',)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 命名分组</span></span><br><span class="line">regex = re.compile(<span class="string">'(b\w+)\n(?P&lt;name2&gt;b\w+)\n(?P&lt;name3&gt;b\w+)'</span>)</span><br><span class="line"><span class="comment"># 这里配置的是bottle\nbag\nbig</span></span><br><span class="line">result = regex.match(s)</span><br><span class="line">print(<span class="number">3</span>, <span class="string">'match'</span>, result)</span><br><span class="line"><span class="comment"># 输出：3 match &lt;re.Match object; span=(0, 14), match='bottle\nbag\nbig'&gt;</span></span><br><span class="line">print(<span class="number">4</span>, result.group(<span class="number">3</span>), result.group(<span class="number">2</span>), result.group(<span class="number">1</span>))</span><br><span class="line"><span class="comment"># 输出：4 big bag bottle</span></span><br><span class="line"><span class="comment"># group()中的数字指返回匹配到的组中的第几个元素，切记匹配到的内容一定是在组中的</span></span><br><span class="line">print(<span class="number">5</span>, result.group(<span class="number">0</span>).encode()) <span class="comment"># 0 返回整个匹配字符串</span></span><br><span class="line"><span class="comment"># 输出：5 b'bottle\nbag\nbig'</span></span><br><span class="line">print(<span class="number">6</span>, result.group(<span class="string">'name2'</span>), result.group(<span class="string">'name3'</span>))</span><br><span class="line"><span class="comment"># 输出：6 bag big</span></span><br><span class="line">print(<span class="number">6.5</span>, result.groups())</span><br><span class="line"><span class="comment"># 输出：6.5 ('bottle', 'bag', 'big')，匹配到的内容会被组成一个元组</span></span><br><span class="line">print(<span class="number">7</span>, result.groupdict())</span><br><span class="line"><span class="comment"># 因为匹配的是bottle\nbag\nbig，name2组匹配到的是bag，所以输出：&#123;'name2': 'bag', 'name3': 'big'&#125;</span></span><br><span class="line"></span><br><span class="line">result = regex.findall(s)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> result:</span><br><span class="line">    print(type(x), x)</span><br><span class="line"><span class="comment"># 输出：&lt;class 'tuple'&gt; ('bottle', 'bag', 'big')，这里的result的值是[('bottle', 'bag', 'big')]</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(<span class="string">'(?P&lt;head&gt;b\w+)'</span>)</span><br><span class="line">result = regex.finditer(s)</span><br><span class="line">print(result)</span><br><span class="line"><span class="comment"># 输出：&lt;callable_iterator object at 0x7f0274c1cb20&gt;，这是一个可调用迭代器</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> result:</span><br><span class="line">    print(type(x), x, x.group(), x.group(<span class="string">'head'</span>))</span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># &lt;class 're.Match'&gt; &lt;re.Match object; span=(0, 6), match='bottle'&gt; bottle bottle</span></span><br><span class="line"><span class="comment"># &lt;class 're.Match'&gt; &lt;re.Match object; span=(7, 10), match='bag'&gt; bag bag</span></span><br><span class="line"><span class="comment"># &lt;class 're.Match'&gt; &lt;re.Match object; span=(11, 14), match='big'&gt; big big</span></span><br></pre></td></tr></table></figure>
<h4 id="练习-2"><a href="#练习-2" class="headerlink" title="练习"></a>练习</h4><h5 id="匹配邮箱地址"><a href="#匹配邮箱地址" class="headerlink" title="匹配邮箱地址"></a>匹配邮箱地址</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">test@hot-mail.com</span><br><span class="line">v-ip@magedu.com</span><br><span class="line">web.manager@magedu.com.cn</span><br><span class="line">super.user@google.com</span><br><span class="line">a@w-a-com</span><br><span class="line"></span><br><span class="line">参考：</span><br><span class="line">\w+[-.\w]*@[\w-]+(\.[\w-]+)+</span><br><span class="line">测试：</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">s = <span class="string">'''</span></span><br><span class="line"><span class="string">test@hot-mail.com</span></span><br><span class="line"><span class="string">v-ip@magedu.com</span></span><br><span class="line"><span class="string">web.manager@magedu.com.cn</span></span><br><span class="line"><span class="string">super.user@google.com</span></span><br><span class="line"><span class="string">a@w-a-com</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(<span class="string">'\w+[-.\w]*@[\w-]+(\.[\w-]+)+'</span>)</span><br><span class="line">result = regex.finditer(s)</span><br><span class="line">print(type(result),result)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">    print(i)</span><br><span class="line">输出：</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">callable_iterator</span>'&gt; &lt;<span class="title">callable_iterator</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f3c9a364e80</span>&gt;</span></span><br><span class="line">&lt;re.Match object; span=(1, 18), match='test@hot-mail.com'&gt;</span><br><span class="line">&lt;re.Match object; span=(<span class="number">19</span>, <span class="number">34</span>), match=<span class="string">'v-ip@magedu.com'</span>&gt;</span><br><span class="line">&lt;re.Match object; span=(<span class="number">35</span>, <span class="number">60</span>), match=<span class="string">'web.manager@magedu.com.cn'</span>&gt;</span><br><span class="line">&lt;re.Match object; span=(<span class="number">61</span>, <span class="number">82</span>), match=<span class="string">'super.user@google.com'</span>&gt;</span><br></pre></td></tr></table></figure>
<h5 id="匹配html标记内的内容"><a href="#匹配html标记内的内容" class="headerlink" title="匹配html标记内的内容"></a>匹配html标记内的内容</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href='http://www.magedu.com/index.html' target='_blank'&gt;马哥教育&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">参考：</span><br><span class="line">&lt;[^&lt;&gt;]+&gt;(.*)&lt;[^&lt;&gt;]+&gt;</span><br><span class="line">如果要匹配标记a</span><br><span class="line">&lt;(\w+)\s+[^&lt;&gt;]+&gt;(.*)(&lt;/\1&gt;)</span><br></pre></td></tr></table></figure>
<h5 id="匹配URL"><a href="#匹配URL" class="headerlink" title="匹配URL"></a>匹配URL</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://www.magedu.com/index.html</span><br><span class="line">https://login.magedu.com</span><br><span class="line">file:///etc/sysconfig/network</span><br><span class="line">    </span><br><span class="line">参考：</span><br><span class="line">(\w+)://([^\s\/]+)</span><br></pre></td></tr></table></figure>
<h5 id="匹配二代中国身份证ID"><a href="#匹配二代中国身份证ID" class="headerlink" title="匹配二代中国身份证ID"></a>匹配二代中国身份证ID</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">321105700101003</span></span><br><span class="line"><span class="number">321105710010100030</span></span><br><span class="line"><span class="number">11210020181239101</span>X</span><br><span class="line"><span class="number">17</span>位数字+<span class="number">1</span>位校验码组成</span><br><span class="line">前<span class="number">6</span>位地址码，<span class="number">8</span>位出生年月，<span class="number">3</span>位数字，<span class="number">1</span>位校验位（<span class="number">0</span><span class="number">-9</span>或X）</span><br><span class="line"></span><br><span class="line">参考：</span><br><span class="line">\d&#123;<span class="number">17</span>&#125;[<span class="number">0</span><span class="number">-9</span>xX]|\d&#123;<span class="number">15</span>&#125;</span><br></pre></td></tr></table></figure>
<h5 id="判断密码强弱"><a href="#判断密码强弱" class="headerlink" title="判断密码强弱"></a>判断密码强弱</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">要求密码必须由<span class="number">10</span><span class="number">-15</span>位指定字符组成：</span><br><span class="line">十进制数字</span><br><span class="line">大写字母</span><br><span class="line">小写字母</span><br><span class="line">下划线</span><br><span class="line">要求四种类型的字符都要出现才算合法的强密码</span><br><span class="line"></span><br><span class="line">例如：Aatb32_67mnq，其中包含大写字母、小写字母、数字和下划线，是合格的强密码</span><br><span class="line"></span><br><span class="line">参考：</span><br><span class="line">Aatb32_67mnq</span><br><span class="line">Aatb32_67m.nq</span><br><span class="line">中国是一个伟大的国家aA_8</span><br><span class="line"><span class="number">10</span><span class="number">-15</span>位，其中包含大写字母、小写字母、数字和下划线</span><br><span class="line">^\w&#123;<span class="number">10</span>,<span class="number">15</span>&#125;$  <span class="comment"># 这会匹配到中文</span></span><br><span class="line">如果测试有不可见字符干扰使用^\w&#123;10,15&#125;\r?$</span><br><span class="line">看似正确，但是，如果密码有中文呢？</span><br><span class="line">^[a-zA-Z0<span class="number">-9</span>_]&#123;<span class="number">10</span>,<span class="number">15</span>&#125;$  <span class="comment"># 排除中文 </span></span><br><span class="line"></span><br><span class="line">但是还是没有解决类似于<span class="number">1111111111112</span>这种密码的问题，如何解决？</span><br><span class="line">需要用到一些非正则表达式的手段。</span><br><span class="line">利用判断来解决，思路如下：</span><br><span class="line"><span class="number">1.</span> 可以判断当前密码字符串中是否有\W，如果出现就说明一定不是合法的，如果不出现说明合法</span><br><span class="line"><span class="number">2.</span> 对合法继续判断，如果出现过_下划线，说明有可能是强密码，但是没有下划线说明一定不是强密码</span><br><span class="line"><span class="number">3.</span> 对包含下划线的合法密码字符串继续判断，如果出现过\d的，说明有可能是强密码，没有出现\d的一定不是强密码</span><br><span class="line"><span class="number">4.</span> 对上一次的包含下划线、数字的合法的密码字符串继续判断，如果出现了[A-Z]说明有可能是强密码，没有出现[A-Z]说明一定不是强密码</span><br><span class="line"><span class="number">5.</span> 对上一次包含下划线、数字、大写字母的合法密码字符串继续判断，如果出现了[a-z]说明就是强密码，找到了，没有出现小写字母就一定不是强密码</span><br><span class="line">请注意上面的判断的顺序，应该是概率上最可能不出在密码字符串的先判断</span><br></pre></td></tr></table></figure>
<h5 id="单词统计word-count"><a href="#单词统计word-count" class="headerlink" title="单词统计word count"></a>单词统计word count</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">对sample文件进行单词统计，要求使用正则表达式</span><br><span class="line"></span><br><span class="line">参考：</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makekey2</span><span class="params">(line:str, chars=set<span class="params">(<span class="string">"""!'"#./\()[],*- \r\n"""</span>)</span>)</span>:</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i,c <span class="keyword">in</span> enumerate(line):</span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> chars:</span><br><span class="line">            <span class="keyword">if</span> start == i: <span class="comment"># 如果紧挨着还是特殊字符，start一定等于i</span></span><br><span class="line">                start += <span class="number">1</span> <span class="comment"># 加1并continue</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">yield</span> line[start:i]</span><br><span class="line">            start = i + <span class="number">1</span> <span class="comment"># 加1是跳过这个不需要的特殊字符c</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> start &lt; len(line): <span class="comment"># 小于，说明还有有效的字符，而且一直到末尾</span></span><br><span class="line">            <span class="keyword">yield</span> line[start:]</span><br><span class="line"><span class="comment"># """\\host\mount splitext('.cshrc splitdrive("//host/computer/dir . abc path `s\r\n`"))"""</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(<span class="string">'[^\w]+'</span>)</span><br><span class="line"><span class="comment"># 匹配所有非字母数字，即符号，最少一次</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makekey3</span><span class="params">(line:str)</span>:</span>  <span class="comment"># 另一种处理字符的方式</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> regex.split(line):  <span class="comment"># 使用符号为分隔符，对line进行分隔</span></span><br><span class="line">        <span class="keyword">if</span> len(word):</span><br><span class="line">            <span class="keyword">yield</span> word</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wordcount</span><span class="params">(filename, encoding=<span class="string">'utf8'</span>, ignore=set<span class="params">()</span>)</span>:</span></span><br><span class="line">    d = defaultdict(<span class="keyword">lambda</span>:<span class="number">0</span>)</span><br><span class="line"><span class="comment"># g = lambda: 0 等价于 def g(): return 0，也有用lambda:'N/A'的，但这里不能这样用，因为下面还要做加法运算</span></span><br><span class="line">    <span class="keyword">with</span> open(filename, encoding=encoding) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">for</span> word <span class="keyword">in</span> map(str.lower, makekey2(line)):  <span class="comment"># 将字符都改为小写字母</span></span><br><span class="line">                <span class="keyword">if</span> word <span class="keyword">not</span> <span class="keyword">in</span> ignore:  <span class="comment"># ignore里是不统计的单词</span></span><br><span class="line">                    d[word] += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">top</span><span class="params">(d:dict, n=<span class="number">10</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i,(k,v) <span class="keyword">in</span> enumerate(sorted(d.items(),key=<span class="keyword">lambda</span> item: item[<span class="number">1</span>],reverse=<span class="keyword">True</span>)):</span><br><span class="line">        <span class="keyword">if</span> i &gt; n:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        print(k,v)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 单词统计前几名</span></span><br><span class="line">top(wordcount(<span class="string">'sample'</span>,ignore=&#123;<span class="string">'the'</span>,<span class="string">'a'</span>&#125;))</span><br></pre></td></tr></table></figure>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line">d = defaultdict(<span class="keyword">lambda</span> :<span class="number">0</span>)   <span class="comment"># defaultdict是缺省字典，字典默认返回0</span></span><br><span class="line"><span class="comment"># s = '''os.path([path])   sub-path.'''</span></span><br><span class="line">s1 = <span class="string">'''r'\\host\mount splitext('.cshrc splitdrive("//host/computer/dir . abc.'''</span></span><br><span class="line">lst = re.split(<span class="string">'[^-\w]+'</span>, s)   <span class="comment"># 以非字母、数字及-的内容为分隔符。单词处理就用这种方法</span></span><br><span class="line">print(lst)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'xxx'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        <span class="keyword">for</span> sub <span class="keyword">in</span> re.split(<span class="string">'[^-\w]+'</span>, line):</span><br><span class="line">            <span class="keyword">if</span> len(sub) &gt; <span class="number">0</span>:</span><br><span class="line">                d[sub] += <span class="number">1</span>   </span><br><span class="line"><span class="comment"># 因为s1字符串被切割后会有空，所以这里判断，如果切割后的字符量大于0，就加1</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/20/使用ELK分析Nginx日志/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/20/使用ELK分析Nginx日志/" itemprop="url">
                  使用ELK分析Nginx日志
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-20 16:57:19" itemprop="dateCreated datePublished" datetime="2020-01-20T16:57:19+08:00">2020-01-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p>使用filebeat收集nginx日志，输出到kafka；logstash从kafka中消费日志，通过grok进行数据格式化，输出到elasticsearch中，kibana从elasticsearch中获取日志，进行过滤出图。</p>
<h3 id="部署wordpress"><a href="#部署wordpress" class="headerlink" title="部署wordpress"></a>部署wordpress</h3><p>这里部署wordpress主要为了得到nginx的访问日志。</p>
<table>
<thead>
<tr>
<th>地址</th>
<th>服务</th>
<th>主机名/系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.14:80</td>
<td>nginx/php/mariadb-server</td>
<td>nwps/CentOS8</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nginx php-fpm php mariadb-server php-mysqlnd</span><br><span class="line">systemctl start php-fpm nginx mariadb-server</span><br><span class="line">systemctl enable php-fpm nginx mariadb-server</span><br><span class="line">mysql_secure_installation</span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化mariadb</span></span><br><span class="line">mysql -uroot -pcentos</span><br><span class="line">create database wordpress;</span><br><span class="line">grant all on wordpress.* to 'wps'@'localhost' identified by 'centos';</span><br><span class="line">flush privileges;</span><br><span class="line">tar xf wordpress-5.2.2-zh_CN.tar.gz -C /usr/share/nginx/html</span><br><span class="line">cd /usr/share/nginx/html/wordpress</span><br><span class="line">cp wp-config-sample.php wp-config.php</span><br><span class="line">vim wp-config.php</span><br><span class="line">            /** WordPress数据库的名称 */</span><br><span class="line">            define('DB_NAME', 'wordpress');</span><br><span class="line"></span><br><span class="line">            /** MySQL数据库用户名 */</span><br><span class="line">            define('DB_USER', 'wps');</span><br><span class="line"></span><br><span class="line">            /** MySQL数据库密码 */</span><br><span class="line">            define('DB_PASSWORD', 'centos');</span><br><span class="line"></span><br><span class="line">            /** MySQL主机 */</span><br><span class="line">            define('DB_HOST', 'localhost');</span><br><span class="line"></span><br><span class="line">            /** 创建数据表时默认的文字编码 */</span><br><span class="line">            define('DB_CHARSET', 'utf8');</span><br><span class="line"></span><br><span class="line">            /** 数据库整理类型。如不确定请勿更改 */</span><br><span class="line">            define('DB_COLLATE', '');</span><br><span class="line">访问：http://172.16.103.130/wordpress进行安装</span><br></pre></td></tr></table></figure>
<h3 id="部署zookeeper"><a href="#部署zookeeper" class="headerlink" title="部署zookeeper"></a>部署zookeeper</h3><table>
<thead>
<tr>
<th>地址</th>
<th>服务</th>
<th>主机名/系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.17</td>
<td>zookeeper-3.4.14/java-1.8.0-openjdk-devel</td>
<td>kafka1/CentOS8</td>
</tr>
<tr>
<td>192.168.1.15</td>
<td>zookeeper-3.4.14/java-1.8.0-openjdk-devel</td>
<td>kafka2/CentOS8</td>
</tr>
<tr>
<td>192.168.1.16</td>
<td>zookeeper-3.4.14/java-1.8.0-openjdk-devel</td>
<td>kafka3/CentOS8</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">   三台主机</span><br><span class="line">------------</span><br><span class="line">到http://zookeeper.apache.org/releases.html去下载zookeeper。这里需要注意，下载的3.5.5和3.5.6</span><br><span class="line">版本中没有zookeeper-***.jar包，所以启动zookeeper会提示:</span><br><span class="line">"Could not find or load main class org.apache.zookeeper.server.quorum.QuorumPeerMain"。</span><br><span class="line">测试下载的3.4.14版本没有问题。也许是不会使用的原因</span><br><span class="line"></span><br><span class="line">yum install java-1.8.0-openjdk-devel</span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper依賴java</span></span><br><span class="line">tar -zxvf zookeeper-3.4.14.tar.gz -C /usr/local</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解壓安裝</span></span><br><span class="line">cd /usr/local</span><br><span class="line">ln -sv zookeeper-3.4.14 zookeeper</span><br><span class="line">cd zookeeper/conf</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vim zoo.cfg</span><br><span class="line">	tickTime=2000</span><br><span class="line">    initLimit=10</span><br><span class="line">    syncLimit=5</span><br><span class="line">    dataDir=/usr/local/zookeeper/data</span><br><span class="line">    dataLogDir=/usr/local/zookeeper/logs</span><br><span class="line">    clientPort=2181</span><br><span class="line">    server.1=192.168.1.17:2888:3888</span><br><span class="line">    server.2=192.168.1.15:2888:3888</span><br><span class="line">    server.3=192.168.1.16:2888:3888</span><br><span class="line"><span class="meta">#</span><span class="bash"> tickTime：这个时间是作为Zookeeper服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每个 tickTime 时间就会发送一个心跳。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dataDir：顾名思义就是 Zookeeper保存数据的目录，默认情况下，Zookeeper将写数据的日志文件也保存在这个目录里。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> clientPort：这个端口就是客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> initLimit：这个配置项是用来配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 5个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5*2000=10 秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> syncLimit：这个配置项标识 Leader 与Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是5*2000=10 秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server.A=B：C：D：其中 A 是一个数字，表示这个是第几号服务器；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意：dataDir,dataLogDir中的wwb是当前登录用户名，data，logs目录开始是不存在，需要使用mkdir命令创建相应的目录。并且在该目录下创建文件myid。serve1,server2,server3该文件内容分别为1,2,3。</span></span><br><span class="line">cd /usr/local/zookeeper</span><br><span class="line">mkdir &#123;data,logs&#125;</span><br><span class="line">cd data</span><br><span class="line">echo 1 &gt; myid</span><br><span class="line"><span class="meta">#</span><span class="bash"> kafka2、3分别在這裡改為<span class="built_in">echo</span> 2 &gt; myid或<span class="built_in">echo</span> 3 &gt; myid</span></span><br><span class="line">cd</span><br><span class="line">scp zookeeper-3.4.14.tar.gz 192.168.1.15:/root</span><br><span class="line">scp zookeeper-3.4.14.tar.gz 192.168.1.16:/root</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从第一台主机复制到另外两台主机上</span></span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">	export JAVA_HOME=/usr</span><br><span class="line">chmod +x /etc/profile.d/java.sh</span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line">java -version</span><br><span class="line">scp /etc/profile.d/java.sh 192.168.1.15:/etc/profile.d</span><br><span class="line">scp /etc/profile.d/java.sh 192.168.1.16:/etc/profile.d</span><br><span class="line">scp /usr/local/zookeeper/conf/zoo.cfg root@192.168.1.15:/usr/local/zookeeper/conf/</span><br><span class="line">scp /usr/local/zookeeper/conf/zoo.cfg root@192.168.1.16:/usr/local/zookeeper/conf/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从第一台主机复制到另外两台主机上</span></span><br><span class="line">cd /usr/local/zookeeper/bin</span><br><span class="line">./zkServer.sh start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 啟動zookeeper</span></span><br><span class="line">ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這時只有leader節點會監聽2888端口，另外兩台是不監聽的。三台主機都會監聽2181和3888端口</span></span><br><span class="line">./zkCli.sh -server localhost:2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這裡如果連接的是本機的zookeeper可以不用參數和地址，連接集群中其他zookeeper需要。</span></span><br></pre></td></tr></table></figure>
<h3 id="部署kafka"><a href="#部署kafka" class="headerlink" title="部署kafka"></a>部署kafka</h3><table>
<thead>
<tr>
<th>地址</th>
<th>服务</th>
<th>主机名/系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.17</td>
<td>kafka_2.12-2.2.1</td>
<td>kafka1/CentOS8</td>
</tr>
<tr>
<td>192.168.1.15</td>
<td>kafka_2.12-2.2.1</td>
<td>kafka2/CentOS8</td>
</tr>
<tr>
<td>192.168.1.16</td>
<td>kafka_2.12-2.2.1</td>
<td>kafka3/CentOS8</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">-------------</span><br><span class="line">   三台主機</span><br><span class="line">-------------</span><br><span class="line">cd /root</span><br><span class="line">tar xf kafka_2.12-2.2.1.tgz -C /usr/local</span><br><span class="line">cd /usr/local</span><br><span class="line">ln -sv kafka_2.12-2.2.1 kafka</span><br><span class="line">cd kafka/config/</span><br><span class="line">vim server.properties</span><br><span class="line">	broker.id=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 三台主機這裡的id是不台一樣的，分別為1、2、3</span></span><br><span class="line">    num.network.threads=3</span><br><span class="line">    num.io.threads=8</span><br><span class="line">    socket.send.buffer.bytes=102400</span><br><span class="line">    socket.receive.buffer.bytes=102400</span><br><span class="line">    socket.request.max.bytes=104857600</span><br><span class="line">    log.dirs=/usr/local/kafka/logs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這裡改了日誌地址</span></span><br><span class="line">    num.partitions=1</span><br><span class="line">    num.recovery.threads.per.data.dir=1</span><br><span class="line">    log.retention.hours=168</span><br><span class="line">    log.segment.bytes=1073741824</span><br><span class="line">    log.retention.check.interval.ms=300000</span><br><span class="line">    zookeeper.connect=192.168.1.17:2181,192.168.1.15:2181,192.168.1.16:2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper集群內的所有地址都寫入</span></span><br><span class="line">    zookeeper.connection.timeout.ms=6000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件基本使用默認配置，之後會再查看配置文件詳細設置</span></span><br><span class="line">mkdir /usr/local/kafka/logs</span><br><span class="line">cd /usr/local/kafka/bin</span><br><span class="line">nohup ./kafka-server-start.sh ../config/server.properties &amp;</span><br><span class="line">ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 這時應該監聽了默認端口9092</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">192.168.1.17   kafka1</span><br><span class="line">192.168.1.15	kafka2</span><br><span class="line">192.168.1.16	kafka3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里添加可以让三台主机互相通过主机名解析</span></span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">    kafka1</span><br><span class="line">---------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建topic</span></span><br><span class="line">[root@kafka1 bin]# ./kafka-topics.sh --create --topic nginxlog --replication-factor 3 --partitions 3 --zookeeper 192.168.1.16:2181</span><br><span class="line">Created topic nginxlog.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为kafka1启动失败了，所以192.168.1.16变成了主节点</span></span><br></pre></td></tr></table></figure>
<h3 id="部署ElasticSearch"><a href="#部署ElasticSearch" class="headerlink" title="部署ElasticSearch"></a>部署ElasticSearch</h3><table>
<thead>
<tr>
<th>地址</th>
<th>服务</th>
<th>主机名/系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.19</td>
<td></td>
<td>elasticsearch1/CentOS8</td>
</tr>
<tr>
<td>192.168.1.20</td>
<td></td>
<td>elasticsearch2/CentOS8</td>
</tr>
<tr>
<td>192.168.1.18</td>
<td></td>
<td>elasticsearch3/CentOS8</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">---------------</span><br><span class="line">    三台主机</span><br><span class="line">---------------</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br><span class="line">chronyc</span><br><span class="line"><span class="meta">chronyc&gt;</span><span class="bash"> waitsync</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步三台主机时间</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装阿里源</span></span><br><span class="line">yum makecache</span><br><span class="line">yum install -y java-1.8.0-openjdk-devel</span><br><span class="line">ssh-keygen -t rsa -P ''</span><br><span class="line"><span class="meta">#</span><span class="bash"> elasticsearch1创建密钥</span></span><br><span class="line">ssh-copy-id -i root@192.168.1.20</span><br><span class="line">ssh-copy-id -i root@192.168.1.18</span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">    export JAVA_HOME=/usr</span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> elasticsearch1创建并发送到另外两台主机</span></span><br><span class="line">scp /etc/profile.d/java.sh root@192.168.1.20:/etc/profile.d/</span><br><span class="line">scp /etc/profile.d/java.sh root@192.168.1.18:/etc/profile.d/</span><br><span class="line">上传elasticsearch-6.5.4.rpm到三台主机</span><br><span class="line">yum install elasticsearch-6.5.4.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 三台主机安装</span></span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">	cluster.name: myelk</span><br><span class="line">    # 集群的名称，名称相同的主机就是处于同一个集群</span><br><span class="line">    node.name: node1</span><br><span class="line">    # 集群情况下，当前node的名字，每个node应该不一样。要将此文件复制到另两个节点</span><br><span class="line">    path.data: /elkdata/data</span><br><span class="line">    # 数据目录</span><br><span class="line">    path.logs: /elkdata/logs</span><br><span class="line">    # 日志目录</span><br><span class="line">    # bootstrap.memory_lock: true</span><br><span class="line">    # 服务启动时即锁定足够大的内存，提高效率。测试中如果打开此项，启动会失败，提示内存未锁定</span><br><span class="line">    network.host: 0.0.0.0</span><br><span class="line">    # 监听的地址</span><br><span class="line">    http.port: 9200</span><br><span class="line">    # 客户端访问端口</span><br><span class="line">    discovery.zen.ping.unicast.hosts: ["192.168.1.19", "192.168.1.20", "192.168.1.18"]</span><br><span class="line">    # 组播范围</span><br><span class="line">    discovery.zen.minimum_master_nodes: 2</span><br><span class="line">    # 设置此项为了必免脑裂，这里的数字是总节点数除以2加1算出来的。</span><br><span class="line">scp /etc/elasticsearch/elasticsearch.yml root@192.168.1.20:/etc/elasticsearch/</span><br><span class="line">scp /etc/elasticsearch/elasticsearch.yml root@192.168.1.18:/etc/elasticsearch/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将配置文件发送到另外两台主机</span></span><br><span class="line">vim /etc/elasticsearch/jvm.options</span><br><span class="line">    -Xms1g  # 初始化的堆内存</span><br><span class="line">    -Xmx1g  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大堆内存，可以改大此值。这两个值要保持一致。或将上面配置文件中的bootstrap.memory_lock的值改为<span class="literal">false</span></span></span><br><span class="line">mkdir /elkdata/&#123;data,logs&#125; -pv</span><br><span class="line"><span class="meta">#</span><span class="bash"> 三台主机创建数据和日志目录</span></span><br><span class="line">chown -R elasticsearch.elasticsearch /elkdata/</span><br><span class="line">systemctl start elasticsearch.service</span><br><span class="line">systemctl status elasticsearch.service</span><br><span class="line">ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动会有一些慢，要等一会儿才能看到监听了9200和9300端口</span></span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line">    elasticsearch1</span><br><span class="line">-----------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装elasticsearch-head插件</span></span><br><span class="line">yum install -y git</span><br><span class="line">git clone git://github.com/mobz/elasticsearch-head.git</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载elasticsearch-head插件，这个插件是为了实现简单的集群监控、主机信息显示和管理等功能</span></span><br><span class="line">yum install epel-release.noarch</span><br><span class="line">yum install -y npm</span><br><span class="line">cd elasticsearch-head/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里一定要到这个目录下再启动插件才能启动，不然会报错</span></span><br><span class="line">npm install grunt -save</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里可能会有报错<span class="string">"npm: relocation error: npm: symbol SSL_set_cert_cb, version libssl.so.10 not defined in file libssl.so.10 with link time reference"</span>，需要安装openssl即可解决。</span></span><br><span class="line">npm install</span><br><span class="line">npm run start &amp;</span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">    #---------------------------------- http --------------------------------</span><br><span class="line">    http.cors.enabled: true     # 打开http功能</span><br><span class="line">    http.cors.allow-origin: "*"     # 允许谁访问</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置elasticsearch允许远程访问</span></span><br><span class="line">systemctl restart elasticsearch</span><br><span class="line">systemctl enable elasticsearch.service</span><br></pre></td></tr></table></figure>
<h3 id="部署logstash"><a href="#部署logstash" class="headerlink" title="部署logstash"></a>部署logstash</h3><table>
<thead>
<tr>
<th>地址</th>
<th>服务</th>
<th>主机名/系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.14:9600</td>
<td>logstash-6.5.4.rpm</td>
<td>nwps/CentOS8</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 上传logstash-6.5.4.rpm到服务器上</span></span><br><span class="line">yum -y install java-1.8.0-openjdk-devel</span><br><span class="line">vim /etc/profile.d/java.sh</span><br><span class="line">export JAVA_HOME=/usr</span><br><span class="line">. /etc/profile.d/java.sh</span><br><span class="line">yum -y install logstash-6.5.4.rpm</span><br><span class="line">systemctl start logstash</span><br><span class="line">systemctl enable logstash</span><br><span class="line">/usr/share/logstash/bin/logstash -e "input&#123;stdin&#123;&#125;&#125; output&#123;stdout&#123; codec =&gt; "rydebug"&#125;&#125;"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试时会提示找不到rydebug模块，无法加载。这里是否应该为rubydebug，未测试。使用下面的配置文件是没有</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 问题的。启动后会监听9600端口</span></span><br><span class="line">vim /etc/logstash/conf.d/system.conf   # 这个配置文件只作为测试使用</span><br><span class="line">    input &#123;</span><br><span class="line">        file&#123;</span><br><span class="line">            type =&gt; "messagelog"</span><br><span class="line">            path =&gt; "/var/log/messages"</span><br><span class="line">            start_position =&gt; "beginning"   # 首次从头收集</span><br><span class="line">        &#125;</span><br><span class="line">        # 从文件输入，类型是messagelog，写明路径，最后指定从头收集</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    output &#123;</span><br><span class="line">        file &#123;</span><br><span class="line">            path =&gt; "/tmp/123.txt"</span><br><span class="line">        &#125;</span><br><span class="line">        # 输出到一个文件，用file引导，下面写明路径。</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; ["192.168.1.20:9200"]    # 指定第一台elaticsearch地址即可。</span><br><span class="line">            index =&gt; "system-messages-%&#123;+YYYY.MM.dd&#125;"   # 索引的命名规则，后面加入日期</span><br><span class="line">        &#125;</span><br><span class="line">        # 输出到elasticsearch，写明地址，索引的名称</span><br><span class="line">    &#125;</span><br><span class="line">/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf -t</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-f指定配置文件，-t表示测试配置文件是否正确</span></span><br><span class="line">chmod 644 /var/log/messages</span><br><span class="line"><span class="meta">#</span><span class="bash"> 让普通用户可以读系统日志</span></span><br><span class="line">systemctl start logstash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动logstash。也可以使用/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf在前台启动</span></span><br><span class="line">tail -f /tmp/123.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以看到输出的日志文件了</span></span><br><span class="line">访问192.168.1.19:9100，在其中的数据浏览中修改上方的连接地址为第一台elasticsearch的地址，之后就可以看到一个叫system-messages-2019.01.24的索引了</span><br></pre></td></tr></table></figure>
<h3 id="修改nginx配置"><a href="#修改nginx配置" class="headerlink" title="修改nginx配置"></a>修改nginx配置</h3><table>
<thead>
<tr>
<th>地址</th>
<th>服务</th>
<th>主机名/系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.14</td>
<td>nginx</td>
<td>nwps/CentOS8</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@nwps ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    log_format access1 '&#123;"@timestamp":"$time_iso8601",'</span><br><span class="line">                         '"host":"$server_addr",'</span><br><span class="line">                         '"clientip":"$remote_addr",'</span><br><span class="line">                         '"size":$body_bytes_sent,'</span><br><span class="line">                         '"responsetime":$request_time,'</span><br><span class="line">                         '"upstreamtime":"$upstream_response_time",'</span><br><span class="line">                         '"upstreamhost":"$upstream_addr",'</span><br><span class="line">                         '"http_host":"$host",'</span><br><span class="line">                         '"url":"$uri",'</span><br><span class="line">                         '"domain":"$host",'</span><br><span class="line">                         '"xff":"$http_x_forwarded_for",'</span><br><span class="line">                         '"referer":"$http_referer",'</span><br><span class="line">                         '"status":"$status"&#125;';</span><br><span class="line">	server &#123;</span><br><span class="line">		...</span><br><span class="line">        access_log  /var/log/nginx/host.access.log  access1;</span><br><span class="line">        # 在server中加入此条，记录访问wordpress的日志</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置日志格式为Json格式。相对普通日志格式,json易于识别,每个值都有与其相对于的key,易于提取日志内容及方便后续进一步对日志的分析。可以到http://www.kjson.com/上验证Json格式是否正确。</span></span><br><span class="line">[root@nginx1 ~]# nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line">[root@nginx1 ~]# nginx -s reload</span><br></pre></td></tr></table></figure>
<h3 id="安装配置filebeat"><a href="#安装配置filebeat" class="headerlink" title="安装配置filebeat"></a>安装配置filebeat</h3><table>
<thead>
<tr>
<th>地址</th>
<th>服务</th>
<th>主机名/系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.14</td>
<td>filebeat-6.5.4</td>
<td>nwps/CentOS8</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 上传filebeat-6.5.4.rpm到主机</span></span><br><span class="line">vim /etc/filebeat/filebeat.yml</span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/host.access.log</span><br><span class="line">  fields:</span><br><span class="line">    log_topics: nginxlog</span><br><span class="line">    json.keys_under_root: true</span><br><span class="line">    json.overwrite_keys: true</span><br><span class="line"> </span><br><span class="line">output.kafka:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: ["192.168.1.17:9092"]</span><br><span class="line">  topic: '%&#123;[fields][log_topics]&#125;'</span><br><span class="line">  partition.round_robin:</span><br><span class="line">  reachable_only: false</span><br><span class="line">  compression: gzip</span><br><span class="line">  max_message_bytes: 1000000</span><br><span class="line">  required_acks: 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置输出到kafka中</span></span><br><span class="line">/usr/share/filebeat/bin/filebeat -e -c /etc/filebeat/filebeat.yml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在前台启动，查看效果</span></span><br><span class="line">systemctl start filebeat</span><br><span class="line">systemctl enable filebeat</span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">    kafka1</span><br><span class="line">---------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到第一台kafka查看效果</span></span><br><span class="line">scp /etc/hosts root@192.168.1.14:/etc</span><br><span class="line"><span class="meta">#</span><span class="bash"> filebeat主机需要可以通过主机名解析kafka的地址，不然下面命令启动filebeat后虽然能收到信息，但会报错</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解析不了kafka的地址。</span></span><br><span class="line">./kafka-console-consumer.sh --bootstrap-server 192.168.1.17:9092 --topic nginxlog --from-beginning</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这条命令可以在前台监控发送过来的消息</span></span><br><span class="line">找一台主机访问nginx主机的wordpress页面，可以用curl访问多次，这时应该可以看到kafka上有发过来的信息</span><br></pre></td></tr></table></figure>
<h3 id="配置logstash"><a href="#配置logstash" class="headerlink" title="配置logstash"></a>配置logstash</h3><table>
<thead>
<tr>
<th>地址</th>
<th>服务</th>
<th>主机名/系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.14:9600</td>
<td>logstash-6.5.4.rpm</td>
<td>nwps/CentOS8</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 这台logstash的作用是消息kafka中的消息，创建了和topic一样名称的消费者组</span></span><br><span class="line">[root@nwps ~]# mv /etc/logstash/conf.d/system.conf&#123;,.bak&#125;</span><br><span class="line">[root@nwps ~]# vim /etc/logstash/conf.d/nginx.conf</span><br><span class="line">input &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">         type =&gt; "nginxlog"</span><br><span class="line">         topics =&gt; ["nginxlog"]</span><br><span class="line">         bootstrap_servers =&gt; ["192.168.1.17:9092"]</span><br><span class="line">         group_id =&gt; "nginxlog"   # 在kafka中创建的组名</span><br><span class="line">         auto_offset_reset =&gt; latest</span><br><span class="line">         codec =&gt; "json"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    if [type] == "nginxlog" &#123;</span><br><span class="line">         grok &#123;</span><br><span class="line">             match =&gt; &#123;"message" =&gt; "%&#123;COMBINEDAPACHELOG&#125;"&#125;</span><br><span class="line">             remove_field =&gt; "message"</span><br><span class="line">         &#125;</span><br><span class="line">         date &#123;</span><br><span class="line">             match =&gt; ["timestamp" , "dd/MMM/YYYY:HH:mm:ss Z"]</span><br><span class="line">         &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">        geoip &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">            <span class="built_in">source</span> =&gt; <span class="string">"clientip"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">            target =&gt; <span class="string">"geoip"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">            database =&gt; <span class="string">"/etc/logstash/conf.d/GeoLite2-City.mmdb"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">            add_field =&gt; [<span class="string">"[geoip][coordinates]"</span>, <span class="string">"%&#123;[geoip][longitude]&#125;"</span>]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">            add_field =&gt; [<span class="string">"[geoip][coordinates]"</span>, <span class="string">"%&#123;[geoip][latitude]&#125;"</span>]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        &#125;   <span class="comment"># 注释这段有点问题，未查看具体原因</span></span></span><br><span class="line">         mutate &#123;</span><br><span class="line">             convert =&gt; ["[geoip][coordinates]", "float"]</span><br><span class="line">         &#125;</span><br><span class="line">         useragent &#123;</span><br><span class="line">             source =&gt; "agent"</span><br><span class="line">             target =&gt; "userAgent"</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    if [type] == 'nginxlog' &#123;</span><br><span class="line">         elasticsearch &#123;</span><br><span class="line">             hosts =&gt; ["http://192.168.1.19:9200"]</span><br><span class="line">             index =&gt; "logstash-nginxlog-%&#123;+YYYY.MM.dd&#125;"</span><br><span class="line">         &#125;</span><br><span class="line">         stdout &#123;codec =&gt; rubydebug&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@nwps ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在前台启动，查看效果。如果正常的话，应该可以看到被消费的信息在前台打印出来。类似下面这样：</span></span><br><span class="line">&#123;</span><br><span class="line">    "@timestamp" =&gt; 2020-01-27T16:41:36.459Z,</span><br><span class="line">       "message" =&gt; "&#123;\"@timestamp\":\"2020-01-28T00:41:36+08:00\",\"host\":\"192.168.1.14\",\"clientip\":\"192.168.1.109\",\"size\":\"185\",\"responsetime\":\"0.000\",\"upstreamtime\":\"-\",\"upstreamhost\":\"-\",\"http_host\":\"192.168.1.14\",\"url\":\"/wordpress\",\"domain\":\"192.168.1.14\",\"xff\":\"-\",\"referer\":\"-\",\"status\":\"301\"&#125;",</span><br><span class="line">        "source" =&gt; "/var/log/nginx/host.access.log",</span><br><span class="line">        "offset" =&gt; 2514148,</span><br><span class="line">        "fields" =&gt; &#123;</span><br><span class="line">        "log_topics" =&gt; "nginxlog",</span><br><span class="line">              "json" =&gt; &#123;</span><br><span class="line">             "overwrite_keys" =&gt; true,</span><br><span class="line">            "keys_under_root" =&gt; true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">          "host" =&gt; &#123;</span><br><span class="line">        "name" =&gt; "nwps"</span><br><span class="line">    &#125;,</span><br><span class="line">      "@version" =&gt; "1",</span><br><span class="line">          "tags" =&gt; [</span><br><span class="line">        [0] "_grokparsefailure"</span><br><span class="line">    ],</span><br><span class="line">          "type" =&gt; "nginxlog",</span><br><span class="line">          "beat" =&gt; &#123;</span><br><span class="line">            "name" =&gt; "nwps",</span><br><span class="line">        "hostname" =&gt; "nwps",</span><br><span class="line">         "version" =&gt; "6.5.4"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">    kafka1</span><br><span class="line">---------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到第一台kafka查看效果</span></span><br><span class="line">[root@kafka1 bin]# ./kafka-consumer-groups.sh --bootstrap-server 192.168.1.17:9092 --group nginxlog --describe</span><br><span class="line"></span><br><span class="line">TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                     HOST            CLIENT-ID</span><br><span class="line">nginxlog        0          5407            5407            0               logstash-0-719c3537-8c50-472d-aa3b-ab0e6f3d8498 /192.168.1.14   logstash-0</span><br><span class="line">nginxlog        1          5406            5406            0               logstash-0-719c3537-8c50-472d-aa3b-ab0e6f3d8498 /192.168.1.14   logstash-0</span><br><span class="line">nginxlog        2          5405            5405            0               logstash-0-719c3537-8c50-472d-aa3b-ab0e6f3d8498 /192.168.1.14   logstash-0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看kafka的消息堆积情况，可以加上watch命令。不知是否与上面提到的hosts文件是否有关，最好加上可以解析</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kafka主机名。这里的kafka的组名是在logstash的配置文件中创建的。</span></span><br></pre></td></tr></table></figure>
<h3 id="安装配置kibana"><a href="#安装配置kibana" class="headerlink" title="安装配置kibana"></a>安装配置kibana</h3><table>
<thead>
<tr>
<th>地址</th>
<th>服务</th>
<th>主机名/系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.14:5601</td>
<td>kibana-6.5.4.rpm</td>
<td>nwps/CentOS8</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 上传kibana-6.5.4.rpm到主机</span></span><br><span class="line">yum install -y kibana-6.5.4-x86_64.rpm</span><br><span class="line">vim /etc/kibana/kibana.yml</span><br><span class="line">    server.port: 5601</span><br><span class="line">    server.host: "localhost"   # 这里是监听的地址</span><br><span class="line">    elasticsearch.url: "http://192.168.1.19:9200"   # 调用elasticsearch的接口，写一个就可以</span><br><span class="line">systemctl start kibana</span><br><span class="line">vim /etc/nginx/conf.d/kibana.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.kibana.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">         proxy_pass http://localhost:5601;</span><br><span class="line">         proxy_http_version 1.1;</span><br><span class="line">         proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">         proxy_set_header Connection 'upgrade';</span><br><span class="line">         proxy_set_header Host $host;</span><br><span class="line">         proxy_cache_bypass $http_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">nginx -s reload</span><br><span class="line">本地添加hosts文件，可以解析test.kibana.com到192.168.1.14</span><br><span class="line">访问test.kibana.com</span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line">   给nginx开启认证功能</span><br><span class="line">-----------------------</span><br><span class="line">yum install -y httpd-tools</span><br><span class="line">htpasswd -bc /etc/nginx/conf.d/htpasswd.users kibanauser centos</span><br><span class="line">vim /etc/nginx/conf.d/kibana.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.kibana.com;</span><br><span class="line">    auth_basic "Restricted Access";</span><br><span class="line">    auth_basic_user_file /etc/nginx/conf.d/htpasswd.users;</span><br><span class="line">    location / &#123;</span><br><span class="line">         proxy_pass http://localhost:5601;</span><br><span class="line">         proxy_http_version 1.1;</span><br><span class="line">         proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">         proxy_set_header Connection 'upgrade';</span><br><span class="line">         proxy_set_header Host $host;</span><br><span class="line">         proxy_cache_bypass $http_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/20/转：Shell中的IFS解惑/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/20/转：Shell中的IFS解惑/" itemprop="url">
                  转：Shell中的IFS解惑
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-20 15:31:22" itemprop="dateCreated datePublished" datetime="2020-01-20T15:31:22+08:00">2020-01-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="转：Shell中的IFS解惑"><a href="#转：Shell中的IFS解惑" class="headerlink" title="转：Shell中的IFS解惑"></a>转：Shell中的IFS解惑</h3><p>原文链接：<a href="https://blog.csdn.net/whuslei/article/details/7187639" target="_blank" rel="noopener">https://blog.csdn.net/whuslei/article/details/7187639</a></p>
<h4 id="一、IFS-介绍"><a href="#一、IFS-介绍" class="headerlink" title="一、IFS 介绍"></a>一、IFS 介绍</h4><p>​    Shell 脚本中有个变量叫 IFS(Internal Field Seprator) ，内部域分隔符。完整定义是The shell uses the value stored in IFS, which is the space, tab, and newline characters by default, to delimit words for the read and set commands, when parsing output from command substitution, and when performing variable substitution.</p>
<p>​    Shell 的环境变量分为 set, env 两种，其中 set 变量可以通过 export 工具导入到 env 变量中。其中，set 是显示设置shell变量，仅在本 shell 中有效；env 是显示设置用户环境变量 ，仅在当前会话中有效。换句话说，set 变量里包含了 env 变量，但 set 变量不一定都是 env 变量。这两种变量不同之处在于变量的作用域不同。显然，env 变量的作用域要大些，它可以在 subshell 中使用。</p>
<p>​    而 IFS 是一种 set 变量，当 shell 处理”命令替换”和”参数替换”时，shell 根据 IFS 的值，默认是 space, tab, newline 来拆解读入的变量，然后对特殊字符进行处理，最后重新组合赋值给该变量。</p>
<h4 id="二、IFS-简单实例"><a href="#二、IFS-简单实例" class="headerlink" title="二、IFS 简单实例"></a>二、IFS 简单实例</h4><ol>
<li>查看变量 IFS 的值。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="variable">$IFS</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"<span class="variable">$IFS</span>"</span> | od -b</span></span><br><span class="line">0000000 040 011 012 012</span><br><span class="line">0000004</span><br><span class="line"><span class="meta">#</span><span class="bash"> 直接输出IFS是看不到的，把它转化为二进制就可以看到了，<span class="string">"040"</span>是空格，<span class="string">"011"</span>是Tab，<span class="string">"012"</span>是换行符<span class="string">"\n"</span> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 。最后一个 012 是因为 <span class="built_in">echo</span> 默认是会换行的。</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>$* 和 $@ 的细微差别</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 从下面的例子中可以看出，如果是用冒号引起来，表示这个变量不用IFS替换！！所以可以看到这个变量的<span class="string">"原始</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 值<span class="string">"。反之，如果不加引号，输出时会根据IFS的值来分割后合并输出！ $* 是按照IFS中的第一个值来确定的！下</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 面这两个例子还有细微的差别！</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> IFS=:;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">set</span> x y z</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> $*</span></span><br><span class="line">x y z</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"$*"</span></span></span><br><span class="line">x:y:z</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="variable">$@</span></span></span><br><span class="line">x y z</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"<span class="variable">$@</span>"</span></span></span><br><span class="line">x y z</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上例 <span class="built_in">set</span> 变量其实是3个参数，而下面这个例子实质是2个参数，即 <span class="built_in">set</span> <span class="string">"x y z"</span>  和 <span class="built_in">set</span> x y z 是完全不同的。</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">set</span> <span class="string">"x"</span> <span class="string">"y z"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> $*</span></span><br><span class="line">x y z</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"$*"</span></span></span><br><span class="line">x:y z</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="variable">$@</span></span></span><br><span class="line">x y z</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"<span class="variable">$@</span>"</span></span></span><br><span class="line">x y z</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> $* |od -b</span></span><br><span class="line">0000000 170 040 171 040 172 012</span><br><span class="line">0000006</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"$*"</span> |od -b</span></span><br><span class="line">0000000 170 072 171 040 172 012</span><br><span class="line">0000006</span><br><span class="line"><span class="meta">#</span><span class="bash"> 小结：$* 会根据 IFS 的不同来组合值，而 <span class="variable">$@</span> 则会将值用<span class="string">" "</span>来组合值！</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>for 循环中的奇怪现象</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="variable">$var</span> ;<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$x</span> |od -b ;<span class="keyword">done</span></span></span><br><span class="line">0000000 012</span><br><span class="line">0000001</span><br><span class="line">0000000 040 141 012</span><br><span class="line">0000003</span><br><span class="line">0000000 142 012</span><br><span class="line">0000002</span><br><span class="line">0000000 012</span><br><span class="line">0000001</span><br><span class="line">0000000 143 012</span><br><span class="line">0000002</span><br><span class="line"><span class="meta">#</span><span class="bash"> ob命令表示转换为二进制</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 先暂且不解释 <span class="keyword">for</span> 循环的内容！看下面这个输出！IFS 的值同上！ var=<span class="string">": a:b::c:"</span>，</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="variable">$var</span> |od -b</span></span><br><span class="line">0000000 040 040 141 040 142 040 040 143 012</span><br><span class="line">0000011</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"<span class="variable">$var</span>"</span> |od -b</span></span><br><span class="line">0000000 072 040 141 072 142 072 072 143 072 012</span><br><span class="line">0000012</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"<span class="variable">$var</span>"</span>的值应该没做替换，所以还是 <span class="string">": a:b::c:"</span> (注 <span class="string">"072"</span> 表示冒号)，但是<span class="variable">$var</span> 则发生了变化！注意输</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 出的最后一个冒号没有了，也没有替换为空格！Why？</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 <span class="variable">$var</span> 时是经历了这样一个过程！首先，按照这样的规则 [变量][IFS][变量][IFS]……根据原始 var 值中</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 所有的分割符(此处是<span class="string">":"</span>)划分出变量，如果IFS的值是有多个字符组成，如IFS=<span class="string">":;"</span>，那么此处的[IFS]指的是</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IFS中的任意一个字符($* 是按第一个字符来分隔！)，如 <span class="string">":"</span> 或者 <span class="string">";"</span> ，后面不再对[IFS]做类似说明！(注：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [IFS]会有多个值，多亏 <span class="comment">#blackold 的提醒)；然后，得到类似这样的 list， ""   " a"   "b"  ""  </span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"c"</span>  。如果此时 <span class="built_in">echo</span> <span class="variable">$var</span>，则需要在这些变量之间用空格隔开，也就是<span class="string">""</span>  [space]   <span class="string">"  a"</span>  [space]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"b"</span> [space]  <span class="string">""</span> [space]  <span class="string">"c"</span> ，忽略掉空值，最终输出是 [space][space]a[space]b[space]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [space]c ！</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果最后一个字符不是分隔符，如 var=<span class="string">"a:b"</span>，那么最后一个分隔符后的变量就是最后一个变量！</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个地方要注意下！！如果IFS就是空格，那么类似于<span class="string">" [space][space]a[space]b[space][space]c "</span>会合</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 并重复的部分，且去头空格，去尾空格，那么最终输出会变成类似 a[space]b[space]c ，所以，如果IFS是默认</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 值，那么处理的结果就很好算出来，直接合并、忽略多余空格即可！</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 另外，$* 和 <span class="variable">$@</span> 在函数中的处理过程是这样的(只考虑<span class="string">"原始值"</span>！)！<span class="string">"<span class="variable">$@</span>"</span>，就是像上面处理后赋值，但是 <span class="string">"$*"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 却不一样！它的值是用分隔符(如<span class="string">":"</span>)而不是空格隔开！具体例子见最后一个例子！</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 好了，现在来解释 <span class="keyword">for</span> 循环的内容。<span class="keyword">for</span> 循环遍历上面这个列表就可以了，所以 <span class="keyword">for</span> 循环的第一个输出是空！</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (<span class="string">"012"</span>是<span class="built_in">echo</span>输出的换行符 )。。。。后面的依次类推！不信可以试试下面这个例子，结果是一样的！</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">""</span> <span class="string">" a"</span> <span class="string">"b"</span> <span class="string">""</span> <span class="string">"c"</span> ;<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$x</span> |od -b ;<span class="keyword">done</span></span></span><br><span class="line">0000000 012</span><br><span class="line">0000001</span><br><span class="line">0000000 040 141 012</span><br><span class="line">0000003</span><br><span class="line">0000000 012</span><br><span class="line">0000001</span><br><span class="line">0000000 142 012</span><br><span class="line">0000002</span><br><span class="line">0000000 012</span><br><span class="line">0000001</span><br><span class="line">0000000 143 012</span><br><span class="line">0000002</span><br></pre></td></tr></table></figure>
<h4 id="三、IFS的其他实例"><a href="#三、IFS的其他实例" class="headerlink" title="三、IFS的其他实例"></a>三、IFS的其他实例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">Example 1:</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> IFS=:</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> var=ab::<span class="built_in">cd</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="variable">$var</span></span></span><br><span class="line">ab  cd</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"<span class="variable">$var</span>"</span></span></span><br><span class="line">ab::cd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解释下：x 的值是 <span class="string">"ab::cd"</span>，当进行到 <span class="built_in">echo</span> <span class="variable">$x</span> 时，因为$符，所以会进行变量替换。Shell 根据 IFS 的</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 值将 x 分解为 ab <span class="string">""</span> <span class="built_in">cd</span>，然后<span class="built_in">echo</span>，插入空隔，ab[space]<span class="string">""</span>[space]<span class="built_in">cd</span>，忽略<span class="string">""</span>，输出  ab  <span class="built_in">cd</span> 。</span></span><br><span class="line"></span><br><span class="line">Example 2 :</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">read</span> a</span></span><br><span class="line">		xy  z</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="variable">$a</span></span></span><br><span class="line">xy  z</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解释：这是 http://bbs.chinaunix.net/thread-207178-1-1.html 上的一个例子。此时IFS是默认值，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本希望把所有的输入(包括空格)都放入变量a中，但是输出的a却把前面的空格给忽略了！！原因是：默认的 IFS </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会按space tab newline 来分割。这里需要注意的一点是，<span class="built_in">read</span> 命令的实现过程，即在读入时已经替换了。解</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 决办法是在开头加上一句 IFS=<span class="string">";"</span> ，这里必须加上双引号，因为分号有特殊含义。</span></span><br><span class="line"></span><br><span class="line">Example 3 :</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> tmp=<span class="string">"   xy z"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> a=<span class="variable">$tmp</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="variable">$a</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"<span class="variable">$a</span>"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解释：什么时候会根据 IFS 来<span class="string">"处理"</span>呢？我觉得是，对于不加引号的变量，使用时都会参考IFS，但是要注意其原始值！</span></span><br><span class="line"></span><br><span class="line">Example 4 ：</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">IFS_old=$IFS      #将原IFS值保存，以便用完后恢复</span><br><span class="line">IFS=$’\n’        #更改IFS值为$’\n’ ，注意，以回车做为分隔符，IFS必须为：$’\n’</span><br><span class="line">for i in $((cat pwd.txt)) #pwd.txt 来自这个命令：cat /etc/passwd &gt;pwd.txt</span><br><span class="line">do</span><br><span class="line">    echo $i</span><br><span class="line">done</span><br><span class="line">IFS=$IFS_old      #恢复原IFS值</span><br><span class="line"><span class="meta">#</span><span class="bash"> 另外一个例子，把IP地址逆转输出：</span></span><br><span class="line"></span><br><span class="line">Example 5 :</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">IP=220.112.253.111</span><br><span class="line">IFS="."</span><br><span class="line">TMPIP=$(echo $IP)</span><br><span class="line">IFS=" " # space</span><br><span class="line">echo $TMPIP</span><br><span class="line">for x in $TMPIP ;do </span><br><span class="line">    Xip="$&#123;x&#125;.$Xip"</span><br><span class="line">done</span><br><span class="line">echo $&#123;Xip%.&#125;</span><br><span class="line"></span><br><span class="line">Complex_Example 1:  http://bbs.chinaunix.net/forum.php?mod=viewthread&amp;tid=3660898&amp;page=1#pid21798049</span><br><span class="line"></span><br><span class="line">function output_args_ifs()&#123;</span><br><span class="line">    echo "=$*"</span><br><span class="line">    echo "="$*</span><br><span class="line">    for m in $* ;do </span><br><span class="line">        echo "[$m]"</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">IFS=':'</span><br><span class="line">var='::a:b::c:::'</span><br><span class="line">output_args_ifs $var</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出为：</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> =::a:b::c::  <span class="comment"># 少了最后一个冒号！看前面就知道为什么了</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> =  a b  c </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [][]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [a][b]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [][c]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> []</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 由于 <span class="string">"output_args_ifs <span class="variable">$var</span>"</span> 中 <span class="variable">$var</span> 没有加引号，所以根据IFS替换！根据IFS划分出变量： <span class="string">""</span>  <span class="string">""</span> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"a"</span>  <span class="string">"b"</span>  <span class="string">""</span>  <span class="string">"c"</span> <span class="string">""</span> <span class="string">""</span>(可以通过输出 <span class="variable">$#</span> 来测试参数的个数！)，重组的结果为:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="string">"<span class="variable">$@</span>"</span> 的值是  <span class="string">""</span> [space] <span class="string">""</span> [space]  <span class="string">"a"</span> [space]  <span class="string">"b"</span>  [space] <span class="string">""</span> [space]  <span class="string">"c"</span> [space] </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">""</span> [space] <span class="string">""</span>，可以通过，<span class="built_in">echo</span>==&gt;<span class="string">"  a b  c   "</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"$*"</span> 的值是   <span class="string">""</span> [IFS] <span class="string">""</span> [IFS]  <span class="string">"a"</span> [IFS]  <span class="string">"b"</span>  [IFS] <span class="string">""</span> [IFS]  <span class="string">"c"</span> [IFS] <span class="string">""</span> [IFS] </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">""</span>，忽略<span class="string">""</span>，<span class="built_in">echo</span>=&gt;<span class="string">"::a:b::c::"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意， $* 和 <span class="variable">$@</span> 的值都是  <span class="string">""</span>   <span class="string">""</span>   <span class="string">"a"</span>   <span class="string">"b"</span>   <span class="string">""</span>   <span class="string">"c"</span>  <span class="string">""</span>  <span class="string">""</span> 。可以说是一个列表……因为他</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 们本来就是由 <span class="variable">$1</span> <span class="variable">$2</span> <span class="variable">$3</span>……组成的。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 所以，《Linux程序设计》里推荐使用 <span class="variable">$@</span>，而不是$*</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 总结：IFS 其实还是很麻烦的，稍有不慎就会产生很奇怪的结果，因此使用的时候要注意！我也走了不少弯路，只希</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 望能给后来者一些帮助。本文若有问题，欢迎指正！！谢谢！</span></span><br></pre></td></tr></table></figure>
<p>如有转载，请注明blog.csdn.net/whuslei<br>参考：<br><a href="http://blog.chinaunix.net/space.php?uid=20543672&amp;do=blog&amp;id=94358" target="_blank" rel="noopener">http://blog.chinaunix.net/space.php?uid=20543672&amp;do=blog&amp;id=94358</a><br><a href="http://smilejay.com/2011/12/bash_ifs/#comment-51" target="_blank" rel="noopener">http://smilejay.com/2011/12/bash_ifs/#comment-51</a><br>(全文完)</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/20/使用set分隔字符/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/20/使用set分隔字符/" itemprop="url">
                  使用set分隔字符
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-20 15:24:46" itemprop="dateCreated datePublished" datetime="2020-01-20T15:24:46+08:00">2020-01-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 将时间格式的字符串转为秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">d="00:20:40.28"</span><br><span class="line">IFS=":"</span><br><span class="line">set -- $d</span><br><span class="line">hr=$(($1*3600))</span><br><span class="line">min=$(($2*60))</span><br><span class="line">sec=$&#123;3%.*&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 百分号的含意：<span class="variable">$&#123;string%substring&#125;</span>：从变量<span class="variable">$string</span>的结尾, 删除最短匹配<span class="variable">$substring</span>的子串。这里的<span class="variable">$3</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 就是40，所以是取消40以后的所有部分，也就是<span class="string">".28"</span>。</span></span><br><span class="line">echo "total secs: $((hr+min+sec))"</span><br><span class="line"></span><br><span class="line">bash -x test1.sh</span><br><span class="line">输出：</span><br><span class="line">+ d=00:20:40</span><br><span class="line">+ IFS=:</span><br><span class="line">+ set -- 00 20 40</span><br><span class="line">+ hr=0</span><br><span class="line">+ min=1200</span><br><span class="line">+ sec=40</span><br><span class="line">+ echo 'total secs: 1240'</span><br><span class="line">total secs: 1240</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到，<span class="built_in">set</span>会以IFS为分隔符，将d的内容重新分隔。另外，<span class="built_in">set</span>后的--表示选项的结束，后面的都当做参数处理而不是选项。例：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> -- -e hello和<span class="built_in">echo</span> -e hello是不一样的，前者-e是一个普通参数，后者-e则是一个选项</span></span><br></pre></td></tr></table></figure>
<h3 id="IFS介绍"><a href="#IFS介绍" class="headerlink" title="IFS介绍"></a>IFS介绍</h3><p>​    Shell 脚本中有个变量叫 IFS(Internal Field Seprator) ，内部域分隔符。完整定义是The shell uses the value stored in IFS, which is the space, tab, and newline characters by default, to delimit words for the read and set commands, when parsing output from command substitution, and when performing variable substitution.</p>
<p>​    Shell 的环境变量分为 set, env 两种，其中 set 变量可以通过 export 工具导入到 env 变量中。其中，set 是显示设置shell变量，仅在本 shell 中有效；env 是显示设置用户环境变量 ，仅在当前会话中有效。换句话说，set 变量里包含了 env 变量，但 set 变量不一定都是 env 变量。这两种变量不同之处在于变量的作用域不同。显然，env 变量的作用域要大些，它可以在 subshell 中使用。</p>
<p>​    而 IFS 是一种 set 变量，当 shell 处理”命令替换”和”参数替换”时，shell 根据 IFS 的值，默认是 space, tab, newline 来拆解读入的变量，然后对特殊字符进行处理，最后重新组合赋值给该变量。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/15/jq命令使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/15/jq命令使用/" itemprop="url">
                  jq命令使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-01-15 12:39:20" itemprop="dateCreated datePublished" datetime="2020-01-15T12:39:20+08:00">2020-01-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="命令使用案例"><a href="#命令使用案例" class="headerlink" title="命令使用案例"></a>命令使用案例</h3><ul>
<li>基本使用</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat abc.json|jq .</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不要少了最后的点，这是用cat打开一个json文件，再传给jq命令，输出一个更好的格式</span></span><br></pre></td></tr></table></figure>
<ul>
<li>获取某个key的值</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat abc.json|jq '.children'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 取出json文件中的children字段下的内容</span></span><br><span class="line"></span><br><span class="line">cat abc.json|jq '.children|.[].metadata_public|.channelID'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用管道符取出多个字段，但要注意字段在json文件中是否是在[]中的，如果是，要加上.[]</span></span><br><span class="line"></span><br><span class="line">cat abc.json|jq '.children|.[].metadata_public|.channelID + "," + .channelName'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 还可以使用加号拼接字段，并且如果再次取相同位置的字段，可以直接写字段的名称</span></span><br><span class="line"></span><br><span class="line">cat abc.json|jq '.children|.[].metadata_public|.channelID + "," + .[].channelName'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不要这样使用，因为再次取值时，使用了.[]，这会造成第一个字段与第二个字段的笛卡尔乘积</span></span><br><span class="line"></span><br><span class="line">cat abc.json|jq '.children|.[].metadata_public|.channelID + "," + .channelName？'</span><br><span class="line"><span class="meta">#</span><span class="bash"> ? 规则适合所有正确的 filter，在 filter 最后加上 ? 可以忽略错误信息</span></span><br></pre></td></tr></table></figure>
<ul>
<li>keys</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat abc.json|jq keys</span><br><span class="line"><span class="comment"># 取出所有key组成数组</span></span><br></pre></td></tr></table></figure>
<ul>
<li>.[]</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat abc.json|jq .[]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 所有的 value</span></span><br></pre></td></tr></table></figure>
<ul>
<li>[.[]]</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat abc.json|jq [.[]]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 所有的 value 组成的数组</span></span><br></pre></td></tr></table></figure>
<ul>
<li>索引</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat abc.json|jq .[1]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 取第2个字段的值</span></span><br><span class="line"></span><br><span class="line">cat abc.json|jq .[0:2]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 取第1和2个字段的值</span></span><br></pre></td></tr></table></figure>
<ul>
<li>比如取出数组元素中 name 的值</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo '[&#123;"name": "foo"&#125;,&#123;"name": "bar"&#125;,&#123;"name": "foobar"&#125;]' |jq .[].name</span><br><span class="line">"foo"</span><br><span class="line">"bar"</span><br><span class="line">"foobar"</span><br></pre></td></tr></table></figure>
<ul>
<li>也可以用下面会提到的管道操作</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo '[&#123;"name": "foo"&#125;,&#123;"name": "bar"&#125;,&#123;"name": "foobar"&#125;]' |jq '.[]|.name'</span><br><span class="line">"foo"</span><br><span class="line">"bar"</span><br><span class="line">"foobar"</span><br></pre></td></tr></table></figure>
<ul>
<li>结果重新组成数组</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo '[&#123;"name": "foo"&#125;,&#123;"name": "bar"&#125;,&#123;"name": "foobar"&#125;]' |jq [.[].name]</span><br><span class="line">[</span><br><span class="line">  "foo",</span><br><span class="line">  "bar",</span><br><span class="line">  "foobar"</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>map</code>创建数组</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo '[&#123;"name": "foo"&#125;,&#123;"name": "bar"&#125;,&#123;"name": "foobar"&#125;]' |jq 'map(.name)'</span><br><span class="line">[</span><br><span class="line">  "foo",</span><br><span class="line">  "bar",</span><br><span class="line">  "foobar"</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li><code>length</code> 可以获取字符串或数组的长度</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo '&#123;"url": "mozillazg.com", "name": "mozillazg"&#125;' |jq '.url|length'</span><br><span class="line">13</span><br><span class="line">echo '["mozillazg.com", "mozillazg"]' |jq '.|length'</span><br><span class="line">2</span><br></pre></td></tr></table></figure>
<ul>
<li><code>map(foo)</code> 可以实现对数组的每一项进行操作，然后合并结果的功能</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo '["mozillazg.com", "mozillazg"]' | jq 'map(length)'</span><br><span class="line">[</span><br><span class="line">  13,</span><br><span class="line">  9</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li><code>select(foo)</code> 可以实现对输入项进行判断，只返回符合条件的项</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo '["mozillazg.com", "mozillazg"]' | jq 'map(select(.|length &gt; 9))'</span><br><span class="line">[</span><br><span class="line">  "mozillazg.com"</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>可以使用 <code>\(foo)</code> 实现字符串插值功能</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo '&#123;"url": "mozillazg.com", "name": "mozillazg"&#125;' |jq '"hi \(.name)"'</span><br><span class="line">"hi mozillazg"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意要用双引号包围起来，表示是一个字符串</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>+</code> 实现字符串拼接</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo '&#123;"url": "mozillazg.com", "name": "mozillazg"&#125;' |jq '"hi " + .name'</span><br><span class="line">"hi mozillazg"</span><br></pre></td></tr></table></figure>
<ul>
<li>可以使用 <code>if .. then .. elif .. then .. else .. end</code> 实现条件判断</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '[0, 1, 2, 3]' \</span><br><span class="line">| jq 'map(if . == 0 then "zero" elif . == 1 then "one" elif . == 2 then "two" else "many" end)'</span><br><span class="line">[</span><br><span class="line">  "zero",</span><br><span class="line">  "one",</span><br><span class="line">  "two",</span><br><span class="line">  "many"</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>可以通过 <code>{}</code> 和 <code>[]</code> 构造新的 object 或 数组</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo '["mozillazg.com", "mozillazg"]' |jq '&#123;name: .[1]&#125;'</span><br><span class="line">&#123;</span><br><span class="line">  "name": "mozillazg"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo '&#123;"url": "mozillazg.com", "name": "mozillazg"&#125;' |jq '[.name, .url]'</span><br><span class="line">[</span><br><span class="line">  "mozillazg",</span><br><span class="line">  "mozillazg.com"</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">echo '&#123;"name": "mozillazg", "ages": [1, 2]&#125;' | jq '&#123;name, age: .ages[]&#125;'</span><br><span class="line">&#123;</span><br><span class="line">  "name": "mozillazg",</span><br><span class="line">  "age": 1</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  "name": "mozillazg",</span><br><span class="line">  "age": 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>join</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo '["mozillazg.com", "mozillazg"]' | jq '.|join(" | ")'</span><br><span class="line">"mozillazg.com | mozillazg"</span><br></pre></td></tr></table></figure>
<ul>
<li>字符串split</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo '"mozillazg.com | mozillazg"' |jq 'split(" | ")'</span><br><span class="line">[</span><br><span class="line">  "mozillazg.com",</span><br><span class="line">  "mozillazg"</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">260</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">183</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
