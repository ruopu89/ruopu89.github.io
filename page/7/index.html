<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/7/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/17/tomcat部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/17/tomcat部署/" itemprop="url">
                  tomcat部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-17 09:27:52" itemprop="dateCreated datePublished" datetime="2019-01-17T09:27:52+08:00">2019-01-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-03-17 22:36:18" itemprop="dateModified" datetime="2019-03-17T22:36:18+08:00">2019-03-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tomcat/" itemprop="url" rel="index"><span itemprop="name">tomcat</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><blockquote>
<p>tomcat最外层为Server，表示一个实例；一个Server内部可以容纳多个Service，Service的目地主要是把Connetor和engine建立关联关系，一个engine可以有多个Connetor，但一个Connetor只能属于一个engine，Connector是对服务地址和端口的定义，还可以定义最大并发连接数等功能。engine是真正的窗口类组件，就是能够存放webapp并可以解析以后响应给用户的组件，这些组件有engine、host、context。它们被定义在server.xml这个主配置文件中。一般不用tomcat面向客户请求，而是用反代。可以用nginx、 httpd反代。用nt或at表示。在后端也不会只用tomcat，还会在tomcat前加一个nginx或httpd处理静态服务，另外，这个前端的nginx服务器还会将动态内容反代到其后面的tomcat处理。也就是nnt或nat。因为给动态服务器处理的内容中有一些如js、css等格式的内容</p>
</blockquote>
<p><img src="/images/tomcat/tomcat结构.jpg" alt=""></p>
<blockquote>
<p>对tomcat来讲，一个主机上的实例叫一个server，或说每个tomcat进程叫一个server，一台主机上可以有多个server。一般一个主机上只运行一个server。tomcat运行在java的虚拟机（JVM）上，java虚拟机有一个特点，就是单进程使用内存不能超过32G。server可以监听在某个套接字上，用来管理。像vanish监听在6082上进行管理一样，但tomcat的管理默认没有认证功能，所有只能监听在127.0.0.1上，甚至最好不要监听。server只代表是一个进程而已，与web无关。为了表示tomcat自己的组件，需要运行一个叫容器的组件，就是在server中的engine，它是用来让用户能够存储java代码，也就是jsp代码，并把代码加载后运行生成结果的组件。它像是一个JVM的实例，就是一个java虚拟机进程。server只是一个环境，engine才是运行代码的引擎或叫jsp容器。用户请求的动态资源都应该由引擎来运行，请求到达主机后要能交给引擎组件才行。引擎要能通过套接字与其他主机联系，但引擎不能监听端口，所以在server中还要有一个到多个连接器connector。一个server内部可以存在多个引擎，连接器与引擎之间只能一一对应，请求到连接器后，这个请求属于哪个引擎，请求就会被路由到哪个引擎。但连接器是不能直接与引擎建立连接关系的。在server内部还有service，service可以有多个，它的作用主要在于把一个或多个连接器与特定的引擎关联起来。实际是在一个service中可以有一个引擎和多个连接器。一个连接器只能属于一个service，因此，属于service的连接器，也就属于了service中的引擎。一个引擎内可以有多个虚拟主机（Host），一般tomcat只使用基于主机名的虚拟主机。每一个应用叫一个context，context可以出现多个。valve用来过滤日志、用户请求等。（布署进，除了布署应用本身，还要布署应用依赖的环境被满足）。后端的tomcat只处理动态内容，静态内容由nginx处理，所以请求的如果是静态内容，就由nginx处理，如果是动态内容，就由nginx反代到tomcat上，处理后返回给nginx。这是一个nt的组合</p>
<p>网站的基本组织框架：第一层接入层、第二层缓存层、第三层应用程序服务器层、第四层存储层</p>
</blockquote>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# yum install -y java-1.8.0-openjdk-devel</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装openjdk</span></span><br><span class="line">[root@test ~]# java -version</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看版本，参数是一个横杠</span></span><br><span class="line">[root@test ~]# vim /etc/profile.d/java.sh</span><br><span class="line">export JAVA_HOME=/usr</span><br><span class="line">[root@test ~]# . /etc/profile.d/</span><br><span class="line">[root@test ~]# echo $JAVA_HOME          </span><br><span class="line">/usr</span><br><span class="line"><span class="meta">#</span><span class="bash"> java程序会依赖这个变量找java的安装环境</span></span><br><span class="line">[root@test ~]# yum install -y tomcat tomcat-webapps tomcat-admin-webapps tomcat-docs-webapp</span><br><span class="line"><span class="meta">#</span><span class="bash"> tomcat-jsp-2.2-api和tomcat-servlet-3.0-api是类库。tomcat-webapps提供的是测试页；admin-webapps提供的是Manager App和Host Manager，访问是要认证的；tomcat-docs-webapp提供的是页面中的Documentation</span></span><br><span class="line">[root@test ~]# systemctl start tomcat</span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> tomcat默认监听在8080上</span></span><br><span class="line">访问http://192.168.1.14:8080/</span><br><span class="line">[root@test ~]# cd /etc/tomcat/</span><br><span class="line">[root@test tomcat]# cp server.xml&#123;,.bak&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> rpm包主配置文件在/etc/tomcat/server.xml，如果是解压安装的tomcat，主配置文件在/usr/<span class="built_in">local</span>/tomcat/conf下</span></span><br><span class="line">[root@test tomcat]# vim server.xml</span><br><span class="line">&lt;Server port="8005" shutdown="SHUTDOWN"&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Server是tomcat的管理端，这表示server监听在哪个端口，并接受SHUTDOWN命令，可以关闭。这个功能是不安全的，将port改为-1或在shutdown后添加一个随机字符串就可使关闭功能失效</span></span><br><span class="line">	&lt;Listener className="org.apache.catalina.core.AprLifecycleListener" SSLEngine="on" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Listener表示侦听器，作用是查看对应的某个类是否被加载，如果加载了就启用起来，以便侦听某些类的资源</span></span><br><span class="line"> &lt;GlobalNamingResources&gt;</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 这是定义全局命名资源的，对主机和用户的名称解析</span></span><br><span class="line"> &lt;Service name="Catalina"&gt;</span><br><span class="line"><span class="meta"> #</span><span class="bash"> Service只有一个名称叫Catalina，Service把连接器和engine关联起来的</span></span><br><span class="line">     &lt;Connector port="8080" protocol="HTTP/1.1"</span><br><span class="line">                   connectionTimeout="20000"</span><br><span class="line">                   redirectPort="8443" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Connector对服务端口进行定义。指明连接器的端口和协议，连接超时时间，最后是一旦超时，重定向到哪个端口。这些定义的都是类的属性</span></span><br><span class="line">	&lt;Engine name="Catalina" defaultHost="localhost"&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同一个Service中的Connector都属于同一个Engine，定义名称为Catalina，defaultHost表示当用户访问的主机与tomcat中的主机没有一个匹配时，就用这个默认的主机来响应</span></span><br><span class="line">    &lt;Host name="localhost"  appBase="webapps"</span><br><span class="line">                unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用Host定义虚拟主机，appBase表示网页根文档在哪，rpm包安装的tomcat的网页根目录在/var/lib/tomcat/webapps的ROOT下，unpackWARs自动展开，autoDeploy自动布署</span></span><br><span class="line">[root@test tomcat]# yum install -y nc</span><br><span class="line">[root@test tomcat]# nc -nv 127.0.0.1 8005</span><br><span class="line">Ncat: Version 7.50 ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Connected to 127.0.0.1:8005.</span><br><span class="line">SHUTDOWN</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接管理端口，输入SHUTDOWN命令后就可以关闭tomcat了</span></span><br><span class="line">[root@test tomcat]# ss -tln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口关闭了</span></span><br><span class="line">[root@test tomcat]# mkdir -pv test/&#123;WEB-INF,META-INF,lib,classes&#125;</span><br><span class="line">[root@test tomcat]# vim test/index.jsp</span><br><span class="line">&lt;%@ page language="java" %&gt;		# 定义当前网站使用的默认语言是java</span><br><span class="line">&lt;%@ page import="java.util.*" %&gt;  		# 导入java.util下面的所有类</span><br><span class="line">   &lt;html&gt;</span><br><span class="line">      &lt;head&gt;</span><br><span class="line">         &lt;title&gt;Test Page&lt;/title&gt;</span><br><span class="line">      &lt;/head&gt;</span><br><span class="line">      &lt;body&gt;</span><br><span class="line">         &lt;% out.println("hello world");			# out.println是java的输出命令</span><br><span class="line">         %&gt;</span><br><span class="line">      &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br><span class="line">[root@test tomcat]# cp -a test/ /var/lib/tomcat/webapps/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将网页目录放到根下，因为文件少，所以没有打包网页目录。因为配置文件中定义了自动布署，所以可以自动导入java.util下面的所有类。如果是war文件，也会自动展开的。因为配置文件中定义了自动展开</span></span><br><span class="line">[root@test tomcat]# systemctl start tomcat</span><br><span class="line">访问http://192.168.1.14:8080/test/index.jsp</span><br><span class="line">[root@test tomcat]# ls /var/cache/tomcat/work</span><br><span class="line">Catalina</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译后的页面在/var/cache/tomcat/work中叫Catalina</span></span><br></pre></td></tr></table></figure>
<h4 id="调整tomcat使用jvm内存"><a href="#调整tomcat使用jvm内存" class="headerlink" title="调整tomcat使用jvm内存"></a>调整tomcat使用jvm内存</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 源码安装</span><br><span class="line">[root@jenkins local]# vim /usr/local/tomcat/bin/catalina.sh</span><br><span class="line">    JAVA_OPTS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整tomcat使用jvm内存</span></span><br><span class="line">[root@jenkins tomcat]# /usr/local/tomcat/bin/startup.sh</span><br><span class="line">[root@jenkins tomcat]# tail -f /usr/local/tomcat/logs/catalina.out</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看启动过程</span></span><br><span class="line">[root@jenkins local]# ps aux|grep tomcat</span><br><span class="line">root       3101 33.7 38.4 3704844 717556 pts/0  Sl   13:02   0:17 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line"></span><br><span class="line">* rpm包安装</span><br><span class="line">[root@jenkins ~]# vim /etc/sysconfig/jenkins</span><br><span class="line">JENKINS_JAVA_OPTIONS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整jenkins的使用内存，默认此项是-Djava.awt.headless=<span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xms：初始堆内存Heap大小，使用的最小内存，cpu性能高时此值应设的大一些</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xmx：初始堆内存heap最大值，使用的最大内存</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -XX:MaxPermSize:设定最大内存的永久保存区域</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xms与-Xmx设置相同的值，需要根据实际情况设置，增大内存可以提高读写性能</span></span><br></pre></td></tr></table></figure>
<h4 id="页面中的manager"><a href="#页面中的manager" class="headerlink" title="页面中的manager"></a>页面中的manager</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@test tomcat]# vim /etc/tomcat/tomcat-users.xml.</span><br><span class="line">&lt;role rolename="manager-gui"/&gt; </span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开manager-gui功能</span></span><br><span class="line">&lt;user name="tomcat" password="tomcat" roles="manager-gui" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自定义用户名和密码，这里要设置password和roles，roles后的内容要与上面的role中定义的一样</span></span><br><span class="line">[root@test tomcat]# systemctl restart tomcat</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改后必须重启，因为启动时此文件已装载进内存</span></span><br><span class="line">访问http://192.168.1.14:8080中的Manager App，使用上面的用户名和密码，在这里可以管理站点，在这里也可以热布署</span><br></pre></td></tr></table></figure>
<h4 id="测试热部署"><a href="#测试热部署" class="headerlink" title="测试热部署"></a>测试热部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@test tomcat]# cp -a test/ /var/lib/tomcat/webapps/test2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在管理页中的Deploy中的Context Path (required)中输入/test2（视频中去掉了斜线），点Deploy，有错误提示，但也可以在上面的页面管理中看到test2了。在下面还有WAR file to deploy，是热布署war文件的，也是选择好文件，并点击Deploy即可。实际测试中在复制<span class="built_in">test</span>文件后，在管理页面中就已经可以看到test2的内容了</span></span><br></pre></td></tr></table></figure>
<h4 id="管理虚拟主机"><a href="#管理虚拟主机" class="headerlink" title="管理虚拟主机"></a>管理虚拟主机</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@test tomcat]# vim /etc/tomcat/tomcat-users.xml</span><br><span class="line">&lt;role rolename="admin-gui"/&gt; </span><br><span class="line">&lt;role rolename="manager-gui"/&gt;</span><br><span class="line">&lt;user name="tomcat" password="tomcat" roles="manager-gui,admin-gui" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 页面中的Host Manager是管理虚拟主机的，用户所属的角色是admin-gui，加入即可。</span></span><br><span class="line">[root@test tomcat]# systemctl restart tomcat</span><br><span class="line">[root@test tomcat]# mkdir -pv /appdata/ilinux/ROOT</span><br><span class="line">[root@test tomcat]# cp -r test/* /appdata/ilinux/ROOT/</span><br><span class="line">[root@test tomcat]# vim /appdata/ilinux/ROOT/index.jsp</span><br><span class="line">&lt;%@ page language="java" %&gt;</span><br><span class="line">&lt;%@ page import="java.util.*" %&gt;</span><br><span class="line">   &lt;html&gt;</span><br><span class="line">      &lt;head&gt;</span><br><span class="line">         &lt;title&gt;ilinux page&lt;/title&gt;</span><br><span class="line">      &lt;/head&gt;</span><br><span class="line">      &lt;body&gt;</span><br><span class="line">         &lt;% out.println("hello ilinux");</span><br><span class="line">         %&gt;</span><br><span class="line">      &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br><span class="line">访问http://192.168.1.14:8080，进入Host Manager中可以创建删除虚拟主机，定义虚拟主机时要指明Name站点名称，这里用了www.ilinux.io，Aliases站点别名，这里用ilinux.io，App base站点路径，这里用/appdata/ilinux/，下面选项是，AutoDeploy：是否自动布署；DeployOnStartup：是否启动时自动布署；DeployXML：是否基于xml文件来布署；UnpackWARs：是否自动展开WAR文件；Manager App：是否用Manager App来管理，最后添加就行了</span><br><span class="line"></span><br><span class="line">** 让自己的主机可以解析www.ilinux.io，配置hosts文件</span><br><span class="line"></span><br><span class="line">访问 www.ilinux.io:8080，不用在访问时写ROOT，tomcat可以自动识别，根文件就在ROOT中。但这种方式是定义在内存中的，如果重启tomcat后，就不存在了。如果要长期有效，还要定义在server.xml中。访问显示hello ilinux</span><br><span class="line">[root@test tomcat]# vim server.xml</span><br><span class="line">&lt;Connector port="8080" protocol="HTTP/1.1"</span><br><span class="line">               connectionTimeout="20000"</span><br><span class="line">               redirectPort="8443" maxThreads="1000" acceptCount="200" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入，最大并发连接数是1000，等待队列是200。端口如果改为80是启动不了的，因为是普通用户</span></span><br><span class="line">&lt;Engine name="Catalina" defaultHost="localhost"&gt;</span><br><span class="line">      &lt;Host name="www.ilinux.io" appBase="/appdata/ilinux"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"/&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里只要将Host写在已有的&lt;Engine&gt;中即可，用&lt;Host&gt;&lt;/Host&gt;或&lt;.../&gt;的方式都可以</span></span><br><span class="line">[root@test tomcat]# systemctl restart tomcat</span><br><span class="line">访问www.ilinux.io:8080，访问显示hello ilinux</span><br><span class="line">上传shopxx-a5-Beta.zip到tomcat主机</span><br><span class="line">[root@test ~]# unzip shopxx-a5-Beta.zip</span><br><span class="line">[root@test ~]# cp -a /root/shopxx-v3.0-Beta/shopxx-3.0Beta/ /appdata/ilinux/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 放在/appdata/ilinux目录中，是因为上面在server.xml中的Host中定义了www.ilinux.io的网页目录路径</span></span><br><span class="line">[root@test ~]# ln -sv /appdata/ilinux/shopxx-3.0Beta/ /appdata/ilinux/shopxx</span><br><span class="line">访问www.ilinux.io:8080/shopxx，这里可以看到安装界面</span><br><span class="line">[root@test ~]# rm -f /appdata/ilinux/shopxx</span><br><span class="line">[root@test ~]# mkdir /e-shop</span><br><span class="line">[root@test ~]# cp -a /root/shopxx-v3.0-Beta/shopxx-3.0Beta/ /e-shop/</span><br><span class="line">[root@test ~]# cd /e-shop/</span><br><span class="line">[root@test e-shop]# ln -sv shopxx-3.0Beta/ shopxx</span><br><span class="line">[root@test e-shop]# vim /etc/tomcat/server.xml</span><br><span class="line">&lt;Engine name="Catalina" defaultHost="localhost"&gt;</span><br><span class="line">      &lt;Host name="www.ilinux.io" appBase="/appdata/ilinux"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line">         &lt;Context path="/eshop" docBase="/e-shop/shopxx/" reloadable="true"/&gt;</span><br><span class="line">      &lt;/Host&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里一定要注意，Context一定要定义在某个Host中，不然是无法访问的。Context类似<span class="built_in">alias</span>，就是将设置的URL指向设置的路径，这里用path设置URL，docBase设置真正的路径，reloadable表示是否自动装载。这时访问eshop时就会到/e-shop/shopxx找文件了</span></span><br><span class="line">[root@test e-shop]# systemctl restart tomcat</span><br><span class="line">访问www.ilinux.io:8080/eshop，这时也可以看到安装界面</span><br></pre></td></tr></table></figure>
<h4 id="添加日志功能"><a href="#添加日志功能" class="headerlink" title="添加日志功能"></a>添加日志功能</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@test tomcat]# vim server.xml</span><br><span class="line">&lt;Engine name="Catalina" defaultHost="localhost"&gt;</span><br><span class="line">      &lt;Host name="www.ilinux.io" appBase="/appdata/ilinux"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line">         &lt;Context path="/eshop" docBase="/e-shop/shopxx/" reloadable="true"/&gt;</span><br><span class="line">         &lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"</span><br><span class="line">         prefix="ilinux_access_log." suffix=".log"</span><br><span class="line">         pattern="%h %l %u %t &amp;quot;%r&amp;quot; %s %b"/&gt;</span><br><span class="line">      &lt;/Host&gt; </span><br><span class="line">[root@test tomcat]# systemctl restart tomcat</span><br><span class="line">访问www.ilinux.io:8080/eshop</span><br><span class="line">[root@test ~]# tail -f /var/log/tomcat/ilinux_access_log.2019-01-17.log</span><br></pre></td></tr></table></figure>
<h4 id="nginx反向代理"><a href="#nginx反向代理" class="headerlink" title="nginx反向代理"></a>nginx反向代理</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">准备两台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。另一台是内网主机，地址：172.16.106.133。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* tomcat</span><br><span class="line">[root@test ~]# yum install -y java-1.8.0-openjdk-devel tomcat tomcat-webapps tomcat-admin-webapps tomcat-docs-webapp</span><br><span class="line">[root@test tomcat]# vim tomcat-users.xml</span><br><span class="line">&lt;role rolename="admin-gui"/&gt; </span><br><span class="line">&lt;role rolename="manager-gui"/&gt; </span><br><span class="line">&lt;user name="tomcat" password="tomcat" roles="admin-gui,manager-gui" /&gt;</span><br><span class="line">[root@test ~]# systemctl start tomcat</span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line">访问http://172.16.106.133:8080/，测试tomcat是否正常</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test ~]# yum install -y nginx</span><br><span class="line">[root@test ~]# cd /etc/nginx/</span><br><span class="line">[root@test nginx]# vim conf.d/ilinux.conf</span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.ilinux.io;</span><br><span class="line">   location / &#123;</span><br><span class="line">        proxy_pass http://172.16.106.133:8080;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@test nginx]# nginx -t</span><br><span class="line">[root@test nginx]# systemctl start nginx</span><br><span class="line">设置本机hosts文件，可以解析www.ilinux.io;</span><br><span class="line">访问www.ilinux.io。这时如果不关闭firewall是不能访问的，如果关闭了firewall而未关闭selinux会提示502无法访问</span><br><span class="line"></span><br><span class="line">* tomcat</span><br><span class="line">[root@test ~]# mkdir -pv /var/lib/tomcat/webapps/test/&#123;WEB-INF,META-INF,classes,lib&#125;</span><br><span class="line">[root@test ~]# vim /var/lib/tomcat/webapps/test/index.jsp</span><br><span class="line">&lt;%@ page language="java" %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="red"&gt;TomcatA.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">      &lt;table align="centre" border="1"&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">           &lt;% session.setAttribute("magedu.com","magedu.com"); %&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line">   &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">访问www.ilinux.io/test/，www.ilinux.io/manager</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test ~]# tail -f /var/log/nginx/access.log</span><br><span class="line">[root@test nginx]# vim conf.d/ilinux.conf </span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.ilinux.io;</span><br><span class="line">   location / &#123;</span><br><span class="line">        proxy_pass http://172.16.106.132:8080;</span><br><span class="line">   &#125;</span><br><span class="line">   location ~*\.(jsp|do)$ &#123;</span><br><span class="line">        proxy_pass http://172.16.106.133:8080;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样设置就可以实现动静分离</span></span><br><span class="line">访问http://www.ilinux.io/test/index.jsp，如果不写后面的index.jsp会打不开页面</span><br></pre></td></tr></table></figure>
<h4 id="http反向代理"><a href="#http反向代理" class="headerlink" title="http反向代理"></a>http反向代理</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">准备两台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。另一台是内网主机，地址：172.16.106.133。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test ~]# yum install -y httpd</span><br><span class="line">[root@test ~]# cd /etc/httpd/</span><br><span class="line">[root@test httpd]# vim conf.d/ilinux-http-tomcat.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www.ilinux.io</span><br><span class="line">   proxyRequests off		# 关闭正向代理</span><br><span class="line">   ProxyPreserveHost on			# 将主机头传到后端</span><br><span class="line">   ProxyVia on			# 是否在响应报文中加上via首部</span><br><span class="line">   &lt;Proxy *&gt;			# Proxy功能可以被谁使用</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Proxy&gt;</span><br><span class="line">   ProxyPass / http://172.16.106.133:8080/     </span><br><span class="line"><span class="meta">   #</span><span class="bash"> 将自己的哪个URL代理到后端的哪个URL，最后的/线不能少</span></span><br><span class="line">   ProxyPassReverse / http://172.16.106.133:8080/		# 这条不写也可以</span><br><span class="line">   &lt;Location /&gt;			# 哪个URL可以被谁访问</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@test httpd]# httpd -M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 看一下是否有proxy_module和proxy_http_module两个模块</span></span><br><span class="line">[root@test httpd]# httpd -t</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查语法</span></span><br><span class="line">[root@test httpd]# systemctl start httpd</span><br><span class="line">[root@test httpd]# ss -tln</span><br><span class="line">访问 www.ilinux.io</span><br><span class="line">[root@test httpd]# tail -f /var/log/httpd/access_log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用之前的nginx反代到后端的httpd上，httpd再反代到本机的tomcat上。实现nat架构</span></span><br></pre></td></tr></table></figure>
<h4 id="ajp反向代理"><a href="#ajp反向代理" class="headerlink" title="ajp反向代理"></a>ajp反向代理</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">准备两台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。另一台是内网主机，地址：172.16.106.133。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test httpd]# cp /etc/httpd/conf.d/ilinux-http-tomcat.conf /etc/httpd/conf.d/iunix-ajp-tomcat.conf</span><br><span class="line">[root@test httpd]# vim conf.d/iunix-ajp-tomcat.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www.iunix.io</span><br><span class="line">   proxyRequests off</span><br><span class="line">   ProxyPreserveHost on</span><br><span class="line">   ProxyVia on</span><br><span class="line">   &lt;Proxy *&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Proxy&gt;</span><br><span class="line">   ProxyPass / ajp://172.16.106.133:8009/		# 改协议为ajp，端口为8009</span><br><span class="line">   ProxyPassReverse / ajp://172.16.106.133:8009/</span><br><span class="line">   &lt;Location /&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@test httpd]# httpd -M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意proxy_ajp_module模块要加载</span></span><br><span class="line">[root@test httpd]# systemctl restart httpd</span><br><span class="line">访问www.iunix.io</span><br><span class="line"><span class="meta">#</span><span class="bash"> ajp的好处是用浏览器是不能访问的，只要注释掉8080端口（因为ajp联系的是8009端口），更安全。显示的结果与http的结果是一样的，也是tomcat主页</span></span><br></pre></td></tr></table></figure>
<h4 id="httpd负载均衡"><a href="#httpd负载均衡" class="headerlink" title="httpd负载均衡"></a>httpd负载均衡</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">准备三台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。tomcat1是内网主机，地址：172.16.106.133。tomcat2地址：172.16.106.134。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test httpd]# httpd -M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 要加载proxy_balancer_module模块</span></span><br><span class="line">[root@test httpd]# vim conf.d/ilinux-http-tomcat.conf</span><br><span class="line">&lt;Proxy balancer://tcsrvs&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义组，balancer://是调用这个模块，不能变。tcsrvs是自定义的名字</span></span><br><span class="line">   BalancerMember http://172.16.106.133:8080</span><br><span class="line">   BalancerMember http://172.16.106.134:8080</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调度的成员</span></span><br><span class="line">   ProxySet lbmethod=byrequests</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义算法，这是加权轮询的。byrequests：默认。基于请求数量计算权重。bytraffic：基于I/O流量大小计算权重。bybusyness：基于挂起的请求(排队暂未处理)数量计算权重。</span></span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www.ilinux.io</span><br><span class="line">   proxyRequests off</span><br><span class="line">   ProxyPreserveHost on</span><br><span class="line">   ProxyVia on</span><br><span class="line">   &lt;Proxy *&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Proxy&gt;</span><br><span class="line">   ProxyPass / balancer://tcsrvs/</span><br><span class="line">   ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">   &lt;Location /&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@test httpd]# systemctl restart httpd</span><br><span class="line">[root@test httpd]# ss -tln</span><br><span class="line"></span><br><span class="line">* tomcat1</span><br><span class="line">[root@test ~]# scp -r /usr/share/tomcat/webapps/test/ 172.16.106.134:/root</span><br><span class="line"></span><br><span class="line">* tomcat2</span><br><span class="line">[root@test ~]# yum install -y java-1.8.0-openjdk-devel tomcat tomcat-webapps tomcat-admin-webapps tomcat-docs-webapp</span><br><span class="line">[root@test ~]# vim /etc/profile.d/java.sh</span><br><span class="line">export JAVA_HOME=/usr</span><br><span class="line">[root@test ~]# cp -r test/ /usr/share/tomcat/webapps/</span><br><span class="line">[root@test ~]# vim /var/lib/tomcat/webapps/test/index.jsp               </span><br><span class="line">&lt;%@ page language="java" %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatB&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="blue"&gt;TomcatB.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">      &lt;table align="centre" border="1"&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">           &lt;% session.setAttribute("magedu.com","magedu.com"); %&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line">   &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@test ~]# vim /etc/tomcat/tomcat-users.xml</span><br><span class="line">&lt;role rolename="admin-gui"/&gt; </span><br><span class="line">&lt;role rolename="manager-gui"/&gt; </span><br><span class="line">&lt;user name="tomcat" password="tomcat" roles="admin-gui,manager-gui" /&gt;</span><br><span class="line">[root@test ~]# systemctl start tomcat</span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test httpd]# vim /etc/hosts</span><br><span class="line">192.168.1.14 www.ilinux.io www.iunix.io</span><br><span class="line">[root@test httpd]# for i in &#123;1..10&#125;;do curl -s http://www.ilinux.io/test/ | grep -i 'tomcat';done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时应该返回两台服务器的结果</span></span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="red"&gt;TomcatA.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatB&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="blue"&gt;TomcatB.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
<h4 id="ajp负载均衡"><a href="#ajp负载均衡" class="headerlink" title="ajp负载均衡"></a>ajp负载均衡</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">准备三台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。tomcat1是内网主机，地址：172.16.106.133。tomcat2地址：172.16.106.134。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test httpd]# vim conf.d/iunix-ajp-tomcat.conf </span><br><span class="line">&lt;Proxy balancer://tomcatsrvs&gt;</span><br><span class="line">   BalancerMember ajp://172.16.106.133:8009</span><br><span class="line">   BalancerMember ajp://172.16.106.134:8009</span><br><span class="line">   ProxySet lbmethod=byrequests</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www.iunix.io</span><br><span class="line">   proxyRequests off</span><br><span class="line">   ProxyPreserveHost on</span><br><span class="line">   ProxyVia on</span><br><span class="line">   &lt;Proxy *&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Proxy&gt;</span><br><span class="line">   ProxyPass / balancer://tomcatsrvs/</span><br><span class="line">   ProxyPassReverse / balancer://tomcatsrvs/</span><br><span class="line">   &lt;Location /&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@test httpd]# systemctl restart httpd</span><br><span class="line">[root@test httpd]# for i in &#123;1..10&#125;;do curl -s http://www.iunix.io/test/ | grep -i 'tomcat';done</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="red"&gt;TomcatA.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatB&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="blue"&gt;TomcatB.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
<h4 id="会话粘性-内建管理页"><a href="#会话粘性-内建管理页" class="headerlink" title="会话粘性/内建管理页"></a>会话粘性/内建管理页</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@test httpd]# vim conf.d/ilinux-http-tomcat.conf</span><br><span class="line">Header add Set-Cookie "ROUTEID=%&#123;BALANCER_WORKER_ROUTE&#125;e; path=/" env=BALANCER_ROUTE_CHANGED</span><br><span class="line">&lt;Proxy balancer://tcsrvs&gt;</span><br><span class="line">   BalancerMember http://172.16.106.133:8080 route=TomcatA</span><br><span class="line">   BalancerMember http://172.16.106.134:8080 route=TomcatB</span><br><span class="line">   ProxySet lbmethod=byrequests</span><br><span class="line">   ProxySet stickysession=ROUTEID</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName www.ilinux.io</span><br><span class="line">   proxyRequests off</span><br><span class="line">   ProxyPreserveHost on</span><br><span class="line">   ProxyVia on</span><br><span class="line">   &lt;Proxy *&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Proxy&gt;</span><br><span class="line">   ProxyPass / balancer://tcsrvs/</span><br><span class="line">   ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">   &lt;Location /&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">   &lt;Location /bstatus&gt;</span><br><span class="line">      SetHandler balancer-manager</span><br><span class="line">      ProxyPass !</span><br><span class="line">      Require all granted</span><br><span class="line">   &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@test httpd]# httpd -t</span><br><span class="line">[root@test httpd]# systemctl restart httpd</span><br><span class="line">访问http://www.ilinux.io/bstatus可以看到管理页面，访问http://www.ilinux.io/test/按F12查看，可以看到cookie一项中有ROUTEID=TomcatA或B，表示cookie会话绑定</span><br></pre></td></tr></table></figure>
<h4 id="session会话绑定，用session-cluster的方法实现"><a href="#session会话绑定，用session-cluster的方法实现" class="headerlink" title="session会话绑定，用session cluster的方法实现"></a>session会话绑定，用session cluster的方法实现</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">准备三台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。tomcat1是内网主机，地址：172.16.106.133。tomcat2地址：172.16.106.134。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    upstream tcsrvs &#123;</span><br><span class="line">        server 172.16.106.133:8080;</span><br><span class="line">        server 172.16.106.134:8080;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入upstream段</span></span><br><span class="line">[root@test ~]# vim /etc/nginx/conf.d/ilinux.conf</span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.ilinux.io;</span><br><span class="line">   location / &#123;</span><br><span class="line">        proxy_pass http://tcsrvs;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里没有在两台tomcat主机上再安装nginx进行静态处理及动态内容反代</span></span><br><span class="line">[root@test ~]# systemctl start nginx</span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line">访问www.ilinux.io/test，这时是轮询的，这时的session ID是会改变的，只要刷新。因为被识别为新用户了。这个测试就是要让sessionID不变。</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看官方文档第十八章，Clustering/Session Replication HOW-TO。这个组件就叫Cluster，只能放在Engine或Host内部。因为每个集群节点都要配置，所以时间都要同步。之后会通过多播地址228.0.0.4进行通信，多播端口是45564。只要监听这个地址和端口就可以成为成员。接收多播信息要监听在4000-4100之间。</span></span><br><span class="line"></span><br><span class="line">* tomcat1&amp;tomcat2</span><br><span class="line">[root@test ~]# vim /etc/tomcat/server.xml</span><br><span class="line">&lt;Host name="localhost"  appBase="webapps"</span><br><span class="line">            unpackWARs="true" autoDeploy="true"&gt;</span><br><span class="line">&lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"</span><br><span class="line">        channelSendOptions="8"&gt;</span><br><span class="line">        &lt;Manager className="org.apache.catalina.ha.session.DeltaManager"</span><br><span class="line">        expireSessionsOnShutdown="false" </span><br><span class="line">        notifyListenersOnReplication="true"/&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义使用哪一个会话管理器，一共有五种；expireSessionsOnShutdown表示关机后会话是否过期，这里是不允许；</span></span><br><span class="line">        &lt;Channel className="org.apache.catalina.tribes.group.GroupChannel"&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Channel是用来定义信道的</span></span><br><span class="line">        &lt;Membership className="org.apache.catalina.tribes.membership.McastService"</span><br><span class="line">           address="228.0.0.4" 		# 多播地址最好改一下</span><br><span class="line">           port="45564" </span><br><span class="line">           frequency="500" 		# 健康检测500毫秒</span><br><span class="line">           dropTime="3000"/&gt;		# 3000毫秒没有响应就将节点去除</span><br><span class="line">        &lt;Receiver className="org.apache.catalina.tribes.transport.nio.NioReceiver"</span><br><span class="line">           address="172.16.106.133" </span><br><span class="line">           # 改为自己的地址。如果是auto与hosts文件有关，它会做主机名反解</span><br><span class="line">           port="4000" </span><br><span class="line">           autoBind="100" </span><br><span class="line">           selectorTimeout="5000"</span><br><span class="line">           maxThreads="6"/&gt;</span><br><span class="line">        &lt;Sender className="org.apache.catalina.tribes.transport.ReplicationTransmitter"&gt;</span><br><span class="line">        &lt;Transport className="org.apache.catalina.tribes.transport.nio.PooledParallelSender"/&gt;</span><br><span class="line">        &lt;/Sender&gt;</span><br><span class="line">        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.TcpFailureDetector"/&gt;</span><br><span class="line">        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor"/&gt;</span><br><span class="line">        &lt;/Channel&gt;</span><br><span class="line">        &lt;Valve className="org.apache.catalina.ha.tcp.ReplicationValve" filter=""/&gt;</span><br><span class="line">        &lt;Valve className="org.apache.catalina.ha.session.JvmRouteBinderValve"/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Deployer className="org.apache.catalina.ha.deploy.FarmWarDeployer"</span><br><span class="line">           tempDir="/tmp/war-temp/"</span><br><span class="line">           deployDir="/tmp/war-deploy/"</span><br><span class="line">           watchDir="/tmp/war-listen/"</span><br><span class="line">           watchEnabled="false"/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;ClusterListener className="org.apache.catalina.ha.session.ClusterSessionListener"/&gt;</span><br><span class="line">        &lt;/Cluster&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在想使用集群的Host中添加上面的内容</span></span><br><span class="line">[root@test ~]# cp web.xml /var/lib/tomcat/webapps/test/WEB-INF/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给<span class="built_in">test</span>提供一个web.xml文件</span></span><br><span class="line">[root@test ~]# vim /var/lib/tomcat/webapps/test/WEB-INF/web.xml</span><br><span class="line">	&lt;distributable/&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在web-app段内任一位置添加&lt;distributable/&gt;才能实现上面的集群功能。当然，还要是在想实现集群功能的页面中的web.xml文件中添加，这里就是在<span class="built_in">test</span>的web.xml文件中添加的</span></span><br><span class="line">[root@test ~]# scp /etc/tomcat/server.xml 172.16.106.133:/etc/tomcat</span><br><span class="line">[root@test ~]# scp /var/lib/tomcat/webapps/test/WEB-INF/web.xml root@172.16.106.133:/var/lib/tomcat/webapps/test/WEB-INF</span><br><span class="line">[root@test test]# systemctl stop tomcat</span><br><span class="line">[root@test test]# systemctl start tomcat</span><br><span class="line">[root@test ~]# tail -f /var/log/tomcat/catalina.2019-01-17.log</span><br><span class="line">访问www.ilinux.io/test，这时不管是TomcatA还是B，session ID都是不会变的。测试中出现问题，Session无法绑定，原因是test中的WEB-INF目录的名字有问题，改回来就没问题了。</span><br></pre></td></tr></table></figure>
<h4 id="tomcat-memcached"><a href="#tomcat-memcached" class="headerlink" title="tomcat + memcached"></a>tomcat + memcached</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">准备三台主机，第一台是反代服务器，两个接口，地址：192.168.1.14 172.16.106.132。tomcat1是内网主机，地址：172.16.106.133。tomcat2地址：172.16.106.134。同步两台服务器的时间</span><br><span class="line"></span><br><span class="line">* tomcat1 &amp; tomcat2</span><br><span class="line">[root@test ~]# yum install -y memcached</span><br><span class="line">[root@test ~]# systemctl start memcached</span><br><span class="line">[root@test ~]# cd /etc/tomcat/</span><br><span class="line">[root@test ~]# cp server.xml&#123;,.cluster&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将tomcat恢复成最初状态，将cluster一段删除</span></span><br><span class="line">[root@test ~]# vim server.xml</span><br><span class="line">&lt;Context path="/test" docBase="test" reloadable="true"&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> reloadable表示自动装载</span></span><br><span class="line">            &lt;Manager className="de.javakaffee.web.msm.MemcachedBackupSessionManager"</span><br><span class="line">            memcachedNodes="m1:172.16.106.133:11211,m2:172.16.106.134:11211"</span><br><span class="line">            failoverNodes="m2"</span><br><span class="line">            requestUriIgnorePattern=".*\.(ico|png|gif|jpg|css|js)$"</span><br><span class="line">            transcoderFactoryClass="de.javakaffee.web.msm.serializer.javolution.JavolutionTran</span><br><span class="line">scoderFactory" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> serializer后的javolution开头的j一定要小写</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> memcachedNodes中m1是自定义的名称，后面是节点的地址；failoverNodes=<span class="string">"m2"</span>表示m2是备用节点，如果m1有故障m2才上线。requestUriIgnorePattern指有些内容是不缓存的，因为是静态文件。</span></span><br><span class="line">         &lt;/Context&gt;</span><br><span class="line">[root@test ~]# scp /etc/tomcat/server.xml 172.16.106.134:/etc/tomcat/</span><br><span class="line">下载相关包到两台tomcat</span><br><span class="line">1.  javolution-5.4.3.1.jar 		# 流式化工具</span><br><span class="line">2. msm-javolution-serializer-1.9.7.jar		# MSM支持两种模式即粘性sessions和非粘性sessions</span><br><span class="line">3. memcached-session-manager-1.9.7.jar		# memcached会话管理器</span><br><span class="line">4. memcached-session-manager-tc7-1.9.7.jar		# memcached会话管理器</span><br><span class="line">5. spymemcached-2.11.1.jar		# 驱动：tomcat连接memcached</span><br><span class="line">[root@test ~]# scp *.jar 172.16.106.134:/usr/share/java/tomcat/</span><br><span class="line">[root@test ~]# systemctl stop tomcat.</span><br><span class="line">[root@test ~]# systemctl start tomcat</span><br><span class="line">[root@test ~]# tail -f /var/log/tomcat/catalina.2019-01-17.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监控日志，看启动是否有问题。启动没有问题后，访问www.ilinux.io/<span class="built_in">test</span>，这时的SessionID是不会有变化的。因为sticky设置成了<span class="literal">true</span>，如果是<span class="literal">false</span>，那么就会有变化了。SessionID的最后有m1或m2的标识，可以知道是在哪个memcached上。</span></span><br><span class="line"></span><br><span class="line">* tomcat1</span><br><span class="line">[root@test ~]# systemctl stop memcached</span><br><span class="line">再访问www.ilinux.io/test，这时的SessionID还是不会有变化，只是Session ID一行最后变成了m2。切记，一定要先启动memcached再启动tomcat。</span><br><span class="line">[root@test ~]# yum install -y libmemcached-devel</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个包是C与memcached连接用的，提供了很多命令</span></span><br><span class="line">[root@test ~]# memstat --servers="172.16.106.133"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示memcached的各种数据</span></span><br></pre></td></tr></table></figure>
<h4 id="memcached安装使用"><a href="#memcached安装使用" class="headerlink" title="memcached安装使用"></a>memcached安装使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">在tomcat主机上安装测试</span><br><span class="line"></span><br><span class="line">[root@test ~]# yum install -y telnet</span><br><span class="line">[root@test ~]# vim /etc/sysconfig/memcached</span><br><span class="line">PORT="11211"		# 端口</span><br><span class="line">USER="memcached"		# 启动服务的用户名</span><br><span class="line">MAXCONN="1024"		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大并发连接数;存储层是不面向用户的，是从前面的反代发来的，所以1024并不小</span></span><br><span class="line">CACHESIZE="64"		# 缓存空间大小，这要改一下，如2G</span><br><span class="line">OPTIONS=""</span><br><span class="line">[root@test ~]# cat /usr/lib/systemd/system/memcached.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Memcached </span><br><span class="line">Before=httpd.service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/memcached</span><br><span class="line">ExecStart=/usr/bin/memcached -u $USER -p $PORT -m $CACHESIZE -c $MAXCONN $OPTIONS</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到，启动时就是调用配置文件中的几个参数</span></span><br><span class="line">[root@test ~]# telnet 127.0.0.1 11211</span><br><span class="line">stats</span><br><span class="line">stats slabs  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内存分配器</span></span><br><span class="line">add mykey 1 600 13  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置存储数据的信息，这里存储的键叫mykey，标志位是1，过期时间是600秒，占用内存大小是13个字符。</span></span><br><span class="line">www.ilinux.io 	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是要存储的数据，成功后返回STORED</span></span><br><span class="line">stats	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时cmd_set的值是1了。</span></span><br><span class="line">get mykey	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看mykey的信息</span></span><br><span class="line">append mykey 1 600 12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在后面追加数据</span></span><br><span class="line">www.iunix.io  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 返回了NOT_STORED，因为数据过期了，不能追加</span></span><br><span class="line">get mykey</span><br><span class="line">prepend mykey 1 600 7	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在前面补</span></span><br><span class="line">http://		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加这些内容</span></span><br><span class="line">get mykey</span><br><span class="line">delete mykey</span><br><span class="line">get mykey</span><br><span class="line">add counter 1 600 1	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置一个计数器</span></span><br><span class="line">0	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 值是0</span></span><br><span class="line">get counter</span><br><span class="line">incr counter 1	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 增加1</span></span><br><span class="line">get counter</span><br><span class="line">incr counter 2</span><br><span class="line">decr counter 1	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 减1</span></span><br><span class="line">flush_all	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清空数据</span></span><br><span class="line">quit</span><br><span class="line"><span class="meta">#</span><span class="bash"> 退出</span></span><br></pre></td></tr></table></figure>
<h4 id="tomcat-redis实现session绑定"><a href="#tomcat-redis实现session绑定" class="headerlink" title="tomcat + redis实现session绑定"></a>tomcat + redis实现session绑定</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">准备一台redis，两台tomcat</span><br><span class="line"></span><br><span class="line">* 反代服务器</span><br><span class="line">[root@test ~]# yum install -y redis</span><br><span class="line">[root@test ~]# vim /etc/redis.conf</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">[root@test ~]# systemctl start redis</span><br><span class="line">[root@test ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">...</span><br><span class="line">upstream tcsrvs &#123;</span><br><span class="line">        server 192.168.1.13:8080;</span><br><span class="line">        server 192.168.1.15:8080;</span><br><span class="line">    &#125;</span><br><span class="line">[root@test ~]# vim /etc/nginx/conf.d/ilinux.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.ilinux.io;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://tcsrvs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">* tomcat1 &amp; tomcat 2</span><br><span class="line">下载commons-pool2-2.0.jar、jedis-2.7.2.jar、tomcat-redis-session-manager1.2.jar到/usr/share/java/tomcat中</span><br><span class="line"><span class="meta">#</span><span class="bash"> 试过上面三个包的其他版本，tomcat启动时均有报错，用上面三个版本没有问题。可以个人百度网盘下载。参考：https://my.oschina.net/xshuai/blog/916122</span></span><br><span class="line">[root@test tomcat]# vim /etc/tomcat/context.xml</span><br><span class="line">&lt;Valve className="com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve" /&gt;</span><br><span class="line">    &lt;Manager className="com.orangefunction.tomcat.redissessions.RedisSessionManager"</span><br><span class="line">         host="192.168.1.14" </span><br><span class="line">         port="6379" </span><br><span class="line">         database="0" </span><br><span class="line">         maxInactiveInterval="60"/&gt;</span><br><span class="line">[root@test tomcat]# mkdir -pv /var/lib/tomcat/webapps/test/&#123;WEB-INF,META-INF,classes,lib&#125;</span><br><span class="line">[root@test tomcat]# vim /usr/share/tomcat/webapps/test/index.jsp</span><br><span class="line">&lt;%@ page language="java" %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">   &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">      &lt;h1&gt;&lt;font color="red"&gt;TomcatA.magedu.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">      &lt;table align="centre" border="1"&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">           &lt;% session.setAttribute("magedu.com","magedu.com"); %&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">         &lt;tr&gt;</span><br><span class="line">           &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">           &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">         &lt;/tr&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line">   &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@test tomcat]# cd /usr/share/java/tomcat</span><br><span class="line">[root@test tomcat]# scp /etc/tomcat/context.xml 192.168.1.13:/etc/tomcat/</span><br><span class="line">[root@test tomcat]# scp jedis-2.7.2.jar commons-pool2-2.0.jar tomcat-redis-session-manager1.2.jar 192.168.1.13:/usr/share/java/tomcat/</span><br><span class="line">[root@test tomcat]# scp -r /usr/share/tomcat/webapps/test/ 192.168.1.13:/usr/share/tomcat/webapps/</span><br><span class="line">[root@test tomcat]# vim /etc/tomcat/tomcat-users.xml</span><br><span class="line">&lt;role rolename="admin-gui"/&gt;</span><br><span class="line">&lt;role rolename="manager-gui"/&gt;</span><br><span class="line">&lt;user name="admin" password="adminadmin" roles="admin-gui,manager-gui" /&gt;</span><br><span class="line">[root@test tomcat]# scp /etc/tomcat/tomcat-users.xml 192.168.1.13:/etc/tomcat</span><br><span class="line">[root@test tomcat]# systemctl start tomcat</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动两台tomcat</span></span><br><span class="line">访问http://www.ilinux.io/test/，这时可以看到sessionID是不会变化的</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/15/linux性能监控命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/15/linux性能监控命令/" itemprop="url">
                  linux性能监控命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-15 17:08:59" itemprop="dateCreated datePublished" datetime="2019-01-15T17:08:59+08:00">2019-01-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-17 00:04:07" itemprop="dateModified" datetime="2019-01-17T00:04:07+08:00">2019-01-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="CPU查看"><a href="#CPU查看" class="headerlink" title="CPU查看"></a>CPU查看</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# cat /proc/cpuinfo |grep "physical id"|sort|uniq|wc -l</span><br><span class="line">1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看物理cpu个数</span></span><br><span class="line">[root@test ~]# cat /proc/cpuinfo |grep "cpu cores"|wc -l                       </span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看每个物理cpu中的核心数</span></span><br><span class="line">[root@test ~]# cat /proc/cpuinfo |grep "processor"|wc -l             </span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 逻辑cpu的个数。物理cpu个数*核数=逻辑cpu个数（不支持超线程技术的情况下）</span></span><br><span class="line">[root@test ~]# lscpu</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此命令也可查询上述信息</span></span><br></pre></td></tr></table></figure>
<h3 id="内存查看"><a href="#内存查看" class="headerlink" title="内存查看"></a>内存查看</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           976M        127M        510M         55M        338M        625M</span><br><span class="line">Swap:          2.0G          0B        2.0G</span><br><span class="line"><span class="meta">#</span><span class="bash"> total：内存总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> used：已经使用的内存数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> free：空闲内存数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> shared：多个进程共享的内存总额</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - buffers/cache：(已用)的内存数，即used-buffers-cached(CentOS6)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> + buffers/cache：(可用)的内存数，即free+buffers+cached(CentOS6)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Buffer Cache用于针对磁盘块的读写；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Page Cache用于针对文件inode的读写，这些Cache能有效地缩短I/O系统调用的时间。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对操作系统来说free/used是系统可用/占用的内存；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对应用程序来说-/+ buffers/cache是可用/占用内存,因为buffers/cache很快就会被使用。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 经验公式：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 应用程序可用内存/系统物理内存&gt;70%，表示系统内存资源非常充足，不影响系统性能;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 应用程序可用内存/系统物理内存&lt;20%，表示系统内存资源紧缺，需要增加系统内存;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 20%&lt;应用程序可用内存/系统物理内存&lt;70%，表示系统内存资源基本能满足应用需求，暂时不影响系统性能</span></span><br></pre></td></tr></table></figure>
<h3 id="磁盘查看"><a href="#磁盘查看" class="headerlink" title="磁盘查看"></a>磁盘查看</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# fdisk -l</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看硬盘及分区信息</span></span><br><span class="line">[root@test ~]# df -h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看文件系统的磁盘空间占用情况</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# du -sh /etc</span><br><span class="line">35M     /etc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看linux系统中某目录的大小</span></span><br></pre></td></tr></table></figure>
<h3 id="其他参数"><a href="#其他参数" class="headerlink" title="其他参数"></a>其他参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# lsmod</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统已载入的相关模块</span></span><br><span class="line">[root@test ~]# lspci</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看pci设置</span></span><br><span class="line">[root@test ~]# uname -a</span><br><span class="line">Linux test 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内核版本号等信息，也可以使用-r选项，只显示内核信息</span></span><br><span class="line">[root@test ~]# file /lib/systemd/systemd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统是32位还是64位的</span></span><br><span class="line">[root@test ~]# cat /etc/redhat-release </span><br><span class="line">CentOS Linux release 7.4.1708 (Core)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看发行版</span></span><br></pre></td></tr></table></figure>
<h3 id="uptime命令"><a href="#uptime命令" class="headerlink" title="uptime命令"></a>uptime命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# uptime </span><br><span class="line"> 21:14:43 up 1 min,  1 user,  load average: 0.05, 0.03, 0.01</span><br><span class="line"><span class="meta"> #</span><span class="bash"> load average三值大小一般不能大于系统CPU的个数。系统有8个CPU,如load average三值长期大于8，说明CPU很繁忙，负载很高，可能会影响系统性能。如load average输出值小于CPU个数，则表示CPU有空闲时间片，比如本例中的输出，CPU是非常空闲的</span></span><br></pre></td></tr></table></figure>
<h3 id="PS命令"><a href="#PS命令" class="headerlink" title="PS命令"></a>PS命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">用途</span><br><span class="line">显示进程的状态。</span><br><span class="line"></span><br><span class="line">语法</span><br><span class="line">ps [options] [--help]</span><br><span class="line"></span><br><span class="line">参数</span><br><span class="line">-A 列出所有的行程</span><br><span class="line">-w 显示加宽可以显示较多的资讯</span><br><span class="line">au 显示较详细的资讯</span><br><span class="line">aux 显示所有包含其他使用者的行程，也可使用-ef参数</span><br><span class="line"></span><br><span class="line">* au(x) 输出格式 :</span><br><span class="line">USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND</span><br><span class="line">USER: 进程拥有者</span><br><span class="line">PID: pid</span><br><span class="line"><span class="meta">%</span><span class="bash">CPU: 占用的 CPU 使用率</span></span><br><span class="line"><span class="meta">%</span><span class="bash">MEM: 占用的内存使用率</span></span><br><span class="line">VSZ: 占用的虚拟内存大小</span><br><span class="line">RSS: 占用的内存大小</span><br><span class="line">TTY: 终端的次要装置号码 (minor device number of tty)</span><br><span class="line">STAT: 此进程的状态:</span><br><span class="line">D: 不可中断的</span><br><span class="line">R: 正在执行中</span><br><span class="line">S: 静止状态</span><br><span class="line">T: 暂停执行</span><br><span class="line">Z: 不存在但暂时无法消除</span><br><span class="line">W: 没有足够的内存分页可分配</span><br><span class="line">&lt;: 高优先级的进程</span><br><span class="line">N: 低优先级的进程</span><br><span class="line">L: 有内存分页分配并锁在内存内 (实时系统或A I/O)</span><br><span class="line">START: 进程开始时间</span><br><span class="line">TIME: 执行的时间</span><br><span class="line">COMMAND:所执行的指令</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@test ~]# ps -A</span><br><span class="line">   PID TTY          TIME CMD</span><br><span class="line">     1 ?        00:00:02 systemd</span><br><span class="line">     2 ?        00:00:00 kthreadd</span><br><span class="line">     3 ?        00:00:00 ksoftirqd/0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示进程信息</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# ps -u root</span><br><span class="line">   PID TTY          TIME CMD</span><br><span class="line">     1 ?        00:00:02 systemd</span><br><span class="line">     2 ?        00:00:00 kthreadd</span><br><span class="line">     3 ?        00:00:00 ksoftirqd/0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示root用户的进程信息</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# ps -ef</span><br><span class="line">UID         PID   PPID  C STIME TTY          TIME CMD</span><br><span class="line">root          1      0  0 10:02 ?        00:00:02 /usr/lib/systemd/systemd --switched-root --s</span><br><span class="line">root          2      0  0 10:02 ?        00:00:00 [kthreadd]</span><br><span class="line">root          3      2  0 10:02 ?        00:00:00 [ksoftirqd/0]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有命令，连带命令行</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# ps axo user,comm,pid,psr,pcpu</span><br><span class="line">USER     COMMAND            PID PSR %CPU</span><br><span class="line">root     systemd              1   1  0.0</span><br><span class="line">root     kthreadd             2   0  0.0</span><br><span class="line">root     ksoftirqd/0          3   0  0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个命令是查看进程的名称、PID以及CPU的占用率。psr表示绑定内核线程的处理器（如果有）的逻辑处理器号。 对一个进程来说，如果它的线程全都绑定到同一处理器上，那么显示该字段。pcpu表示CPU的占用率。comm表示进程名称。pid表示进程的ID号</span></span><br></pre></td></tr></table></figure>
<h3 id="top命令"><a href="#top命令" class="headerlink" title="top命令"></a>top命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">用途</span><br><span class="line">用于实时显示 process 的动态。</span><br><span class="line"></span><br><span class="line">语法</span><br><span class="line">top [-] [d delay] [c] [S] [s] [i] [n] [b]</span><br><span class="line"></span><br><span class="line">参数</span><br><span class="line">d : 改变显示的更新速度，或在交互式指令列( interactive command)按 s</span><br><span class="line">c : 切换显示模式，共有两种模式，一是只显示执行程序的名称，另一种是显示完整的路径与名称</span><br><span class="line">S : 累积模式，会将己完成或消失的子行程 ( dead child process ) 的 CPU time 累积起来</span><br><span class="line">s : 安全模式，将交互式指令取消, 避免潜在的危机</span><br><span class="line">i : 不显示任何闲置 (idle) 或无用 (zombie) 的进程</span><br><span class="line">n : 更新的次数，完成后将会退出 top</span><br><span class="line">b : 批次模式，搭配 "n" 参数一起使用，可以用来将 top 的结果输出到文件内</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@test ~]# top</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示进程信息</span></span><br><span class="line">top - 17:44:23 up  7:42,  4 users,  load average: 0.02, 0.02, 0.05</span><br><span class="line">Tasks: 110 total,   1 running, 109 sleeping,   0 stopped,   0 zombie</span><br><span class="line"><span class="meta">%</span><span class="bash">Cpu(s):  0.0 us,  0.5 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.2 si,  0.0 st</span></span><br><span class="line">KiB Mem :   999720 total,   522516 free,   131076 used,   346128 buff/cache</span><br><span class="line">KiB Swap:  2097148 total,  2097148 free,        0 used.   640836 avail Mem </span><br><span class="line"></span><br><span class="line">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                 </span><br><span class="line">   893 root      20   0  549.2m  18.2m   5.7m S   0.3  1.9   0:03.52 /usr/bin/python -Es /us+</span><br><span class="line">   </span><br><span class="line">* 统计信息区</span><br><span class="line">前五行是系统整体的统计信息。第一行是任务队列信息，同 uptime 命令的执行结果。其内容如下：</span><br><span class="line">01:06:48：当前时间</span><br><span class="line">up 1:22：系统运行时间，格式为时:分</span><br><span class="line">1 user：当前登录用户数</span><br><span class="line">load average: 0.06, 0.60, 0.48：系统负载，即任务队列的平均长度。三个数值分别为 1分钟、5分钟、15分钟前到现在的平均值。</span><br><span class="line">第二、三行为进程和CPU的信息。当有多个CPU时，这些内容可能会超过两行。内容如下：</span><br><span class="line">Tasks: 29 total：进程总数</span><br><span class="line">1 running：正在运行的进程数</span><br><span class="line">28 sleeping：睡眠的进程数</span><br><span class="line">0 stopped：停止的进程数</span><br><span class="line">0 zombie：僵尸进程数</span><br><span class="line">Cpu(s): 0.3% us：用户空间占用CPU百分比</span><br><span class="line">1.0% sy： 内核空间占用CPU百分比</span><br><span class="line">0.0% ni：用户进程空间内改变过优先级的进程占用CPU百分比</span><br><span class="line">98.7% id：空闲CPU百分比</span><br><span class="line">0.0% wa：等待输入输出的CPU时间百分比</span><br><span class="line">0.0% hi</span><br><span class="line">0.0% si</span><br><span class="line">最后两行为内存信息。内容如下：</span><br><span class="line">Mem: 191272k total：物理内存总量</span><br><span class="line">173656k used：使用的物理内存总量</span><br><span class="line">17616k free：空闲内存总量</span><br><span class="line">22052k buffers：用作内核缓存的内存量</span><br><span class="line">Swap: 192772k total：交换区总量</span><br><span class="line">0k used：使用的交换区总量</span><br><span class="line">192772k free：空闲交换区总量</span><br><span class="line">123988k cached：缓冲的交换区总量。</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存中的内容被换出到交换区，而后又被换入到内存，但使用过的交换区尚未被覆盖，该数值即为这些内容已存在于内存中的交换区的大小。相应的内存再次被换出时可不必再对交换区写入。</span></span><br><span class="line"></span><br><span class="line">* 进程信息区</span><br><span class="line">统计信息区域的下方显示了各个进程的详细信息。</span><br><span class="line">PID：进程id</span><br><span class="line">PPID：父进程id</span><br><span class="line">RUSER Real user name</span><br><span class="line">UID：进程所有者的用户id</span><br><span class="line">USER：进程所有者的用户名</span><br><span class="line">GROUP：进程所有者的组名</span><br><span class="line">TTY：启动进程的终端名。不是从终端启动的进程则显示为 ?</span><br><span class="line">PR：优先级</span><br><span class="line">NI：nice值。负值表示高优先级，正值表示低优先级</span><br><span class="line">P：最后使用的CPU，仅在多CPU环境下有意义</span><br><span class="line"><span class="meta">%</span><span class="bash">CPU：上次更新到现在的CPU时间占用百分比</span></span><br><span class="line">TIME：进程使用的CPU时间总计，单位秒</span><br><span class="line">TIME+：进程使用的CPU时间总计，单位1/100秒</span><br><span class="line"><span class="meta">%</span><span class="bash">MEM：进程使用的物理内存百分比</span></span><br><span class="line">VIRT：进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES</span><br><span class="line">SWAP：进程使用的虚拟内存中，被换出的大小，单位kb。</span><br><span class="line">RES：进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA</span><br><span class="line">CODE：可执行代码占用的物理内存大小，单位kb</span><br><span class="line">DATA：可执行代码以外的部分(数据段+栈)占用的物理内存大小，单位kb</span><br><span class="line">SHR：共享内存大小，单位kb</span><br><span class="line">nFLT：页面错误次数</span><br><span class="line">nDRT：最后一次写入到现在，被修改过的页面数。</span><br><span class="line">S：进程状态。</span><br><span class="line">    D=不可中断的睡眠状态</span><br><span class="line">    R=运行</span><br><span class="line">    S=睡眠</span><br><span class="line">    T=跟踪/停止</span><br><span class="line">    Z=僵尸进程</span><br><span class="line">COMMAND：命令名/命令行</span><br><span class="line">WCHAN：若该进程在睡眠，则显示睡眠中的系统函数名</span><br><span class="line">Flags：任务标志</span><br><span class="line"></span><br><span class="line">* 更改显示内容</span><br><span class="line">通过 f 键可以选择显示的内容。按 f 键之后会显示列的列表，按 a-z 即可显示或隐藏对应的列，最后按回车键确定。</span><br><span class="line">按 o 键可以改变列的显示顺序。按小写的 a-z 可以将相应的列向右移动，而大写的 A-Z 可以将相应的列向左移动。最后按回车键确定。</span><br><span class="line">按大写的 F 或 O 键，然后按 a-z 可以将进程按照相应的列进行排序。而大写的 R 键可以将当前的排序倒转。</span><br><span class="line"></span><br><span class="line">* 交互命令</span><br><span class="line">h或者?：显示帮助画面，给出一些简短的命令总结说明。</span><br><span class="line">k：终止一个进程。系统将提示用户输入需要终止的进程PID，以及需要发送给该进程什么样的信号。一般的终止进程可以使用15信号；如果不能正常结束那就使用信号9强制结束该进程。默认值是信号15。在安全模式中此命令被屏蔽。</span><br><span class="line">i：忽略闲置和僵死进程。这是一个开关式命令。</span><br><span class="line">q：退出程序。</span><br><span class="line">r ：重新安排一个进程的优先级别。系统提示用户输入需要改变的进程PID以及需要设置的进程优先级值。输入一个正值将使优先级降低，反之则可以使该进程拥有更高的优先权。默认值是10。</span><br><span class="line">S：切换到累计模式。</span><br><span class="line">s：改变两次刷新之间的延迟时间。系统将提示用户输入新的时间，单位为s。如果有小数，就换算成m s。输入0值则系统将不断刷新，默认值是5 s。需要注意的是如果设置太小的时间，很可能会引起不断刷新，从而根本来不及看清显示的情况，而且系统负载也会大大增加。</span><br><span class="line">f或者F：从当前显示中添加或者删除项目。</span><br><span class="line">o或者O：改变显示项目的顺序。</span><br><span class="line">l：切换显示平均负载和启动时间信息。</span><br><span class="line">m：切换显示内存信息。</span><br><span class="line">t：切换显示进程和CPU状态信息。</span><br><span class="line">c：切换显示命令名称和完整命令行。</span><br><span class="line">M：根据驻留内存大小进行排序。</span><br><span class="line">P：根据CPU使用百分比大小进行排序。</span><br><span class="line">T：根据时间/累计时间进行排序。</span><br><span class="line">W：将当前设置写入~/.toprc文件中。</span><br><span class="line">1：查看CPU数量</span><br><span class="line"></span><br><span class="line">[root@test ~]# top -c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示完整命令</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# top -b</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以批处理模式显示程序信息</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# top -S</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以累积模式显示程序信息</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# top -n 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置信息更新次数，这里会更新两次后终止更新显示</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# top -d 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置信息更新时间，这条命令更新周期为3秒</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# top -p 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示指定的进程信息</span></span><br></pre></td></tr></table></figure>
<h3 id="iostat命令"><a href="#iostat命令" class="headerlink" title="iostat命令"></a>iostat命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">用法：iostat [ 选项 ] [ &lt;时间间隔&gt; [ &lt;次数&gt; ]]</span><br><span class="line">常用选项说明：</span><br><span class="line">-c：只显示系统CPU统计信息，即单独输出avg-cpu结果，不包括device结果</span><br><span class="line">-d：单独输出Device结果，不包括cpu结果</span><br><span class="line">-k/-m：输出结果以kB/mB为单位，而不是以扇区数为单位</span><br><span class="line">-x：输出更详细的io设备统计信息</span><br><span class="line">interval/count：每次输出间隔时间，count表示输出次数，不带count表示循环输出</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此命令需要安装sysstat包</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@test ~]# iostat</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从系统开机到当前执行时刻的统计信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avg-cpu: 总体cpu使用情况统计信息，对于多核cpu，这里为所有cpu的平均值。重点关注iowait值，表示CPU用于等待io请求的完成时间。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Device：各磁盘设备的IO统计信息。各列含义如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Device：以sdX形式显示的设备名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tps： 每秒进程下发的IO读、写请求数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> KB_read/s：每秒从驱动器读入的数据量，单位为K。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> KB_wrtn/s：每秒从驱动器写入的数据量，单位为K。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> KB_read：读入数据总量，单位为K。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> KB_wrtn：写入数据总量，单位为K。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  重点关注参数：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iowait% 表示CPU等待IO时间占整个CPU周期的百分比，如果iowait值超过50%，或者明显大于%system、%user以及%idle，表示IO可能存在问题。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avgqu-sz 表示磁盘IO队列长度，即IO等待个数。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> await 表示每次IO请求等待时间，包括等待时间和处理时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> svctm 表示每次IO请求处理的时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %util 表示磁盘忙碌情况，一般该值超过80%表示该磁盘可能处于繁忙状态。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# ll /dev/centos/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 7 Jan 16 21:13 root -&gt; ../dm-0</span><br><span class="line">lrwxrwxrwx 1 root root 7 Jan 16 21:13 swap -&gt; ../dm-1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用此命令查看dm-*对应的分区名称</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# iostat -x -k -d 1 2</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sda               0.00     0.02    0.62    0.12    12.85     1.85    40.04     0.00    0.32    0.28    0.55   0.16   0.01</span><br><span class="line">dm-0              0.00     0.00    0.34    0.13    11.44     1.58    55.41     0.00    0.52    0.46    0.65   0.21   0.01</span><br><span class="line">dm-1              0.00     0.00    0.01    0.00     0.30     0.00    47.40     0.00    0.13    0.13    0.00   0.06   0.00</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每隔1秒输出磁盘IO的详细信息，总共采样2次</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rrqm/s：每秒对该设备的读请求被合并次数，文件系统会对读取同块(block)的请求进行合并</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wrqm/s：每秒对该设备的写请求被合并次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> r/s：每秒完成的读次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> w/s：每秒完成的写次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rkB/s：每秒读数据量(kB为单位)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wkB/s：每秒写数据量(kB为单位)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avgrq-sz：平均每次IO操作的数据量(扇区数为单位)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avgqu-sz：平均等待处理的IO请求队列长度</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> await：平均每次IO请求等待时间(包括等待时间和处理时间，毫秒为单位)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> svctm：平均每次IO请求的处理时间(毫秒为单位)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %util：采用周期内用于IO操作的时间比率，即IO队列非空的时间比率</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# iostat -x 1 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看硬盘的I/O性能。每隔一秒显示一次，显示5次。如果%util接近100%,说明产生的I/O请求太多，I/O系统已经满负荷，该磁盘可能存在瓶颈。如果idle小于70%，I/O的压力就比较大了，说明读取进程中有较多的<span class="built_in">wait</span>。</span></span><br></pre></td></tr></table></figure>
<h3 id="vmstat命令"><a href="#vmstat命令" class="headerlink" title="vmstat命令"></a>vmstat命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# vmstat 2 2</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class="line"> 1  0      0 766596   2108 116392    0    0   334    36  144  191  0  1 98  0  0</span><br><span class="line"> 0  0      0 766596   2108 116392    0    0     0     0  180  148  0  0 100  0  0</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 显示系统各种资源之间相关性能简要信息，主要看CPU负载情况。2表示每个两秒采集一次服务器状态，2表示只采集两次。也可以只使用vmstat 2命令，每2秒显示一次，一直监控</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> r：表示运行队列(就是说多少个进程真的分配到CPU)，我测试的服务器目前CPU比较空闲，没什么程序在跑，当这个值超过了CPU数目，就会出现CPU瓶颈了。这个也和top的负载有关系，一般负载超过了3就比较高，超过了5就高，超过了10就不正常了，服务器的状态很危险。top的负载类似每秒的运行队列。如果运行队列过大，表示你的CPU很繁忙，一般会造成CPU使用率很高。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> b：表示阻塞的进程,这个不多说，进程阻塞，大家懂的。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> swpd：虚拟内存已使用的大小，如果大于0，表示你的机器物理内存不足了，如果不是程序内存泄露的原因，那么你该升级内存了或者把耗内存的任务迁移到其他机器。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> free：空闲的物理内存的大小，我的机器内存总共8G，剩余3415M。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> buff：Linux/Unix系统是用来存储，目录里面有什么内容，权限等的缓存，我本机大概占用300多M</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cache：cache直接用来记忆我们打开的文件,给文件做缓冲，我本机大概占用300多M(这里是Linux/Unix的聪明之处，把空闲的物理内存的一部分拿来做文件和目录的缓存，是为了提高 程序执行的性能，当程序使用内存时，buffer/cached会很快地被使用。)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> si：每秒从磁盘读入虚拟内存的大小，如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉。我的机器内存充裕，一切正常。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> so：每秒虚拟内存写入磁盘的大小，如果这个值大于0，同上。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bi：块设备每秒接收的块数量，这里的块设备是指系统上所有的磁盘和其他块设备，默认块大小是1024byte，我本机上没什么IO操作，所以一直是0，但是我曾在处理拷贝大量数据(2-3T)的机器上看过可以达到140000/s，磁盘写入速度差不多140M每秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bo：块设备每秒发送的块数量，例如我们读取文件，bo就要大于0。bi和bo一般都要接近0，不然就是IO过于频繁，需要调整。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span>：每秒CPU的中断次数，包括时间中断</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cs：每秒上下文切换次数，例如我们调用系统函数，就要进行上下文切换，线程的切换，也要进程上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的数目,例如在apache和nginx这种web服务器中，我们一般做性能测试时会进行几千并发甚至几万并发的测试，选择web服务器的进程可以由进程或者线程的峰值一直下调，压测，直到cs到一个比较小的值，这个进程和线程数就是比较合适的值了。系统调用也是，每次调用系统函数，我们的代码就会进入内核空间，导致上下文切换，这个是很耗资源，也要尽量避免频繁调用系统函数。上下文切换次数过多表示你的CPU大部分浪费在上下文切换，导致CPU干正经事的时间少了，CPU没有充分利用，是不可取的。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> us：用户CPU时间，我曾经在一个做加密解密很频繁的服务器上，可以看到us接近100,r运行队列达到80(机器在做压力测试，性能表现不佳)。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sy：系统CPU时间，如果太高，表示系统调用时间长，例如是IO操作频繁。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> id：空闲 CPU时间，一般来说，id + us + sy = 100,一般我认为id是空闲CPU使用率，us是用户CPU使用率，sy是系统CPU使用率。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> si、so的值长期不为0，表示系统内存不足。需增加系统内存。</span></span><br></pre></td></tr></table></figure>
<h3 id="sar命令"><a href="#sar命令" class="headerlink" title="sar命令"></a>sar命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"> sar（System ActivityReporter系统活动情况报告）是目前Linux上最为全面的系统性能分析工具之一，可以从多方面对系统的活动进行报告，包括：文件的读写情况、系统调用的使用情况、磁盘I/O、CPU效率、内存使用状况、进程活动及IPC有关的活动等，sar命令由sysstat安装包安装</span><br><span class="line"></span><br><span class="line">用法: sar [ 选项 ] [ &lt;时间间隔&gt; [ &lt;次数&gt; ] ]</span><br><span class="line">选项:</span><br><span class="line">-A：所有报告的总和</span><br><span class="line">-b：显示I/O和传递速率的统计信息</span><br><span class="line">-B：显示换页状态</span><br><span class="line">-d：输出每一块磁盘的使用信息</span><br><span class="line">-e：设置显示报告的结束时间</span><br><span class="line">-f：从制定的文件读取报告</span><br><span class="line">-i：设置状态信息刷新的间隔时间</span><br><span class="line">-P：报告每个CPU的状态</span><br><span class="line">-R：显示内存状态</span><br><span class="line">-u：输出cpu使用情况和统计信息</span><br><span class="line">-v：显示索引节点、文件和其他内核表的状态</span><br><span class="line">-w：显示交换分区的状态</span><br><span class="line">-x：显示给定进程的装</span><br><span class="line">-r：报告内存利用率的统计信息</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@test ~]# sar -u 3 4</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:18:58 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">09:19:01 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">09:19:04 PM     all      0.00      0.00      0.17      0.00      0.00     99.83</span><br><span class="line">09:19:07 PM     all      0.00      0.00      0.17      0.00      0.00     99.83</span><br><span class="line">09:19:10 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">Average:        all      0.00      0.00      0.08      0.00      0.00     99.92</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每间隔3秒钟统计一次总共统计4次</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %user：显示用户进程消耗的CPU 时间百分比。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %nice：显示运行正常进程所消耗的CPU 时间百分比。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %system：显示系统进程消耗的CPU时间百分比。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %iowait：显示IO等待所占用的CPU时间百分比</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %steal：显示在内存相对紧张的环境下pagein强制对不同的页面进行的steal操作 。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %idle：显示CPU处在空闲状态的时间百分比。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果系统CPU整体利用率不高，而应用响应缓慢，可能是在一个多CPU的系统中，程序使用了单线程的原因。单线程只使用一个CPU，导致这个CPU占用率为100%，无法处理其它请求，而其它的CPU却闲置，这就导致了整体CPU使用率不高，而应用缓慢现象的发生。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在以上的显示当中，主要看%iowait和%idle，%iowait过高表示存在I/O瓶颈，即磁盘IO无法满足业务需求，如果%idle过低表示CPU使用率比较严重，需要结合内存使用等情况判断CPU是否瓶颈。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -P 1 3 3</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:36:03 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">11:36:06 PM       1      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">11:36:09 PM       1      0.00      0.00      0.33      0.00      0.00     99.67</span><br><span class="line">11:36:12 PM       1      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">Average:          1      0.00      0.00      0.11      0.00      0.00     99.89</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-P选项指定监控1号CPU信息，每3秒显示一次，一共显示3次</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -u -o /tmp/1.txt 2 3</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:37:52 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">11:37:54 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">11:37:56 PM     all      0.00      0.00      0.25      0.00      0.00     99.75</span><br><span class="line">11:37:58 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">Average:        all      0.00      0.00      0.08      0.00      0.00     99.92</span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存监控文件，保存后的文件是二进制的，无法使用vim和cat直接打开</span></span><br><span class="line">[root@test ~]# sar -u -f /tmp/1.txt </span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:37:52 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">11:37:54 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">11:37:56 PM     all      0.00      0.00      0.25      0.00      0.00     99.75</span><br><span class="line">11:37:58 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br><span class="line">Average:        all      0.00      0.00      0.08      0.00      0.00     99.92</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从二进制文件读取</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -q</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:13:34 PM       LINUX RESTART</span><br><span class="line"></span><br><span class="line">09:20:01 PM   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked</span><br><span class="line">09:30:01 PM         0       113      0.00      0.01      0.01         0</span><br><span class="line">09:40:01 PM         0       113      0.08      0.03      0.02         0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看平均负载</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> runq-sz：运行队列的长度（等待运行的进程数，每核的CP不能超过3个）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> plist-sz：进程列表中的进程（processes）和线程数（threads）的数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ldavg-1：最后1分钟的CPU平均负载，即将多核CPU过去一分钟的负载相加再除以核心数得出的平均值，5分钟和15分钟以此类推</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ldavg-5：最后5分钟的CPU平均负载</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ldavg-15：最后15分钟的CPU平均负载</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -r</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:13:34 PM       LINUX RESTART</span><br><span class="line"></span><br><span class="line">09:20:01 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">09:30:01 PM    765604    234116     23.42      2108     77200    268076      8.66     83636     62712         0</span><br><span class="line">09:40:01 PM    765664    234056     23.41      2108     77212    268076      8.66     83944     62428         0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内存使用情况</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kbmemfree：空闲的物理内存大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kbmemused：使用中的物理内存大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %memused：物理内存使用率</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kbbuffers：内核中作为缓冲区使用的物理内存大小，kbbuffers和kbcached:这两个值就是free命令中的buffer和cache. </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kbcached：缓存的文件大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kbcommit：保证当前系统正常运行所需要的最小内存，即为了确保内存不溢出而需要的最少内存（物理内存+Swap分区）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> commit 这个值是kbcommit与内存总量（物理内存+swap分区）的一个百分比的值</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -W</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:13:34 PM       LINUX RESTART</span><br><span class="line"></span><br><span class="line">09:20:01 PM  pswpin/s pswpout/s</span><br><span class="line">09:30:01 PM      0.00      0.00</span><br><span class="line">09:40:01 PM      0.00      0.00</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统swap分区的统计信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pswpin/s：每秒从交换分区到系统的交换页面（swap page）数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pswpott/s：每秒从系统交换到swap的交换页面（swap page）的数量</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -b</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:13:34 PM       LINUX RESTART</span><br><span class="line"></span><br><span class="line">09:20:01 PM       tps      rtps      wtps   bread/s   bwrtn/s</span><br><span class="line">09:30:01 PM      0.08      0.00      0.08      0.00      1.18</span><br><span class="line">09:40:01 PM      0.09      0.00      0.09      0.00      1.12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看I/O和传递速率的统计信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tps：磁盘每秒钟的IO总数，等于iostat中的tps</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rtps：每秒钟从磁盘读取的IO总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wtps：每秒钟从写入到磁盘的IO总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bread/s：每秒钟从磁盘读取的块总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bwrtn/s：每秒钟此写入到磁盘的块总数</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -dp 2 2</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:44:35 PM       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util</span><br><span class="line">11:44:37 PM       sda      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line"><span class="meta">#</span><span class="bash"> sar –d组合，可以对系统的磁盘IO做一个基本的统计</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DEV 磁盘设备的名称，如果不加-p，会显示dev253-0类似的设备名称，因此加上-p显示的名称更直接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tps：每秒I/O的传输总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rd_sec/s：每秒读取的扇区的总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wr_sec/s：每秒写入的扇区的总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avgrq-sz：平均每次次磁盘I/O操作的数据大小（扇区）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avgqu-sz：磁盘请求队列的平均长度</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> await：平均每次设备I/O操作等待时间（毫秒）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> svctm：平均每次设备I/O操作的服务时间（毫秒）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %util：一秒钟有百分之几的时间用于I/O操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对磁盘IO性能评判标准：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 正常svctm应小于await值，而svctm和磁盘性能有关，CPU、内存负荷也会对svctm值造成影响，过多的请求也会间接的导致svctm值的增加。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> await值取决svctm和I/O队列长度以及I/O请求模式，如果svctm的值与await很接近，表示几乎没有I/O等待，磁盘性能很好，如果await的值远高于svctm的值，则表示I/O队列等待太长，系统上运行的应用程序将变慢，此时可以通过更换更快的硬盘来解决问题。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %util：衡量磁盘I/O重要指标，如%util接近100%，表示磁盘产生的I/O请求太多，I/O系统已经满负荷工作，该磁盘可能存在瓶颈。可优化程序或者 通过更换 更高、更快的磁盘。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -v</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">09:13:34 PM       LINUX RESTART</span><br><span class="line"></span><br><span class="line">09:20:01 PM dentunusd   file-nr  inode-nr    pty-nr</span><br><span class="line">09:30:01 PM      8571      1088     17484         1</span><br><span class="line">09:40:01 PM      8574      1120     17481         1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进程、inode、文件和锁表状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dentunusd：在缓冲目录条目中没有使用的条目数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> file-nr：被系统使用的文件句柄数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> inode-nr：已经使用的索引数量 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pty-nr：使用的pty数量</span></span><br><span class="line">================================================================================</span><br><span class="line">这里面的索引和文件句柄值不是ulimit -a查看到的值，而是sysctl.conf里面定义的和内核相关的值， max-file表示系统级别的能够打开的文件句柄的数量， 而ulimit -n控制进程级别能够打开的文件句柄的数量，可以使用sysctl  -a | grep inode和sysctl  -a | grep file查看，具体含义如下：</span><br><span class="line"></span><br><span class="line">file-max中指定了系统范围内所有进程可打开的文件句柄的数量限制(系统级别， kernel-level)。 （The value in file-max denotes the maximum number of file handles that the Linux kernel will allocate）。当收到"Too many open files in system"这样的错误消息时， 就应该增加这个值了。</span><br><span class="line">[root@test ~]# cat /proc/sys/fs/file-max</span><br><span class="line">95823</span><br><span class="line">[root@test ~]# echo 100000 &gt; /proc/sys/fs/file-max</span><br><span class="line">或者</span><br><span class="line">[root@test ~]# echo ""fs.file-max=65535" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@test ~]# sysctl -p</span><br><span class="line">file-nr 可以查看系统中当前打开的文件句柄的数量。 他里面包括3个数字： 第一个表示已经分配了的文件描述符数量， 第二个表示空闲的文件句柄数量， 第三个表示能够打开文件句柄的最大值（跟file-max一致）。  内核会动态的分配文件句柄， 但是不会再次释放他们（这个可能不适应最新的内核了， 在我的file-nr中看到第二列一直为0， 第一列有增有减）	</span><br><span class="line">man bash， 找到说明ulimit的那一节：提供对shell及其启动的进程的可用资源（包括文件句柄， 进程数量， core文件大小等）的控制。 这是进程级别的， 也就是说系统中某个session及其启动的每个进程能打开多少个文件描述符， 能fork出多少个子进程等... 当达到上限时， 会报错"Too many open files"或者遇上Socket/File: Can’t open so many files等</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -n DEV 1 1</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:52:46 PM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</span><br><span class="line">11:52:47 PM     ens35      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">11:52:47 PM        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">11:52:47 PM     ens33      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每间隔1秒统计一次，总计统计1次</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sar -n选项使用6个不同的开关：DEV，EDEV，NFS，NFSD，SOCK，IP，EIP，ICMP，EICMP，TCP，ETCP，UDP，SOCK6，IP6，EIP6，ICMP6，EICMP6和UDP6 ，DEV显示网络接口信息，EDEV显示关于网络错误的统计数据，NFS统计活动的NFS客户端的信息，NFSD统计NFS服务器的信息，SOCK显示套接字信息，ALL显示所有5个开关。它们可以单独或者一起使用。 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IFACE：本地网卡接口的名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxpck/s：每秒钟接受的数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txpck/s：每秒钟发送的数据库</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxKB/S：每秒钟接受的数据包大小，单位为KB</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txKB/S：每秒钟发送的数据包大小，单位为KB</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxcmp/s：每秒钟接受的压缩数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txcmp/s：每秒钟发送的压缩包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxmcst/s：每秒钟接收的多播数据包  </span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -n EDEV 1 1</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:55:30 PM     IFACE   rxerr/s   txerr/s    coll/s  rxdrop/s  txdrop/s  txcarr/s  rxfram/s  rxfifo/s  txfifo/s</span><br><span class="line">11:55:31 PM     ens35      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">11:55:31 PM        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">11:55:31 PM     ens33      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计网络设备通信失败信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IFACE：网卡名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxerr/s：每秒钟接收到的损坏的数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txerr/s：每秒钟发送的数据包错误数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> coll/s：当发送数据包时候，每秒钟发生的冲撞（collisions）数，这个是在半双工模式下才有</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxdrop/s：当由于缓冲区满的时候，网卡设备接收端每秒钟丢掉的网络包的数目</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txdrop/s：当由于缓冲区满的时候，网络设备发送端每秒钟丢掉的网络包的数目</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txcarr/s：当发送数据包的时候，每秒钟载波错误发生的次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxfram：在接收数据包的时候，每秒钟发生的帧对其错误的次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rxfifo：在接收数据包的时候，每秒钟缓冲区溢出的错误发生的次数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> txfifo：在发生数据包 的时候，每秒钟缓冲区溢出的错误发生的次数</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -n SOCK 1 1    </span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:57:03 PM    totsck    tcpsck    udpsck    rawsck   ip-frag    tcp-tw</span><br><span class="line">11:57:04 PM       568         3         4         0         0         0</span><br><span class="line">Average:          568         3         4         0         0         0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计socket连接信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> totsck：当前被使用的socket总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tcpsck：当前正在被使用的TCP的socket总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> udpsck：当前正在被使用的UDP的socket总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rawsck：当前正在被使用于RAW的skcket总数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span>-frag：当前的IP分片的数目</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tcp-tw：TCP套接字中处于TIME-WAIT状态的连接数量</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# sar -n TCP 1 3</span><br><span class="line">Linux 3.10.0-693.el7.x86_64 (test)      01/16/2019      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">11:59:25 PM  active/s passive/s    iseg/s    oseg/s</span><br><span class="line">11:59:26 PM      0.00      0.00      0.00      0.00</span><br><span class="line">11:59:27 PM      0.00      0.00      1.00      1.00</span><br><span class="line">11:59:28 PM      0.00      0.00      1.00      1.00</span><br><span class="line">Average:         0.00      0.00      0.67      0.67</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP连接的统计</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> active/s：新的主动连接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> passive/s：新的被动连接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iseg/s：接受的段</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> oseg/s：输出的段</span></span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">sar -n 使用总结</span><br><span class="line">-n DEV ： 网络接口统计信息。</span><br><span class="line">-n EDEV ： 网络接口错误。</span><br><span class="line">-n IP ： IP数据报统计信息。</span><br><span class="line">-n EIP ： IP错误统计信息。</span><br><span class="line">-n TCP ： TCP统计信息。</span><br><span class="line">-n ETCP ： TCP错误统计信息。</span><br><span class="line">-n SOCK ： 套接字使用。</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line">常用命令</span><br><span class="line">sar -b 5 5：IO传送速率</span><br><span class="line">sar -B 5 5：页交换速率</span><br><span class="line">sar -c 5 5：进程创建的速率</span><br><span class="line">sar -d 5 5：块设备的活跃信息</span><br><span class="line">sar -n DEV 5 5：网路设备的状态信息</span><br><span class="line">sar -n SOCK 5 5：SOCK的使用情况</span><br><span class="line">sar -n ALL 5 5：所有的网络状态信息</span><br><span class="line">sar -P ALL 5 5：每颗CPU的使用状态信息和IOWAIT统计状态 </span><br><span class="line">sar -q 5 5：队列的长度（等待运行的进程数）和负载的状态</span><br><span class="line">sar -r 5 5：内存和swap空间使用情况</span><br><span class="line">sar -R 5 5：内存的统计信息（内存页的分配和释放、系统每秒作为BUFFER使用内存页、每秒被cache到的内存页）</span><br><span class="line">sar -u 5 5：CPU的使用情况和IOWAIT信息（同默认监控）</span><br><span class="line">sar -v 5 5 ：inode, file and other kernel tablesd的状态信息</span><br><span class="line">sar -w 5 5 ：每秒上下文交换的数目</span><br><span class="line">sar -W 5 5：SWAP交换的统计信息(监控状态同iostat 的si so)</span><br><span class="line">sar -x 2906 5 5：显示指定进程(2906)的统计信息，信息包括：进程造成的错误、用户级和系统级用户CPU的占用情况、运行在哪颗CPU上</span><br><span class="line">sar -y 5 5：TTY设备的活动状态</span><br><span class="line">sar将结果输出到文件(-o)和读取记录信息(-f)</span><br></pre></td></tr></table></figure>
<h3 id="netstat命令"><a href="#netstat命令" class="headerlink" title="netstat命令"></a>netstat命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">功能说明：显示网络状态。</span><br><span class="line">语　　法：netstat [-acCeFghilMnNoprstuvVwx] [-A&lt;网络类型&gt;][--ip]</span><br><span class="line">补充说明：利用netstat指令可让你得知整个Linux系统的网络情况。</span><br><span class="line">参　　数：</span><br><span class="line">-a 或--all：显示所有连线中的Socket。</span><br><span class="line">-A ：&lt;网络类型&gt;或–&lt;网络类型&gt; 列出该网络类型连线中的相关地址。</span><br><span class="line">-c或--continuous：持续列出网络状态。</span><br><span class="line">-C或--cache：显示路由器配置的快取信息。</span><br><span class="line">-e或--extend：显示网络其他相关信息。</span><br><span class="line">-F或--fib：显示FIB。</span><br><span class="line">-g或--groups：显示多重广播功能群组组员名单。</span><br><span class="line">-h或--help：在线帮助。</span><br><span class="line">-i或--interfaces：显示网络界面信息表单。</span><br><span class="line">-l或--listening：显示监控中的服务器的Socket。</span><br><span class="line">-M或--masquerade：显示伪装的网络连线。</span><br><span class="line">-n或--numeric：直接使用IP地址，而不通过域名服务器。</span><br><span class="line">-N或--netlink或--symbolic：显示网络硬件外围设备的符号连接名称。</span><br><span class="line">-o或--timers：显示计时器。</span><br><span class="line">-p或--programs：显示正在使用Socket的程序识别码和程序名称。</span><br><span class="line">-r或--route：显示 Routing Table。</span><br><span class="line">-s或--statistice：显示网络工作信息统计表。</span><br><span class="line">-t或--tcp：显示TCP 传输协议的连线状况。</span><br><span class="line">-u或--udp：显示UDP传输协议的连线状况。</span><br><span class="line">-v或--verbose：显示指令执行过程。</span><br><span class="line">-V或--version：显示版本信息。</span><br><span class="line">-w或--raw：显示RAW传输协议的连线状况。</span><br><span class="line">-x或--unix：此参数的效果和指定”-A unix”参数相同。</span><br><span class="line">–ip或--inet：此参数的效果和指定”-A inet”参数相同。</span><br><span class="line"></span><br><span class="line">网络连接状态详解</span><br><span class="line">共有12中可能的状态，前面11种是按照TCP连接建立的三次握手和TCP连接断开的四次挥手过程来描述的。</span><br><span class="line">1. LISTEN：首先服务端需要打开一个socket进行监听，状态为LISTEN。/* The socket is listening for incoming connections. 侦听来自远方TCP端口的连接请求*/</span><br><span class="line">2. SYN_SENT：客户端通过应用程序调用connect进行active open。于是客户端tcp发送一个SYN以请求建立一个连接。之后状态置为SYN_SENT。/*The socket is actively attempting to establish a connection. 在发送连接请求后等待匹配的连接请求 */</span><br><span class="line">3. SYN_RECV：服务端应发出ACK确认客户端的 SYN，同时自己向客户端发送一个SYN。之后状态置为SYN_RECV。/* A connection request has been received from the network. 在收到和发送一个连接请求后等待对连接请求的确认 */</span><br><span class="line">4. ESTABLISHED：代表一个打开的连接，双方可以进行或已经在数据交互了。/* The socket has an established connection. 代表一个打开的连接，数据可以传送给用户 */</span><br><span class="line">5. FIN_WAIT1：主动关闭(active close)端应用程序调用close，于是其TCP发出FIN请求主动关闭连接，之后进入FIN_WAIT1状态。/* The socket is closed, and the connection is shutting down. 等待远程TCP的连接中断请求，或先前的连接中断请求的确认 */</span><br><span class="line">6. CLOSE_WAIT：被动关闭(passive close)端TCP接到FIN后，就发出ACK以回应FIN请求(它的接收也作为文件结束符传递给上层应用程序)，并进入CLOSE_WAIT。/* The remote end has shut down, waiting for the socket to close. 等待从本地用户发来的连接中断请求 */</span><br><span class="line">7. FIN_WAIT2：主动关闭端接到ACK后，就进入了 FIN-WAIT-2 。/* Connection is closed, and the socket is waiting for a shutdown from the remote end. 从远程TCP等待连接中断请求 */</span><br><span class="line">8. LAST_ACK:：被动关闭端一段时间后，接收到文件结束符的应用程序将调用CLOSE关闭连接。这导致它的TCP也发送一个 FIN，等待对方的ACK。就进入了LAST-ACK 。/* The remote end has shut down, and the socket is closed. Waiting for acknowledgement. 等待原来发向远程TCP的连接中断请求的确认 */</span><br><span class="line">9. TIME_WAIT：在主动关闭端接收到FIN后，TCP 就发送ACK包，并进入TIME-WAIT状态。/* The socket is waiting after close to handle packets still in the network.等待足够的时间以确保远程TCP接收到连接中断请求的确认 */</span><br><span class="line">10. CLOSING: 比较少见。/* Both sockets are shut down but we still don’t have all our data sent. 等待远程TCP对连接中断的确认 */</span><br><span class="line">11. CLOSED：被动关闭端在接受到ACK包后，就进入了closed的状态。连接结束。/* The socket is not being used. 没有任何连接状态 */</span><br><span class="line">12. UNKNOWN：未知的Socket状态。/* The state of the socket is unknown. */</span><br><span class="line"></span><br><span class="line">SYN： (同步序列编号，Synchronize Sequence Numbers)该标志仅在三次握手建立TCP连接时有效。表示一个新的TCP连接请求。</span><br><span class="line">ACK：(确认编号，Acknowledgement Number)是对TCP请求的确认标志，同时提示对端系统已经成功接收所有数据。</span><br><span class="line">FIN： (结束标志，FINish)用来结束一个TCP回话。但对应端口仍处于开放状态，准备接收后续数据。</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@test ~]# netstat -a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出所有端口</span></span><br><span class="line">[root@test ~]# netstat -at</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出所有TCP端口</span></span><br><span class="line">[root@test ~]# netstat -au</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出所有UDP端口</span></span><br><span class="line">[root@test ~]# netstat -l</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只显示监听端口</span></span><br><span class="line">[root@test ~]# netstat -lt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示监听TCP端口</span></span><br><span class="line">[root@test ~]# netstat -lu</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示监听UDP端口</span></span><br><span class="line">[root@test ~]# netstat -lx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示监听UNIX端口</span></span><br><span class="line">[root@test ~]# netstat -s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有端口的统计信息</span></span><br><span class="line">[root@test ~]# netstat -st</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有TCP的统计信息</span></span><br><span class="line">[root@test ~]# netstat -su</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有UDP的统计信息</span></span><br><span class="line">[root@test ~]# netstat -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示 PID 和进程名称</span></span><br><span class="line">[root@test ~]# netstat -r</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface</span><br><span class="line">default         bogon           0.0.0.0         UG        0 0          0 ens33</span><br><span class="line">172.16.106.0    0.0.0.0         255.255.255.0   U         0 0          0 ens35</span><br><span class="line">192.168.1.0     0.0.0.0         255.255.255.0   U         0 0          0 ens33</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示核心路由信息</span></span><br><span class="line">[root@test ~]# netstat -rn</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface</span><br><span class="line">0.0.0.0         192.168.1.1     0.0.0.0         UG        0 0          0 ens33</span><br><span class="line">172.16.106.0    0.0.0.0         255.255.255.0   U         0 0          0 ens35</span><br><span class="line">192.168.1.0     0.0.0.0         255.255.255.0   U         0 0          0 ens33</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示数字格式，不查询主机名称</span></span><br><span class="line">[root@test ~]# netstat -c</span><br><span class="line"><span class="meta">#</span><span class="bash"> netstat 将每隔一秒输出网络信息</span></span><br><span class="line">[root@test ~]# netstat -ie</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示网络接口列表详细信息，结果如ifconfig</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# netstat -ant|grep "192.168.1.14:22"|awk '&#123;print $5&#125;'|sort|uniq -c|sort -nr|head -20</span><br><span class="line">      1 192.168.1.9:51292</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看连接某服务端口最多的的IP地址。uniq的-c或--count选项是在每列旁边显示该行重复出现的次数。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# netstat -nat |awk '&#123;print $6&#125;'|sort|uniq -c|sort -rn</span><br><span class="line">      4 LISTEN</span><br><span class="line">      1 Foreign</span><br><span class="line">      1 ESTABLISHED</span><br><span class="line">      1 established)</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP各种状态列表</span></span><br></pre></td></tr></table></figure>
<h3 id="系统连接状态"><a href="#系统连接状态" class="headerlink" title="系统连接状态"></a>系统连接状态</h3><h4 id="查看TCP连接状态"><a href="#查看TCP连接状态" class="headerlink" title="查看TCP连接状态"></a>查看TCP连接状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">netstat -nat |awk '&#123;print $6&#125;'|sort|uniq -c|sort -rn</span><br><span class="line">netstat -n | awk  '/^tcp/ &#123;++S[$NF]&#125;;END &#123;for(a in S) print a, S[a]&#125;'</span><br><span class="line">netstat -n | awk '/^tcp/ &#123;++state[$NF]&#125;; END &#123;for(key in state) print key,"\t",state[key]&#125;'</span><br><span class="line">netstat -n | awk '/^tcp/ &#123;++arr[$NF]&#125;;END &#123;for(k in arr) print k,"\t",arr[k]&#125;'</span><br><span class="line">netstat -n |awk '/^tcp/ &#123;print $NF&#125;'|sort|uniq -c|sort -rn</span><br><span class="line">netstat -ant | awk '&#123;print $NF&#125;' | grep -v '[a-z]' | sort | uniq -c</span><br></pre></td></tr></table></figure>
<h4 id="查找请求数请20个IP（常用于查找攻击来源）"><a href="#查找请求数请20个IP（常用于查找攻击来源）" class="headerlink" title="查找请求数请20个IP（常用于查找攻击来源）"></a>查找请求数请20个IP（常用于查找攻击来源）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -anlp|grep 80|grep tcp|awk '&#123;print $5&#125;'|awk -F: '&#123;print $1&#125;'|sort|uniq -c|sort -nr|head -n20</span><br><span class="line">netstat -ant |awk '/:80/&#123;split($5,ip,':');++A[ip[1]]&#125;END&#123;for(i in A) print A[i],i&#125;' |sort -rn|head -n20</span><br></pre></td></tr></table></figure>
<h4 id="用tcpdump嗅探80端口的访问看看谁最高"><a href="#用tcpdump嗅探80端口的访问看看谁最高" class="headerlink" title="用tcpdump嗅探80端口的访问看看谁最高"></a>用tcpdump嗅探80端口的访问看看谁最高</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# tcpdump -i ens33 -tnn dst port 80 -c 1000 | awk -F"." '&#123;print $1"."$2"."$3"."$4&#125;' | sort | uniq -c | sort -nr |head -20</span><br></pre></td></tr></table></figure>
<h4 id="查找较多time-wait连接"><a href="#查找较多time-wait连接" class="headerlink" title="查找较多time_wait连接"></a>查找较多time_wait连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -n|grep TIME_WAIT|awk '&#123;print $5&#125;'|sort|uniq -c|sort -rn|head -n20</span><br></pre></td></tr></table></figure>
<h4 id="找查较多的SYN连接"><a href="#找查较多的SYN连接" class="headerlink" title="找查较多的SYN连接"></a>找查较多的SYN连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an | grep SYN | awk '&#123;print $5&#125;' | awk -F: '&#123;print $1&#125;' | sort | uniq -c | sort -nr | more</span><br></pre></td></tr></table></figure>
<h4 id="根据端口列进程PID"><a href="#根据端口列进程PID" class="headerlink" title="根据端口列进程PID"></a>根据端口列进程PID</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ntlp | grep 80 | awk '&#123;print $7&#125;' | cut -d/ -f1</span><br></pre></td></tr></table></figure>
<h3 id="网站日志分析（Apache）"><a href="#网站日志分析（Apache）" class="headerlink" title="网站日志分析（Apache）"></a>网站日志分析（Apache）</h3><h4 id="获得访问前10位的ip地址"><a href="#获得访问前10位的ip地址" class="headerlink" title="获得访问前10位的ip地址"></a>获得访问前10位的ip地址</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat access.log|awk '&#123;print $1&#125;'|sort|uniq -c|sort -nr|head -10</span><br><span class="line">cat access.log|awk '&#123;counts[$(11)]+=1&#125;; END &#123;for(url in counts) print counts[url], url&#125;'</span><br></pre></td></tr></table></figure>
<h4 id="访问次数最多的文件或页面-取前20"><a href="#访问次数最多的文件或页面-取前20" class="headerlink" title="访问次数最多的文件或页面,取前20"></a>访问次数最多的文件或页面,取前20</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log|awk '&#123;print $11&#125;'|sort|uniq -c|sort -nr|head -20</span><br></pre></td></tr></table></figure>
<h4 id="列出传输最大的几个exe文件（分析下载站的时候常用）"><a href="#列出传输最大的几个exe文件（分析下载站的时候常用）" class="headerlink" title="列出传输最大的几个exe文件（分析下载站的时候常用）"></a>列出传输最大的几个exe文件（分析下载站的时候常用）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '($7~/\.exe/)&#123;print $10 " " $1 " " $4 " " $7&#125;'|sort -nr|head -20</span><br></pre></td></tr></table></figure>
<h4 id="列出输出大于200000byte-约200kb-的exe文件以及对应文件发生次数"><a href="#列出输出大于200000byte-约200kb-的exe文件以及对应文件发生次数" class="headerlink" title="列出输出大于200000byte(约200kb)的exe文件以及对应文件发生次数"></a>列出输出大于200000byte(约200kb)的exe文件以及对应文件发生次数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '($10 &gt; 200000 &amp;&amp; $7~/\.exe/)&#123;print $7&#125;'|sort -n|uniq -c|sort -nr|head -100</span><br></pre></td></tr></table></figure>
<h4 id="如果日志最后一列记录的是页面文件传输时间，则有列出到客户端最耗时的页面"><a href="#如果日志最后一列记录的是页面文件传输时间，则有列出到客户端最耗时的页面" class="headerlink" title="如果日志最后一列记录的是页面文件传输时间，则有列出到客户端最耗时的页面"></a>如果日志最后一列记录的是页面文件传输时间，则有列出到客户端最耗时的页面</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '($7~/\.php/)&#123;print $NF " " $1 " " $4 " " $7&#125;'|sort -nr|head -100</span><br></pre></td></tr></table></figure>
<h4 id="列出最最耗时的页面-超过60秒的-的以及对应页面发生次数"><a href="#列出最最耗时的页面-超过60秒的-的以及对应页面发生次数" class="headerlink" title="列出最最耗时的页面(超过60秒的)的以及对应页面发生次数"></a>列出最最耗时的页面(超过60秒的)的以及对应页面发生次数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '($NF &gt; 60 &amp;&amp; $7~/\.php/)&#123;print $7&#125;'|sort -n|uniq -c|sort -nr|head -100</span><br></pre></td></tr></table></figure>
<h4 id="列出传输时间超过-30-秒的文件"><a href="#列出传输时间超过-30-秒的文件" class="headerlink" title="列出传输时间超过 30 秒的文件"></a>列出传输时间超过 30 秒的文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '($NF &gt; 30)&#123;print $7&#125;'|sort -n|uniq -c|sort -nr|head -20</span><br></pre></td></tr></table></figure>
<h4 id="统计网站流量（G"><a href="#统计网站流量（G" class="headerlink" title="统计网站流量（G)"></a>统计网站流量（G)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '&#123;sum+=$10&#125; END &#123;print sum/1024/1024/1024&#125;'</span><br></pre></td></tr></table></figure>
<h4 id="统计404的连接"><a href="#统计404的连接" class="headerlink" title="统计404的连接"></a>统计404的连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk '($9 ~/404/)' access.log | awk '&#123;print $9,$7&#125;' | sort</span><br></pre></td></tr></table></figure>
<h4 id="统计http-status"><a href="#统计http-status" class="headerlink" title="统计http status"></a>统计http status</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat access.log |awk '&#123;counts[$(9)]+=1&#125;; END &#123;for(code in counts) print code, counts[code]&#125;'</span><br><span class="line">cat access.log |awk '&#123;print $9&#125;'|sort|uniq -c|sort -rn</span><br></pre></td></tr></table></figure>
<h4 id="蜘蛛分析"><a href="#蜘蛛分析" class="headerlink" title="蜘蛛分析"></a>蜘蛛分析</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/tcpdump -i eth0 -l -s 0 -w - dst port 80 | strings | grep -i user-agent | grep -i -E 'bot|crawler|slurp|spider'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是哪些蜘蛛在抓取内容</span></span><br></pre></td></tr></table></figure>
<h4 id="网站日分析Squid"><a href="#网站日分析Squid" class="headerlink" title="网站日分析Squid"></a>网站日分析Squid</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zcat squid_access.log.tar.gz| awk '&#123;print $10,$7&#125;' |awk 'BEGIN&#123;FS="[ /]"&#125;&#123;trfc[$4]+=$1&#125;END&#123;for(domain in trfc)&#123;printf "%s\t%d\n",domain,trfc[domain]</span><br></pre></td></tr></table></figure>
<h3 id="查看数据库执行的sql"><a href="#查看数据库执行的sql" class="headerlink" title="查看数据库执行的sql"></a>查看数据库执行的sql</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 -s 0 -l -w - dst port 3306 | strings | egrep -i 'SELECT|UPDATE|DELETE|INSERT|SET|COMMIT|ROLLBACK|CREATE|DROP|ALTER|CALL'</span><br></pre></td></tr></table></figure>
<h3 id="系统Debug分析"><a href="#系统Debug分析" class="headerlink" title="系统Debug分析"></a>系统Debug分析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">strace -p pid</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调试命令</span></span><br><span class="line"></span><br><span class="line">gdb -p pid</span><br><span class="line"><span class="meta">#</span><span class="bash"> 跟踪指定进程的PID</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/13/shellScript语法及使用方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/13/shellScript语法及使用方法/" itemprop="url">
                  shellScript语法及使用方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-13 21:02:43" itemprop="dateCreated datePublished" datetime="2019-01-13T21:02:43+08:00">2019-01-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-03-20 15:53:25" itemprop="dateModified" datetime="2019-03-20T15:53:25+08:00">2019-03-20</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="清除日志的三种方法"><a href="#清除日志的三种方法" class="headerlink" title="清除日志的三种方法"></a>清除日志的三种方法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. echo &gt; test.log 或 echo "" &gt; test.log</span><br><span class="line">2. &gt;test.log</span><br><span class="line">3. cat /dev/null &gt; test.log</span><br></pre></td></tr></table></figure>
<h3 id="Shell脚本执行方式"><a href="#Shell脚本执行方式" class="headerlink" title="Shell脚本执行方式"></a>Shell脚本执行方式</h3><blockquote>
<p>当shell脚本以非交互的方式运行时，它会先查找环境变量ENV，该变量指定了一个环境文件（通常是.bashrc），然后从该环境变量文件开始执行，当读取了ENV文件后，SHELL才开始执行shell脚本中的内容。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1. bash script-name或sh script-name（推荐使用）；没有执行权限也可以执行。</span><br><span class="line">2. path/script-name或./script-name（当前路径 下执行脚本）</span><br><span class="line">3. source script-name或. script-name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意“.”点号；使用<span class="built_in">source</span>或点号来加载或读入脚本，然后，依次执行指定shell脚本文件son.sh中的所有语句。这些语句将作为当前父shell脚本father.sh进程的一部分运行。因此，使用<span class="built_in">source</span>或点号可以将son.sh自身脚本中的变量的值或函数等的返回值传递到当前的父shell脚本father.sh中使用。这就是在脚本中使用点或<span class="built_in">source</span>加载文件的意义，为使用加载的文件中的内容可被当前脚本使用。这是第三种方法与前两种的最大区别。</span></span><br><span class="line">全局环境变量：/etc/profile、/etc/profile.d、/etc/bashrc</span><br><span class="line">用户环境变量：./bash_profile、.bashrc</span><br><span class="line">例：</span><br><span class="line">[root@template sh]# vim tesh1.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">userdir=`pwd`</span><br><span class="line">[root@template sh]# chmod +x tesh1.sh </span><br><span class="line">[root@template sh]# bash tesh1.sh </span><br><span class="line">[root@template sh]# echo $userdir</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 没有执行结果</span></span><br><span class="line">[root@template sh]# . tesh1.sh </span><br><span class="line">[root@template sh]# echo $userdir</span><br><span class="line">/root/sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用<span class="built_in">source</span>或点号执行后，再用<span class="built_in">echo</span>命令执行才有结果。用<span class="built_in">source</span>或点号执行才能将变量加载到当前环境变量。</span></span><br></pre></td></tr></table></figure>
<h3 id="shell脚本开发基本规范及习惯"><a href="#shell脚本开发基本规范及习惯" class="headerlink" title="shell脚本开发基本规范及习惯"></a>shell脚本开发基本规范及习惯</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1. 开头指定脚本解释器</span><br><span class="line">2. 开头加版本版权等信息</span><br><span class="line">    #Date: 16:29 2012-3-30	时间</span><br><span class="line">    #Authou: oldboy	作者</span><br><span class="line">    #Mail：aaaa@qq.com	联系方式</span><br><span class="line">    #Function：this scripts function is ...	脚本的功能是什么 </span><br><span class="line">    #Version： 1.1	脚本的版本号</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可配置vim编辑文件时自动加上以上信息，方法是修改~/.vimrc配置文件</span></span><br><span class="line">3. 脚本中不用中文件注释</span><br><span class="line">4. 脚本以.sh为扩展名</span><br><span class="line">5. 代码书写优秀习惯</span><br><span class="line">    1. 成对内容的一次写出来，防止挂失</span><br><span class="line">    2. []中括号两端要有空格</span><br><span class="line">    3. 流程控制语句一次书写完</span><br><span class="line">        if 条件内容</span><br><span class="line">        then</span><br><span class="line">            内容</span><br><span class="line">        fi</span><br><span class="line">6. 通过缩进让代码易读</span><br></pre></td></tr></table></figure>
<h3 id="变量分类"><a href="#变量分类" class="headerlink" title="变量分类"></a>变量分类</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">* 变量分两类：环境变量（全局变量）和局部变量</span><br><span class="line"></span><br><span class="line">* 环境变量可以在命令中设置，但用户退出时这些变量值也会丢失，因此最好在用户家目录下的.bash_profile文件中或全局设置/etc/bashrc，/etc/profile文件或者/etc/profile.d中定义。将环境变量放入profile文件中，每次用户登录时这些变量值都将被初始化。</span><br><span class="line"></span><br><span class="line">* 有一些环境变量，比如HOME、PATH、SHELL、UID、USER等，在用户登录之前就已经被/bin/login程序设置好了。通常环境变量定义并保存在用户家目录下的.bash_profile文件中</span><br><span class="line"></span><br><span class="line">* PS1环境变量定义用户登录后的提示符如[\u@\h \W]$，\u表示用户名，\h表示主机名，\W表示路径</span><br><span class="line"></span><br><span class="line">TMOUT＝3600，此变量表示多久不操作就退出终端</span><br><span class="line">UID＝0，此变量表示用户的UID</span><br><span class="line">USER＝root，此变量表示当前用户的用户名</span><br><span class="line">HISTFILESIZE=50，历史文件能包含的最大行数</span><br><span class="line">HISTSIZE=50，记录在命令行历史文件中的命令行数</span><br><span class="line">HISTFILE=/root/.bash_history，历史记录文件的全路径 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的环境变量都可以加到/etc/profile文件中，加入后用<span class="built_in">source</span>或点号加载生效。</span></span><br><span class="line"></span><br><span class="line">*  设置环境变量要在给环境变量赋值后或设置变量时用export命令。带-x选项的declare内置命令也可以完成同样的功能。（注意：输出变量时不要在变量名前加$）</span><br><span class="line">1. export 变量名＝value</span><br><span class="line">2. 变量名＝value --&gt; export 变量名</span><br><span class="line">3. declare -x 变量名＝value</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以查看/etc/profile文件中是如何定义变量的</span></span><br><span class="line">用unset 变量名取消环境变量，变量名前不要加$符号。如果要永久生效，也要写到/etc/profile中。</span><br><span class="line"></span><br><span class="line">* 局部变量</span><br><span class="line">变量名＝value</span><br><span class="line">变量名＝'value'</span><br><span class="line">变量名="value"</span><br><span class="line">shell中变量名的要求：一般是字母，数字，下划线组成。字母开头</span><br><span class="line"></span><br><span class="line">* 自定义变量建议</span><br><span class="line">1. 纯数字（不带空格），定义方式可以不加引号（单或双）</span><br><span class="line">2. 没特殊情况，字符串一般用双引号定义，特别是多个字符串中间有空格时</span><br><span class="line">3. 变量内容需要原样输出时，要用单引号''</span><br><span class="line"></span><br><span class="line">* 变量命名规范</span><br><span class="line">1. 变量命名要统一，使用全部大写字母</span><br><span class="line">2. 避免无含义字符或数字</span><br><span class="line"><span class="meta">#</span><span class="bash"> 看/etc/init.d/<span class="built_in">functions</span>脚本中如何定义变量</span></span><br><span class="line"></span><br><span class="line">* 把命令定义为变量，就是将命令的执行结果给变量，用反引号或$()括起命令即可。</span><br><span class="line">tar zcf etc_$&#123;cmd&#125;_oldboy.tar.gz /etc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里cmd是自定义的变量，但如果要这样使用，要用大括号括起，因为如果不括起，系统就不能分辨出哪个是变量，可以会找<span class="variable">$cmd_oldboy</span>，这会执行错误。</span></span><br></pre></td></tr></table></figure>
<h3 id="位置变量"><a href="#位置变量" class="headerlink" title="位置变量"></a>位置变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">0：获取当前执行的shell脚本的文件名</span></span><br><span class="line"><span class="meta">$</span><span class="bash">n：获取当前执行的shell脚本的第n个参数</span></span><br><span class="line"><span class="meta">$</span><span class="bash">*：获取当前shell的所有参数，将所有的命令行参数视为单个字符</span></span><br><span class="line"><span class="meta">$</span><span class="bash"><span class="comment">#：获取当前shell命令行中参数的总个数</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">!：执行上一个指令的PID</span></span><br><span class="line"><span class="meta">$</span><span class="bash">?：获取执行结果返回值</span></span><br><span class="line">        执行结果返回值的意义：</span><br><span class="line">        0：正确执行</span><br><span class="line">        2：权限拒绝</span><br><span class="line">        1－125：表示运行失败</span><br><span class="line">        126：找到该命令了，但是无法执行</span><br><span class="line">        127：未找到要运行的命令</span><br><span class="line">        &gt;128：命令被系统强制结束</span><br><span class="line"><span class="meta">$</span><span class="bash">$：获取当前shell的进程号（PID）</span></span><br><span class="line"><span class="meta">$</span><span class="bash">_：在此之前执行的命令或脚本的最后一个参数</span></span><br><span class="line"><span class="meta">$</span><span class="bash">@：这个程序的所有参数，如<span class="string">"<span class="variable">$1</span>"</span> <span class="string">"<span class="variable">$2</span>"</span> <span class="string">"<span class="variable">$3</span>"</span>...</span></span><br><span class="line">=======================================================================================</span><br><span class="line"><span class="meta">$</span><span class="bash">*与 <span class="variable">$@</span>区别</span></span><br><span class="line"><span class="meta">$</span><span class="bash">*：将所有的命令行所有参数视为单个字符串，等同于“<span class="variable">$1</span><span class="variable">$2</span><span class="variable">$3</span>”</span></span><br><span class="line"><span class="meta">$</span><span class="bash">@：将命令行每个参数视为单独的字符串，等同于<span class="string">"<span class="variable">$1</span>"</span><span class="string">"<span class="variable">$2</span>"</span><span class="string">"<span class="variable">$3</span>"</span>。这是将参数传递给其他程序的最佳 方式，因为他会促使所有内嵌在每个参数里的任何空白。</span></span><br><span class="line">=======================================================================================</span><br><span class="line">例：</span><br><span class="line">sh n.sh "1 2 3"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用引号括起的部分表示一个参数。</span></span><br><span class="line"></span><br><span class="line">basename：获取名称，也就是最后的一段</span><br><span class="line">dirname：获取文件所在路径，也就是最后一段前面的内容</span><br></pre></td></tr></table></figure>
<h3 id="常用内部命令"><a href="#常用内部命令" class="headerlink" title="常用内部命令"></a>常用内部命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo</span><br><span class="line"></span><br><span class="line">exec</span><br><span class="line"></span><br><span class="line">eval</span><br><span class="line"></span><br><span class="line">export</span><br><span class="line"></span><br><span class="line">readonly</span><br><span class="line"></span><br><span class="line">read</span><br><span class="line"></span><br><span class="line">shift</span><br><span class="line"><span class="meta">#</span><span class="bash"> 按如下方式重新命名所有的位置参数变量，即<span class="variable">$2</span>成为<span class="variable">$1</span>，<span class="variable">$3</span>成为<span class="variable">$2</span>...在程序中每使用一次<span class="built_in">shift</span>语句，都使所有的位置参数依次向左移动一个位置，并使位置参数<span class="variable">$#</span>减1，直到减到0为止。可以查看ssh-copy-id脚本是如何使用<span class="built_in">shift</span>的</span></span><br><span class="line"></span><br><span class="line">wait</span><br><span class="line"></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">点</span><br></pre></td></tr></table></figure>
<h3 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">* 判断读取字符串的值</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var&#125;：变量var的值, 与<span class="variable">$var</span>相同</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var-DEFAULT&#125;：如果var没有被声明, 那么就以<span class="variable">$DEFAULT</span>作为其值 *</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var:-DEFAULT&#125;：如果var没有被声明, 或者其值为空, 那么就以<span class="variable">$DEFAULT</span>作为其值 *</span></span><br><span class="line">例</span><br><span class="line">[root@template sh]# echo $&#123;bbb-'ok'&#125;</span><br><span class="line">ok</span><br><span class="line">[root@template sh]# echo $bbb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> bbb没有被声明过</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var=DEFAULT&#125;：如果var没有被声明, 那么就以<span class="variable">$DEFAULT</span>作为其值 *</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var:=DEFAULT&#125;：如果var没有被声明, 或者其值为空, 那么就以<span class="variable">$DEFAULT</span>作为其值 *</span></span><br><span class="line">例</span><br><span class="line">[root@template sh]# echo $&#123;abc='ok'&#125;</span><br><span class="line">ok</span><br><span class="line">[root@template sh]# echo $abc</span><br><span class="line">ok</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var+OTHER&#125;：如果var声明了, 那么其值就是<span class="variable">$OTHER</span>, 否则就为null字符串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var:+OTHER&#125;：如果var被设置了, 那么其值就是<span class="variable">$OTHER</span>, 否则就为null字符串</span></span><br><span class="line"> 	 </span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var?ERR_MSG&#125;：如果var没被声明, 那么就打印<span class="variable">$ERR_MSG</span> *</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var:?ERR_MSG&#125;：如果var没被设置, 那么就打印<span class="variable">$ERR_MSG</span> *</span></span><br><span class="line"> 	 </span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;!varprefix*&#125;：匹配之前所有以varprefix开头进行声明的变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;!varprefix@&#125;：匹配之前所有以varprefix开头进行声明的变量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$&#123;!varprefix*&#125;</span>与<span class="variable">$&#123;!varprefix@&#125;</span>相似，可以通过变量名前缀字符，搜索已经定义的变量,无论是否为空值。</span></span><br><span class="line">例</span><br><span class="line">[root@template sh]# var1=11;var2=22;var3=33</span><br><span class="line">[root@template sh]# echo $var1</span><br><span class="line">11</span><br><span class="line">[root@template sh]# echo $var2</span><br><span class="line">22</span><br><span class="line">[root@template sh]# echo $var3</span><br><span class="line">33</span><br><span class="line">[root@template sh]# echo $&#123;!v@&#125;</span><br><span class="line">var1 var2 var3</span><br><span class="line">[root@template sh]# echo $&#123;!v*&#125;</span><br><span class="line">var1 var2 var3</span><br><span class="line"></span><br><span class="line">* 字符串操作</span><br><span class="line">	* 截取长度</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;<span class="comment">#string&#125;：$string的长度</span></span></span><br><span class="line"></span><br><span class="line">	* 截取字符串</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string:position&#125;：在<span class="variable">$string</span>中, 从位置<span class="variable">$position</span>开始提取子串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string:position:length&#125;：在<span class="variable">$string</span>中, 从位置<span class="variable">$position</span>开始提取长度为<span class="variable">$length</span>的子串</span></span><br><span class="line"> 	 </span><br><span class="line"> 	 * 删除子串</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string<span class="comment">#substring&#125;：从变量$string的开头, 删除最短匹配$substring的子串</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string<span class="comment">##substring&#125;：从变量$string的开头, 删除最长匹配$substring的子串</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string%substring&#125;：从变量<span class="variable">$string</span>的结尾, 删除最短匹配<span class="variable">$substring</span>的子串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string%%substring&#125;：从变量<span class="variable">$string</span>的结尾, 删除最长匹配<span class="variable">$substring</span>的子串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;变量名<span class="comment">#substring正则表达式&#125;：从字符串开头开始配备substring，删除匹配上的表达式。</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;变量名%substring正则表达式&#125;：从字符串结尾开始配备substring，删除匹配上的表达式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$&#123;test##*/&#125;</span>,<span class="variable">$&#123;test%/*&#125;</span> 分别是得到文件名，或者目录地址最简单方法。 	 </span></span><br><span class="line"></span><br><span class="line"> 	 * 字符串替换</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string/substring/replacement&#125;：使用<span class="variable">$replacement</span>, 来代替第一个匹配的<span class="variable">$substring</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string//substring/replacement&#125;：使用<span class="variable">$replacement</span>, 代替所有匹配的<span class="variable">$substring</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string/<span class="comment">#substring/replacement&#125;：如果$string的前缀匹配$substring, 那么就用$replacement来代替匹配到的$substring</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;string/%substring/replacement&#125;：如果<span class="variable">$string</span>的后缀匹配<span class="variable">$substring</span>, 那么就用<span class="variable">$replacement</span>来代替匹配到的<span class="variable">$substring</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"* <span class="variable">$substring</span>"</span> 可以是一个正则表达式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$&#123;变量/查找/替换值&#125;</span> 一个“/”表示替换第一个，”//”表示替换所有,当查找中出现了：”/”请加转义符”\/”表示。</span></span><br><span class="line">例</span><br><span class="line">[root@template sh]# num=oldboy5343</span><br><span class="line">[root@template sh]# echo "$&#123;num//[0-9]/&#125;" </span><br><span class="line">oldboy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是使用空来代替oldboy5343中的所有数字，所以取的值只有字母</span></span><br><span class="line">[root@template sh]# echo "$&#123;num//[0-9]/a&#125;"</span><br><span class="line">oldboyaaaa</span><br></pre></td></tr></table></figure>
<h3 id="变量的数值计算"><a href="#变量的数值计算" class="headerlink" title="变量的数值计算"></a>变量的数值计算</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">* (())用法：此方法很常用，且效率高。执行简单的整数运算，只需将特定的算术表达式用"$((算术运算表达式))"。shell的算术运算符号都置于"$((算术运算表达式))"的语法中。这一语法如同双引号功能，除了内嵌双引号无需转义。</span><br><span class="line">=======================================================================================</span><br><span class="line">运算符</span><br><span class="line">++  --：增加及减少，可前置也可放在结尾。放在开头表示先自增或自减再赋值，放在结尾表示先赋值再自增或自减。变量话前，先输出变量值，变量在后，就是先运算后输出变量的值。</span><br><span class="line">+ - ! ~	：一元的正号与负号；逻辑与位的取反</span><br><span class="line">* / %：乘法、除法、与取余</span><br><span class="line">+ -	：加法、减法</span><br><span class="line">&lt; &lt;= &gt; &gt;=：比较符号</span><br><span class="line">== !=：判断相等与不相等</span><br><span class="line">&lt;&lt; &gt;&gt;：向左位移、向右位移</span><br><span class="line">&amp;：位的AND</span><br><span class="line">^：位的异或</span><br><span class="line">｜：位的或</span><br><span class="line">&amp;&amp;：逻辑的AND</span><br><span class="line">||：逻辑的OR</span><br><span class="line">?：条件表达式</span><br><span class="line">= += -= *= /= %= &amp;= ^=</span><br><span class="line">&lt;&lt;=  &gt;&gt;=  \=：赋值运算符</span><br><span class="line">=======================================================================================</span><br><span class="line">例</span><br><span class="line">[root@template sh]# echo $((3&gt;2))</span><br><span class="line">1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断，如果是真就输出1，假输出0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 括号两边有几个空格不敏感，也可以没有</span></span><br><span class="line">[root@template sh]# echo $((3&gt;8))</span><br><span class="line">0</span><br><span class="line">[root@template sh]# ((a=1+2**3-4%3))</span><br><span class="line"><span class="meta">#</span><span class="bash"> **是幂，表示几次方</span></span><br><span class="line">[root@template sh]# echo $a</span><br><span class="line">8</span><br><span class="line">[root@template sh]# b=$((1+2**3-4%3))</span><br><span class="line">[root@template sh]# echo $b</span><br><span class="line">8</span><br><span class="line">[root@template sh]# echo $((1+2**3-4%3))</span><br><span class="line">8</span><br><span class="line">[root@template sh]# echo $((a+=1))</span><br><span class="line">9</span><br><span class="line"><span class="meta">#</span><span class="bash"> a++表示先赋值再自增1、++a表示先自增1再赋值、a--与--a同理</span></span><br><span class="line">[root@template sh]# echo $((100*(100+1)/2))</span><br><span class="line">5050</span><br><span class="line">[root@template sh]# echo $((1000*(1000+1)/2))</span><br><span class="line">500500</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从1加到100的计算公式是n*(n+1)/2，只要从1开始，间隔为1的相加计算都可以用此公式</span></span><br><span class="line">[root@template sh]# echo $((1.1+1))</span><br><span class="line">-bash: 1.1+1: syntax error: invalid arithmetic operator (error token is ".1+1")</span><br><span class="line"><span class="meta">#</span><span class="bash"> 双括号中只能使用整数，不能使用小数</span></span><br><span class="line"></span><br><span class="line">例：使用传参的方式对两个变量进行计算</span><br><span class="line">[root@template sh]# vim test2.sh</span><br><span class="line">echo "a-b=$(($a-$b))"</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">a=$1</span><br><span class="line">b=$2</span><br><span class="line">echo "a-b=$(($a-$b))"</span><br><span class="line">echo "a+b=$(($a+$b))"</span><br><span class="line">echo "a*b=$(($a*$b))"</span><br><span class="line">echo "a/b=$(($a/$b))"</span><br><span class="line">echo "a**b=$(($a**$b))"</span><br><span class="line">echo "a%b=$(($a%$b))"</span><br><span class="line">[root@template sh]# chmod +x test2.sh </span><br><span class="line">[root@template sh]# bash test2.sh 5 2</span><br><span class="line">a-b=3</span><br><span class="line">a+b=7</span><br><span class="line">a*b=10</span><br><span class="line">a/b=2</span><br><span class="line">a**b=25</span><br><span class="line"><span class="meta">a%</span><span class="bash">b=1</span></span><br><span class="line"></span><br><span class="line">* []的用法，$[算术运算表达式]，与$((算术运算表达式))相同</span><br><span class="line"></span><br><span class="line">* let命令的用法</span><br><span class="line">格式：</span><br><span class="line">	let 赋值表达式</span><br><span class="line">	let i=$[$i+1]</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 这里不加<span class="built_in">let</span>也可以，因为有中括号了</span></span><br><span class="line">	let i++</span><br><span class="line">	let i+=1</span><br><span class="line">	</span><br><span class="line">例</span><br><span class="line">[root@template sh]# i=2</span><br><span class="line">[root@template sh]# let i=i+9</span><br><span class="line">[root@template sh]# echo $i</span><br><span class="line">11</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">let</span> i=i+8等同于((i=i+8))，但双括号效率更高</span></span><br><span class="line"></span><br><span class="line">例：利用let计数监控web服务状态</span><br><span class="line">[root@template sh]# vim web.sh </span><br><span class="line">ServerMonitor() &#123;</span><br><span class="line">   timeout=10</span><br><span class="line">   fails=0</span><br><span class="line">   success=0</span><br><span class="line">   while true;do</span><br><span class="line">        /usr/bin/wget --timeout=$timeout --tries=1 http://192.168.1.24 -q -O /de</span><br><span class="line">v/null</span><br><span class="line">        if [ $? -ne 0 ];then</span><br><span class="line">           let fails+=1</span><br><span class="line">           success=0</span><br><span class="line">        else</span><br><span class="line">           fail=0</span><br><span class="line">           let success=1</span><br><span class="line">        fi</span><br><span class="line">        if [ $success -eq 1 ];then</span><br><span class="line">           exit 0</span><br><span class="line">        fi</span><br><span class="line">        if [ $fails -ge 2 ];then</span><br><span class="line">           Critical="web应用服务故障"</span><br><span class="line">           echo $Critical </span><br><span class="line">        fi</span><br><span class="line">        sleep 10</span><br><span class="line">done</span><br><span class="line">&#125;</span><br><span class="line">ServerMonitor</span><br><span class="line"><span class="meta">#</span><span class="bash"> 探测主页，之后判断，如果返回值不是0，fails变量就自增1，否则success变量就等于1。再判断success变量是否等于1,如果等于1，如果是，就正常退出，返回0。再判断fails变量是否大于等于2,如果是就定义一个变量Critical，并显示变量值。最后，每10秒检查一次。</span></span><br><span class="line"></span><br><span class="line">* expr命令用法</span><br><span class="line"><span class="meta">#</span><span class="bash"> expr命令一般用于整数值，但也可用于字符串，用来求表达式变量的值，同时expr也是一个手工命令行计算器。</span></span><br><span class="line">语法：</span><br><span class="line">	expr Expression</span><br><span class="line">例</span><br><span class="line">[root@template sh]# expr 2 + 2</span><br><span class="line">4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运算符两侧必须有空格</span></span><br><span class="line">[root@template sh]# expr 2 - 2</span><br><span class="line">0</span><br><span class="line">[root@template sh]# expr 2 \* 2</span><br><span class="line">4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 乘号要转义</span></span><br><span class="line">[root@template sh]# expr 2 / 2 </span><br><span class="line">1</span><br><span class="line">[root@template sh]# expr 3 % 2</span><br><span class="line">1</span><br><span class="line">[root@template sh]# i=0</span><br><span class="line">[root@template sh]# i=`expr $i + 1`</span><br><span class="line">[root@template sh]# echo $i</span><br><span class="line">1</span><br><span class="line"><span class="meta">#</span><span class="bash"> expr在循环中可用于增量计算。首先，循环初始化为0，然后循环值加1，反引号的用法为命令替代。最其本的一种是从(expr)命令接受输出并将之放入循环变量</span></span><br><span class="line">[root@template sh]# expr $[2+3]</span><br><span class="line">5</span><br><span class="line"><span class="meta">#</span><span class="bash"> expr如果加上$[]后，运算符两侧就不用空格了。运算符两侧必须为整数</span></span><br><span class="line"></span><br><span class="line">例：ssh-copy-id脚本中使用expr命令</span><br><span class="line">if expr "$1" : ".*\.pub";then</span><br><span class="line"><span class="meta">#</span><span class="bash"> 冒号两侧一样要有空格</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置结果可能为expr id_dsa.pub:<span class="string">".*\.pub"</span>，匹配*.pub格式的文件如果是则为真。如：</span></span><br><span class="line">[root@template sh]# expr ~/.ssh/id_rsa.pub : ".*\.pub"</span><br><span class="line">21</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果为真就会打印出字符数，假就显示0</span></span><br><span class="line">[root@template sh]# expr ~/.ssh/id_rsa.pub : ".*\.pub" &amp;&amp; echo 1||echo 0</span><br><span class="line">21</span><br><span class="line">1</span><br><span class="line">[root@template sh]# expr ~/.ssh/id_rsa.p : ".*\.pub" &amp;&amp; echo 1||echo 0  </span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断文件或字符串的扩展名</span></span><br><span class="line"></span><br><span class="line">例：判断变量是否为整数</span><br><span class="line">[root@template sh]# vim expr.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">read -p "Pls input: " a</span><br><span class="line">expr $a + 0 &amp;&gt; /dev/null</span><br><span class="line">[ $? -eq 0 ] &amp;&amp; echo int || echo chars</span><br><span class="line"></span><br><span class="line">例：计算字符串的长度</span><br><span class="line">[root@template sh]# chars=`seq -s " " 100`      </span><br><span class="line"><span class="meta">#</span><span class="bash"> -s选项表示指定分隔符，上面是以空格为分隔符。默认是回车。</span></span><br><span class="line">[root@template sh]# echo $&#123;#chars&#125;              </span><br><span class="line">291</span><br><span class="line">[root@template sh]# echo $(expr length "$chars")</span><br><span class="line">291</span><br><span class="line"></span><br><span class="line">* $[]的用法与(())一样，效果也一样</span><br><span class="line">[root@template sh]# echo $((2-2))</span><br><span class="line">0</span><br><span class="line">[root@template sh]# echo $[2-2]</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<h3 id="read命令"><a href="#read命令" class="headerlink" title="read命令"></a>read命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">可以使用read命令从标准输入获得参数</span><br><span class="line">语法：</span><br><span class="line">	read [参数] [变量名]</span><br><span class="line">常用选项：</span><br><span class="line">	-p prompt：设置提示信息</span><br><span class="line">	-t timeout：设置输入等待时间，单位默认为秒</span><br><span class="line">例</span><br><span class="line">[root@template sh]# read -p "pls input two number: " a b</span><br><span class="line">pls input two number: 1 2   </span><br><span class="line">或</span><br><span class="line">[root@template sh]# echo -n "pls input two number: ";read a b</span><br><span class="line">pls input two number: 4 3</span><br><span class="line">[root@template sh]# echo $a</span><br><span class="line">4</span><br><span class="line">[root@template sh]# echo $b</span><br><span class="line">3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这两种方式都可以使用<span class="built_in">read</span>获得参数</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim read.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">read -t 10 -p "Pls input two number: " a b</span><br><span class="line">echo "a-b=$(($a-$b))"</span><br><span class="line">echo "a+b=$(($a+$b))"</span><br><span class="line">echo "a*b=$(($a*$b))"</span><br><span class="line">echo "a/b=$(($a/$b))"</span><br><span class="line">echo "a**b=$(($a**$b))"</span><br><span class="line">echo "a%b=$(($a%$b))"</span><br><span class="line"></span><br><span class="line">[root@template sh]# vim read1.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">echo -n "Pls input two number"</span><br><span class="line">read a b</span><br><span class="line">echo "a-b=$(($a-$b))"</span><br><span class="line">echo "a+b=$(($a+$b))"</span><br><span class="line">echo "a*b=$(($a*$b))"</span><br><span class="line">echo "a/b=$(($a/$b))"</span><br><span class="line">echo "a**b=$(($a**$b))"</span><br><span class="line">echo "a%b=$(($a%$b))"</span><br></pre></td></tr></table></figure>
<h3 id="条件测试"><a href="#条件测试" class="headerlink" title="条件测试"></a>条件测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">* 测试语句</span><br><span class="line">条件测试语法</span><br><span class="line">1. test &lt;测试表达式&gt;</span><br><span class="line">2. [&lt;测试表达式&gt;]</span><br><span class="line">3. [[&lt;测试表达式&gt;]]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 格式1和格式2是一样的，只是写法不同。格式3为扩展的<span class="built_in">test</span>命令。在[[]]中可以使用通配符进行模式匹配。&amp;&amp;、||、&gt;、&lt;等操作符，但不能用于[]中。对整数进行关系运算，也可以使用shell的算术运算符(())</span></span><br><span class="line"></span><br><span class="line">* 文件测试操作符</span><br><span class="line">-f 文件：若文件存在且为普通文件则为真</span><br><span class="line">-d 文件：若文件存在且为目录则为真</span><br><span class="line">-s 文件：若文件存在且不为空（文件大小非0）则为真</span><br><span class="line">-e 文件：若文件存在则为真，要与-f区别，-f只判断是否为普通文件</span><br><span class="line">-r 文件：若文件可读则为真</span><br><span class="line">-w 文件：若文件可写则为真</span><br><span class="line">-x 文件：若文件可执行则为真</span><br><span class="line">-L 文件：若文件存在且为链接文件则为真</span><br><span class="line">f1 -nt f2：若文件f1比f2新则为真</span><br><span class="line">f1 -ot f2：若文件f1比f2旧则为真</span><br><span class="line"></span><br><span class="line">例：test</span><br><span class="line">[root@template sh]# test -f file &amp;&amp; echo true||echo false  </span><br><span class="line">false</span><br><span class="line">[root@template sh]# test -f expr.sh &amp;&amp; echo true||echo false    </span><br><span class="line">true</span><br><span class="line">[root@template sh]# test ! -f file &amp;&amp; echo true||echo false</span><br><span class="line">true</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用!号可以取反</span></span><br><span class="line"></span><br><span class="line">例：[]</span><br><span class="line">[root@template sh]# [ -f file ] &amp;&amp; echo true || echo false</span><br><span class="line">false</span><br><span class="line">[root@template sh]# [ ! -f file ] &amp;&amp; echo true || echo false</span><br><span class="line">true</span><br><span class="line"></span><br><span class="line">例：[[]]</span><br><span class="line">[root@template sh]# [[ -f file ]] &amp;&amp; echo true || echo false  </span><br><span class="line">false</span><br><span class="line">[root@template sh]# [[ ! -f file ]] &amp;&amp; echo true || echo false</span><br><span class="line">true</span><br><span class="line">[root@template sh]# [[ -f file &amp;&amp; -f expr.sh ]] &amp;&amp; echo true || echo false</span><br><span class="line">false</span><br><span class="line">[root@template sh]# [[ ! -f file &amp;&amp; -f expr.sh ]] &amp;&amp; echo true || echo false</span><br><span class="line">true</span><br></pre></td></tr></table></figure>
<h3 id="字符串及整数操作符"><a href="#字符串及整数操作符" class="headerlink" title="字符串及整数操作符"></a>字符串及整数操作符</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">字符串测试操作符的作用：比较两个字符串是否相同、字符串长度是否为零，字符串是否为NULL（bash区分零长度字符串与空字符串）等。</span><br><span class="line">=比较两个字符串是相同，与==等价，如if[ "$a" = "$b" ]，其中$a这样的变量最好用""括起来，因为如果中间有空格，*等符号就可能出错了，也可以用[ "$&#123;a&#125;" = "$&#123;b&#125;" ]这样的方法。!=比较两个字符串是否相同，不同则为真</span><br><span class="line">* 字符串测试操作符</span><br><span class="line">-z "字符串"：若串长度为0则为真</span><br><span class="line">-n "字符串"：若串长度不为0则为真</span><br><span class="line">"串1"="串2"：若串1等于串2则为真，也可以使用==代替=</span><br><span class="line">"串1"!="串2"：若串1不等于串2则为真</span><br></pre></td></tr></table></figure>
<p>整数二元比较操作符</p>
<table>
<thead>
<tr>
<th>在[]中使用的比较符</th>
<th>在(())和[[]]中使用的比较符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-eq</td>
<td>==</td>
<td>equal</td>
</tr>
<tr>
<td>-ne</td>
<td>!=</td>
<td>not equal</td>
</tr>
<tr>
<td>-gt</td>
<td>&gt;</td>
<td>greater than</td>
</tr>
<tr>
<td>-ge</td>
<td>&gt;=</td>
<td>greater equal</td>
</tr>
<tr>
<td>-lt</td>
<td>&lt;</td>
<td>less thean</td>
</tr>
<tr>
<td>-le</td>
<td>&lt;=</td>
<td>less equal</td>
</tr>
</tbody>
</table>
<p><strong>在[]中也可以使用&gt;、&lt;、=号，但&gt;、&lt;号要转义</strong></p>
<h3 id="逻辑操作符"><a href="#逻辑操作符" class="headerlink" title="逻辑操作符"></a>逻辑操作符</h3><p>逻辑连接符</p>
<table>
<thead>
<tr>
<th>在[]中使用的逻辑操作符</th>
<th>在[[]]中使用的逻辑操作符</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-a</td>
<td>&amp;&amp;</td>
<td style="text-align:left">与，两端都为真，则为真</td>
</tr>
<tr>
<td>-o</td>
<td>\</td>
<td style="text-align:left">\</td>
<td></td>
<td>或，两端有一端为真则为真</td>
</tr>
<tr>
<td>!</td>
<td>!</td>
<td style="text-align:left">非，相反则为真</td>
</tr>
</tbody>
</table>
<h3 id="单级与多级菜单"><a href="#单级与多级菜单" class="headerlink" title="单级与多级菜单"></a>单级与多级菜单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@template ~]# vim menu.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">menu() &#123;</span><br><span class="line">   cat &lt;&lt; END</span><br><span class="line">   1. [install lamp]</span><br><span class="line">   2. [install lnmp]</span><br><span class="line">   3. [install nfs]</span><br><span class="line">   4. [install rsync]</span><br><span class="line">   Pls input the num that you want:</span><br><span class="line">END</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试中，如果将END改为EOF会报错，内容如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> menu.sh: line 14: warning: here-document at line 4 delimited by end-of-file (wanted `EOF<span class="string">')</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> menu.sh: line 15: syntax error: unexpected end of file</span></span><br><span class="line">read a</span><br><span class="line">[ $a -eq 1 ] &amp;&amp; &#123;</span><br><span class="line">cat &lt;&lt; END</span><br><span class="line">[1. install apache]</span><br><span class="line">[2. install mysql]</span><br><span class="line">[3. install php]</span><br><span class="line">END</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">menu</span><br><span class="line">read b</span><br><span class="line">echo "You selected $b"</span><br><span class="line">[root@template ~]# bash menu.sh </span><br><span class="line">   1. [install lamp]</span><br><span class="line">   2. [install lnmp]</span><br><span class="line">   3. [install nfs]</span><br><span class="line">   4. [install rsync]</span><br><span class="line">   Pls input the num that you want:</span><br><span class="line">1</span><br><span class="line">[1. install apache]</span><br><span class="line">[2. install mysql]</span><br><span class="line">[3. install php]</span><br><span class="line">1</span><br><span class="line">You selected 1</span><br></pre></td></tr></table></figure>
<h3 id="if条件语句"><a href="#if条件语句" class="headerlink" title="if条件语句"></a>if条件语句</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">* if条件单分支</span><br><span class="line">语法：</span><br><span class="line">if [条件]</span><br><span class="line">	then</span><br><span class="line">		指令</span><br><span class="line">fi</span><br><span class="line">或</span><br><span class="line">if [条件];then</span><br><span class="line">	指令</span><br><span class="line">fi</span><br><span class="line">特殊写法：if [ -f "$file" ];then echo 1;fi，相当于：[ -f "$file" ] &amp;&amp; echo 1</span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim if.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">cur_free=`free -m|awk '/buffers\// &#123;print $NF&#125;'`</span><br><span class="line">chars="current memory is $cur_free"</span><br><span class="line">if [ $cur_free -lt 900 ];then</span><br><span class="line">   echo $chars</span><br><span class="line">fi</span><br><span class="line">[root@template sh]# chmod +x if.sh </span><br><span class="line">[root@template sh]# ./if.sh</span><br><span class="line">current memory is 855</span><br><span class="line"></span><br><span class="line">* 双分支、多分支if语句</span><br><span class="line">双分支语法：</span><br><span class="line">if [条件];then</span><br><span class="line">   指令</span><br><span class="line">else</span><br><span class="line">	指令</span><br><span class="line">fi</span><br><span class="line">多分支语法：</span><br><span class="line">if [条件];then</span><br><span class="line">   指令</span><br><span class="line">elif [条件];then</span><br><span class="line">	指令</span><br><span class="line">else</span><br><span class="line">	指令</span><br><span class="line">fi</span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim if1.sh      </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">a=$1</span><br><span class="line">b=$2</span><br><span class="line">if [ $# -ne 2 ];then</span><br><span class="line">   echo "Usage: sh $0 num1 num2"</span><br><span class="line">   exit 1</span><br><span class="line">fi</span><br><span class="line">[ -n "`echo $1|sed 's/[0-9]//g'`" ] &amp;&amp; echo "first parameter must num" &amp;&amp; exit 1</span><br><span class="line">[ -n "`echo $2|sed 's/[0-9]//g'`" ] &amp;&amp; echo "second parameter must num" &amp;&amp; exit 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里是要显示输入的内容，将内容传给sed命令，sed命令将数字部分都替换为空，再对这个显示的值做字符串长度的计算，如果不是0就要提示应该输入数字，不然就退出。</span></span><br><span class="line">if [ $a -gt $b ];then</span><br><span class="line">   echo "yes,$a &gt; $b"</span><br><span class="line">elif [ $a -eq $b ];then</span><br><span class="line">   echo "yes,$a = $b"</span><br><span class="line">else</span><br><span class="line">   echo "yes,$a &lt; $b"</span><br><span class="line">fi</span><br><span class="line">[root@template sh]# bash if1.sh 99 89</span><br><span class="line">yes,99 &gt; 89</span><br><span class="line">[root@template sh]# bash if1.sh 99 99</span><br><span class="line">yes,99 = 99</span><br><span class="line">[root@template sh]# bash if1.sh 69 99 </span><br><span class="line">yes,69 &lt; 99</span><br><span class="line"></span><br><span class="line">例：检查mysql是否启动</span><br><span class="line">[root@template sh]# vim check_db.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">portNum=`netstat -lnt|grep 3306|wc -l`</span><br><span class="line">if [ $portNum -eq 1 ];then</span><br><span class="line">   echo "db is running"</span><br><span class="line">else</span><br><span class="line">   service mysqld start</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 脚本的名称中最好不要包括要查询的服务的名称，如这里就是mysql</span></span><br><span class="line"></span><br><span class="line">例：检查mysql是否启动，更完整 </span><br><span class="line">[root@template sh]# vim check1_db.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">LogPath=/tmp/mysql.log</span><br><span class="line">portNum=`netstat -lnt|grep 3306|wc -l`</span><br><span class="line">mysqlProcessNum=`ps -ef|grep mysqld|grep -v grep|wc -l`</span><br><span class="line">if [ $portNum -eq 1 ] &amp;&amp; [ $mysqlProcessNum -eq 2 ];then</span><br><span class="line">   echo "db is running"</span><br><span class="line">else</span><br><span class="line">   /etc/init.d/mysqld start</span><br><span class="line">   sleep 10</span><br><span class="line">   portNum=`netstat -lnt|grep 3306|wc -l`</span><br><span class="line">   mysqlProcessNum=`ps -ef|grep mysqld|grep -v grep|wc -l`</span><br><span class="line">   if [ $portNum -ne 1 ] &amp;&amp; [ $mysqlProcessNum -ne 2 ];then</span><br><span class="line">        while true;do</span><br><span class="line">           killall mysqld &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">           [ $? -ne 0 ] &amp;&amp; break</span><br><span class="line">           sleep 1</span><br><span class="line">        done</span><br><span class="line">        /etc/init.d/mysqld start &gt;&gt; $LogPath &amp;&amp; status="successful" || status="failure"</span><br><span class="line">        mail -s "mysql startup status is $status" root@localost &lt; $LogPath</span><br><span class="line">   fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：检查mysql是否启动，利用mysql帐号登录测试</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">LogPath=/tmp/mysql.log</span><br><span class="line">mysql -uroot -p'centos' -S /var/lib/mysql/mysql.sock -e "select version();" &gt;&amp; /dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的用户名与密码一定要正确，不然也会执行失败，使下面判断mysql为未启动状态。</span></span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">   echo "db is running"</span><br><span class="line">else</span><br><span class="line">   /etc/init.d/mysqld start &gt; $LogPath</span><br><span class="line">   sleep 10</span><br><span class="line">   mysql -uroot -p'centos' -S /var/lib/mysql/mysql.sock -e "select version();" &gt;&amp; /dev/null</span><br><span class="line">   if [ $? -ne 0 ];then</span><br><span class="line">        while true;do</span><br><span class="line">           killall mysqld &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">           [ $? -ne 0 ] &amp;&amp; break</span><br><span class="line">           # 这里只检查killall命令执行是否正确，如果正确就跳出循环。个人认为还应该加上检查进程是否存在更准确</span><br><span class="line">           sleep 1</span><br><span class="line">        done</span><br><span class="line">        /etc/init.d/mysqld start &gt;&gt; $LogPath &amp;&amp; status="successful" || status="failure"</span><br><span class="line">        mail -s "mysql startup status is $status" root@localost &lt; $LogPath</span><br><span class="line">   fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：检查mysql是否启动的php脚本</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="meta">   $</span><span class="bash">link_id=mysql_connect(<span class="string">'localhost'</span>,<span class="string">'root'</span>,<span class="string">'centos'</span>) or mysql_error();</span></span><br><span class="line">   if ($link_id) &#123;</span><br><span class="line">       echo "mysql successful !";</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">       echo mysql_error();</span><br><span class="line">   &#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">监控mysql数据库是否异常的多种方法</span><br><span class="line">1. 根据mysql端口号监控mysql(本地)</span><br><span class="line">2. 根据mysql进程监控mysql(本地)。只能本地监控，进程在服务可能不正常，如：负载很高，CPU很高，连接数满了，另外，进程也可以远程监控，如通过ssh key，expect</span><br><span class="line">3. 通过mysql客户端命令及用户帐户连接mysql，然后根据返回命令状态或返回内容确认mysql是否正常（本地和远程连接判断）。必须要有mysql客户端，要有数据库的帐号与密码及连接数据库主机授权。</span><br><span class="line">4. 通过php/java程序url方式监控mysql，此方法最接近用户访问，效果最好。报警的最佳方式不是服务是否开启了，而是网站的用户是否还能正常访问</span><br><span class="line">5. 以上四种方法的综合运用</span><br><span class="line"></span><br><span class="line">例：本地监控web服务</span><br><span class="line">[root@template sh]# vim check_web.sh     </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">HttpPortNum=`netstat -tln|grep 80|wc -l`</span><br><span class="line">if [ $HttpPortNum -ge 1 ];then</span><br><span class="line">   echo "web is running"</span><br><span class="line">else</span><br><span class="line">   echo "web is not running"</span><br><span class="line">   /etc/init.d/nginx start</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：远程监控web服务</span><br><span class="line">[root@template sh]# vim check1_web.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">HttpPortNum=`nmap 192.168.1.24 -p 80|grep open|wc -l`</span><br><span class="line">if [ $HttpPortNum -ge 1 ];then</span><br><span class="line">   echo "web is running"</span><br><span class="line">else</span><br><span class="line">   echo "web is not running"</span><br><span class="line">   /etc/init.d/nginx start</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：通过url地址远程监控web服务</span><br><span class="line">[root@template sh]# vim check2_web.sh             </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">wget -T 10 -q --spider http://192.168.1.24 &gt; /dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"> -T表示超时时间，-q表示静默模式，--spider表示爬虫</span></span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">   echo "web is running"</span><br><span class="line">else</span><br><span class="line">   echo "web is not running"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：通过状态码查看服务是否启动</span><br><span class="line">[root@template sh]# vim check3_web.sh    </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">[ -f /etc/init.d/functions ] &amp;&amp; . /etc/init.d/functions</span><br><span class="line">httpCode=`curl -I -s 192.168.1.24|head -1|cut -d" " -f2`</span><br><span class="line">if [ "$httpCode" == "200" ];then</span><br><span class="line">   action "nginx is running" /bin/true</span><br><span class="line"><span class="meta">   #</span><span class="bash"> action是调用<span class="built_in">functions</span>函数</span></span><br><span class="line">else</span><br><span class="line">   action "nginx is not running" /bin/false</span><br><span class="line">   sleep 1</span><br><span class="line">   /etc/init.d/nginx start</span><br><span class="line">   action "nginx is started" /bin/true</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">例：使用传参的方式查看服务是否启动</span><br><span class="line">[root@template sh]# vim check4_web.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">if [ $# -ne 2 ];then</span><br><span class="line">   echo "Usage: $0 ip port "</span><br><span class="line">fi</span><br><span class="line">PortNum=`nmap $1 -p $2 |grep open|wc -l`</span><br><span class="line">if [ $PortNum -eq 1 ];then</span><br><span class="line">   echo "$1 $2 is open"</span><br><span class="line">else</span><br><span class="line">   echo "$1 $2 is closed"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h3 id="case条件语句"><a href="#case条件语句" class="headerlink" title="case条件语句"></a>case条件语句</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">case "字符串变量" in</span><br><span class="line">	值1) 指令 ...</span><br><span class="line">	;;</span><br><span class="line">	值2) 指令 ...</span><br><span class="line">	;;</span><br><span class="line">	*) 指令 ...</span><br><span class="line">	;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">[root@template sh]# vim plus_color.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">new_chars() &#123;</span><br><span class="line">RED_COLOR='\E[1;31m'</span><br><span class="line">GREEN_COLOR='\E[1;32m'</span><br><span class="line">YELLOW_COLOR='\E[1;33m'</span><br><span class="line">BLUE_COLOR='\E[1;34m'</span><br><span class="line">PINK_COLOR='\E[1;35m'</span><br><span class="line">RES='\E[0m'</span><br><span class="line"></span><br><span class="line">if [ $# -ne 2 ];then</span><br><span class="line">   echo "Usage $0 content &#123;red|yellow|blue|green&#125;"</span><br><span class="line">   exit</span><br><span class="line">fi</span><br><span class="line">case "$2" in</span><br><span class="line">   red|RED)</span><br><span class="line">        echo -e "$&#123;RED_COLOR&#125;$1$&#123;RES&#125;"</span><br><span class="line">   ;;</span><br><span class="line">   yellow|YELLOW)</span><br><span class="line">        echo -e "$&#123;YELLOW_COLOR&#125;$1$&#123;RES&#125;"</span><br><span class="line">   ;;</span><br><span class="line">   green|GREEN)</span><br><span class="line">        echo -e "$&#123;GREEN_COLOR&#125;$1$&#123;RES&#125;"</span><br><span class="line">   ;;</span><br><span class="line">   blue|BLUE)</span><br><span class="line">        echo -e "$&#123;BLUE_COLOR&#125;$1$&#123;RES&#125;"</span><br><span class="line">   ;;</span><br><span class="line">   pink|PINK)</span><br><span class="line">        echo -e "$&#123;PINK_COLOR&#125;$1$&#123;RES&#125;"</span><br><span class="line">   ;;</span><br><span class="line">   *)</span><br><span class="line">        echo "Usage $0 content &#123;red|yellow|blue|green&#125;"</span><br><span class="line">   ;;</span><br><span class="line">esac</span><br><span class="line">&#125;</span><br><span class="line">new_chars abc red</span><br><span class="line">new_chars abc yellow</span><br><span class="line">new_chars abc green</span><br><span class="line">new_chars abc blue</span><br><span class="line">new_chars abc pink</span><br><span class="line"></span><br><span class="line">例：利用case语句启动web服务</span><br><span class="line">[root@template sh]# vim nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">nginx="/etc/init.d/nginx"</span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">case "$1" in</span><br><span class="line">   start)</span><br><span class="line">        $nginx start &gt;&amp; /dev/null</span><br><span class="line">        [ $? -eq 0 ] &amp;&amp; action "nginx is started" /bin/true ||\</span><br><span class="line">        action "nginx is started" /bin/false</span><br><span class="line">   ;;</span><br><span class="line">   stop)</span><br><span class="line">        $nginx stop &gt;&amp; /dev/null</span><br><span class="line">        [ $? -eq 0 ] &amp;&amp; action "nginx is stoped" /bin/true ||\</span><br><span class="line">        action "nginx is stoped" /bin/false</span><br><span class="line">   ;;</span><br><span class="line">   restart)</span><br><span class="line">        $nginx restart &gt;&amp; /dev/null</span><br><span class="line">        [ $? -eq 0 ] &amp;&amp; action "nginx is restarted" /bin/true ||\</span><br><span class="line">        action "nginx is restarted" /bin/false</span><br><span class="line">   ;;</span><br><span class="line">   *)</span><br><span class="line">        echo "Usage: $0 &#123;start|stop|restart&#125;"</span><br><span class="line">        exit</span><br><span class="line">   ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<h3 id="while语句"><a href="#while语句" class="headerlink" title="while语句"></a>while语句</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">while 条件;do</span><br><span class="line">	指令</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 条件满足就退出</span></span><br><span class="line"></span><br><span class="line">while读文件方式</span><br><span class="line">方式一</span><br><span class="line">exec &lt; FILE</span><br><span class="line">sum=0</span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">	cmd</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">方式二</span><br><span class="line">cat $&#123;FILE_PATH&#125; | while read line</span><br><span class="line">do</span><br><span class="line">	cmd</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">方式三</span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">	cmd</span><br><span class="line">done &lt; FILE</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim while1.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">while true;do</span><br><span class="line">   uptime</span><br><span class="line">   sleep 2</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">while</span> <span class="literal">true</span>表示永远为真，是死循环</span></span><br><span class="line">[root@template sh]# vim while2.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">while [ 1 ];do</span><br><span class="line">   uptime</span><br><span class="line">   usleep 1000000</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的条件为[ 1 ]，也是死循环的意思。usllep是使用微秒为单位</span></span><br><span class="line"></span><br><span class="line">=======================================================================================</span><br><span class="line">ctrl+z：暂停执行当前脚本或任务</span><br><span class="line">bg：把当前脚本或任务放到后台执行</span><br><span class="line">fg：把当前脚本或任务拿到前台执行，如果有多个任务，可以fg加任务编号调出，如fg 1</span><br><span class="line">jobs：查看执行的脚本或任务</span><br><span class="line">=======================================================================================</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim while3.sh     </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">i=1</span><br><span class="line">sum=0</span><br><span class="line">while ((i &lt;= 100));do</span><br><span class="line">   ((sum=sum+i))</span><br><span class="line">   ((i++))</span><br><span class="line">done</span><br><span class="line">echo $sum</span><br><span class="line"></span><br><span class="line">例：循环竖向打印10-1，使用双小括号</span><br><span class="line">[root@template sh]# vim while4.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">i=10</span><br><span class="line">while ((i&gt;0));do</span><br><span class="line">   echo $i</span><br><span class="line">   ((i--))</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例：循环竖向打印10-1，使用双中括号</span><br><span class="line">[root@template sh]# vim while5.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">i=10</span><br><span class="line">while [[ $i&gt;0 ]];do</span><br><span class="line">   echo $i</span><br><span class="line">   ((i--))</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用双中括号时必须使用<span class="variable">$i</span>，而不能用i</span></span><br><span class="line"></span><br><span class="line">例：循环竖向打印10-1，使用单中括号</span><br><span class="line">[root@template sh]# vim while6.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">i=10</span><br><span class="line">while [ $i -gt 0 ];do</span><br><span class="line">   echo $i</span><br><span class="line">   ((i--))</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 这里也可以写为<span class="built_in">let</span> i--或i=$[<span class="variable">$i</span>-1]，中括号中不能写成i--这样的形式。</span></span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用单中括号时，<span class="keyword">while</span>的比较运算符要使用-gt的形式，或使用\&gt;的形式，也就是使用大于号时要转义</span></span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">[root@template sh]# vim while7.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">read -t 20 -p "pls input the num: " i</span><br><span class="line">while ((--i));do</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当i为0时就会退出循环</span></span><br><span class="line">   echo $i</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例：测试负载均衡是否平均分配到了节点</span><br><span class="line">[root@template sh]# vim while8.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">while true;do</span><br><span class="line">   curl -I -s http://www.test.com|head -1</span><br><span class="line">   sleep 10</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例：数组方法</span><br><span class="line">[root@template sh]# vim check_url.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">url_list=(</span><br><span class="line">http://www.baidu.com</span><br><span class="line">http://www.sina.com</span><br><span class="line">http://www.sohu.com</span><br><span class="line">http://192.168.1.24</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">wait_time() &#123;</span><br><span class="line">   echo -n "3秒后，执行此操作"</span><br><span class="line">   for ((i=0;i&lt;3;i++));do</span><br><span class="line">        echo -n ".";sleep 1</span><br><span class="line">   done</span><br><span class="line">   echo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_url() &#123;</span><br><span class="line">   wait_time</span><br><span class="line">   echo 'check url...'</span><br><span class="line">   for ((i=0;i&lt;`echo $&#123;#url_list[*]&#125;`;i++));do</span><br><span class="line">        judge=($(curl -I -s $&#123;url_list[$i]&#125;|head -1|tr "\r" "\n"))</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里还是将结果当作一个数组传给judge变量，下面对数组的各值做判断。       </span></span><br><span class="line">        if [[ "$&#123;judge[1]&#125;" == '200' &amp;&amp; "$&#123;judge[2]&#125;" == 'OK' ]];then</span><br><span class="line">        # 这里的问题是只以200状态码与OK为正常，如果是301也是正常的，但这里就会判断为不正常。</span><br><span class="line">           action "$&#123;url_list[$i]&#125;" /bin/true</span><br><span class="line">        else</span><br><span class="line">           action "$&#123;url_list[$i]&#125;" /bin/false</span><br><span class="line">        fi</span><br><span class="line">   done</span><br><span class="line">&#125;</span><br><span class="line">check_url</span><br><span class="line">=======================================================================================</span><br><span class="line">curl命令</span><br><span class="line">-I/--head：只显示响应报文首部信息</span><br><span class="line">-s/--silent：静音模式。不输出任何东西</span><br><span class="line">-o/--output：把输出写到一个文件中，这是保存网页的方法</span><br><span class="line">-w/--write-out [format]：如 -w %&#123;http_code&#125;可以取得网页的状态码。</span><br><span class="line">例</span><br><span class="line">curl -o /dev/null -s -w %&#123;http_code&#125; www.linux.com</span><br><span class="line">=======================================================================================</span><br><span class="line"></span><br><span class="line">例：读日志文件，计算其中所有行的日志各元素的访问字节数的总和</span><br><span class="line">[root@template sh]# vim while9.sh    </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">sum=0</span><br><span class="line">while read line;do</span><br><span class="line">   size=`echo $line|awk '&#123;print $10&#125;'`</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 以空格为分隔符，日志的第10段是访问数据的大小</span></span><br><span class="line">   [ "$size" == "-" ] &amp;&amp; continue</span><br><span class="line">   ((sum=sum+$size))</span><br><span class="line">done &lt; /var/log/nginx/access.log</span><br><span class="line">echo $sum</span><br></pre></td></tr></table></figure>
<h3 id="until语句"><a href="#until语句" class="headerlink" title="until语句"></a>until语句</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">until 条件;do</span><br><span class="line">	指令</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 条件不满足就退出，until应用场合不多见</span></span><br></pre></td></tr></table></figure>
<h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">for 变量名 in 变量取值列表</span><br><span class="line">do</span><br><span class="line">	指令</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在此结构中<span class="string">"in 变量取值列表"</span>可省略，省略时相当于<span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>，使用<span class="keyword">for</span> i 就相当于使用<span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span> </span></span><br><span class="line"></span><br><span class="line">for ((exp1;exp2;exp3))</span><br><span class="line">do</span><br><span class="line">	指令</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim for1.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">size=`awk '&#123;print $10&#125;' $1`</span><br><span class="line">sum=0</span><br><span class="line">for num in $size;do</span><br><span class="line">   [ -n "$num" -a "$num" = "$&#123;num//[^0-9]/&#125;" ] || continue</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 这里要判断一下，<span class="variable">$sum</span>是否不为空，再判断，替换了<span class="variable">$num</span>中开头的数字后，<span class="variable">$num</span>是否等于<span class="variable">$num</span>，如果等于，说明这里有字母，就退出本轮循环。</span></span><br><span class="line">   ((sum=$num+sum))</span><br><span class="line">done</span><br><span class="line">echo "Log size: $sum bytes=`echo $(($sum/1024))`KB"</span><br><span class="line">[root@template sh]# ./for1.sh /var/log/nginx/access.log </span><br><span class="line">Log size: 139959 bytes=136KB</span><br><span class="line"></span><br><span class="line">另一种方法</span><br><span class="line">[root@template sh]# echo `awk '&#123;print $10&#125;' /var/log/nginx/access.log|grep -v -|tr "\n" "+"|sed 's/3698+$/3698/'`|bc</span><br><span class="line">139959</span><br><span class="line"></span><br><span class="line">例：批量改名</span><br><span class="line">[root@template sh]# vim for2.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">for filename in `ls *.jpg`;do</span><br><span class="line">   mv $filename `echo $filename|cut -d . -f1`.git</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例：乘法表</span><br><span class="line">[root@template sh]# vim for3.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">for i in `seq 9`;do</span><br><span class="line">   for j in `seq 9`;do</span><br><span class="line">        [ $j -le $i ] &amp;&amp; echo -en "$j * $i = `expr $i \* $j` \c"</span><br><span class="line">        # -n表示不换行输出，-e表示激活转义字符，\c表示最后不加上换行符号</span><br><span class="line">   done</span><br><span class="line">   echo " "</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">例：访问十次页面</span><br><span class="line">[root@template sh]# vim for4.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">for ((i=0;i&lt;=10;i++));do</span><br><span class="line">   curl http://192.168.1.24/index1.html</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="取随机数的方法"><a href="#取随机数的方法" class="headerlink" title="取随机数的方法"></a>取随机数的方法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">方法一</span><br><span class="line">[root@template sh]# echo $RANDOM</span><br><span class="line">9066</span><br><span class="line"></span><br><span class="line">方法二</span><br><span class="line">[root@template sh]# openssl rand -base64 8</span><br><span class="line">sT9rgkzhDKQ=</span><br><span class="line">[root@template sh]# openssl rand -base64 10</span><br><span class="line">dK5aymAlYRlJxA==</span><br><span class="line"></span><br><span class="line">方法三</span><br><span class="line">[root@template sh]# date +%s%N</span><br><span class="line">1547475685362659766</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过时间获取随机数</span></span><br><span class="line"></span><br><span class="line">方法四</span><br><span class="line">[root@template sh]# head /dev/urandom | cksum </span><br><span class="line">3543804650 1922</span><br><span class="line"><span class="meta">#</span><span class="bash"> /dev/random设备，存储着系统当前运行的环境的实时数据。它可以看作是系统某个时候，唯一值数据，因此可以用作随机数元数据。/dev/urandom这个设备数据与random里面一样，只是，它是非阻塞的随机数发生器，读取操作不会产生阻塞。</span></span><br><span class="line"></span><br><span class="line">方法五</span><br><span class="line">[root@template sh]# cat /proc/sys/kernel/random/uuid </span><br><span class="line">9794b963-3311-483e-aa9b-ace2df623d07</span><br><span class="line"></span><br><span class="line">方法六</span><br><span class="line">[root@template sh]# yum install -y expect</span><br><span class="line">[root@template sh]# mkpasswd -l 8</span><br><span class="line"><span class="meta">E&gt;</span><span class="bash">jC45ut</span></span><br><span class="line"></span><br><span class="line">[root@template sh]# cat /proc/sys/kernel/random/uuid | md5sum | cut -c 1-9</span><br><span class="line">c1baddd2e</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的命令得到随机数后都通过md5sum再计算一次得到一个数字，到通过cut命令取指定长度的数字。cut的-c选项就是仅显示行中指定范围的字符</span></span><br></pre></td></tr></table></figure>
<h3 id="break、continue、exit对比"><a href="#break、continue、exit对比" class="headerlink" title="break、continue、exit对比"></a>break、continue、exit对比</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>break n</td>
<td>n表示跳出循环的层数，如果省略n表示跳出整个循环</td>
</tr>
<tr>
<td>continue n</td>
<td>n表示退出到第n层继续循环，如果省略n表示跳过本次循环，忽略本次循环的接任代码，进入循环的下一次循环</td>
</tr>
<tr>
<td>exit n</td>
<td>退出当前shell程序，终止整个shell脚本，并返回n。n也可以省略。</td>
</tr>
<tr>
<td>return</td>
<td>与exit相似，在函数中使用，用于跳出函数</td>
</tr>
</tbody>
</table>
<h3 id="shell函数"><a href="#shell函数" class="headerlink" title="shell函数"></a>shell函数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">简单的语法：</span><br><span class="line">函数名() &#123;</span><br><span class="line">    指令</span><br><span class="line">    return n</span><br><span class="line">&#125;</span><br><span class="line">规范的语法：</span><br><span class="line">function 函数名() &#123;</span><br><span class="line">    指令</span><br><span class="line">    return n</span><br><span class="line">&#125;</span><br><span class="line">调用函数：</span><br><span class="line">1. 直接执行函数名即可。注意，不需要带小括号</span><br><span class="line">例：函数名</span><br><span class="line">2. 带参数的函数执行方法：</span><br><span class="line">例：函数名 参数1 参数2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在函数体中的位置参数(<span class="variable">$1</span>、<span class="variable">$2</span>、<span class="variable">$3</span>、<span class="variable">$#</span>、$*、$?、<span class="variable">$@</span>)都可以是函数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 父脚本的参数则临时地被函数参数所掩盖或隐藏</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$0</span>比较特殊，它仍然是父脚本的名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 函数一定要在调用之前定义并加载</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim func1.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">if [ $# -ne 1 ];then</span><br><span class="line">   echo "error" &amp;&amp; exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">Check_Url() &#123;</span><br><span class="line">   curl -I -s $1|head -1 &amp;&amp; return 0||return 1</span><br><span class="line">&#125;</span><br><span class="line">Check_Url $1</span><br><span class="line"><span class="meta">#</span><span class="bash"> Check_Url后的<span class="variable">$1</span>是命令行的第一个参数，curl中的<span class="variable">$1</span>是函数的第一个参数。这两个<span class="variable">$1</span>的作用是不一样的</span></span><br><span class="line"></span><br><span class="line">例：生产环境批量检查web服务是否正常并且发送相关邮件</span><br><span class="line">[root@template sh]# vim check_service.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">RETVAL=0</span><br><span class="line">FAILCOUNT=0</span><br><span class="line">SCRIPTS_PATH="/root/sh"</span><br><span class="line">MAIL_GROUP="root@localhost"</span><br><span class="line">LOG_FILE="/tmp/web_check.log"</span><br><span class="line">GetUrlStatus() &#123;</span><br><span class="line">   for ((i=1;i&lt;=3;i++));do</span><br><span class="line">        wget -T 10 --tries=1 --spider http://$&#123;1&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        [ $? -ne 0 ] &amp;&amp; let FAILCOUNT+=1</span><br><span class="line">   done</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 访问三次页面，如果返回值不是0，变量FAILCOUNT就自增1。</span></span><br><span class="line">   if [ $FAILCOUNT -gt 1 ];then</span><br><span class="line">        RETVAL=1</span><br><span class="line">        NowTime=`date +"%m-%d %H:%M:%S"`</span><br><span class="line">        SC="http://$&#123;1&#125; service is error,$&#123;NowTime&#125;."</span><br><span class="line">        echo "send to : $MAIL_USER, Title: $SUBJECT_CONTENT" &gt; $LOG_FILE</span><br><span class="line">        for MAIL_USER in $MAIL_GROUP;do</span><br><span class="line">           mail -s "$SC" $MAIL_USER &lt; $LOG_FILE</span><br><span class="line">        done</span><br><span class="line">   else</span><br><span class="line">        RETVAL=0</span><br><span class="line">   fi</span><br><span class="line">   return $RETVAL</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 判断变量FAILCOUNT是否大于1，如果大于1,就发邮件，并记入日志文件，并将变量RETVAL的值改为1，否则RETVAL的值是0，RETVAL的值就是返回码，退出函数。</span></span><br><span class="line">&#125;</span><br><span class="line">[ ! -d "$SCRIPTS_PATH" ] &amp;&amp; mkdir -p $SCRIPTS_PATH</span><br><span class="line">[ ! -f "$SCRIPTS_PATH"/domain.list ] &amp;&amp; &#123;</span><br><span class="line">cat &gt; $SCRIPTS_PATH/domain.list &lt;&lt; END</span><br><span class="line">www.baidu.com</span><br><span class="line">www.sohu.com</span><br><span class="line">192.168.1.24</span><br><span class="line">END</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断变量SCRIPTS_PATH指定的目录是否存在，不存在就创建，再判断变量SCRIPTS_PATH中的domain.list文件是否存在，不存在就创建，其中是网页地址。</span></span><br><span class="line">for URL in `cat $SCRIPTS_PATH/domain.list`;do</span><br><span class="line">   echo -n "checking $URL: "</span><br><span class="line">   GetUrlStatus $URL &amp;&amp; echo ok || echo no</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 循环检查domain.list文件中的网址，将变量URL的值给GetUrlStatus函数，在GetUrlStatus函数中由<span class="variable">$1</span>接收。如果返回值是0就显示ok，否则显示no</span></span><br><span class="line">[root@template sh]# bash check_service.sh   </span><br><span class="line">checking www.baidu.com: ok</span><br><span class="line">checking www.sohu.com: ok</span><br><span class="line">checking 192.168.1.24: no</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>
<h3 id="优化linux系统"><a href="#优化linux系统" class="headerlink" title="优化linux系统"></a>优化linux系统</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 安装系统时精简安装包，最小化安装</span><br><span class="line">2. 配置国内高速yum源</span><br><span class="line">3. 禁用开机不需要启动的服务</span><br><span class="line">4. 优化系统内核参数，/etc/sysctl.conf</span><br><span class="line">5. 增加系统文件描述符、堆栈等配置</span><br><span class="line">6. 有外网IP的机器要开启配置防火墙，仅对外开启需要提供服务的端口，配置或关闭selinux</span><br><span class="line">7. 清除无用的默认系统帐户或组（非必须）</span><br><span class="line">8. 锁定敏感文件，如/etc/passwd（非必须）</span><br><span class="line">9. 配置服务器和互联网时间同步</span><br><span class="line">10. 配置sudo对普通用户权限精细控制</span><br><span class="line">11. 把以上10点写成一键优化脚本</span><br></pre></td></tr></table></figure>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">方法一</span><br><span class="line">array=(value1 value2 value3 ...)</span><br><span class="line">echo $&#123;#array[@]&#125;</span><br><span class="line">echo $&#123;#array[*]&#125;</span><br><span class="line">echo $&#123;#array[0]&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 计算数组中的共有几个值</span></span><br><span class="line">echo $&#123;array[*]&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出数组中的所有值</span></span><br><span class="line">echo $&#123;array[0]&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出数组中的某个值，数组的下标从0开始</span></span><br><span class="line">array[3]=4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给某个数组下标赋值</span></span><br><span class="line">array[0]=abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给已有的数组下标修改值</span></span><br><span class="line">unset array</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除整个数组</span></span><br><span class="line">unset array[0]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除数组中某个下标的值</span></span><br><span class="line">echo $&#123;array[@]:1:3&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从第几个元素开始截取，截取几个</span></span><br><span class="line">array=($&#123;array[@]/5/6&#125;)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将第5个元素的值改为6</span></span><br><span class="line">echo $&#123;array[@]#o&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从左开始最短匹配删除</span></span><br><span class="line">echo $&#123;array[@]#fo&#125;</span><br><span class="line">echo $&#123;array[@]%t*e&#125;</span><br><span class="line">echo $&#123;array[@]%%t*e&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数组也是变量，因此也适合于变量的子串处理的功能应用。</span></span><br><span class="line"></span><br><span class="line">方法二</span><br><span class="line">array=([1]=one [2]=two [3]=three)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义下标与值</span></span><br><span class="line"></span><br><span class="line">方法三</span><br><span class="line">array[0]=a array[1]=b array[2]=c </span><br><span class="line"></span><br><span class="line">方法四</span><br><span class="line">declare -a array</span><br><span class="line"></span><br><span class="line">方法五</span><br><span class="line">array=($(ls))</span><br></pre></td></tr></table></figure>
<h3 id="trap信号"><a href="#trap信号" class="headerlink" title="trap信号"></a>trap信号</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">trap使用信号的方法</span><br><span class="line">trap命令用于指定在接收到信号后将要采取的行动。trap命令的一种常见用途是在脚本程序被中断时完成清理工作。历史上，shell总是用数字来代表信号，而新的脚本程序应该使用的名字，它们保存在用#include命令包含进来的signal.h头文件中，在使用信号名时需要省略SIG前缀。你可以在命令提示符下输入命令trap -l来查看信号编号及其关联的名称。</span><br><span class="line">脚本程序通常是以从上到下的顺序解释执行的，所以必须在你想保护的那部分代码以前指定trap命令。</span><br><span class="line">如果要重置桔某个信号的处理条件到其默认值，只需简单的将command设置为-。如果要忽略某个信号，就把command设置为空字符串''，一个不带参数的trap命令将列出当前设置的信号及其行动的清单。exit命令后传输就是就是这个信号的代码</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template ~]# trap "" 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 屏蔽ctrl+c信号 </span></span><br><span class="line">[root@template ~]# trap ":" 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复ctrl+c信号 </span></span><br><span class="line">[root@template ~]# trap "echo -n 'you are typing ctrl+c'" 2 </span><br><span class="line">[root@template ~]# ^Cyou are typing ctrl+c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置一个提示，当输入指定信号时就会提示</span></span><br><span class="line">[root@template ~]# trap "" HUP INT QUIT TSTP TERM</span><br><span class="line"><span class="meta">#</span><span class="bash"> 屏蔽多个信号</span></span><br><span class="line">[root@template ~]# trap ":" HUP INT QUIT TSTP TERM</span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复多个信号 </span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim showdate.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">trap 'echo “you go…”;exit 1' INT</span><br><span class="line">while :; do</span><br><span class="line">    date</span><br><span class="line">    sleep 2</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 捕捉到信號，顯示命令。要想用ctrl+c退出，要在<span class="built_in">echo</span> you go后加&amp;&amp; <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">[root@template sh]# vim ping.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">NET=192.168.1</span><br><span class="line">FILE=`mktemp /tmp/file.XXXXX`</span><br><span class="line">clearup() &#123;</span><br><span class="line">   echo “quit…”</span><br><span class="line">   rm -f $FILE</span><br><span class="line">   exit 1</span><br><span class="line">&#125;</span><br><span class="line">trap 'clearup' INT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试发现，只要有退出码，就可以使用ctrl+c退出脚本。如上面的退出码是<span class="built_in">exit</span> 1。如果注释了上面的函数，再使用ctrl+c退出时只能退出当前ping的命令，脚本会继续ping下一个地址。</span></span><br><span class="line">for I in &#123;200..254&#125;; do</span><br><span class="line">   if ping -c 1 -W 1 $NET.$I &amp;&gt; /dev/null; then</span><br><span class="line">      echo “$NET.$I is up .” | tee &gt;&gt; $FILE</span><br><span class="line">   else</span><br><span class="line">      echo “$NET.$I is down”</span><br><span class="line">   fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/08/redis命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/08/redis命令/" itemprop="url">
                  redis命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-08 09:34:35" itemprop="dateCreated datePublished" datetime="2019-01-08T09:34:35+08:00">2019-01-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-09 18:18:48" itemprop="dateModified" datetime="2019-01-09T18:18:48+08:00">2019-01-09</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# yum install -y redis</span><br><span class="line">[root@test ~]# rpm -ql redis</span><br><span class="line">/etc/logrotate.d/redis</span><br><span class="line">/etc/redis-sentinel.conf</span><br><span class="line">/etc/redis.conf</span><br><span class="line">/etc/systemd/system/redis-sentinel.service.d</span><br><span class="line">/etc/systemd/system/redis-sentinel.service.d/limit.conf</span><br><span class="line">/etc/systemd/system/redis.service.d</span><br><span class="line">/etc/systemd/system/redis.service.d/limit.conf</span><br><span class="line">/usr/bin/redis-benchmark：评估redis性能</span><br><span class="line">/usr/bin/redis-check-aof：检测工具</span><br><span class="line">/usr/bin/redis-check-rdb：检测工具</span><br><span class="line">/usr/bin/redis-cli</span><br><span class="line">/usr/bin/redis-sentinel</span><br><span class="line">/usr/bin/redis-server：主程序</span><br><span class="line">/usr/lib/systemd/system/redis-sentinel.service</span><br><span class="line">/usr/lib/systemd/system/redis.service</span><br><span class="line">/usr/libexec/redis-shutdown</span><br><span class="line">...</span><br><span class="line">/var/lib/redis：数据存储目录</span><br><span class="line">/var/log/redis</span><br><span class="line">/var/run/redis</span><br><span class="line">[root@test ~]# systemctl start redis</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128    127.0.0.1:6379                    *:*  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听127地址的6379端口，要监听在所有地址，需要认证，只有密码，没有用户名</span></span><br><span class="line">[root@test ~]# redis-cli -h localhost -p 6379</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接本机的redis，-h指定地址，-p指定端口，-a指定密码，连接本机时不用密码</span></span><br><span class="line">localhost:6379&gt; SELECT 0</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换数据库，数据库以数字表示，默认是16个库，0－15</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">help</span> @&lt;group&gt;可查看一组命令的使用格式；<span class="built_in">help</span> &lt;<span class="built_in">command</span>&gt;可查看单个命令的使用方法；<span class="built_in">help</span> &lt;tab&gt;可切换命令组；</span></span><br><span class="line">localhost:6379&gt; help @list</span><br><span class="line">localhost:6379&gt; SET name tom</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置健为name，值为tom</span></span><br><span class="line">localhost:6379&gt; GET name</span><br><span class="line">"tom"</span><br><span class="line">localhost:6379&gt; APPEND name brown</span><br><span class="line">(integer) 8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在name的值后追加值brown</span></span><br><span class="line">localhost:6379&gt; GET name</span><br><span class="line">"tombrown"</span><br><span class="line">localhost:6379&gt; STRLEN name</span><br><span class="line">(integer) 8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看name值有多长</span></span><br><span class="line">localhost:6379&gt; SET count 0</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置一个计数器叫count，值为0</span></span><br><span class="line">localhost:6379&gt; INCR count</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> count计数器的值加1</span></span><br><span class="line">localhost:6379&gt; INCRBY count 10</span><br><span class="line">(integer) 11</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在count计数器上加10</span></span><br><span class="line">localhost:6379&gt; DECR count</span><br><span class="line">(integer) 10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 计数器减1</span></span><br><span class="line">localhost:6379&gt; DECRBY count 3</span><br><span class="line">(integer) 7</span><br><span class="line"><span class="meta">#</span><span class="bash"> 计数器减3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 先进先出FIFO(First IN First Out)，后进先出</span></span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">* 查看配置语法</span><br><span class="line">redis 127.0.0.1:6379&gt; CONFIG GET CONFIG_SETTING_NAME</span><br><span class="line">例 </span><br><span class="line">localhost:6379&gt; CONFIG GET loglevel</span><br><span class="line">1) "loglevel"</span><br><span class="line">2) "notice"</span><br><span class="line"></span><br><span class="line">localhost:6379&gt; CONFIG GET *</span><br><span class="line">  1) "dbfilename"</span><br><span class="line">  2) "dump.rdb"</span><br><span class="line">  3) "requirepass"</span><br><span class="line">  ...</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 使用 * 号获取所有配置项</span></span><br><span class="line">  </span><br><span class="line">  * 编辑配置</span><br><span class="line">  语法</span><br><span class="line">  redis 127.0.0.1:6379&gt; CONFIG SET CONFIG_SETTING_NAME NEW_CONFIG_VALUE</span><br><span class="line">  例</span><br><span class="line">  localhost:6379&gt; CONFIG SET loglevel "notice"</span><br><span class="line"> OK</span><br><span class="line"> </span><br><span class="line">[root@test ~]# vim /etc/redis.conf</span><br><span class="line">    daemonize no</span><br><span class="line"><span class="meta">	#</span><span class="bash"> Redis默认不是以守护进程的方式运行，可以通过该配置项修改，使用yes启用守护进程</span></span><br><span class="line"></span><br><span class="line">    pidfile /var/run/redis.pid</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 当Redis以守护进程方式运行时，Redis默认会把pid写入/var/run/redis.pid文件，可以通过pidfile指定</span></span><br><span class="line"></span><br><span class="line">    port 6379</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定Redis监听端口，默认端口为6379</span></span><br><span class="line"></span><br><span class="line">    bind 127.0.0.1</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 绑定的主机地址</span></span><br><span class="line"></span><br><span class="line">    timeout 300</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 当客户端闲置多长时间后关闭连接，如果指定为0，表示关闭该功能</span></span><br><span class="line"></span><br><span class="line">    loglevel verbose</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定日志记录级别，Redis总共支持四个级别：debug、verbose、notice、warning，默认为verbose</span></span><br><span class="line"></span><br><span class="line">    logfile stdout</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 日志记录方式，默认为标准输出，如果配置Redis为守护进程方式运行，而这里又配置为日志记录方式为标准输出，则日志将会发送给/dev/null</span></span><br><span class="line"></span><br><span class="line">    databases 16</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 设置数据库的数量，默认数据库为0，可以使用SELECT &lt;dbid&gt;命令在连接上指定数据库id</span></span><br><span class="line"></span><br><span class="line">    save &lt;seconds&gt; &lt;changes&gt;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定在多长时间内，有多少次更新操作，就将数据同步到数据文件，可以多个条件配合</span></span><br><span class="line">    # Redis默认配置文件中提供了三个条件：</span><br><span class="line">    # save 900 1</span><br><span class="line">    # save 300 10</span><br><span class="line">    # save 60 10000</span><br><span class="line">    # 分别表示900秒（15分钟）内有1个更改，300秒（5分钟）内有10个更改以及60秒内有10000个更改。</span><br><span class="line"></span><br><span class="line">    rdbcompression yes</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定存储至本地数据库时是否压缩数据，默认为yes，Redis采用LZF压缩，如果为了节省CPU时间，可以关闭该选项，但会导致数据库文件变的巨大</span></span><br><span class="line"></span><br><span class="line">    dbfilename dump.rdb</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定本地数据库文件名，默认值为dump.rdb</span></span><br><span class="line"></span><br><span class="line">    dir ./</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定本地数据库存放目录</span></span><br><span class="line"></span><br><span class="line">    slaveof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 设置当本机为slav服务时，设置master服务的IP地址及端口，在Redis启动时，它会自动从master进行数据同步</span></span><br><span class="line"></span><br><span class="line">    masterauth &lt;master-password&gt;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 当master服务设置了密码保护时，slav服务连接master的密码</span></span><br><span class="line"></span><br><span class="line">    requirepass foobared</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 设置Redis连接密码，如果配置了连接密码，客户端在连接Redis时需要通过AUTH &lt;password&gt;命令提供密码，默认关闭</span></span><br><span class="line"></span><br><span class="line">    maxclients 128</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 设置同一时间最大客户端连接数，默认无限制，Redis可以同时打开的客户端连接数为Redis进程可以打开的最大文件描述符数，如果设置 maxclients 0，表示不作限制。当客户端连接数到达限制时，Redis会关闭新的连接并向客户端返回max number of clients reached错误信息</span></span><br><span class="line"></span><br><span class="line">    maxmemory &lt;bytes&gt;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定Redis最大内存限制，Redis在启动时会把数据加载到内存中，达到最大内存后，Redis会先尝试清除已到期或即将到期的Key，当此方法处理后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作。Redis新的vm机制，会把Key存放内存，Value会存放在swap区</span></span><br><span class="line"></span><br><span class="line">    appendonly no</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定是否在每次更新操作后进行日志记录，Redis在默认情况下是异步的把数据写入磁盘，如果不开启，可能会在断电时导致一段时间内的数据丢失。因为redis本身同步数据文件是按上面save条件来同步的，所以有的数据会在一段时间内只存在于内存中。默认为no</span></span><br><span class="line"></span><br><span class="line">     appendfilename appendonly.aof</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定更新日志文件名，默认为appendonly.aof</span></span><br><span class="line"></span><br><span class="line">    appendfsync everysec</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定更新日志条件，共有3个可选值： </span></span><br><span class="line">    # no：表示等操作系统进行数据缓存同步到磁盘（快） </span><br><span class="line">    # always：表示每次更新操作后手动调用fsync()将数据写到磁盘（慢，安全） </span><br><span class="line">    # everysec：表示每秒同步一次（折中，默认值）</span><br><span class="line"> </span><br><span class="line">     vm-enabled no</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定是否启用虚拟内存机制，默认值为no，简单的介绍一下，VM机制将数据分页存放，由Redis将访问量较少的页即冷数据swap到磁盘上，访问多的页面由磁盘自动换出到内存中</span></span><br><span class="line"></span><br><span class="line">     vm-swap-file /tmp/redis.swap</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 虚拟内存文件路径，默认值为/tmp/redis.swap，不可多个Redis实例共享</span></span><br><span class="line"></span><br><span class="line">     vm-max-memory 0</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 将所有大于vm-max-memory的数据存入虚拟内存,无论vm-max-memory设置多小,所有索引数据都是内存存储的(Redis的索引数据就是keys),也就是说,当vm-max-memory设置为0的时候,其实是所有value都存在于磁盘。默认值为0</span></span><br><span class="line"></span><br><span class="line">     vm-page-size 32</span><br><span class="line"><span class="meta">	#</span><span class="bash"> Redis swap文件分成了很多的page，一个对象可以保存在多个page上面，但一个page上不能被多个对象共享，vm-page-size是要根据存储的数据大小来设定的，作者建议如果存储很多小对象，page大小最好设置为32或者64bytes；如果存储很大的对象，则可以使用更大的page，如果不确定，就使用默认值</span></span><br><span class="line"></span><br><span class="line">     vm-pages 134217728</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 设置swap文件中的page数量，由于页表（一种表示页面空闲或使用的bitmap）是在放在内存中的，在磁盘上每8个pages将消耗1byte的内存。</span></span><br><span class="line"></span><br><span class="line">     vm-max-threads 4</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 设置访问swap文件的线程数,最好不要超过机器的核数,如果设置为0,那么所有对swap文件的操作都是串行的，可能会造成比较长时间的延迟。默认值为4</span></span><br><span class="line"></span><br><span class="line">    glueoutputbuf yes</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 设置在向客户端应答时，是否把较小的包合并为一个包发送，默认为开启</span></span><br><span class="line"></span><br><span class="line">    hash-max-zipmap-entries 64</span><br><span class="line">    hash-max-zipmap-value 512</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定在超过一定的数量或者最大的元素超过某一临界值时，采用一种特殊的哈希算法</span></span><br><span class="line"></span><br><span class="line">    activerehashing yes</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 指定是否激活重置哈希，默认为开启</span></span><br><span class="line"></span><br><span class="line">    include /path/to/local.conf</span><br><span class="line">    # 指定包含其它的配置文件，可以在同一主机上多个Redis实例之间使用同一份配置文件，而同时各个实例又拥有自己的特定配置文件</span><br></pre></td></tr></table></figure>
<h3 id="List（列表）"><a href="#List（列表）" class="headerlink" title="List（列表）"></a>List（列表）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">localhost:6379&gt; LPUSH weekdays Mon Tue</span><br><span class="line">(integer) 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 追加一个weekdays队列，但从右进，值是Mon Tue</span></span><br><span class="line">localhost:6379&gt; LINDEX weekdays 0</span><br><span class="line">"Tue"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看队列最左侧的索引值，显示Tue</span></span><br><span class="line">localhost:6379&gt; LRANGE weekdays 0 1</span><br><span class="line">1) "Tue"</span><br><span class="line">2) "Mon"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取列表指定范围内的元素</span></span><br><span class="line">localhost:6379&gt; RPUSH weekdays Wed Thu</span><br><span class="line">(integer) 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 向weekdays队列中追加值Wed和Thu</span></span><br><span class="line">localhost:6379&gt; LINDEX weekdays 3</span><br><span class="line">"Thu"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看索引为3的值。因为是从0开始编号的，所以第3个是Thu</span></span><br><span class="line">localhost:6379&gt; LRANGE weekdays 0 5</span><br><span class="line">1) "Tue"</span><br><span class="line">2) "Mon"</span><br><span class="line">3) "Wed"</span><br><span class="line">4) "Thu"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取列表指定范围内的元素</span></span><br><span class="line">localhost:6379&gt; LPOP weekdays</span><br><span class="line">"Tue"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从weekdays队列最左侧删除数据</span></span><br><span class="line">localhost:6379&gt; RPOP weekdays</span><br><span class="line">"Thu"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从weekdays队列最右侧删除数据</span></span><br><span class="line">localhost:6379&gt; LINSERT weekdays BEFORE Wed Fri</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在Wed前插入数据Fri。BEFORE在指定元素前插入数据，AFTER是在指定元素之后插入数据</span></span><br><span class="line">localhost:6379&gt; LINDEX weekdays 1</span><br><span class="line">"Fri"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示Fri，因为上面将Fri插入在了原来索引为1的Web前</span></span><br><span class="line">localhost:6379&gt; LRANGE weekdays 0 10</span><br><span class="line">1) "Mon"</span><br><span class="line">2) "Fri"</span><br><span class="line">3) "Wed"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取列表指定范围内的元素</span></span><br></pre></td></tr></table></figure>
<h3 id="hash（哈希）"><a href="#hash（哈希）" class="headerlink" title="hash（哈希）"></a>hash（哈希）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">localhost:6379&gt; HSET stu1 name tom</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义一个名字叫stu1的表name名字叫tom</span></span><br><span class="line">localhost:6379&gt; HSET stu1 age 17</span><br><span class="line">(integer) 1</span><br><span class="line">localhost:6379&gt; HMSET stu1 gender Male major Kuihua</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> HMSET可以设置多个下标，gender和major是下标，Male和Kuihua是值</span></span><br><span class="line">localhost:6379&gt; HKEYS stu1</span><br><span class="line">1) "name"</span><br><span class="line">2) "age"</span><br><span class="line">3) "gender"</span><br><span class="line">4) "major"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看stu1的下标的名字</span></span><br><span class="line">localhost:6379&gt; HVALS stu1</span><br><span class="line">1) "tom"</span><br><span class="line">2) "17"</span><br><span class="line">3) "Male"</span><br><span class="line">4) "Kuihua"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看下标的值</span></span><br><span class="line">localhost:6379&gt; HDEL stu1 major</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除stu1的下标major</span></span><br><span class="line">localhost:6379&gt; HKEYS stu1</span><br><span class="line">1) "name"</span><br><span class="line">2) "age"</span><br><span class="line">3) "gender"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看下标</span></span><br><span class="line">localhost:6379&gt; HLEN stu1</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看key上有几个元素</span></span><br><span class="line">localhost:6379&gt; HSTRLEN stu1 name</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看name元素有几个字节</span></span><br></pre></td></tr></table></figure>
<h3 id="Set（集合）"><a href="#Set（集合）" class="headerlink" title="Set（集合）"></a>Set（集合）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">localhost:6379&gt; SADD tom lucy lily hanmeimei</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个集合叫tom，tom后的是他的好友的名字</span></span><br><span class="line">localhost:6379&gt; SADD jerry lucy obama trump</span><br><span class="line">(integer) 3</span><br><span class="line">localhost:6379&gt; SINTER tom jerry</span><br><span class="line">1) "lucy"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看tom和jerry的交集</span></span><br><span class="line">localhost:6379&gt; SUNION tom jerry</span><br><span class="line">1) "lucy"</span><br><span class="line">2) "lily"</span><br><span class="line">3) "hanmeimei"</span><br><span class="line">4) "trump"</span><br><span class="line">5) "obama"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看tom和jerry的并集</span></span><br><span class="line">localhost:6379&gt; SDIFF tom jerry</span><br><span class="line">1) "lily"</span><br><span class="line">2) "hanmeimei"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看差集，tom有的而jerry没有朋友的名字</span></span><br><span class="line">localhost:6379&gt; SDIFF jerry tom</span><br><span class="line">1) "trump"</span><br><span class="line">2) "obama"</span><br><span class="line">localhost:6379&gt; SMEMBERS tom</span><br><span class="line">1) "lily"</span><br><span class="line">2) "lucy"</span><br><span class="line">3) "hanmeimei"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看tom集合的所有元素</span></span><br><span class="line">localhost:6379&gt; SMEMBERS jerry</span><br><span class="line">1) "trump"</span><br><span class="line">2) "obama"</span><br><span class="line">3) "lucy"</span><br><span class="line">localhost:6379&gt; SUNIONSTORE friends tom jerry</span><br><span class="line">(integer) 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看并集并保存，保存的键名叫friends</span></span><br><span class="line">localhost:6379&gt; SMEMBERS friends</span><br><span class="line">1) "lucy"</span><br><span class="line">2) "lily"</span><br><span class="line">3) "hanmeimei"</span><br><span class="line">4) "trump"</span><br><span class="line">5) "obama"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看</span></span><br></pre></td></tr></table></figure>
<h3 id="sorted-set（有序集合）"><a href="#sorted-set（有序集合）" class="headerlink" title="sorted set（有序集合）"></a>sorted set（有序集合）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">localhost:6379&gt; ZADD colors 1 red 2 blue 8 green 5 gray</span><br><span class="line">(integer) 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个叫colors的集合。添加时提示“OOM <span class="built_in">command</span> not allowed when used memory &gt; <span class="string">'maxmemory'</span>”，是因为配置文件中设置了maxmemory的值，现在已经达到了上限，所以报错。</span></span><br><span class="line">localhost:6379&gt; ZCARD colors</span><br><span class="line">(integer) 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看colors有几个成员</span></span><br><span class="line">localhost:6379&gt; ZSCORE colors green</span><br><span class="line">"8"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看成员green的分数</span></span><br><span class="line">localhost:6379&gt; ZCOUNT colors 2 6</span><br><span class="line">(integer) 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计一个范围分数的成员个数</span></span><br><span class="line">localhost:6379&gt; ZRANGE colors 0 5</span><br><span class="line">1) "red"</span><br><span class="line">2) "blue"</span><br><span class="line">3) "gray"</span><br><span class="line">4) "green"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 返回所指范围内的值</span></span><br><span class="line">localhost:6379&gt; ZRANK colors gray</span><br><span class="line">(integer) 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看元素的索引是几</span></span><br></pre></td></tr></table></figure>
<h3 id="发布订阅"><a href="#发布订阅" class="headerlink" title="发布订阅"></a>发布订阅</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">localhost:6379&gt; SUBSCRIBE military</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) "subscribe"</span><br><span class="line">2) "military"</span><br><span class="line">3) (integer) 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 订阅频道，这时会停留在频道中</span></span><br><span class="line">再打开一个窗口连接redis</span><br><span class="line">[root@test ~]# redis-cli -h localhost</span><br><span class="line">localhost:6379&gt; PUBLISH military caoxian</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 向military频道中发布一条信息</span></span><br><span class="line">回到之前的窗口，这时会显示刚发布的信息</span><br><span class="line">localhost:6379&gt; SUBSCRIBE military finance</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) "subscribe"</span><br><span class="line">2) "military"</span><br><span class="line">3) (integer) 1</span><br><span class="line">1) "subscribe"</span><br><span class="line">2) "finance"</span><br><span class="line">3) (integer) 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在第一个窗口重新订阅两个频道</span></span><br><span class="line">到新窗口重新发布信息</span><br><span class="line">localhost:6379&gt; PUBLISH finance bitcorn</span><br><span class="line">(integer) 1</span><br><span class="line">回到之前的窗口</span><br><span class="line">[root@test ~]# redis-cli -h localhost -p 6379</span><br><span class="line">localhost:6379&gt; SUBSCRIBE military finance</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) "subscribe"</span><br><span class="line">2) "military"</span><br><span class="line">3) (integer) 1</span><br><span class="line">1) "subscribe"</span><br><span class="line">2) "finance"</span><br><span class="line">3) (integer) 2</span><br><span class="line">1) "message"</span><br><span class="line">2) "finance"</span><br><span class="line">3) "bitcorn"</span><br></pre></td></tr></table></figure>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# vim /etc/redis.conf</span><br><span class="line">requirepass mageedu</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置密码为mageedu</span></span><br><span class="line">[root@test ~]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; GET name</span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时是不能使用的，要密码</span></span><br><span class="line">127.0.0.1:6379&gt; AUTH mageedu</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给密码</span></span><br><span class="line">127.0.0.1:6379&gt; GET name</span><br><span class="line">"tombrown"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时就能得到数据了</span></span><br><span class="line">127.0.0.1:6379&gt; INFO Server</span><br><span class="line"><span class="meta">#</span><span class="bash"> Server</span></span><br><span class="line">redis_version:3.2.12</span><br><span class="line">redis_git_sha1:00000000</span><br><span class="line">redis_git_dirty:0</span><br><span class="line">redis_build_id:7897e7d0e13773f</span><br><span class="line">redis_mode:standalone</span><br><span class="line">os:Linux 3.10.0-693.el7.x86_64 x86_64</span><br><span class="line">arch_bits:64</span><br><span class="line">multiplexing_api:epoll</span><br><span class="line">gcc_version:4.8.5</span><br><span class="line">process_id:2591</span><br><span class="line">run_id:af2243e0cf36e57e000b383901b8c832530fc91e</span><br><span class="line">tcp_port:6379</span><br><span class="line">uptime_in_seconds:74</span><br><span class="line">uptime_in_days:0</span><br><span class="line">hz:10</span><br><span class="line">lru_clock:3412915</span><br><span class="line">executable:/usr/bin/redis-server</span><br><span class="line">config_file:/etc/redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看服务器信息</span></span><br><span class="line">127.0.0.1:6379&gt; INFO</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看所有信息</span></span><br><span class="line">127.0.0.1:6379&gt; INFO Clients</span><br><span class="line"><span class="meta">#</span><span class="bash"> Clients</span></span><br><span class="line">connected_clients:1</span><br><span class="line">client_longest_output_list:0</span><br><span class="line">client_biggest_input_buf:0</span><br><span class="line">blocked_clients:0</span><br><span class="line">127.0.0.1:6379&gt; INFO Memory</span><br><span class="line"><span class="meta">#</span><span class="bash"> Memory</span></span><br><span class="line">used_memory:814480</span><br><span class="line">used_memory_human:795.39K</span><br><span class="line">used_memory_rss:5947392</span><br><span class="line">used_memory_rss_human:5.67M</span><br><span class="line">used_memory_peak:815328</span><br><span class="line">used_memory_peak_human:796.22K</span><br><span class="line">total_system_memory:1023713280</span><br><span class="line">total_system_memory_human:976.29M</span><br><span class="line">used_memory_lua:37888</span><br><span class="line">used_memory_lua_human:37.00K</span><br><span class="line">maxmemory:0</span><br><span class="line">maxmemory_human:0B</span><br><span class="line">maxmemory_policy:noeviction</span><br><span class="line">mem_fragmentation_ratio:7.30</span><br><span class="line">mem_allocator:jemalloc-3.6.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存信息，其中的maxmemory_policy:noeviction表示最大内存用尽后的策略，noeviction表示不处理，新数据就没法存了。还可以使用内存的淘汰策略</span></span><br><span class="line">localhost:6379&gt; CLIENT LIST</span><br><span class="line">id=2 addr=127.0.0.1:44490 fd=5 name= age=216 idle=44 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=client</span><br><span class="line">id=3 addr=127.0.0.1:44492 fd=6 name= age=10 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=client</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有连接上服务器的客户端</span></span><br></pre></td></tr></table></figure>
<h3 id="测试：修改配置文件"><a href="#测试：修改配置文件" class="headerlink" title="测试：修改配置文件"></a>测试：修改配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# vim /etc/redis.conf</span><br><span class="line">    #######INCLUDES##############</span><br><span class="line">    //包含段</span><br><span class="line"><span class="meta">	#</span><span class="bash"><span class="comment">####NETWORK#########</span></span></span><br><span class="line">	bind	0.0.0.0</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 监听所有地址</span></span><br><span class="line">	protected-mode	yes</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 是否工作在保护模式，无论监听哪个地址，都只能本机连接。不使用监听地址和认证功能此项才生效</span></span><br><span class="line">	prot  6379	</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 监听端口</span></span><br><span class="line">	timeout 0		</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 客户端空闲超时时间，超时就与客户端断开连接</span></span><br><span class="line">	tcp-keepalive 300		</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 客户端与服务器tcp连接保持时长</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"><span class="comment">#####SECURITY#######</span></span></span><br><span class="line">	requirepass   mageedu		</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 认证密码</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"><span class="comment">#######LIMITS######</span></span></span><br><span class="line">	maxclients  10000		</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 最大并发连接数</span></span><br><span class="line">	maxmemory 		</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 最大内存。最好手动设置</span></span><br><span class="line">	maxmemory-policy 		</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 内存淘汰策略；noeviction不启用淘汰机制；</span></span><br><span class="line">	maxmemory-samples 5		</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 淘汰的样本数量，每次找5个并淘汰1个</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"><span class="comment">#####SLOW LOG#####</span></span></span><br><span class="line">	slowlog-log-slower-than 10000	</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 慢查询的时间，微秒</span></span><br><span class="line">[root@test ~]# systemctl restart redis</span><br><span class="line">* 换一台主机</span><br><span class="line">[root@test ~]# redis-cli -h 192.168.1.14</span><br><span class="line">192.168.1.14:6379&gt; GET name</span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">192.168.1.14:6379&gt; auth mageedu</span><br><span class="line">OK</span><br><span class="line">192.168.1.14:6379&gt; get name</span><br><span class="line">"tombrown"</span><br></pre></td></tr></table></figure>
<h3 id="实时配置"><a href="#实时配置" class="headerlink" title="实时配置"></a>实时配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; CONFIG GET requirepass</span><br><span class="line">1) "requirepass"</span><br><span class="line">2) "mageedu"</span><br><span class="line">127.0.0.1:6379&gt; CONFIG SET requirepass 123456</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; CONFIG GET requirepass</span><br><span class="line">1) "requirepass"</span><br><span class="line">2) "123456"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将密码从mageedu改为123456</span></span><br><span class="line">127.0.0.1:6379&gt; CONFIG REWRITE</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将内存中的数据覆盖配置文件中的值</span></span><br><span class="line">127.0.0.1:6379&gt; CONFIG SET appendonly yes</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动AOF功能.这是为了让数据在写入内存时就记入日志，防止断电时数据丢失</span></span><br><span class="line">[root@test ~]# vim /etc/redis.conf </span><br><span class="line">requirepass "123456"</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件中有两条配置了</span></span><br><span class="line">[root@test ~]# ls /var/lib/redis/</span><br><span class="line">appendonly.aof  dump.rdb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时有.aof的文件了</span></span><br><span class="line">127.0.0.1:6379&gt; CONFIG RESETSTAT</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重置INFO命令输出的数据</span></span><br></pre></td></tr></table></figure>
<h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 准备三台主机，node1-3，第一台为主节点，后两台为从节点</span></span><br><span class="line"></span><br><span class="line">* node1 192.168.1.14</span><br><span class="line">[root@node1 ~]# vim /etc/redis.conf</span><br><span class="line">	bind 0.0.0.0</span><br><span class="line">	requirepass "123456"</span><br><span class="line">[root@node1 ~]# systemctl restart redis</span><br><span class="line"></span><br><span class="line">* node2、3 192.168.1.15 192.168.1.13</span><br><span class="line">[root@node2 ~]# vim /etc/redis.conf</span><br><span class="line">	bind 0.0.0.0</span><br><span class="line">	requirepass "123456"</span><br><span class="line">[root@node2 ~]# systemctl start redis</span><br><span class="line">[root@node2 ~]# ss -tln</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128         *:6379                    *:* </span><br><span class="line">127.0.0.1:6379&gt; SLAVEOF 192.168.1.14 6379</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指明主节点地址和端口就可以了</span></span><br><span class="line">127.0.0.1:6379&gt; CONFIG SET masterauth 123456</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置主节点的认证密码</span></span><br><span class="line">127.0.0.1:6379&gt; CONFIG REWRITE</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 写入配置文件</span></span><br><span class="line">=======================================================================================</span><br><span class="line">也可以直接写入配置文件</span><br><span class="line">[root@node3 ~]# vim /etc/redis.conf</span><br><span class="line">slaveof 192.168.1.14 6379</span><br><span class="line">masterauth "123456"</span><br><span class="line">=======================================================================================</span><br><span class="line"></span><br><span class="line">* node1 192.168.1.14</span><br><span class="line">127.0.0.1:6379&gt; INFO Replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.1.15,port=6379,state=online,offset=197,lag=1</span><br><span class="line">slave1:ip=192.168.1.13,port=6379,state=online,offset=197,lag=0</span><br><span class="line">master_repl_offset:197</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:196</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到两个从节点</span></span><br><span class="line"></span><br><span class="line">* node2 192.168.1.15</span><br><span class="line">127.0.0.1:6379&gt; GET name</span><br><span class="line">"tombrown"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到有信息了</span></span><br><span class="line"></span><br><span class="line">* node3 192.168.1.13</span><br><span class="line">127.0.0.1:6379&gt; GET name</span><br><span class="line">"tombrown"</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS jerry</span><br><span class="line">1) "lucy"</span><br><span class="line">2) "obama"</span><br><span class="line">3) "trump"</span><br><span class="line"><span class="meta">#</span><span class="bash"> node3上也可以查询到信息了</span></span><br><span class="line">127.0.0.1:6379&gt; CONFIG GET slave-read-only</span><br><span class="line">1) "slave-read-only"</span><br><span class="line">2) "yes"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看从节点的配置是否为只读。只有当前节点为从节点时才有效。可以通过CONFIG SET slave-read-only no来设置此项为yes或no</span></span><br><span class="line">127.0.0.1:6379&gt; SET hikey hellothere</span><br><span class="line">(error) READONLY You can't write against a read only slave.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在从节点上是不可以设置数据的，有错误提示</span></span><br></pre></td></tr></table></figure>
<h3 id="redis-sentinel"><a href="#redis-sentinel" class="headerlink" title="redis-sentinel"></a>redis-sentinel</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 准备三台主机，node1：192.168.1.14，node2：192.168.1.15，node3：192.168.1.13</span></span><br><span class="line"></span><br><span class="line">* 三台主机</span><br><span class="line">[root@node1 ~]# vim /etc/sudoers</span><br><span class="line"><span class="meta">	#</span><span class="bash"> Defaults requiretty</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果有此项就注释掉</span></span><br><span class="line">[root@node1 ~]# vim /etc/sudoers.d/redis</span><br><span class="line">	redis ALL=(ALL) NOPASSWD:/sbin/ip,NOPASSWD:/sbin/arping</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是为了让redis用户使用sudo命令时不用密码也可执行ip和arping命令。因为redis-sentinel进程是以redis身份运行的，所以执行脚本时也是redis用户，但redis用户是没有权限设置本机地址的，所以要给它权限。</span></span><br><span class="line">[root@node1 ~]# vim /opt/notify_mymaster.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">MASTER_IP=$&#123;6&#125;</span><br><span class="line">LOCAL_IP='192.168.1.14'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置为每台主机的本地地址</span></span><br><span class="line">VIP='192.168.1.10'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 虚拟IP地址不能变</span></span><br><span class="line">NETMASK='24'</span><br><span class="line">INTERFACE='ens33'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 本地地址所在的网卡</span></span><br><span class="line">if [ $&#123;MASTER_IP&#125; = $&#123;LOCAL_IP&#125; ];then</span><br><span class="line">    sudo /usr/sbin/ip addr add $&#123;VIP&#125;/$&#123;NETMASK&#125; dev $&#123;INTERFACE&#125;</span><br><span class="line">    sudo /usr/sbin/arping -q -c 3 -A $&#123;VIP&#125; -I $&#123;INTERFACE&#125;</span><br><span class="line">    exit 0</span><br><span class="line">else</span><br><span class="line">   sudo /usr/sbin/ip addr del $&#123;VIP&#125;/$&#123;NETMASK&#125; dev $&#123;INTERFACE&#125;</span><br><span class="line">   exit 0</span><br><span class="line">fi</span><br><span class="line">exit 1</span><br><span class="line">[root@node1 ~]# chmod  777 /opt/notify_mymaster.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 脚本一定要有执行权限，不然sentinel服务无法启动</span></span><br><span class="line"></span><br><span class="line">* node1</span><br><span class="line">[root@node1 ~]# /etc/redis.conf</span><br><span class="line">	bind 0.0.0.0</span><br><span class="line">[root@node1 ~]# systemctl start redis</span><br><span class="line">[root@test ~]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; CONFIG SET requirepass redisqwer1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; CONFIG SET masterauth redisqwer1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; CONFIG REWRITE</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">* node2&amp;3</span><br><span class="line">[root@node1 ~]# /etc/redis.conf</span><br><span class="line">	bind 0.0.0.0</span><br><span class="line">[root@node1 ~]# systemctl start redis</span><br><span class="line">127.0.0.1:6379&gt; slaveof 192.168.1.14 6379</span><br><span class="line">OK Already connected to specified master</span><br><span class="line">127.0.0.1:6379&gt; CONFIG SET masterauth redisqwer1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; CONFIG SET requirepass redisqwer1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; CONFIG REWRITE</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的三个节点都应该设置masterauth和requirepass的值，requirepass的值是自己作为主节点时，别人请求要用的认证密码。masterauth是与主节点通信时要用到的认证密码。也就是说，masterauth指向的密码就是requirepass设置的密码。因为三个节点都可以做主节点，所以都要设置。如果只设置一个，那么在主节点查看从节点信息时，有可能只显示一个。可在从节点查看/var/<span class="built_in">log</span>/redis/redis.conf日志，日志中会显示不能加入集群的信息</span></span><br><span class="line"></span><br><span class="line">* node1</span><br><span class="line">127.0.0.1:6379&gt; INFO replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.1.15,port=6379,state=online,offset=351,lag=0</span><br><span class="line">slave1:ip=192.168.1.13,port=6379,state=online,offset=351,lag=1</span><br><span class="line">master_repl_offset:351</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:350</span><br><span class="line">[root@node1 ~]# vim /etc/redis-sentinel.conf</span><br><span class="line">port 26379</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">dir "/tmp"</span><br><span class="line">sentinel myid 8da3fbcd01dafcbb9558f1ac5b52406a3afd00de</span><br><span class="line">sentinel monitor mymaster 192.168.1.14 6379 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel监听主节点的地址和端口，2表示至少有几个sentinel进行选举才能通过</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 多久连接不到主节点就认为它宕机了，这是主观宕机。这里默认是30秒，可改为5000</span></span><br><span class="line">sentinel failover-timeout mymaster 60000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 故障转移多久完成不了，就进行新的转移。这个时间不要太短。这里是3分钟</span></span><br><span class="line">sentinel parallel-syncs 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一次只给几个从节点同步。并行同步的数量</span></span><br><span class="line">sentinel auth-pass mymaster redisqwer1234</span><br><span class="line"><span class="meta">#</span><span class="bash"> 认证mymaster的主节点的密码，建议用随机字符串。如果不写此项就无法用sentinel slaves mymaster命令查看到从节点的信息</span></span><br><span class="line">sentinel config-epoch mymaster 0</span><br><span class="line">sentinel client-reconfig-script mymaster /opt/notify_mymaster.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 故障转移时执行notify_mymaster.sh脚本。加入这一行，sentinel的client-reconfig-script在每次执行时会传递出7个参数，第6个就是主redis的地址，所以脚本中定义了MASTER_IP=<span class="variable">$&#123;6&#125;</span></span></span><br><span class="line">logfile "/var/log/redis/sentinel.log"</span><br><span class="line">supervised systemd</span><br><span class="line">sentinel leader-epoch mymaster 0</span><br><span class="line">sentinel known-slave mymaster 192.168.1.13 6379</span><br><span class="line">sentinel known-slave mymaster 192.168.1.15 6379</span><br><span class="line">sentinel current-epoch 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面五行是启动sentinel后自动添加的</span></span><br><span class="line">[root@test ~]# scp /etc/redis-sentinel.conf 192.168.1.13:/etc</span><br><span class="line">[root@test ~]# scp /etc/redis-sentinel.conf 192.168.1.15:/etc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将配置文件复制到另两个节点</span></span><br><span class="line">[root@test ~]# systemctl start redis-sentinel</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从主节点启动三个节点的服务</span></span><br><span class="line">[root@test ~]# redis-cli -h 192.168.1.14 -p 26379</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在主节点连接</span></span><br><span class="line">192.168.1.14:26379&gt; SENTINEL master mymaster</span><br><span class="line"> 1) "name"</span><br><span class="line"> 2) "mymaster"</span><br><span class="line"> 3) "ip"</span><br><span class="line"> 4) "192.168.1.14"</span><br><span class="line"> 5) "port"</span><br><span class="line"> 6) "6379"</span><br><span class="line"> 7) "runid"</span><br><span class="line"> 8) "84336d6f7ef4fddbc8d21622fabfedd6e3354817"</span><br><span class="line"> 9) "flags"</span><br><span class="line">10) "master"</span><br><span class="line">11) "link-pending-commands"</span><br><span class="line">12) "0"</span><br><span class="line">13) "link-refcount"</span><br><span class="line">14) "1"</span><br><span class="line">15) "last-ping-sent"</span><br><span class="line">16) "0"</span><br><span class="line">17) "last-ok-ping-reply"</span><br><span class="line">18) "963"</span><br><span class="line">19) "last-ping-reply"</span><br><span class="line">20) "963"</span><br><span class="line">21) "down-after-milliseconds"</span><br><span class="line">22) "5000"</span><br><span class="line">23) "info-refresh"</span><br><span class="line">24) "3142"</span><br><span class="line">25) "role-reported"</span><br><span class="line">26) "master"</span><br><span class="line">27) "role-reported-time"</span><br><span class="line">28) "1177509"</span><br><span class="line">29) "config-epoch"</span><br><span class="line">30) "0"</span><br><span class="line">31) "num-slaves"</span><br><span class="line">32) "2"		# 可以看到从节点的数量</span><br><span class="line">33) "num-other-sentinels"</span><br><span class="line">34) "0"</span><br><span class="line">35) "quorum"</span><br><span class="line">36) "2"</span><br><span class="line">37) "failover-timeout"</span><br><span class="line">38) "60000"</span><br><span class="line">39) "parallel-syncs"</span><br><span class="line">40) "1"</span><br><span class="line">41) "client-reconfig-script"</span><br><span class="line">42) "/opt/notify_mymaster.sh"</span><br><span class="line">192.168.1.14:26379&gt; SENTINEL slaves mymaster</span><br><span class="line">1)  1) "name"</span><br><span class="line">    2) "192.168.1.13:6379"</span><br><span class="line">    3) "ip"</span><br><span class="line">    4) "192.168.1.13"</span><br><span class="line">    5) "port"</span><br><span class="line">    6) "6379"</span><br><span class="line">    7) "runid"</span><br><span class="line">    8) "80bc33312e088d2238d455269493e1cb22e78576"</span><br><span class="line">    9) "flags"</span><br><span class="line">   10) "slave"</span><br><span class="line">   11) "link-pending-commands"</span><br><span class="line">   12) "0"</span><br><span class="line">   13) "link-refcount"</span><br><span class="line">   14) "1"</span><br><span class="line">   15) "last-ping-sent"</span><br><span class="line">   16) "0"</span><br><span class="line">   17) "last-ok-ping-reply"</span><br><span class="line">   18) "6"</span><br><span class="line">   19) "last-ping-reply"</span><br><span class="line">   20) "6"</span><br><span class="line">   21) "down-after-milliseconds"</span><br><span class="line">   22) "5000"</span><br><span class="line">   23) "info-refresh"</span><br><span class="line">   24) "5510"</span><br><span class="line">   25) "role-reported"</span><br><span class="line">   26) "slave"</span><br><span class="line">   27) "role-reported-time"</span><br><span class="line">   28) "1260331"</span><br><span class="line">   29) "master-link-down-time"</span><br><span class="line">   30) "0"</span><br><span class="line">   31) "master-link-status"</span><br><span class="line">   32) "ok"			# 这里的状态应该显示OK</span><br><span class="line">   33) "master-host"</span><br><span class="line">   34) "192.168.1.14"</span><br><span class="line">   35) "master-port"</span><br><span class="line">   36) "6379"</span><br><span class="line">   37) "slave-priority"</span><br><span class="line">   38) "100"</span><br><span class="line">   39) "slave-repl-offset"</span><br><span class="line">   40) "311944"</span><br><span class="line">2)  1) "name"</span><br><span class="line">    2) "192.168.1.15:6379"</span><br><span class="line">    3) "ip"</span><br><span class="line">    4) "192.168.1.15"</span><br><span class="line">    5) "port"</span><br><span class="line">    6) "6379"</span><br><span class="line">    7) "runid"</span><br><span class="line">    8) "524e2a7f1c021b610272b7d5a71629617279238d"</span><br><span class="line">    9) "flags"</span><br><span class="line">   10) "slave"</span><br><span class="line">   11) "link-pending-commands"</span><br><span class="line">   12) "0"</span><br><span class="line">   13) "link-refcount"</span><br><span class="line">   14) "1"</span><br><span class="line">   15) "last-ping-sent"</span><br><span class="line">   16) "0"</span><br><span class="line">   17) "last-ok-ping-reply"</span><br><span class="line">   18) "6"</span><br><span class="line">   19) "last-ping-reply"</span><br><span class="line">   20) "6"</span><br><span class="line">   21) "down-after-milliseconds"</span><br><span class="line">   22) "5000"</span><br><span class="line">   23) "info-refresh"</span><br><span class="line">   24) "5663"</span><br><span class="line">   25) "role-reported"</span><br><span class="line">   26) "slave"</span><br><span class="line">   27) "role-reported-time"</span><br><span class="line">   28) "1260331"</span><br><span class="line">   29) "master-link-down-time"</span><br><span class="line">   30) "0"</span><br><span class="line">   31) "master-link-status"</span><br><span class="line">   32) "ok"		# 这里的状态应该显示OK</span><br><span class="line">   33) "master-host"</span><br><span class="line">   34) "192.168.1.14"</span><br><span class="line">   35) "master-port"</span><br><span class="line">   36) "6379"</span><br><span class="line">   37) "slave-priority"</span><br><span class="line">   38) "100"</span><br><span class="line">   39) "slave-repl-offset"</span><br><span class="line">   40) "311805"</span><br><span class="line">   [root@test ~]# ip addr add 192.168.1.111/24 dev ens33</span><br><span class="line"><span class="meta">   #</span><span class="bash"> 第一次启动需要手动配置VIP地址</span></span><br><span class="line">   [root@test opt]# redis-cli -p 26379</span><br><span class="line">   127.0.0.1:26379&gt; sentinel failover mymaster</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样可以切换主节点</span></span><br><span class="line">127.0.0.1:26379&gt; sentinel master mymaster</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以查看切换后的主节点</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 之后可以在切换到的主节点上执行sentinel failover mymaster命令，看一下切换的结果</span></span><br><span class="line">   </span><br><span class="line">=======================================================================================</span><br><span class="line">配置方法：</span><br><span class="line">1. 所有节点设置同样的requirepass和masterauth，最后要写入配置文件</span><br><span class="line">2. 配置redis可以设置IP地址的权限</span><br><span class="line">3. 配置监控脚本</span><br><span class="line">4. 设置sentinel脚本，将sentinel脚本复制到所有节点</span><br><span class="line">5. 按顺序启动主节点与从节点的sentinel服务</span><br><span class="line"></span><br><span class="line">排错方法：</span><br><span class="line">按配置方法设置好并启动后，在主节点的sentinel中看不到从节点的信息。可以查看各节点的/var/log/redis/sentinel.log、/var/log/redis/redis.log、/var/log/messages三个日志文件，停止三个节点的sentinel服务，按顺序从主节点启动sentinel日志，再查看日志文件中的报错。</span><br><span class="line">=======================================================================================</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/08/redis概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/08/redis概念/" itemprop="url">
                  redis概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-08 09:00:38 / 修改時間：09:34:13" itemprop="dateCreated datePublished" datetime="2019-01-08T09:00:38+08:00">2019-01-08</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h3><blockquote>
<ul>
<li>原子性（Atomic:）：要么整个事务成功，要么整个不成功。</li>
<li>一致性（Consistency）：数据库在事务之间处于一个一致的状态中。比方说，如果一条记录指向另一条记录，而到事务结束时这个指向是无效的，那么整个事务就必须回滚。</li>
<li>隔离性（Isolation）：在其他事务结束之前，事务看不到被它们更改的数据。</li>
<li>持久性（Durability）：一旦数据库系统通知用户事务成功，数据就永不丢失。</li>
</ul>
</blockquote>
<h3 id="BASE"><a href="#BASE" class="headerlink" title="BASE"></a>BASE</h3><blockquote>
<ul>
<li>基本可用（Basically Available）：用户都有一种愚蠢的期望，就是当他们把浏览器指向一个网页时，就会有某些信息出现。这是你期望发生的，即便系统的某些部分宕机了也一样。这听上去微不足道，事实却并非如此；有很多系统只要一台服务器宕了，整个系统就宕了。</li>
<li>可伸缩（Scalable）：添加更多的服务器使得服务更多的客户成为可能。不是创建一个巨大的怪物服务器，而是添加更多的服务器，这更具有前瞻性，而且也通常更便宜。重申一下，这是用户的期望之一：信息不仅仅是出现，而且还要快速地出现。（注意这项用户期望不仅要求伸缩性，还同时要求性能。）</li>
<li>最终一致（Eventually Consistent）：如果数据最终在所有副本出现的地方变为可用，这就足够了（如上一点所述，你可以有很多副本）。这里的期望是，信息要快速出现才会显得及时。 当你在Craigslist上发布一个广告，它不会马上出现在列表和搜索结果中，这不是太大的问题；但如果一个广告需要几天才出现，就没有人会去用那个网站了。</li>
</ul>
</blockquote>
<h3 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h3><blockquote>
<ul>
<li>C: Consistency 一致性：多个数据节点上的数据一致；</li>
<li>A: Availability 可用性(指的是快速获取数据)：用户发出请求后的有限时间范围内返回结果；</li>
<li>P: Tolerance of network Partition 分区容忍性(分布式)：网络发生分区后，服务是否依然可用；</li>
</ul>
</blockquote>
<blockquote>
<p>BASE一般与由大量服务器组成的系统有关。在一致性、可用性和分区宽容度这三者中，你只能选择两者而不能三者兼而有之。<strong>在任何时间点，不管哪台服务器应答了一个请求，所有服务器都会给出同样的答案。可用性的意思是即使某些服务器宕机了，整个系统仍能正常工作。最后，分区宽容度是指两台服务器之间的通信可以丢失，而系统仍能正常工作。</strong>虽然SQL数据库大多是兼容ACID的，但注重BASE的数据库更适合Web应用程序。</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/07/mysql客户端命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/07/mysql客户端命令/" itemprop="url">
                  mysql客户端命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-07 13:09:37 / 修改時間：13:19:10" itemprop="dateCreated datePublished" datetime="2019-01-07T13:09:37+08:00">2019-01-07</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">选项</span><br><span class="line">--user, -u	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户</span></span><br><span class="line">--host -h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 地址</span></span><br><span class="line">--password -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 密码</span></span><br><span class="line">--port</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口</span></span><br><span class="line">--protocol</span><br><span class="line">--database DATABASE, -D  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在连入數據庫時指定默認庫。如mysql -D mydb，在登入時指定了mydb為默認庫</span></span><br><span class="line">--compress </span><br><span class="line"><span class="meta">#</span><span class="bash"> 語句先壓縮再發送或返回</span></span><br><span class="line"></span><br><span class="line">例：用mysql导入sql文件</span><br><span class="line">1. vim test.sql</span><br><span class="line">    CREATE DATABASE testdb;</span><br><span class="line">    CREATE TABLE testdb.tb1(id INT, name CHAR(20));</span><br><span class="line">2. mysql -uroot -p</span><br><span class="line">3. mysql&gt;\. /root/test.sql      </span><br><span class="line"><span class="meta">#</span><span class="bash"> 用\.載入數據庫，用soucer也可加载脚本</span></span><br><span class="line">或</span><br><span class="line">4. mysql &lt; test.sql        </span><br><span class="line"><span class="meta">#</span><span class="bash"> 輸入重定向也能載入數據庫</span></span><br><span class="line">5. SHOW DATABASES；</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看载入的数据库</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -e選項：不進入服務器，傳命令到服務器</span></span><br><span class="line">mysql -e 'CREATE DATABASE edb;'</span><br><span class="line">mysql -e 'SHOW DATABASES;'</span><br><span class="line">mysql -e 'SELECT * FROM jiaowu.students;'</span><br><span class="line"></span><br><span class="line">例1：插入一張表，且mysql規定第一條數據必須手動插入，之後可寫腳本輸入數據，可將下面語句寫入腳本，用變量引用字段的值，寫一個死循環</span><br><span class="line">mysql -e “INSERT INTO jiaowu.students (Name,Age,Gender,CID1,CID2,TID,CreateTime) VALUES ('stu1',23,'F',4,1,6);”</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试这里一定要用双引号，单引号不行</span></span><br></pre></td></tr></table></figure>
<h3 id="mysqladmin"><a href="#mysqladmin" class="headerlink" title="mysqladmin"></a>mysqladmin</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">mysqladmin [options] command [arg] [command [arg]] …    </span><br><span class="line"><span class="meta">#</span><span class="bash"> [arg]是參數</span></span><br><span class="line"></span><br><span class="line">create：建庫。例：mysqladmin create hellodb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里不用指明用户名密码等信息，因为mysqladmin可以读取到在家目录创建的.my.cnf文件</span></span><br><span class="line">    </span><br><span class="line">debug</span><br><span class="line"></span><br><span class="line">drop DATABASES：刪庫</span><br><span class="line"></span><br><span class="line">ping：看數據庫是否在線。例：mysqladmin -uroot -p -h172.16.0.1 ping</span><br><span class="line"></span><br><span class="line">processlist：正在執行的線程列表顯示  例：mysqladmin processlist</span><br><span class="line"></span><br><span class="line">status：狀態</span><br><span class="line">例：</span><br><span class="line">mysqladmin status --sleep 2   			</span><br><span class="line"><span class="meta">#</span><span class="bash"> 兩秒顯示一次</span></span><br><span class="line">mysqladmin status --sleep 2 --count 2      </span><br><span class="line"><span class="meta">#</span><span class="bash"> 兩秒顯示一次共顯示兩次</span></span><br><span class="line"></span><br><span class="line">extended status：顯示mysql的狀態變量及其值，监控mysql服务器非常重要的手段</span><br><span class="line"></span><br><span class="line">variables：顯示服務器變量</span><br><span class="line"></span><br><span class="line">flush-privileges：讓mysqld重讀授權表</span><br><span class="line"></span><br><span class="line">flush-tables：關閉所有已打開的表</span><br><span class="line"></span><br><span class="line">flush-threads：重置線程緩存，清除线程池中的空闲线程</span><br><span class="line"></span><br><span class="line">flush-status：重置大多數的服務器狀態變量，慎用</span><br><span class="line"></span><br><span class="line">flush-logs：二進制和中繼日志滾動</span><br><span class="line"></span><br><span class="line">flush-hosts：清除主機的內部信息，包括緩存，及由於太多的登陸而拒絕的登陸</span><br><span class="line"></span><br><span class="line">flush-kill：杀死mysql的进程</span><br><span class="line"></span><br><span class="line">reload：讓mysqld重讀授權表</span><br><span class="line"></span><br><span class="line">refresh：相當於同時執行flush-hosts和flush-logs</span><br><span class="line"></span><br><span class="line">shutdown：停止mysql服務器；用start可以启动</span><br><span class="line"></span><br><span class="line">version：版本號與相關狀態信息顯示</span><br><span class="line"></span><br><span class="line">start-slave：啟動復制，啟動從服務器復制線程，一般是启动兩個进程，SQL thread, IO thread</span><br><span class="line"></span><br><span class="line">stop-slave：關閉復制線程</span><br></pre></td></tr></table></figure>
<h3 id="mysqlbinlog"><a href="#mysqlbinlog" class="headerlink" title="mysqlbinlog"></a>mysqlbinlog</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">选项</span><br><span class="line">--start-datetime</span><br><span class="line">--stop-datetime</span><br><span class="line">--start-position</span><br><span class="line">--stop-position</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果不用選項會顯示全部內容</span></span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">mysqlbinlog mysql-bin.000005   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看內容中有文件頭的內容，這是無論如何都會顯示的</span></span><br><span class="line"></span><br><span class="line">mysqlbinlog --start-position=177 --stop-position=358 mysql-bin.000005 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看位置從177到358</span></span><br><span class="line"></span><br><span class="line">mysqlbinlog --start-datetime=’130425 15:14:39’ mysql-bin.000005     </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看某時開始的，沒有指定結束時間會顯示到文件尾部為止</span></span><br><span class="line"></span><br><span class="line">mysqlbinlog --start-datetime=’130425 15:14:39’ mysql-bin.000005 &gt; /root/a.sql    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 將結果重定向到一個.sql文件中，之後可導入mysql執行一次，這就是即時點恢復</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 二進制日志的輪動除重啟服務器外還可以用FLUSH LOGS;来實現，這是在主服務器上，如果是從服務器就是中繼服務器才滾動</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 二進制日志文件不能手動刪除，會影響mysql服務器啟動。要用mysql命令</span></span><br><span class="line"></span><br><span class="line">PURGE BINARY LOGS TO ‘mysql-bin.000003’;      </span><br><span class="line"><span class="meta">#</span><span class="bash"> 刪除000003以前的二進制文件</span></span><br><span class="line"></span><br><span class="line">SHOW BINARY LOGS;       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看現有的所有二進制文件</span></span><br><span class="line">binlog_format            </span><br><span class="line"><span class="meta">#</span><span class="bash"> 二進制日制的格式，MIXED是混合模式</span></span><br><span class="line">log_bin         </span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否記錄二進制日志</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/07/mysql概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/07/mysql概念/" itemprop="url">
                  mysql概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-07 11:08:59 / 修改時間：12:35:30" itemprop="dateCreated datePublished" datetime="2019-01-07T11:08:59+08:00">2019-01-07</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="约束-constraint"><a href="#约束-constraint" class="headerlink" title="约束 constraint"></a>约束 constraint</h3><blockquote>
<ul>
<li>約束：明確有效數據範圍；定義數據時要有約束</li>
<li>域約束：數據類型約束</li>
<li>外鍵約束：引用完整性約束；是降低數據冗餘的手段；一個表中填的值一定要保證在另外一個表中有相同的值才允許使用。級連表示如果這張表被其他表依賴，如果刪除了這張表，被依賴的表也會被刪。一般不用。與外鍵約束有關。</li>
<li>主鍵約束：某字段能惟一標識此字段所屬的實體，並且不允許為空，不能有相同值。可當主鍵的鍵叫候選鍵。一個表只能有一個主鍵</li>
<li>唯一性約束：每一行的某字段都不允許出現相同值，可以為空，一張表可以有多個唯一鍵。</li>
<li>檢查性約束：age:int定義符合現實的邏輯。</li>
</ul>
</blockquote>
<h3 id="mysql的rpm包"><a href="#mysql的rpm包" class="headerlink" title="mysql的rpm包"></a>mysql的rpm包</h3><blockquote>
<ul>
<li>mysql-client ：提供客戶端及組件</li>
<li>mysql-debuginfo：可幫助調試mysql，一般開發人員用</li>
<li>my-devel：開發組件，開發用的頭文件與庫文件</li>
<li>mysql-embedded：嵌入式服務專用</li>
<li>mysql-ndb-management ：Cluster server上專用的組件，平常不用</li>
<li>mysql-server</li>
<li>mysql-shared：共享庫</li>
<li>mysql-shared-compat：為老版本的兼容庫，是shared的補充</li>
<li>mysql-test：測試用組件</li>
<li>mysql-version.platform.src.rpm：源碼格式的rpm包</li>
</ul>
</blockquote>
<h3 id="安裝後的目錄結構"><a href="#安裝後的目錄結構" class="headerlink" title="安裝後的目錄結構"></a>安裝後的目錄結構</h3><blockquote>
<ul>
<li>bin：二進制程序，命令</li>
<li>data：數據目錄</li>
<li>include：頭文件</li>
<li>lib：庫文件</li>
<li>man：手冊</li>
<li>mysql-test：測試組件</li>
<li>scripts：初始化腳本</li>
<li>share：語言版本</li>
<li>sql-bench：基准測試</li>
<li>support-files：腳本、樣例、等</li>
</ul>
</blockquote>
<h3 id="linux-mysql啟動時查找的配置文件"><a href="#linux-mysql啟動時查找的配置文件" class="headerlink" title="linux mysql啟動時查找的配置文件"></a>linux mysql啟動時查找的配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">每次啓動，mysql都要讀取下面文件</span><br><span class="line"></span><br><span class="line">1. /etc/my.cnf</span><br><span class="line"></span><br><span class="line">2. /etc/mysql/my.cnf</span><br><span class="line"></span><br><span class="line">3. $MYSQL_HOME/my.cnf</span><br><span class="line"><span class="meta">#</span><span class="bash"> mysql實例運行下my.cnf。一個數據庫服務器上可以提供多個web服務主機，mysql也可以提供多個不同的mysql服務器，只要它們監聽在不同的端口上就行，因爲不支持基於名稱的，所以要監聽在不同端口上，每個監聽在不同端口上的mysql服務稱爲一個mysql實例，每個實例都有自己的運行目錄，就叫MYSQL_HOME，所以每個實例都可以到自己的家目錄下找my.cnf；</span></span><br><span class="line"></span><br><span class="line">4. /path/to/fiel when defaults-extra-file=/path/to/file is specified    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在啓動mysql服務器時可以給它傳遞一個參數，叫--defaults-extra-file</span></span><br><span class="line"></span><br><span class="line">5. ~/.my.conf</span><br><span class="line"></span><br><span class="line">/etc/my.cnf --&gt; /etc/mysql/my.cnf --&gt; $MYSQL_HOME/my.cnf --&gt; --default-extra-file=/path/to/somefile --&gt; ~/.my.cnf</span><br><span class="line"></span><br><span class="line">配置文件中大多數的參數都可以命令行直接指定的也就是在啓動mysql時，在命令行可指定的參數也基本都可寫在配置文件中，寫在配置文件中時就不要加-了。如-host，在配置文件中直接寫host = ××× 就可以了。再如default-extra-file也可寫爲default_extra_file，這兩種格式都對，但建議寫爲統一格式，要寫在對應的段[×××]下。</span><br></pre></td></tr></table></figure>
<h3 id="windows-mysql啟動時查找的配置文件"><a href="#windows-mysql啟動時查找的配置文件" class="headerlink" title="windows mysql啟動時查找的配置文件"></a>windows mysql啟動時查找的配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. %WINDIR%\my.ini, %WINDIR%\my.cnf</span><br><span class="line">2. C:\my.ini, C:\my.cnf</span><br><span class="line">3. %INSTALLDIR%\my.ini, %INSTALLDIR%\my.cnf</span><br><span class="line">4. /path/to/file when defaults-extra-file=/path/to/file is specified</span><br></pre></td></tr></table></figure>
<h3 id="請求過程"><a href="#請求過程" class="headerlink" title="請求過程"></a>請求過程</h3><blockquote>
<p>當用戶需要連到數據庫上來完成某種操作時，由連接器負責接收用戶請求，並將請求轉發給線程管理器，線程管理器給它創建一個線程，線程管理器將線程權限轉給用戶模塊，用戶模塊來驗證用戶是否有訪問權限，如果沒有就終止，有就建立連接。之後用戶發起命令，由命令分發模块來完成用戶請求內容是否從緩存中直接返回，是否記錄日志，如果緩存中沒有的話， 可能就要將命令語句轉給解析器分析生成執行树，並交由底層的對應模塊處理，如果是SELECT語句就交給優化器，來生成更優的執行過程，如果用戶發起與數據定義相關的命令都要交給表定義模塊，如INSERT,DELECT等，如果用戶要維護一張表，就交給表維護模塊來完成，用戶每發起一次命令語句，狀態信息都要更新，最終，不論用戶是哪種請求都要判斷用戶是否有對應的訪問權限，這由訪問控制模塊來完成，如果有，就由表管理器負責後續的動作，如讀取表結構、修改表結構、施加表鎖，最終由存儲引擎來負責到對應文件中去找對應的數據。存儲引擎是真正與磁盤打交道的接口。這就是mysql的微觀結構</p>
</blockquote>
<h3 id="mysql基礎架構"><a href="#mysql基礎架構" class="headerlink" title="mysql基礎架構"></a>mysql基礎架構</h3><blockquote>
<p>面對用戶的一端是連接管理器，接收請求並建立連接後的下一層是查詢緩存和分析器，如果查詢緩存中有結果就直接返回給用戶，查詢緩存只與讀操作有關，與寫無關，且只與讀操作的查詢操作有關，如果緩存中沒有結果，就由分析器來分析，分析的結果如果發現緩存中有結果還會從緩存中返回結果，如果沒有結果就交給優化器完成優化，而後就交給存儲引擎，或交給執行引擎再交給存儲引擎完成操作。這就是mysql的基礎架構。連接管理器就是監聽在某個套接字上接收用戶請求，接收後創建一個線程予以響應，因為創建線程很消耗資源，也為了加速線程的創建，所以有了重用線程的概念，用戶退出後線程不被銷毀，而是放到空閒線程池中，有新的用戶請求時直接從空閒線程中拿一個給用戶響應，創建連接後會驗證用戶的連入權限，連入的所有用戶的操作都在它自身的線程地址空間內完成，因CPU有限，每個用戶發起的操作都在CPU上輪流進行，如果有一個非常慢的話會使其他用戶請求非常慢。在遠程連接mysql服務器時數據通過tcp/ip協議傳輸，是明文的，如果是機密的數據，會話管理器（連接管理器）還要進行加密</p>
<p>當我們發起查詢請求後mysql服務器會負責解析每一個查詢，並在mysql進程內部創建一個解析樹，它會去解析每一個請求，並為這個請求創建一個解析樹，解析執行過程並優化，最後計算出最優執行路徑，這就是解析器和優化器的作用。優化器的優化是自我判定的，與實際場景可能有出入，所以結果未必是最佳的。作為用戶可以給優化器提示，在執行語句中，這就避免優化器再去查找。優化器在優化中不會考慮存儲引擎的不同，每一個查詢執行結束之後，如果結果是決定性的，mysql會將結果緩存下來，但視查詢結果大小，不是所有結果都可以緩存的，一定是小於某個上限的才緩存。</p>
<p>緩存（一段內存空間）中的內容被分成了三個區域，每個區域中有一個叫作緩存槽的東西，每個查詢結果都會佔用這個槽的，為了便於管理，槽是有下限的，因為每個結果都要佔用一個槽，如果結詢結果比槽小的多，還要進行緩存，這會浪費槽，如果不浪費，自動去減小緩存空間，也會使緩存中產生大量的碎片，這也會影響執行效率。為了發揮緩存的效能提高效率，對緩存要進行優化，要有限定。非確定性結果，每次結果都不同，如查看時間（SELECT CURRENT_TIME()）一般不緩存。兩個語句一樣也不一定就能緩存，比如兩個查詢的用戶權限不同，有一方沒有查詢權限，就不能緩存。沒有緩存就由解析樹處理，如果有緩存就要查在緩存中是否命中，這會使每條語句都去找一次緩存，成了額外開銷，如此要計算益處與開銷的平衡</p>
<p>讀寫操作同時請求同一張表，任何時候（不只mysql）有兩個用戶同時讀寫同一個文件的數據時都會有並發控制的問題</p>
<p>並發控制是為了提高性能，可以使兩個並發的操作不會互相影響。不能使用串行的方法，一個用戶操作完下個用戶再操作的機制。很多服務器都引入了多版本並發控制的機制，叫作MVCC，每個用戶操作的都是一個數據的副本或快照，最後再完成快照合並，快照會有一個時間值，用來判定快照的先後。時間快照是數據庫必備的功能，要實現時間並發控制就要有鎖功能，多版本並發控制是用其他功能實現的</p>
<p>客戶端命令：mysql、mysqladmin、mysqldump、mysqllimport、mysqlcheck</p>
<p>服務器：mysqld、mysqld_safe、mysqld_multi（不同端口的mysql3306、3307、3308運行在一臺服務器上，相當於多臺服務器）</p>
</blockquote>
<h3 id="數據如何存儲到磁盤"><a href="#數據如何存儲到磁盤" class="headerlink" title="數據如何存儲到磁盤"></a>數據如何存儲到磁盤</h3><blockquote>
<p>磁盤按塊加載數據到內存，如果數據只佔了塊的一部分，也要加載整個塊。多個磁盤塊可組成一個數據塊。由存儲引擎管理。一般使用定長表結構，而不用變長，這樣可以使存取速度加快。因爲塊中的行會被刪除，就空出了空間，所以要做碎片整理，碎片會使裝載速度變慢，爲了管理這樣的數據，每個塊要有塊頭，塊頭裏要有行的信息，有多少空閒行等。這個塊不一定都是磁盤塊，可能是多個磁盤塊組成的數據塊，數據塊由存儲引擎來管理，只用磁盤塊也可以。定長的表的執行速度更快。</p>
</blockquote>
<h3 id="文件中記錄組織"><a href="#文件中記錄組織" class="headerlink" title="文件中記錄組織"></a>文件中記錄組織</h3><blockquote>
<ul>
<li>堆文件組織：一條記錄可以放在文件中的任何地方，維護簡便，管理不便</li>
<li>順序文件組織：根據“搜索碼”的值順序存放</li>
<li>散列文件組織：分成N個塊，叫桶，將某行的不同列進行hash運算，結果相同的放在一起。hash<strong>索引</strong></li>
</ul>
</blockquote>
<h3 id="程序語言連接數據的方式有兩種"><a href="#程序語言連接數據的方式有兩種" class="headerlink" title="程序語言連接數據的方式有兩種"></a>程序語言連接數據的方式有兩種</h3><blockquote>
<ul>
<li>動態SQL：通過函數或方法與數據庫服務建立連接，然後通過協議將查詢語句直接送到服務器端；簡單的方式屬於動態SQL</li>
<li>嵌入式SQL：用程序開發語言的格式寫的，通過API直接連到服務器上，連接之前要先編譯</li>
</ul>
</blockquote>
<h3 id="语句中的错误提示"><a href="#语句中的错误提示" class="headerlink" title="语句中的错误提示"></a>语句中的错误提示</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span><span class="bash">：语句未结束，继续輸入</span></span><br><span class="line">'&gt;：缺單引號的後一半</span><br><span class="line">"&gt;：缺雙引號的後一半</span><br><span class="line">`&gt;：缺反引號的後一半</span><br><span class="line">/*&gt;：缺多行注釋的後一半</span><br></pre></td></tr></table></figure>
<h3 id="補全"><a href="#補全" class="headerlink" title="補全"></a>補全</h3><blockquote>
<p>要把數據庫中的表都載入內存中才能補全</p>
<p>名稱補全：mysql連接時用-A或–no-auto-rehash或–disable-auto-rehash來禁用補全功能；默認是有此功能的，或在mysql中用rehash或#命令就可以名稱補全了，但是是對新建命令的補全。</p>
</blockquote>
<h3 id="mysql不能啟動問題的原因"><a href="#mysql不能啟動問題的原因" class="headerlink" title="mysql不能啟動問題的原因"></a>mysql不能啟動問題的原因</h3><blockquote>
<p>啟動時會在datadir =/mydata/data 指定的路徑下生成一個hostname.err的錯誤日志，mysql啟動後的錯誤信息都在此日志中，如果啟動錯誤還沒有錯誤日志，應該就是數據目錄指錯了。修改配置文件定義datadir =即可。测试中因为用的是mariadb，没有在目录中找到hostname.err日志，只有/var/log中的mariadb的日志，且只有一个mariadb.log</p>
<ol>
<li>此前的服務未關閉套接字被佔用，用killall mysqld就可以了</li>
<li>數據初始化失敗</li>
<li>數據目錄位置錯誤</li>
<li>數據目錄權限問題</li>
</ol>
<p>如果解決不了可重新初始化數據庫試一下</p>
</blockquote>
<h3 id="數據類型"><a href="#數據類型" class="headerlink" title="數據類型"></a>數據類型</h3><blockquote>
<ul>
<li><p>數值型，不需要指定長度</p>
<ul>
<li><p>精確數值</p>
<ul>
<li><p>int：整型（TINYINT微整型1字節、SMALLINT小整型2、MEDIUMINT中整型3、INT整型4、BIGINT大整型8）</p>
</li>
<li><p>DECIMAL：精確定點數</p>
</li>
</ul>
</li>
<li><p>近似數值</p>
<ul>
<li>FLOAT：單精度浮點型4</li>
<li>DOUBLE：雙精度浮點型8</li>
<li>real：實數</li>
<li>NUMERIC：定點數值</li>
<li>DECIMAL：定點數值</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>// 數值後加數字表示顯示幾位數字</p>
<ul>
<li><p>字符型，一定要指定長度</p>
<ul>
<li><p>定長：CHAR(#)（不區分大小寫），BINARY（區分）</p>
</li>
<li><p>變長:VARCHAR(#)（不區分大小寫），VARBINARY（區分）</p>
</li>
<li><p>text（不區分大小寫）</p>
</li>
<li><p>BLOB：二進制大對象（區分）</p>
</li>
<li><p>ENUM：枚舉（在給定的選項中選）</p>
</li>
<li><p>SET：集合（1-64個字符串，一組數值的組合值）</p>
</li>
</ul>
</li>
</ul>
<p>// CHAR最多存儲255個字符，VARCHAR最多存儲65535個字符，每個VARCHAR存儲時會多佔一個字節，因為要有一個結束符，VARCHAR在255個字符內只需要一個結束符，超出255就需要兩個結束符。text上不能索引整個字段，CHAR上可以</p>
<ul>
<li><p>字符串修飾屬性</p>
<ul>
<li>NOT NULL：不能為空   </li>
<li>NULL：可為空（默認）</li>
<li>DEFAULT：給一個默認值</li>
<li>CHARACTER SET：字符集</li>
<li>COLLATION：排序規則</li>
</ul>
</li>
<li><p>二進制大對象，區分大小寫，因爲按字節排序</p>
<ul>
<li>TINYBLOB                255</li>
<li>MEDIUMBLOB            16M</li>
<li>LONGBLOB                4G</li>
<li>BLOB                      64K</li>
<li>BINARY                        255</li>
<li>VARBINARY                65535</li>
</ul>
</li>
</ul>
<p>// 大對象存儲在一個單獨的位置，表上只是一個指針，故無法在表上建索引</p>
<ul>
<li><p>日期時間型</p>
<ul>
<li>date：日期</li>
<li>time：時間</li>
<li>datetime：日期時間</li>
<li>timestamp：時間戳</li>
<li>YEAR：年</li>
</ul>
</li>
<li><p>數據類型的作用</p>
<ol>
<li>存入值的類型；</li>
<li>使用空間大小；</li>
<li>定長還是變長的；</li>
<li>mysql如何對其進行比較和排序；</li>
<li>是否可以創建索引</li>
</ol>
</li>
</ul>
<p>// 域屬性修飾符就是定義域限制的</p>
<ul>
<li>只要在一個域上定義了數據類型，它能作出以下限定<ol>
<li>它能表示哪個种類的數據</li>
<li>定義最大最小值，定義空間</li>
<li>確定是變長還是定長的</li>
<li>mysql如何比較排序字符，是否区分大小寫</li>
<li>這樣的類型是否能夠創建索引，是否能夠索引</li>
</ol>
</li>
</ul>
</blockquote>
<h3 id="查看表结构文件"><a href="#查看表结构文件" class="headerlink" title="查看表结构文件"></a>查看表结构文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ls /var/lib/mysql  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看mysql的datadir目录，这里的目录就是数据库中的表，如mysql,<span class="built_in">test</span>等，在目录内有表结构文件</span></span><br><span class="line"></span><br><span class="line">對myISAM引擎來說每表三個文件，MyISAM表是無事務，支持表鎖</span><br><span class="line">1.  .frm: 表結構定義文件</span><br><span class="line">2.  .MYD：表數據文件</span><br><span class="line">3. .MYI：表索引文件</span><br><span class="line"></span><br><span class="line">對InnoDB引擎來說，支持事務，行鎖；要打開每表一個單獨的表空間。每表一個表空間會創建下面兩個文件。所有表共享一個表空間文件；建議：每表一個獨立的表空間文件</span><br><span class="line">1. .frm: 表結構文件</span><br><span class="line">2. .ibd：表空間（同时存储表數據和表索引）</span><br><span class="line"><span class="meta">#</span><span class="bash"> 建議打開innodb_file_per_table一項為ON，實現每表一個獨立表空間，在mysql中用SHOW GLOBAL VARIABLES LIKE <span class="string">'%innodb%'</span>;命令查看全局变量中与innodb相关的項，其中的innodb_file_per_table应该是ON。5.6中默認已打開了此項，不然可以在my.cnf中加入innodb_file_per_table = ON或1一行即可打開。</span></span><br><span class="line"></span><br><span class="line">db.opt標記當前庫的字符集和排序規則的定义，也就是数据库的默认选项</span><br></pre></td></tr></table></figure>
<h3 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">SHOW ENGINES;         </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看存儲引擎</span></span><br><span class="line"></span><br><span class="line">MyISAM</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不支持事務，默認只支持表鎖，讀性能更好，寫性能差，不支持外鍵，支持B樹索引、FULLTEXT索引、空間索引、支持表壓縮；.frm（表格式）  .MYD（數據文件）  .MYI（索引文件）</span></span><br><span class="line"></span><br><span class="line">InnoDB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 支持事務，支持行級鎖、支持B樹索引、聚簇索引、自適應<span class="built_in">hash</span>索引，使用表空間、raw磁盤設備； .frm（表格式）  .ibd（表空間）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 將innodb_file_per_table改成ON就會為每表創建一個表空間了</span></span><br><span class="line"></span><br><span class="line">MRG_MYISAM:</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可將兩個表合成一張表，也就是建一個兩張表合在一起的存儲引擎</span></span><br><span class="line"></span><br><span class="line">CSV</span><br><span class="line"><span class="meta">#</span><span class="bash"> 方便移植，一般不用</span></span><br><span class="line"></span><br><span class="line">ARCHIVE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用來實現歸檔的</span></span><br><span class="line"></span><br><span class="line">MEMORY</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在內存中建立存儲引擎</span></span><br><span class="line"></span><br><span class="line">BLACKHOLE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 黑洞</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可用第三方存儲引擎，不建議混合使用存儲引擎</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/06/mysql锁与事物/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/06/mysql锁与事物/" itemprop="url">
                  mysql锁与事物
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-06 21:12:19" itemprop="dateCreated datePublished" datetime="2019-01-06T21:12:19+08:00">2019-01-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-07 01:13:15" itemprop="dateModified" datetime="2019-01-07T01:13:15+08:00">2019-01-07</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><blockquote>
<p>mysql一般會自動加鎖；最簡單的並發控制機制就是加鎖。鎖粒度從大到小，mysql僅支持表級鎖，行鎖需要由存儲引擎完成，一般不用在服務器上加鎖</p>
<ul>
<li><p>讀鎖：同一個文件可以被多個用戶讀取。這是共享鎖</p>
</li>
<li><p>寫鎖：獨佔鎖，可以多人讀，但不允許寫；一個文件在寫時，不允許其他人讀與寫</p>
</li>
<li><p>表鎖：鎖定一張表</p>
</li>
<li><p>頁鎖：鎖定數據塊的，一個塊內有多行</p>
</li>
<li><p>行鎖：</p>
</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [mysql]&gt; use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; LOCK TABLES tutors read;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给tutors表施加读锁</span></span><br><span class="line">* 再打开一个终端</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname,Gender,Age) VALUES ('jerry','M',50);</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时控制台会停住，因为表有读锁。如果換一臺主機连接数据库，插入数据会提示<span class="string">"Table 'tutors' was locked with a READ lock and can't be updated"</span></span></span><br><span class="line">* 回到加锁的终端</span><br><span class="line">MariaDB [jiaowu]&gt; UNLOCK tables;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 去除锁。这时会马上插入数据</span></span><br></pre></td></tr></table></figure>
<h3 id="事物"><a href="#事物" class="headerlink" title="事物"></a>事物</h3><blockquote>
<p>事務指多項操作要作爲一個處理單元來進行對待。它們要麼同時執行，要麼同時不執行。這需要大量CPU與IO操作。能啓動事務的是sql語句或ODBC中的一堆指令。多事務同時執行，彼此之間以互不影響的方式進行並發，事務之間交互，通過數據集。</p>
<p>如果一個存儲引擎是滿足事務的，要滿足ACID的測試</p>
<p>RDBMS：要滿足四種ACID測試，叫ACID(原子發Automicity、一致性Consistency、隔離性Isolation、持久性Durability)</p>
<p>MYISAM不支持事務，INNODB支持</p>
<ul>
<li><p>Automicity原子性：事務所引起的數據庫操作，要麼都完成，要麼都不執行</p>
</li>
<li><p>Consistency一致性：當事務執行完成後總和是一致的，如銀行轉帳，這與隔離性有關，要在隔離中執行</p>
</li>
<li><p>Isolation隔離性：通過事務調度來實現，彼此之間以互不影響的方式進行並發，或事務之間影響降到最小</p>
</li>
<li><p>Durability持久性：一旦事務成功完成，不能再發生變化，系統必須保證任何故障都不會引起事務表現出不一致性</p>
</li>
</ul>
<ol>
<li><p>事務提交之前就已經寫出數據至持久性存儲</p>
</li>
<li><p>結合事務日志完成，事務日志產生的是順序IO，數據文件是隨機IO</p>
</li>
</ol>
<ul>
<li><p>事務的狀態</p>
<ul>
<li><p>活動的：active</p>
</li>
<li><p>部分提交的：最後一條語句執行後</p>
</li>
<li><p>失敗的：提交未完成</p>
</li>
<li><p>中止的：沒提交</p>
</li>
<li><p>提交的：完成的</p>
</li>
</ul>
</li>
</ul>
<p>事務提交就無法撤銷。狀態的轉換是一個事務從活動狀態到部分提交狀態或失敗狀態，部分提交到提交狀態，如果是未完成就到失敗狀態，失敗再到终止</p>
<ul>
<li><p>活动 –&gt; 部分提交 –&gt; 提交</p>
</li>
<li><p>活动 –&gt; 部分提交 –&gt; 失败 –&gt; 终止</p>
</li>
<li><p>活动 –&gt; 失败 –&gt; 终止</p>
</li>
</ul>
<p>事務：並發執行</p>
<ul>
<li><p>提高吞吐量和資源利用率</p>
</li>
<li><p>減少等待時間</p>
</li>
</ul>
<p>事務調度</p>
<ul>
<li><p>可恢復調度</p>
</li>
<li><p>無級聯調度</p>
</li>
</ul>
<p>並發控制依賴的技術手段</p>
<ul>
<li>鎖</li>
<li>時間戳：記錄每個事務的啓動時間，執行時間</li>
<li>多版本和快照隔離</li>
</ul>
<h4 id="事務日志"><a href="#事務日志" class="headerlink" title="事務日志"></a>事務日志</h4><p>事務日志，對mysql很重要，mysql每一次操作都先在日志操作中完成，過一段時間才寫到磁般文件中。mysql中支持事務的引擎每次操作都是先在日志中完成，也就是增刪查改功能要先在內存中完成，完成後會立即寫到日志中去，過一段時間才寫到磁盤空間中去或叫磁盤文件中去，是將事務日志的查詢再在文件上走一遍，所以在事務引擎上的寫操作幾乎每次都要執行兩遍，日志中一次，數據文件中一次，寫在日志中非常快，因爲日志中記錄的只是操作，而不是操作數據本身，日志中記錄的是操作過程，所以操作過程可以在數據上重新執行一遍，所以叫redo。事務提交了就是完成了。服務器啓動時要讀日志，將未同步但已提交的事務同步到數據文件中去。這就是修復過程。如果在崩潰時還沒有提交事務，那麼此事務中的前幾條操作要撤消。日志文件通常不要太大，事務越小越好。日志文件不能只有一個，有兩個，第一個寫滿寫每二個，寫第二個時將第一個提交，這兩個文件組成了日志組。磁盤壞了，爲了保證事務不丟失，不可將事務日志與磁盤放在一起。這些日志就是爲了提供ACID功能的兼容性的。在mysql中叫事務日志，它自我能完成重做、撤消與自我修復</p>
<p>事務日志：</p>
<ul>
<li><p>重做日志redo log：每一個操作在真正寫到數據庫之前，它先被寫到日志裏，下一次這個操作就算崩潰了，它可以根據重做日志再走一遍；這意味着我們的一系列操作可以無限次地根據這個日志重復地執行N遍</p>
</li>
<li><p>撤消日志 undo log：我們的每一次操作在操作以前，要把它的原有狀態保留下來。萬一要還原原來狀態時，可以撤消此次所做的任何一次操作</p>
</li>
</ul>
<h4 id="隔離級別"><a href="#隔離級別" class="headerlink" title="隔離級別"></a>隔離級別</h4><ul>
<li><p>READ-UNCOMMITTED ：讀未提交，隔離級別最低；別人的操作馬上能看到，幹擾最大</p>
</li>
<li><p>READ-COMMITTED ：讀提交；別人提交後才能看到。也有問題</p>
</li>
<li><p>REPATABLE-READ ：可重讀，無論是否提交看到的都是一樣的，直到提交。會產生幻讀              </p>
</li>
<li><p>SERIALIZABLE ：可串行。可解決幻讀。</p>
<p>隔離級別越高並發能力越差。mysql默認是可重讀，可適當降低mysql隔離級別，這會提高mysql性能，如果對並發能力要求不高的情況下，用SHOW GLOBAL VARIABLES LIKE ‘%iso%’可查看隔離級別。</p>
</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [jiaowu]&gt; START TRANSACTION;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 啟動事務</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line">|   2 | HuangYaoshi  | M      |   63 |</span><br><span class="line">|   3 | Miejueshitai | F      |   72 |</span><br><span class="line">|   4 | OuYangfeng   | M      |   76 |</span><br><span class="line">|   5 | YiDeng       | M      |   90 |</span><br><span class="line">|   6 | YuCanghai    | M      |   56 |</span><br><span class="line">|   7 | Jinlunfawang | M      |   67 |</span><br><span class="line">|   8 | HuYidao      | M      |   42 |</span><br><span class="line">|   9 | NingZhongze  | F      |   49 |</span><br><span class="line">|  10 | jerry        | M      |   50 |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">MariaDB [jiaowu]&gt; DELETE FROM tutors WHERE Tname LIKE 'Hu%'; </span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 刪除以Hu開頭的兩行</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line">|   3 | Miejueshitai | F      |   72 |</span><br><span class="line">|   4 | OuYangfeng   | M      |   76 |</span><br><span class="line">|   5 | YiDeng       | M      |   90 |</span><br><span class="line">|   6 | YuCanghai    | M      |   56 |</span><br><span class="line">|   7 | Jinlunfawang | M      |   67 |</span><br><span class="line">|   9 | NingZhongze  | F      |   49 |</span><br><span class="line">|  10 | jerry        | M      |   50 |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">MariaDB [jiaowu]&gt; ROLLBACK;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 事務回滾</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line">|   2 | HuangYaoshi  | M      |   63 |</span><br><span class="line">|   3 | Miejueshitai | F      |   72 |</span><br><span class="line">|   4 | OuYangfeng   | M      |   76 |</span><br><span class="line">|   5 | YiDeng       | M      |   90 |</span><br><span class="line">|   6 | YuCanghai    | M      |   56 |</span><br><span class="line">|   7 | Jinlunfawang | M      |   67 |</span><br><span class="line">|   8 | HuYidao      | M      |   42 |</span><br><span class="line">|   9 | NingZhongze  | F      |   49 |</span><br><span class="line">|  10 | jerry        | M      |   50 |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 被刪除的行被恢復</span></span><br><span class="line">MariaDB [jiaowu]&gt; DELETE FROM tutors WHERE Tname LIKE 'Hu%';</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次删除两行</span></span><br><span class="line">MariaDB [jiaowu]&gt; COMMIT;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交事務，這樣就不能恢復了</span></span><br><span class="line">MariaDB [jiaowu]&gt; ROLLBACK;</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line">|   3 | Miejueshitai | F      |   72 |</span><br><span class="line">|   4 | OuYangfeng   | M      |   76 |</span><br><span class="line">|   5 | YiDeng       | M      |   90 |</span><br><span class="line">|   6 | YuCanghai    | M      |   56 |</span><br><span class="line">|   7 | Jinlunfawang | M      |   67 |</span><br><span class="line">|   9 | NingZhongze  | F      |   49 |</span><br><span class="line">|  10 | jerry        | M      |   50 |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交后，再回滚也不能恢复了</span></span><br><span class="line">MariaDB [jiaowu]&gt; SHOW VARIABLES LIKE 'autocommit';</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| autocommit    | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> autocommit函數是自動提交，如果沒有明確啟動事務，默認每一個操作是autocommit自動提交的，但這會產生大量磁盤IO。建議明確使用事務，並且關閉自動提交，這是優化服務器的一種策略。用命令SET @@autocommit=0關閉.切記，先啟動事務，最後要提交。测试中autocommit默认</span></span><br><span class="line">=======================================================================================</span><br><span class="line">全局變量：與用戶無關，服務器啟動就生效了，有管理權限的用戶才能修改。對當前會話無效，只對新建立會話有效。查看方法：SHOW GLOBAL VARIABLES [LIKE 'VALUE']，修改方法：SET GLOBAL @@VARIABLES ='VALUE'</span><br><span class="line">會話變量：客戶端連接服務器時可以顯示的變量，對當前會話立即生效，會話終止變量失效。查看方法：SHOW [SESSION] VARIABLES [LIKE 'VALUE']，修改方法：SET  @@[SESSION.]VARIABLES ='VALUE'</span><br><span class="line">=======================================================================================</span><br><span class="line">MariaDB [jiaowu]&gt; SET @@autocommit=0;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭会话变量的自动提交</span></span><br><span class="line">MariaDB [jiaowu]&gt; SHOW VARIABLES LIKE 'autocommit';       </span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| autocommit    | OFF   |</span><br><span class="line">+---------------+-------+</span><br><span class="line">MariaDB [jiaowu]&gt; DELETE FROM tutors WHERE Age=90;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除年龄为90的人</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line">|   3 | Miejueshitai | F      |   72 |</span><br><span class="line">|   4 | OuYangfeng   | M      |   76 |</span><br><span class="line">|   6 | YuCanghai    | M      |   56 |</span><br><span class="line">|   7 | Jinlunfawang | M      |   67 |</span><br><span class="line">|   9 | NingZhongze  | F      |   49 |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看，第5条被删除了</span></span><br><span class="line">MariaDB [jiaowu]&gt; ROLLBACK;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 回滚</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line">|   3 | Miejueshitai | F      |   72 |</span><br><span class="line">|   4 | OuYangfeng   | M      |   76 |</span><br><span class="line">|   5 | YiDeng       | M      |   90 |</span><br><span class="line">|   6 | YuCanghai    | M      |   56 |</span><br><span class="line">|   7 | Jinlunfawang | M      |   67 |</span><br><span class="line">|   9 | NingZhongze  | F      |   49 |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第5条数据又回来了</span></span><br><span class="line"></span><br><span class="line">* 保存点</span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存點：SAVEPOINT sid，可撤銷到指定的保存點</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 回滾至保存點：ROLLBACK TO sid</span></span><br><span class="line">MariaDB [jiaowu]&gt; DELETE FROM tutors WHERE TID=1;</span><br><span class="line">MariaDB [jiaowu]&gt; SAVEPOINT ab;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存，保存的名字不能是數字</span></span><br><span class="line">MariaDB [jiaowu]&gt; DELETE FROM tutors WHERE TID=3;</span><br><span class="line">MariaDB [jiaowu]&gt; SAVEPOINT aC;</span><br><span class="line">MariaDB [jiaowu]&gt; DELETE FROM tutors WHERE TID=4;</span><br><span class="line">MariaDB [jiaowu]&gt; SAVEPOINT ad;</span><br><span class="line">MariaDB [jiaowu]&gt; ROLLBACK TO aC;</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   4 | OuYangfeng   | M      |   76 |</span><br><span class="line">|   5 | YiDeng       | M      |   90 |</span><br><span class="line">|   6 | YuCanghai    | M      |   56 |</span><br><span class="line">|   7 | Jinlunfawang | M      |   67 |</span><br><span class="line">|   9 | NingZhongze  | F      |   49 |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 回滚到aC保存点，这个保存点是删除了TID=3后的保存点，所以表中没有TID=3的数据，如果回滚到ab保存点，就会有TID=3的数据。如果要回滚到TID=1状态，就直接使用ROLLBACK命令。</span></span><br><span class="line"></span><br><span class="line">* 测试隔离级别</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开兩個mysql會話，隔離級別都設爲READ UNCOMMITTED，查看第一個事務的操作是否影響第二個</span></span><br><span class="line"></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT @@tx_isolation;</span><br><span class="line">+-----------------+</span><br><span class="line">| @@tx_isolation  |</span><br><span class="line">+-----------------+</span><br><span class="line">| REPEATABLE-READ |</span><br><span class="line">+-----------------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看会话变量，用SHOW SESSION VARIABLES LIKE <span class="string">'%tx_iso%'</span>;也可以查询到同样的结果。</span></span><br><span class="line">MariaDB [jiaowu]&gt; SET tx_isolation='READ-UNCOMMITTED';</span><br><span class="line"><span class="meta">#</span><span class="bash"> 兩個会话都調為讀未提交</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT @@tx_isolation;              </span><br><span class="line">+------------------+</span><br><span class="line">| @@tx_isolation   |</span><br><span class="line">+------------------+</span><br><span class="line">| READ-UNCOMMITTED |</span><br><span class="line">+------------------+</span><br><span class="line">MariaDB [jiaowu]&gt; START TRANSACTION;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 兩個会话都啟動事務</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line">|   3 | Miejueshitai | F      |   72 |</span><br><span class="line">|   4 | OuYangfeng   | M      |   76 |</span><br><span class="line">|   5 | YiDeng       | M      |   90 |</span><br><span class="line">|   6 | YuCanghai    | M      |   56 |</span><br><span class="line">|   7 | Jinlunfawang | M      |   67 |</span><br><span class="line">|   9 | NingZhongze  | F      |   49 |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">MariaDB [jiaowu]&gt; UPDATE tutors SET Age=50 WHERE TID=1;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其中一個調整</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   50 |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 另一個查看，雖未提交也可看到變化</span></span><br><span class="line">MariaDB [jiaowu]&gt; ROLLBACK;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改數據的一方撤銷了</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 另一個查看與，數據又回到之前</span></span><br><span class="line">MariaDB [jiaowu]&gt; COMMIT;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 两个会话都要提交</span></span><br><span class="line"></span><br><span class="line">* 再測讀提交，對方不提交就看不到</span><br><span class="line">MariaDB [jiaowu]&gt; SET tx_isolation='READ-COMMITTED';</span><br><span class="line">MariaDB [jiaowu]&gt; START TRANSACTION;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 两个会话都要设置成READ-COMMITTED，并启动事务</span></span><br><span class="line">MariaDB [jiaowu]&gt; UPDATE tutors SET Age=50 WHERE TID=1;</span><br><span class="line">ERROR 1665 (HY000): Cannot execute statement: impossible to write to binary log since BINLOG_FORMAT = STATEMENT and at least one table uses a storage engine limited to row-based logging. InnoDB is limited to row-logging when transaction isolation level is READ COMMITTED or READ UNCOMMITTED.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改数据时有报错。</span></span><br><span class="line">=======================================================================================</span><br><span class="line">从 MySQL 5.1.12 开始，可以用以下三种模式来实现：基于SQL语句的复制(statement-based replication, SBR)，基于行的复制(row-based replication, RBR)，混合模式复制(mixed-based replication, MBR)。相应地，binlog的格式也有三种：STATEMENT，ROW，MIXED。</span><br><span class="line">如果你采用默认隔离级别REPEATABLE-READ，那么建议binlog_format=ROW。如果你是READ-COMMITTED隔离级别，binlog_format=MIXED和binlog_format=ROW效果是一样的，binlog记录的格式都是ROW，对主从复制来说是很安全的参数。</span><br><span class="line">参考：https://blog.csdn.net/wsyw126/article/details/73011497</span><br><span class="line">=======================================================================================</span><br><span class="line">MariaDB [jiaowu]&gt; SET @@binlog_format=ROW;</span><br><span class="line">ERROR 1679 (HY000): Cannot modify @@session.binlog_format inside a transaction</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提示不能在事物中修改</span></span><br><span class="line">MariaDB [jiaowu]&gt; COMMIT;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交事物后，事物也就关闭了</span></span><br><span class="line">MariaDB [jiaowu]&gt; SET @@binlog_format=ROW;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再修改就没问题了</span></span><br><span class="line">MariaDB [jiaowu]&gt; UPDATE tutors SET Age=50 WHERE TID=1;       </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在一个终端修改数据</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在另一个终端查看</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当一边修改数据，另一边查看时，数据是不会改变的，提交后才会修改  </span></span><br><span class="line">MariaDB [jiaowu]&gt; ROLLBACK;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改数据的终端回滚</span></span><br><span class="line"></span><br><span class="line">* 測试REPATABLE-READ</span><br><span class="line"><span class="meta">#</span><span class="bash"> 結果未提交前不能看到變化，提交後仍未看到變量，因為需要兩方都提交才能看到變化</span></span><br><span class="line">MariaDB [jiaowu]&gt; SET tx_isolation='REPEATABLE-READ';</span><br><span class="line">MariaDB [jiaowu]&gt; START TRANSACTION;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在两个终端修改</span></span><br><span class="line">MariaDB [jiaowu]&gt; UPDATE tutors SET Age=50 WHERE TID=1;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在一个终端修改并查看数据</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;                </span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   50 |</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;                                </span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在另一个终端查看到的数据与修改数据终端查看到的不一样</span></span><br><span class="line">MariaDB [jiaowu]&gt; COMMIT;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改数据的终端提交并查看</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   50 |</span><br><span class="line"></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   93 |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在另一个终端查看，数据仍未变化</span></span><br><span class="line">MariaDB [jiaowu]&gt; COMMIT;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只有这个终端也提交后再查看，数据才会变化</span></span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   50 |</span><br><span class="line"></span><br><span class="line">* 測試可串行SERIALIZABLE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 效果與REPATABLE-READ一樣，但因一方未提交，另一方的操作不能繼續</span></span><br><span class="line"></span><br><span class="line">MariaDB [jiaowu]&gt; SET tx_isolation='SERIALIZABLE';</span><br><span class="line">MariaDB [jiaowu]&gt; START TRANSACTION;</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">| TID | Tname        | Gender | Age  |</span><br><span class="line">+-----+--------------+--------+------+</span><br><span class="line">|   1 | HongQigong   | M      |   50 |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在两个终端执行上面操作</span></span><br><span class="line">MariaDB [jiaowu]&gt; UPDATE tutors SET Age=93 WHERE TID=1;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在一个终端执行此命令，命令行会停住。先启动事物的终端命令行会停住，后启动的可以修改，但要等后启动事物的终端提交后，先启动事物的终端才可以操作，提交后的结果也以后提交的终端数据为准 </span></span><br><span class="line">MariaDB [jiaowu]&gt; UPDATE tutors SET Age=23 WHERE TID=1;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在另一个执行此命令</span></span><br><span class="line">MariaDB [jiaowu]&gt; COMMIT;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交，这时命令行停住的终端又可以操作了，但如果这里长时间没有提交，命令行停住的终端会提示<span class="string">"Lock wait timeout exceeded; try restarting transaction"</span></span></span><br><span class="line">MariaDB [jiaowu]&gt; COMMIT;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令行停住的终端提交后，数据结果以此终端的修改为准</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/05/mysql集群/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/05/mysql集群/" itemprop="url">
                  mysql集群
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-05 11:40:22" itemprop="dateCreated datePublished" datetime="2019-01-05T11:40:22+08:00">2019-01-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-15 10:18:11" itemprop="dateModified" datetime="2019-02-15T10:18:11+08:00">2019-02-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 准备两个节点，主节点有两块网卡，一为内网地址：172.16.106.132,一为外网地址：192.168.1.14。从节点为内网地址：172.16.106.133</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置从节点可以访问外网</span></span><br><span class="line">* 从节点</span><br><span class="line">[root@http1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">IPADDR=172.16.106.133</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=172.16.106.132</span><br><span class="line">DNS1=192.168.1.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入上面内容</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line">[root@test ~]# vim /etc/sysctl.conf </span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入上面内容，开启转发功能</span></span><br><span class="line">[root@test ~]# sysctl -p</span><br><span class="line">[root@test ~]# iptables -t nat -I POSTROUTING -s 172.16.106.0/24 -j SNAT --to-source 192.168.1.14</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加源地址转发，所有内网出去的数据的地址都改为主节点的外网地址192.168.1.14。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装mysql</span></span><br><span class="line">* 两节点上</span><br><span class="line">[root@test ~]# wget http://mirrors.ustc.edu.cn/mysql-repo/yum/mysql-5.7-community/el/7/x86_64/mysql-community-release-el7-7.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载科大源</span></span><br><span class="line">[root@test ~]# yum install -y mysql-community-release-el7-7.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装源</span></span><br><span class="line">[root@test ~]# yum install -y mysql-community-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装mysql服务，这里安装的是5.6版本</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置mysql</span></span><br><span class="line">* 主节点</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">    [mysqld]</span><br><span class="line">    innodb_file_per_table=ON</span><br><span class="line">    skip_name_resolve=ON</span><br><span class="line">    server_id=1</span><br><span class="line">    log-bin=master-log</span><br><span class="line">[root@test ~]# systemctl start mysql</span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">    [mysqld]</span><br><span class="line">    innodb_file_per_table=ON</span><br><span class="line">    skip_name_resolve=ON</span><br><span class="line">	server_id=11</span><br><span class="line">    relay_log=relay-log</span><br><span class="line">    read_only=ON</span><br><span class="line">[root@test ~]# systemctl start mysql</span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到主节点上创建拥有复制权限的用户，创建的用户最好使用最小权限法则，并且只允许从某个节点连接</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION CLIENT,REPLICATION SLAVE ON *.* TO <span class="string">'repluser'</span>@<span class="string">'172.16.106.%'</span> IDENTIFIED BY <span class="string">'replpass'</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建的用户最好指定一个具体地址，只让某个地址的某个用户可以有复制权限</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS;</span></span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| master-log.000003 |     2643 |              |                  |                   |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看二进制日志处于哪个位置，这里查到的是master-log.000003 2643，我们从这里向后手动复制即可</span></span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line">mysql -uroot -p</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">'172.16.106.132'</span>,MASTER_USER=<span class="string">'repluser'</span>,MASTER_PASSWORD=<span class="string">'replpass'</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">'master-log.000003'</span>,MASTER_LOG_POS=2643;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接用CHANGE MASTER TO命令,MASTER_HOST指向主节点地址，MASTER_CONNECT_RETRY是多长时间做一次复制，MASTER_LOG_FILE是指定主节点的日志文件，MASTER_LOG_POS是日志的位置</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: </span><br><span class="line">                  Master_Host: 172.16.106.132</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-log.000003</span><br><span class="line">          Read_Master_Log_Pos: 2643</span><br><span class="line">               Relay_Log_File: relay-log.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: master-log.000003</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 2643</span><br><span class="line">              Relay_Log_Space: 120</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 0</span><br><span class="line">                  Master_UUID: </span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: </span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里会显示上面连接时指定的信息，如用户名，地址，端口等。其中Slave_IO_Running和Slave_SQL_Running表示本地的两个重要线程，复制时一定要用到，这里显示NO，表示未运行。Exec_Master_Log_Pos表示执行到主节点二进制的哪个位置了，如果与Read_Master_Log_Pos相同，表示与主节点是一样的，数据同步未落后。Seconds_Behind_Master表示落后主节点多长时间，这里是NULL，是因为上面说的两个线程没有启动，启动后就会显示数字了，正数表示落后的时间</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START SLAVE;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动两个线程的命令；也可以用START SLAVE IO_THREAD/START SLAVE SQL_THREAD单独启动线程</span></span><br><span class="line">[root@http1 ~]# tail -100 /var/log/mysqld.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看日志</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.106.132</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-log.000003</span><br><span class="line">          Read_Master_Log_Pos: 2643</span><br><span class="line">               Relay_Log_File: relay-log.000002</span><br><span class="line">                Relay_Log_Pos: 284</span><br><span class="line">        Relay_Master_Log_File: master-log.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 2643</span><br><span class="line">              Relay_Log_Space: 451</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: e2b8a386-10a3-11e9-8f5d-000c295c6de3</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> Slave_IO_Running与Slave_SQL_Running变为了Yes，Seconds_Behind_Master变为了0</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line">mysql -uroot -p</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE DATABASE mydb;</span></span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看变化</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW DATABASES;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mydb               |</span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use mydb</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE TABLE tb1(id INT,Name CHAR(30));</span></span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use mydb</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW TABLES;</span></span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_mydb |</span><br><span class="line">+----------------+</span><br><span class="line">| tb1            |</span><br><span class="line">+----------------+</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> DESC tb1;</span></span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| Field | Type     | Null | Key | Default | Extra |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11)  | YES  |     | NULL    |       |</span><br><span class="line">| Name  | char(30) | YES  |     | NULL    |       |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW GLOBAL VARIABLES LIKE <span class="string">'read_only'</span>;</span></span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| read_only     | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里应该显示ON，查看全局变量read_only，是否为只读</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line">[root@test ~]# mysql -uroot -p &lt; jiaowu.sql</span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line">mysql -uroot -p</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| jiaowu             |</span><br><span class="line"></span><br><span class="line">===========================================================================================</span><br><span class="line">流程：</span><br><span class="line">1. 主节点/etc/my.cnf打开server_id=1、log-bin=master-log（启动二进制日志）。启动服务</span><br><span class="line">2. 从节点server_id=11、relay_log=relay-log（启动中继日志）、read_only=ON（让从节点为只读）。启动服务 </span><br><span class="line">3. 到主节点上创建拥有复制权限的用户，创建的用户最好使用最小权限，并且只允许从某个节点连接</span><br><span class="line">4. 到从节点用CHANGE MASTER TO命令连接主节点</span><br><span class="line">===========================================================================================</span><br></pre></td></tr></table></figure>
<h3 id="主主复制"><a href="#主主复制" class="headerlink" title="主主复制"></a>主主复制</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 准备两个节点，主节点有两块网卡，一为内网地址：172.16.106.132,一为外网地址：192.168.1.14。从节点为内网地址：172.16.106.133</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置</span></span><br><span class="line">* 主节点</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">    [mysqld]</span><br><span class="line">    innodb_file_per_table=ON</span><br><span class="line">    skip_name_resolve=ON</span><br><span class="line">    server_id=1</span><br><span class="line">    log-bin=master-log</span><br><span class="line">    relay_log=relay-log</span><br><span class="line">    auto_increment_offset=1</span><br><span class="line">    auto_increment_increment=2</span><br><span class="line">[root@test ~]# systemctl start mysql</span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">    [mysqld]</span><br><span class="line">    innodb_file_per_table=ON</span><br><span class="line">    skip_name_resolve=ON</span><br><span class="line">    server_id=11</span><br><span class="line">    log-bin=master-log</span><br><span class="line">    relay_log=relay-log</span><br><span class="line">    auto_increment_offset=2</span><br><span class="line">    auto_increment_increment=2</span><br><span class="line">[root@http1 ~]# systemctl start mysql</span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION CLIENT,REPLICATION SLAVE ON *.* TO <span class="string">'repluser'</span>@<span class="string">'172.16.106.133'</span> IDENTIFIED BY <span class="string">'replpass'</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里设置用户只能从172.16.106.133连接，这个是从节点的内网地址</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS;</span></span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| master-log.000004 |      444 |              |                  |                   |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line">[root@http1 ~]# mysql -uroot -p</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION CLIENT,REPLICATION SLAVE ON *.* TO <span class="string">'repluser'</span>@<span class="string">'192.168.1.14'</span> IDENTIFIED BY <span class="string">'replpass'</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里只有添加主节点的192地址，主节点才能连接从节点，如果添加的是主节点的内网地址就无法连接。测试发现在主节点连接从节点时使用的是192的地址。</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS;</span></span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| master-log.000001 |      444 |              |                  |                   |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> STOP SLAVE;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">'172.16.106.132'</span>,MASTER_USER=<span class="string">'repluser'</span>,MASTER_PASSWORD=<span class="string">'replpass'</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">'master-log.000004'</span>,MASTER_LOG_POS=444;</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash">CHANGE MASTER TO MASTER_HOST=<span class="string">'172.16.106.133'</span>,MASTER_USER=<span class="string">'repluser'</span>,MASTER_PASSWORD=<span class="string">'replpass'</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">'master-log.000001'</span>,MASTER_LOG_POS=444;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START SLAVE;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START SLAVE;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create database mydb1;</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE TABLE tbl1(id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,Name CHAR(30));</span></span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSERT INTO tbl1 (Name) VALUES (<span class="string">'stu1'</span>),(<span class="string">'stu2'</span>);</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from tbl1;</span></span><br><span class="line">+----+------+</span><br><span class="line">| id | Name |</span><br><span class="line">+----+------+</span><br><span class="line">|  2 | stu1 |</span><br><span class="line">|  4 | stu2 |</span><br><span class="line">+----+------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以看到ID是2和4，因为配置文件中设置从2开始</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSERT INTO tbl1 (Name) VALUES (<span class="string">'stu3'</span>),(<span class="string">'stu4'</span>);</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from tbl1;</span></span><br><span class="line">+----+------+</span><br><span class="line">| id | Name |</span><br><span class="line">+----+------+</span><br><span class="line">|  2 | stu1 |</span><br><span class="line">|  4 | stu2 |</span><br><span class="line">|  5 | stu3 |</span><br><span class="line">|  7 | stu4 |</span><br><span class="line">+----+------+</span><br><span class="line">这里可以看到是5和7，因为是从前面数据向下的ID号</span><br><span class="line"></span><br><span class="line">========================================================</span><br><span class="line"> * 如果主从节点数据不一致，解决的办法最好是，将从节点停掉，从主节点备份再恢复到从节点，再开启从节点复制功能。</span><br><span class="line"> * 数据库读写分离后，前端应该有一个读写分离器，读写分离器还可以做语句网关，禁止掉一些危险语句。数据库不应该面向互联网。公司人员远程管理时可通过VPN，拔号或跳板机连接服务器</span><br><span class="line"> </span><br><span class="line"><span class="meta"> #</span><span class="bash"> 双主模型创建过程</span></span><br><span class="line">1. 开启两台服务器的二进制日志和中继日志，设置数据ID从几开始和增长因子。之后启动服务</span><br><span class="line">2. 在两台服务器上创建有复制权限的用户。</span><br><span class="line">3. 在两台服务器上查看所处的日志位置，再通过CHANGE MASTER TO命令设置对方为主服务器</span><br><span class="line">4. 启动功能START SLAVE;。之后就可以测试了。</span><br><span class="line">========================================================</span><br></pre></td></tr></table></figure>
<h3 id="mysql-keeyalived"><a href="#mysql-keeyalived" class="headerlink" title="mysql+keeyalived"></a>mysql+keeyalived</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">准备两台主机，node1：192.168.1.14，node2：192.168.1.15</span><br><span class="line"></span><br><span class="line">* 两台主机</span><br><span class="line">[root@test ~]# yum install -y keepalived</span><br><span class="line"></span><br><span class="line">* node1</span><br><span class="line">[root@test ~]# cp -p /etc/keepalived/keepalived.conf&#123;,.bak&#125;</span><br><span class="line">[root@test ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id node1</span><br><span class="line">   vrrp_mcast_group4 224.1.101.120</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_mysql_port &#123;</span><br><span class="line">    script "/etc/keepalived/chk_mysql.sh"</span><br><span class="line">    interval 2</span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.101/24 dev ens33 label ens33:1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_mysql_port</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@test ~]# yum install -y mailx</span><br><span class="line">[root@test ~]# vim /etc/mail.rc</span><br><span class="line">set from=budongchan@ccgoldenet.com</span><br><span class="line">set smtp=imap.exmail.qq.com</span><br><span class="line">set smtp-auth-user=budongchan@ccgoldenet.com</span><br><span class="line">set smtp-auth-password=CCjd1rj.com</span><br><span class="line">set smtp-auth=login</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入上面的内容。以便下面实现邮件报警功能</span></span><br><span class="line">[root@test ~]# vim /etc/keepalived/chk_mysql.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">counter=$(netstat -na|grep "LISTEN"|grep "3306"|wc -l)</span><br><span class="line">if [ "$&#123;counter&#125;" -eq 0 ]; then</span><br><span class="line">   /usr/bin/systemctl start mysqld || /usr/bin/systemctl stop keepalived &amp;&amp; ech</span><br><span class="line">o "MysqlError" | mailx -s "MysqlError" budongchan@ccgoldenet.com</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置keepalived的监控脚本</span></span><br><span class="line">[root@test ~]# chmod +x /etc/keepalived/chk_mysql.sh</span><br><span class="line">[root@test ~]# scp /etc/keepalived/keepalived.conf 192.168.1.15:/etc/keepalived/</span><br><span class="line">[root@test ~]# scp /etc/keepalived/chk_mysql.sh 192.168.1.15:/etc/keepalived/</span><br><span class="line">[root@test ~]# scp /etc/mail.rc 192.168.1.15:/etc/</span><br><span class="line">[root@test ~]# systemctl start keepalived</span><br><span class="line"></span><br><span class="line">* node2</span><br><span class="line"> [root@test ~]# vim /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   router_id node2</span><br><span class="line"></span><br><span class="line">vrrp_script chk_mysql_port &#123;</span><br><span class="line">    script "/etc/keepalived/chk_mysql.sh"</span><br><span class="line">    interval 2</span><br><span class="line">    weight -5</span><br><span class="line">    fall 2 </span><br><span class="line">    rise 1 </span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 96</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;   </span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.101/24 dev ens33 label ens33:1</span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_mysql_port</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line">[root@test ~]# systemctl start keepalived</span><br><span class="line">[root@test ~]# tcpdump -i ens33 -nn -vv host 224.1.101.120</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试，可以看到心跳包</span></span><br><span class="line"></span><br><span class="line">* 两个节点</span><br><span class="line">[root@test ~]# rpm -Uvh http://dev.mysql.com/get/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">[root@test ~]# yum -y install mysql-community-server</span><br><span class="line"></span><br><span class="line">* node1</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">symbolic-links=0</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">collation-server = utf8mb4_unicode_ci</span><br><span class="line">innodb_file_per_table=ON</span><br><span class="line">skip_name_resolve=ON</span><br><span class="line">server_id=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 另一个节点server_id要改为2，如果一样，在启动后会有问题</span></span><br><span class="line">log-bin=master-log</span><br><span class="line">relay_log=relay-log</span><br><span class="line">auto_increment_offset=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 另一节点这里要改为2，表示以双数输入</span></span><br><span class="line">auto_increment_increment=2</span><br><span class="line">symbolic-links=0</span><br><span class="line">sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES </span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">[root@test ~]# systemctl start mysql</span><br><span class="line">[root@test ~]# scp /etc/my.cnf 192.168.1.15:/etc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动时，/var/lib/mysql数据目录中的performance_schema目录和一些文件的属主属组可能不是mysql，需要chown -R mysql.mysql /var/lib/mysql，不然无法启动</span></span><br><span class="line">[root@test ~]# mysql_secure_installation</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置mysql密码等信息</span></span><br><span class="line">[root@test ~]# mysql -uroot -p</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION CLIENT,REPLICATION SLAVE ON *.* TO <span class="string">'repluser'</span>@<span class="string">'192.168.1.15'</span> IDENTIFIED BY <span class="string">'replpass'</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS;</span></span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| master-log.000003 |     2674 |              |                  |                   |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">'192.168.1.15'</span>,MASTER_USER=<span class="string">'repluser'</span>,MASTER_PASSWORD=<span class="string">'replpass'</span>,MASTER</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">'192.168.1.15'</span>,MASTER_USER=<span class="string">'repluser'</span>,MASTER_PASSWORD=<span class="string">'replpass'</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">'master-log.000003'</span>,MASTER_LOG_POS=2436;</span></span><br><span class="line"></span><br><span class="line">* node2</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION CLIENT,REPLICATION SLAVE ON *.* TO <span class="string">'repluser'</span>@<span class="string">'192.168.1.14'</span> IDENTIFIED BY <span class="string">'replpass'</span>; </span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS;</span></span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| master-log.000003 |     2674 |              |                  |                   |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">'192.168.1.14'</span>,MASTER_USER=<span class="string">'repluser'</span>,MASTER_PASSWORD=<span class="string">'replpass'</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">'master-log.000003'</span>,MASTER_LOG_POS=2758;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定MASTER_LOG_POS最好看一下，可能有变化</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.1.14</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-log.000003</span><br><span class="line">          Read_Master_Log_Pos: 2758</span><br><span class="line">               Relay_Log_File: relay-log.000002</span><br><span class="line">                Relay_Log_Pos: 284</span><br><span class="line">        Relay_Master_Log_File: master-log.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在两个节点都查看一下</span></span><br><span class="line"></span><br><span class="line">* node1</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE DATABASE mydb;</span></span><br><span class="line"></span><br><span class="line">* node2</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW DATABASES;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mydb               |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在node1上创建的库，在node2上可以看到</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE TABLE tbl1(id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,Name CHAR(30));</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在node2上创建表</span></span><br><span class="line"></span><br><span class="line">* node1</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> USE mydb</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSERT INTO tbl1(Name) VALUES (<span class="string">'stu1'</span>),(<span class="string">'stu2'</span>);</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在node1上可以向表中插入数据</span></span><br><span class="line"></span><br><span class="line">* node2</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> USE mydb</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSERT INTO tbl1(Name) VALUES (<span class="string">'stu1'</span>),(<span class="string">'stu2'</span>);</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM tbl1;</span></span><br><span class="line">+----+------+</span><br><span class="line">| id | Name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | stu1 |</span><br><span class="line">|  3 | stu2 |</span><br><span class="line">|  4 | stu1 |</span><br><span class="line">|  6 | stu2 |</span><br><span class="line">+----+------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在node2上插入数据后可以看到id号是node1插入单数，node2插入双数</span></span><br><span class="line"></span><br><span class="line">* node1</span><br><span class="line">[root@test ~]# systemctl stop mysql</span><br><span class="line">Job for mysqld.service canceled.</span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128         *:26379                   *:*                  </span><br><span class="line">LISTEN      0      128         *:6379                    *:*                  </span><br><span class="line">LISTEN      0      128         *:22                      *:*                  </span><br><span class="line">LISTEN      0      100    127.0.0.1:25                      *:*                  </span><br><span class="line">LISTEN      0      128        :::22                     :::*                  </span><br><span class="line">LISTEN      0      100       ::1:25                     :::*                  </span><br><span class="line">LISTEN      0      80         :::3306</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到，停止了mysql服务，会被重新启动</span></span><br></pre></td></tr></table></figure>
<h3 id="半同步"><a href="#半同步" class="headerlink" title="半同步"></a>半同步</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">* 主节点</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">    [mysqld]</span><br><span class="line">    innodb_file_per_table=ON</span><br><span class="line">    skip_name_resolve=ON</span><br><span class="line">    server_id=1</span><br><span class="line">    log-bin=master-log</span><br><span class="line">[root@test ~]# systemctl start mysql</span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">    [mysqld]</span><br><span class="line">    innodb_file_per_table=ON</span><br><span class="line">    skip_name_resolve=ON</span><br><span class="line">	server_id=11</span><br><span class="line">    relay_log=relay-log</span><br><span class="line">[root@test ~]# systemctl start mysql</span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION CLIENT,REPLICATION SLAVE ON *.* TO <span class="string">'repluser'</span>@<span class="string">'172.16.106.133'</span> IDENTIFIED BY <span class="string">'replpass'</span>;   </span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS;</span></span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| master-log.000005 |      434 |              |                  |                   |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">'172.16.106.132'</span>,MASTER_USER=<span class="string">'repluser'</span>,MASTER_PASSWORD=<span class="string">'replpass'</span>,MASTER_PORT=3306,MASTER_LOG_FILE=<span class="string">'master-log.000005'</span>,MASTER_LOG_POS=434;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START SLAVE;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.106.132</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-log.000005</span><br><span class="line">          Read_Master_Log_Pos: 434</span><br><span class="line">               Relay_Log_File: relay-log.000002</span><br><span class="line">                Relay_Log_Pos: 284</span><br><span class="line">        Relay_Master_Log_File: master-log.000005</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 434</span><br><span class="line">              Relay_Log_Space: 451</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: e2b8a386-10a3-11e9-8f5d-000c295c6de3</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSTALL PLUGIN rpl_semi_sync_master SONAME <span class="string">'semisync_master.so'</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装插件</span></span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSTALL PLUGIN rpl_semi_sync_slave SONAME <span class="string">'semisync_slave.so'</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW PLUGINS;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在两个节点可以看到最下面一行中rpl_semi_sync_slave 已经是ACTIVE状态了</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW GLOBAL VARIABLES LIKE <span class="string">'%semi%'</span>;</span></span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| Variable_name                      | Value |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_master_enabled       | OFF   |</span><br><span class="line">| rpl_semi_sync_master_timeout       | 10000 |</span><br><span class="line">| rpl_semi_sync_master_trace_level   | 32    |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave | ON    |</span><br><span class="line">| rpl_semi_sync_slave_enabled        | OFF   |</span><br><span class="line">| rpl_semi_sync_slave_trace_level    | 32    |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到rpl_semi_sync_master_enabled一项还是OFF，要改为ON。rpl_semi_sync_master_timeout为10000，表示10秒；rpl_semi_sync_master_wait_no_slave表示如果没有半节点同步是否等待</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET @@global.rpl_semi_sync_master_enabled=ON;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动半同步</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW GLOBAL VARIABLES LIKE <span class="string">'%semi%'</span>;</span></span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| Variable_name                      | Value |</span><br><span class="line">+------------------------------------+-------+</span><br><span class="line">| rpl_semi_sync_master_enabled       | ON    |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时rpl_semi_sync_master_enabled是ON了</span></span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW GLOBAL VARIABLES LIKE <span class="string">'%rpl%'</span>;</span></span><br><span class="line">+---------------------------------+----------+</span><br><span class="line">| Variable_name                   | Value    |</span><br><span class="line">+---------------------------------+----------+</span><br><span class="line">| rpl_semi_sync_slave_enabled     | OFF      |</span><br><span class="line">| rpl_semi_sync_slave_trace_level | 32       |</span><br><span class="line">| rpl_stop_slave_timeout          | 31536000 |</span><br><span class="line">+---------------------------------+----------+</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET @@global.rpl_semi_sync_slave_enabled=ON;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW GLOBAL VARIABLES LIKE <span class="string">'%rpl%'</span>;</span></span><br><span class="line">+---------------------------------+----------+</span><br><span class="line">| Variable_name                   | Value    |</span><br><span class="line">+---------------------------------+----------+</span><br><span class="line">| rpl_semi_sync_slave_enabled     | ON       |</span><br><span class="line">| rpl_semi_sync_slave_trace_level | 32       |</span><br><span class="line">| rpl_stop_slave_timeout          | 31536000 |</span><br><span class="line">+---------------------------------+----------+</span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW GLOBAL STATUS LIKE <span class="string">'rpl%'</span>;</span></span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_master_clients               | 0     |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一项Rpl_semi_sync_master_clients表示从节点有几个，这里是0</span></span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> STOP SLAVE IO_THREAD;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START SLAVE IO_THREAD;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从节点需要先停止再启动IO线程，才能加入到半同步的节点</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW GLOBAL STATUS LIKE <span class="string">'rpl%'</span>;</span></span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_master_clients               | 1     |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时Rpl_semi_sync_master_clients是1了。</span></span><br><span class="line">[root@test ~]# mysql -uroot -p &lt; jiaowu.sql</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW GLOBAL STATUS LIKE <span class="string">'rpl%'</span>;</span></span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_master_clients               | 1     |</span><br><span class="line">| Rpl_semi_sync_master_net_avg_wait_time     | 498   |</span><br><span class="line">| Rpl_semi_sync_master_net_wait_time         | 10959 |</span><br><span class="line">| Rpl_semi_sync_master_net_waits             | 22    |</span><br><span class="line">| Rpl_semi_sync_master_no_times              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_tx                 | 0     |</span><br><span class="line">| Rpl_semi_sync_master_status                | ON    |</span><br><span class="line">| Rpl_semi_sync_master_timefunc_failures     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_avg_wait_time      | 625   |</span><br><span class="line">| Rpl_semi_sync_master_tx_wait_time          | 13762 |</span><br><span class="line">| Rpl_semi_sync_master_tx_waits              | 22    |</span><br><span class="line">| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_sessions         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_yes_tx                | 22    |</span><br><span class="line">| Rpl_semi_sync_slave_status                 | OFF   |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以看到有数据的信息了</span></span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW DATABASES;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| jiaowu             |</span><br><span class="line"><span class="meta">#</span><span class="bash"> jiaowu库同步了</span></span><br><span class="line"></span><br><span class="line">=======================================================================================</span><br><span class="line">半同步复制创建过程</span><br><span class="line">1. 主节点打开server_id=1、log-bin=master-log。启动服务</span><br><span class="line">2. 从节点打开server_id=11、relay_log=relay-log。启动服务</span><br><span class="line">3. 主节点创建可以使用复制功能的帐号</span><br><span class="line">4. 从节点按主节点创建的帐号连接主节点</span><br><span class="line">5. 主节点安装插件INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';</span><br><span class="line">6. 从节点安装插件INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';</span><br><span class="line">7. 主节点启用半同步SET @@global.rpl_semi_sync_master_enabled=ON;</span><br><span class="line">8. 从节点启用半同步SET @@global.rpl_semi_sync_slave_enabled=ON;。重启IO线程STOP SLAVE IO_THREAD; --&gt; START SLAVE IO_THREAD;</span><br><span class="line"></span><br><span class="line">* 异步复制（Asynchronous replication）</span><br><span class="line">MySQL默认的复制即是异步的，主库在执行完客户端提交的事务后会立即将结果返回给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，主库如果crash(crash[kræʃ]：崩溃)掉了，此时主库上已经提交的事务可能并没有传到从库上，如果此时，强行将从库提升为主库，可能导致新主库上的数据不完整。</span><br><span class="line"></span><br><span class="line">* 全同步复制（Fully synchronous replication）</span><br><span class="line">当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会受到严重的影响。</span><br><span class="line"></span><br><span class="line">* 半同步复制（Semisynchronous replication）</span><br><span class="line">介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。</span><br><span class="line">=======================================================================================</span><br></pre></td></tr></table></figure>
<h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 实现只复制某一个库（一般就到库级别，不会到表级别）。准备两台主机，主服务器地址：192.168.1.14，从服务器地址：192.168.1.15</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line">[root@test ~]# yum install -y mariadb-server</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_file_per_table=ON</span><br><span class="line">skip_name_resolve=ON</span><br><span class="line">server_id=1</span><br><span class="line">log-bin=master-log</span><br><span class="line">[root@test ~]# systemctl start mariadb</span><br><span class="line">[root@test ~]# mysql_secure_installation</span><br><span class="line">[root@test ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; GRANT REPLICATION CLIENT,REPLICATION SLAVE ON *.* TO 'repluser'@'192.168.1.%' IDENTIFIED BY 'replpass';  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建只有192.168.1.15通过repluser用户可以同步 </span></span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line">MariaDB [(none)]&gt; SHOW MASTER STATUS;</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line">| master-log.000003 |     1989 |              |                  |</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line">[root@test ~]# yum install -y mariadb-server</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_file_per_table=ON</span><br><span class="line">skip_name_resolve=ON</span><br><span class="line">server_id=11</span><br><span class="line">relay_log=relay-log</span><br><span class="line">[root@test ~]# systemctl start mariadb</span><br><span class="line">[root@test ~]# mysql_secure_installation</span><br><span class="line">[root@test ~]# mysql -uroot -pcentos</span><br><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST='192.168.1.14',MASTER_USER='repluser',MASTER_PASSWORD='replpass',MASTER_PORT=3306,MASTER_LOG_FILE='master-log.000003',MASTER_LOG_POS=1989;</span><br><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G</span><br><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES LIKE '%do_db%';</span><br><span class="line">+-----------------+-------+</span><br><span class="line">| Variable_name   | Value |</span><br><span class="line">+-----------------+-------+</span><br><span class="line">| replicate_do_db |       |</span><br><span class="line">+-----------------+-------+</span><br><span class="line">MariaDB [(none)]&gt; SET @@global.replicate_do_db=mydb;</span><br><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.1.14</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-log.000003</span><br><span class="line">          Read_Master_Log_Pos: 1989</span><br><span class="line">               Relay_Log_File: relay-log.000003</span><br><span class="line">                Relay_Log_Pos: 530</span><br><span class="line">        Relay_Master_Log_File: master-log.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: mydb</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replicate_Do_DB变为了mydb，表示只同步这个库              </span></span><br><span class="line">              </span><br><span class="line">* 主节点</span><br><span class="line">[root@test ~]# mysql -uroot -pcentos &lt; jiaowu.sql</span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| jiaowu             |</span><br><span class="line">MariaDB [(none)]&gt; USE jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; SHOW TABLES;</span><br><span class="line">MariaDB [jiaowu]&gt; DROP TABLE students;</span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">+--------------------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从库中并没有jiaowu库</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line">MariaDB [jiaowu]&gt; CREATE DATABASE mydb;</span><br><span class="line">MariaDB [jiaowu]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| jiaowu             |</span><br><span class="line">| mydb               |</span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mydb               |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从库同步了mydb库</span></span><br><span class="line"></span><br><span class="line">* 主节点</span><br><span class="line">MariaDB [mydb]&gt; CREATE TABLE tbl1 (id INT);</span><br><span class="line">MariaDB [mydb]&gt; SHOW TABLES;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_mydb |</span><br><span class="line">+----------------+</span><br><span class="line">| tbl1           |</span><br><span class="line">+----------------+</span><br><span class="line"></span><br><span class="line">* 从节点</span><br><span class="line">MariaDB [(none)]&gt; SHOW TABLES FROM mydb;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_mydb |</span><br><span class="line">+----------------+</span><br><span class="line">| tbl1           |</span><br><span class="line">+----------------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步了tbl1表</span></span><br></pre></td></tr></table></figure>
<h3 id="读写分离器-proxysql"><a href="#读写分离器-proxysql" class="headerlink" title="读写分离器 proxysql"></a>读写分离器 proxysql</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 准备一个集群，有一个master主机，地址192.168.1.14，两个从节点，地址一个192.168.1.15，一个192.168.1.13。再准备一个读写分离器，地址是192.168.1.10。请求都到192.168.1.10，写到192.168.1.14，读到192.168.1.15和192.168.1.13。以上面的主从复制为基础</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要同步服务器的时间，保证所有服务器的时间是一样的</span></span><br><span class="line"></span><br><span class="line">* 从节点192.168.1.15，将只复制一个库改回来</span><br><span class="line">MariaDB [(none)]&gt; STOP SLAVE;</span><br><span class="line">MariaDB [(none)]&gt; SET @@global.replicate_do_db='';</span><br><span class="line"><span class="meta">#</span><span class="bash"> 改为空就可以了</span></span><br><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.1.14</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-log.000003</span><br><span class="line">          Read_Master_Log_Pos: 7043</span><br><span class="line">               Relay_Log_File: relay-log.000004</span><br><span class="line">                Relay_Log_Pos: 530</span><br><span class="line">        Relay_Master_Log_File: master-log.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line"></span><br><span class="line">* 从节点192.168.1.13</span><br><span class="line">[root@test ~]# yum install -y mariadb-server</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_file_per_table=ON</span><br><span class="line">skip_name_resolve=ON</span><br><span class="line">server_id=12</span><br><span class="line">relay_log=relay-log</span><br><span class="line">read_only=ON</span><br><span class="line">[root@test ~]# systemctl start mariadb</span><br><span class="line"></span><br><span class="line">* 主节点192.168.1.14</span><br><span class="line">[root@test ~]# mysqldump -uroot --all-databases -R -E --triggers -x --master-data=2 -p &gt; alldb.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> --all-databases  , -A：导出全部数据库。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --routines, -R：导出存储过程以及自定义函数。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --events, -E：导出事件。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --triggers：导出触发器。该选项默认启用，用--skip-triggers禁用它。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --lock-all-tables,  -x：提交请求锁定所有数据库中的所有表，以保证数据的一致性。这是一个全局读锁，并且自动关闭--single-transaction 和--lock-tables 选项。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --master-data：该选项将当前服务器的binlog的位置和文件名追加到输出文件中(show master status)。如果为1，将会输出CHANGE MASTER 命令；如果为2，输出的CHANGE  MASTER命令前添加注释信息。</span></span><br><span class="line">[root@test ~]# scp alldb.sql 192.168.1.13:/root</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制到刚加上来的从节点</span></span><br><span class="line">[root@test ~]# rm -rf alldb.sql</span><br><span class="line"></span><br><span class="line">* 从节点192.168.1.13</span><br><span class="line">[root@test ~]# mysql -uroot -p &lt; alldb.sql</span><br><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST='192.168.1.14',MASTER_USER='repluser',MASTER_PASSWORD='replpass',MASTER_LOG_FILE='master-log.000003',MASTER_LOG_POS=7043;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置与主节点同步</span></span><br><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.1.14</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-log.000003</span><br><span class="line">          Read_Master_Log_Pos: 7295</span><br><span class="line">               Relay_Log_File: relay-log.000002</span><br><span class="line">                Relay_Log_Pos: 782</span><br><span class="line">        Relay_Master_Log_File: master-log.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line"></span><br><span class="line">* 主节点192.168.1.14</span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE testdb;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到主节点创建一个库测试一下</span></span><br><span class="line"></span><br><span class="line">* 两个从节点</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| jiaowu             |</span><br><span class="line">| mydb               |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| testdb             |</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在两个从节点可以看到创建的库</span></span><br><span class="line"></span><br><span class="line">* 主节点192.168.1.14</span><br><span class="line">MariaDB [(none)]&gt; DROP DATABASE testdb;</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL ON *.* TO 'myadmin'@'192.168.1.%' IDENTIFIED BY 'mypass';</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个有权限连接主从服务器的帐号。这个用户会同步到两个从节点</span></span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">* 两个从节点</span><br><span class="line">MariaDB [(none)]&gt; SELECT User FROM mysql.user;</span><br><span class="line">+----------+</span><br><span class="line">| User     |</span><br><span class="line">+----------+</span><br><span class="line">| root     |</span><br><span class="line">| myadmin  |</span><br><span class="line"></span><br><span class="line">* 分离器192.168.1.10</span><br><span class="line">下载 proxysql-1.3.6-1-centos7.x86_64.rpm</span><br><span class="line">[root@test ~]# yum install -y proxysql-1.3.6-1-centos7.x86_64.rpm</span><br><span class="line">[root@test ~]# cp /etc/proxysql.cnf&#123;,.bak&#125;</span><br><span class="line">[root@test ~]# vim /etc/proxysql.cnf</span><br><span class="line">datadir="/var/lib/proxysql"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据目录路径，这是proxysql的状态数据，与mysql无关</span></span><br><span class="line">admin_variables=</span><br><span class="line">&#123;</span><br><span class="line">        admin_credentials="admin:admin"</span><br><span class="line">        # 登录proxysql进行管理时用的帐号密码</span><br><span class="line">        mysql_ifaces="127.0.0.1:6032;/tmp/proxysql_admin.sock"</span><br><span class="line">        # 连接时用的地址和端口</span><br><span class="line">&#125;</span><br><span class="line">mysql_variables=</span><br><span class="line">&#123;</span><br><span class="line">        threads=4</span><br><span class="line">        # 启动几个线程，它是单线程响应多个请求的，与CPU有关。测试时CPU为双核，但还是启动了四个线程</span><br><span class="line">        max_connections=2048</span><br><span class="line">        # 并发连接数</span><br><span class="line">        default_query_delay=0</span><br><span class="line">        default_query_timeout=36000000</span><br><span class="line">        have_compress=true</span><br><span class="line">        poll_timeout=2000</span><br><span class="line">        interfaces="0.0.0.0:3306;/tmp/proxysql.sock"</span><br><span class="line">        # 监听在所有地址的3306端口接收请求，测试调整上面的启动线程和此项的端口都不起作用，启动后还是启动4个线程，监听在6033端口。用1.4.7和1.3.6版本都是如此.恢复镜像后正常了</span><br><span class="line">        default_schema="mydb"</span><br><span class="line">        # 登录后默认操作的数据库</span><br><span class="line">        stacksize=1048576</span><br><span class="line">        server_version="5.5.30"</span><br><span class="line">        connect_timeout_server=3000</span><br><span class="line">        monitor_history=600000</span><br><span class="line">        monitor_connect_interval=60000</span><br><span class="line">        monitor_ping_interval=10000</span><br><span class="line">        monitor_read_only_interval=1500</span><br><span class="line">        monitor_read_only_timeout=500</span><br><span class="line">        ping_interval_server=120000</span><br><span class="line">        ping_timeout_server=500</span><br><span class="line">        commands_stats=true</span><br><span class="line">        sessions_sort=true</span><br><span class="line">        connect_retries_on_failure=10</span><br><span class="line">&#125;</span><br><span class="line">mysql_servers =</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每一组花括号记录一台服务器，用逗号隔开，再记录下一台服务器</span></span><br><span class="line">( # 要有括号，不然无法启动，在message日志中会提示语法错误</span><br><span class="line">&#123;</span><br><span class="line">        address = "192.168.1.14" # no default, required . If port is 0 , address is interpred as a Unix Socket Domain</span><br><span class="line">        port = 3306           # no default, required . If port is 0 , address is interpred as a Unix Socket Domain</span><br><span class="line">        hostgroup = 0           # no default, required</span><br><span class="line">        # 所处的主机组，将读定义一组，写定义一组</span><br><span class="line">        status = "ONLINE"     # default: ONLINE</span><br><span class="line">        # 配置完以后，这个服务器默认是在线的还是离线的</span><br><span class="line">        weight = 1            # default: 1</span><br><span class="line">        # 权重</span><br><span class="line">        compression = 0       # default: 0</span><br><span class="line">        # 压缩</span><br><span class="line">        max_connections = 200</span><br><span class="line">        # 最大并发连接数</span><br><span class="line">         #	max_replication_lag = 10	# 读服务器是否延迟，这里默认是10秒</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">        address = "192.168.1.15" # no default, required . If port is 0 , address is interpred as a Unix Socket Domain</span><br><span class="line">        port = 3306           # no default, required . If port is 0 , ddress is interpred as a Unix Socket Domain</span><br><span class="line">        hostgroup = 1           # no default, required</span><br><span class="line">        status = "ONLINE"     # default: ONLINE</span><br><span class="line">        weight = 1            # default: 1</span><br><span class="line">        compression = 0       # default: 0</span><br><span class="line">        max_connections = 500</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">        address = "192.168.1.13" # no default, required . If port is 0 , address is interpred as a Unix Socket Domain</span><br><span class="line">        port = 3306           # no default, required . If port is 0 ,ddress is interpred as a Unix Socket Domain</span><br><span class="line">        hostgroup = 1           # no default, required</span><br><span class="line">        status = "ONLINE"     # default: ONLINE</span><br><span class="line">        weight = 1            # default: 1</span><br><span class="line">        compression = 0       # default: 0</span><br><span class="line">        max_connections = 500</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">mysql_users:</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义以哪个用户组的身份连接至哪台服务器上</span></span><br><span class="line">(</span><br><span class="line">&#123;</span><br><span class="line">        username = "myadmin" # no default , required</span><br><span class="line">        password = "mypass" # default: ''</span><br><span class="line">        default_hostgroup = 0 # default: 0</span><br><span class="line">        # 默认连接哪个组</span><br><span class="line">        active = 1            # default: 1</span><br><span class="line">        default_schema="mydb"</span><br><span class="line">        # 连接后默认使用的数据库</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">mysql_query_rules:</span><br><span class="line"><span class="meta">#</span><span class="bash"> 语句路由，实际是一个防火墙，可以屏蔽一些语句</span></span><br><span class="line">(</span><br><span class="line">)</span><br><span class="line">scheduler=</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调度器</span></span><br><span class="line">(</span><br><span class="line">)</span><br><span class="line">mysql_replication_hostgroups=</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指明哪个组读，哪个组写。可以同时调度多个集群</span></span><br><span class="line">(</span><br><span class="line">&#123;</span><br><span class="line">        writer_hostgroup=0</span><br><span class="line">        reader_hostgroup=1</span><br><span class="line">        comment="test repl 1"</span><br><span class="line">        # 说明</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">[root@test ~]# systemctl start proxysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">[root@test ~]# ss -tln</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128    127.0.0.1:6032                    *:*                  </span><br><span class="line">LISTEN      0      128         *:6033                    *:*                  </span><br><span class="line">LISTEN      0      128         *:6033                    *:*                  </span><br><span class="line">LISTEN      0      128         *:6033                    *:*                  </span><br><span class="line">LISTEN      0      128         *:6033                    *:*</span><br><span class="line">[root@test ~]# yum install -y mariadb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装客户端</span></span><br><span class="line">[root@test ~]# mysql -h192.168.1.10 -P6033 -umyadmin -pmypass</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.5.30 (ProxySQL)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接后提示连接的是<span class="string">"Server version: 5.5.30 (ProxySQL)"</span></span></span><br><span class="line">MySQL [(none)]&gt; SHOW TABLES;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_mydb |</span><br><span class="line">+----------------+</span><br><span class="line">| tbl1           |</span><br><span class="line">| tbl2           |</span><br><span class="line">+----------------+</span><br><span class="line">MySQL [(none)]&gt; CREATE TABLE tbl3(id INT);</span><br><span class="line">MySQL [(none)]&gt; SHOW TABLES;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_mydb |</span><br><span class="line">+----------------+</span><br><span class="line">| tbl1           |</span><br><span class="line">| tbl2           |</span><br><span class="line">| tbl3           |</span><br><span class="line">+----------------+</span><br><span class="line"></span><br><span class="line">* 两台从节点</span><br><span class="line">MariaDB [mydb]&gt; SHOW TABLES;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_mydb |</span><br><span class="line">+----------------+</span><br><span class="line">| tbl1           |</span><br><span class="line">| tbl2           |</span><br><span class="line">| tbl3           |</span><br><span class="line">+----------------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 两个从节点都有tbl3表了。这说明上面的创建语句被路由到了主节点上，因为如果路由到了从节点上，那么也只能有一个从服务器有此表，如果两个都有，说明是复制主节点的</span></span><br><span class="line"></span><br><span class="line">* 主节点192.168.1.14</span><br><span class="line">MariaDB [(none)]&gt; SHOW PROCESSlist;</span><br><span class="line">+------+----------+--------------------+------+-------------+-------+-----------------------------------------------------------------------+------------------+----------+</span><br><span class="line">| Id   | User     | Host               | db   | Command     | Time  | State                                                                 | Info             | Progress |</span><br><span class="line">+------+----------+--------------------+------+-------------+-------+-----------------------------------------------------------------------+------------------+----------+</span><br><span class="line">|   17 | repluser | 192.168.1.15:51118 | NULL | Binlog Dump | 15388 | Master has sent all binlog to slave; waiting for binlog to be updated | NULL             |    0.000 |</span><br><span class="line">|   21 | repluser | 192.168.1.13:41342 | NULL | Binlog Dump | 14775 | Master has sent all binlog to slave; waiting for binlog to be updated | NULL             |    0.000 |</span><br><span class="line">| 6183 | root     | localhost          | NULL | Query       |     0 | NULL                                                                  | SHOW PROCESSlist |    0.000 |</span><br><span class="line">+------+----------+--------------------+------+-------------+-------+-----------------------------------------------------------------------+------------------+----------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到有几个客户端连上来了</span></span><br><span class="line">MariaDB [(none)]&gt; USE mydb</span><br><span class="line">MariaDB [mydb]&gt; SHOW TABLES;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_mydb |</span><br><span class="line">+----------------+</span><br><span class="line">| tbl1           |</span><br><span class="line">| tbl2           |</span><br><span class="line">| tbl3           |</span><br><span class="line">+----------------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 主节点上也有tbl3表</span></span><br><span class="line">[root@test ~]# tcpdump -i ens33 -nn -vv port 3306</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听3306端口，这时可以看到很多信息，是分离器的ping探测。在两个从节点和主节点上做此操作</span></span><br><span class="line"></span><br><span class="line">* 分离器192.168.1.10</span><br><span class="line">[root@test ~]# mysql -uadmin -padmin -hlocalhost -S /tmp/proxysql_admin.sock </span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line">MySQL [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">| seq | name    | file                          |</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">| 0   | main    |                               |</span><br><span class="line">| 2   | disk    | /var/lib/proxysql/proxysql.db |</span><br><span class="line">| 3   | stats   |                               |</span><br><span class="line">| 4   | monitor |                               |</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">MySQL [(none)]&gt; USE monitor</span><br><span class="line">MySQL [monitor]&gt; SHOW TABLES;</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| tables                               |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| global_variables                     |</span><br><span class="line">| mysql_collations                     |</span><br><span class="line">| mysql_query_rules                    |</span><br><span class="line">| mysql_replication_hostgroups         |</span><br><span class="line">| mysql_servers                        |</span><br><span class="line">| mysql_users                          |</span><br><span class="line">| runtime_global_variables             |</span><br><span class="line">| runtime_mysql_query_rules            |</span><br><span class="line">| runtime_mysql_replication_hostgroups |</span><br><span class="line">| runtime_mysql_servers                |</span><br><span class="line">| runtime_mysql_users                  |</span><br><span class="line">| runtime_scheduler                    |</span><br><span class="line">| scheduler                            |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">MySQL [monitor]&gt; SELECT * FROM mysql_users;</span><br><span class="line">+----------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span><br><span class="line">| username | password | active | use_ssl | default_hostgroup | default_schema | schema_locked | transaction_persistent | fast_forward | backend | frontend | max_connections |</span><br><span class="line">+----------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span><br><span class="line">| myadmin  | mypass   | 1      | 0       | 0                 | mydb           | 0             | 0                      | 0            | 1       | 1        | 10000           |</span><br><span class="line">+----------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只要向这个表中加入数据，定义好信息，就可以实现运行时修改主从节点的主机了</span></span><br><span class="line">MySQL [monitor]&gt; SELECT * FROM runtime_mysql_replication_hostgroups;</span><br><span class="line">+------------------+------------------+-------------+</span><br><span class="line">| writer_hostgroup | reader_hostgroup | comment     |</span><br><span class="line">+------------------+------------------+-------------+</span><br><span class="line">| 0                | 1                | test repl 1 |</span><br><span class="line">+------------------+------------------+-------------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示读写组的编号</span></span><br><span class="line">MySQL [monitor]&gt; select * from mysql_servers;</span><br><span class="line">+--------------+--------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname     | port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+--------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 0            | 192.168.1.14 | 3306 | ONLINE | 1      | 0           | 200             | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.1.15 | 3306 | ONLINE | 1      | 0           | 500             | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.1.13 | 3306 | ONLINE | 1      | 0           | 500             | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+--------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">MySQL [monitor]&gt; UPDATE mysql_servers SET hostgroup_id=0 WHERE hostname='192.168.1.13';</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其他库也支持运行时修改</span></span><br></pre></td></tr></table></figure>
<h3 id="MHA"><a href="#MHA" class="headerlink" title="MHA"></a>MHA</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当主节点故障时，将从节点提升为主节点</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以上面四台主机为基础，在分离器上安装MHA，一台主节点，两台从节点</span></span><br><span class="line"></span><br><span class="line">* 主节点192.168.1.14</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_file_per_table=ON</span><br><span class="line">skip_name_resolve=ON</span><br><span class="line">server_id=1</span><br><span class="line">log-bin=master-log</span><br><span class="line">relay_log=relay-log</span><br><span class="line">[root@test ~]# systemctl start mariadb</span><br><span class="line"></span><br><span class="line">* 两个从节点192.168.1.13、192.168.1.15</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_file_per_table=ON</span><br><span class="line">skip_name_resolve=ON</span><br><span class="line">server_id=11</span><br><span class="line">log-bin=master-log</span><br><span class="line">relay_log=relay-log</span><br><span class="line">relay_log_purge=0</span><br><span class="line">read_only=ON</span><br><span class="line">[root@test ~]# systemctl start mariadb</span><br><span class="line"></span><br><span class="line">* 主节点192.168.1.14</span><br><span class="line">[root@test ~]# ssh-keygen -t rsa -P ''</span><br><span class="line">[root@test ~]# ssh-copy-id -i .ssh/id_rsa.pub root@192.168.1.10</span><br><span class="line">[root@test ~]# ssh-copy-id -i .ssh/id_rsa.pub root@192.168.1.13</span><br><span class="line">[root@test ~]# ssh-copy-id -i .ssh/id_rsa.pub root@192.168.1.14</span><br><span class="line">[root@test ~]# ssh-copy-id -i .ssh/id_rsa.pub root@192.168.1.15</span><br><span class="line">[root@test ~]# scp -p .ssh/* 192.168.1.10:/root/.ssh</span><br><span class="line">[root@test ~]# scp -p .ssh/* 192.168.1.13:/root/.ssh</span><br><span class="line">[root@test ~]# scp -p .ssh/* 192.168.1.15:/root/.ssh</span><br><span class="line"></span><br><span class="line">* 分离器192.168.1.10</span><br><span class="line">下载mha4mysql-manager-0.56.0.el6.noarch.rpm mha4mysql-node-0.56-0.el6.noarch.rpm</span><br><span class="line">[root@test ~]# yum install mha4mysql-manager-0.56-0.el6.noarch.rpm mha4mysql-node-0.56-0.el6.noarch.rpm</span><br><span class="line">[root@test ~]# scp mha4mysql-node-0.56-0.el6.noarch.rpm 192.168.1.13:/root</span><br><span class="line">[root@test ~]# scp mha4mysql-node-0.56-0.el6.noarch.rpm 192.168.1.14:/root</span><br><span class="line">[root@test ~]# scp mha4mysql-node-0.56-0.el6.noarch.rpm 192.168.1.15:/root</span><br><span class="line"></span><br><span class="line">* 三个节点192.168.1.13、192.168.1.14、192.168.1.15</span><br><span class="line">[root@test ~]# yum install -y mha4mysql-node-0.56-0.el6.noarch.rpm</span><br><span class="line"></span><br><span class="line">* 主节点192.168.1.14</span><br><span class="line">GRANT ALL ON *.* TO 'mhaadmin'@'172.16.0.%' IDENTIFIED BY 'mhapass';</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个mha连接mysql的用户，用上面主从复制中创建的用户也可以</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">* 分离器192.168.1.10</span><br><span class="line">[root@test ~]# mkdir /etc/masterha</span><br><span class="line">[root@test ~]# vim /etc/masterha/app1.cnf</span><br><span class="line">[server default]</span><br><span class="line">user=mhaadmin</span><br><span class="line">password=mhapass</span><br><span class="line">manager_workdir=/data/masterha/app1</span><br><span class="line">manager_log=/data/masterha/app1/manager.log</span><br><span class="line">remote_workdir=/data/masterha/app1</span><br><span class="line">ssh_user=root</span><br><span class="line">repl_user=repladmin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 有复制权限的用户名和密码</span></span><br><span class="line">repl_password=replpass</span><br><span class="line">ping_interval=1</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=192.168.1.14</span><br><span class="line">candidate_master=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否可以被选为主节点，1为可以</span></span><br><span class="line">[server2]</span><br><span class="line">hostname=192.168.1.15</span><br><span class="line">candidate_master=1</span><br><span class="line"></span><br><span class="line">[server3]</span><br><span class="line">hostname=192.168.1.13</span><br><span class="line">candidate_master=1</span><br><span class="line">[root@test ~]# masterha_check_ssh --conf=/etc/masterha/app1.cnf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试基于密钥认证是否可以连接主机，后面指明配置文件。如果没问题会显示OK</span></span><br><span class="line">[root@test ~]# masterha_check_repl --conf=/etc/masterha/app1.cnf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检测主节点和从节点是否正常，这里提示从节点没有repladmin用户，如果提升为主节点会有问题。所以复制时最好看一下主节点(SHOW MASTER STATUS;)日志状态，再创建用户，之后从节点从创建用户之前的日志位置开始复制，就没问题了。</span></span><br><span class="line"></span><br><span class="line">* 主节点192.168.1.14</span><br><span class="line">GRANT REPLICATION CLIENT,REPLICATION SLAVE ON *.* TO 'repladmin'@'172.16.0.%' IDENTIFIED BY 'replpass';</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">* 分离器192.168.1.10</span><br><span class="line">[root@test ~]# masterha_check_repl --conf=/etc/masterha/app1.cnf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再检查就OK了。</span></span><br><span class="line">[root@test ~]# nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;&gt;&gt; /data/masterha/app1/manager.log &amp;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动监控，如果主节点故障就切换，切换后这个进程会关闭，需手动启动</span></span><br><span class="line">[root@test ~]# ps aux</span><br><span class="line"><span class="meta">#</span><span class="bash"> 有perl /usr/bin/masterha_manager --conf=/etc/masterha/app1.cnf一条</span></span><br><span class="line">[root@test ~]# masterha_check_status --conf=/etc/masterha/app1.cnf</span><br><span class="line">app1 (pid:2793) is running(0:PING_OK), master:192.168.1.14</span><br><span class="line"><span class="meta">#</span><span class="bash"> //检查集群是否有问题，提示主节点是192.168.1.14</span></span><br><span class="line"></span><br><span class="line">* 主节点192.168.1.14</span><br><span class="line">[root@test ~]# systemctl stop mariadb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭mariadb服务。测试从节点是否会提升为主节点</span></span><br><span class="line"></span><br><span class="line">* 分离器192.168.1.10</span><br><span class="line">[root@test ~]# ps aux</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的nohup启动的masterha_manager进程没有了，完成切换这个进程就会终止。显示：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">“[1]+  完成                  nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;&gt;/data/masterha/app1/manager.log”</span></span><br><span class="line">[root@test ~]# less /data/masterha/app1/manager.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看日志，最后有Failover Report故障转移报告，提示主节点已改为192.168.1.15，并修改了从服务器的配置</span></span><br><span class="line"></span><br><span class="line">* 节点192.168.1.15</span><br><span class="line">[root@test ~]# mysqldump -uroot -x -R -E --triggers --master-data=2 --all-databases -p &gt; alldb.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 完全备份</span></span><br><span class="line">[root@test ~]# scp alldb.sql 192.168.1.14:/root</span><br><span class="line"></span><br><span class="line">* 节点192.168.1.14</span><br><span class="line">[root@test ~]# rm -rf /var/lib/mysql/* </span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">[msyqld]</span><br><span class="line">innodb_file_per_table=ON</span><br><span class="line">skip_name_resolve=ON</span><br><span class="line">server_id=1</span><br><span class="line">relay_log_purge=0</span><br><span class="line">read_only=1</span><br><span class="line">log-bin=master-log</span><br><span class="line">relay_log=relay-log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入两条配置</span></span><br><span class="line">[root@test ~]# systemctl start mariadb</span><br><span class="line">[root@test ~]# mysql &lt; alldb.sql</span><br><span class="line">[root@test ~]# head -30 alldb.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看CHANGE MASTER TO一行master-log的文件名和位置</span></span><br><span class="line">[root@test ~]# mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为是重新初始化的mariadb，所以没有密码，与主节点同步后就会有密码了</span></span><br><span class="line">CHANGE MASTER TO MASTER_HOST='192.168.1.15',MASTER_USER='repladmin',MASTER_PASSWORD='replpass',MASTER_LOG_FILE='master-log.000001',MASTER_LOG_POS=633;</span><br><span class="line">START SLAVE;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动线程，这样就修复好了。</span></span><br><span class="line">SHOW SLAVE STATUS\G</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看时有报错，提示<span class="string">"Slave_SQL_Running:No"</span>。解决方法如下：</span></span><br><span class="line">=======================================================================================</span><br><span class="line">方法一</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> stop slave ;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> GLOBAL SQL_SLAVE_SKIP_COUNTER=1;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在主从库维护中，有时候需要跳过某个无法执行的命令，需要在slave处于stop状态下，执行 <span class="built_in">set</span> global sql_slave_skip_counter=N以跳过命令。常用的且不易用错的是N=1的情况</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> start slave ;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line"></span><br><span class="line">方法二</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> stop slave ;</span></span><br><span class="line">到主服务器上查看主机状态，记录File和Position对应的值</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">'192.168.1.15'</span>,MASTER_USER=<span class="string">'repladmin'</span>,MASTER_PASSWORD=<span class="string">'replpass'</span>,MASTER_LOG_FILE=<span class="string">'master-log.000001'</span>,MASTER_LOG_POS=633;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> start slave ;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line">=======================================================================================</span><br><span class="line"></span><br><span class="line">* 分离器192.168.1.10</span><br><span class="line">[root@test ~]# masterha_check_repl --conf=/etc/masterha/app1.cnf</span><br><span class="line">[root@test ~]# nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;&gt;&gt; /data/masterha/app1/manager.log &amp;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 地址转移后，这个进程就会关闭，需要手动再启动</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/04/mysql日志/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/04/mysql日志/" itemprop="url">
                  mysql日志
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-01-04 15:36:41" itemprop="dateCreated datePublished" datetime="2019-01-04T15:36:41+08:00">2019-01-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-01-07 12:42:24" itemprop="dateModified" datetime="2019-01-07T12:42:24+08:00">2019-01-07</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="錯誤日志"><a href="#錯誤日志" class="headerlink" title="錯誤日志"></a>錯誤日志</h4><blockquote>
<ul>
<li>錯誤日志記錄內容<ol>
<li>服務器啟動和關閉過程中的信息</li>
<li>服務器運行過程中的錯誤信息</li>
<li>事件調度器運行一個事件時產生的信息</li>
<li>在從服務器上啟動從服務器進程時產生的信息</li>
</ol>
</li>
</ul>
<p>默認mysql不啟用任何日志功能，一般啟動錯誤日志，默認放在數據目錄中，以當前主機名加.err為後綴名的文件；log_error</p>
<p>log_warnings警告信息日志，是否把警告信息記入錯誤日志，服務器上默認是記入的（0是不記，1是記）；mysql中的文件操作要在重啟服務器後生效，我們要把改變內容寫入配置文件。这里的log_warnings改变没有关系</p>
</blockquote>
<h3 id="一般查詢日志"><a href="#一般查詢日志" class="headerlink" title="一般查詢日志"></a>一般查詢日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 一般關閉，記錄每條查詢會產生大量IO</span></span><br><span class="line"></span><br><span class="line">general_log               </span><br><span class="line"><span class="meta">#</span><span class="bash"> 表示是否啟用查詢日志</span></span><br><span class="line"></span><br><span class="line">general_log_file        </span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志記錄位置，默認是數據目錄下本機名稱加.<span class="built_in">log</span>。</span></span><br><span class="line"></span><br><span class="line">log                              </span><br><span class="line"><span class="meta">#</span><span class="bash"> 與查詢日志相關，但在5.6中已廢棄。是否啟用記錄所有語句的日志信息於一般查詢日志中，默認是OFF</span></span><br><span class="line"></span><br><span class="line">mysql可以將一般查詢日志保存在表中，只是這個表需要手工創建。啟用此功能還需要啟用log_output，默認輸出是FILE，也可以是TABLE，或是NONE不記錄，這項會控制上面的兩項及其他日志選項。這裡的FILE和TABLE可以同時指定，用逗號隔開即可</span><br></pre></td></tr></table></figure>
<h3 id="慢查詢日志"><a href="#慢查詢日志" class="headerlink" title="慢查詢日志"></a>慢查詢日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 慢查詢日志，一般啟用，超過正常查詢的都算慢查詢</span></span><br><span class="line"></span><br><span class="line">long_query_time      </span><br><span class="line"><span class="meta">#</span><span class="bash"> 超過此項定義時間的查詢就是慢查詢。這裡的語句執行時長為實際的執行時間，而非在CPU上的執行時長。因此，負載較重的服務器上更容易產生慢查詢。其最小值為0，默認值是10，單位是秒。也支持毫秒級的解析度，作用範圍為全局或會話級別，可用於配置文件，屬動態變量</span></span><br><span class="line"></span><br><span class="line">log_slow_queries=&#123;YES|NO&#125;      </span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否記錄慢查詢。默认是OFF</span></span><br><span class="line"></span><br><span class="line">slow_query_log=&#123;ON|OFF&#125;         </span><br><span class="line"><span class="meta">#</span><span class="bash"> 設定是否啟用慢查詢日志，0或OFF表示禁用，1或ON表示啟用。日志信息的輸出位置取決於log_output變量的定義，如果其值為NONE，則即便slow_query_log為ON，也不會記錄任何慢查詢信息。作用範圍為全局級別，可用於選項文件，屬動態變量</span></span><br><span class="line"></span><br><span class="line">slow_query_log_file </span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志保存位置</span></span><br><span class="line"></span><br><span class="line">set global slow_query_log=1              </span><br><span class="line"><span class="meta">#</span><span class="bash"> 開啓慢查日志</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 操作函數開關的可以當時生效，如果是文件就要重啓服務了。</span></span><br></pre></td></tr></table></figure>
<h3 id="二進制日志"><a href="#二進制日志" class="headerlink" title="二進制日志"></a>二進制日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 二進制日志，二進制格式，任何引起或可能引起數據庫變化的操作信息都記錄，用於實現mysql復制以及即時點恢復的重要依據。mysql的復制功能就是從服務器不停地從主服務器上把它的二進制日志裡產生的任何操作，它把每個操作通過mysql客戶端、服務器端的每一個操作都讀取過來一份並保存在本地的某個日志中，而後由本地的某一個服務器的mysql線程和IO線程每一次從這個本地文件日志中讀取一行並在本地的服務器上操作一次，其中的某一個線程把日志中的內容讀取出來並在本地執行一次，使兩個數據庫一致，這就是復制。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本地保存此內容的日志叫中繼日志，中繼日志的格式與二進制的格式一樣，只不過作用並不完全一致，因為中斷日志只是要讓本地服務器執行一次的日志文件。</span></span><br><span class="line"></span><br><span class="line">* mysqlbinlog              </span><br><span class="line"><span class="meta">#</span><span class="bash"> 用此命令查詢此日志文件。mysqlbinlog的工作很獨特，這一般位於我們的數據目錄中，而且以mysql-bin開頭或以當前主機名開頭。mysql服務器每重啟一次，它都會滾動一次，因為要記錄任何數據庫改變的操作。重放可以生成一模一樣的數據庫在多個位置，它是復制與即時點恢復的重要憑據。在日志文件增長到一定程度就會生成一個新的日志文件，不會讓此文件無限增長的，這就是輪動。不要將此日志與數據庫放在一個磁盤上，這可以在數據丟失時進行重放，指定從某個時間進行還原，這就是即時點恢復</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 二進制日志的記錄格式可以是基於語句statement也可基於行row，還有混合方式mixed，由服務器選擇基於語句還是行。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 二進制日志事件，可以是基於行的，也可能是基於語句的，而每一個事件在記錄時的格式是1、事件產生時間；2、每個事件在日志中有一個相對位置。日志文件中有一個文件頭，一般要佔107個字節，記錄日志產生的信息，之後就是事件的內容了，每個事件有一個相對的位置叫position，起始時間starttime，恢復時可指定事件開始時間或位置與結束時間或位置定位。名字一般是mysql-bin.00001之後以此類推，老的文件名是不會改變的</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 二進制日志文件組成有索引文件與二進制日志文件，啟動此功能就會有二進制日志文件，mysql-bin.index是索引文件，記錄了已產生的二進制日志文件名，在其中有指針記錄開始與結束文件，結束文件一般是當前使用的。用命令SHOW MASTER STATUS;可查看當前使用的文件，在結果顯示中的Position表示上次事件結束的位置。使用命令SHOW BINLOG EVENTS IN <span class="string">'mysql-bin.000005'</span>;可查看二進制文件中記錄的信息，或SHOW BINLOG EVENTS IN <span class="string">'mysql-bin.000005'</span> FROM 107;指定從哪個位置開始顯示</span></span><br><span class="line"></span><br><span class="line">* 二進制日志相關的幾個選項</span><br><span class="line">innodb_support_xa=&#123;TRUE|FLASE&#125;              </span><br><span class="line"><span class="meta">#</span><span class="bash"> 定義innodb是否支持分布式事務。存儲引擎事務在存儲引擎內部被賦予了ACID屬性，分布式（XA）事務是一種高層次的事務，它能將InnoDB分爲兩段式提交，它利用“准備”然後“提交”（prepare-then-commit）；現在的存儲引擎都應支持此項功能，建議啓用起來</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 兩段式的方式將ACID屬性擴展到存儲引擎外部，甚至是數據庫外部，然而，“准備”階段會導致額外的磁盤刷寫操作，XA需要事務協調員，它會通知所有的參與者准備提交事務（階段1），當協調員從所有參與者那裡收到“就緒”信息時，它會指示所有參與者進行真正的“提交”操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此變量正是用於定義InnoDB是否支持兩段式提交的分布式事務，默認為啟用。事實上，所有啟用了二進制日志的並支持多個線程同時向二進制日志寫入數據的Mysql服務器都需要啟用分佈式事務，否則，多個線程對二進制日誌的寫入操作可能會以與次序不同的方式完成，這將會在基於二進制日誌的恢復操作中或者是從服務器上創建出不同原始數據的結果，因此，除了僅有一個線程可以改變數據以外的其它應用場景都不應該禁用此功能。而在僅有一個線程可以修改數據的應用中，禁用此功能是安全的並可以提升InnoDB表的性能。作用範圍為全局和會話級別，可用於選項文件，屬動態變量。</span></span><br><span class="line"></span><br><span class="line">sync_binlog=#</span><br><span class="line"><span class="meta">#</span><span class="bash"> 設定多久同步一次二進制日志至磁盤文件中，0表示不同步，任何正數值都表示對二進制每多少次寫操作之後同步一次。當autocommit的值為1時，每條語句的執行都會引起二進制日志同步，否則，每個事務的提交會引起二進制日志同步。一般建議把此項設為1。這樣可使我們在備份時不會有那些正在寫入的事務。打開此項會使二進制日志在寫入的時候以安全的方式進行。FLUSH LOGS執行後會打開一個新的二進制日志執行寫操作，但上面的方法更好一些</span></span><br></pre></td></tr></table></figure>
<h3 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">事務日志是保證給事務提供原子性、一致性的一個重要依據，它能實現將隨機IO轉換為順序IO從而提高性能，並能夠保證事務提交以後不會丟失。只有事務性引擎才會用到事務日志，如InnoDB</span><br><span class="line">mysql靠各種服務器變量或服務器啟動的參數來定義各類日志是否啟用， 以及如何啟用，日志文件是什麼。另外事務日志有一個日志組，裡面至少有兩個日志輪替使用</span><br></pre></td></tr></table></figure>
<h3 id="与日志相关的变量"><a href="#与日志相关的变量" class="headerlink" title="与日志相关的变量"></a>与日志相关的变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">SHOW GLOBAL VARIABLES LIKE '%LOG%';</span><br><span class="line"></span><br><span class="line">binlog_cache_size          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 二進制日志緩存大小，大小取決於下面這條</span></span><br><span class="line"></span><br><span class="line">binlog_stmt_cache_size        </span><br><span class="line"><span class="meta">#</span><span class="bash"> 與事務相關的二進制日志緩存大小，這兩條取決於binlog_stmt_cache_size的大小而改變，我們只關心這條即可，建議不要調太大，這會加大丟失量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> async異步：先在內存中寫，過一會兒再一並寫入磁盤</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sync同步：每次操作在內存中完成後直接寫入磁盤，這會使性能降低</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最好是引入異步方式，並提供緩存，寫操作在內存中完成並當作緩存，到一定量再同步到磁盤；可以是按時間，如每一秒與磁盤同步一次；也可以是按語句，如10條語句同步一次；還可以是按事務存儲引擎，只要提交就同步一次。</span></span><br><span class="line"></span><br><span class="line">log_bin         </span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否啟用二進制日志，與指定文件位置有關</span></span><br><span class="line"></span><br><span class="line">sql_ log_bin=&#123;ON|OFF&#125;  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否真正使用二進制日志取決於此條。用於控制二進制日志信息是否記錄進日志文件，默認為ON，表示啟用記錄功能。用戶可以在會話級別修改此變量的值，但用户必須具有SUPER權限，作用範圍為全局和會話級別，屬動態變量。</span></span><br><span class="line"></span><br><span class="line">sql_log_off=&#123;ON|OFF&#125; </span><br><span class="line"><span class="meta">#</span><span class="bash"> 用於控制是否禁止將一般查詢日志類信息記錄進查詢日志文件，默認為OFF，表示不禁止記錄功能。用戶可以在會話級別修改此變量的值，但用户必須具有SUPER權限。作用範圍為全局和會話級別，屬動態變量。與二進制日志無關</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">max_binlog_cache_size                            </span><br><span class="line">max_binlog_stmt_cache_size            </span><br><span class="line"><span class="meta">#</span><span class="bash"> 這兩個值一般不用修改，這是控制上限的。最終緩存大小還是取決於binlog_stmt_cache_size</span></span><br><span class="line"></span><br><span class="line">expire_logs_days            </span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志的過期天數</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> innodb_file_per_table的值為ON就會給每個表創建一個表空間了，這就可以使用innodb的一些高級功能了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 中繼日志:從主服務器的二進制日志文件中復制而來的事件，並保存的日志文件。這是從服務器上的信息。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 因爲二進制日志文件只有一個，所以二進制日志文件所在磁盤性能越好，IO能力越強，服務器的整體性能越強。如用一堆SSD盤作RAID。mysql為提高性能會盡可能提高並發能力，如有多個CPU就可以同時多線程操作，但寫入二進制日志文件時，因為日志文件只有一個，故需要此日志文件所在磁盤IO能力更強</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IOPS：IO設備每秒執行的IO操作數</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 事務日志是確保事務安全性的重要工具。事務性存儲引擎用於保證原子性、一致性、隔離性和持久性</span></span><br><span class="line"></span><br><span class="line">innodb_flush_log_at_trx_commit        </span><br><span class="line"><span class="meta">#</span><span class="bash"> flush_log的行為，flush_log就是將內存中的日志事件同步到日志文件中的行為。日志文件到磁盤的同步是mysql後台線程自動進行的。這裡的1表示每當有事務提交或每隔1秒都會向磁盤寫一次。2表示每事務提交才同步；0表示每秒同步一次並執行磁盤flush操作（flush操作指告訴內核不在內核中緩存直接寫到磁盤上去）；1表示每事務同步，並執行磁盤flush操作；2表示每事務同步，但不執行磁盤flush操作。</span></span><br><span class="line"></span><br><span class="line">innodb_log_buffer_size         </span><br><span class="line"><span class="meta">#</span><span class="bash"> 內存緩存大小</span></span><br><span class="line"></span><br><span class="line">innodb_log_file_size              </span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志文件大小，估計一下五分鍾會產生多少事務操作，有多大數據量，然後給它一個值即可</span></span><br><span class="line"></span><br><span class="line">innodb_log_files_in_group           </span><br><span class="line"><span class="meta">#</span><span class="bash"> 事務日志組有幾個文件，默認是兩個，一個寫滿就寫另一個，寫滿的將數據同步到磁盤</span></span><br><span class="line"></span><br><span class="line">innodb_log_group_home_dir             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志組所在目錄，叫ib_logfile*，建議給事務日志做一個鏡像。在不同的磁盤上</span></span><br><span class="line"></span><br><span class="line">innodb_mirrored_log_groups             </span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否給日志組做鏡像</span></span><br></pre></td></tr></table></figure>
<h3 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 存放在同一塊磁盤上会使性能降低，更因為數據安全的原因，建議分開存放</span></span><br><span class="line"></span><br><span class="line">语法</span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看當前服務器能識別的二進制日志有哪些</span></span><br><span class="line"></span><br><span class="line">SHOW MASTER STATUS;    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看當前使用的二進制日志</span></span><br><span class="line"></span><br><span class="line">SHOW BINLOG EVENTS IN '二進制日志文件' [FROM 'position'];</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看某個文件中的事件</span></span><br><span class="line"></span><br><span class="line">PURGE BINARY LOGS TO '日志文件';</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除某個日志之前的日志</span></span><br><span class="line"></span><br><span class="line">FLUSH LOGS;   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 手動滾動二進制日志文件</span></span><br></pre></td></tr></table></figure>
<h3 id="启动二进制日志功能"><a href="#启动二进制日志功能" class="headerlink" title="启动二进制日志功能"></a>启动二进制日志功能</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# systemctl stop mysql</span><br><span class="line">[root@test ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log_bin = mysql_bin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入此项</span></span><br><span class="line">[root@test ~]# systemctl start mysql</span><br><span class="line">[root@test ~]# mysql</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW GLOBAL VARIABLES LIKE <span class="string">'sql_log_bin'</span>;</span></span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| sql_log_bin   | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果此项为ON，表示开启了二进制日志</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW BINARY LOGS;</span></span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql_bin.000001 |       120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line"></span><br><span class="line">[[root@test ~]# mysqlbinlog /var/lib/mysql/mysql_bin.000001</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;</span><br><span class="line">/*!40019 SET @@session.max_insert_delayed_threads=0*/;</span><br><span class="line">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;</span><br><span class="line">DELIMITER /*!*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> at 4</span></span><br><span class="line"><span class="meta">#</span><span class="bash">190104 15:41:52 server id 1  end_log_pos 120 CRC32 0x2b1c1f39  Start: binlog v 4, server v 5.6.42-log created 190104 15:41:52 at startup</span></span><br><span class="line">ROLLBACK/*!*/;</span><br><span class="line">BINLOG '</span><br><span class="line">QA4vXA8BAAAAdAAAAHgAAAAAAAQANS42LjQyLWxvZwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAABADi9cEzgNAAgAEgAEBAQEEgAAXAAEGggAAAAICAgCAAAACgoKGRkAATkf</span><br><span class="line">HCs=</span><br><span class="line">'/*!*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> at 120</span></span><br><span class="line"><span class="meta">#</span><span class="bash">190104 15:52:41 server id 1  end_log_pos 167 CRC32 0x7f00ec56  Rotate to mysql_bin.000002  pos: 4</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="meta">#</span><span class="bash"> End of <span class="built_in">log</span> file</span></span><br><span class="line">ROLLBACK /* added by mysqlbinlog */;</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> /var/lib/mysql是数据库的路径</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# mysqlbinlog --start-position=120 --stop-position=167 /var/lib/mysql/mysql_bin.000001</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;</span><br><span class="line">/*!40019 SET @@session.max_insert_delayed_threads=0*/;</span><br><span class="line">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;</span><br><span class="line">DELIMITER /*!*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> at 4</span></span><br><span class="line"><span class="meta">#</span><span class="bash">190104 15:41:52 server id 1  end_log_pos 120 CRC32 0x2b1c1f39  Start: binlog v 4, server v 5.6.42-log created 190104 15:41:52 at startup</span></span><br><span class="line">ROLLBACK/*!*/;</span><br><span class="line">BINLOG '</span><br><span class="line">QA4vXA8BAAAAdAAAAHgAAAAAAAQANS42LjQyLWxvZwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAABADi9cEzgNAAgAEgAEBAQEEgAAXAAEGggAAAAICAgCAAAACgoKGRkAATkf</span><br><span class="line">HCs=</span><br><span class="line">'/*!*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> at 120</span></span><br><span class="line"><span class="meta">#</span><span class="bash">190104 15:52:41 server id 1  end_log_pos 167 CRC32 0x7f00ec56  Rotate to mysql_bin.000002  pos: 4</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="meta">#</span><span class="bash"> End of <span class="built_in">log</span> file</span></span><br><span class="line">ROLLBACK /* added by mysqlbinlog */;</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看位置從120到167</span></span><br><span class="line">[root@test ~]# mysqlbinlog --start-datetime='2019-01-04 15:41:52' /var/lib/mysql/mysql_bin.000001</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;</span><br><span class="line">/*!40019 SET @@session.max_insert_delayed_threads=0*/;</span><br><span class="line">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;</span><br><span class="line">DELIMITER /*!*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> at 4</span></span><br><span class="line"><span class="meta">#</span><span class="bash">190104 15:41:52 server id 1  end_log_pos 120 CRC32 0x2b1c1f39  Start: binlog v 4, server v 5.6.42-log created 190104 15:41:52 at startup</span></span><br><span class="line">ROLLBACK/*!*/;</span><br><span class="line">BINLOG '</span><br><span class="line">QA4vXA8BAAAAdAAAAHgAAAAAAAQANS42LjQyLWxvZwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAABADi9cEzgNAAgAEgAEBAQEEgAAXAAEGggAAAAICAgCAAAACgoKGRkAATkf</span><br><span class="line">HCs=</span><br><span class="line">'/*!*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> at 120</span></span><br><span class="line"><span class="meta">#</span><span class="bash">190104 15:52:41 server id 1  end_log_pos 167 CRC32 0x7f00ec56  Rotate to mysql_bin.000002  pos: 4</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="meta">#</span><span class="bash"> End of <span class="built_in">log</span> file</span></span><br><span class="line">ROLLBACK /* added by mysqlbinlog */;</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令中的日期一定要使用****-**-**这样的格式，不然会报错：<span class="string">"Incorrect date and time argument"</span>，日期和时间参数不正确。</span></span><br><span class="line"></span><br><span class="line">[root@test ~]# mysqlbinlog --start-datetime='2019-01-04 15:41:52' /var/lib/mysql/mysql_bin.000001 &gt; abc.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 將結果重定向到一個.sql文件中，之後可導入mysql執行一次，這就是即時點恢復</span></span><br><span class="line"></span><br><span class="line">* 二進制日志的輪動除重啟服務器外還可以用FLUSH LOGS;来實現，這是在主服務器上，如果是從服務器就是中繼服務器才滾動</span><br><span class="line">* 二進制日志文件不能手動刪除，會影響mysql服務器啟動。要用mysql命令</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> PURGE BINARY LOGS TO <span class="string">'mysql_bin.000002'</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 刪除000002以前的二進制文件。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">137</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">104</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
