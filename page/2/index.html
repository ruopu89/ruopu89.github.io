<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/2/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/29/python基础学习-WEB框架之路由进阶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/29/python基础学习-WEB框架之路由进阶/" itemprop="url">
                  python基础学习-WEB框架之路由进阶
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-10-29 15:37:23" itemprop="dateCreated datePublished" datetime="2020-10-29T15:37:23+08:00">2020-10-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-11-17 09:36:31" itemprop="dateModified" datetime="2020-11-17T09:36:31+08:00">2020-11-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="类Flask框架实现"><a href="#类Flask框架实现" class="headerlink" title="类Flask框架实现"></a>类Flask框架实现</h1><h2 id="路由分组"><a href="#路由分组" class="headerlink" title="路由分组**"></a>路由分组**</h2><p>所谓路由分组，就是按照前缀分别映射。<br>需求<br>URL为/product/123456<br>需要将产品ID提取出来<br>分析<br>这个URL可以看做是一级分组路由，生成环境中够用了。<br>例如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">product = Router(<span class="string">'/product'</span>) <span class="comment"># 匹配前缀/product，每一个路由实例保存一个前缀</span></span><br><span class="line">product.get(<span class="string">'/(?P&lt;id&gt;\d+)'</span>) <span class="comment"># 匹配路径为/product/123456，路由实例再管理第二级匹配</span></span><br></pre></td></tr></table></figure>
<p>常见的一级目录<br>/admin 后台管理<br>/product 产品<br>这些目录都是 / 根目录下的第一级，暂且称为前缀prefix</p>
<blockquote>
<p>  前缀要求必须以 / 开头，但不能以分隔符结尾</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面的定义方法已经不能描述prefix和URL之间的隶属关系</span></span><br><span class="line"><span class="meta">@Router.get(r'^/$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request: Request)</span>:</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Router.route('^/python$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showpython</span><span class="params">(request: Request)</span>:</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>如何建立prefix和URL之间的隶属关系?<br>一个Prefix下可以有若干个URL，这些URL都是属于这个Prefix的。<br>不同前缀对应不同的Router实例管理，所有路由注册方法，都成了实例的方法，路由表实例自己管理。<br>App中需要保存不同前缀的Router实例，提供注册方法，把Router对象被管理起来。<br><code>__call__</code>方法依然是WSGI回调入口，在其中遍历所有Router实例，将路径匹配代码全部挪到Router中并新建一个match方法。<br>match方法匹配就返回Response对象，否则返回None。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">from</span> webob.exc <span class="keyword">import</span> HTTPNotFound</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, prefix:str=<span class="string">''</span>)</span>:</span></span><br><span class="line">        self.__prefix = prefix.rstrip(<span class="string">'/\\'</span>) <span class="comment"># 前缀,例如/product</span></span><br><span class="line">        self.__routetable = [] <span class="comment"># 存三元组,列表,有序的</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, pattern, *methods)</span>:</span> <span class="comment"># 注册路由,装饰器</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            self.__routetable.append((tuple(map(<span class="keyword">lambda</span> x: x.upper(), methods)),re.compile(pattern), handler)) <span class="comment"># (方法元组，预编译正则对象，处理函数)</span></span><br><span class="line">            <span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self.route(pattern, <span class="string">'GET'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self.route(pattern, <span class="string">'POST'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">head</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self.route(pattern, <span class="string">'HEAD'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">    	<span class="comment"># 必须先匹配前缀</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.path.startswith(self.__prefix):</span><br><span class="line">        	<span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">    	<span class="comment"># 前缀匹配,说明就必须这个Router实例处理，后续匹配不上，依然返回None</span></span><br><span class="line">    	<span class="keyword">for</span> methods, pattern, handler <span class="keyword">in</span> self.__routetable:</span><br><span class="line">            <span class="comment"># not methods表示一个方法都没有定义,就是支持全部方法</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> methods <span class="keyword">or</span> request.method.upper() <span class="keyword">in</span> methods:</span><br><span class="line">            <span class="comment"># 前提已经是以__prefix开头了，可以replace，去掉prefix剩下的才是正则表达式需要匹配的路径</span></span><br><span class="line">                matcher = pattern.match(request.path.replace(self.__prefix, <span class="string">''</span>, <span class="number">1</span>))</span><br><span class="line">                <span class="keyword">if</span> matcher: <span class="comment"># 正则匹配</span></span><br><span class="line">                    <span class="comment"># 动态为request增加属性</span></span><br><span class="line">                    request.groups = matcher.groups() <span class="comment"># 所有分组组成的元组,包括命名分组</span></span><br><span class="line">                    request.groupdict = matcher.groupdict() <span class="comment"># 命名分组组成的字典</span></span><br><span class="line">                    <span class="keyword">return</span> handler(request)</span><br><span class="line">                </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line">    _ROUTERS = [] <span class="comment"># 存储所有一级Router对象</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 注册</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, *routers:Router)</span>:</span></span><br><span class="line">		<span class="keyword">for</span> router <span class="keyword">in</span> routers:</span><br><span class="line">			cls._ROUTERS.append(router)</span><br><span class="line"></span><br><span class="line"><span class="meta">	@wsgify</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">	<span class="comment"># 遍历_ROTERS，调用Router实例的match方法，看谁匹配</span></span><br><span class="line">    	<span class="keyword">for</span> router <span class="keyword">in</span> self._ROUTERS:</span><br><span class="line">			response = router.match(request)</span><br><span class="line">			<span class="keyword">if</span> response: <span class="comment"># 匹配返回非None的Router对象</span></span><br><span class="line">				<span class="keyword">return</span> response <span class="comment"># 匹配则立即返回</span></span><br><span class="line">		<span class="keyword">raise</span> HTTPNotFound(<span class="string">'&lt;h1&gt;你访问的页面被外星人劫持了&lt;/h1&gt;'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 创建Router对象</span></span><br><span class="line">idx = Router()</span><br><span class="line">py = Router(<span class="string">'/python'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册</span></span><br><span class="line">App.register(idx, py)</span><br><span class="line"></span><br><span class="line"><span class="meta">@idx.get(r'^/$')</span></span><br><span class="line"><span class="meta">@idx.route(r'^/(?P&lt;id&gt;\d+)$') # 支持所有方法访问</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(request.groups)</span><br><span class="line">    print(request.groupdict)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@py.get('^/(\w+)$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.charset = <span class="string">'utf-8'</span></span><br><span class="line">    res.body = <span class="string">'&lt;h1&gt;Welcome to Magedu Python&lt;/h1&gt;'</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, App())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	server.serve_forever() <span class="comment"># server.handle_request() 一次</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure>
<h2 id="字典访问属性化"><a href="#字典访问属性化" class="headerlink" title="字典访问属性化"></a>字典访问属性化</h2><p>这是一个技巧<br>让kwargs这个字典，不使用<code>[ ]</code>访问元素，使用<code>.</code>点号访问元素，如同属性一样访问。<br>字典转属性类，如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttrDict</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, d:dict)</span>:</span></span><br><span class="line">		self.__dict__.update(d <span class="keyword">if</span> isinstance(d, dict) <span class="keyword">else</span> &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="comment"># 不允许修改属性</span></span><br><span class="line">		<span class="keyword">raise</span> NotImplementedError</span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">"&lt;AttrDict &#123;&#125;&gt;"</span>.format(self.__dict__)</span><br><span class="line">    </span><br><span class="line">d = &#123;<span class="string">'a'</span>:<span class="number">1</span>, <span class="string">'b'</span>:<span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line">do = AttrDict(d)</span><br><span class="line">print(do.a, do.b)</span><br><span class="line">print(do.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面语句抛异常</span></span><br><span class="line">do.c = <span class="number">1</span></span><br><span class="line">do.a = <span class="number">2</span></span><br><span class="line"><span class="comment"># 下面语句可以</span></span><br><span class="line">do.__dict__[<span class="string">'c'</span>] = <span class="number">1000</span></span><br><span class="line">print(do.__dict__)</span><br></pre></td></tr></table></figure>
<p>修改Router的match方法如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttrDict</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, d:dict)</span>:</span></span><br><span class="line">        self.__dict__.update(d <span class="keyword">if</span> isinstance(d, dict) <span class="keyword">else</span> &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="comment"># 不允许修改属性</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;AttrDict &#123;&#125;&gt;"</span>.format(self.__dict__)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.__dict__)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="comment"># 必须先匹配前缀</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.path.startswith(self.__prefix):</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="comment"># 前缀匹配,说明就必须这个Router实例处理,后续匹配不上,依然返回None</span></span><br><span class="line">        <span class="keyword">for</span> methods, pattern, handler <span class="keyword">in</span> self.__routetable:</span><br><span class="line">            <span class="comment"># not methods表示一个方法都没有定义,就是支持全部方法</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> methods <span class="keyword">or</span> request.method.upper() <span class="keyword">in</span> methods:</span><br><span class="line">                <span class="comment"># 前提已经是以__prefix开头了,可以replace,去掉prefix剩下的才是正则表达式需要匹配的路径</span></span><br><span class="line">                matcher = pattern.match(request.path.replace(self.__prefix, <span class="string">''</span>, <span class="number">1</span>))</span><br><span class="line">                <span class="keyword">if</span> matcher: <span class="comment"># 正则匹配</span></span><br><span class="line">                    <span class="comment"># 动态为request增加属性</span></span><br><span class="line">                    request.groups = matcher.groups() <span class="comment"># 所有分组组成的元组,包括命名分组</span></span><br><span class="line">                    request.groupdict = AttrDict(matcher.groupdict()) <span class="comment"># 命名分组组成的字典被属性化</span></span><br><span class="line">                    <span class="keyword">return</span> handler(request)</span><br><span class="line">                </span><br><span class="line"><span class="meta">@idx.get(r'^/$')</span></span><br><span class="line"><span class="meta">@idx.route(r'^/(?P&lt;id&gt;\d+)$') # 支持所有方法访问</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(request.groups)</span><br><span class="line">    print(request.groupdict)</span><br><span class="line">    id = <span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span> request.groupdict:</span><br><span class="line">    	id = request.groupdict.id</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你&#123;&#125;. magedu.com&lt;/h1&gt;'</span>.format(id)</span><br></pre></td></tr></table></figure>
<h4 id="用点访问字典属性"><a href="#用点访问字典属性" class="headerlink" title="用点访问字典属性"></a>用点访问字典属性</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">方法一</span><br><span class="line">重写dict类的__init__方法</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDict</span><span class="params">(dict)</span>:</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 一个类里面只能有一个init方法&lt;br&gt;    #self.__dict__方法就是&lt;br&gt;用来显示类里面的属性的（函数也是类的一种属性）</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,**kwargs)</span>:</span></span><br><span class="line">        super(MyDict,self).__init__(kwargs)</span><br><span class="line">        self.__dict__ = self</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    a = MyDict(x=<span class="number">1</span>,y=<span class="number">2</span>,z=<span class="number">3</span>)</span><br><span class="line">    print(a)</span><br><span class="line">    print(a.x)</span><br><span class="line">    </span><br><span class="line">方法二</span><br><span class="line">重写dict类的__getattr__和__setattr__</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDict</span><span class="params">(dict)</span>:</span></span><br><span class="line">    <span class="comment"># 支持用.获取属性值，如d.a=1</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self[item]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self[key] = value</span><br><span class="line"></span><br><span class="line">test = MyDict()   </span><br><span class="line">test.update(x=<span class="number">1</span>)  </span><br><span class="line">print(test.x) <span class="comment"># 这里虽然可以使用test.x，但输入点以后不会有提示</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line">方法三</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dotdict</span><span class="params">(dict)</span>:</span></span><br><span class="line">    <span class="string">"""dot.notation access to dictionary attributes"""</span></span><br><span class="line">    __getattr__ = dict.get</span><br><span class="line">    __setattr__ = dict.__setitem__</span><br><span class="line">    __delattr__ = dict.__delitem__</span><br><span class="line"></span><br><span class="line">mydict = &#123;<span class="string">'val'</span>:<span class="string">'it works'</span>&#125;</span><br><span class="line">nested_dict = &#123;<span class="string">'val'</span>:<span class="string">'nested works too'</span>&#125;</span><br><span class="line">mydict = dotdict(mydict)</span><br><span class="line">mydict.val  <span class="comment"># 这里输入点后也不会有提示</span></span><br><span class="line"><span class="comment"># 'it works'</span></span><br><span class="line"></span><br><span class="line">mydict.nested = dotdict(nested_dict)</span><br><span class="line">mydict.nested.val</span><br><span class="line"><span class="comment"># 'nested works too'</span></span><br><span class="line"></span><br><span class="line">方法四</span><br><span class="line">通过dict安装dotmap</span><br><span class="line">pip install dotmap</span><br><span class="line"><span class="comment"># 它可以执行您想要的所有操作和子类dict，因此它的操作类似于普通字典：</span></span><br><span class="line"><span class="keyword">from</span> dotmap <span class="keyword">import</span> DotMap</span><br><span class="line"></span><br><span class="line">m = DotMap()</span><br><span class="line">m.hello = <span class="string">'world'</span></span><br><span class="line">m.hello</span><br><span class="line">m.hello += <span class="string">'!'</span></span><br><span class="line"><span class="comment"># m.hello and m['hello'] now both return 'world!'</span></span><br><span class="line">m.val = <span class="number">5</span></span><br><span class="line">m.val2 = <span class="string">'Sam'</span></span><br><span class="line">最重要的是，您可以将它转换为dict对象：</span><br><span class="line">d = m.toDict()</span><br><span class="line">m = DotMap(d) <span class="comment"># automatic conversion in constructor</span></span><br><span class="line">这意味着如果您要访问的内容已经是dict表单，则可以将其转换为dict以便于访问：</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">jsonDict = json.loads(text)</span><br><span class="line">data = DotMap(jsonDict)</span><br><span class="line"><span class="keyword">print</span> data.location.city</span><br><span class="line">最后，它会自动创建新的子项dict实例，以便您可以执行以下操作：</span><br><span class="line">m = DotMap()</span><br><span class="line">m.people.steve.age = <span class="number">31</span></span><br></pre></td></tr></table></figure>
<h2 id="正则表达式的简化"><a href="#正则表达式的简化" class="headerlink" title="正则表达式的简化***"></a>正则表达式的简化***</h2><p>问题<br>目前路由匹配使用正则表达式定义，不友好，很多用户不会使用正则表达式，能否简化?</p>
<p>分析<br>生产环境中，URL是规范的，不能随便书写，路径是有意义的，尤其是对restful风格。<br>所以，要对URL规范。<br>例如/product/111023564，这就是一种规范，要求第一段是业务，第二段是ID。</p>
<p>设计<br>路径规范化，如下定义<br><code>/student/{name:str}/{id:int}</code><br>类型设计，支持str、word、int、float、any类型。<br>还可以考虑一种raw类型，直接支持正则表达式，暂不考虑实现。<br>通过这样的定义，可以让用户定义简化了，也规范了，背后的转换由编程者实现。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>含义</th>
<th>对应正则</th>
</tr>
</thead>
<tbody>
<tr>
<td>str</td>
<td>不包含<code>/</code>的任意字符。默认类型</td>
<td><code>[^/]+</code></td>
</tr>
<tr>
<td>word</td>
<td>字母和数字</td>
<td><code>\w+</code></td>
</tr>
<tr>
<td>int</td>
<td>纯粹数字，正负数</td>
<td><code>[+-]?\d+</code></td>
</tr>
<tr>
<td>float</td>
<td>正负号，数字，包含<code>.</code></td>
<td><code>[+-]?\d+.\d+</code></td>
</tr>
<tr>
<td>any</td>
<td>包含<code>/</code>的任意字符</td>
<td><code>.+</code></td>
</tr>
</tbody>
</table>
<p>建立如下的映射关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 类型字符串映射到正则表达式</span></span><br><span class="line">TYPEPATTERNS = &#123;</span><br><span class="line">    <span class="string">'str'</span>  : <span class="string">r'[^/]+'</span>,</span><br><span class="line">    <span class="string">'word'</span> : <span class="string">r'\w+'</span>,</span><br><span class="line">    <span class="string">'int'</span> : <span class="string">r'[+-]?\d+'</span>,</span><br><span class="line">    <span class="string">'float'</span> : <span class="string">r'[+-]?\d+\.\d+'</span>, <span class="comment"># 严苛的要求必须是 15.6这样的形式</span></span><br><span class="line">    <span class="string">'any'</span>   : <span class="string">r'.+'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 类型字符串到Python类型的映射</span></span><br><span class="line">TYPECAST = &#123;</span><br><span class="line">    <span class="string">'str'</span>  : str,</span><br><span class="line">    <span class="string">'word'</span> : str,</span><br><span class="line">    <span class="string">'int'</span> : int,</span><br><span class="line">    <span class="string">'float'</span> : float,</span><br><span class="line">    <span class="string">'any'</span>   : str</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>/student/{name:str}/{id:int}</code>怎样转换?<br>使用<code>(\{([^\{\}]+):([^\{\}]+)\})</code> 来search整个字符串，分别找到<code>{name:str}</code>和<code>{id:int}</code>并替换成目标的正则表达式。<br>id转变为命名分组的名字，int转变为对应的正则表达式，如下<br><code>/student/{name:str}/xxx/{id:int}</code> =&gt; <code>/student/(?P&lt;name&gt;[^/]+)/xxx/(?P&lt;id&gt;[+-]?\d+)</code><br>对于 <code>/student/{name:str}</code>和 <code>/student/{name:}</code>正则表达式修改为 <code>/{([^{}:]+):?([^{}:]*)}</code><br>先看一个正则替换sub函数使用的例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">pattern = <span class="string">r'\d+'</span></span><br><span class="line">repl = <span class="string">''</span></span><br><span class="line">src = <span class="string">'welcome 123 to 456 magedu.com'</span></span><br><span class="line"></span><br><span class="line">regex = re.compile(pattern)</span><br><span class="line">dest = regex.sub(repl, src)</span><br><span class="line"></span><br><span class="line">print(dest, end=<span class="string">'----------------\n'</span>)</span><br><span class="line"></span><br><span class="line">pattern = <span class="string">r'/&#123;([^&#123;&#125;:]+):?([^&#123;&#125;:]*)&#125;'</span></span><br><span class="line">src = <span class="string">'/student/&#123;name&#125;/xxx/&#123;id:int&#125;'</span></span><br><span class="line">print(src)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repl</span><span class="params">(matcher)</span>:</span></span><br><span class="line">    print(matcher.group(<span class="number">0</span>))</span><br><span class="line">    print(matcher.group(<span class="number">1</span>))</span><br><span class="line">    print(matcher.group(<span class="number">2</span>)) <span class="comment"># &#123;name&#125;或&#123;name:&#125;这个分组都匹配为''</span></span><br><span class="line">    <span class="comment"># (?P&lt;name&gt;...)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'/(?P&lt;&#123;&#125;&gt;&#123;&#125;)'</span>.format(</span><br><span class="line">        matcher.group(<span class="number">1</span>),</span><br><span class="line">        <span class="string">'T'</span> <span class="keyword">if</span> matcher.group(<span class="number">2</span>) <span class="keyword">else</span> <span class="string">'F'</span></span><br><span class="line">    )</span><br><span class="line">regex = re.compile(pattern)</span><br><span class="line">dest = regex.sub(repl, src)</span><br><span class="line">print(dest)</span><br></pre></td></tr></table></figure>
<p>编写一个转换例程</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">regex = re.compile(<span class="string">'/&#123;([^&#123;&#125;:]+):?([^&#123;&#125;:]*)&#125;'</span>)</span><br><span class="line"></span><br><span class="line">s = [</span><br><span class="line">    <span class="string">'/student/&#123;name:str&#125;/xxx/&#123;id:int&#125;'</span>,</span><br><span class="line">    <span class="string">'/student/xxx/&#123;id:int&#125;/yyy'</span>,</span><br><span class="line">    <span class="string">'/student/xxx/5134324'</span>,</span><br><span class="line">    <span class="string">'/student/&#123;name:&#125;/xxx/&#123;id&#125;'</span>,</span><br><span class="line">    <span class="string">'/student/&#123;name:&#125;/xxx/&#123;id:aaa&#125;'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># /&#123;id:int&#125; =&gt; /(?P&lt;id&gt;[+-]?\d+)</span></span><br><span class="line"><span class="comment"># '/(?&lt;&#123;&#125;&gt;&#123;&#125;)'.format('id', TYPEPATTERNS['int'])</span></span><br><span class="line"></span><br><span class="line">TYPEPATTERNS = &#123;</span><br><span class="line">    <span class="string">'str'</span>: <span class="string">r'[^/]+'</span>,</span><br><span class="line">    <span class="string">'word'</span>: <span class="string">r'\w+'</span>,</span><br><span class="line">    <span class="string">'int'</span>: <span class="string">r'[+-]?\d+'</span>,</span><br><span class="line">    <span class="string">'float'</span>: <span class="string">r'[+-]?\d+\.\d+'</span>,</span><br><span class="line">    <span class="comment"># 严苛的要求必须是 15.6这样的形式</span></span><br><span class="line">    <span class="string">'any'</span>: <span class="string">r'.+'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repl</span><span class="params">(matcher)</span>:</span></span><br><span class="line">    <span class="comment"># print(matcher.group(0))</span></span><br><span class="line">    <span class="comment"># print(matcher.group(1))</span></span><br><span class="line">    <span class="comment"># print(matcher.group(2)) # &#123;name&#125;或&#123;name:&#125;这个分组都匹配为''</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'/(?P&lt;&#123;&#125;&gt;&#123;&#125;)'</span>.format(</span><br><span class="line">        matcher.group(<span class="number">1</span>),</span><br><span class="line">        TYPEPATTERNS.get(matcher.group(<span class="number">2</span>), TYPEPATTERNS[<span class="string">'str'</span>])</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(src:str)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> regex.sub(repl, src)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> s:</span><br><span class="line">	print(parse(x))</span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">/student/(?P&lt;name&gt;[^/]+)/xxx/(?P&lt;id&gt;[+-]?\d+)</span><br><span class="line">/student/xxx/(?P&lt;id&gt;[+-]?\d+)/yyy</span><br><span class="line">/student/xxx/<span class="number">5134324</span></span><br><span class="line">/student/(?P&lt;name&gt;[^/]+)/xxx/(?P&lt;id&gt;[^/]+)</span><br><span class="line">/student/(?P&lt;name&gt;[^/]+)/xxx/(?P&lt;id&gt;[^/]+)</span><br></pre></td></tr></table></figure>
<p>将上面的代码合入Router类中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">from</span> webob.exc <span class="keyword">import</span> HTTPNotFound</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttrDict</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, d:dict)</span>:</span></span><br><span class="line">		self.__dict__.update(d <span class="keyword">if</span> isinstance(d, dict) <span class="keyword">else</span> &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="comment"># 不允许修改属性</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> <span class="string">"&lt;AttrDict &#123;&#125;&gt;"</span>.format(self.__dict__)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> len(self.__dict__)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">	<span class="comment">############# 正则转换</span></span><br><span class="line">	__regex = re.compile(<span class="string">r'/&#123;([^&#123;&#125;:]+):?([^&#123;&#125;:]*)&#125;'</span>)</span><br><span class="line">    </span><br><span class="line">    TYPEPATTERNS = &#123;</span><br><span class="line">        <span class="string">'str'</span>: <span class="string">r'[^/]+'</span>,</span><br><span class="line">        <span class="string">'word'</span>: <span class="string">r'\w+'</span>,</span><br><span class="line">        <span class="string">'int'</span>: <span class="string">r'[+-]?\d+'</span>,</span><br><span class="line">        <span class="string">'float'</span>: <span class="string">r'[+-]?\d+\.\d+'</span>,</span><br><span class="line">        <span class="comment"># 严苛的要求必须是 15.6这样的形式</span></span><br><span class="line">        <span class="string">'any'</span>: <span class="string">r'.+'</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repl</span><span class="params">(self, matcher)</span>:</span></span><br><span class="line">        <span class="comment"># print(matcher.group(0))</span></span><br><span class="line">        <span class="comment"># print(matcher.group(1))</span></span><br><span class="line">        <span class="comment"># print(matcher.group(2)) # &#123;name&#125;或&#123;name:&#125;这个分组都匹配为''</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'/(?P&lt;&#123;&#125;&gt;&#123;&#125;)'</span>.format(</span><br><span class="line">            matcher.group(<span class="number">1</span>),</span><br><span class="line">            self.TYPEPATTERNS.get(matcher.group(<span class="number">2</span>), self.TYPEPATTERNS[<span class="string">'str'</span>])</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__parse</span><span class="params">(self, src: str)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self.__regex.sub(self.__repl, src)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">############ 实例</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, prefix:str=<span class="string">''</span>)</span>:</span></span><br><span class="line">        self.__prefix = prefix.rstrip(<span class="string">'/\\'</span>) <span class="comment"># 前缀,例如/product</span></span><br><span class="line">        self.__routetable = [] <span class="comment"># 存三元组,列表,有序的</span></span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, pattern, *methods)</span>:</span> <span class="comment"># 注册路由,装饰器</span></span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            <span class="comment"># /student/&#123;name:str&#125;/xxx/&#123;id:int&#125; =&gt;</span></span><br><span class="line">            <span class="comment"># '/student/(?P&lt;name&gt;[^/]+)/xxx/(?P&lt;id&gt;[+-]?\\d+)'</span></span><br><span class="line">			self.__routetable.append(</span><br><span class="line">                (tuple(map(<span class="keyword">lambda</span> x: x.upper(), methods)),</span><br><span class="line">                re.compile(self.__parse(pattern)), <span class="comment"># 用户输入规则转换为正则表达式并编译</span></span><br><span class="line">                handler)</span><br><span class="line">            ) <span class="comment"># (方法元组,预编译正则对象,处理函数)</span></span><br><span class="line">			<span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self.route(pattern, <span class="string">'GET'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> self.route(pattern, <span class="string">'POST'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">head</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> self.route(pattern, <span class="string">'HEAD'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="comment"># 必须先匹配前缀</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.path.startswith(self.__prefix):</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="comment"># 前缀匹配,说明就必须这个Router实例处理,后续匹配不上,依然返回None</span></span><br><span class="line">        <span class="keyword">for</span> methods, pattern, handler <span class="keyword">in</span> self.__routetable:</span><br><span class="line">            <span class="comment"># not methods表示一个方法都没有定义,就是支持全部方法</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> methods <span class="keyword">or</span> request.method.upper() <span class="keyword">in</span> methods:</span><br><span class="line">                <span class="comment"># 前提已经是以__prefix开头了,可以replace,去掉prefix剩下的才是正则表达式需要匹配的路径</span></span><br><span class="line">                matcher = pattern.match(request.path.replace(self.__prefix, <span class="string">''</span>, <span class="number">1</span>))</span><br><span class="line">					<span class="keyword">if</span> matcher: <span class="comment"># 正则匹配</span></span><br><span class="line">                        <span class="comment"># 动态为request增加属性</span></span><br><span class="line">                        request.groups = matcher.groups() <span class="comment"># 所有分组组成的元组,包括命名分组</span></span><br><span class="line">                        request.groupdict = AttrDict(matcher.groupdict()) <span class="comment"># 命名分组组成的字典被属性化</span></span><br><span class="line">                        <span class="keyword">return</span> handler(request)</span><br><span class="line">                    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line">	_ROUTERS = [] <span class="comment"># 存储所有一级Router对象</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment"># 注册</span></span><br><span class="line"><span class="meta">        @classmethod</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, *routers:Router)</span>:</span></span><br><span class="line">			<span class="keyword">for</span> router <span class="keyword">in</span> routers:</span><br><span class="line">				cls._ROUTERS.append(router)</span><br><span class="line"></span><br><span class="line"><span class="meta">		@wsgify</span></span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">            <span class="comment"># 遍历_ROTERS,调用Router实例的match方法,看谁匹配</span></span><br><span class="line">            <span class="keyword">for</span> router <span class="keyword">in</span> self._ROUTERS:</span><br><span class="line">                response = router.match(request)</span><br><span class="line">                <span class="keyword">if</span> response: <span class="comment"># 匹配返回非None的Router对象</span></span><br><span class="line">					<span class="keyword">return</span> response <span class="comment"># 匹配则立即返回</span></span><br><span class="line">			<span class="keyword">raise</span> HTTPNotFound(<span class="string">'&lt;h1&gt;你访问的页面被外星人劫持了&lt;/h1&gt;'</span>)</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 创建Router对象</span></span><br><span class="line">idx = Router()</span><br><span class="line">py = Router(<span class="string">'/python'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册</span></span><br><span class="line">App.register(idx, py)</span><br><span class="line"></span><br><span class="line"><span class="meta">@idx.get(r'^/$')</span></span><br><span class="line"><span class="meta">@idx.route(r'^/&#123;id:int&#125;$') # 支持所有方法访问</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(request.groups)</span><br><span class="line">    print(request.groupdict)</span><br><span class="line">    id = <span class="string">''</span></span><br><span class="line">	<span class="keyword">if</span> request.groupdict:</span><br><span class="line">		id = request.groupdict.id</span><br><span class="line">	<span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你&#123;&#125;. magedu.com&lt;/h1&gt;'</span>.format(id)</span><br><span class="line"></span><br><span class="line"><span class="meta">@py.get('^/&#123;id&#125;$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.charset = <span class="string">'utf-8'</span></span><br><span class="line">    res.body = <span class="string">'&lt;h1&gt;Welcome to Magedu Python&lt;/h1&gt;'</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, App())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	server.serve_forever() <span class="comment"># server.handle_request() 一次</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure>
<p>如果要增加对捕获数据的类型，使用re.sub()就不行了。重写prase函数，如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(src:str)</span>:</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    repl = <span class="string">''</span></span><br><span class="line">    types = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    matchers = regex.finditer(src)</span><br><span class="line">	<span class="keyword">for</span> i, matcher <span class="keyword">in</span> enumerate(matchers):</span><br><span class="line">        name = matcher.group(<span class="number">1</span>)</span><br><span class="line">        t = matcher.group(<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        types[name] = TYPECAST.get(matcher.group(<span class="number">2</span>), str)</span><br><span class="line">        </span><br><span class="line">        repl += src[start:matcher.start()] <span class="comment"># 拼接分组前</span></span><br><span class="line">        tmp = <span class="string">'/(?P&lt;&#123;&#125;&gt;&#123;&#125;)'</span>.format(</span><br><span class="line">            matcher.group(<span class="number">1</span>),</span><br><span class="line">            TYPEPATTERNS.get(matcher.group(<span class="number">2</span>), TYPEPATTERNS[<span class="string">'str'</span>])</span><br><span class="line">        )</span><br><span class="line">        repl += tmp <span class="comment"># 替换</span></span><br><span class="line">        start = matcher.end() <span class="comment"># 移动</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		repl += src[start:] <span class="comment"># 拼接分组后的内容</span></span><br><span class="line">	<span class="keyword">return</span> repl, types</span><br></pre></td></tr></table></figure>
<p>由此，重新修改源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">from</span> webob.exc <span class="keyword">import</span> HTTPNotFound</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttrDict</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, d:dict)</span>:</span></span><br><span class="line">    	self.__dict__.update(d <span class="keyword">if</span> isinstance(d, dict) <span class="keyword">else</span> &#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="comment"># 不允许修改属性</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> <span class="string">"&lt;AttrDict &#123;&#125;&gt;"</span>.format(self.__dict__)</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> len(self.__dict__)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    <span class="comment">############# 正则转换</span></span><br><span class="line">    __regex = re.compile(<span class="string">r'/&#123;([^&#123;&#125;:]+):?([^&#123;&#125;:]*)&#125;'</span>)</span><br><span class="line">    </span><br><span class="line">    TYPEPATTERNS = &#123;</span><br><span class="line">        <span class="string">'str'</span>: <span class="string">r'[^/]+'</span>,</span><br><span class="line">        <span class="string">'word'</span>: <span class="string">r'\w+'</span>,</span><br><span class="line">        <span class="string">'int'</span>: <span class="string">r'[+-]?\d+'</span>,</span><br><span class="line">        <span class="string">'float'</span>: <span class="string">r'[+-]?\d+\.\d+'</span>,  <span class="comment"># 严苛的要求必须是 15.6这样的形式</span></span><br><span class="line">        <span class="string">'any'</span>: <span class="string">r'.+'</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    TYPECAST = &#123;</span><br><span class="line">        <span class="string">'str'</span>: str,</span><br><span class="line">        <span class="string">'word'</span>: str,</span><br><span class="line">        <span class="string">'int'</span>: int,</span><br><span class="line">        <span class="string">'float'</span>: float,</span><br><span class="line">        <span class="string">'any'</span>: str</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__parse</span><span class="params">(self, src: str)</span>:</span></span><br><span class="line">        start = <span class="number">0</span></span><br><span class="line">        repl = <span class="string">''</span></span><br><span class="line">        types = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">		matchers = self.__regex.finditer(src)</span><br><span class="line">		<span class="keyword">for</span> i, matcher <span class="keyword">in</span> enumerate(matchers):</span><br><span class="line">            name = matcher.group(<span class="number">1</span>)</span><br><span class="line">            t = matcher.group(<span class="number">2</span>)</span><br><span class="line">            </span><br><span class="line">            types[name] = self.TYPECAST.get(matcher.group(<span class="number">2</span>), str)</span><br><span class="line">            </span><br><span class="line">            repl += src[start:matcher.start()]    <span class="comment"># 拼接分组前</span></span><br><span class="line">            tmp = <span class="string">'/(?P&lt;&#123;&#125;&gt;&#123;&#125;)'</span>.format(</span><br><span class="line">                matcher.group(<span class="number">1</span>),</span><br><span class="line">                self.TYPEPATTERNS.get(matcher.group(<span class="number">2</span>), self.TYPEPATTERNS[<span class="string">'str'</span>])</span><br><span class="line">            )</span><br><span class="line">            repl += tmp     <span class="comment"># 替换</span></span><br><span class="line">            </span><br><span class="line">            start = matcher.end()    <span class="comment"># 移动</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">            repl += src[start:]      <span class="comment"># 拼接分组后的内容</span></span><br><span class="line">            </span><br><span class="line">		<span class="keyword">return</span> repl, types</span><br><span class="line">    </span><br><span class="line">    <span class="comment">############ 实例</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, prefix:str=<span class="string">''</span>)</span>:</span></span><br><span class="line">        self.__prefix = prefix.rstrip(<span class="string">'/\\'</span>) <span class="comment"># 前缀,例如/product</span></span><br><span class="line">        self.__routetable = [] <span class="comment"># 存四元组,列表,有序的</span></span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, rule, *methods)</span>:</span> <span class="comment"># 注册路由,装饰器</span></span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            <span class="comment"># /student/&#123;name:str&#125;/xxx/&#123;id:int&#125; =&gt;</span></span><br><span class="line">            <span class="comment"># '/student/(?P&lt;name&gt;[^/]+)/xxx/(?P&lt;id&gt;[+-]?\\d+)'</span></span><br><span class="line">            pattern, trans = self.__parse(rule) <span class="comment"># 用户输入规则转换为正则表达式</span></span><br><span class="line">            self.__routetable.append(</span><br><span class="line">                (tuple(map(<span class="keyword">lambda</span> x: x.upper(), methods)),</span><br><span class="line">                re.compile(pattern), <span class="comment"># 编译</span></span><br><span class="line">                trans,</span><br><span class="line">                handler)</span><br><span class="line">            ) <span class="comment"># (方法元组,预编译正则对象,类型转换,处理函数)</span></span><br><span class="line">			<span class="keyword">return</span> handler</span><br><span class="line">		<span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> self.route(pattern, <span class="string">'GET'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> self.route(pattern, <span class="string">'POST'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">head</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> self.route(pattern, <span class="string">'HEAD'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="comment"># 必须先匹配前缀</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.path.startswith(self.__prefix):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="comment"># 前缀匹配,说明就必须这个Router实例处理,后续匹配不上,依然返回None</span></span><br><span class="line">        <span class="keyword">for</span> methods, pattern, trans, handler <span class="keyword">in</span> self.__routetable:</span><br><span class="line">            <span class="comment"># not methods表示一个方法都没有定义,就是支持全部方法</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> methods <span class="keyword">or</span> request.method.upper() <span class="keyword">in</span> methods:</span><br><span class="line">                <span class="comment"># 前提已经是以__prefix开头了,可以replace,去掉prefix剩下的才是正则表达式需要匹配的路径</span></span><br><span class="line">                matcher = pattern.match(request.path.replace(self.__prefix, <span class="string">''</span>, <span class="number">1</span>))</span><br><span class="line">                <span class="keyword">if</span> matcher: <span class="comment"># 正则匹配</span></span><br><span class="line">                    newdict = &#123;&#125;</span><br><span class="line">                    <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items(): <span class="comment"># 命名分组组成的字典</span></span><br><span class="line">						newdict[k] = trans[k](v)</span><br><span class="line">                    <span class="comment"># 动态为request增加属性</span></span><br><span class="line">                    request.vars = AttrDict(newdict) <span class="comment"># 属性化</span></span><br><span class="line">                    <span class="keyword">return</span> handler(request)</span><br><span class="line">                </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line">    _ROUTERS = [] <span class="comment"># 存储所有一级Router对象</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 注册</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, *routers:Router)</span>:</span></span><br><span class="line">    	<span class="keyword">for</span> router <span class="keyword">in</span> routers:</span><br><span class="line">    		cls._ROUTERS.append(router)</span><br><span class="line">            </span><br><span class="line"><span class="meta">    @wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="comment"># 遍历_ROTERS,调用Router实例的match方法,看谁匹配</span></span><br><span class="line">        <span class="keyword">for</span> router <span class="keyword">in</span> self._ROUTERS:</span><br><span class="line">            response = router.match(request)</span><br><span class="line">            <span class="keyword">if</span> response: <span class="comment"># 匹配返回非None的Router对象</span></span><br><span class="line">        		<span class="keyword">return</span> response <span class="comment"># 匹配则立即返回</span></span><br><span class="line">        <span class="keyword">raise</span> HTTPNotFound(<span class="string">'&lt;h1&gt;你访问的页面被外星人劫持了&lt;/h1&gt;'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 创建Router对象</span></span><br><span class="line">idx = Router()</span><br><span class="line">py = Router(<span class="string">'/python'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册</span></span><br><span class="line">App.register(idx, py)</span><br><span class="line"></span><br><span class="line"><span class="meta">@idx.get(r'^/$')</span></span><br><span class="line"><span class="meta">@idx.route(r'^/&#123;id:int&#125;$') # 支持所有方法访问</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    id = <span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span> request.vars:</span><br><span class="line">        id = request.vars.id</span><br><span class="line">        print(type(id))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你&#123;&#125;. magedu.com&lt;/h1&gt;'</span>.format(id)</span><br><span class="line"></span><br><span class="line"><span class="meta">@py.get('^/&#123;id&#125;$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.vars:</span><br><span class="line">    	print(type(request.vars.id))</span><br><span class="line">    res = Response()</span><br><span class="line">    res.charset = <span class="string">'utf-8'</span></span><br><span class="line">    res.body = <span class="string">'&lt;h1&gt;Welcome to Magedu Python&lt;/h1&gt;'</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, App())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	server.serve_forever() <span class="comment"># server.handle_request() 一次</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure>
<p>Application中，可以使用字典保存所有Router实例。因为每一个Router实例的前缀不同，完全可以使用前缀为key，Router实例为value组成字典。这样，以后在 <code>__call__</code> 方法中，就不需要遍历列表了，需要提取request的path的前缀就可以和字典的key匹配了，这样提高了效率。<br>目前这么做的原因是一级目录本身不是很多，就几个，所以不用字典也可以。</p>
<h1 id="框架处理流程"><a href="#框架处理流程" class="headerlink" title="框架处理流程"></a>框架处理流程</h1><p>客户端发来HTTP请求，被WSGI服务器处理后传递给App的<code>__call__</code> 。<br>App中遍历已注册的Routers，Routers的match来判断是不是自己能处理，前缀匹配，就看注册的规则(当然规则被装饰器已经转换成了命名分组的正则表达式了)。<br>如果由某一个注册的正则表达式匹配，就把获取的参数放到request中，并调用注册时映射的handler给它传入request。<br>handler处理后，返回response。App中拿到这个response的数据，返回给最初的wsgi。<br>如果handler返回仅仅是数据,将这些数据填入一个HTML中，将新生成的HTML字符串返回客户端，这就是网页。<br>这种技术就是模板技术。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/29/python基础学习-WEB框架之路由实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/29/python基础学习-WEB框架之路由实现/" itemprop="url">
                  python基础学习-WEB框架之路由实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-10-29 15:02:40" itemprop="dateCreated datePublished" datetime="2020-10-29T15:02:40+08:00">2020-10-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-11-13 14:18:28" itemprop="dateModified" datetime="2020-11-13T14:18:28+08:00">2020-11-13</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="类Flask框架实现"><a href="#类Flask框架实现" class="headerlink" title="类Flask框架实现"></a>类Flask框架实现</h1><h2 id="路由route"><a href="#路由route" class="headerlink" title="路由route"></a>路由route</h2><p>什么是路由?<br>简单说，就是路怎么走。就是按照不同的路径分发数据。<br>URL代表对不同资源的地址的访问，可以认为请求不同路径对应的数据。对动态网页技术来说，不同的路径应该对应不同的应用程序来处理，返回数据，用户以为还是访问的静态的网页。<br>所以，代码中要增加对URL路径的分析处理。<br>不管是静态WEB服务器，还是动态WEB服务器，都需要路径和资源或处理程序的映射，最终返回HTML的文本。<br>静态WEB服务器，解决路径和文件之间的映射。<br>动态WEB服务器，解决路径和应用程序之间的映射。<br>所有的WEB框架都是如此，都有路由配置。</p>
<h2 id="路由功能实现"><a href="#路由功能实现" class="headerlink" title="路由功能实现"></a>路由功能实现</h2><h3 id="路由类实现"><a href="#路由类实现" class="headerlink" title="路由类实现"></a>路由类实现</h3><p>路由功能，使用路由类实现。<br>路由类实现的功能主要就是完成path到handler函数的映射，使用字典保存最适合。<br>路由映射的建立需要提供一个方法注册register，它需要提供2个参数path和handler。<br>有以下的路由需求</p>
<table>
<thead>
<tr>
<th>路径</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>/</td>
<td>返回欢迎内容</td>
</tr>
<tr>
<td>/python</td>
<td>返回Hello Python</td>
</tr>
<tr>
<td>其它路径</td>
<td>返回404</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 路由</span></span><br><span class="line"><span class="comment"># url = 'http://127.0.0.1:9999/python/index.html?id=5&amp;name=wayne&amp;age=19&amp;age=20'</span></span><br><span class="line"><span class="comment"># path = '/python/index.html'</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    ROUTETABLE = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(self, path, handler)</span>:</span></span><br><span class="line">        self.ROUTETABLE[path] = handler</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;h1&gt;Welcome to Magedu Python&lt;/h1&gt;'</span></span><br><span class="line"></span><br><span class="line">router = Router()</span><br><span class="line">router.register(<span class="string">'/'</span>, indexhandler)</span><br><span class="line">router.register(<span class="string">'/python'</span>, pythonhandler)</span><br></pre></td></tr></table></figure>
<h3 id="404处理"><a href="#404处理" class="headerlink" title="404处理"></a>404处理</h3><p>webob.exc提供了异常模块<br><a href="https://docs.pylonsproject.org/projects/webob/en/stable/api/exceptions.html" target="_blank" rel="noopener">https://docs.pylonsproject.org/projects/webob/en/stable/api/exceptions.html</a><br>使用webob.exc.HTTPNotFound表示路由表找不到对应的处理函数。</p>
<h3 id="注册函数的改造"><a href="#注册函数的改造" class="headerlink" title="注册函数的改造"></a>注册函数的改造</h3><p>将注册函数改造装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 路由</span></span><br><span class="line"><span class="comment"># url = 'http://127.0.0.1:9999/python/index.html?id=5&amp;name=wayne&amp;age=19&amp;age=20'</span></span><br><span class="line"><span class="comment"># path = '/python/index.html'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    ROUTETABLE = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod # 注册路由,装饰器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, path)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            cls.ROUTETABLE[path] = handler</span><br><span class="line">            <span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Router.register('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Router.register('/python')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;Welcome to Magedu Python&lt;/h1&gt;'</span></span><br></pre></td></tr></table></figure>
<p>将路由功能合并到App类中去。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">from</span> webob.exc <span class="keyword">import</span> HTTPNotFound</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    ROUTETABLE = &#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod # 注册路由,装饰器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, path)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            cls.ROUTETABLE[path] = handler</span><br><span class="line">            <span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Router.register('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Router.register('/python')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;Welcome to Magedu Python&lt;/h1&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line">    _Router = Router</span><br><span class="line"></span><br><span class="line"><span class="meta">    @wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._Router.ROUTETABLE[request.path](request)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">raise</span> HTTPNotFound(<span class="string">'&lt;h1&gt;你访问的页面被外星人劫持了&lt;/h1&gt;'</span>)</span><br><span class="line">            </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, App())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever() <span class="comment"># server.handle_request() 一次</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure>
<p>到目前为止，一个框架的雏形基本完成了。<br>App是WSGI中的应用程序，但是这个应用程序已经变成了一个路由程序，处理逻辑已经移到了应用程序外了，而这部分就是以后留给程序员完成的部分。</p>
<h3 id="路由正则匹配"><a href="#路由正则匹配" class="headerlink" title="路由正则匹配"></a>路由正则匹配</h3><p>目前实现的路由匹配，路径匹配非常死板，使用正则表达式，可以更好的匹配路径。导入re模块。<br>注册的时候，存入不再是路径字符串，而是模式pattern。<br>App的<code>__call__</code>方法中实现模式和传入路径的匹配</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">compile</span> 方法,编译正则表达式</span><br><span class="line">match 方法,必须从头开始匹配,只匹配一次</span><br><span class="line">search 方法,只匹配一次</span><br><span class="line">fullmatch 方法,要完全匹配</span><br><span class="line">findall 方法,从头开始找,找到所有匹配</span><br><span class="line"></span><br><span class="line">分组捕获</span><br><span class="line"><span class="string">'/(?P&lt;biz&gt;.*)/(?P&lt;url&gt;.*)'</span> 贪婪</span><br><span class="line"><span class="string">'/(?P&lt;biz&gt;.*?)/(?P&lt;url&gt;.*)'</span> 非贪婪</span><br><span class="line"></span><br><span class="line"><span class="variable">@Application</span>.register(<span class="string">'^/$'</span>) <span class="comment"># 只匹配根</span></span><br><span class="line"><span class="variable">@Application</span>.register(<span class="string">'/python$'</span>) <span class="comment"># 只匹配/python</span></span><br></pre></td></tr></table></figure>
<p>字典的问题<br>如果使用字典，key保存的是路径，普通字典遍历匹配的时候，是不能保证路径匹配的顺序的。<br>但是匹配过程应该是有顺序的。<br>正则表达式预编译<br>何时预编译正则表达式呢？<br>第一次使用的时候会影响用户体验，所以还是要在注册的时候编译。<br>综上，改用列表，元素使用二元组(编译后的正则对象，handler)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">from</span> webob.exc <span class="keyword">import</span> HTTPNotFound</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    ROUTETABLE = [] <span class="comment"># 列表,有序的</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod # 注册路由,装饰器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            cls.ROUTETABLE.append((re.compile(pattern), handler)) <span class="comment"># (预编译正则对象,处理函数)</span></span><br><span class="line">            <span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Router.register('^/$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Router.register('^/python$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;Welcome to Magedu Python&lt;/h1&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line">    _Router = Router</span><br><span class="line"></span><br><span class="line"><span class="meta">    @wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> pattern, handler <span class="keyword">in</span> self._Router.ROUTETABLE:</span><br><span class="line">            <span class="keyword">if</span> pattern.match(request.path): <span class="comment"># 正则匹配</span></span><br><span class="line">                <span class="keyword">return</span> handler(request)</span><br><span class="line">        <span class="keyword">raise</span> HTTPNotFound(<span class="string">'&lt;h1&gt;你访问的页面被外星人劫持了&lt;/h1&gt;'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, App())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever() <span class="comment"># server.handle_request() 一次</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure>
<h3 id="正则表达式分组捕获"><a href="#正则表达式分组捕获" class="headerlink" title="正则表达式分组捕获"></a>正则表达式分组捕获</h3><p>假设URL为 <a href="http://127.0.0.1:9999/11808，路径为" target="_blank" rel="noopener">http://127.0.0.1:9999/11808，路径为</a> /11808 ，如何编写路径匹配的正则表达式？<br><code>^/(?P&lt;id&gt;\d+)$</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Router.register(r'^/$')</span></span><br><span class="line"><span class="meta">@Router.register(r'^/(?P&lt;id&gt;\d+)$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(request.groups)</span><br><span class="line">    print(request.groupdict)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line">    _Router = Router</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> pattern, handler <span class="keyword">in</span> self._Router.ROUTETABLE:</span><br><span class="line">            matcher = pattern.match(request.path)</span><br><span class="line">            <span class="keyword">if</span> matcher: <span class="comment"># 正则匹配</span></span><br><span class="line">                <span class="comment"># 动态为request增加属性</span></span><br><span class="line">                request.groups = matcher.groups() <span class="comment"># 所有分组组成的元组,包括命名分组</span></span><br><span class="line">                request.groupdict = matcher.groupdict() <span class="comment"># 命名分组组成的字典</span></span><br><span class="line"><span class="comment"># 动态添加属性，将匹配到的groups()和groupdict()添加到当前的request上，这里要注意，是将属性添加到当前的</span></span><br><span class="line"><span class="comment"># request上，一个请求就是一个request，另一个请求就是另一个request实例，只有当前的request返回response</span></span><br><span class="line"><span class="comment"># 后，下一个request才会过来，当前的request一定与当前的请求是一一对应的。通过这个的设计就可以把分组信息保存</span></span><br><span class="line"><span class="comment"># 下来了。</span></span><br><span class="line">                <span class="keyword">return</span> handler(request)</span><br><span class="line">        <span class="keyword">raise</span> HTTPNotFound(<span class="string">'&lt;h1&gt;你访问的页面被外星人劫持了&lt;/h1&gt;'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Request-Method过滤"><a href="#Request-Method过滤" class="headerlink" title="Request Method过滤"></a>Request Method过滤</h3><p>请求方法，一般来说即使是同一个URL，因为请求方法不同，处理方式也不同。<br>假设有一个URL，GET方法表示希望返回网页内容；POST方法表示浏览器提交数据过来需要处理并存入数据库，最终返回客户端存储成功或失败的信息。<br>换句话说，需要请求方法、正则同时匹配才能决定执行 什么处理函数。</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>请求指定的页面信息，并返回报头和正文</td>
</tr>
<tr>
<td>HEAD</td>
<td>类似于get请求，只不过返回的响应中没有具体的内容，用于获取报头</td>
</tr>
<tr>
<td>POST</td>
<td>向指定资源提交数据进行处理请求（例如提交表单或者上传文件），数据被包含在请求正文。POST请求可能会导致新的资源的建立或已有资源的修改</td>
</tr>
<tr>
<td>PUT</td>
<td>从客户端向服务器传送的数据取代指定的文档的内容</td>
</tr>
<tr>
<td>DELETE</td>
<td>请求服务器删除指定的内容</td>
</tr>
</tbody>
</table>
<p>请求方法还有很多，这里不再赘述。<br>实现请求方法判断的方式有:<br>1、在register装饰器中增加参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod # 注册路由,装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, method, pattern)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">        cls.ROUTETABLE.append((method.upper(), re.compile(pattern), handler)) </span><br><span class="line">        <span class="comment"># (预编译正则对象，处理函数)</span></span><br><span class="line">        <span class="keyword">return</span> handler</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@Application.register('GET', '^/$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>2、将register分解成不同方法的装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> cls.register(<span class="string">'GET'</span>, pattern)</span><br></pre></td></tr></table></figure>
<p>将register注册方法改名为route路由方法。<br>改造代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">from</span> webob.exc <span class="keyword">import</span> HTTPNotFound</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    ROUTETABLE = [] <span class="comment"># 列表,有序的</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod # 注册路由,装饰器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(cls, method, pattern)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            cls.ROUTETABLE.append((method.upper(), re.compile(pattern), handler)) <span class="comment"># (预编译正则对象，处理函数)</span></span><br><span class="line">            <span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.route(<span class="string">'GET'</span>, pattern)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.route(<span class="string">'POST'</span>, pattern)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">head</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.route(<span class="string">'HEAD'</span>, pattern)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Router.get(r'^/$')</span></span><br><span class="line"><span class="meta">@Router.route('GET', r'^/(?P&lt;id&gt;\d+)$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(request.groups)</span><br><span class="line">    print(request.groupdict)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Router.get('^/python$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.charset = <span class="string">'utf-8'</span></span><br><span class="line">    res.body = <span class="string">'&lt;h1&gt;Welcome to Magedu Python&lt;/h1&gt;'</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line">    _Router = Router</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> method, pattern, handler <span class="keyword">in</span> self._Router.ROUTETABLE:</span><br><span class="line">            <span class="keyword">if</span> request.method.upper() != method:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            matcher = pattern.match(request.path)</span><br><span class="line">            <span class="keyword">if</span> matcher: <span class="comment"># 正则匹配</span></span><br><span class="line">                <span class="comment"># 动态为request增加属性</span></span><br><span class="line">                request.groups = matcher.groups() <span class="comment"># 所有分组组成的元组,包括命名分组</span></span><br><span class="line">                request.groupdict = matcher.groupdict() <span class="comment"># 命名分组组成的字典</span></span><br><span class="line">                <span class="keyword">return</span> handler(request)</span><br><span class="line">        <span class="keyword">raise</span> HTTPNotFound(<span class="string">'&lt;h1&gt;你访问的页面被外星人劫持了&lt;/h1&gt;'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, App())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever() <span class="comment"># server.handle_request() 一次</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure>
<p>改进</p>
<p>一个URL可以设定多种请求方法，怎么解决？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">思路一</span><br><span class="line">如果什么方法都不写，相当于所有方法都支持。</span><br><span class="line"><span class="meta">@Application.route('^/$') # 隐含一个默认值method=None</span></span><br><span class="line">等价于@Application.route(<span class="keyword">None</span>, <span class="string">'^/$'</span>)</span><br><span class="line">如果一个处理函数handler需要关联多个请求方法method,如下:</span><br><span class="line"><span class="meta">@Router.route(('GET','PUT','DELETE'), '^/$')</span></span><br><span class="line"><span class="meta">@Router.route(['GET','PUT','POST'], '^/$')</span></span><br><span class="line"><span class="meta">@Router.route(&#123;'POST','PUT','DELETE'&#125;, '^/$')</span></span><br><span class="line"></span><br><span class="line">思路二</span><br><span class="line">调整参数位置,把method放到后面变成可变参数</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(cls, pattern, *methods)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">那么methods有可能是一个空元组,表示匹配所有方法;非空表示,匹配指定方法。</span><br><span class="line"><span class="meta">@Router.route('^/$', 'POST','PUT','DELETE')</span></span><br><span class="line"><span class="meta">@Router.route('^/$')</span></span><br><span class="line"></span><br><span class="line">选择思路二</span><br></pre></td></tr></table></figure>
<p>完整代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">from</span> webob.exc <span class="keyword">import</span> HTTPNotFound</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    ROUTETABLE = [] <span class="comment"># 列表,有序的</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod # 注册路由,装饰器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(cls, pattern, *methods)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            cls.ROUTETABLE.append((tuple(map(<span class="keyword">lambda</span> x: x.upper(), methods)),re.compile(pattern), handler)) <span class="comment"># (方法元组,预编译正则对象,处理函数)</span></span><br><span class="line">            <span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.route(pattern, <span class="string">'GET'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.route(pattern, <span class="string">'POST'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">head</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.route(pattern, <span class="string">'HEAD'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Router.get(r'^/$')</span></span><br><span class="line"><span class="meta">@Router.route(r'^/(?P&lt;id&gt;\d+)$') # 支持所有方法访问</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(request.groups)</span><br><span class="line">    print(request.groupdict)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Router.get('^/python$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.charset = <span class="string">'utf-8'</span></span><br><span class="line">    res.body = <span class="string">'&lt;h1&gt;Welcome to Magedu Python&lt;/h1&gt;'</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line">    _Router = Router</span><br><span class="line"></span><br><span class="line"><span class="meta">    @wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> methods, pattern, handler <span class="keyword">in</span> self._Router.ROUTETABLE:</span><br><span class="line">            <span class="comment"># not methods表示一个方法都没有定义,就是支持全部方法</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> methods <span class="keyword">or</span> request.method.upper() <span class="keyword">in</span> methods:</span><br><span class="line">                matcher = pattern.match(request.path)</span><br><span class="line">                <span class="keyword">if</span> matcher: <span class="comment"># 正则匹配</span></span><br><span class="line">                    <span class="comment"># 动态为request增加属性</span></span><br><span class="line">                    request.groups = matcher.groups() <span class="comment"># 所有分组组成的元组,包括命名分组</span></span><br><span class="line">                    request.groupdict = matcher.groupdict() <span class="comment"># 命名分组组成的字典</span></span><br><span class="line">                    <span class="keyword">return</span> handler(request)</span><br><span class="line">        <span class="keyword">raise</span> HTTPNotFound(<span class="string">'&lt;h1&gt;你访问的页面被外星人劫持了&lt;/h1&gt;'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, App())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever() <span class="comment"># server.handle_request() 一次</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure>
<p>路由匹配从 URL =&gt; handler 变成了 method + URL =&gt; handler</p>
<h3 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request, dec</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server, demo_app</span><br><span class="line"></span><br><span class="line"><span class="meta">@dec.wsgify</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(request:Request)</span> -&gt; Response:</span></span><br><span class="line">    print(request.path)</span><br><span class="line">    </span><br><span class="line">    res = Response()</span><br><span class="line">    <span class="keyword">if</span> request.path == <span class="string">"/"</span>:</span><br><span class="line">        res.body = <span class="string">"&lt;h1&gt;马哥教育欢迎你们大家&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">elif</span> request.path == <span class="string">"/pathon"</span>:</span><br><span class="line">        res.body = <span class="string">"&lt;h1&gt;马哥教育python&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res.status_code = <span class="number">404</span></span><br><span class="line">        res.body = <span class="string">"not Found"</span>.encode()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, app)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">    	server.server_close()</span><br><span class="line">=======================================================================================</span><br><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request, dec</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server, demo_app</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request:Request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育欢迎你们大家&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showpython</span><span class="params">(request:Request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育python&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notfound</span><span class="params">()</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.status_code = <span class="number">404</span></span><br><span class="line">    res.body = <span class="string">"not Found"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="meta">@dec.wsgify</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(request:Request)</span> -&gt; Response:</span></span><br><span class="line">    <span class="keyword">if</span> request.path == <span class="string">"/"</span>:</span><br><span class="line">        <span class="keyword">return</span> index(request)</span><br><span class="line">    <span class="keyword">elif</span> request.path == <span class="string">"/pathon"</span>:</span><br><span class="line">        <span class="keyword">return</span> showpython(request)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> notfound()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, app)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">    	server.server_close()</span><br><span class="line">=======================================================================================</span><br><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request, dec</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server, demo_app</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request:Request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育欢迎你们大家&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showpython</span><span class="params">(request:Request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育python&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notfound</span><span class="params">()</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.status_code = <span class="number">404</span></span><br><span class="line">    res.body = <span class="string">"not Found"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">ROUTETABLE = &#123;</span><br><span class="line">    <span class="string">"/"</span>: index,</span><br><span class="line">    <span class="string">"/python"</span>: showpython</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@dec.wsgify</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(request:Request)</span> -&gt; Response:</span></span><br><span class="line">    <span class="keyword">return</span> ROUTETABLE.get(request.path, notfound)(request)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, app)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">    	server.server_close()</span><br><span class="line">=======================================================================================</span><br><span class="line"><span class="comment"># 注册函数</span></span><br><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request, dec</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server, demo_app</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request:Request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育欢迎你们大家&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showpython</span><span class="params">(request:Request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育python&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notfound</span><span class="params">()</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.status_code = <span class="number">404</span></span><br><span class="line">    res.body = <span class="string">"not Found"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="comment"># 路由表</span></span><br><span class="line">ROUTETABLE = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(path, handler)</span>:</span></span><br><span class="line">    ROUTETABLE[path] = handler</span><br><span class="line"><span class="comment"># 注册</span></span><br><span class="line">register(<span class="string">'/'</span>,index)</span><br><span class="line">register(<span class="string">'/python'</span>, showpython)</span><br><span class="line"></span><br><span class="line"><span class="meta">@dec.wsgify</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(request:Request)</span> -&gt; Response:</span></span><br><span class="line">    <span class="keyword">return</span> ROUTETABLE.get(request.path, notfound)(request)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, app)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">    	server.server_close()</span><br><span class="line">=========================================================================================</span><br><span class="line"><span class="comment"># 用类封装</span></span><br><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request, dec, exc</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server, demo_app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span>:</span></span><br><span class="line">    <span class="comment"># 用__init__实现调用不合适，因为参数写死了</span></span><br><span class="line">  <span class="comment">#  def notfound(self, request:Request):  # 这个方法是客户不关心的，出问题才会使用这个函数，这是一个共用的，所以写在框架内</span></span><br><span class="line">   <span class="comment">#     res = Response()</span></span><br><span class="line">  <span class="comment">#      res.status_code = 404</span></span><br><span class="line">    <span class="comment">#    res.body = "您访问的页面被外星人劫持了".encode()</span></span><br><span class="line">    <span class="comment">#    return res</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 路由表</span></span><br><span class="line">    ROUTETABLE = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, path)</span>:</span></span><br><span class="line"> <span class="comment">#       cls.ROUTETABLE[path] = handler</span></span><br><span class="line">	<span class="comment"># 因为ROUTETABLE是类属性，所以这里也用类方法，如果ROUTETABLE是实例的，这里就要用实例方法了</span></span><br><span class="line">    	<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            cls.ROUTETABLE[path] = handler</span><br><span class="line">            <span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"><span class="comment"># register是一个带参装饰器，使用方法如：@Application.register('/')，这会把'/'当做path传给register函</span></span><br><span class="line"><span class="comment"># 数，之后返回wrapper，在@符号的作用下，再将@Application.register('/')下面的函数当做参数传给wrapper</span></span><br><span class="line"><span class="comment"># 函数，在wrapper函数中并没有增加handler参数的功能，只是将handler参数加入到了路由表中，所以又将handler</span></span><br><span class="line"><span class="comment"># 参数原封不动的返回回来了。</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="meta">    @dec.wsgify  # 这个装饰器一定保证下面的函数转化成接收两个参数，environ和start_response，这样才是make_server要看到的东西。这个装饰器就是把下面函数变成标准接口的东西</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span> -&gt; Response:</span></span><br><span class="line">        </span><br><span class="line">     <span class="comment">#   return self.ROUTETABLE.get(request.path, self.notfound)(request)  </span></span><br><span class="line"><span class="comment"># 装饰器会把返回值变成可迭代对象，这里不用将self改成cls，用self.ROUTETABLE也没问题，因为实例变量是每一个</span></span><br><span class="line"><span class="comment"># 实例自己的变量，是自己独有的；类变量是类的变量，是类的所有实例共享的属性和方法</span></span><br><span class="line"><span class="comment"># Application类未来是要单独做一个模块的，所以单独创建了一个类</span></span><br><span class="line"><span class="comment"># 请求会先到Application类，再由这个类决定将请求给哪个handler处理，handler是一个业务函数，业务函数就不属于这个类管理的事情了</span></span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">        	<span class="keyword">return</span> self.ROUTETABLE.get(request.path)(request)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">           <span class="comment"># return self.notfound(request)</span></span><br><span class="line">           <span class="keyword">raise</span> exc.HTTPNoFound(<span class="string">"您访问的页面被外星人劫持了"</span>)   <span class="comment"># HTTPNoFound继承自response，所以可以把一个缺省的body放在这里。HTTPNoFound类中已经定义了code，title，explantion，就是没有body。只要抛异常就从这里返回</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Application.register('/')  # 带参装饰器，index = Application.register('/')(index)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request:Request)</span> -&gt; Response:</span></span><br><span class="line"><span class="comment"># 这里要求handler的参数是Request，返回Response，Application成了server端，handler成了被调用端，handler要暴露接口给Application</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育欢迎你们大家&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment"># 这个函数也可以写成一个普通函数，return一个字符串，外面用类或装饰器一包就行了</span></span><br><span class="line"><span class="comment"># 原来代理运行时是逐行向下跑，跑到下面的Application.register('/',index)才会注册，加入装饰器后，跑到</span></span><br><span class="line"><span class="comment"># @Application.register('/')就开始注册了，当模块运行到@Application.register('/')时就开始调用了，这时类属性ROUTETABLE也已经创建了，所以这里运行@Application.register('/')就可以将handler函数注册到路由表中了</span></span><br><span class="line"><span class="meta">@Application.register('/python')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showpython</span><span class="params">(request:Request)</span> -&gt; Response:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育python&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment"># 如果是一个框架的话，上面两个方法应该是用户写好的，与Application类无关，所以放到了类外面</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册</span></span><br><span class="line"><span class="comment"># Application.register('/',index)</span></span><br><span class="line"><span class="comment"># Application.register('/python', showpython)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, Application())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">    	server.server_close()</span><br><span class="line">=========================================================================================</span><br><span class="line"><span class="comment"># 路由正则匹配</span></span><br><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request, dec, exc</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server, demo_app</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span>:</span></span><br><span class="line">    <span class="comment"># 路由表</span></span><br><span class="line">    <span class="comment"># ROUTETABLE = &#123;'^/python':showpython&#125;</span></span><br><span class="line">    ROUTETABLE = []</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(cls, pattern, *methods)</span>:</span></span><br><span class="line"> <span class="comment">#       cls.ROUTETABLE[path] = handler</span></span><br><span class="line">	<span class="comment"># 因为ROUTETABLE是类属性，所以这里也用类方法，如果ROUTETABLE是实例的，这里就要用实例方法了</span></span><br><span class="line">    	<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            cls.ROUTETABLE.append((methods, re.compile(pattern), handler))</span><br><span class="line"><span class="comment"># 测试可以将正则表达式放入元组中，如(re.compile(r'^/$'),)。这里的method不用往后放，是None也没关系</span></span><br><span class="line"><span class="comment"># 这里传入的如：register(re.compile(r'^/$'),'POST','GET')，ROUTETABLE中为(('POST','GET'),re.compile(r'^/$'),index)</span></span><br><span class="line">            <span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"><span class="comment"># register是一个带参装饰器，使用方法如：@Application.register('/')，这会把'/'当做path传给register函</span></span><br><span class="line"><span class="comment"># 数，之后返回wrapper，在@符号的作用下，再将@Application.register('/')下面的函数当做参数传给wrapper</span></span><br><span class="line"><span class="comment"># 函数，在wrapper函数中并没有增加handler参数的功能，只是将handler参数加入到了路由表中，所以又将handler</span></span><br><span class="line"><span class="comment"># 参数原封不动的返回回来了。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">	@classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.route(<span class="string">'GET'</span>, pattern)  <span class="comment"># 调用cls.register()</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.route(<span class="string">'POST'</span>, pattern)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">head</span><span class="params">(cls, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls.route(<span class="string">'HEAD'</span>, pattern)  </span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="meta">    @dec.wsgify  # 这个装饰器一定保证下面的函数转化成接收两个参数，environ和start_response，这样才是make_server要看到的东西。这个装饰器就是把下面函数变成标准接口的东西</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span> -&gt; Response:</span></span><br><span class="line">		</span><br><span class="line">        <span class="keyword">for</span> method,pattern,handler <span class="keyword">in</span> self.ROUTETABLE:</span><br><span class="line"><span class="comment"># 这里的pattern是一个编译过的东西</span></span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">not</span> methods <span class="keyword">or</span> request.method.upper() <span class="keyword">in</span> methods: </span><br><span class="line">            <span class="comment"># 判断传入的method是否为None或空值</span></span><br><span class="line">                matcher = pattern.match(request.path)</span><br><span class="line">                <span class="keyword">if</span> matcher:</span><br><span class="line">                    <span class="keyword">return</span> handler(request)</span><br><span class="line">		<span class="keyword">raise</span> exc.HTTPNoFound(<span class="string">"您访问的页面被外星人劫持了"</span>)   </span><br><span class="line"><span class="comment"># HTTPNoFound继承自response，所以可以把一个缺省的body放在这里。HTTPNoFound类中已经定义了code，</span></span><br><span class="line"><span class="comment"># title，explantion，就是没有body。只要抛异常就从这里返回</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># @Application.register(Application.GET,'/')  # 带参装饰器，index = Application.register('/')(index)</span></span><br><span class="line"><span class="meta">@Application.get('^/$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request:Request)</span> -&gt; Response:</span></span><br><span class="line"><span class="comment"># 这里要求handler的参数是Request，返回Response，Application成了server端，handler成了被调用端，handler要暴露接口给Application</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育欢迎你们大家&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment"># 这个函数也可以写成一个普通函数，return一个字符串，外面用类或装饰器一包就行了</span></span><br><span class="line"><span class="comment"># 原来代理运行时是逐行向下跑，跑到下面的Application.register('/',index)才会注册，加入装饰器后，跑到</span></span><br><span class="line"><span class="comment"># @Application.register('/')就开始注册了，当模块运行到@Application.register('/')时就开始调用了，这</span></span><br><span class="line"><span class="comment"># 时类属性ROUTETABLE也已经创建了，所以这里运行@Application.register('/')就可以将handler函数注册到路</span></span><br><span class="line"><span class="comment"># 由表中了</span></span><br><span class="line"><span class="meta">@Application.post('/python')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showpython</span><span class="params">(request:Request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育python&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment"># 如果是一个框架的话，上面两个方法应该是用户写好的，与Application类无关，所以放到了类外面</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, Application())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">    	server.server_close()</span><br><span class="line">=========================================================================================</span><br><span class="line"><span class="comment"># 正则表达式，分组</span></span><br><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request, dec, exc</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server, demo_app</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, prefix:str=<span class="string">''</span>)</span>:</span></span><br><span class="line">        self.__prefix = prefix.rstrip(<span class="string">'/\\'</span>) <span class="comment"># 不允许右边出现/和\，这里一定不能用strip()，那样会去掉两边的</span></span><br><span class="line">        <span class="comment"># ROUTETABLE = &#123;'^/python':showpython&#125;  # /abc/python/1234</span></span><br><span class="line">        <span class="comment"># /product/tv/1234  /product/tv/abc</span></span><br><span class="line">        <span class="comment"># /product/(\w+)/(?P&lt;id&gt;\d+)   # 用match匹配</span></span><br><span class="line">        self.__routetable = []</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prefix</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__prefix</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, pattern, *methods)</span>:</span></span><br><span class="line">    	<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            self.__routetable.append((methods, re.compile(pattern), handler))</span><br><span class="line">            <span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.route(pattern, <span class="string">'GET'</span>)  <span class="comment"># 调用cls.register()</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.route(pattern, <span class="string">'POST'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">head</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.route(pattern, <span class="string">'HEAD'</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(self, request:Request)</span> -&gt; Response:</span></span><br><span class="line">        <span class="comment"># 属于你管的prefix</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.path.startswith(self.prefix):</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line">        <span class="keyword">for</span> method,pattern,handler <span class="keyword">in</span> self.ROUTETABLE:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> methods <span class="keyword">or</span> request.method.upper() <span class="keyword">in</span> methods:</span><br><span class="line">                matcher = pattern.match(request.path.replace(self.prefix))</span><br><span class="line">                        <span class="keyword">if</span> matcher:</span><br><span class="line">                            request.args = matcher.group()  <span class="comment"># 所有分组</span></span><br><span class="line">                            request.kwargs = DictObj(matcher.groupdict())  <span class="comment"># 所有命令分组，这才是我们想要的，DictObj()是自定义的类的实例</span></span><br><span class="line">                            <span class="keyword">return</span> handler(request)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span>:</span></span><br><span class="line">	ROUTERS = []</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, *router:Router)</span>:</span></span><br><span class="line">        cls.ROUTERS.append(router)</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @dec.wsgify </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span> -&gt; Response:</span></span><br><span class="line">		<span class="keyword">for</span> router <span class="keyword">in</span> self.ROUTERS:</span><br><span class="line">            response = router.match(request)</span><br><span class="line">            <span class="keyword">if</span> response:</span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">        </span><br><span class="line">		<span class="keyword">raise</span> exc.HTTPNoFound(<span class="string">"您访问的页面被外星人劫持了"</span>)   </span><br><span class="line"><span class="comment"># HTTPNoFound继承自response，所以可以把一个缺省的body放在这里。HTTPNoFound类中已经定义了code，</span></span><br><span class="line"><span class="comment"># title，explantion，就是没有body。只要抛异常就从这里返回</span></span><br><span class="line"></span><br><span class="line">idx = Router()</span><br><span class="line">py = Router(<span class="string">'/python'</span>)</span><br><span class="line"></span><br><span class="line">Application.register(idx)</span><br><span class="line">Application.register(py)  <span class="comment"># 注册</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@idx.get('^/$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request:Request)</span> -&gt; Response:</span></span><br><span class="line"><span class="comment"># 这里要求handler的参数是Request，返回Response，Application成了server端，handler成了被调用端，handler要暴露接口给Application</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育欢迎你们大家&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment"># 这个函数也可以写成一个普通函数，return一个字符串，外面用类或装饰器一包就行了</span></span><br><span class="line"><span class="comment"># 原来代理运行时是逐行向下跑，跑到下面的Application.register('/',index)才会注册，加入装饰器后，跑到</span></span><br><span class="line"><span class="comment"># @Application.register('/')就开始注册了，当模块运行到@Application.register('/')时就开始调用了，这</span></span><br><span class="line"><span class="comment"># 时类属性ROUTETABLE也已经创建了，所以这里运行@Application.register('/')就可以将handler函数注册到路</span></span><br><span class="line"><span class="comment"># 由表中了</span></span><br><span class="line"><span class="meta">@py.post('/python')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showpython</span><span class="params">(request:Request)</span> -&gt; Response:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育python&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment"># 如果是一个框架的话，上面两个方法应该是用户写好的，与Application类无关，所以放到了类外面</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, Application())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">    	server.server_close()</span><br><span class="line">=========================================================================================</span><br><span class="line"><span class="comment"># 需求：有一个字典，想在未来访问时用d.a，将一个字典对象化，像对象一样访问</span></span><br><span class="line"></span><br><span class="line">d = &#123;</span><br><span class="line">    <span class="string">'a'</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># d.a</span></span><br><span class="line"><span class="comment"># d.a = 5</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DictObj</span>:</span>  <span class="comment"># 对字典包装的类</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, d:dict)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(d, (dict,)):  <span class="comment"># 第二个参数应该是一个元组</span></span><br><span class="line">            self.__dict__[<span class="string">'_dict'</span>] = d</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.__dict__[<span class="string">'_dict'</span>] = &#123;&#125;</span><br><span class="line"><span class="comment"># 用这种方法解决下面__getattr__的递归问题</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 不能用@property，不灵活</span></span><br><span class="line">    <span class="comment"># def __setitem__(self, key, value):  item与容器相关</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span>  <span class="comment"># 看到get应该想到有return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._dict[item]      <span class="comment"># 这里有一个递归的问题，需要找一下递归的真正原因是什么</span></span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">'Attribute &#123;&#125; Not Found'</span>.format(item))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementeError  <span class="comment"># set时会碰这个函数，阻止别人修改属性值</span></span><br><span class="line">    </span><br><span class="line">do = DictObj(d)</span><br><span class="line">d[<span class="string">'a'</span>] = <span class="number">200</span></span><br><span class="line"><span class="comment">#print(do.a)</span></span><br><span class="line"><span class="comment">#do.a = 200</span></span><br><span class="line">print(do.a)</span><br><span class="line">=========================================================================================</span><br><span class="line"><span class="comment"># URL转换</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">pattern = re.compile(<span class="string">'/(&#123;[^&#123;&#125;:]+:?[^&#123;&#125;:]*&#125;)'</span>)</span><br><span class="line">s = <span class="string">'/student/&#123;name:str&#125;/xxx/&#123;id:int&#125;'</span></span><br><span class="line">s1 = <span class="string">'/student/xxx/&#123;id:int&#125;/yyy'</span></span><br><span class="line">s2 = <span class="string">'/student/xxx/513423'</span></span><br><span class="line">s3 = <span class="string">'/student/&#123;name:&#125;/xxx/&#123;id&#125;'</span></span><br><span class="line">s4 = <span class="string">'/student/&#123;name:&#125;/xxx/&#123;id:aaa&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /(id:int) =&gt; /(?P&lt;id&gt;[+-]?/d+)</span></span><br><span class="line"><span class="comment"># '/(?&lt;&#123;&#125;&gt;&#123;&#125;)'.format('id',TYPEPATTERNS['int'])</span></span><br><span class="line"></span><br><span class="line">TYPEPATTERNS = &#123;</span><br><span class="line">    <span class="string">'str'</span>:<span class="string">r'[^/]+'</span>,</span><br><span class="line">    <span class="string">'word'</span>:<span class="string">r'\w+'</span>,</span><br><span class="line">    <span class="string">'int'</span>:<span class="string">r'[+-]?\d+'</span>,</span><br><span class="line">    <span class="string">'float'</span>:<span class="string">r'[+-]?\d+\.\d+'</span>,</span><br><span class="line">    <span class="string">'any'</span>:<span class="string">r'.+'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TYPECAST = &#123;</span><br><span class="line">    <span class="string">'str'</span>:str,</span><br><span class="line">    <span class="string">'word'</span>:str,</span><br><span class="line">    <span class="string">'int'</span>:int,</span><br><span class="line">    <span class="string">'float'</span>:float,</span><br><span class="line">    <span class="string">'any'</span>:str</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># /python/class</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transform</span><span class="params">(kv:str)</span>:</span></span><br><span class="line">    <span class="comment"># /(id:int) =&gt; /(?P&lt;id&gt;[+-]?\d+)</span></span><br><span class="line">    name, _, type = kv.strip(<span class="string">'/&#123;&#125;'</span>).partition(<span class="string">':'</span>)</span><br><span class="line">    <span class="comment"># 返回元组，（目标正则表达式，被替换部分类型有序列表）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'/(?P&lt;&#123;&#125;&gt;&#123;&#125;)'</span>.format(name, TYPEPATTERNS.get(type,<span class="string">'\w+'</span>)), name, TYPECAST.get(type, str)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(src:str)</span>:</span></span><br><span class="line">    start = <span class="number">0</span> <span class="comment"># '/(&#123;[^&#123;&#125;:]+:?[^&#123;&#125;:]*&#125;)'</span></span><br><span class="line">    res = <span class="string">''</span> <span class="comment"># '/student/&#123;name:str&#125;/xxx/&#123;id:int&#125;'  /prefix/&#123;name&#125;/&#123;id&#125;  /(?P&lt;name&gt;......)</span></span><br><span class="line">    translator = &#123;&#125;  <span class="comment"># id =&gt; int   name =&gt; str</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        matcher = pattern.search(src, start)</span><br><span class="line">        <span class="keyword">if</span> matcher:</span><br><span class="line">            res += matcher.string[start:matcher.start()]</span><br><span class="line">            tmp = transform(matcher.string[matcher.start():matcher.end()])</span><br><span class="line">            res += tmp[<span class="number">0</span>]</span><br><span class="line">            translator[tmp[<span class="number">1</span>]] = tmp[<span class="number">2</span>]</span><br><span class="line">            start = matcher.end()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 没有任何匹配应该原样返回字符串</span></span><br><span class="line">    <span class="keyword">if</span> res:</span><br><span class="line">        <span class="keyword">return</span> res, translator</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> src, translator</span><br><span class="line">    </span><br><span class="line">print(parse(s))</span><br><span class="line">print(parse(s1))</span><br><span class="line">print(parse(s2))</span><br><span class="line">print(parse(s3))</span><br><span class="line">print(parse(s4))</span><br><span class="line">=========================================================================================</span><br><span class="line"><span class="comment"># 解决客户端主动断开</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></span><br><span class="line">    super().handle()</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> self.e.is_set():</span><br><span class="line">        print(self.e.is_set())</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print(threading.current_thread(), <span class="string">'a'</span>)</span><br><span class="line">            data = self.request.recv(<span class="number">1024</span>)</span><br><span class="line">            print(data, <span class="string">'~~~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">            <span class="keyword">if</span> len(data) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> BrokenPipeError</span><br><span class="line">            data = data.decode().strip()</span><br><span class="line">            print(threading.current_thread(), <span class="string">'b'</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">'Error!!!!!!!!!!!!!!!'</span>)</span><br><span class="line">            print(e)</span><br><span class="line">            data = <span class="string">"quit"</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">"quit"</span>:</span><br><span class="line">            self.e.set()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">        msg = <span class="string">"are you ok &#123;&#125;\n"</span>.format(data).encode()</span><br><span class="line">        print(msg)</span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> self.sockset.values():</span><br><span class="line">            s.send(mag)</span><br></pre></td></tr></table></figure>
<p>上下文管理<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request, dec, exc</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DictObj</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, d:dict)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(d, (dict,)):</span><br><span class="line">            self.__dict__[<span class="string">'_dict'</span>] = d</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.__dict__[<span class="string">'_dict'</span>] = &#123;&#125;</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._dict[item]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">'Attribute &#123;&#125; Not Found'</span>.format(item))</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span>  <span class="comment"># 这里这样写就是不允许改属性的</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span><span class="params">(dict)</span>:</span>   <span class="comment"># 用这个类实现字典访问用Context().app = test 的方式。因为当找不到属性时就会触发__setattr__方法，这里定义的__setattr__就是把kv对放到字典中。这个类是给app用的</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self[item]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">'Attribute &#123;&#125; Not Found.'</span>.format(item))</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self[key] = value</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NestedContext</span><span class="params">(Context)</span>:</span>  <span class="comment"># 这个类是给Router用的</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, globalcontext: Context = None)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.globalcontext = globalcontext</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">relate</span><span class="params">(self, globalcontext: Context = None)</span>:</span></span><br><span class="line">        self.globalcontext = globalcontext</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">in</span> self.keys():</span><br><span class="line">            <span class="keyword">return</span> self[item]</span><br><span class="line">        <span class="keyword">return</span> self.globalcontext[item]</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    KVPATTERN = re.compile(<span class="string">'/(&#123;[^&#123;&#125;:]+:?[^&#123;&#125;:]*&#125;)'</span>)</span><br><span class="line">    </span><br><span class="line">    TYPEPATTERNS = &#123;</span><br><span class="line">        <span class="string">'str'</span>:<span class="string">r'[^/]+'</span>,</span><br><span class="line">        <span class="string">'word'</span>:<span class="string">r'\w+'</span>,</span><br><span class="line">        <span class="string">'int'</span>:<span class="string">r'[+-]?\d+'</span>,</span><br><span class="line">        <span class="string">'float'</span>:<span class="string">r'[+-]?\d+\.\d+'</span>,</span><br><span class="line">        <span class="string">'any'</span>:<span class="string">r'.+'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TYPECAST = &#123;</span><br><span class="line">        <span class="string">'str'</span>:str,</span><br><span class="line">        <span class="string">'word'</span>:str,</span><br><span class="line">        <span class="string">'int'</span>:int,</span><br><span class="line">        <span class="string">'float'</span>:float,</span><br><span class="line">        <span class="string">'any'</span>:str</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># /python/class</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">transform</span><span class="params">(self, kv:str)</span>:</span></span><br><span class="line">        <span class="comment"># /&#123;id:int&#125; =&gt; /(?P&lt;id&gt;[+-]?\d+)</span></span><br><span class="line">        name, _, type = kv.strip(<span class="string">'&#123;&#125;'</span>).partition(<span class="string">':'</span>)</span><br><span class="line">        <span class="comment"># 返回元组，（目标正则表达式，被替换部分类型有序列表）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'/(?P&lt;&#123;&#125;&gt;&#123;&#125;)'</span>.format(name, self.TYPEPATTERNS.get(type, <span class="string">'\w+'</span>)), name, self.TYPECAST.get(type, str)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, src:str)</span>:</span></span><br><span class="line">        start = <span class="number">0</span>  <span class="comment"># '/(&#123;[^&#123;&#125;:]+:?[^&#123;&#125;:]*&#125;)'</span></span><br><span class="line">        res = <span class="string">''</span>  <span class="comment"># '/student/&#123;name:str&#125;/xxx/&#123;id:int&#125;' /prefix/&#123;name&#125;/&#123;id&#125; /(?P&lt;name&gt;......)</span></span><br><span class="line">        translator = &#123;&#125;  <span class="comment"># id =&gt; int  name =&gt; str</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            matcher = self.KVPATTERN.search(src, start)</span><br><span class="line">            <span class="keyword">if</span> matcher:</span><br><span class="line">                res += matcher.string[start:matcher.start()]</span><br><span class="line">                tmp = self.transform(matcher.string[matcher.start():matcher.end()])</span><br><span class="line">                res += tmp[<span class="number">0</span>]</span><br><span class="line">                translator[tmp[<span class="number">1</span>]] = tmp[<span class="number">2</span>]</span><br><span class="line">                start = matcher.end()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                <span class="comment"># 没有任何匹配应该原样返回字符串</span></span><br><span class="line">        <span class="keyword">if</span> res:</span><br><span class="line">            <span class="keyword">return</span> res, translator</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> src, translator</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, prefix:str=<span class="string">''</span>)</span>:</span></span><br><span class="line">        self.__prefix = prefix.rstrip(<span class="string">'/\\'</span>)</span><br><span class="line">        <span class="comment"># URL: /product/tv/1234  /product/tv/abc</span></span><br><span class="line">        <span class="comment"># URL: /python/student/16</span></span><br><span class="line">        <span class="comment"># PATTERN: /product/(\w+)/(?P&lt;id&gt;\d+)  /product/&#123;name&#125;/&#123;id&#125;</span></span><br><span class="line">        self.__routetable = []‘</span><br><span class="line">        </span><br><span class="line">        self.ctx = NestedContext()  <span class="comment"># 未绑定全局的上下文 </span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 拦截器</span></span><br><span class="line">        self.preinterceptor = []</span><br><span class="line">        self.postinterceptor = []</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg_preinterceptor</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.preinterceptor.append(fn)</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg_postinterceptor</span><span class="params">(self,fn)</span>:</span></span><br><span class="line">        self.postinterceptor.append(fn)</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prefix</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__prefix</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, rule, *methods)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            pattern, translator = self.parse(rule)</span><br><span class="line">            self.__routetable.append((methods, re.compile(pattern), translator, handler))  <span class="comment"># TODO</span></span><br><span class="line">            <span class="keyword">return</span> handler</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.route(pattern, <span class="string">"GET"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.route(pattern, <span class="string">"POST"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">head</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.route(pattern, <span class="string">"HEAD"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(self, request:Request)</span> -&gt; Response:</span></span><br><span class="line">        <span class="comment"># 属于你管的prefix</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.path.startswith(self.prefix):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> fn <span class="keyword">in</span> self.preinterceptor:</span><br><span class="line">            request = fn(self.ctx, request)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> methods, pattern, translator, handler <span class="keyword">in</span> self.__routetable:</span><br><span class="line">            matcher = pattern.match(request.path.replace(self.prefix, <span class="string">""</span>, <span class="number">1</span>))</span><br><span class="line">            <span class="keyword">if</span> matcher:</span><br><span class="line">                <span class="comment"># request.kwargs = DictObj(matcher.groupdict())  # 所有的命名的分组</span></span><br><span class="line">                newdict = &#123;&#125;</span><br><span class="line">                <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items():</span><br><span class="line">                    newdict[k] = translator[k](v)</span><br><span class="line">                request.vars = DictObj(newdict)  <span class="comment"># request.vars.id request.vars.name</span></span><br><span class="line">                </span><br><span class="line">                response = handler(self.ctx, request)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> fn <span class="keyword">in</span> self.postinterceptor:</span><br><span class="line">                    response = fn(self.ctx, request, response)</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">return</span> response </span><br><span class="line">            </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span>:</span></span><br><span class="line">    ctx = Context()  <span class="comment"># 实例化</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        self.ctx.app = self  <span class="comment"># 这实际是放到字典中了</span></span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            self.ctx[k] = v</span><br><span class="line">    </span><br><span class="line">    ROUTERS = []</span><br><span class="line">    </span><br><span class="line">    PREINTERCEPTOR = []</span><br><span class="line">    POSTINTERCEPTOR = []</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg_preinterceptor</span><span class="params">(cls, fn)</span>:</span></span><br><span class="line">        cls.PREINTERCEPOR.append(fn)</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg_postinterceptor</span><span class="params">(cls,fn)</span>:</span></span><br><span class="line">        cls.POSTINTERCEPOR.append(fn)</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, router:Router)</span>:</span></span><br><span class="line">        router.ctx.relate(cls.ctx)</span><br><span class="line">        router.ctx.router = router  <span class="comment"># .app = self，在自己的类上有一个自己的引用</span></span><br><span class="line">        cls.ROUTERS.append(router)</span><br><span class="line">        <span class="keyword">return</span> router</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @dec.wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span> -&gt; Response:</span></span><br><span class="line">        <span class="keyword">for</span> fn <span class="keyword">in</span> self.PREINTERCEPTOR:</span><br><span class="line">            request = fn(self.ctx, request)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> router <span class="keyword">in</span> self.ROUTERS:</span><br><span class="line">            response = router.match(request)</span><br><span class="line">            <span class="keyword">if</span> response:</span><br><span class="line">                <span class="keyword">for</span> fn <span class="keyword">in</span> self.POSTINTERCEPTOR:</span><br><span class="line">                    response = fn(self.ctx, request, response)</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">raise</span> exc.HTTPNotFound(<span class="string">"您访问的页面被外星人劫持了"</span>)</span><br><span class="line">        </span><br><span class="line">idx = Router()</span><br><span class="line">py = Router(<span class="string">'/python'</span>)</span><br><span class="line"></span><br><span class="line">Application.register(idx)</span><br><span class="line">Application.register(py)</span><br><span class="line"></span><br><span class="line"><span class="meta">@idx.get('^/$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request: Request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育欢迎你们大家&lt;/h1&gt;"</span>.encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="meta">@py.get('/&#123;name&#125;/&#123;id&#125;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showpython</span><span class="params">(request: Request)</span>:</span></span><br><span class="line">    res = Response()</span><br><span class="line">    res.body = <span class="string">"&lt;h1&gt;马哥教育python欢迎你们大家 &#123;&#125;&lt;/h1&gt;"</span>.format(request.vars.id).encode()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, Application())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever()  <span class="comment"># server.handle_request()  一次</span></span><br><span class="line">    <span class="keyword">except</span> keyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/23/python基础学习-WEB框架之environ处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/23/python基础学习-WEB框架之environ处理/" itemprop="url">
                  python基础学习-WEB框架之environ处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-10-23 10:53:05" itemprop="dateCreated datePublished" datetime="2020-10-23T10:53:05+08:00">2020-10-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-11-05 17:26:35" itemprop="dateModified" datetime="2020-11-05T17:26:35+08:00">2020-11-05</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="类Flask框架实现"><a href="#类Flask框架实现" class="headerlink" title="类Flask框架实现"></a>类Flask框架实现</h1><p>从现在开始，我们将一步步完成一个WSGI的WEB框架，从而了解WEB框架的内部机制</p>
<h2 id="WSGIfy请求environ处理"><a href="#WSGIfy请求environ处理" class="headerlink" title="WSGIfy请求environ处理"></a>WSGIfy请求environ处理</h2><p>WSGI服务器程序会帮我们处理HTTP请求报文，但是提供的environ还是一个用起来不方便的字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9999/python/index.html?id=1234&amp;name=tom</span><br><span class="line">(<span class="string">'SERVER_PROTOCOL'</span>, <span class="string">'HTTP/1.1'</span>)</span><br><span class="line">(<span class="string">'wsgi.url_scheme'</span>, <span class="string">'http'</span>)</span><br><span class="line">(<span class="string">'HTTP_HOST'</span>, <span class="string">'127.0.0.1:9999'</span>)</span><br><span class="line">(<span class="string">'SERVER_PORT'</span>, <span class="string">'9999'</span>)</span><br><span class="line">(<span class="string">'REMOTE_ADDR'</span>, <span class="string">'127.0.0.1'</span>)</span><br><span class="line"></span><br><span class="line">(<span class="string">'REQUEST_METHOD'</span>, <span class="string">'GET'</span>)</span><br><span class="line">(<span class="string">'CONTENT_TYPE'</span>, <span class="string">'text/plain'</span>)</span><br><span class="line">(<span class="string">'PATH_INFO'</span>, <span class="string">'/python/index.html'</span>)</span><br><span class="line">(<span class="string">'QUERY_STRING'</span>, <span class="string">'id=1234&amp;name=tom'</span>)</span><br><span class="line">(<span class="string">'HTTP_USER_AGENT'</span>, <span class="string">'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Maxthon/5.0 Chrome/55.0.2883.75 Safari/537.36'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="QUERY-STRING-查询字符串的解析"><a href="#QUERY-STRING-查询字符串的解析" class="headerlink" title="QUERY_STRING 查询字符串的解析"></a>QUERY_STRING 查询字符串的解析</h2><p>WSGI服务器程序处理过HTTP报文后，返回一个字典，可以得到查询字符串<code>(&#39;QUERY_STRING&#39;, &#39;id=1234&amp;name=tom&#39;)</code>。这个键值对用起来不方便。</p>
<p>注：WSGI服务器指的是由make_server()函数创建的服务器，它会返回environ字典</p>
<p>1、编程序解析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># id=5&amp;name=wayne</span></span><br><span class="line">qstr = environ.get(<span class="string">'QUERY_STRING'</span>)</span><br><span class="line">print(qstr)</span><br><span class="line"><span class="keyword">if</span> qstr:</span><br><span class="line">    <span class="keyword">for</span> pair <span class="keyword">in</span> qstr.split(<span class="string">'&amp;'</span>):</span><br><span class="line">        k, _, v = pair.partition(<span class="string">'='</span>)</span><br><span class="line">        print(<span class="string">"k=&#123;&#125;, v=&#123;&#125;"</span>.format(k,v))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># id=5&amp;name=wayne</span></span><br><span class="line">querstr = environ.get(<span class="string">'QUERY_STRING'</span>)</span><br><span class="line"><span class="keyword">if</span> querystr:</span><br><span class="line">    querdict = &#123;k:v <span class="keyword">for</span> k,_,v <span class="keyword">in</span> map(<span class="keyword">lambda</span> item: item.partition(<span class="string">'='</span>), querystr.split(<span class="string">'&amp;'</span>))&#125;</span><br><span class="line">print(querydict)</span><br></pre></td></tr></table></figure>
<p>2、使用cgi模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># id=5&amp;name=wayne</span></span><br><span class="line">qstr = environ.get(<span class="string">'QUERY_STRING'</span>)</span><br><span class="line">print(qstr)</span><br><span class="line">print(parse_qs(qstr))</span><br><span class="line"><span class="comment"># &#123;'name': ['wayne'], 'id': ['5']&#125;</span></span><br></pre></td></tr></table></figure>
<p>可以看到使用这个库，可以解析查询字符串，请注意value是列表，为什么？</p>
<p>这是因为同一个key可以有多个值</p>
<p>cgi模块过期了，建议使用urllib</p>
<p>3、使用urllib库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http://127.0.0.1:9999/?id=5&amp;name=wayne&amp;age=&amp;comment=1,a,c&amp;age=19&amp;age=20</span></span><br><span class="line">qstr = environ.get(<span class="string">'QUERY_STRING'</span>)</span><br><span class="line">print(qstr)</span><br><span class="line">print(parse.parse_qs(qstr))  <span class="comment"># 字典</span></span><br><span class="line">print(parse.parse_qs1(qstr))  <span class="comment"># 二元组列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">id=<span class="number">5</span>&amp;name=wayne&amp;age=&amp;comment=<span class="number">1</span>,a,c&amp;age=<span class="number">19</span>&amp;age=<span class="number">20</span></span><br><span class="line">&#123;<span class="string">'name'</span>: [<span class="string">'wayne'</span>], <span class="string">'age'</span>: [<span class="string">'19'</span>, <span class="string">'20'</span>], <span class="string">'id'</span>: [<span class="string">'5'</span>], <span class="string">'comment'</span>: [<span class="string">'1,a,c'</span>]&#125;</span><br><span class="line">[(<span class="string">'id'</span>, <span class="string">'5'</span>), (<span class="string">'name'</span>, <span class="string">'wayne'</span>), (<span class="string">'comment'</span>, <span class="string">'1,a,c'</span>), (<span class="string">'age'</span>, <span class="string">'19'</span>), (<span class="string">'age'</span>, <span class="string">'20'</span>)]</span><br></pre></td></tr></table></figure>
<p>parse_qs函数，将同一个名称的多值，保存在字典中，使用了列表保存。<br><code>comment=1,a,c</code> 这不是多值，这是一个值。<br><code>age</code> 是多值。</p>
<h4 id="environ的解析–webob库"><a href="#environ的解析–webob库" class="headerlink" title="environ的解析–webob库"></a>environ的解析–webob库</h4><p>环境数据有很多，都是存在字典中的，字典的存取方式没有对象的属性访问方便。使用第三方库webob，可以把环境数据解析、封装成对象。</p>
<p>注：环境数据指服务器返回的environ字典</p>
<h5 id="webob简介"><a href="#webob简介" class="headerlink" title="webob简介"></a>webob简介</h5><p>Python下，可以对WSGI请求进行解析，并提供对响应进行高级封装的库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install webob</span><br></pre></td></tr></table></figure>
<p>官网文档 <code>docs.webob.org</code></p>
<h5 id="webob-Request对象"><a href="#webob-Request对象" class="headerlink" title="webob.Request对象"></a>webob.Request对象</h5><p>将环境参数(environ)解析并封装成request对象</p>
<p>GET方法，发送的数据是URL中Query string，在Request Header中。<br><code>request.GET</code>就是一个字典MultiDict，里面就封装着查询字符串。<br>POST方法，”提交”的数据是放在Request Body里面，但是也可以同时使用Query String。<br><code>request.POST</code>可以获取Request Body中的数据，也是个字典MultiDict。</p>
<p>不关心什么方法提交，只关心数据，可以使用<code>request.params</code>，它里面是所有提交数据的封装。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request = webob.Request(environ)</span><br><span class="line">print(request.headers) <span class="comment"># 类字典容器</span></span><br><span class="line">print(request.method)</span><br><span class="line">print(request.path)</span><br><span class="line">print(request.query_string) <span class="comment"># 查询字符串</span></span><br><span class="line">print(request.GET) <span class="comment"># GET方法的所有数据</span></span><br><span class="line">print(request.POST) <span class="comment"># POST方法的所有数据</span></span><br><span class="line">print(<span class="string">'params = &#123;&#125;'</span>.format(request.params)) <span class="comment"># 所有数据，参数</span></span><br></pre></td></tr></table></figure>
<h5 id="MultiDict"><a href="#MultiDict" class="headerlink" title="MultiDict"></a>MultiDict</h5><p>MultiDict允许一个key存了好几个值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob.multidict <span class="keyword">import</span> MultiDict</span><br><span class="line">md = MultiDict()</span><br><span class="line">md.add(<span class="number">1</span>, <span class="string">'magedu'</span>)</span><br><span class="line">md.add(<span class="number">1</span>, <span class="string">'.com'</span>)</span><br><span class="line">md.add(<span class="string">'a'</span>, <span class="number">1</span>)</span><br><span class="line">md.add(<span class="string">'a'</span>, <span class="number">2</span>)</span><br><span class="line">md.add(<span class="string">'b'</span>, <span class="string">'3'</span>)</span><br><span class="line">md[<span class="string">'b'</span>] = <span class="string">'4'</span></span><br><span class="line"><span class="keyword">for</span> pair <span class="keyword">in</span> md.items():</span><br><span class="line">    print(pair)</span><br><span class="line">    print(md.getall(<span class="number">1</span>))</span><br><span class="line">    <span class="comment">#print(md.getone('a')) # 只能有一个值</span></span><br><span class="line">    print(md.get(<span class="string">'a'</span>)) <span class="comment"># 返回一个值</span></span><br><span class="line">    print(md.get(<span class="string">'c'</span>)) <span class="comment"># 不会抛异常KeyError，返回None</span></span><br></pre></td></tr></table></figure>
<h5 id="webob-Response对象"><a href="#webob-Response对象" class="headerlink" title="webob.Response对象"></a>webob.Response对象</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">res = webob.Response()</span><br><span class="line">print(res.status)</span><br><span class="line">print(res.headerlist)</span><br><span class="line">start_response(res.status, res.headerlist)</span><br><span class="line"><span class="comment"># 返回可迭代对象</span></span><br><span class="line">html = <span class="string">'&lt;h1&gt;马哥教育欢迎你&lt;/h1&gt;'</span>.encode(<span class="string">"utf-8"</span>)</span><br><span class="line"><span class="keyword">return</span> [html]</span><br></pre></td></tr></table></figure>
<p>如果一个Application是一个类的实例，可以实现 <code>__call__</code> 方法。<br>我们来看看webob.Response类的源代码</p>
<p><img src="/images/python-WEB开发/WEB开发6.png" alt=""></p>
<p>注：从原码看，Response方法实现了<code>__call__</code>方法，是符合WSGI接口标准的方法</p>
<p>由此可以得到下面代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ:dict, start_response)</span>:</span></span><br><span class="line"><span class="comment"># 请求处理</span></span><br><span class="line">    request = webob.Request(environ)</span><br><span class="line">    print(request.method)</span><br><span class="line">    print(request.path)</span><br><span class="line">    print(request.query_string)</span><br><span class="line">    print(request.GET)</span><br><span class="line">    print(request.POST)</span><br><span class="line">    print(<span class="string">'params = &#123;&#125;'</span>.format(request.params))</span><br><span class="line">    <span class="comment"># 响应处理</span></span><br><span class="line">    res = webob.Response() <span class="comment"># [('Content-Type', 'text/html; charset=UTF-8'), ('Content-Length', '0')]</span></span><br><span class="line">    res.status_code = <span class="number">200</span> <span class="comment"># 默认200</span></span><br><span class="line">    print(res.content_type)</span><br><span class="line">    html = <span class="string">'&lt;h1&gt;马哥教育欢迎你&lt;/h1&gt;'</span>.encode(<span class="string">"utf-8"</span>)</span><br><span class="line">    res.body = html</span><br><span class="line">    <span class="keyword">return</span> res(environ, start_response)</span><br><span class="line">注：这里的Request()并没有用到，只是为了打印。返回是通过Response()实现的</span><br></pre></td></tr></table></figure>
<h5 id="webob-dec装饰器"><a href="#webob-dec装饰器" class="headerlink" title="webob.dec装饰器"></a>webob.dec装饰器</h5><p>wsgify装饰器<br>文档<br><a href="https://docs.pylonsproject.org/projects/webob/en/stable/api/dec.html" target="_blank" rel="noopener">https://docs.pylonsproject.org/projects/webob/en/stable/api/dec.html</a></p>
<p><code>class webob.dec.wsgify(func=None, RequestClass=None, args=(), kwargs=None, middleware_wraps=None)</code></p>
<p>要求提供类似下面的可调用对象，以函数举例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="meta">@wsgify</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(request:webob.Request)</span> -&gt; webob.Response:</span>  <span class="comment"># 传入的是包装过的Request</span></span><br><span class="line">    res = webob.Response(<span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span>)  <span class="comment"># 依然要实例化一个Response</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>
<blockquote>
<p>  wsgify装饰器装饰的函数应该具有一个参数，这个参数是<code>webob.Request</code>类型，是对字典environ的对象化后的实例。</p>
<p>  注：这条非常重要，需要注意，提供webob.Request类型参数</p>
<p>  返回值：<br>  可以是一个<code>webob.Response</code>类型实例<br>  可以是一个bytes类型实例，它会被封装成<code>webob.Response</code>类型实例的body属性<br>  可以是一个字符串类型实例，它会被转换成bytes类型实例，然后会被封装成<code>webob.Response</code>类型实例的body属性<br>  总之，返回值会被封装成<code>webob.Response</code>类型实例返回</p>
<p>  注：返回值很重要，无论如何都会返回<code>webob.Response</code>类型实例</p>
</blockquote>
<p>由此修改测试代码，如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">import</span> webob</span><br><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="comment"># application函数不用了，用来和app函数对比</span></span><br><span class="line"><span class="comment"># 这里需要注意，模块名不要与第三方的库名重名，比如也叫webob，这会造成执行错误。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ:dict, start_response)</span>:</span></span><br><span class="line"><span class="comment"># 请求处理</span></span><br><span class="line">    request = webob.Request(environ)</span><br><span class="line">    print(request.method)</span><br><span class="line">    print(request.path)</span><br><span class="line">    print(request.query_string)</span><br><span class="line">    print(request.GET)</span><br><span class="line">    print(request.POST)</span><br><span class="line">    print(<span class="string">'params = &#123;&#125;'</span>.format(request.params))</span><br><span class="line">    <span class="comment"># 响应处理</span></span><br><span class="line">    res = webob.Response() <span class="comment"># [('Content-Type', 'text/html; charset=UTF-8'), ('Content-Length', '0')]</span></span><br><span class="line">    res.status_code = <span class="number">200</span> <span class="comment"># 默认200，设置状态码</span></span><br><span class="line">    print(res.content_type)</span><br><span class="line">    html = <span class="string">'&lt;h1&gt;马哥教育欢迎你&lt;/h1&gt;'</span>.encode(<span class="string">"utf-8"</span>) </span><br><span class="line">    res.body = html  <span class="comment"># 设置页面的内容</span></span><br><span class="line">    <span class="keyword">return</span> res(environ, start_response)</span><br><span class="line"></span><br><span class="line"><span class="meta">@wsgify</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(request:webob.Request)</span> -&gt; webob.Response:</span></span><br><span class="line">    print(request.method)</span><br><span class="line">    print(request.path)</span><br><span class="line">    print(request.query_string)</span><br><span class="line">    print(request.GET)</span><br><span class="line">    print(request.POST)</span><br><span class="line">    print(<span class="string">'params = &#123;&#125;'</span>.format(request.params))</span><br><span class="line">    </span><br><span class="line">    res = webob.Response(<span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span>)</span><br><span class="line"><span class="comment"># 需要设置返回的内容，其他如状态码都用默认的</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment"># 这里也可以直接返回字符串，如：return '&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'，这也可以正常访问，因为会被</span></span><br><span class="line"><span class="comment"># 装饰器封装成webob.Response类型实例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, app)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	server.serve_forever() <span class="comment"># server.handle_request() 一次</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure>
<p>将上面的app函数封装成类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line"><span class="meta">@wsgify</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你. magedu.com&lt;/h1&gt;'</span></span><br><span class="line"><span class="comment"># 直接返回字符串也可以</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, App())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever() <span class="comment"># server.handle_request() 一次</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure>
<p>上面的代码中，所有的请求，都有这个App类的实例处理，需要对它进行改造。</p>
<h3 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request, dec</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server, demo_app</span><br><span class="line"></span><br><span class="line"><span class="meta">@dec.wsgify</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(request:Request)</span> -&gt; Response:</span></span><br><span class="line">    print(request.path)</span><br><span class="line">    <span class="keyword">return</span> Response(<span class="string">"&lt;h1&gt;马哥教育欢迎你们大家&lt;/h1&gt;"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, app)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">    	server.server_close()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/23/python基础学习-WEB开发及请求响应的处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/23/python基础学习-WEB开发及请求响应的处理/" itemprop="url">
                  python基础学习-WEB开发及请求响应的处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-10-23 09:37:33" itemprop="dateCreated datePublished" datetime="2020-10-23T09:37:33+08:00">2020-10-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-11-03 15:49:04" itemprop="dateModified" datetime="2020-11-03T15:49:04+08:00">2020-11-03</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="WEB开发"><a href="#WEB开发" class="headerlink" title="WEB开发"></a>WEB开发</h1><p><img src="/images/python-WEB开发/WEB开发1.png" alt=""></p>
<p>CS即客户端、服务器编程。</p>
<p>客户端、服务端之间需要使用Socket，约定协议、版本（往往使用的协议是TCP或者UDP），指定地址和端口，就可以通信了。</p>
<p>客户端、服务端传输数据，数据可以有一定的格式，双方必须先约定好。</p>
<p><img src="/images/python-WEB开发/WEB开发2.png" alt=""></p>
<p>BS编程，即Browser、Server开发。</p>
<p>Browser浏览器，一种特殊的客户端，支持HTTP(S)协议，能够通过URL向服务端发起请求，等待服务端返回HTML等数据，并在浏览器内可视化展示的程序。</p>
<p>Server，支持HTTP(s)协议，能够接受众多客户端发起的HTTP协议请求，经过处理，将HTML等数据返回给浏览器。</p>
<p>本质上说，BS是一种特殊的CS，即客户端必须是一种支持HTTP协议且能解析并渲染HTML的软件，服务端必须是能够接受多客户端HTTP访问的服务器软件。</p>
<p>HTTP协议底层基于TCP协议实现。</p>
<ul>
<li>BS开发分为两端开发<ul>
<li>客户端开发，或称前端开发。HTML、CSS、JavaScript等</li>
<li>服务端开发，Python有WSGI、Django、Flask、Tornado等</li>
</ul>
</li>
</ul>
<h1 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h1><h2 id="安装httpd"><a href="#安装httpd" class="headerlink" title="安装httpd"></a>安装httpd</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd</span><br></pre></td></tr></table></figure>
<p>使用httpd服务，观察http协议</p>
<h2 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h2><p>http协议是无状态协议</p>
<p>同一个客户端的两次请求之间没有任何关系，从服务器端角度来说，它不知道这两个请求来自同一个客户端。</p>
<h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><p>键值对信息。</p>
<p>浏览器发起每一次请求时，都会把cookie信息发给服务器端。</p>
<p>是一种客户端、服务器端传递数据的技术。</p>
<p>服务端可以通过判断这些信息，来确定这次请求是否和之前的请求有关联。</p>
<p>一般来说cookie信息是在服务器端生成，返回给客户端的。</p>
<p>客户端可以自己设置cookie信息。</p>
<h2 id="URL组成"><a href="#URL组成" class="headerlink" title="URL组成"></a>URL组成</h2><p>URL可以说就是地址，uniform resource locator 统一资源定位符，每一个链接指向一个资源供客户端访问。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">schema://host[:port#]/path/.../[;url-params][?query-string][#anchor]</span><br><span class="line"># 这里主要关心schema://host[:port#]/path/，[?query-string]</span><br></pre></td></tr></table></figure>
<p>例如，通过下面的URL访问网页</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.magedu.com/pathon/index.html?id=5&amp;name=python</span><br></pre></td></tr></table></figure>
<p>访问静态资源时，通过上面这个URL访问的是网站的某路径下的index.html文件，而这个文件对应磁盘上的真实的文件 。就会从磁盘上读取这个文件，并把文件的内容发回浏览器端。</p>
<p>scheme模式、协议：</p>
<p>http、ftp、https、file、mailto等等。mysql等都是类似这样写。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">host:port</span><br><span class="line"># www.magedu.com:80，80端口是默认端口可以不写。域名会使用DNS解析，域名会解析成IP才能使用。实际上会对解析后返回的IP的TCP的80端口发起访问。</span><br><span class="line"></span><br><span class="line">/path/to/resource</span><br><span class="line"># path，指向资源的路径。</span><br><span class="line"></span><br><span class="line">?key1=value1&amp;key2=value2</span><br><span class="line"># query string，查询字符串，问号分割，后面key=value形式，且使用&amp;符号分割。</span><br></pre></td></tr></table></figure>
<h2 id="HTTP消息"><a href="#HTTP消息" class="headerlink" title="HTTP消息"></a>HTTP消息</h2><p>消息分为Request、Response。</p>
<p>Request：浏览器向服务器发起请求</p>
<p>Response：服务器对客户端请求的响应</p>
<p>请求和响应消息都是由请求行、Header消息报头、Body消息正文组成。</p>
<h3 id="请求"><a href="#请求" class="headerlink" title="请求"></a>请求</h3><p>请求消息行：请求方法Method 请求路径 协议版本CRLF</p>
<p><img src="/images/python-WEB开发/WEB开发3.png" alt=""></p>
<p>请求方法Method</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">GET</span>    请求获取URL对应的资源</span><br><span class="line">POST   提交数据至服务器端</span><br><span class="line">HEAD   和GET类似，不过不返回消息正文</span><br></pre></td></tr></table></figure>
<p>常见传递信息的方式</p>
<p>1、GET方法使用Query String</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.magedu.com/pathon/index.html?id=5&amp;name=python</span><br></pre></td></tr></table></figure>
<p>通过查询字符串在URL中传递参数</p>
<p>2、POST方法提交数据</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9999/xxx/yyy?id=5&amp;name=magedu</span><br><span class="line">使用表单提交数据，文本框input的name属性分别为age、weight、height</span><br><span class="line"></span><br><span class="line">请求消息如下</span><br><span class="line">POST /xxx/yyy?id=5&amp;name=magedu HTTP/1.1</span><br><span class="line">HOST: 127.0.0.1:9999</span><br><span class="line">content-length: 26</span><br><span class="line">content-type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">age=5&amp;weight=80&amp;height=170</span><br></pre></td></tr></table></figure>
<p>3、URL中本身就包含着信息</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.magedu.com/python/student/001</span><br></pre></td></tr></table></figure>
<h3 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h3><p>响应消息行：协议版本 状态码 消息描述CRLF</p>
<p><img src="/images/python-WEB开发/WEB开发4.png" alt=""></p>
<p>status code状态码</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">状态码在响应头第一行</span><br><span class="line">    <span class="number">1</span>XX    提示信息，表示请求已被成功接收，继续处理</span><br><span class="line">    <span class="number">2</span>XX    表示正常响应</span><br><span class="line">           <span class="number">200</span>    正常返回了网页内容</span><br><span class="line">    <span class="number">3</span>XX    重定向</span><br><span class="line">           <span class="number">301</span>    页面永久性移走，永久重定向。返回新的URL，浏览器会根据返回的url发起新的request请求</span><br><span class="line">           <span class="number">302</span>    临时重定向</span><br><span class="line">           <span class="number">304</span>    资源未修改，浏览器使用本地缓存</span><br><span class="line">    <span class="number">4</span>XX    客户端请求错误</span><br><span class="line">           <span class="number">404</span>    Not Found，网页找不到，客户端请求的资源有错</span><br><span class="line">           <span class="number">400</span>    请求语法错误</span><br><span class="line">           <span class="number">401</span>    请求要求身份验证</span><br><span class="line">           <span class="number">403</span>    服务器拒绝请求</span><br><span class="line">    <span class="number">5</span>XX    服务器端错误</span><br><span class="line">           <span class="number">500</span>    服务器内部错误</span><br><span class="line">           <span class="number">502</span>    上游服务器错误，例如nginx反向代理的时候</span><br></pre></td></tr></table></figure>
<h3 id="无状态，有连接和短连接"><a href="#无状态，有连接和短连接" class="headerlink" title="无状态，有连接和短连接"></a>无状态，有连接和短连接</h3><p>无状态，指的是服务器无法知道2次请求之间的联系，即使是前后2次同一个浏览器也没有任何数据能够判断出是同一个浏览器的请求。后来可以通过cookie、session来判断。</p>
<p>有连接，是因为它基于TCP协议，是面向连接的，需要3次握手、4次断开</p>
<p>短连接，Http1.1之前，都是一个请求一个连接，而TCP的连接创建销毁成本高，对服务器有很大的影响。所以，自HTTP1.1开始，支持keep-alive，默认也开启，一个连接打开后，会保持一段时间（可设置），浏览器再访问该服务器就使用这个TCP连接，减轻了服务器压力，提高了效率。</p>
<p>推荐图书《HTTP权威指南》</p>
<h1 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h1><p><img src="/images/python-WEB开发/WEB开发5.png" alt=""></p>
<p>浏览器使用http协议发起请求，请求到达服务器后进行解包，之后封装成environ，再调用application，将environ和start_response传给application，application对请求进行逻辑处理，之后返回状态码和报头通过server端给到浏览器，再将处理后的正文给server端，server端将html文本封装成http协议的包返回给浏览器。</p>
<p>WSGI主要规定了服务器端和应用程序间的接口。</p>
<h2 id="WSGI服务器——wsgiref"><a href="#WSGI服务器——wsgiref" class="headerlink" title="WSGI服务器——wsgiref"></a>WSGI服务器——wsgiref</h2><p>wsgiref是一个WSGI参考实现库</p>
<p><code>wsgiref.simple_server</code>模块实现一个简单的WSGI HTTP服务器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wsgiref.simple_server.make_server(host, port, app, server_class=WSGIServer, handler_class=WSGIRequestHandler)  <span class="comment"># 启动一个WSGI服务器</span></span><br><span class="line">wsgiref.simple_server.demo_app(environ, start_response)  <span class="comment"># 一个函数，小巧完整的WSGI的应用程序的实现</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回文本的例子</span></span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server, demo_app</span><br><span class="line"></span><br><span class="line">ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">9999</span></span><br><span class="line">server = make_server(ip, port, demo_app)  <span class="comment"># demo_app应用程序，可调用</span></span><br><span class="line"><span class="comment"># make_server就是登录server端的，demo_app就是处理请求的application，只要把application的名字传给</span></span><br><span class="line"><span class="comment"># make_server即可，之后application会被调用，这是底层的工作，我们不用关心</span></span><br><span class="line">server.serve_forever()  <span class="comment"># server.handle_request() 执行一次</span></span><br></pre></td></tr></table></figure>
<p>WSGI服务器作用</p>
<ul>
<li>监听HTTP服务端口（TCPServer，默认端口80）</li>
<li>接收浏览器端的HTTP请求并解析封装成environ环境数据</li>
<li>负责调用应用程序，将environ和start_response方法传入</li>
<li>将应用程序响应的正文封装成HTTP响应报文返回浏览器端</li>
</ul>
<h2 id="WSGI-APP应用程序端"><a href="#WSGI-APP应用程序端" class="headerlink" title="WSGI APP应用程序端"></a>WSGI APP应用程序端</h2><p>1、应用程序应该是一个可调用对象</p>
<p>Python中应该是函数、类、实现了<code>__call__</code>方法的类的实例</p>
<p>2、这个可调用对象应该接收两个参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 函数实现</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 类实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 3 类实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>3、以上的可调用对象实现，都必须返回一个可迭代对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">res_str = <span class="string">b'magedu.com\n'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数实现</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> [res_str]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 类实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span>  <span class="comment">#实现此方法，对象即可迭代</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 类实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> [res_str]</span><br></pre></td></tr></table></figure>
<p>environ和start_response这两个参数名可以是任何合法名，但是一般默认都是这2个名字。</p>
<p>应用程序端还有些其他的规定，暂不用关心</p>
<h3 id="environ"><a href="#environ" class="headerlink" title="environ"></a>environ</h3><p>environ是包含Http请求信息的dict对象</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>REQUEST_METHOD</td>
<td>请求方法，GET、POST等</td>
</tr>
<tr>
<td>PATH_INFO</td>
<td>URL中的路径部分</td>
</tr>
<tr>
<td>QUERY_STRING</td>
<td>查询字符串</td>
</tr>
<tr>
<td>SERVER_NAME, SERVER_PORT</td>
<td>服务器名、端口</td>
</tr>
<tr>
<td>HTTP_HOST</td>
<td>地址和端口</td>
</tr>
<tr>
<td>SERVER_PROTOCOL</td>
<td>协议</td>
</tr>
<tr>
<td>HTTP_USER_AGENT</td>
<td>UserAgent信息</td>
</tr>
</tbody>
</table>
<h3 id="start-response"><a href="#start-response" class="headerlink" title="start_response"></a>start_response</h3><p>它是一个可调用对象。有3个参数，定义如下</p>
<p><code>start_response(status, response_headers, exc_info=None)</code></p>
<p>status是状态码，例如<code>200 OK</code></p>
<p>response_header是一个元素为二元组的列表，例如<code>[(&#39;Content-Type&#39;, &#39;text/plain;charset=utf-8&#39;)]</code></p>
<p>exc_info在错误处理的时候使用</p>
<p>start_response应该在返回可迭代对象之前调用，因为它返回的是Response Header（这里的意思是先返回状态码和报头）。返回的可迭代对象是Response Body（这里返回的是正文）。</p>
<h2 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h2><p>服务器程序需要调用符合上述定义的可调用对象APP，传入environ、start_response，APP处理后，返回响应头和可迭代对象的正文，由服务器封装返回浏览器端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回网页的例子</span></span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></span><br><span class="line">    status = <span class="string">'200 ok'</span></span><br><span class="line">    headers = [(<span class="string">'Content-Type'</span>, <span class="string">'text/html;charset=utf-8'</span>)]</span><br><span class="line">    start_response(status, headers)</span><br><span class="line">    <span class="comment"># 返回可迭代对象</span></span><br><span class="line">    html = <span class="string">'&lt;h1&gt;马哥教育欢迎你&lt;/h1&gt;'</span>.encode(<span class="string">"utf-8"</span>)</span><br><span class="line">    <span class="keyword">return</span> [html]</span><br><span class="line"></span><br><span class="line">ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">9999</span></span><br><span class="line">server = make_server(ip, port, application)</span><br><span class="line">server.serve_forever()  <span class="comment"># server.handle_request() 一次</span></span><br></pre></td></tr></table></figure>
<p>simple_server只是参考用，不能用于生产。</p>
<p>测试用命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -I http://192.168.142.1:9999/xxx?id=5</span><br><span class="line">curl -X POST http://192.168.142.1:9999/yyy -d '&#123;"x":2&#125;'</span><br></pre></td></tr></table></figure>
<p>-I：使用HEAD方法</p>
<p>-X：指定方法，-d传输数据</p>
<p>到这里就完成了一个简单的WEB程序开发。</p>
<p>WEB服务器</p>
<ul>
<li>本质上就是一个TCP服务器，监听在特定的端口上</li>
<li>支持HTTP协议，能够将HTTP请求报文进行解析，能够把响应数据进行HTTP协议的报文封装并返回浏览器端</li>
<li>实现了WSGI协议，该协议约定了和应用程序之间的接口（参看PEP333，<a href="https://www.python.org/dev/peps/pep-0333/）" target="_blank" rel="noopener">https://www.python.org/dev/peps/pep-0333/）</a></li>
</ul>
<p>APP应用程序</p>
<ul>
<li>遵从WSGI协议</li>
<li>本身是一个可调用对象</li>
<li>调用start_response，返回响应头部</li>
<li>返回包含正文的可迭代对象</li>
</ul>
<p>为了更好的理解WSGI框架的工作原理，现在开始动手自己写一个WEB框架。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/10/vim-脚本/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/10/vim-脚本/" itemprop="url">
                  vim-脚本
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-09-10 11:15:06" itemprop="dateCreated datePublished" datetime="2020-09-10T11:15:06+08:00">2020-09-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-09-16 16:39:32" itemprop="dateModified" datetime="2020-09-16T16:39:32+08:00">2020-09-16</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/vscode/" itemprop="url" rel="index"><span itemprop="name">vscode</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用脚本语言，可以更灵活地定制编辑器以完成复杂的任务。</p>
<p>例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.vimrc</span><br><span class="line">let i = 1                                                                                                               </span><br><span class="line">while i &lt; 5 </span><br><span class="line">    echo "count is" i</span><br><span class="line">    let i += 1</span><br><span class="line">endwhile</span><br><span class="line">当再次使用vim打开文件时就会执行这个脚本。</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一行的 <span class="string">":let"</span> 命令给一个变量赋值。通常的用法是: </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">let</span> &#123;变量&#125; = &#123;表达式&#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"while"</span> 命令开始一个循环。通常的用法是:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">while</span> &#123;条件&#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#123;语句&#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> endwhile</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 只要条件为真，<span class="string">"while"</span> 和 <span class="string">"endwhile"</span> 包围的语句就会被执行。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果你碰巧写了一个死循环语句，你可以用 CTRL-C 来终止 (在 MS-Windows上使用 CTRL-Break)。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"echo"</span> 命令显示它的参数。</span></span><br><span class="line"></span><br><span class="line">for i in range(1, 4)</span><br><span class="line">    echo "count is" i</span><br><span class="line">endfor</span><br></pre></td></tr></table></figure>
<p>数值可以是十进制，十六进制，八进制或者二进制的。</p>
<p>“echo” 命令总以十进制格式显示数值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">echo 0x7f 036</span><br><span class="line">127 30</span><br><span class="line"></span><br><span class="line">在一个数值前加上减号会将其变为负值。十六进制数、八进制数和二进制数亦然。减号也</span><br><span class="line">用于减法操作。</span><br><span class="line"></span><br><span class="line">echo 0x7f -036</span><br><span class="line">97 </span><br><span class="line"></span><br><span class="line">表达式中的空白字符将被忽略。然而，为了增加表达式的易读性，建议用来分隔不同的项</span><br><span class="line">目。例如，为了不和上面的负号混淆，在减号和之后的数字前加入一个空格: </span><br><span class="line">echo 0x7f - 036</span><br></pre></td></tr></table></figure>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>一个变量名可以由 ASCII 字符、数字和下划线组成。但是变量名不能以数字开始。</p>
<p>这些变量都是全局的。要列出当前定义的所有变量可以用这个命令:  <code>:let</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">你可以在任何地方使用全局变量。这同时也意味着: 当一个脚本文件使用 "count" 变量时，可能另一个脚本文件也使用了</span><br><span class="line">这个变量。这至少会引起混乱，严重时会导致脚本无法正常工作。为避免这种情况发生，你可以在变量名前加上 "s:" 使其</span><br><span class="line">变成脚本文件的局部变量。例如，一脚本包含以下代码: </span><br><span class="line"></span><br><span class="line">let s:count = 1</span><br><span class="line">while s:count &lt; 5</span><br><span class="line">    source other.vim</span><br><span class="line">    let s:count += 1</span><br><span class="line">endwhile</span><br><span class="line"></span><br><span class="line">由于 "s:count" 是局部变量，你可以确信调用 (source) "other.vim" 脚本时不会改变它的值。如果 </span><br><span class="line">"other.vim" 也使用一个 "s:count" 变量，该变量将会是仅在脚本内有效的局部变量。</span><br><span class="line"></span><br><span class="line">还有很多其它类型的变量，最常用的几类有:</span><br><span class="line"></span><br><span class="line">        b:name          缓冲区的局部变量</span><br><span class="line">        w:name          窗口的局部变量</span><br><span class="line">        g:name          全局变量 (也用于函数中)</span><br><span class="line">        v:name          Vim 预定义的变量</span><br></pre></td></tr></table></figure>
<h3 id="打开-py文件时自动添加几行"><a href="#打开-py文件时自动添加几行" class="headerlink" title="打开.py文件时自动添加几行"></a>打开<code>.py</code>文件时自动添加几行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.vimrc</span><br><span class="line">function PythonHeader()</span><br><span class="line">    call setline(1, "#!/usr/bin/python")</span><br><span class="line">    call setline(2, "# -*- coding: utf-8 -*-")</span><br><span class="line">    call setline(3, "#Author:Kevin")</span><br><span class="line">    call setline(4, "#Subject:xx")</span><br><span class="line">    call setline(5, "import sys")</span><br><span class="line">    call setline(6, "load(sys)")</span><br><span class="line">    call setline(7, "sys.setdefaultencoding('utf8')")</span><br><span class="line">    normal G</span><br><span class="line">    normal o</span><br><span class="line">    normal o</span><br><span class="line">endfunc</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> call命令用来调用函数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> setline() 函数将第一个参数表示的行的文本置为第二个参数表示的字符串。要将文本添加到当前行，可以使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">function</span> setline。在当前行的末尾添加文本<span class="string">' hello'</span>：call setline(line(<span class="string">'.'</span>), getline(<span class="string">'.'</span>) . <span class="string">' hello'</span>)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> normal  被用来使用新的缩写。normal命令可以用来执行普通模式命令。上面函数中的三个意思应该是跳转到最后一行，再往下两行开始输入</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/09/python基础学习-转：Python之路-第十七篇-logging模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/09/python基础学习-转：Python之路-第十七篇-logging模块/" itemprop="url">
                  python基础学习-转：Python之路(第十七篇)logging模块
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-09-09 14:32:18 / 修改時間：15:47:52" itemprop="dateCreated datePublished" datetime="2020-09-09T14:32:18+08:00">2020-09-09</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转自：<a href="https://www.cnblogs.com/Nicholas0707/p/9021672.html" target="_blank" rel="noopener">https://www.cnblogs.com/Nicholas0707/p/9021672.html</a></p>
<h1 id="一、logging模块"><a href="#一、logging模块" class="headerlink" title="一、logging模块"></a>一、logging模块</h1><h2 id="（一）、日志相关概念"><a href="#（一）、日志相关概念" class="headerlink" title="（一）、日志相关概念"></a>（一）、日志相关概念</h2><p>日志是一种可以追踪某些软件运行时所发生事件的方法。软件开发人员可以向他们的代码中调用日志记录相关的方法来表明发生了某些事情。一个事件可以用一个可包含可选变量数据的消息来描述。此外，事件也有重要性的概念，这个重要性也可以被称为严重性级别（level）。</p>
<h3 id="1、日志的作用"><a href="#1、日志的作用" class="headerlink" title="1、日志的作用"></a>1、日志的作用</h3><p>通过log的分析，可以方便用户了解系统或软件、应用的运行情况；如果你的应用log足够丰富，也可以分析以往用户的操作行为、类型喜好、地域分布或其他更多信息；如果一个应用的log同时也分了多个级别，那么可以很轻易地分析得到该应用的健康状况，及时发现问题并快速定位、解决问题，补救损失。</p>
<p>简单来讲就是，我们通过记录和分析日志可以了解一个系统或软件程序运行情况是否正常，也可以在应用程序出现故障时快速定位问题。比如，做运维的同学，在接收到报警或各种问题反馈后，进行问题排查时通常都会先去看各种日志，大部分问题都可以在日志中找到答案。再比如，做开发的同学，可以通过IDE控制台上输出的各种日志进行程序调试。对于运维老司机或者有经验的开发人员，可以快速的通过日志定位到问题的根源。可见，日志的重要性不可小觑。日志的作用可以简单总结为以下3点：</p>
<ul>
<li>程序调试</li>
<li>了解软件程序运行情况，是否正常</li>
<li>软件程序运行故障分析与问题定位</li>
</ul>
<p>如果应用的日志信息足够详细和丰富，还可以用来做用户行为分析，如：分析用户的操作行为、类型喜好、地域分布以及其它更多的信息，由此可以实现改进业务、提高商业利益。</p>
<h3 id="2、日志的等级"><a href="#2、日志的等级" class="headerlink" title="2、日志的等级"></a>2、日志的等级</h3><p>我们先来思考下下面的两个问题：</p>
<p>作为开发人员，在开发一个应用程序时需要什么日志信息？在应用程序正式上线后需要什么日志信息？</p>
<p>作为应用运维人员，在部署开发环境时需要什么日志信息？在部署生产环境时需要什么日志信息？</p>
<p>在软件开发阶段或部署开发环境时，为了尽可能详细的查看应用程序的运行状态来保证上线后的稳定性，我们可能需要把该应用程序所有的运行日志全部记录下来进行分析，这是非常耗费机器性能的。当应用程序正式发布或在生产环境部署应用程序时，我们通常只需要记录应用程序的异常信息、错误信息等，这样既可以减小服务器的I/O压力，也可以避免我们在排查故障时被淹没在日志的海洋里。那么，怎样才能在不改动应用程序代码的情况下实现在不同的环境记录不同详细程度的日志呢？这就是日志等级的作用了，我们通过配置文件指定我们需要的日志等级就可以了。</p>
<p>不同的应用程序所定义的日志等级可能会有所差别，分的详细点的会包含以下几个等级：</p>
<ul>
<li>DEBUG</li>
<li>INFO</li>
<li>NOTICE</li>
<li>WARNING</li>
<li>ERROR</li>
<li>CRITICAL</li>
<li>ALERT</li>
<li>EMERGENCY</li>
</ul>
<table>
<thead>
<tr>
<th>级别</th>
<th>何时使用</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEBUG</td>
<td>详细信息，典型地调试问题时会感兴趣。 详细的debug信息。</td>
</tr>
<tr>
<td>INFO</td>
<td>证明事情按预期工作。 关键事件。</td>
</tr>
<tr>
<td>WARNING</td>
<td>表明发生了一些意外，或者不久的将来会发生问题（如‘磁盘满了’）。软件还是在正常工作。</td>
</tr>
<tr>
<td>ERROR</td>
<td>由于更严重的问题，软件已不能执行一些功能了。 一般错误消息。</td>
</tr>
<tr>
<td>CRITICAL</td>
<td>严重错误，表明软件已不能继续运行了。</td>
</tr>
<tr>
<td>NOTICE</td>
<td>不是错误，但是可能需要处理。普通但是重要的事件。</td>
</tr>
<tr>
<td>ALERT</td>
<td>需要立即修复，例如系统数据库损坏。</td>
</tr>
<tr>
<td>EMERGENCY</td>
<td>紧急情况，系统不可用（例如系统崩溃），一般会通知所有用户。</td>
</tr>
</tbody>
</table>
<h3 id="3、日志字段信息与日志格式"><a href="#3、日志字段信息与日志格式" class="headerlink" title="3、日志字段信息与日志格式"></a>3、日志字段信息与日志格式</h3><p>一条日志信息对应的是一个事件的发生，而一个事件通常需要包括以下几个内容：</p>
<ul>
<li>事件发生时间</li>
<li>事件发生位置</li>
<li>事件的严重程度–日志级别</li>
<li>事件内容</li>
</ul>
<p>上面这些都是一条日志记录中可能包含的字段信息，当然还可以包括一些其他信息，如进程ID、进程名称、线程ID、线程名称等。日志格式就是用来定义一条日志记录中包含那些字段的，且日志格式通常都是可以自定义的。</p>
<h3 id="4、日志功能的实现"><a href="#4、日志功能的实现" class="headerlink" title="4、日志功能的实现"></a>4、日志功能的实现</h3><p>几乎所有开发语言都会内置日志相关功能，或者会有比较优秀的第三方库来提供日志操作功能，比如：log4j，log4php等。它们功能强大、使用简单。Python自身也提供了一个用于记录日志的标准库模块–logging。</p>
<h2 id="（二）logging模块"><a href="#（二）logging模块" class="headerlink" title="（二）logging模块"></a>（二）logging模块</h2><p>logging模块是Python内置的标准模块，主要用于输出运行日志，可以设置输出日志的等级、日志保存路径、日志文件回滚等；相比print，具备如下优点：</p>
<ul>
<li>可以通过设置不同的日志等级，在release版本中只输出重要信息，而不必显示大量的调试信息；</li>
<li>print将所有信息都输出到标准输出中，严重影响开发者从标准输出中查看其它数据；logging则可以由开发者决定将信息输出到什么地方，以及怎么输出。</li>
</ul>
<h3 id="1、-logging模块的日志级别"><a href="#1、-logging模块的日志级别" class="headerlink" title="1、 logging模块的日志级别"></a>1、 logging模块的日志级别</h3><p>logging模块默认定义了以下几个日志等级，它允许开发人员自定义其他日志级别，但是这是不被推荐的，尤其是在开发供别人使用的库时，因为这会导致日志级别的混乱。</p>
<table>
<thead>
<tr>
<th>日志等级（level）</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEBUG</td>
<td>最详细的日志信息，典型应用场景是 问题诊断</td>
</tr>
<tr>
<td>INFO</td>
<td>信息详细程度仅次于DEBUG，通常只记录关键节点信息，用于确认一切都是按照我们预期的那样进行工作</td>
</tr>
<tr>
<td>WARNING</td>
<td>当某些不期望的事情发生时记录的信息（如，磁盘可用空间较低），但是此时应用程序还是正常运行的</td>
</tr>
<tr>
<td>ERROR</td>
<td>由于一个更严重的问题导致某些功能不能正常运行时记录的信息</td>
</tr>
<tr>
<td>CRITICAL</td>
<td>当发生严重错误，导致应用程序不能继续运行时记录的信息</td>
</tr>
</tbody>
</table>
<p>开发应用程序或部署开发环境时，可以使用DEBUG或INFO级别的日志获取尽可能详细的日志信息来进行开发或部署调试；</p>
<p>应用上线或部署生产环境时，应该使用WARNING或ERROR或CRITICAL级别的日志来降低机器的I/O压力和提高获取错误日志信息的效率。日志级别的指定通常都是在应用程序的配置文件中进行指定的。</p>
<blockquote>
<p>  说明：</p>
<ul>
<li>上面列表中的日志等级是从上到下依次升高的，即：DEBUG &lt; INFO &lt; WARNING &lt; ERROR &lt; CRITICAL，而日志的信息量是依次减少的；</li>
<li>当为某个应用程序指定一个日志级别后，应用程序会记录所有日志级别大于或等于指定日志级别的日志信息，而不是仅仅记录指定级别的日志信息，nginx、php等应用程序以及这里的python的logging模块都是这样的。同样，logging模块也可以指定日志记录器的日志级别，只有级别大于或等于该指定日志级别的日志记录才会被输出，小于该等级的日志记录将会被丢弃。</li>
</ul>
</blockquote>
<h3 id="2、logging模块的使用方式介绍"><a href="#2、logging模块的使用方式介绍" class="headerlink" title="2、logging模块的使用方式介绍"></a>2、logging模块的使用方式介绍</h3><p>logging模块提供了两种记录日志的方式：</p>
<ul>
<li>第一种方式是使用logging提供的模块级别的函数</li>
<li>第二种方式是使用Logging日志系统的四大组件</li>
</ul>
<p>其实，logging所提供的模块级别的日志记录函数也是对logging日志系统相关类的封装而已。</p>
<p>logging模块定义的模块级别的常用函数</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>logging.debug(msg, *args, **kwargs)</code></td>
<td>创建一条严重级别为DEBUG的日志记录</td>
</tr>
<tr>
<td><code>logging.info(msg, *args, **kwargs)</code></td>
<td>创建一条严重级别为INFO的日志记录</td>
</tr>
<tr>
<td><code>logging.warning(msg, *args, **kwargs)</code></td>
<td>创建一条严重级别为WARNING的日志记录</td>
</tr>
<tr>
<td><code>logging.error(msg, *args, **kwargs)</code></td>
<td>创建一条严重级别为ERROR的日志记录</td>
</tr>
<tr>
<td><code>logging.critical(msg, *args, **kwargs)</code></td>
<td>创建一条严重级别为CRITICAL的日志记录</td>
</tr>
<tr>
<td><code>logging.log(level, *args, **kwargs)</code></td>
<td>创建一条严重级别为level的日志记录</td>
</tr>
<tr>
<td><code>logging.basicConfig(**kwargs)</code></td>
<td>对root logger进行一次性配置</td>
</tr>
</tbody>
</table>
<p>其中logging.basicConfig(**kwargs)函数用于指定“要记录的日志级别”、“日志格式”、“日志输出位置”、“日志文件的打开模式”等信息，其他几个都是用于记录各个级别日志的函数。</p>
<h3 id="3、第一种使用方式：简单配置"><a href="#3、第一种使用方式：简单配置" class="headerlink" title="3、第一种使用方式：简单配置"></a>3、第一种使用方式：简单配置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.debug(<span class="string">"debug_msg"</span>)</span><br><span class="line">logging.info(<span class="string">"info_msg"</span>)</span><br><span class="line">logging.warning(<span class="string">"warning_msg"</span>)</span><br><span class="line">logging.error(<span class="string">"error_msg"</span>)</span><br><span class="line">logging.critical(<span class="string">"critical_msg"</span>)</span><br><span class="line"></span><br><span class="line">输出结果</span><br><span class="line">WARNING:root:warning_msg</span><br><span class="line">ERROR:root:error_msg</span><br><span class="line">CRITICAL:root:critical_msg</span><br></pre></td></tr></table></figure>
<p>默认情况下Python的logging模块将日志打印到了标准输出中，且只显示了大于等于WARNING级别的日志，这说明默认的日志级别设置为WARNING（日志级别等级CRITICAL &gt; ERROR &gt; WARNING &gt; INFO &gt; DEBUG）</p>
<p>默认输出格式为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">默认的日志格式为日志级别：Logger名称：用户输出消息</span><br></pre></td></tr></table></figure>
<p>这里可以用 logging.basicConfig()函数调整日志级别、输出格式等<br>简单的例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.DEBUG,</span><br><span class="line">                    format=<span class="string">"%(asctime)s %(name)s %(levelname)s %(message)s"</span>,</span><br><span class="line">                    datefmt = <span class="string">'%Y-%m-%d  %H:%M:%S %a'</span>    <span class="comment">#注意月份和天数不要搞乱了，这里的格式化符与time模块相同</span></span><br><span class="line">                    )</span><br><span class="line">logging.debug(<span class="string">"msg1"</span>)</span><br><span class="line">logging.info(<span class="string">"msg2"</span>)</span><br><span class="line">logging.warning(<span class="string">"msg3"</span>)</span><br><span class="line">logging.error(<span class="string">"msg4"</span>)</span><br><span class="line">logging.critical(<span class="string">"msg5"</span>)</span><br><span class="line">　　</span><br><span class="line"></span><br><span class="line">输出结果</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-09</span>  <span class="number">23</span>:<span class="number">37</span>:<span class="number">49</span> Wed root DEBUG msg1</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-09</span>  <span class="number">23</span>:<span class="number">37</span>:<span class="number">49</span> Wed root INFO msg2</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-09</span>  <span class="number">23</span>:<span class="number">37</span>:<span class="number">49</span> Wed root WARNING msg3</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-09</span>  <span class="number">23</span>:<span class="number">37</span>:<span class="number">49</span> Wed root ERROR msg4</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-09</span>  <span class="number">23</span>:<span class="number">37</span>:<span class="number">49</span> Wed root CRITICAL msg5</span><br></pre></td></tr></table></figure>
<p>logging.basicConfig()函数包含参数说明</p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>filename</td>
<td>指定日志输出目标文件的文件名（可以写文件名也可以写文件的完整的绝对路径，写文件名日志放执行文件目录下，写完整路径按照完整路径生成日志文件），指定该设置项后日志信心就不会被输出到控制台了</td>
</tr>
<tr>
<td>filemode</td>
<td>指定日志文件的打开模式，默认为’a’。需要注意的是，该选项要在filename指定时才有效</td>
</tr>
<tr>
<td>format</td>
<td>指定日志格式字符串，即指定日志输出时所包含的字段信息以及它们的顺序。logging模块定义的格式字段下面会列出。</td>
</tr>
<tr>
<td>datefmt</td>
<td>指定日期/时间格式。需要注意的是，该选项要在format中包含时间字段%(asctime)s时才有效</td>
</tr>
<tr>
<td>level</td>
<td>指定日志器的日志级别</td>
</tr>
<tr>
<td>stream</td>
<td>指定日志输出目标stream，如sys.stdout、sys.stderr以及网络stream。需要说明的是，stream和filename不能同时提供，否则会引发 ValueError异常</td>
</tr>
<tr>
<td>style</td>
<td>Python 3.2中新添加的配置项。指定format格式字符串的风格，可取值为’%’、’{‘和’$’，默认为’%’</td>
</tr>
<tr>
<td>handlers</td>
<td>Python 3.3中新添加的配置项。该选项如果被指定，它应该是一个创建了多个Handler的可迭代对象，这些handler将会被添加到root logger。需要说明的是：filename、stream和handlers这三个配置项只能有一个存在，不能同时出现2个或3个，否则会引发ValueError异常。</td>
</tr>
</tbody>
</table>
<p>logging模块中定义好的可以用于format格式字符串说明</p>
<table>
<thead>
<tr>
<th>字段/属性名称</th>
<th>使用格式</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>asctime</td>
<td>%(asctime)s</td>
<td>将日志的时间构造成可读的形式，默认情况下是‘2016-02-08 12:00:00,123’精确到毫秒</td>
</tr>
<tr>
<td>name</td>
<td>%(name)s</td>
<td>所使用的日志器名称，默认是’root’，因为默认使用的是 rootLogger</td>
</tr>
<tr>
<td>filename</td>
<td>%(filename)s</td>
<td>调用日志输出函数的模块的文件名； pathname的文件名部分，包含文件后缀</td>
</tr>
<tr>
<td>funcName</td>
<td>%(funcName)s</td>
<td>由哪个function发出的log， 调用日志输出函数的函数名</td>
</tr>
<tr>
<td>levelname</td>
<td>%(levelname)s</td>
<td>日志的最终等级（被filter修改后的）</td>
</tr>
<tr>
<td>message</td>
<td>%(message)s</td>
<td>日志信息， 日志记录的文本内容</td>
</tr>
<tr>
<td>lineno</td>
<td>%(lineno)d</td>
<td>当前日志的行号， 调用日志输出函数的语句所在的代码行</td>
</tr>
<tr>
<td>levelno</td>
<td>%(levelno)s</td>
<td>该日志记录的数字形式的日志级别（10, 20, 30, 40, 50）</td>
</tr>
<tr>
<td>pathname</td>
<td>%(pathname)s</td>
<td>完整路径 ，调用日志输出函数的模块的完整路径名，可能没有</td>
</tr>
<tr>
<td>process</td>
<td>%(process)s</td>
<td>当前进程， 进程ID。可能没有</td>
</tr>
<tr>
<td>processName</td>
<td>%(processName)s</td>
<td>进程名称，Python 3.1新增</td>
</tr>
<tr>
<td>thread</td>
<td>%(thread)s</td>
<td>当前线程， 线程ID。可能没有</td>
</tr>
<tr>
<td>threadName</td>
<td>%(thread)s</td>
<td>线程名称</td>
</tr>
<tr>
<td>module</td>
<td>%(module)s</td>
<td>调用日志输出函数的模块名， filename的名称部分，不包含后缀即不包含文件后缀的文件名</td>
</tr>
<tr>
<td>created</td>
<td>%(created)f</td>
<td>当前时间，用UNIX标准的表示时间的浮点数表示； 日志事件发生的时间–时间戳，就是当时调用time.time()函数返回的值</td>
</tr>
<tr>
<td>relativeCreated</td>
<td>%(relativeCreated)d</td>
<td>输出日志信息时的，自Logger创建以 来的毫秒数； 日志事件发生的时间相对于logging模块加载时间的相对毫秒数</td>
</tr>
<tr>
<td>msecs</td>
<td>%(msecs)d</td>
<td>日志事件发生事件的毫秒部分。logging.basicConfig()中用了参数datefmt，将会去掉asctime中产生的毫秒部分，可以用这个加上</td>
</tr>
</tbody>
</table>
<p>升级版日志例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">LOG_FORMAT = <span class="string">"%(asctime)s %(name)s %(levelname)s %(pathname)s %(message)s "</span><span class="comment">#配置输出日志格式</span></span><br><span class="line">DATE_FORMAT = <span class="string">'%Y-%m-%d  %H:%M:%S %a '</span> <span class="comment">#配置输出时间的格式，注意月份和天数不要搞乱了</span></span><br><span class="line">logging.basicConfig(level=logging.DEBUG,</span><br><span class="line">                    format=LOG_FORMAT,</span><br><span class="line">                    datefmt = DATE_FORMAT ,</span><br><span class="line">                    filename=<span class="string">r"d:\test\test.log"</span> <span class="comment">#有了filename参数就不会直接输出显示到控制台，而是直接写入文件</span></span><br><span class="line">                    )</span><br><span class="line">logging.debug(<span class="string">"msg1"</span>)</span><br><span class="line">logging.info(<span class="string">"msg2"</span>)</span><br><span class="line">logging.warning(<span class="string">"msg3"</span>)</span><br><span class="line">logging.error(<span class="string">"msg4"</span>)</span><br><span class="line">logging.critical(<span class="string">"msg5"</span>)</span><br><span class="line">　　</span><br><span class="line"></span><br><span class="line">输出结果</span><br><span class="line">日志在d:\test目录下，日志具体内容</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-10</span>  <span class="number">02</span>:<span class="number">13</span>:<span class="number">46</span> Thu AM  root DEBUG D:/<span class="number">06</span>python/exercise/test_package/test.py msg1</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-10</span>  <span class="number">02</span>:<span class="number">13</span>:<span class="number">46</span> Thu AM  root INFO D:/<span class="number">06</span>python/exercise/test_package/test.py msg2</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-10</span>  <span class="number">02</span>:<span class="number">13</span>:<span class="number">46</span> Thu AM  root WARNING D:/<span class="number">06</span>python/exercise/test_package/test.py msg3</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-10</span>  <span class="number">02</span>:<span class="number">13</span>:<span class="number">46</span> Thu AM  root ERROR D:/<span class="number">06</span>python/exercise/test_package/test.py msg4</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-10</span>  <span class="number">02</span>:<span class="number">13</span>:<span class="number">46</span> Thu AM  root CRITICAL D:/<span class="number">06</span>python/exercise/test_package/test.py msg5</span><br></pre></td></tr></table></figure>
<p>说明</p>
<ul>
<li>logging.basicConfig()函数是一个一次性的简单配置工具，也就是说只有在第一次调用该函数时会起作用，后续再次调用该函数时完全不会产生任何操作的，多次调用的设置并不是累加操作。</li>
<li>日志器（Logger）是有层级关系的，上面调用的logging模块级别的函数所使用的日志器是RootLogger类的实例，其名称为’root’，它是处于日志器层级关系最顶层的日志器，且该实例是以单例模式存在的。</li>
<li>如果要记录的日志中包含变量数据，可使用一个格式字符串作为这个事件的描述消息（logging.debug、logging.info等函数的第一个参数），然后将变量数据作为第二个参数<code>*args</code>的值进行传递</li>
</ul>
<p>如:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logging.warning(<span class="string">'%s is %d years old.'</span>, <span class="string">'Tom'</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">输出内容为</span><br><span class="line">WARNING:root:Tom <span class="keyword">is</span> <span class="number">10</span> years old.</span><br></pre></td></tr></table></figure>
<ul>
<li><code>logging.debug()</code>，<code>logging.info()</code>等方法的定义中，除了<code>msg</code>和<code>args</code>参数外，还有一个<code>**kwargs</code>参数。它们支持3个关键字参数: <code>exc_info</code>，<code>stack_info</code>，<code>extra</code>，下面对这几个关键字参数作个说明。关于<code>exc_info</code>，<code>stack_info</code>，<code>extra</code>关键词参数的说明：见参考资料1。（了解）</li>
</ul>
<h3 id="4、第二种使用方式：日志流处理流程"><a href="#4、第二种使用方式：日志流处理流程" class="headerlink" title="4、第二种使用方式：日志流处理流程"></a>4、第二种使用方式：日志流处理流程</h3><p>上面简单配置的方法例子中我们了解到了<code>logging.debug()</code>、<code>logging.info()</code>、<code>logging.warning()</code>、<code>logging.error()</code>、<code>logging.critical()</code>（分别用以记录不同级别的日志信息），<code>logging.basicConfig()</code>（用默认日志格式（Formatter）为日志系统建立一个默认的流处理器（StreamHandler），设置基础配置（如日志级别等）并加到root logger（根Logger）中）这几个logging模块级别的函数。</p>
<p>第二种是一个模块级别的函数<code>logging.getLogger([name])</code>（返回一个logger对象，如果没有指定名字将返回root logger）。</p>
<p>logging日志模块四大组件<br>在介绍logging模块的日志流处理流程之前，我们先来介绍下logging模块的四大组件：</p>
<table>
<thead>
<tr>
<th>组件名称</th>
<th>对应类名</th>
<th>功能描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>日志器</td>
<td>Logger</td>
<td>提供了应用程序可一直使用的接口</td>
</tr>
<tr>
<td>处理器</td>
<td>Handler</td>
<td>将logger创建的日志记录发送到合适的目标输出</td>
</tr>
<tr>
<td>过滤器</td>
<td>Filter</td>
<td>提供了更细粒度的控制工具来决定输出哪条日志记录，丢弃哪条日志记录</td>
</tr>
<tr>
<td>格式器</td>
<td>Formatter</td>
<td>决定日志记录的最终输出格式</td>
</tr>
</tbody>
</table>
<p>logging模块就是通过这些组件来完成日志处理的，上面所使用的logging模块级别的函数也是通过这些组件对应的类来实现的。</p>
<p>这些组件之间的关系描述：</p>
<ul>
<li>日志器（logger）需要通过处理器（handler）将日志信息输出到目标位置，如：文件、sys.stdout、网络等；</li>
<li>不同的处理器（handler）可以将日志输出到不同的位置；</li>
<li>日志器（logger）可以设置多个处理器（handler）将同一条日志记录输出到不同的位置；</li>
<li>每个处理器（handler）都可以设置自己的过滤器（filter）实现日志过滤，从而只保留感兴趣的日志；</li>
<li>每个处理器（handler）都可以设置自己的格式器（formatter）实现同一条日志以不同的格式输出到不同的地方。</li>
</ul>
<p>简单点说就是：日志器（logger）是入口，真正干活儿的是处理器（handler），处理器（handler）还可以通过过滤器（filter）和格式器（formatter）对要输出的日志内容做过滤和格式化等处理操作。</p>
<p>logging日志模块相关类及其常用方法介绍<br>与logging四大组件相关的类：Logger, Handler, Filter, Formatter。</p>
<h4 id="Logger类"><a href="#Logger类" class="headerlink" title="Logger类"></a>Logger类</h4><p>Logger对象有3个任务要做：</p>
<ul>
<li>1）向应用程序代码暴露几个方法，使应用程序可以在运行时记录日志消息；</li>
<li>2）基于日志严重等级（默认的过滤设施）或filter对象来决定要对哪些日志进行后续处理；</li>
<li>3）将日志消息传送给所有感兴趣的日志handlers。</li>
</ul>
<p>Logger对象最常用的方法分为两类：配置方法和消息发送方法</p>
<p>最常用的配置方法如下：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Logger.setLevel()</td>
<td>设置日志器将会处理的日志消息的最低严重级别</td>
</tr>
<tr>
<td>Logger.addHandler() 和 Logger.removeHandler()</td>
<td>为该logger对象添加 和 移除一个handler对象</td>
</tr>
<tr>
<td>Logger.addFilter() 和 Logger.removeFilter()</td>
<td>为该logger对象添加和移除一个filter对象</td>
</tr>
</tbody>
</table>
<p>logger对象配置完成后，可以使用下面的方法来创建日志记录：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Logger.debug(), Logger.info(), Logger.warning(), Logger.error(), Logger.critical()</td>
<td>创建一个与它们的方法名对应等级的日志记录</td>
</tr>
<tr>
<td>Logger.exception()</td>
<td>创建一个类似于Logger.error()的日志消息</td>
</tr>
<tr>
<td>Logger.log()</td>
<td>需要获取一个明确的日志level参数来创建一个日志记录</td>
</tr>
</tbody>
</table>
<p>一个Logger对象呢？一种方式是通过Logger类的实例化方法创建一个Logger类的实例，但是我们通常都是用第二种方式–<code>logging.getLogger()</code>方法。</p>
<p><code>logging.getLogger()</code>方法有一个可选参数<code>name</code>，该参数表示将要返回的日志器的名称标识，如果不提供该参数，则其值为’root’。若以相同的<code>name</code>参数值多次调用<code>getLogger()</code>方法，将会返回指向同一个logger对象的引用。</p>
<p>多次使用注意不能创建多个logger，否则会出现重复输出日志现象。</p>
<p>关于logger的层级结构与有效等级的说明：</p>
<ul>
<li>logger的名称是一个以’.’分割的层级结构，每个’.’后面的logger都是’.’前面的logger的children，例如，有一个名称为 foo 的logger，其它名称分别为 foo.bar, foo.bar.baz 和 foo.bam都是 foo 的后代。</li>
<li>logger有一个”有效等级（effective level）”的概念。如果一个logger上没有被明确设置一个level，那么该logger就是使用它parent的level；如果它的parent也没有明确设置level则继续向上查找parent的parent的有效level，依次类推，直到找到个一个明确设置了level的祖先为止。需要说明的是，root logger总是会有一个明确的level设置（默认为 WARNING）。当决定是否去处理一个已发生的事件时，logger的有效等级将会被用来决定是否将该事件传递给该logger的handlers进行处理。</li>
<li>child loggers在完成对日志消息的处理后，默认会将日志消息传递给与它们的祖先loggers相关的handlers。因此，我们不必为一个应用程序中所使用的所有loggers定义和配置handlers，只需要为一个顶层的logger配置handlers，然后按照需要创建child loggers就可足够了。我们也可以通过将一个logger的propagate属性设置为False来关闭这种传递机制。</li>
</ul>
<h4 id="Handler类"><a href="#Handler类" class="headerlink" title="Handler类"></a>Handler类</h4><p>Handler对象的作用是（基于日志消息的level）将消息分发到handler指定的位置（文件、网络、邮件等）。Logger对象可以通过<code>addHandler()</code>方法为自己添加0个或者更多个handler对象。比如，一个应用程序可能想要实现以下几个日志需求：</p>
<ul>
<li>1）把所有日志都发送到一个日志文件中；</li>
<li>2）把所有严重级别大于等于error的日志发送到stdout（标准输出）；</li>
<li>3）把所有严重级别为critical的日志发送到一个email邮件地址。这种场景就需要3个不同的handlers，每个handler负责发送一个特定严重级别的日志到一个特定的位置。</li>
</ul>
<p><code>Handler.setLevel(lel)</code>：指定被处理的信息级别，低于lel级别的信息将被忽略<br><code>Handler.setFormatter()</code>：给这个handler选择一个格式<br><code>Handler.addFilter(filt)</code>、<code>Handler.removeFilter(filt)</code>：新增或删除一个filter对象</p>
<p>需要说明的是，应用程序代码不应该直接实例化和使用Handler实例。因为Handler是一个基类，它只定义了素有handlers都应该有的接口，同时提供了一些子类可以直接使用或覆盖的默认行为。下面是一些常用的Handler：</p>
<table>
<thead>
<tr>
<th>Handler</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>logging.StreamHandler</td>
<td>将日志消息发送到输出到Stream，如std.out, std.err或任何file-like对象。</td>
</tr>
<tr>
<td>logging.FileHandler</td>
<td>将日志消息发送到磁盘文件，默认情况下文件大小会无限增长</td>
</tr>
<tr>
<td>logging.handlers.RotatingFileHandler</td>
<td>将日志消息发送到磁盘文件，并支持日志文件按大小切割</td>
</tr>
<tr>
<td>logging.hanlders.TimedRotatingFileHandler</td>
<td>将日志消息发送到磁盘文件，并支持日志文件按时间切割</td>
</tr>
<tr>
<td>logging.handlers.HTTPHandler</td>
<td>将日志消息以GET或POST的方式发送给一个HTTP服务器</td>
</tr>
<tr>
<td>logging.handlers.SMTPHandler</td>
<td>将日志消息发送给一个指定的email地址</td>
</tr>
<tr>
<td>logging.NullHandler</td>
<td>该Handler实例会忽略error messages，通常被想使用logging的library开发者使用来避免’No handlers could be found for logger XXX’信息的出现。</td>
</tr>
</tbody>
</table>
<h4 id="Formater类"><a href="#Formater类" class="headerlink" title="Formater类"></a>Formater类</h4><p>Formater对象用于配置日志信息的最终顺序、结构和内容。与<code>logging.Handler</code>基类不同的是，应用代码可以直接实例化Formatter类。另外，如果你的应用程序需要一些特殊的处理行为，也可以实现一个Formatter的子类来完成。</p>
<p>Formatter类的构造方法定义如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.Formatter.__init__(fmt=<span class="keyword">None</span>, datefmt=<span class="keyword">None</span>, style=<span class="string">'%'</span>)</span><br></pre></td></tr></table></figure>
<p>可见，该构造方法接收3个可选参数：</p>
<ul>
<li>fmt：指定消息格式化字符串，如果不指定该参数则默认使用message的原始值</li>
<li>datefmt：指定日期格式字符串，如果不指定该参数则默认使用”%Y-%m-%d %H:%M:%S”</li>
<li>style：Python 3.2新增的参数，可取值为 ‘%’, ‘{‘和 ‘$’，如果不指定该参数则默认使用’%’</li>
</ul>
<p>一般直接用<code>logging.Formatter（fmt, datefmt）</code></p>
<h4 id="Filter类（暂时了解）"><a href="#Filter类（暂时了解）" class="headerlink" title="Filter类（暂时了解）"></a>Filter类（暂时了解）</h4><p>Filter可以被Handler和Logger用来做比level更细粒度的、更复杂的过滤功能。Filter是一个过滤器基类，它只允许某个logger层级下的日志事件通过过滤。该类定义如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">logging</span>.<span class="title">Filter</span><span class="params">(name=<span class="string">''</span>)</span></span></span><br><span class="line"><span class="class">    <span class="title">filter</span><span class="params">(record)</span></span></span><br></pre></td></tr></table></figure>
<p>比如，一个filter实例化时传递的name参数值为’A.B’，那么该filter实例将只允许名称为类似如下规则的loggers产生的日志记录通过过滤：’A.B’，’A.B,C’，’A.B.C.D’，’A.B.D’，而名称为’A.BB’, ‘B.A.B’的loggers产生的日志则会被过滤掉。如果name的值为空字符串，则允许所有的日志事件通过过滤。</p>
<p>filter方法用于具体控制传递的record记录是否能通过过滤，如果该方法返回值为0表示不能通过过滤，返回值为非0表示可以通过过滤。</p>
<blockquote>
<p>  说明：</p>
<ul>
<li>如果有需要，也可以在filter(record)方法内部改变该record，比如添加、删除或修改一些属性。</li>
<li>我们还可以通过filter做一些统计工作，比如可以计算下被一个特殊的logger或handler所处理的record数量等。</li>
</ul>
</blockquote>
<p>日志流处理简要流程<br>1、创建一个logger</p>
<p>2、设置logger的日志的等级</p>
<p>3、创建合适的Handler(FileHandler要有路径)</p>
<p>4、设置每个Handler的日志等级</p>
<p>5、创建日志的格式</p>
<p>6、向Handler中添加上面创建的格式</p>
<p>7、将上面创建的Handler添加到logger中</p>
<p>8、打印输出logger.debug\logger.info\logger.warning\logger.error\logger.critical</p>
<p>例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建logger，如果参数为空则返回root logger</span></span><br><span class="line">logger = logging.getLogger(<span class="string">"nick"</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)  <span class="comment">#设置logger日志等级</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建handler</span></span><br><span class="line">fh = logging.FileHandler(<span class="string">"test.log"</span>,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">ch = logging.StreamHandler()</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置输出日志格式</span></span><br><span class="line">formatter = logging.Formatter(</span><br><span class="line">    fmt=<span class="string">"%(asctime)s %(name)s %(filename)s %(message)s"</span>,</span><br><span class="line">    datefmt=<span class="string">"%Y/%m/%d %X"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意 logging.Formatter的大小写</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#为handler指定输出格式，注意大小写</span></span><br><span class="line">fh.setFormatter(formatter)</span><br><span class="line">ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line"><span class="comment">#为logger添加的日志处理器</span></span><br><span class="line">logger.addHandler(fh)</span><br><span class="line">logger.addHandler(ch)</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出不同级别的log</span></span><br><span class="line">logger.warning(<span class="string">"泰拳警告"</span>)</span><br><span class="line">logger.info(<span class="string">"提示"</span>)</span><br><span class="line">logger.error(<span class="string">"错误"</span>)</span><br></pre></td></tr></table></figure>
<p>python logging 重复写日志问题<br>用Python的logging模块记录日志时，可能会遇到重复记录日志的问题，第一条记录写一次，第二条记录写两次，第三条记录写三次</p>
<p>原因：没有移除handler 解决：在日志记录完之后removeHandler</p>
<p>例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="comment">#创建logger，如果参数为空则返回root logger</span></span><br><span class="line">    logger = logging.getLogger(<span class="string">"nick"</span>)</span><br><span class="line">    logger.setLevel(logging.DEBUG)  <span class="comment">#设置logger日志等级</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#创建handler</span></span><br><span class="line">    fh = logging.FileHandler(<span class="string">"test.log"</span>,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    ch = logging.StreamHandler()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#设置输出日志格式</span></span><br><span class="line">    formatter = logging.Formatter(</span><br><span class="line">        fmt=<span class="string">"%(asctime)s %(name)s %(filename)s %(message)s"</span>,</span><br><span class="line">        datefmt=<span class="string">"%Y/%m/%d %X"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment">#为handler指定输出格式</span></span><br><span class="line">    fh.setFormatter(formatter)</span><br><span class="line">    ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#为logger添加的日志处理器</span></span><br><span class="line">    logger.addHandler(fh)</span><br><span class="line">    logger.addHandler(ch)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出不同级别的log</span></span><br><span class="line">    logger.info(msg)</span><br><span class="line">    </span><br><span class="line">log(<span class="string">"泰拳警告"</span>)</span><br><span class="line">log(<span class="string">"提示"</span>)</span><br><span class="line">log(<span class="string">"错误"</span>)</span><br><span class="line"></span><br><span class="line">输出结果</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 泰拳警告</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 提示</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 提示</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 错误</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 错误</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 错误</span><br></pre></td></tr></table></figure>
<p>分析：可以看到输出结果有重复打印</p>
<p>原因：第二次调用log的时候，根据getLogger(name)里的name获取同一个logger，而这个logger里已经有了第一次你添加的handler，第二次调用又添加了一个handler，所以，这个logger里有了两个同样的handler，以此类推，调用几次就会有几个handler。</p>
<p>解决方案1</p>
<p>添加removeHandler语句</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="comment">#创建logger，如果参数为空则返回root logger</span></span><br><span class="line">    logger = logging.getLogger(<span class="string">"nick"</span>)</span><br><span class="line">    logger.setLevel(logging.DEBUG)  <span class="comment">#设置logger日志等级</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#创建handler</span></span><br><span class="line">    fh = logging.FileHandler(<span class="string">"test.log"</span>,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    ch = logging.StreamHandler()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#设置输出日志格式</span></span><br><span class="line">    formatter = logging.Formatter(</span><br><span class="line">        fmt=<span class="string">"%(asctime)s %(name)s %(filename)s %(message)s"</span>,</span><br><span class="line">        datefmt=<span class="string">"%Y/%m/%d %X"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment">#为handler指定输出格式</span></span><br><span class="line">    fh.setFormatter(formatter)</span><br><span class="line">    ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#为logger添加的日志处理器</span></span><br><span class="line">    logger.addHandler(fh)</span><br><span class="line">    logger.addHandler(ch)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出不同级别的log</span></span><br><span class="line">    logger.info(msg)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#解决方案1，添加removeHandler语句，每次用完之后移除Handler</span></span><br><span class="line">    logger.removeHandler(fh)</span><br><span class="line">    logger.removeHandler(ch)</span><br><span class="line">    </span><br><span class="line">log(<span class="string">"泰拳警告"</span>)</span><br><span class="line">log(<span class="string">"提示"</span>)</span><br><span class="line">log(<span class="string">"错误"</span>)</span><br></pre></td></tr></table></figure>
<p>解决方案2<br>在log方法里做判断，如果这个logger已有handler，则不再添加handler。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="comment">#创建logger，如果参数为空则返回root logger</span></span><br><span class="line">    logger = logging.getLogger(<span class="string">"nick"</span>)</span><br><span class="line">    logger.setLevel(logging.DEBUG)  <span class="comment">#设置logger日志等级</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#解决方案2：这里进行判断，如果logger.handlers列表为空，则添加，否则，直接去写日志</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> logger.handlers:</span><br><span class="line">        <span class="comment">#创建handler</span></span><br><span class="line">        fh = logging.FileHandler(<span class="string">"test.log"</span>,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">        ch = logging.StreamHandler()</span><br><span class="line"></span><br><span class="line">        <span class="comment">#设置输出日志格式</span></span><br><span class="line">        formatter = logging.Formatter(</span><br><span class="line">            fmt=<span class="string">"%(asctime)s %(name)s %(filename)s %(message)s"</span>,</span><br><span class="line">            datefmt=<span class="string">"%Y/%m/%d %X"</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="comment">#为handler指定输出格式</span></span><br><span class="line">        fh.setFormatter(formatter)</span><br><span class="line">        ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#为logger添加的日志处理器</span></span><br><span class="line">        logger.addHandler(fh)</span><br><span class="line">        logger.addHandler(ch)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出不同级别的log</span></span><br><span class="line">    logger.info(msg)</span><br><span class="line">    </span><br><span class="line">log(<span class="string">"泰拳警告"</span>)</span><br><span class="line">log(<span class="string">"提示"</span>)</span><br><span class="line">log(<span class="string">"错误"</span>)</span><br></pre></td></tr></table></figure>
<p>logger调用方式例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#创建logger，如果参数为空则返回root logger</span></span><br><span class="line">    logger = logging.getLogger(<span class="string">"nick"</span>)</span><br><span class="line">    logger.setLevel(logging.DEBUG)  <span class="comment">#设置logger日志等级</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#这里进行判断，如果logger.handlers列表为空，则添加，否则，直接去写日志</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> logger.handlers:</span><br><span class="line">        <span class="comment">#创建handler</span></span><br><span class="line">        fh = logging.FileHandler(<span class="string">"test.log"</span>,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">        ch = logging.StreamHandler()</span><br><span class="line"></span><br><span class="line">        <span class="comment">#设置输出日志格式</span></span><br><span class="line">        formatter = logging.Formatter(</span><br><span class="line">            fmt=<span class="string">"%(asctime)s %(name)s %(filename)s %(message)s"</span>,</span><br><span class="line">            datefmt=<span class="string">"%Y/%m/%d %X"</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="comment">#为handler指定输出格式</span></span><br><span class="line">        fh.setFormatter(formatter)</span><br><span class="line">        ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#为logger添加的日志处理器</span></span><br><span class="line">        logger.addHandler(fh)</span><br><span class="line">        logger.addHandler(ch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> logger <span class="comment">#直接返回logger</span></span><br><span class="line">    </span><br><span class="line">logger = log()</span><br><span class="line">logger.warning(<span class="string">"泰拳警告"</span>)</span><br><span class="line">logger.info(<span class="string">"提示"</span>)</span><br><span class="line">logger.error(<span class="string">"错误"</span>)</span><br><span class="line">logger.debug(<span class="string">"查错"</span>)</span><br></pre></td></tr></table></figure>
<p>参考链接</p>
<p>[1]<a href="https://www.cnblogs.com/yyds/p/6901864.html" target="_blank" rel="noopener">https://www.cnblogs.com/yyds/p/6901864.html</a></p>
<p>[2]<a href="https://blog.csdn.net/huilan_same/article/details/51858817" target="_blank" rel="noopener">https://blog.csdn.net/huilan_same/article/details/51858817</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/09/python使用记录-发送邮件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/09/python使用记录-发送邮件/" itemprop="url">
                  python使用记录-发送邮件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-09-09 14:11:49 / 修改時間：17:27:29" itemprop="dateCreated datePublished" datetime="2020-09-09T14:11:49+08:00">2020-09-09</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发送附件，函数</span></span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="comment"># 不这样使用，在下面使用urllib.parse时就看不到提示。why？</span></span><br><span class="line"><span class="keyword">import</span> pathlib</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面使用的本地路径定义是在windows中的方法</span></span><br><span class="line"><span class="comment"># 获取昨天的日期，这是文件名的一部分</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getYesterday</span><span class="params">()</span>:</span></span><br><span class="line">    today = datetime.date.today()</span><br><span class="line">    yesterday = (today - datetime.timedelta(days=<span class="number">1</span>)).strftime(<span class="string">'%Y-%m-%d'</span>)</span><br><span class="line">    <span class="comment"># print(yesterday)</span></span><br><span class="line">    <span class="keyword">return</span> yesterday</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">downloadFile</span><span class="params">()</span>:</span></span><br><span class="line">    url1 = <span class="string">'http://172.16.174.55:8088/hourdata/gehuavhmlp/send_report/'</span>+getYesterday()+<span class="string">'歌华三款盒子开机人次统计.csv'</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 下面是下载中文文件的方法一</span></span><br><span class="line">    <span class="comment">#urlbefore = url1.split("//")[0]</span></span><br><span class="line">    <span class="comment">#urlafter = url1.split("//")[1]</span></span><br><span class="line">    <span class="comment">#url = urlbefore + "//" + parse.quote(urlafter)</span></span><br><span class="line"><span class="comment"># 上面四行可以解决下载文件为中文名称的问题。第一行定义路径，第二行到第三行将路径以//分隔为两段，因为使用</span></span><br><span class="line"><span class="comment"># quote将路径转码时，会将冒号也转码，所以这样做。最后再将两段合并成一段url</span></span><br><span class="line">    <span class="comment"># s = request.urlopen(url).read()</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 下面是下载中文文件的方法二</span></span><br><span class="line">    url = parse.quote(url1, safe=<span class="string">":/=?#"</span>)</span><br><span class="line">    <span class="comment"># 链接转义，防止链接中有中文或空格而报错</span></span><br><span class="line">    LocalPath = pathlib.Path(<span class="string">'D:\\no_delete_task_data\\BigSampleData\\'</span>+getYesterday()+<span class="string">'歌华三款盒子开机人次统计.csv'</span>)</span><br><span class="line">    request.urlretrieve(url,filename=LocalPath,reporthook=loading)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loading</span><span class="params">(blocknum,blocksize,totalsize)</span>:</span></span><br><span class="line">    percent = <span class="number">100</span>*blocknum*blocksize/totalsize</span><br><span class="line">    <span class="keyword">if</span> percent &gt; <span class="number">100</span>:</span><br><span class="line">        percent = <span class="number">100</span></span><br><span class="line">    print(<span class="string">"正在下载&gt;&gt;&gt;%0.2f%%"</span>%percent)</span><br><span class="line"></span><br><span class="line">========================================================================================</span><br><span class="line">函数参数说明</span><br><span class="line">urllib.request.urlretrieve(url, filename=<span class="keyword">None</span>, reporthook=<span class="keyword">None</span>, data=<span class="keyword">None</span>)</span><br><span class="line">url: 文件下载链接</span><br><span class="line">filename: 文件下载路径（如果参数未指定，urllib 会生成一个临时文件保存数据）</span><br><span class="line">reporthook: 回调函数，当连接上服务器、以及相应的数据块传输完毕时会触发该回调，我们可以利用这个回调函数来显示当前的下载进度</span><br><span class="line">data: 指 post 到服务器的数据。该方法返回一个包含两个元素的元组 (filename, headers)，filename 表示保存到本地的路径，header 表示服务器的响应头</span><br><span class="line">========================================================================================</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_mail</span><span class="params">(sender = <span class="string">'ziwei.zhang@xor-media.tv'</span>,receivers = [<span class="string">'1411002380@qq.com'</span>],sender_password = <span class="string">'ICE0JCIJBdP5qvtD'</span>,smtp_sender = <span class="string">'mail.xor-media.tv'</span>, subject = <span class="string">'开机人次数据汇总：'</span>+getYesterday<span class="params">()</span>)</span>:</span></span><br><span class="line">    msg = MIMEMultipart()  <span class="comment">#  实例化email对象</span></span><br><span class="line">    msg[<span class="string">'From'</span>] = sender  <span class="comment">#</span></span><br><span class="line">    msg[<span class="string">'To'</span>] = <span class="string">','</span>.join(receivers)</span><br><span class="line">    <span class="comment"># msg['To'] = str(receivers)</span></span><br><span class="line">    <span class="comment"># subject = 'Python SMTP 邮件测试...'</span></span><br><span class="line"></span><br><span class="line">    msg[<span class="string">'Subject'</span>] = subject</span><br><span class="line"></span><br><span class="line"><span class="comment"># 邮件正文内容</span></span><br><span class="line">    msg.attach(MIMEText(<span class="string">'开机人次数据汇总'</span>,<span class="string">'plain'</span>,<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造附件1,传送当前目录下的test.txt文件</span></span><br><span class="line">    att1 = MIMEText(open(<span class="string">'D:\\no_delete_task_data\\BigSampleData\\'</span> + getYesterday() + <span class="string">'歌华三款盒子开机人次统计.csv'</span>,<span class="string">'rb'</span>).read(),<span class="string">'base64'</span>,<span class="string">'utf8'</span>)</span><br><span class="line">    att1[<span class="string">"Content-Type"</span>] = <span class="string">'application/octet-stream'</span></span><br><span class="line"><span class="comment"># 这里的filename可以任意写，写什么名字，邮件中显示什么名字</span></span><br><span class="line"><span class="comment">#     att1["Content-Disposition"] = 'attachment; filename="密云时段开机数据.zip"'  # 这种方法无法修改附件的名称</span></span><br><span class="line">    att1.add_header(<span class="string">'Content-Disposition'</span>,<span class="string">'attachment'</span>,filename=getYesterday()+<span class="string">'歌华三款盒子开机人次统计.csv'</span>)</span><br><span class="line">    msg.attach(att1)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server = smtplib.SMTP(smtp_sender,<span class="number">25</span>)</span><br><span class="line">        <span class="comment">###server.set_debuglevel(1)</span></span><br><span class="line">        server.ehlo()  <span class="comment"># 用户认证</span></span><br><span class="line">        server.starttls()</span><br><span class="line">        server.login(sender,sender_password)</span><br><span class="line">        server.sendmail(sender,msg[<span class="string">'To'</span>].split(<span class="string">','</span>),str(msg))</span><br><span class="line">        server.quit()</span><br><span class="line">        print(<span class="string">"邮件发送成功"</span>)</span><br><span class="line">    <span class="keyword">except</span> smtplib.SMTPException:</span><br><span class="line">        print(<span class="string">"Error: 无法发送邮件"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line">downloadFile()</span><br><span class="line">send_mail()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/01/利用ssh动态端口转发代理上网/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/01/利用ssh动态端口转发代理上网/" itemprop="url">
                  利用ssh动态端口转发代理上网
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-09-01 14:34:07 / 修改時間：14:57:32" itemprop="dateCreated datePublished" datetime="2020-09-01T14:34:07+08:00">2020-09-01</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>本机只有内网地址，无法连接互联网。通过ssh连接到一台服务器联网。这时本机与服务器间建立了隧道，通过隧道将数据流发送到服务器，服务器到发送到互联网。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">VMware登录一台windows虚拟机，使用Host-only网络。宿主机为ubuntu20.04系统。</span><br><span class="line">windows主机地址：192.168.176.128。ubuntu20.04上vmnet1地址：192.168.176.1</span><br><span class="line">1. windows主机</span><br><span class="line">ssh -D 8090 shouyu@192.168.176.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时可以连接上ubuntu主机。这是在本地打开8090端口，连接到192.168.176.1。本地端口也可以使用IP:port。如下</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh -D 127.0.0.1:8090 shouyu@192.168.176.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果不写地址，只写端口。本机就会监听所有地址。</span></span><br><span class="line">2. 在windows主机使用chrome浏览器的switchyomega插件添加一个代理，使用SOCK5方式，代理地址为127.0.0.1:8090。配置好之后就可以访问baidu.com等网页了</span><br><span class="line">3. curl --socks 5 127.0.0.1:8080 http://需要访问的网站</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种方法也可以测试</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/17/python基础学习-asyncio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/17/python基础学习-asyncio/" itemprop="url">
                  python基础学习-asyncio
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-06-17 11:53:36" itemprop="dateCreated datePublished" datetime="2020-06-17T11:53:36+08:00">2020-06-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-06-18 11:09:02" itemprop="dateModified" datetime="2020-06-18T11:09:02+08:00">2020-06-18</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="asyncio"><a href="#asyncio" class="headerlink" title="asyncio"></a>asyncio</h3><p>3.4版本加入标准库。<br>asyncio底层基于selectors实现，看似库，其实就是个框架，包含异步IO、事件循环、协程、任务等内容。</p>
<h3 id="问题的引出"><a href="#问题的引出" class="headerlink" title="问题的引出"></a>问题的引出</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">		print(x)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">"abc"</span>:</span><br><span class="line">		print(x)</span><br><span class="line">        </span><br><span class="line">a()</span><br><span class="line">b()</span><br><span class="line"><span class="comment"># 运行结果一定是</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br></pre></td></tr></table></figure>
<p>这是一个串行的程序，单线程中根本没有做任何<br>能否并行?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        time.sleep(<span class="number">0.001</span>) <span class="comment">#</span></span><br><span class="line">        print(x)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">"abc"</span>:</span><br><span class="line">        time.sleep(<span class="number">0.001</span>)</span><br><span class="line">        print(x)</span><br><span class="line">        </span><br><span class="line">threading.Thread(target=a, name=<span class="string">'a'</span>).start()</span><br><span class="line">threading.Thread(target=b, name=<span class="string">'b'</span>).start()</span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">a</span><br><span class="line"><span class="number">1</span></span><br><span class="line">b</span><br><span class="line"><span class="number">2</span></span><br><span class="line">c</span><br></pre></td></tr></table></figure>
<p>多进程版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">		time.sleep(<span class="number">0.001</span>)</span><br><span class="line">		print(x)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">"abc"</span>:</span><br><span class="line">        time.sleep(<span class="number">0.001</span>)</span><br><span class="line">        print(x)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    multiprocessing.Process(target=a, name=<span class="string">'a'</span>).start()</span><br><span class="line">    multiprocessing.Process(target=b, name=<span class="string">'b'</span>).start()</span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">a</span><br><span class="line"><span class="number">1</span></span><br><span class="line">b</span><br><span class="line"><span class="number">2</span></span><br><span class="line">c</span><br></pre></td></tr></table></figure>
<p>生成器版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        print(x)</span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">"abc"</span>:</span><br><span class="line">		print(x)</span><br><span class="line">		<span class="keyword">yield</span></span><br><span class="line">        </span><br><span class="line">x = a()</span><br><span class="line">y = b()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">	next(x)</span><br><span class="line">    next(y)</span><br></pre></td></tr></table></figure>
<p>上例在一个线程内通过生成器完成了调度，让两个函数都有机会执行，这样的调度不是操作系统的进程、线程完成的，而是用户自己设计的。<br>这个程序编写:<br>需要使用yield来让出控制权<br>需要循环帮助交替执行</p>
<h3 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h3><p>事件循环是asyncio提供的核心运行机制。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>asyncio.get_event_loop()</td>
<td>返回一个事件循环对象，是asyncio.BaseEventLoop的实例</td>
</tr>
<tr>
<td>AbstractEventLoop.stop()</td>
<td>停止运行事件循环</td>
</tr>
<tr>
<td>AbstractEventLoop.run_forever()</td>
<td>一直运行，直到stop()</td>
</tr>
<tr>
<td>AbstractEventLoop.run_until_complete(future)</td>
<td>运行直至Future对象运行完</td>
</tr>
<tr>
<td>AbstractEventLoop.close()</td>
<td>关闭事件循环</td>
</tr>
<tr>
<td>AbstractEventLoop.is_running()</td>
<td>返回事件循环是否运行</td>
</tr>
<tr>
<td>AbstractEventLoop.close()</td>
<td>关闭事件循环</td>
</tr>
</tbody>
</table>
<h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><ul>
<li>协程不是进程、也不是线程，它是用户空间调度的完成并发处理的方式。</li>
<li>进程、线程由操作系统完成调度，而协程是线程内完成调度。它不需要更多的线程，自然也没有多线程切换带来的开销。</li>
<li>协程是非抢占式调度，只有一个协程主动让出控制权，另一个协程才会被调度。</li>
<li>协程也不需要使用锁机制，因为是在同一个线程中执行。</li>
<li>多CPU下，可以使用多进程和协程配合，既能进程并发又能发挥协程在单线程中的优势。</li>
<li>Python中协程是基于生成器的。</li>
</ul>
<h4 id="协程的使用"><a href="#协程的使用" class="headerlink" title="协程的使用"></a>协程的使用</h4><p>3.4引入asyncio，使用装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">(x)</span>:</span> <span class="comment"># 协程函数</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        print(<span class="string">'sleep &#123;&#125;'</span>.format(i))</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(x)</span><br><span class="line">        </span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(sleep(<span class="number">3</span>))</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure>
<p>将生成器函数转换成协程函数，就可以在事件循环中执行了。<br>3.5版本开始，Python提供关键字async、await，在语言上原生支持协程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">(x)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        print(<span class="string">'sleep &#123;&#125;'</span>.format(i))</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(x)</span><br><span class="line">        </span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(sleep(<span class="number">3</span>))</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure>
<p>async def用来定义协程函数，iscoroutinefunction()返回True。协程函数中可以不包含await、async关键字，但不能使用yield关键字。<br>如同生成器函数调用返回生成器对象一样，协程函数调用也会返回一个对象称为协程对象，iscoroutine()返回True。<br>再来做个例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">(x)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        print(<span class="string">'sleep &#123;&#125;'</span>.format(i))</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(x)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">showthread</span><span class="params">(x)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        print(threading.enumerate())</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">tasks = [sleep(<span class="number">3</span>), showthread(<span class="number">3</span>)]</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">loop.close()</span><br><span class="line">============================================================================================</span><br><span class="line"><span class="comment"># 协程版本</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        print(<span class="string">'a.x'</span>, x)</span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">'abc'</span>:</span><br><span class="line">        print(<span class="string">'b.x'</span>, x)</span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line">        </span><br><span class="line">print(asyncio.iscoroutinefunction(a))</span><br><span class="line">print(asyncio.iscoroutinefunction(b))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 大循环</span></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">tasks = [a(), b()]</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure>
<h4 id="TCP-Echo-Server举例"><a href="#TCP-Echo-Server举例" class="headerlink" title="TCP Echo Server举例"></a>TCP Echo Server举例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="comment"># TCP Echo Server 举例</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(reader, writer)</span>:</span></span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">1024</span>)</span><br><span class="line">        print(dir(reader))</span><br><span class="line">        print(dir(writer))</span><br><span class="line">        client = writer.get_extra_info(<span class="string">'peername'</span>)</span><br><span class="line">        message = <span class="string">"&#123;&#125; Your msg &#123;&#125;"</span>.format(client, data.decode()).encode()</span><br><span class="line">        writer.write(message)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line">        </span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">9999</span></span><br><span class="line">crt = asyncio.start_server(handle, ip, port, loop=loop)</span><br><span class="line">server = loop.run_until_complete(crt)</span><br><span class="line">print(server) <span class="comment"># server是监听的socket对象</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	loop.run_forever()</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    server.close()</span><br><span class="line">    loop.close()</span><br></pre></td></tr></table></figure>
<h4 id="aiohttp库"><a href="#aiohttp库" class="headerlink" title="aiohttp库"></a>aiohttp库</h4><p>安装</p>
<p><code>pip install aiohttp</code></p>
<p>开发</p>
<p>HTTP Server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">indexhandle</span><span class="params">(request:web.Request)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> web.Response(text=request.path, status=<span class="number">201</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(request:web.Request)</span>:</span></span><br><span class="line">    print(request.match_info)</span><br><span class="line">    print(request.query_string) <span class="comment"># http://127.0.0.1:8080/1?name=12301</span></span><br><span class="line">    <span class="keyword">return</span> web.Response(text=request.match_info.get(<span class="string">'id'</span>, <span class="string">'0000'</span>), status=<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">app = web.Application()</span><br><span class="line">app.router.add_get(<span class="string">"/"</span>, indexhandle) <span class="comment"># http://127.0.0.1:8080/</span></span><br><span class="line">app.router.add_get(<span class="string">"/&#123;id&#125;"</span>, handle) <span class="comment"># http://127.0.0.1:8080/12301</span></span><br><span class="line"></span><br><span class="line">web.run_app(app, host=<span class="string">'0.0.0.0'</span>, port=<span class="number">9977</span>)</span><br></pre></td></tr></table></figure>
<p>HTTP Client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> ClientSession</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_html</span><span class="params">(url:str)</span>:</span></span><br><span class="line">	<span class="keyword">async</span> <span class="keyword">with</span> ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">		<span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> res:</span><br><span class="line">            print(res.status)</span><br><span class="line">            print(<span class="keyword">await</span> res.text())</span><br><span class="line">            </span><br><span class="line">url = <span class="string">'http://127.0.0.1/ziroom-web/'</span></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(get_html(url))</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/17/python基础学习-IO各种概念及多路复用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/17/python基础学习-IO各种概念及多路复用/" itemprop="url">
                  python基础学习-IO各种概念及多路复用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-06-17 11:53:24" itemprop="dateCreated datePublished" datetime="2020-06-17T11:53:24+08:00">2020-06-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-10-13 11:24:19" itemprop="dateModified" datetime="2020-10-13T11:24:19+08:00">2020-10-13</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h3><h4 id="重要概念"><a href="#重要概念" class="headerlink" title="重要概念"></a>重要概念</h4><h5 id="同步、异步"><a href="#同步、异步" class="headerlink" title="同步、异步"></a>同步、异步</h5><p>函数或方法被调用的时候，调用者是否得到最终结果的。</p>
<p>直接得到最终结果的，就是同步调用</p>
<p>不直接得到最终结果的，就是异步调用。</p>
<p>同步就是我让你打饭，你不打好给我我就不走开，直到你打饭给了我。</p>
<p>异步就是我让你打饭，你打着，我不等你，但是我会盯着你，你打完，我会过来拿走的。异步并不保证多长时间最终打完饭</p>
<p>同步异步只看拿到的是不是最终结果，异步拿到的是中间结果，同步拿到的是最终结果</p>
<h5 id="阻塞、非阻塞"><a href="#阻塞、非阻塞" class="headerlink" title="阻塞、非阻塞"></a>阻塞、非阻塞</h5><p>函数或方法调用的时候，是否立刻返回。</p>
<p>立即返回就是非阻塞调用；不立即返回就是阻塞调用</p>
<h5 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h5><p>同步、异步，与阻塞、非阻塞不相关。</p>
<p>同步、异步强调的是，是否得到（最终的）结果；</p>
<p>阻塞、非阻塞强调的是时间，是否等待。</p>
<p>同步与异步区别在于：调用者是否得到了想要的最终结果。</p>
<p>同步就是一直要执行到返回最终结果；</p>
<p>异步就是直接返回了，但是返回的不是最终结果。调用者不能通过这种调用得到结果，还要通过被调用者，使用其他方式通知调用者，来取回最终结果。</p>
<p>阻塞与非阻塞的区别在于，调用者是否还能干其他事。</p>
<p>阻塞，调用者就只能干等；</p>
<p>非阻塞，调用者可以先去忙会儿别的，不用一直等</p>
<h5 id="联系"><a href="#联系" class="headerlink" title="联系"></a>联系</h5><p>同步阻塞，我啥事不干，就等你打饭打给我。打到饭是结果，而且我啥事不干一直等，同步加阻塞。</p>
<p>同步非阻塞，我等着你打饭给我，但我可以玩会儿手机、看看电视。打饭是结果，但是我不一直等</p>
<p>异步阻塞，我要打饭，你说等叫号，并没有返回饭给我，我啥事不干，就干等着饭好了你叫我。例如，叫号</p>
<p>异步非阻塞，我要打饭，你说等叫号，并没有返回饭给我，我在旁边看电视、玩手机，饭打好了叫我。</p>
<h4 id="同步IO、异步IO、IO多路复用"><a href="#同步IO、异步IO、IO多路复用" class="headerlink" title="同步IO、异步IO、IO多路复用"></a>同步IO、异步IO、IO多路复用</h4><h5 id="IO两个阶段"><a href="#IO两个阶段" class="headerlink" title="IO两个阶段"></a>IO两个阶段</h5><p>IO过程分两阶段：</p>
<ol>
<li>数据准备阶段</li>
<li>内核空间复制回用户进程缓冲区阶段</li>
</ol>
<p>发生IO的时候：</p>
<ol>
<li>内核从输入设备读、写数据（淘米，把米放饭锅里煮饭）</li>
<li>进程从内核复制数据（盛饭，从内核这个饭锅里面把饭装到碗里来）</li>
</ol>
<p>系统调用–read函数</p>
<p>零拷贝：<a href="https://www.jianshu.com/p/fad3339e3448" target="_blank" rel="noopener">https://www.jianshu.com/p/fad3339e3448</a></p>
<p>回调函数：定义一个函数，然后将这个函数的函数名传递给另一个函数做参数，以这个函数命名的参数就是回调函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_callbcak</span><span class="params">(args)</span>:</span></span><br><span class="line">    print(*args)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">caller</span><span class="params">(args, func)</span>:</span></span><br><span class="line">    func(args)</span><br><span class="line"></span><br><span class="line">caller((<span class="number">1</span>,<span class="number">2</span>), my_callbcak)</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line"><span class="comment"># 1 2</span></span><br><span class="line"><span class="comment"># my_callback是回调函数，因为它作为参数传递给了caller</span></span><br></pre></td></tr></table></figure>
<h5 id="IO模型"><a href="#IO模型" class="headerlink" title="IO模型"></a>IO模型</h5><h6 id="同步IO"><a href="#同步IO" class="headerlink" title="同步IO"></a>同步IO</h6><p>同步IO模型包括阻塞IO、非阻塞IO、IO多路复用</p>
<h6 id="阻塞IO"><a href="#阻塞IO" class="headerlink" title="阻塞IO"></a>阻塞IO</h6><p><img src="/images/python网络编程tcp编程/阻塞IO.png" alt=""></p>
<p>进程等待（阻塞），直到读写完成。（全程等待）</p>
<p>read/write函数</p>
<h6 id="非阻塞IO"><a href="#非阻塞IO" class="headerlink" title="非阻塞IO"></a>非阻塞IO</h6><p><img src="/images/python网络编程tcp编程/非阻塞IO.png" alt=""></p>
<p>进程调用read操作，如果IO设备没有准备好，立即返回ERROR，进程不阻塞。用户可以再次发起系统调用，如果内核已经准备好，就阻塞，然后复制数据到用户空间。</p>
<p>第一阶段数据没有准备好，就先忙别的，等会儿再来看看。检查数据是否准备好了的过程是非阻塞的。</p>
<p>第二阶段是阻塞的，即内核空间和用户空间之间复制数据是阻塞的。</p>
<p>淘米、蒸饭我不等，我去玩会，盛饭过程我等着你装好饭，但是要等到盛好饭才算完事，这是同步的，结果就是盛好饭</p>
<p>read/write</p>
<h6 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h6><p>所谓IO多路复用，就是同时监控多个IO，有一个准备好了，就不需要等了，开始处理，提高了同时处理IO的能力。</p>
<p>select几乎所有操作系统平台都支持，poll是对select的升级。</p>
<p>epoll，linux系统内核2.5+开始支持，对select和poll的增强，在监视的基础上，增加回调机制。BSD、Mac平台有kqueue，Windows有iocp。</p>
<p><img src="/images/python网络编程tcp编程/IO多路复用.png" alt=""></p>
<p>以select为例，将关注的IO操作告诉select函数并调用，进程阻塞，内核“监视“select关注的文件描述符fd，被关注的任何一个fd对应的IO准备好了数据，select返回。再使用read将数据复制到用户进程。（当有数据在内核缓冲区准备好了，就可以读了，这些工作让select来做，你要告诉select等待谁，等待谁里面的什么事件满足之后然后再回来找你。注册时还有一个data，要盯住这个，当满足条件时把data给我就行了，就省得找了，data与每一个观察者之间对应）</p>
<p>select举例，食堂供应很多菜（众多的IO），你需要吃某三菜一汤，大师傅（操作系统）说要现做，需要等，你只好等待。其中一样菜好了，大师傅叫你过来说你点的菜有好的了，你得自己找找看哪一样菜好了，请服务员把做好的菜打给你。</p>
<p>epoll是有菜准备好了，大师傅喊你去几号窗口直接打菜，不用自己找菜了。</p>
<p>一般情况下，select最多能监听1024个fd（可以修改，但不建议改），但是由于select采用轮询的方式，当管理的IO多了，多次都要遍历全部fd，效率低下。</p>
<p>epoll没有管理的fd的上限，且是回调机制，不需遍历，效率很高。</p>
<h6 id="异步IO"><a href="#异步IO" class="headerlink" title="异步IO"></a>异步IO</h6><p><img src="/images/python网络编程tcp编程/异步IO.png" alt=""></p>
<p>进程发起异步IO请求，立即返回。内核完成IO的两个阶段，内核给进程发一个信号。</p>
<p>举例，来打饭，跟大师傅说饭好了叫你，饭菜准备好了，窗口服务员把饭盛好了打电话叫你。两阶段都是异步的。在整个过程中，进程都可以忙别的，等好了才过来</p>
<p>举例，今天不想出去到饭店吃饭了，点外卖，饭菜在饭店做好了（第一阶段），快递员从饭店送到你家门口（第二阶段）</p>
<p>Linux的aio的系统调用，内核从版本2.6开始支持</p>
<h4 id="Python中IO多路复用"><a href="#Python中IO多路复用" class="headerlink" title="Python中IO多路复用"></a>Python中IO多路复用</h4><ul>
<li>IO多路复用<ul>
<li>大多数操作系统都支持select和poll</li>
<li>Linux 2.5+支持epoll</li>
<li>BSD、Mac支持kqueue</li>
<li>Windows的IOCP</li>
</ul>
</li>
</ul>
<p>Python的select库</p>
<p>实现了select、poll系统调用，这个基本上操作系统都支持。部分实现了epoll。</p>
<p>底层的IO多路复用模块。</p>
<p>开发中的选择</p>
<ol>
<li>完全跨平台，使用select、poll。但是性能较差</li>
<li>针对不同操作系统自行选择支持的技术，这样做会提高IO处理的性能</li>
</ol>
<h5 id="selectors库"><a href="#selectors库" class="headerlink" title="selectors库"></a>selectors库</h5><p>3.4版本提供这个库，高级IO复用库。</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">类层次结构..</span><br><span class="line">BaseSelector</span><br><span class="line">+<span class="comment">-- SelectSelector 实现select</span></span><br><span class="line">+<span class="comment">-- PollSelector 实现poll</span></span><br><span class="line">+<span class="comment">-- EpollSelector 实现epoll</span></span><br><span class="line">+<span class="comment">-- DevpollSelector 实现devpoll</span></span><br><span class="line">+<span class="comment">-- KqueueSelector 实现kqueue</span></span><br></pre></td></tr></table></figure>
<p><code>selectors.DefaultSelector</code>返回当前平台最有效、性能最高的实现。<br>但是，由于没有实现Windows下的IOCP，所以，只能退化为select。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在selects模块源码最下面有如下代码</span></span><br><span class="line"><span class="comment"># Choose the best implementation, roughly:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">epoll|kqueue|devpoll &gt; poll &gt; select.</span><br><span class="line"><span class="comment"># select() also can't accept a FD &gt; FD_SETSIZE (usually around 1024)</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">'KqueueSelector'</span> <span class="keyword">in</span> globals():</span><br><span class="line">DefaultSelector = KqueueSelector</span><br><span class="line"><span class="keyword">elif</span> <span class="string">'EpollSelector'</span> <span class="keyword">in</span> globals():</span><br><span class="line">DefaultSelector = EpollSelector</span><br><span class="line"><span class="keyword">elif</span> <span class="string">'DevpollSelector'</span> <span class="keyword">in</span> globals():</span><br><span class="line">DefaultSelector = DevpollSelector</span><br><span class="line"><span class="keyword">elif</span> <span class="string">'PollSelector'</span> <span class="keyword">in</span> globals():</span><br><span class="line">DefaultSelector = PollSelector</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">DefaultSelector = SelectSelector</span><br></pre></td></tr></table></figure>
<p><code>abstractmethod register(fileobj, events, data=None)</code><br>为selector注册一个文件对象，监视它的IO事件。<br>fileobj：被监视文件对象，例如socket对象<br>events事件：该文件对象必须等待的事件<br>data：可选的与此文件对象相关联的不透明数据，例如，关联用来存储每个客户端的会话ID，关联方法。通过这个参数在关注的事件产生后让selector干什么事。</p>
<table>
<thead>
<tr>
<th>Event常量</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>EVENT_READ</td>
<td>可读0b01，内核已经准备好输入输出设备，可以开始读了</td>
</tr>
<tr>
<td>EVENT_WRITE</td>
<td>可写0b10，内核准备好了，可以往里写了</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用举例</span></span><br><span class="line"><span class="keyword">import</span> selectors</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span></span><br><span class="line">logging.basicConfig(format=FORMAT, level=logging.INFO)</span><br><span class="line"><span class="comment"># 回调函数,自己定义形参</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">accept</span><span class="params">(sock:socket.socket, mask)</span>:</span></span><br><span class="line">    <span class="string">"""mask: 事件掩码的或值 """</span></span><br><span class="line">    conn, raddr = sock.accept()</span><br><span class="line">    conn.setblocking(<span class="keyword">False</span>) <span class="comment"># 不阻塞</span></span><br><span class="line">    <span class="comment"># 监视conn这个文件对象</span></span><br><span class="line">    key = selector.register(conn, selectors.EVENT_READ, read)</span><br><span class="line">    logging.info(key)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn:socket.socket, mask)</span>:</span></span><br><span class="line">    data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    msg = <span class="string">"Your msg is &#123;&#125;."</span>.format(data.decode())</span><br><span class="line">    conn.send(msg.encode())</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 构造缺省性能最优selector</span></span><br><span class="line">selector = selectors.DefaultSelector()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Tcp Server</span></span><br><span class="line">sock = socket.socket()</span><br><span class="line">sock.bind((<span class="string">'0.0.0.0'</span>, <span class="number">9999</span>))</span><br><span class="line">sock.listen()</span><br><span class="line">logging.info(sock)</span><br><span class="line">sock.setblocking(<span class="keyword">False</span>) <span class="comment"># 非阻塞</span></span><br><span class="line"><span class="comment"># 注册文件对象sock关注读事件,返回SelectorKey</span></span><br><span class="line"><span class="comment"># 将sock、关注事件、data都绑定到key实例属性上</span></span><br><span class="line">key = selector.register(sock, selectors.EVENT_READ, accept)</span><br><span class="line">logging.info(key)</span><br><span class="line">e = threading.Event()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select</span><span class="params">(e)</span>:</span></span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">not</span> e.is_set():</span><br><span class="line">        <span class="comment"># 开始监视,等到有文件对象监控事件产生,返回(key, mask)元组</span></span><br><span class="line">        events = selector.select()</span><br><span class="line">        print(<span class="string">'-'</span>*<span class="number">30</span>)</span><br><span class="line">        <span class="keyword">for</span> key, mask <span class="keyword">in</span> events:</span><br><span class="line">            logging.info(key)</span><br><span class="line">            logging.info(mask)</span><br><span class="line">            callback = key.data <span class="comment"># 回调函数，key.data就是accept函数，赋值后callback就等于accept函数</span></span><br><span class="line">            callback(key.fileobj, mask)  <span class="comment"># key.fileobj就是socket</span></span><br><span class="line">threading.Thread(target=select, args=(e,), name=<span class="string">'select'</span>).start()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">not</span> e.is_set():</span><br><span class="line">        cmd = input(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">        <span class="keyword">if</span> cmd.strip() == <span class="string">'quit'</span>:</span><br><span class="line">            e.set()</span><br><span class="line">            fobjs = []</span><br><span class="line">            logging.info(<span class="string">'&#123;&#125;'</span>.format(list(selector.get_map().items())))</span><br><span class="line">            <span class="keyword">for</span> fd, key <span class="keyword">in</span> selector.get_map().items(): <span class="comment"># 返回注册的项</span></span><br><span class="line">                print(fd, key)</span><br><span class="line">                print(key.fileobj)</span><br><span class="line">                fobjs.append(key.fileobj)</span><br><span class="line">			<span class="keyword">for</span> fobj <span class="keyword">in</span> fobjs:</span><br><span class="line">                selector.unregister(fobj)</span><br><span class="line">                fobj.close() <span class="comment"># 关闭socket</span></span><br><span class="line">			selector.close()</span><br><span class="line">            </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<h5 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h5><p>将ChatServer改写成IO多路复用的方式<br>不需要启动多线程来执行socket的accept、recv方法了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> selectors</span><br><span class="line"></span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span></span><br><span class="line">logging.basicConfig(format=FORMAT, level=logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatServer</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, ip=<span class="string">'127.0.0.1'</span>, port=<span class="number">9999</span>)</span>:</span></span><br><span class="line">        self.sock = socket.socket()</span><br><span class="line">        self.addr = (ip, port)</span><br><span class="line">        self.event = threading.Event()</span><br><span class="line">        self.selector = selectors.DefaultSelector() <span class="comment"># 创建selector</span></span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span> <span class="comment"># 启动监听</span></span><br><span class="line">        self.sock.bind(self.addr) <span class="comment"># 绑定</span></span><br><span class="line">        self.sock.listen() <span class="comment"># 监听</span></span><br><span class="line">        self.sock.setblocking(<span class="keyword">False</span>) <span class="comment"># 不阻塞</span></span><br><span class="line">        <span class="comment"># 注册</span></span><br><span class="line">        self.selector.register(self.sock, selectors.EVENT_READ, self.accept)</span><br><span class="line">        threading.Thread(target=self.select, name=<span class="string">'selector'</span>, daemon=<span class="keyword">True</span>).start()</span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">select</span><span class="params">(self)</span>:</span> <span class="comment"># 阻塞</span></span><br><span class="line">		<span class="keyword">while</span> <span class="keyword">not</span> self.event.is_set():</span><br><span class="line">            <span class="comment"># 开始监视,等到某文件对象被监控的事件产生,返回(key, mask)元组</span></span><br><span class="line">            events = self.selector.select()  <span class="comment"># 阻塞,直到events</span></span><br><span class="line">            print(<span class="string">'-'</span> * <span class="number">30</span>)</span><br><span class="line">			<span class="keyword">for</span> key, mask <span class="keyword">in</span> events:</span><br><span class="line">                logging.info(key)</span><br><span class="line">                logging.info(mask)</span><br><span class="line">                callback = key.data</span><br><span class="line">                <span class="comment"># 回调函数</span></span><br><span class="line">                callback(key.fileobj)</span><br><span class="line">                </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">accept</span><span class="params">(self, sock:socket.socket)</span>:</span> <span class="comment"># 接收客户端连接</span></span><br><span class="line">        conn, raddr = sock.accept()</span><br><span class="line">        conn.setblocking(<span class="keyword">False</span>) <span class="comment"># 非阻塞</span></span><br><span class="line">        <span class="comment"># 注册,监视每一个与客户端的连接的socket对象</span></span><br><span class="line">        self.selector.register(conn, selectors.EVENT_READ, self.recv)</span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">recv</span><span class="params">(self, sock:socket.socket)</span>:</span> <span class="comment"># 接收客户端数据</span></span><br><span class="line">        data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> data == <span class="string">b'quit'</span>: <span class="comment"># 客户端主动断开或退出,注销并关闭socket</span></span><br><span class="line">            self.selector.unregister(sock)</span><br><span class="line">            sock.close()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">		msg = <span class="string">"&#123;:%Y/%m/%d %H:%M:%S&#125; &#123;&#125;:&#123;&#125;\n&#123;&#125;\n"</span>.format(datetime.datetime.now(), *sock.getpeername(),data.decode())</span><br><span class="line">		logging.info(msg)</span><br><span class="line">		msg = msg.encode()</span><br><span class="line">        <span class="comment"># 群发</span></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> self.selector.get_map().values():</span><br><span class="line">			<span class="keyword">if</span> key.data == self.recv: <span class="comment"># 排除self.accept</span></span><br><span class="line">				key.fileobj.send(msg)</span><br><span class="line">                </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self)</span>:</span> <span class="comment"># 停止服务</span></span><br><span class="line">        self.event.set()</span><br><span class="line">        fobjs = []</span><br><span class="line">        <span class="keyword">for</span> fd, key <span class="keyword">in</span> self.selector.get_map().items():</span><br><span class="line">			fobjs.append(key.fileobj)</span><br><span class="line">		<span class="keyword">for</span> fobj <span class="keyword">in</span> fobjs:</span><br><span class="line">            self.selector.unregister(fobj)</span><br><span class="line">            fobj.close()</span><br><span class="line">		self.selector.close()</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    cs = ChatServer()</span><br><span class="line">    cs.start()</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        cmd = input(<span class="string">'&gt;&gt;'</span>).strip()</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="string">'quit'</span>:</span><br><span class="line">            cs.stop()</span><br><span class="line">            threading.Event().wait(<span class="number">3</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">		logging.info(threading.enumerate())</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<p>进阶<br>send是写操作，也可以让selector监听，如何监听？<br><code>self.selector.register(conn, selectors.EVENT_READ | selectors.EVENT_WRITE, self.recv)</code><br>注册语句，要监听selectors.EVENT_READ | selectors.EVENT_WRITE 读与写事件。<br>回调的时候，需要mask来判断究竟是读触发还是写触发了。所以，需要修改方法声明，增加mask。<br><code>def recv(self, sock, mask)</code>但是由于recv 方法处理读和写事件，所以叫recv不太合适，改名为<br><code>def handle(self, sock, mask)</code><br>注意读和写是分离的，那么handle函数应该写成下面这样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self, sock:socket.socket, mask)</span>:</span> <span class="comment"># 接收客户端数据</span></span><br><span class="line">	<span class="keyword">if</span> mask &amp; selectors.EVENT_READ:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment"># 注意,这里是某一个socket的写操作</span></span><br><span class="line">	<span class="keyword">if</span> mask &amp; selectors.EVENT_WRITE: <span class="comment"># 写缓冲区准备好了,可以写入数据了</span></span><br><span class="line">		<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>handle方法里面处理读、写，mask有可能是0b01、0b10、0b11。<br>问题是，假设读取到了客户端发来的数据后，如何写出去?<br>为每一个与客户端连接的socket对象增加对应的队列。<br>与每一个客户端连接的socket对象，自己维护一个队列，某一个客户端收到信息后，会遍历发给所有客户端的队列。这里完成一对多，即一份数据放到了所有队列中。<br>与每一个客户端连接的socket对象，发现自己队列有数据，就发送给客户端。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> selectors</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span></span><br><span class="line">logging.basicConfig(format=FORMAT, level=logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatServer</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, ip=<span class="string">'127.0.0.1'</span>, port=<span class="number">9999</span>)</span>:</span></span><br><span class="line">        self.sock = socket.socket()</span><br><span class="line">        self.addr = (ip, port)</span><br><span class="line">        self.clients = &#123;&#125;</span><br><span class="line">        self.event = threading.Event()</span><br><span class="line">        self.selector = selectors.DefaultSelector() <span class="comment"># 创建selector</span></span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span> <span class="comment"># 启动监听</span></span><br><span class="line">        self.sock.bind(self.addr) <span class="comment"># 绑定</span></span><br><span class="line">        self.sock.listen() <span class="comment"># 监听</span></span><br><span class="line">        self.sock.setblocking(<span class="keyword">False</span>) <span class="comment"># 不阻塞</span></span><br><span class="line">        <span class="comment"># 注册</span></span><br><span class="line">        self.selector.register(self.sock, selectors.EVENT_READ, self.accept)</span><br><span class="line">		threading.Thread(target=self.select, name=<span class="string">'selector'</span>, daemon=<span class="keyword">True</span>).start()</span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">select</span><span class="params">(self)</span>:</span> <span class="comment"># 阻塞</span></span><br><span class="line">		<span class="keyword">while</span> <span class="keyword">not</span> self.event.is_set():</span><br><span class="line">            <span class="comment"># 开始监视,等到某文件对象被监控的事件产生,返回(key, mask)元组</span></span><br><span class="line">            events = self.selector.select()  <span class="comment"># 阻塞,直到events</span></span><br><span class="line">            </span><br><span class="line">			<span class="keyword">for</span> key, mask <span class="keyword">in</span> events:</span><br><span class="line">				<span class="keyword">if</span> callable(key.data):</span><br><span class="line">                    callback = key.data  <span class="comment"># key对象的data属性,回调</span></span><br><span class="line">                    callback(key.fileobj, mask)</span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">                    callback = key.data[<span class="number">0</span>]</span><br><span class="line">                    callback(key, mask)</span><br><span class="line">                    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">accept</span><span class="params">(self, sock:socket.socket, mask)</span>:</span> <span class="comment"># 接收客户端连接</span></span><br><span class="line">        conn, raddr = sock.accept()</span><br><span class="line">        conn.setblocking(<span class="keyword">False</span>) <span class="comment"># 非阻塞</span></span><br><span class="line">        self.clients[raddr] = (self.handle, Queue())</span><br><span class="line">        <span class="comment"># 注册,监视每一个与客户端的连接的socket对象</span></span><br><span class="line">        self.selector.register(conn, selectors.EVENT_READ | selectors.EVENT_WRITE, self.clients[raddr])</span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self, key: selectors.SelectorKey, mask)</span>:</span> <span class="comment"># 接收客户端数据</span></span><br><span class="line">		<span class="keyword">if</span> mask &amp; selectors.EVENT_READ:</span><br><span class="line">            sock = key.fileobj</span><br><span class="line">            raddr = sock.getpeername()</span><br><span class="line">            data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> data == <span class="string">b'quit'</span>:</span><br><span class="line">                self.selector.unregister(sock)</span><br><span class="line">                sock.close()</span><br><span class="line">                self.clients.pop(raddr)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">			msg = <span class="string">"&#123;:%Y/%m/%d %H:%M:%S&#125; &#123;&#125;:&#123;&#125;\n&#123;&#125;\n"</span>.format(</span><br><span class="line">				datetime.datetime.now(), *raddr, data.decode())</span><br><span class="line">            logging.info(msg)</span><br><span class="line">            msg = msg.encode()</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> self.selector.get_map().values():</span><br><span class="line">                logging.info(k)</span><br><span class="line">                <span class="keyword">if</span> isinstance(k.data, tuple):</span><br><span class="line">					k.data[<span class="number">1</span>].put(data)</span><br><span class="line">		<span class="keyword">if</span> mask &amp; selectors.EVENT_WRITE:</span><br><span class="line">            <span class="comment"># 因为写一直就绪,mask为2,所以一直可以写,从而导致select()不断循环,如同不阻塞一样</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> key.data[<span class="number">1</span>].empty():</span><br><span class="line">    			key.fileobj.send(key.data[<span class="number">1</span>].get())</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self)</span>:</span> <span class="comment"># 停止服务</span></span><br><span class="line">        self.event.set()</span><br><span class="line">        fobjs = []</span><br><span class="line">        <span class="keyword">for</span> fd, key <span class="keyword">in</span> self.selector.get_map().items():</span><br><span class="line">			fobjs.append(key.fileobj)</span><br><span class="line">		<span class="keyword">for</span> fobj <span class="keyword">in</span> fobjs:</span><br><span class="line">            self.selector.unregister(fobj)</span><br><span class="line">            fobj.close()</span><br><span class="line">		self.selector.close()</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    cs = ChatServer()</span><br><span class="line">    cs.start()</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        cmd = input(<span class="string">'&gt;&gt;'</span>).strip()</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="string">'quit'</span>:</span><br><span class="line">            cs.stop()</span><br><span class="line">            threading.Event().wait(<span class="number">3</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        logging.info(threading.enumerate())</span><br><span class="line">        logging.info(<span class="string">'-'</span>*<span class="number">30</span>)</span><br><span class="line">        logging.info(<span class="string">"&#123;&#125; &#123;&#125;"</span>.format(len(cs.clients), cs.clients))</span><br><span class="line">        logging.info(list(map(<span class="keyword">lambda</span> x: (x.fileobj.fileno(), x.data), cs.selector.get_map().values())))</span><br><span class="line">		logging.info(<span class="string">'-'</span>*<span class="number">30</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<p>这个程序最大的问题，在select()一直判断可写，几乎一直循环不停。所以对于写不频繁的情况下,就不要监听<br>EVENT_WRITE。<br>对于Server来说，一般来说，更多的是等待对方发来数据后响应时才发出数据，而不是积极的等着发送数据。所以监听EVENT_READ，收到数据之后再发送就可以了。<br>本例只完成基本功能，其他功能如有需要，请自行完成。</p>
<h4 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h4><p>IO多路复用，文件操作盯的就是读写，对IO来讲就是IN和OUT。IO多路复用与多线程没关系，它就不是多线程的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> selectors</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> myutils </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">accept</span><span class="params">(sock:socket.socket)</span>:</span>  <span class="comment"># 这里的sock就是下面定义的sock</span></span><br><span class="line">    conn, _ = sock.accept()  <span class="comment"># 阻塞等待“连接”到来，conn就是传输数据的socket</span></span><br><span class="line">    conn.setblocking(<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    selector.register(conn, selectors.EVENT_READ, recv)</span><br><span class="line">print(accept)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv</span><span class="params">(conn:socket.socket)</span>:</span></span><br><span class="line">    data = conn.recv(<span class="number">1024</span>).strip().decode()</span><br><span class="line">    print(data)</span><br><span class="line">    msg = <span class="string">"Your msg = &#123;&#125;"</span>.format(data)</span><br><span class="line">    conn.send(msg.encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 平台自适应</span></span><br><span class="line">selector = selectors.DefaultSelector()  </span><br><span class="line"><span class="comment"># 这就是之后帮助做事的，我们只关心有事件了selector通知我，其他的我们都不关心</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建监听socket对象，监控文件对象，socket也是文件对象</span></span><br><span class="line">sock = socket.socket()</span><br><span class="line">ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">9999</span></span><br><span class="line">addr = (ip, port)</span><br><span class="line">sock.bind(addr)</span><br><span class="line">sock.listen()</span><br><span class="line">sock.setblocking(<span class="keyword">False</span>)  </span><br><span class="line"><span class="comment"># 建议把文件转换为非阻塞的模式，accept默认是不阻塞的，不阻塞的线程会直接退出，所以accept就不能卡住线程</span></span><br><span class="line"><span class="comment"># 用非阻塞的方式使用socket，下面就不能再用sock.accept()，因为这样的话如果没有连接进来就卡不住了，我们要把</span></span><br><span class="line"><span class="comment"># 卡住线程这件事交给事件去处理，由selector来观察这个事件，selector中的select会挑选准备好的。与selector的</span></span><br><span class="line"><span class="comment"># 交互是通过注册的，就是下面的key = selector.register(sock, selectors.EVENT_READ, accept)，让</span></span><br><span class="line"><span class="comment"># selector盯住sock，盯住读就可以（selectors.EVENT_READ），sock.accept()就是读，如果读准备好了，就给他</span></span><br><span class="line"><span class="comment"># 一个accept，以后就处理accept就行了</span></span><br><span class="line">e = threading.Event()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册selector中监听的对象，事件和回调的data。</span></span><br><span class="line">key = selector.register(sock, selectors.EVENT_READ, accept)</span><br><span class="line"><span class="comment"># 这时还没有人调用accept函数</span></span><br><span class="line">print(key)</span><br><span class="line"></span><br><span class="line">myutils.show_threads()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> e.is_set():</span><br><span class="line">    events = selector.select()  <span class="comment"># 因为有条件满足，就不再阻塞了，所以要想继续监视，就要用循环，看还有没有连接进来。运行代码后，会在这行阻塞住 </span></span><br><span class="line">    <span class="keyword">if</span> events:</span><br><span class="line">        print(events)  <span class="comment"># 列表</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> key, mask <span class="keyword">in</span> events:</span><br><span class="line">        print(key, mask)</span><br><span class="line">        callback = key.data  <span class="comment"># accept or recv</span></span><br><span class="line">        callback(key.fileobj)</span><br><span class="line">       </span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line">&lt;function accept at <span class="number">0x7f089670a1e0</span>&gt;</span><br><span class="line">SelectorKey(fileobj=&lt;socket.socket fd=<span class="number">4</span>, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=<span class="number">0</span>, laddr=(<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>)&gt;, fd=<span class="number">4</span>, events=<span class="number">1</span>, data=&lt;function accept at <span class="number">0x7f089670a1e0</span>&gt;)</span><br><span class="line"><span class="comment"># 在没有连接时，输出的是一个四元组，第一项是你让我监视谁，第二项是被监视的对象的文件描述符是谁，第三项的</span></span><br><span class="line"><span class="comment"># events是1，表示READ，这是未来要等的，现在还没产生这个事件，这就是上面register中注册的，第四项data是</span></span><br><span class="line"><span class="comment"># accept，这与打印的accept函数对象是同一个，这就是未来select要帮我们调用的东西</span></span><br></pre></td></tr></table></figure>
<p>wechatServer群聊</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> selectors</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(format=<span class="string">'%(thread)s %(threadName)s %(message)s'</span>, level=logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatServer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, ip=<span class="string">'127.0.0.1'</span>, port=<span class="number">9999</span>)</span>:</span></span><br><span class="line">        self.sock = socket.socket()  <span class="comment"># 这是监听的socket</span></span><br><span class="line">        self.addr = (ip, port)</span><br><span class="line">        self.event = threading.Event()</span><br><span class="line">        </span><br><span class="line">        self.selector = selectors.DefaultSelector()  </span><br><span class="line">        self.clients = &#123;&#125;  <span class="comment"># 存储不同的客户端socket</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sock.bind(self.addr)</span><br><span class="line">        self.sock.listen()</span><br><span class="line">        self.sock.setblocking(<span class="keyword">False</span>)</span><br><span class="line">        <span class="comment">#threading.Thread(target=self._accept, name='accept').start()</span></span><br><span class="line">        key = self.selector.register(self.sock, selectors.EVENT_READ, self._accept)</span><br><span class="line">        </span><br><span class="line">        threading.Thread(target=self._run(), name=<span class="string">"run"</span>).start()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.event.is_set():</span><br><span class="line">            events = self.selector.select(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 等待1秒超时，如果不阻塞，events就不会有值，一个事件都没等到，events就没有值，如果events列表没有值，下面</span></span><br><span class="line"><span class="comment"># 的for循环写不写都一样了，进入下一轮循环。所以这样写也可以，不加超时时间也可以。写超时时间就不会阻塞，不写</span></span><br><span class="line"><span class="comment"># 超时时间就会阻塞，都可以。讲课时没有写超时时间</span></span><br><span class="line">            <span class="keyword">for</span> skey, mask <span class="keyword">in</span> events:  <span class="comment"># mask就是读或写，表现为1或2</span></span><br><span class="line">                callback = skey.data</span><br><span class="line">                callback(skey.fileobj, mask)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># TODO</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> self.clients.values():</span><br><span class="line">            c.close()</span><br><span class="line">        self.sock.close()</span><br><span class="line">        self.event.wait(<span class="number">3</span>)  <span class="comment"># 关闭时要花费一些时间，所以这里等一会儿，因为是关闭所以无所谓</span></span><br><span class="line">        self.event.set()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_accept</span><span class="params">(self,sock:socket.socket, mask)</span>:</span>  <span class="comment"># 这里不再需要循环了，产生数据时由select找_accept</span></span><br><span class="line">        conn, client = self.sock.accept()</span><br><span class="line">        conn.setblocking(<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">        self.clients[client] = conn  <span class="comment"># 记录socket</span></span><br><span class="line"></span><br><span class="line">        threading.Thread(target=self._recv, args=(f,client), name=<span class="string">"recv"</span>).start()</span><br><span class="line">        <span class="comment"># TODO reg</span></span><br><span class="line">        self.selector.register(conn, selectors.EVENT_READ | selectors.EVENT_WRITE, self._recv)  <span class="comment"># 监听socket的读和写，有数据进来就_recv</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_recv</span><span class="params">(self, conn:socket.socket, mask)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (mask &amp; selectors.EVENT_READ) == selectors.EVENT_READ:  <span class="comment"># 位与，与完是01，可能读写同时满足，mask是3</span></span><br><span class="line">        </span><br><span class="line">            <span class="comment"># 接收到了数据，然后分发</span></span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> self.event.is_set():</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    data = f.readline()</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logging.info(e)</span><br><span class="line">                    data = <span class="string">b"quit"</span></span><br><span class="line">    <span class="comment"># try...except一段可以有效地把recv产生的各种问题拦截下来，保证以正常流程退出。当客户端断开时会抛出错</span></span><br><span class="line">    <span class="comment"># 误，这里会伪造成服务端主动断开，也就是data = b"quit"一句，再通过下面的if语句退出</span></span><br><span class="line">                <span class="comment"># data = data.decode()  # 用makefile就不需要解码了</span></span><br><span class="line">                logging.info(data)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 客户端通知的退出机制</span></span><br><span class="line">                <span class="keyword">if</span> data == <span class="string">"quit"</span>:</span><br><span class="line">                    logging.info(<span class="string">'quit!'</span>)</span><br><span class="line">                    self.clients.pop(client)</span><br><span class="line">    <span class="comment"># 断开时会报错，这里是不是应该写成conn = self.clients.pop(client)</span></span><br><span class="line">                    f.close()  <span class="comment"># 这句表示服务端主动与客户端断开</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                msg = <span class="string">"ack &#123;&#125;"</span>.format(data)</span><br><span class="line">                <span class="keyword">for</span> c <span class="keyword">in</span> self.clients.values():  <span class="comment"># 因为是群发，所以用不到字典的key</span></span><br><span class="line">                    c.send(msg.encode())</span><br><span class="line">                   <span class="comment"># c.write(msg) </span></span><br><span class="line">                   <span class="comment"># c.flush()</span></span><br><span class="line">           <span class="keyword">if</span> (mask &amp; selectors.EVENT_WRITE) == selectors.EVENT_WRITE:  <span class="comment"># 位与，与完是01</span></span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">          </span><br><span class="line">cs = ChatServer()</span><br><span class="line">cs.start()</span><br><span class="line"></span><br><span class="line">e = threading.Event()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showthreads</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> e.wait(<span class="number">3</span>):</span><br><span class="line">        logging.info(threading.enumerate())</span><br><span class="line">        </span><br><span class="line"><span class="comment"># showthreads()</span></span><br><span class="line">threading.Thread(target=showthreads, daemon=<span class="keyword">True</span>).start()  <span class="comment"># 因为随时可以结束，所以设置成daemon的</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    cmd = input(<span class="string">"&gt;&gt;&gt;"</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">"quit"</span>:</span><br><span class="line">		cs.stop()</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">265</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">185</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
