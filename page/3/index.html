<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/3/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/18/RabbitMQ安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/18/RabbitMQ安装/" itemprop="url">
                  RabbitMQ安装
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-18 14:52:42" itemprop="dateCreated datePublished" datetime="2018-10-18T14:52:42+08:00">2018-10-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-19 13:06:27" itemprop="dateModified" datetime="2018-10-19T13:06:27+08:00">2018-10-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/消息队列/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>下载rpm包<br><a href="http://www.rabbitmq.com/download.html" target="_blank" rel="noopener">http://www.rabbitmq.com/download.html</a></li>
</ul>
<p><img src="/images/rabbitmq/下载页面1.jpg" alt=""></p>
<ul>
<li>分别点击两个箭头指向的页面下载相应包</li>
</ul>
<p><img src="/images/rabbitmq/下载页面2.jpg" alt=""></p>
<ul>
<li>箭头指向为CentOS7中可以安装的erlang的rpm包和rabbitmq的rpm包</li>
</ul>
<p><img src="/images/rabbitmq/下载页面3.jpg" alt=""></p>
<p><img src="/images/rabbitmq/下载页面4.jpg" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum install -y erlang-19.3.6.11-2.el7.centos.x86_64.rpm</span><br><span class="line">yum install -y rabbitmq-server-3.6.16-2.el7.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将两个rpm包上传到服务器并安装</span></span><br><span class="line">vim /etc/rabbitmq/rabbitmq.config</span><br><span class="line">	[&#123;rabbit, [&#123;loopback_users, []&#125;]&#125;].</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装后没有此文件，自已创建此文件并加入上面内容，不要忘记最后点</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启网页管理页面的插件</span></span><br><span class="line">cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.16/plugins/</span><br><span class="line">wget https://dl.bintray.com/rabbitmq/community-plugins/rabbitmq_delayed_message_exchange-0.0.1.ez</span><br><span class="line"><span class="meta">#</span><span class="bash"> 消息延迟发送给消费者的插件</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br><span class="line">service rabbitmq-server start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果无法启动，可以使用journalctl -xe &gt; /root/abc.txt命令将报错信息重定向到一个文件，并查看。测试中无法启动是因为上面的配置文件写错了，改成上面的样子后启动就没问题了。</span></span><br><span class="line">ss -tlnp</span><br><span class="line"><span class="meta">#</span><span class="bash"> rabbitmq的网页默认监听在15672端口上，服务器监听在5672端口</span></span><br></pre></td></tr></table></figure>
<ul>
<li>访问rabbitmq远程管理页面。默认用户名和密码都是guest</li>
</ul>
<p><img src="/images/rabbitmq/登录1.jpg" alt=""></p>
<p><img src="/images/rabbitmq/登录2.jpg" alt=""></p>
<h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><h4 id="账号级别"><a href="#账号级别" class="headerlink" title="账号级别"></a>账号级别</h4><ul>
<li>超级管理员administrator，可以登录控制台，查看所有信息，可以对用户和策略进行操作</li>
<li>监控者monitoring，可以登录控制台，可以查看节点的相关信息，比如进程数，内存磁盘使用情况</li>
<li>策略制定者policymaker，可以登录控制台，制定策略，但是无法查看节点信息</li>
<li>普通管理员management，仅能登录控制台</li>
<li>其他，无法登录控制台，一般指的是提供者和消费者</li>
</ul>
<h4 id="添加账号"><a href="#添加账号" class="headerlink" title="添加账号"></a>添加账号</h4><h5 id="命令添加"><a href="#命令添加" class="headerlink" title="命令添加"></a>命令添加</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user username password</span><br><span class="line"><span class="meta">#</span><span class="bash">添加用户和密码</span></span><br><span class="line">rabbitmqctl set_user_tags username Account_level</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给用户一个账号级别，如administrator,monitoring等</span></span><br></pre></td></tr></table></figure>
<h5 id="网页添加"><a href="#网页添加" class="headerlink" title="网页添加"></a>网页添加</h5><ul>
<li>添加用户</li>
</ul>
<p><img src="/images/rabbitmq/添加用户1.jpg" alt=""></p>
<ul>
<li>添加后的用户还没有指定可以访问的路径</li>
</ul>
<p><img src="/images/rabbitmq/添加用户2.jpg" alt=""></p>
<ul>
<li>添加虚拟主机</li>
</ul>
<p><img src="/images/rabbitmq/添加虚拟主机1.jpg" alt=""></p>
<ul>
<li>点击/test进入页面，之后指定用户。这相当于建立了一个用户可以访问的库</li>
</ul>
<p><img src="/images/rabbitmq/添加虚拟主机2.jpg" alt=""></p>
<p><img src="/images/rabbitmq/添加虚拟主机3.jpg" alt=""></p>
<p><img src="/images/rabbitmq/添加用户3.jpg" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/17/awk内置函数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/17/awk内置函数/" itemprop="url">
                  awk内置函数
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-17 16:48:35" itemprop="dateCreated datePublished" datetime="2018-10-17T16:48:35+08:00">2018-10-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-29 08:31:40" itemprop="dateModified" datetime="2018-10-29T08:31:40+08:00">2018-10-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="awk内置函数"><a href="#awk内置函数" class="headerlink" title="awk内置函数"></a>awk内置函数</h3><h4 id="算数函数"><a href="#算数函数" class="headerlink" title="算数函数"></a>算数函数</h4><h5 id="rand函数"><a href="#rand函数" class="headerlink" title="rand函数"></a>rand函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print rand()&#125;'</span><br><span class="line">0.237788</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print rand()&#125;'</span><br><span class="line">0.237788</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print rand()&#125;'</span><br><span class="line">0.237788</span><br><span class="line"><span class="meta">#</span><span class="bash"> 单纯的使用rand函数，生成的值是不变的</span></span><br></pre></td></tr></table></figure>
<h5 id="srand函数"><a href="#srand函数" class="headerlink" title="srand函数"></a>srand函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print rand()&#125;'</span><br><span class="line">0.121122</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print rand()&#125;'</span><br><span class="line">0.665691</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print rand()&#125;'</span><br><span class="line">0.383723</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配合srand函数使用rand函数就可以生成小于1的随机数了</span></span><br></pre></td></tr></table></figure>
<h5 id="int函数"><a href="#int函数" class="headerlink" title="int函数"></a>int函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print rand()&#125;'</span><br><span class="line">0.999933</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print 100*rand()&#125;'</span><br><span class="line">72.6895</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;srand();print int(100*rand())&#125;'</span><br><span class="line">82</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用int函数最后截取出一个整数，第二步后要取出多少位的值就乘以多少</span></span><br></pre></td></tr></table></figure>
<h4 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h4><h5 id="gsub函数"><a href="#gsub函数" class="headerlink" title="gsub函数"></a>gsub函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# cat test4</span><br><span class="line">Allen Phillips</span><br><span class="line">Green Lee</span><br><span class="line">William Aiden James Lee</span><br><span class="line">Angel Jack</span><br><span class="line">Tyler Kevin</span><br><span class="line">Lucas Thomas</span><br><span class="line">Kevin</span><br><span class="line">[root@bogon ~]# awk '&#123;gsub("l","L",$1);print $0&#125;' test4</span><br><span class="line">ALLen Phillips</span><br><span class="line">Green Lee</span><br><span class="line">WiLLiam Aiden James Lee</span><br><span class="line">AngeL Jack</span><br><span class="line">TyLer Kevin</span><br><span class="line">Lucas Thomas</span><br><span class="line">Kevin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用gsub函数，将小写字母<span class="string">"l"</span>替换成大写字母<span class="string">"L"</span>，但是替换的范围只限于<span class="string">"<span class="variable">$1</span>"</span>，所以，当我们再次输出文本时，发现只有文本中的第一列中的小写字母<span class="string">"l"</span>被替换成了大写字母<span class="string">"L"</span>，其他列中的小写字母<span class="string">"l"</span>并未被替换。如果想要替换文本中所有的小写字母<span class="string">"l"</span>，则可以将上图中的<span class="string">"<span class="variable">$1</span>"</span>换成<span class="string">"<span class="variable">$0</span>"</span>，或者省略gsub函数中的第三个参数，省略gsub中的第三个参数时，默认为<span class="string">"<span class="variable">$0</span>"</span></span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;gsub("[a-z]","6",$1);print $0&#125;' test4</span><br><span class="line">A6666 Phillips</span><br><span class="line">G6666 Lee</span><br><span class="line">W666666 Aiden James Lee</span><br><span class="line">A6666 Jack</span><br><span class="line">T6666 Kevin</span><br><span class="line">L6666 Thomas</span><br><span class="line">K6666</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过正则表达式进行匹配，这里将第一列中的小写字母都替换成了6</span></span><br></pre></td></tr></table></figure>
<h5 id="sub函数"><a href="#sub函数" class="headerlink" title="sub函数"></a>sub函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;sub("l","L",$1);print $0&#125;' test4</span><br><span class="line">ALlen Phillips</span><br><span class="line">Green Lee</span><br><span class="line">WiLliam Aiden James Lee</span><br><span class="line">AngeL Jack</span><br><span class="line">TyLer Kevin</span><br><span class="line">Lucas Thomas</span><br><span class="line">Kevin</span><br><span class="line"><span class="meta">#</span><span class="bash"> sub函数只会替换指定范围内第一次匹配到的符合条件的字符。</span></span><br></pre></td></tr></table></figure>
<h5 id="length函数"><a href="#length函数" class="headerlink" title="length函数"></a>length函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;for(i=1;i&lt;=NF;i++)&#123;print $i,length($i)&#125;&#125;' test4</span><br><span class="line">Allen 5</span><br><span class="line">Phillips 8</span><br><span class="line">Green 5</span><br><span class="line">Lee 3</span><br><span class="line">William 7</span><br><span class="line">Aiden 5</span><br><span class="line">James 5</span><br><span class="line">Lee 3</span><br><span class="line">Angel 5</span><br><span class="line">Jack 4</span><br><span class="line">Tyler 5</span><br><span class="line">Kevin 5</span><br><span class="line">Lucas 5</span><br><span class="line">Thomas 6</span><br><span class="line">Kevin 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过length函数，获取到指定字符串的长度。</span></span><br><span class="line">[root@bogon ~]# awk '&#123;print $0,length()&#125;' test4</span><br><span class="line">Allen Phillips 14</span><br><span class="line">Green Lee 9</span><br><span class="line">William Aiden James Lee 23</span><br><span class="line">Angel Jack 10</span><br><span class="line">Tyler Kevin 11</span><br><span class="line">Lucas Thomas 12</span><br><span class="line">Kevin 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> length函数可以省略传入的参数，即不指定任何字符串，当省略参数时，默认使用<span class="string">"<span class="variable">$0</span>"</span>作为参数</span></span><br></pre></td></tr></table></figure>
<h5 id="index函数"><a href="#index函数" class="headerlink" title="index函数"></a>index函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print index($0,"Lee")&#125;' test4</span><br><span class="line">0</span><br><span class="line">7</span><br><span class="line">21</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用index函数，在每一行中找字符串<span class="string">"Lee"</span>，如果Lee存在于当前行，则返回字符串Lee位于当前行的位置，如果Lee不存在于当前行，则返回0，表示当前行并不存在Lee，如上，第二行中包含Lee，而且Lee位于第二行的第7个字符的位置，所以返回数字7</span></span><br></pre></td></tr></table></figure>
<h5 id="split函数"><a href="#split函数" class="headerlink" title="split函数"></a>split函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk -v ts="大鹏:少松:老董" 'BEGIN&#123;split(ts,test,":");for(i in test)&#123;print test[i]&#125;&#125;'</span><br><span class="line">大鹏</span><br><span class="line">少松</span><br><span class="line">老董</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过split函数，将字符串ts切割了，以<span class="string">":"</span>作为分割符，将分割后的字符串保存到了名为<span class="built_in">test</span>的数组中，当我们输出数组中的元素时，每个元素的值为分割后的字符，其实，split函数也有对应的返回值，其返回值就是分割以后的数组长度</span></span><br><span class="line">[root@bogon ~]# awk -v ts="大鹏:少松:老董" 'BEGIN&#123;print split(ts,test,":")&#125;'</span><br><span class="line">3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 被split函数分割后的数组的元素下标从1开始，不像其他语言中的数组下标是从0开始的，而且数组中元素输出的顺序可能与字符串中字符的顺序不同</span></span><br><span class="line">[root@bogon ~]# awk -v ts="大鹏:少松:老董" 'BEGIN&#123;ruo=split(ts,test,":");for(i=1;i&lt;=ruo;i++)&#123;print i,test[i]&#125;&#125;'</span><br><span class="line">1 大鹏</span><br><span class="line">2 少松</span><br><span class="line">3 老董</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="keyword">for</span>(i=1;i&lt;=ruo;i++)这样的循环语句，才能按顺序输出内容</span></span><br></pre></td></tr></table></figure>
<h4 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">* asort</span><br><span class="line"><span class="meta">#</span><span class="bash"> asort 函数可以根据元素的值进行排序</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["a"]=66;t["b"]=88;t["c"]=3;for(i in t)&#123;print i,t[i]&#125;&#125;'</span><br><span class="line">a 66</span><br><span class="line">b 88</span><br><span class="line">c 3</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["a"]=66;t["b"]=88;t["c"]=3;asort(t);for(i in t)&#123;print i,t[i]&#125;&#125;'</span><br><span class="line">1 3</span><br><span class="line">2 66</span><br><span class="line">3 88</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数组中元素的值均为数字，但是下标为自定义的字符串，通过asort函数对数组排序后，再次输出数组中的元素时，已经按照元素的值的大小进行了排序，但是，数组的下标也被重置为了纯数字。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["a"]=66;t["b"]=88;t["c"]=3;asort(t,newt);for(i in t)&#123;print i,t[i]&#125;&#125;'</span><br><span class="line">a 66</span><br><span class="line">b 88</span><br><span class="line">c 3</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["a"]=66;t["b"]=88;t["c"]=3;asort(t,newt);for(i in newt)&#123;print i,newt[i]&#125;&#125;'</span><br><span class="line">1 3</span><br><span class="line">2 66</span><br><span class="line">3 88</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对原数组元素值排序的同时，创建一个新的数组，将排序后的元素放置在新数组中。上面两条命令一条打印源数组的值，一条打印新数组的值。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["a"]=66;t["b"]=88;t["c"]=3;len=asort(t,newt);for(i=1;i&lt;=len;i++)&#123;print i,newt[i]&#125;&#125;'</span><br><span class="line">1 3</span><br><span class="line">2 66</span><br><span class="line">3 88</span><br><span class="line"><span class="meta">#</span><span class="bash"> asort函数也有返回值，它的返回值就是数组的长度。这里将asort的返回值保存在了len中</span></span><br><span class="line"></span><br><span class="line">* asorti</span><br><span class="line"><span class="meta">#</span><span class="bash"> asorti 函数可以根据元素的下标进行排序</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["z"]=66;t["q"]=88;t["a"]=3;for(i in t)&#123;print i,t[i]&#125;&#125;'</span><br><span class="line">z 66</span><br><span class="line">a 3</span><br><span class="line">q 88</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["z"]=66;t["q"]=88;t["a"]=3;len=asorti(t,newt);for(i=1;i&lt;=len;i++)&#123;print i,newt[i]&#125;&#125;'</span><br><span class="line">1 a</span><br><span class="line">2 q</span><br><span class="line">3 z</span><br><span class="line"><span class="meta">#</span><span class="bash"> asorti 函数根据数组t的下标排序后，创建了一个新的数组newt，newt中元素的值即为t数组下标的值，上例中，我们使用len变量保存了asorti函数的返回值，并且输出了最后排序后的新数组。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["z"]=66;t["q"]=88;t["a"]=3;len=asorti(t,newt);for(i=1;i&lt;=len;i++)&#123;print i,newt[i]&#125;&#125;'</span><br><span class="line">1 a</span><br><span class="line">2 q</span><br><span class="line">3 z</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;t["z"]=66;t["q"]=88;t["a"]=3;len=asorti(t,newt);for(i=1;i&lt;=len;i++)&#123;print i,t[newt[i]]&#125;&#125;'</span><br><span class="line">1 3</span><br><span class="line">2 88</span><br><span class="line">3 66</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据排序后的下标再次输出对应的元素值，从而达到根据数组下标排序后，输出原数组元素的目的。新数组负责排序老数组的下标，并将排序后的下标作为新数组的元素，而我们输出新数组元素的同时，又将新数组的元素值作为老数组下标，从而输出了老数组中的元素值</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/17/awk数组/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/17/awk数组/" itemprop="url">
                  awk数组
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-17 15:20:44" itemprop="dateCreated datePublished" datetime="2018-10-17T15:20:44+08:00">2018-10-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-29 08:32:01" itemprop="dateModified" datetime="2018-10-29T08:32:01+08:00">2018-10-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="awk数组"><a href="#awk数组" class="headerlink" title="awk数组"></a>awk数组</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[0]="大鹏";test[1]="少松";test[2]="老董";print test[1]&#125;'</span><br><span class="line">少松</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为数组中的元素赋值，下标从0开始。最后打印数组中的第二个元素。awk的数组默认从1开始。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[0]="大鹏";test[1]="少松";test[2]="老董";test[3]="正伟";test[4]="法林";test[5]="";print test[5]&#125;'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面<span class="built_in">test</span>[5]设置为了空字符串，在awk中也是被允许的，所以可以打印出一个空行</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[0]="大鹏";test[1]="少松";test[2]="老董";test[3]="正伟";test[4]="法林";test[5]="";print test[6]&#125;'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在引用一个不存在的数组元素也是可以的，会打印出一个空字符串。</span></span><br><span class="line"></span><br><span class="line">* 语法</span><br><span class="line">	if(下标 in 数组名)</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 判断数组中是否存在对应的元素</span></span><br><span class="line">	delete</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 删除整个数组</span></span><br><span class="line">	</span><br><span class="line">* 使用数字为下标</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[0]="大鹏";test[1]="少松";test[2]="老董";test[3]="正伟";test[4]="法林";test[5]="";if(6 in test)&#123;print "数组的 第7个元素存在即可看到"&#125;&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果下标是6的元素存在，就会打印后面的一段话</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[0]="大鹏";test[1]="少松";test[2]="老董";test[3]="正伟";test[4]="法林";test[5]="";if(!(6 in test))&#123;print "数.的第7个元素不存在即可看到"&#125;&#125;'</span><br><span class="line">数组的第7个元素不存在即可看到</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以取反</span></span><br><span class="line"></span><br><span class="line">* 以字符串为下标</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test["a"]="大鹏";test["b"]="少松";test["cc"]="老董";test["fe"]="正伟";test["ews"]="法林";test["adg"]="";&#123;print test["ews"]&#125;&#125;'</span><br><span class="line">法林</span><br><span class="line"><span class="meta">#</span><span class="bash"> 还可以使用字符串作为下标，但字符串两侧一个要有双引号</span></span><br><span class="line"></span><br><span class="line">* 删除</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test["a"]="大鹏";test["b"]="少松";test["cc"]="老董";test["fe"]="正伟";test["ews"]="法林";test["adg"]="";print test["ews"];delete test;&#123;print test["ews"]&#125;&#125;'</span><br><span class="line">法林</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在delete前的<span class="built_in">print</span>可以打印出内容，经过delete删除数组后，就没法打印出同样数据元素的内容了</span></span><br><span class="line"></span><br><span class="line">* 打印所有元素</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[1]="大鹏";test[2]="少松";test[3]="老董";test[4]="正伟";test[5]="法林";test[6]="";for (i=1;i&lt;=6;i++)&#123;print i,test[i]&#125;&#125;'</span><br><span class="line">1 大鹏</span><br><span class="line">2 少松</span><br><span class="line">3 老董</span><br><span class="line">4 正伟</span><br><span class="line">5 法林</span><br><span class="line">6 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种<span class="keyword">for</span>循环只能输出以数字为下标的数组</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test["a"]="大鹏";test["b"]="少松";test["cc"]="老董";test["fe"]="正伟";test["ews"]="法林";test["adg"]="";for(i in test)&#123;print i,test[i]&#125;&#125;'</span><br><span class="line">cc 老董</span><br><span class="line">a 大鹏</span><br><span class="line">b 少松</span><br><span class="line">fe 正伟</span><br><span class="line">ews 法林</span><br><span class="line">adg </span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span>循环中的变量<span class="string">"i"</span>表示的是元素的下标，而并非表示元素的值，所以，如果想要输出元素的值，则需要使用<span class="string">"print 数组名[变量]"</span></span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;test[1]="大鹏";test[2]="少松";test[3]="老董";test[4]="正伟";test[5]="法林";test[6]="";for (i in test)&#123;print i,test[i]&#125;&#125;'</span><br><span class="line">4 正伟</span><br><span class="line">5 法林</span><br><span class="line">6 </span><br><span class="line">1 大鹏</span><br><span class="line">2 少松</span><br><span class="line">3 老董</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用这种<span class="keyword">for</span>循环，是不能按数字顺序打印元素的，因为数字被转换成了字符串。awk中的数组本质上就是关联数组</span></span><br><span class="line"></span><br><span class="line">* 统计次数</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;a=1;print a;a=a+1;print a&#125;'</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将变量a的值设置为1，进行加法计算，每次自加后，再次打印变量a的值，都会加1。a=a+1可以写为a++</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;a="test";print a;a=a+1;print a;a++;print a&#125;'</span><br><span class="line">test</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 字符串两侧一定要有双引号。字符串也可以进行运算，如果参与运算，字符串将被当做数字0进行运算</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;a="";print a;a=a+1;print a;a++;print a&#125;'</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 空字符串也可以当做0进行运算</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print test["i"];test["i"]++;print test["i"]&#125;'</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不存在的字符串也可以参与运算，因为不存在的字符串会被赋值为空字符串</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test5</span><br><span class="line">192.168.1.123	</span><br><span class="line">192.168.1.124	</span><br><span class="line">192.168.1.123	</span><br><span class="line">192.168.1.123</span><br><span class="line">192.168.1.124</span><br><span class="line">192.168.2.222</span><br><span class="line">172.16.100.3</span><br><span class="line">172.16.100.3</span><br><span class="line">172.16.100.3</span><br><span class="line">172.16.100.3</span><br><span class="line">172.16.100.3</span><br><span class="line">172.16.100.3</span><br><span class="line">192.168.1.15</span><br><span class="line">172.16.100.7</span><br><span class="line">[root@bogon ~]# awk '&#123;count[$1]++&#125;END&#123;for(i in count)&#123;print i,count[i]&#125;&#125;' test5</span><br><span class="line">172.16.100.3 6</span><br><span class="line">192.168.2.222 1</span><br><span class="line">172.16.100.7 1</span><br><span class="line">192.168.1.123 3</span><br><span class="line">192.168.1.124 2</span><br><span class="line">192.168.1.15 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用空模式与END模式，空模式中，我们随便创建了一个数组，并且将IP地址作为引用元素的下标，进行了引用，所以，当执行到第一行时，我们引用的是count[<span class="string">"192.168.1.123"</span>]，这个元素并不存在，所以，当第一行被空模式中的动作处理完毕后，count[<span class="string">"192.168.1.123"</span>]的值已经被赋值为1了。这时，空模式中的动作继续处理下一行，而下一行的IP地址为192.168.1.124，所以，count[<span class="string">"192.168.1.124"</span>]第一次参与运算的过程与上述过程一样。其他IP地址第一次参与运算的过程与上述过程也一样。直到再次遇到相同的IP地址时，使用同样一个IP地址作为下标的元素将会再次被自加，每次遇到相同的IP地址，对应元素的值都会加1。直到处理完所有行，开始执行END模式中的动作。而END模式中，我们打印出了count数组中的所有元素的下标，以及元素对应的值。此刻，count数组中的下标即为IP地址，元素的值即为对应IP地址出现的次数。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们对一个不存在的元素进行自加运算后，这个元素的值就变成了自加运算的次数</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test4</span><br><span class="line">Allen Phillips</span><br><span class="line">Green Lee</span><br><span class="line">William Aiden James Lee</span><br><span class="line">Angel Jack</span><br><span class="line">Tyler Kevin</span><br><span class="line">Lucas Thomas</span><br><span class="line">Kevin</span><br><span class="line">[root@bogon ~]# awk '&#123;for(i=1;i&lt;=NF;i++)&#123;count[$i]++&#125;&#125;END&#123;for(s in count)&#123;print s,count[s]&#125;&#125;' test4</span><br><span class="line">Tyler 1</span><br><span class="line">Angel 1</span><br><span class="line">James 1</span><br><span class="line">Lucas 1</span><br><span class="line">William 1</span><br><span class="line">Thomas 1</span><br><span class="line">Green 1</span><br><span class="line">Jack 1</span><br><span class="line">Phillips 1</span><br><span class="line">Kevin 2</span><br><span class="line">Lee 2</span><br><span class="line">Allen 1</span><br><span class="line">Aiden 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此命令与上面计算IP地址出现次数的命令同理，只是文件中比上面的文件多了几列，所以先将每列的内容赋值给count，NF就表示一共有几列，这会先将第一列的内容赋值给count，之后第二列第三列，但不会超过每行的总列数。理解了前半部分命令，END后面的动作就和上面的命令意思一样了。这里count[<span class="variable">$i</span>]赋值后就会变为count[Tyler]、count[Angel]等，然后给这个元素赋值，因为这是一个不存在的数组，并且空模式处理后会自加，所以赋值从1开始，也就是count[Tyler]=1、count[Angel]=1等，这个数字实际也就是最后要计算的次数了</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/17/awk动作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/17/awk动作/" itemprop="url">
                  awk动作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-17 14:13:32" itemprop="dateCreated datePublished" datetime="2018-10-17T14:13:32+08:00">2018-10-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-29 08:41:04" itemprop="dateModified" datetime="2018-10-29T08:41:04+08:00">2018-10-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="awk动作"><a href="#awk动作" class="headerlink" title="awk动作"></a>awk动作</h3><ul>
<li>输出语句</li>
<li>组合语句</li>
<li>条件判断控制语句</li>
<li>循环控制语句</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print $0&#125;' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line"><span class="meta">#</span><span class="bash"> &#123;&#125;与<span class="built_in">print</span> <span class="variable">$0</span>是两个动作。<span class="string">"print"</span>属于<span class="string">"输出语句"</span>类型的动作，<span class="string">"输出语句"</span>类型的动作的作用就是输出、打印信息。<span class="string">"&#123;  &#125;"</span>属于<span class="string">"组合语句"</span>类型的动作，组合语句<span class="string">"类型的动作的作用就是将多个代码组合成代码块。</span></span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk '&#123;print $1&#125;&#123;print $2&#125;' test</span><br><span class="line">abc</span><br><span class="line">345</span><br><span class="line">123</span><br><span class="line">klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用了两个大括号<span class="string">"&#123;  &#125;"</span>，它们属于<span class="string">"组合语句"</span>类型的动作，它们分别将两个<span class="built_in">print</span>括住，表示这两个<span class="built_in">print</span>动作分别作为两个独立的个体。先打印<span class="variable">$1</span>再打印<span class="variable">$2</span></span></span><br><span class="line">[root@bogon ~]# awk '&#123;print $1;print $2&#125;' test</span><br><span class="line">abc</span><br><span class="line">345</span><br><span class="line">123</span><br><span class="line">klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将上面的动作组合在一起。当我们把多个动作（多段代码）组合成一个代码块的时候，每段动作（每段代码）之间需要用分号<span class="string">";"</span>隔开</span></span><br></pre></td></tr></table></figure>
<h4 id="条件判断控制语句"><a href="#条件判断控制语句" class="headerlink" title="条件判断控制语句"></a>条件判断控制语句</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">    if(条件)</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;if(NR == 1)&#123;print $0&#125;&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要将动作写在&#123;&#125;中，控制语句也要有&#123;&#125;，所以这里有两个&#123;&#125;，<span class="keyword">if</span>语句中的大括号中，也可以执行多个动作。将行号是1的行打印出来。</span></span><br><span class="line">[root@bogon ~]# awk '&#123;if(NR == 1)&#123;print $1;print $2&#125;&#125;' test</span><br><span class="line">abc</span><br><span class="line">345</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果行号是1，就打印第一列和第二列</span></span><br><span class="line">[root@bogon ~]# awk '&#123;if(NR == 1)print $1&#125;' test</span><br><span class="line">abc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果<span class="keyword">if</span>后的动作只有一个，那么也可以不写&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">* 语法</span><br><span class="line">    "if...else..."的语法如下：</span><br><span class="line">    if(条件)</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    "if...else if...else"的语法如下：</span><br><span class="line">    if(条件1)</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    else if(条件2)</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">    语句1;</span><br><span class="line">    语句2;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -F":" '&#123;if($3 &lt; 1000)&#123;print $1,"系统用户"&#125;else&#123;print $1,"普通用户"&#125;&#125;' /etc/passwd</span><br><span class="line">root 系统用户</span><br><span class="line">bin 系统用户</span><br><span class="line">daemon 系统用户</span><br><span class="line">adm 系统用户</span><br><span class="line">lp 系统用户</span><br><span class="line">sync 系统用户</span><br><span class="line">shutdown 系统用户</span><br><span class="line">halt 系统用户</span><br><span class="line">mail 系统用户</span><br><span class="line">operator 系统用户</span><br><span class="line">games 系统用户</span><br><span class="line">ftp 系统用户</span><br><span class="line">nobody 系统用户</span><br><span class="line">systemd-network 系统用户</span><br><span class="line">dbus 系统用户</span><br><span class="line">polkitd 系统用户</span><br><span class="line">postfix 系统用户</span><br><span class="line">sshd 系统用户</span><br><span class="line">openvpn 系统用户</span><br><span class="line">ruopu 普通用户</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对/etc/passwd文件中的用户做判断，用户ID小于1000的为系统用户，否则就是普通用户</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test7</span><br><span class="line">姓名	年龄</span><br><span class="line">aaa	18</span><br><span class="line">bbb	66</span><br><span class="line">ccc	36</span><br><span class="line">[root@bogon ~]# awk 'NR !=1&#123;if($2&lt;=30)&#123;print $1,"年轻人"&#125;else if($2&gt;=30 &amp;&amp; $2&lt;=50)&#123;print $1,"中年人"&#125;else&#123;print $1,"老年人"&#125;&#125;' test7</span><br><span class="line">aaa 年轻人</span><br><span class="line">bbb 老年人</span><br><span class="line">ccc 中年人</span><br><span class="line"><span class="meta">#</span><span class="bash"> 首先忽略第一行，然后判断文件中第二列的年龄，最后打印出结果</span></span><br></pre></td></tr></table></figure>
<h5 id="三元运算"><a href="#三元运算" class="headerlink" title="三元运算"></a>三元运算</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">条件?结果1:结果2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果条件成立，则返回结果1，如果条件不成立，则返回结果2。</span></span><br><span class="line"></span><br><span class="line">表达式1 ? 表达式2 : 表达式3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果表达式1为真，则执行表达式2，如果表达式1为假，则执行表达式3</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -F: '&#123;if($3 &lt; 1000)&#123;usertype="系统用户"&#125;else&#123;usertype="普通用户"&#125;;print $1,usertype&#125;' /etc/passwd</span><br><span class="line">root 系统用户</span><br><span class="line">bin 系统用户</span><br><span class="line">daemon 系统用户</span><br><span class="line">adm 系统用户</span><br><span class="line">lp 系统用户</span><br><span class="line">sync 系统用户</span><br><span class="line">shutdown 系统用户</span><br><span class="line">halt 系统用户</span><br><span class="line">mail 系统用户</span><br><span class="line">operator 系统用户</span><br><span class="line">games 系统用户</span><br><span class="line">ftp 系统用户</span><br><span class="line">nobody 系统用户</span><br><span class="line">systemd-network 系统用户</span><br><span class="line">dbus 系统用户</span><br><span class="line">polkitd 系统用户</span><br><span class="line">postfix 系统用户</span><br><span class="line">sshd 系统用户</span><br><span class="line">openvpn 系统用户</span><br><span class="line">ruopu 普通用户</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"if...else"</span>结构，对usertype变量进行了赋值，如果用户的UID小于1000，则对usertype变量赋值为<span class="string">"系统用户"</span>,否则赋值usertype变量为<span class="string">"普通用户"</span>，最后打印出用户名所在的列与usertype变量的值。</span></span><br><span class="line">[root@bogon ~]# awk -F: '&#123;usertype=$3&lt;1000?"系统用户":"普通用户";print $1,usertype&#125;' /etc/passwd</span><br><span class="line">root 系统用户</span><br><span class="line">bin 系统用户</span><br><span class="line">daemon 系统用户</span><br><span class="line">adm 系统用户</span><br><span class="line">lp 系统用户</span><br><span class="line">sync 系统用户</span><br><span class="line">shutdown 系统用户</span><br><span class="line">halt 系统用户</span><br><span class="line">mail 系统用户</span><br><span class="line">operator 系统用户</span><br><span class="line">games 系统用户</span><br><span class="line">ftp 系统用户</span><br><span class="line">nobody 系统用户</span><br><span class="line">systemd-network 系统用户</span><br><span class="line">dbus 系统用户</span><br><span class="line">polkitd 系统用户</span><br><span class="line">postfix 系统用户</span><br><span class="line">sshd 系统用户</span><br><span class="line">openvpn 系统用户</span><br><span class="line">ruopu 普通用户</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"<span class="variable">$3</span>&lt;1000"</span>就是语法中的<span class="string">"条件"</span>，<span class="string">"系统用户"</span>就是语法中<span class="string">"?"</span>后面的<span class="string">"结果1"</span>，<span class="string">"普通用户"</span>就是语法中<span class="string">":"</span>后面的<span class="string">"结果2"</span> ，同时，在上例中我们使用usertype变量接收了三元运算后的返回值，所以，当条件成立时，usertype变量被赋值为<span class="string">"系统用户"</span>，当条件不成立时，usertype变量被赋值为<span class="string">"普通用户"</span>。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -F: '&#123;$3&lt;1000?a++:b++&#125;END&#123;print a,b&#125;' /etc/passwd</span><br><span class="line">19 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"<span class="variable">$3</span>&lt;1000"</span>即为表达式1，<span class="string">"a++"</span>即为表达式2，<span class="string">"b++"</span>即为表达式3。当每遇到一个UID小于1000的用户，我就对变量a加1，否则我就对变量b加1，从而算出了系统用户与普通用户的数量，最后再END模式中输出了变量a与变量b的值。</span></span><br></pre></td></tr></table></figure>
<h4 id="循环控制语句"><a href="#循环控制语句" class="headerlink" title="循环控制语句"></a>循环控制语句</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">    # for循环语法格式1</span><br><span class="line">    for(初始化; 布尔表达式; 更新) &#123;</span><br><span class="line">    //代码语句</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # for循环语法格式2</span><br><span class="line">    for(变量 in 数组) &#123;</span><br><span class="line">    //代码语句</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # while循环语法</span><br><span class="line">    while( 布尔表达式 ) &#123;</span><br><span class="line">    //代码语句</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # do...while循环语法</span><br><span class="line">    do &#123;</span><br><span class="line">    //代码语句</span><br><span class="line">    &#125;while(条件)</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;for(i=1;i&lt;=6;i++)&#123;print i&#125;&#125;'</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">[root@bogon ~]# awk -v i=1 'BEGIN&#123;while(i&lt;=5)&#123;print i;i++&#125;&#125;'</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;i=1;while(i&lt;=5)&#123;print i;i++&#125;&#125;'</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;i=1;do&#123;print "test";i++&#125;while(i&lt;1)&#125;'</span><br><span class="line">test</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;i=1;do&#123;print "test";i++&#125;while(i&lt;11)&#125;'</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line">test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不论如何，先执行一次<span class="keyword">do</span>后面的动作</span></span><br><span class="line"></span><br><span class="line">* 跳出循环语法</span><br><span class="line">	continue的作用：跳出"当前"循环</span><br><span class="line">	break的作用：跳出"整个"循环</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;for(i=0;i&lt;6;i++)&#123;if(i==3)&#123;continue&#125;;print i&#125;&#125;'</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 先设置i在0到6之前循环，再判断，如果i等于3就跳过此次循环。<span class="keyword">if</span>动作是<span class="keyword">for</span>循环的一部分。也就是<span class="function"><span class="title">for</span></span>()&#123;<span class="function"><span class="title">if</span></span>()&#123;&#125;&#125;</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;for(i=0;i&lt;6;i++)&#123;if(i==3)&#123;break&#125;;print i&#125;&#125;'</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">break</span>可以跳出整个循环</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">continue</span>与<span class="built_in">break</span>同样可以用于<span class="keyword">while</span>循环与do...while循环，此处就不再赘述了。</span></span><br><span class="line"></span><br><span class="line">* 退出</span><br><span class="line">	exit</span><br><span class="line">	next</span><br><span class="line">	</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print 1;exit;print 2;print 3&#125;'</span><br><span class="line">1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="built_in">exit</span>会跳出整个脚本，所以没有打印2和3</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "start";exit&#125;&#123;print $0&#125;END&#123;print "over"&#125;' test</span><br><span class="line">start</span><br><span class="line">over</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exit</span>并不会跳出awk命令，遇到<span class="built_in">exit</span>后，之后的命令都不执行，它会直接执行END模式的动作。如果没有END模式，将直接退出整个awk命令。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test8</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">[root@bogon ~]# awk '&#123;if(NR==2)&#123;next&#125;;print $0&#125;' test8</span><br><span class="line">1</span><br><span class="line">3</span><br><span class="line"><span class="meta">#</span><span class="bash"> next命令可以促使awk不对当前行执行对应的动作，而是直接处理下一行。next与<span class="built_in">continue</span>有些类似，只是，<span class="built_in">continue</span>是针对<span class="string">"循环"</span>而言的，<span class="built_in">continue</span>的作用是结束<span class="string">"本次循环"</span>，而next是针对<span class="string">"逐行处理"</span>而言的，next的作用是结束<span class="string">"对当前行的处理"</span>，从而直接处理<span class="string">"下一行"</span></span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/17/awk模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/17/awk模式/" itemprop="url">
                  awk模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-17 11:28:32" itemprop="dateCreated datePublished" datetime="2018-10-17T11:28:32+08:00">2018-10-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-30 12:07:22" itemprop="dateModified" datetime="2018-11-30T12:07:22+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="awk模式"><a href="#awk模式" class="headerlink" title="awk模式"></a>awk模式</h3><ul>
<li>BEGIN/END模式</li>
<li>关系表达式模式</li>
<li>空模式</li>
<li>正则模式</li>
<li>行范围模式</li>
</ul>
<blockquote>
<p>模式也可以理解为条件。不指定任何”条件”，awk会一行一行的处理文本中的每一行。指定了”条件”，只有满足”条件”的行才会被处理，不满足”条件”的行就不会被处理。</p>
</blockquote>
<h4 id="关系表达式模式"><a href="#关系表达式模式" class="headerlink" title="关系表达式模式"></a>关系表达式模式</h4><table>
<thead>
<tr>
<th>关系运算符</th>
<th>含义</th>
<th>用法示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt;</td>
<td>小于</td>
<td>x &lt; y</td>
</tr>
<tr>
<td>&lt;=</td>
<td>小于等于</td>
<td>x &lt;= y</td>
</tr>
<tr>
<td>==</td>
<td>等于</td>
<td>x == y</td>
</tr>
<tr>
<td>!=</td>
<td>不等于</td>
<td>x != y</td>
</tr>
<tr>
<td>&gt;=</td>
<td>大于等于</td>
<td>x &gt;= y</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于</td>
<td>x &gt; y</td>
</tr>
<tr>
<td>~</td>
<td>与对应的正则匹配则为真</td>
<td>x ~ /正则/</td>
</tr>
<tr>
<td>!~</td>
<td>与对应的正则不匹配则为真</td>
<td>x !~ /正则/</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# cat test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk 'NF==5 &#123;print $0&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印正好有五列的行。这里的条件就是这一行一共有五列</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'NF&gt;2&#123;print $0&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk 'NF&lt;=4 &#123;print $0&#125;' test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 文件中没有小于等于四列的行</span></span><br><span class="line">[root@bogon ~]# awk '$1==123 &#123;print $0&#125;' test</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要用两个等号</span></span><br></pre></td></tr></table></figure>
<h4 id="空模式"><a href="#空模式" class="headerlink" title="空模式"></a>空模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print $0&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 没有使用模式实际是使用的空模式，<span class="string">"空模式"</span>会匹配文本中的每一行，所以，每一行都满足<span class="string">"条件"</span></span></span><br></pre></td></tr></table></figure>
<h5 id="打印奇偶行"><a href="#打印奇偶行" class="headerlink" title="打印奇偶行"></a>打印奇偶行</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# cat test9</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">[root@bogon ~]# awk 'i=!i' test9</span><br><span class="line">1</span><br><span class="line">3</span><br><span class="line">5</span><br><span class="line">7</span><br><span class="line">9</span><br><span class="line">11</span><br><span class="line">[root@bogon ~]# awk '!(i=!i)' test9</span><br><span class="line">2</span><br><span class="line">4</span><br><span class="line">6</span><br><span class="line">8</span><br><span class="line">10</span><br><span class="line">12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当awk开始处理第一行时，变量 i 被初始化，变量 i 在被初始化时，值为<span class="string">"空"</span>，而awk中，数字0或者<span class="string">"空字符串"</span>表示假，所以可以认为模式为假，但是 i 直接取反了，对假取反后的值为真，将取反后的值又赋值给了变量i，此刻，变量i的值为真，所以当awk处理第一行文本时，变量i的值被赋值为真，模式成立则需要执行对应的动作，而上例中又省略了动作，所以默认动作为<span class="string">"&#123;print <span class="variable">$0</span>&#125;"</span>，所以，第一行被整行打印了。当第一行文本处理完毕后，awk开始处理第二行文本，此时，i 为真，但是取反后，i 为假，所以第二行没有被输出，依次类推，最终只打印了奇数行。打印偶数行同理，只是从第一次就让i为空字符串为假</span></span><br><span class="line">* 知识点</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在awk中，如果省略了模式对应的动作，当前行满足模式时，默认动作为打印整行，即&#123;<span class="built_in">print</span> <span class="variable">$0</span>&#125;。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在awk中，0或者空字符串表示<span class="string">"假"</span>，非0值或者非空字符串表示<span class="string">"真"</span></span></span><br><span class="line"></span><br><span class="line">* 解析</span><br><span class="line">[root@bogon ~]# awk '/1/&#123;print $0&#125;' test9</span><br><span class="line">1</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果当前行中包含字符<span class="string">"1"</span>，则执行对应的动作，而对应的动作就是打印整行。</span></span><br><span class="line">root@ccjd:~# awk '/regi/&amp;&amp;/mi/&amp;&amp;/192/&#123;print $0&#125;' daemon.json | head</span><br><span class="line">        "registry-mirrors":["http://192.168.0.198:80"],</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以通过&amp;&amp;符号指定多个条件，需要同时满足才可以。</span></span><br><span class="line">[root@bogon ~]# awk '$1&gt;10&#123;print $0&#125;' test9</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果test9文本中文本行的第一列的值如果大于10，则打印整行。</span></span><br><span class="line">[root@bogon ~]# awk '/1/' test9</span><br><span class="line">1</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">[root@bogon ~]# awk '$1&gt;10' test9</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当使用了模式时，如果省略了模式对应的动作，默认动作为<span class="string">"&#123;print <span class="variable">$0</span>&#125;"</span>，<span class="string">"空模式"</span>与<span class="string">"BEGIN/END模式"</span>除外。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '&#123;print $0&#125;' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '1&#123;print $0&#125;' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '2&#123;print $0&#125;' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '2' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '0&#123;print $0&#125;' test2</span><br><span class="line">[root@bogon ~]# awk '0' test2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一条awk命令使用了<span class="string">"空模式"</span>，也就是说，每一行都满足模式，每一行经过<span class="string">"空模式"</span>匹配以后结果都是<span class="string">"真"</span>，所以每一行都会执行对应的动作。第二条awk命令原来<span class="string">"模式的位置"</span>被替换为了数字<span class="string">"1"</span>，我们可以把数字<span class="string">"1"</span>理解成一种模式匹配后的结果，而1是非零值，刚才说过，在awk中非零值表示真，所以，<span class="string">"1"</span>表示<span class="string">"真"</span>，  换句话说就是模式的匹配结果为真，模式成立则会执行对应的动作，也就是打印整行。第三条awk命令与第二条awk命令同理，动作前的数字可以换为任何非0数字或非空字符串。第四条awk命令数字<span class="string">"2"</span>为非零值，表示模式为真，而之前说过，当使用模式时，可以省略动作，当使用模式并省略动作时，默认动作为打印整行，所以，第四条awk命令表示打印所有行，因为每一行的模式都为真。第五条awk命令与第六条awk命令因为数字<span class="string">"0"</span>与空字符串表示假，当模式为假时，不会执行对应的动作，而当存在模式并省略动作时，默认动作为打印整行，但是由于模式为假，所以对应的动作并未执行。</span></span><br><span class="line">[root@bogon ~]# awk '!0' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '!5' test2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 还能对真与假进行取反，非真即为假，非假即为真</span></span><br><span class="line">[root@bogon ~]# awk 'i=1' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk 'i=a' test2</span><br><span class="line">[root@bogon ~]# awk 'i="a"' test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk 'i=0' test2</span><br><span class="line">[root@bogon ~]# awk 'i=""' test2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用了awk的变量，将变量 i赋值为1，当 i=1 以后，i为非零值，表示为真，我们可以认为这是一种模式匹配后的结果，当模式为真时，同时省略了对应动作时，默认动作为打印整行，所以上例会输出test2中的所有行。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;i=!i;print i&#125;' test2</span><br><span class="line">1</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印出处理每一行时，i 对应的值。</span></span><br></pre></td></tr></table></figure>
<h4 id="正则模式"><a href="#正则模式" class="headerlink" title="正则模式"></a>正则模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 把<span class="string">"正则表达式"</span>当做<span class="string">"条件"</span>，能与正则匹配的行，就算满足条件，满足条件的行才会执行对应的动作，不能被正则匹配到的行，则不会执行对应的动作。</span></span><br><span class="line"></span><br><span class="line">语法</span><br><span class="line">awk '/正则表达式/&#123;动作&#125;' 文件</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# grep "^ruo" /etc/passwd</span><br><span class="line">ruopu:x:1000:1000::/home/ruopu:/bin/bash</span><br><span class="line">[root@bogon ~]# awk  '/^ruo/&#123;print $0&#125;' /etc/passwd</span><br><span class="line">ruopu:x:1000:1000::/home/ruopu:/bin/bash</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -F":" 'BEGIN&#123;printf "%-10s%-10s\n","用户名","用户ID"&#125; /^ruo/&#123;printf "%-10s\t%-10s\n",$1,$3&#125;' /etc/passwd</span><br><span class="line">用户名       用户ID      </span><br><span class="line">ruopu     	1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从/etc/passwd文件中找出符合条件的行（用户名以ruo开头的用户）；找出符合条件的文本行以后，以<span class="string">":"</span>作为分隔符，将文本行分段；取出我们需要的字段，格式化输出；结合BEGIN模式，输出一个格式化以后的文本，提高可读性</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# grep "/bin/bash" /etc/passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">ruopu:x:1000:1000::/home/ruopu:/bin/bash</span><br><span class="line">[root@bogon ~]# awk '/\/bin\/bash/&#123;print $0&#125;' /etc/passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">ruopu:x:1000:1000::/home/ruopu:/bin/bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用斜线时要用转义符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当在awk命令中使用正则模式时，使用到的正则用法属于<span class="string">"扩展正则表达式"</span>；</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -V</span><br><span class="line">GNU Awk 4.0.2</span><br><span class="line"><span class="meta">#</span><span class="bash"> CentOS7使用awk版本</span></span><br><span class="line">[root@bogon ~]# cat test2</span><br><span class="line">hey</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">heeeey</span><br><span class="line">[root@bogon ~]# awk '/he&#123;2,3&#125;y/&#123;print $0&#125;' test2</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line"><span class="meta">#</span><span class="bash"> CentOS7中可以直接使用&#123;x,y&#125;的形式匹配</span></span><br><span class="line">[root@bogon ~]# awk --posix '/he&#123;2,3&#125;y/&#123;print $0&#125;' test2</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line">[root@bogon ~]# awk --re-interval '/he&#123;2,3&#125;y/&#123;print $0&#125;' test2</span><br><span class="line">heey</span><br><span class="line">heeey</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果无法直接使用&#123;x,y&#125;的形式，就要使用--posix或者--re-interval选项</span></span><br></pre></td></tr></table></figure>
<h4 id="行范围模式"><a href="#行范围模式" class="headerlink" title="行范围模式"></a>行范围模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">awk '/正则1/,/正则2/&#123;动作&#125;' 文件</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从被正则1匹配到的行开始，到被正则2匹配到的行结束，之间的所有行都会执行对应的动作。在行范围模式中，不管是正则1，还是正则2，都以第一次匹配到的行为准</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat -n test4</span><br><span class="line">     1	Allen Phillips</span><br><span class="line">     2	Green Lee</span><br><span class="line">     3	William Aiden James Lee</span><br><span class="line">     4	Angel Jack</span><br><span class="line">     5	Tyler Kevin</span><br><span class="line">     6	Lucas Thomas</span><br><span class="line">     7	Kevin</span><br><span class="line">[root@bogon ~]# awk '/Lee/,/Kevin/&#123;print $0&#125;' test4</span><br><span class="line">Green Lee</span><br><span class="line">William Aiden James Lee</span><br><span class="line">Angel Jack</span><br><span class="line">Tyler Kevin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 找出从Lee第一次出现的行，到Kevin第一次出现的行之间的所有行</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'NR&gt;=3 &amp;&amp; NR&lt;=6 &#123;print $0&#125;' test4</span><br><span class="line">William Aiden James Lee</span><br><span class="line">Angel Jack</span><br><span class="line">Tyler Kevin</span><br><span class="line">Lucas Thomas</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样也可以打印出需要范围的行</span></span><br><span class="line"></span><br><span class="line">* 关系运算符~与!~的使用</span><br><span class="line">[root@bogon ~]# cat test3</span><br><span class="line">主机名	网卡1的IP	网卡2的IP</span><br><span class="line">主机A	192.168.1.123	192.168.1.124</span><br><span class="line">主机B	192.168.2.222	172.16.100.3</span><br><span class="line">主机C	10.1.0.1	172.16.100.3</span><br><span class="line">主机D	10.1.2.1	192.168.1.15</span><br><span class="line">主机E	10.1.5.1	172.16.100.5</span><br><span class="line">主机F	192.168.1.234	172.16.100.6</span><br><span class="line">主机G	10.1.7.1	172.16.100.7</span><br><span class="line">[root@bogon ~]# awk '$2~/192\.168\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;/&#123;print $1,$2&#125;' test3</span><br><span class="line">主机A 192.168.1.123</span><br><span class="line">主机B 192.168.2.222</span><br><span class="line">主机F 192.168.1.234</span><br><span class="line"><span class="meta">#</span><span class="bash"> 找出网卡1的IP地址在192.168.0.0/16网段内的主机。先执行第二列匹配相应地址，最后再打印出来。如果正则模式不能使用，要加入--posix或者--re-interval选项</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/16/awk基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/16/awk基础/" itemprop="url">
                  awk基础
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-16 13:54:49" itemprop="dateCreated datePublished" datetime="2018-10-16T13:54:49+08:00">2018-10-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-29 08:31:56" itemprop="dateModified" datetime="2018-10-29T08:31:56+08:00">2018-10-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 我们在linux上所使用的awk其实是gawk，也就是GNU awk，简称为gawk。awk其实是一门编程语言，它支持条件判断、数组、循环等功能。grep：更适合单纯的查找或匹配文本、sed：更适合编辑匹配到的文本、awk：更适合格式化文本，对文本进行较复杂格式处理</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# ll /usr/bin/awk </span><br><span class="line">lrwxrwxrwx. 1 root root 4 Oct  8 14:20 /usr/bin/awk -&gt; gawk</span><br><span class="line"></span><br><span class="line">* 语法</span><br><span class="line">awk [options] 'program' file1 , file2 , ...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对于上述语法中的program来说，又可以细分成pattern（模式）和action（动作），也就是说，awk的基本语法如下</span></span><br><span class="line">awk [options] 'Pattern&#123;Action&#125;' file</span><br><span class="line">-F：用于指定输入分隔符。</span><br><span class="line">-v：用于设置变量的值。</span><br><span class="line"></span><br><span class="line">* 常用内置变量：</span><br><span class="line">    FS：输入字段分隔符， 默认为空白字符</span><br><span class="line">    OFS：输出字段分隔符， 默认为空白字符</span><br><span class="line">    RS：输入记录分隔符(输入换行符)， 指定输入时的换行符</span><br><span class="line">    ORS：输出记录分隔符（输出换行符），输出时用指定符号代替换行符</span><br><span class="line">    NF：number of Field，当前行的字段的个数(即当前行被分割成了几列)，字段数量</span><br><span class="line">    NR：行号，当前处理的文本行的行号。</span><br><span class="line">    FNR：各文件分别计数的行号</span><br><span class="line">    FILENAME：当前文件名</span><br><span class="line">    ARGC：命令行参数的个数</span><br><span class="line">    ARGV：数组，保存的是命令行所给定的各参数</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="variable">$0</span> 表示显示整行 ，<span class="variable">$NF</span>表示当前行分割后的最后一列（<span class="variable">$0</span>和<span class="variable">$NF</span>均为内置变量）。<span class="variable">$NF</span> 和 NF 要表达的意思是不一样的，对于awk来说，<span class="variable">$NF</span>表示最后一个字段，NF表示当前行被分隔符切开以后，一共有几个字段。假如一行文本被空格分成了7段，那么NF的值就是7，<span class="variable">$NF</span>的值就是<span class="variable">$7</span>,  而<span class="variable">$7</span>表示当前行的第7个字段，也就是最后一列，那么每行的倒数第二列可以写为$(NF-1)。</span></span><br></pre></td></tr></table></figure>
<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">* 打印全部</span><br><span class="line">[root@bogon ~]# echo ddd &gt; testd</span><br><span class="line">[root@bogon ~]# awk '&#123;print&#125;' testd </span><br><span class="line">ddd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将testd文件中的内容打印了出来</span></span><br><span class="line">[root@bogon ~]# awk '&#123;print $0&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面两种写法都可以打印整行</span></span><br><span class="line"></span><br><span class="line">* 打印某列</span><br><span class="line">[root@bogon ~]# df -h | awk '&#123;print $2&#125;'</span><br><span class="line">Size</span><br><span class="line">30G</span><br><span class="line">234M</span><br><span class="line">245M</span><br><span class="line">245M</span><br><span class="line">245M</span><br><span class="line">1014M</span><br><span class="line">976M</span><br><span class="line">49M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出df的信息的第2列，<span class="variable">$2</span>表示将当前行按照分隔符分割后的第2列，不指定分隔符时，默认使用空格作为分隔符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> awk是逐行处理的，处理完当前行，再处理下一行。awk默认以<span class="string">"换行符"</span>为标记，识别每一行，每次遇到<span class="string">"回车换行"</span>，就认为是当前行的结束，新的一行的开始，awk会按照用户指定的分割符去分割当前行</span></span><br><span class="line"></span><br><span class="line">* 打印多个列</span><br><span class="line">[root@bogon ~]# cat test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk '&#123;print $2,$5,$6&#125;' test</span><br><span class="line">345 lkj;l </span><br><span class="line">klj adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一行并没有第六列，所以并没有输出任何文本，而第二行有第六列，所以输出了。</span></span><br><span class="line"></span><br><span class="line">* 添加自己的字段</span><br><span class="line">[root@bogon ~]# awk '&#123;print $1,$2,"string"&#125;' test</span><br><span class="line">abc 345 string</span><br><span class="line">123 klj string</span><br><span class="line">[root@bogon ~]# awk  '&#123;print $1,$2,423&#125;' test</span><br><span class="line">abc 345 423</span><br><span class="line">123 klj 423</span><br><span class="line">[root@bogon ~]# awk '&#123;print "diyilie:" $1,"diyilie:" $2&#125;' test</span><br><span class="line">diyilie:abc diyilie:345</span><br><span class="line">diyilie:123 diyilie:klj</span><br><span class="line">[root@bogon ~]# awk '&#123;print "diyilie:"$1,"diyilie:"$2&#125;' test</span><br><span class="line">diyilie:abc diyilie:345</span><br><span class="line">diyilie:123 diyilie:klj</span><br><span class="line">[root@bogon ~]# awk '&#123;print "diyilie:"$1,"534","diyilie:"$2&#125;' test</span><br><span class="line">diyilie:abc 534 diyilie:345</span><br><span class="line">diyilie:123 534 diyilie:klj</span><br><span class="line">[root@bogon ~]# cat test | awk '&#123;print $1&#125;'</span><br><span class="line">abc</span><br><span class="line">123</span><br><span class="line">[root@bogon ~]# cat test | awk '&#123;print "$1"&#125;'</span><br><span class="line"><span class="meta">$</span><span class="bash">1</span></span><br><span class="line"><span class="meta">$</span><span class="bash">1</span></span><br><span class="line">[root@bogon ~]# cat test | awk '&#123;print "firstF:"$1&#125;'</span><br><span class="line">firstF:abc</span><br><span class="line">firstF:123</span><br><span class="line">[root@bogon ~]# cat test | awk '&#123;print "firstF:$1"&#125;'</span><br><span class="line">firstF:$1</span><br><span class="line">firstF:$1</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$1</span>这种内置变量的外侧不能加入双引号，否则<span class="variable">$1</span>会被当做文本输出</span></span><br></pre></td></tr></table></figure>
<h4 id="特殊模式"><a href="#特殊模式" class="headerlink" title="特殊模式"></a>特殊模式</h4><h5 id="BEGIN"><a href="#BEGIN" class="headerlink" title="BEGIN"></a>BEGIN</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> BEGIN 模式指定了处理文本之前需要执行的操作</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa","bbb"&#125;' test</span><br><span class="line">aaa bbb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在开始处理<span class="built_in">test</span>文件中的文本之前，先执行打印动作，输出的内容为<span class="string">"aaa"</span>,<span class="string">"bbb"</span>.</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa","bbb"&#125;'</span><br><span class="line">aaa bbb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为不打算处理文本文件，所以也可以不指定文本文件，只进行一个处理前的打印动作。</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa","bbb"&#125;&#123;print $1,$2&#125;' test</span><br><span class="line">aaa bbb</span><br><span class="line">abc 345</span><br><span class="line">123 klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以先进行处理前打印，再处理文本文件，但两次打印要分开写</span></span><br></pre></td></tr></table></figure>
<h5 id="END"><a href="#END" class="headerlink" title="END"></a>END</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> END 模式指定了处理完所有行之后所需要执行的操作</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa","bbb"&#125;&#123;print $1,$2&#125;END&#123;print "ccc","ddd"&#125;' test</span><br><span class="line">aaa bbb</span><br><span class="line">abc 345</span><br><span class="line">123 klj</span><br><span class="line">ccc ddd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 结合BEGIN模式和END模式一起使用</span></span><br></pre></td></tr></table></figure>
<h4 id="分隔符"><a href="#分隔符" class="headerlink" title="分隔符"></a>分隔符</h4><ul>
<li><p>awk的分隔符还分为两种，”输入分隔符” 和 “输出分隔符”</p>
</li>
<li><p>输入分隔符，英文原文为field separator，此处简称为FS。awk默认以空白字符为分隔符对每一行进行分割。</p>
</li>
<li><p>输出分割符，英文原文为output field separator，此处简称为OFS。awk默认的输出分割符也是空格。</p>
</li>
</ul>
<h5 id="输入分隔符"><a href="#输入分隔符" class="headerlink" title="输入分隔符"></a>输入分隔符</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# cat test1</span><br><span class="line"><span class="meta">aaa#</span><span class="bash">dfa<span class="comment">#123#jkl;</span></span></span><br><span class="line"><span class="meta">aiew#</span><span class="bash">adkf<span class="comment">#alkdjf#asdjfj</span></span></span><br><span class="line">[root@bogon ~]# awk -F# '&#123;print $1,$2&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l </span><br><span class="line">123 klj adf daff adeills adsfei </span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定默认分隔符为<span class="comment">#号，对文本进行分隔</span></span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -v FS='#' '&#123;print $1,$2&#125;' test</span><br><span class="line">abc 345 ssd asdf lkj;l </span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 还能够通过设置内部变量的方式，指定awk的输入分隔符，awk内置变量FS可以用于指定输入分隔符，但是在使用变量时，需要使用-v选项，用于指定对应的变量</span></span><br></pre></td></tr></table></figure>
<h5 id="输出分隔符"><a href="#输出分隔符" class="headerlink" title="输出分隔符"></a>输出分隔符</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当我们要对处理完的文本进行输出的时候，以什么文本或符号作为分隔符。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;print $1,$2&#125;' test</span><br><span class="line">abc 345</span><br><span class="line">123 klj</span><br><span class="line">[root@bogon ~]# awk -v OFS="+++" '&#123;print $1,$2&#125;' test</span><br><span class="line">abc+++345</span><br><span class="line">123+++klj</span><br><span class="line">[root@bogon ~]# awk -v OFS='+++' '&#123;print $1,$2&#125;' test</span><br><span class="line">abc+++345</span><br><span class="line">123+++klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加号两侧可以是单引号或双引号</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -v FS='#' -v OFS='---' '&#123;print $1,$2&#125;' test1</span><br><span class="line">aaa---dfa</span><br><span class="line">aiew---adkf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同时指定输入分隔符和输出分割符</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;print $1,$2&#125;' test</span><br><span class="line">abc 345</span><br><span class="line">123 klj</span><br><span class="line">[root@bogon ~]# awk '&#123;print $1 $2&#125;' test</span><br><span class="line">abc345</span><br><span class="line">123klj</span><br><span class="line">[root@bogon ~]# awk '&#123;print $1$2&#125;' test</span><br><span class="line">abc345</span><br><span class="line">123klj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出不使用分隔符，打印在一起</span></span><br></pre></td></tr></table></figure>
<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><ul>
<li>“变量”又分为”内置变量” 和 “自定义变量” , “输入分隔符FS”和”输出分隔符OFS”都属于内置变量。内置变量就是awk预定义好的、内置在awk内部的变量，而自定义变量就是用户定义的变量。</li>
</ul>
<h5 id="内置变量NR"><a href="#内置变量NR" class="headerlink" title="内置变量NR"></a>内置变量NR</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在awk中，只有在引用<span class="variable">$0</span>、<span class="variable">$1</span>等内置变量的值的时候才会用到<span class="string">"$"</span>,引用其他变量时，不管是内置变量，还是自定义变量，都不使用<span class="string">"$"</span>,而是直接使用变量名。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# cat test</span><br><span class="line">abc 345 ssd asdf lkj;l</span><br><span class="line">123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk '&#123;print NR,NF&#125;' test</span><br><span class="line">1 5</span><br><span class="line">2 6</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印每一行的行号以及每一行对应的列的数量。内置变量NR表示每一行的行号，内置变量NF表示每一行中一共有几列</span></span><br><span class="line">[root@bogon ~]# awk '&#123;print NR,$0&#125;' test</span><br><span class="line">1 abc 345 ssd asdf lkj;l</span><br><span class="line">2 123 klj adf daff adeills adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 先打印出行号，再打印出整行的内容</span></span><br></pre></td></tr></table></figure>
<h5 id="内置变量FNR"><a href="#内置变量FNR" class="headerlink" title="内置变量FNR"></a>内置变量FNR</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print NR,$0&#125;' test test1</span><br><span class="line">1 abc 345 ssd asdf lkj;l</span><br><span class="line">2 123 klj adf daff adeills adsfei</span><br><span class="line">3 aaa#dfa#123#jkl;</span><br><span class="line">4 aiew#adkf#alkdjf#asdjfj</span><br><span class="line"><span class="meta">#</span><span class="bash"> awk处理多个文件的时候，如果使用NR显示行号，那么，多个文件的所有行会按照顺序进行排序。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;print FNR,$0&#125;' test test1</span><br><span class="line">1 abc 345 ssd asdf lkj;l</span><br><span class="line">2 123 klj adf daff adeills adsfei</span><br><span class="line">1 aaa#dfa#123#jkl;</span><br><span class="line">2 aiew#adkf#alkdjf#asdjfj</span><br><span class="line"><span class="meta">#</span><span class="bash"> FNR变量可以在处理多个文件时分开显示行号。</span></span><br></pre></td></tr></table></figure>
<h5 id="内置变量RS"><a href="#内置变量RS" class="headerlink" title="内置变量RS"></a>内置变量RS</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print NR,$0&#125;' test</span><br><span class="line">1 abc 345 ssd asdf lkj;l</span><br><span class="line">2 123 klj adf daff adeills adsfei</span><br><span class="line">[root@bogon ~]# awk -v RS=" " '&#123;print NR,$0&#125;' test</span><br><span class="line">1 abc</span><br><span class="line">2 345</span><br><span class="line">3 ssd</span><br><span class="line">4 asdf</span><br><span class="line">5 lkj;l</span><br><span class="line">123</span><br><span class="line">6 klj</span><br><span class="line">7 adf</span><br><span class="line">8 daff</span><br><span class="line">9 adeills</span><br><span class="line">10 adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定空格为换行符并打印，第5行是因为<span class="built_in">test</span>文本中的第一行行尾和第二行开头之间没有空格，只有回车，所以打印成这个样子。</span></span><br></pre></td></tr></table></figure>
<h5 id="内置变量ORS"><a href="#内置变量ORS" class="headerlink" title="内置变量ORS"></a>内置变量ORS</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk  -v ORS='+++' '&#123;print NR,$0&#125;' test</span><br><span class="line">1 abc 345 ssd asdf lkj;l+++2 123 klj adf daff adeills adsfei+++[root@bogon ~]#</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定输出换行符，awk认为有+++号就是换行了，所以才打印成这个样子</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk -v RS=" " -v ORS='+++' '&#123;print NR,$0&#125;' test</span><br><span class="line">1 abc+++2 345+++3 ssd+++4 asdf+++5 lkj;l</span><br><span class="line">123+++6 klj+++7 adf+++8 daff+++9 adeills+++10 adsfei</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一起使用输入输出换行符。</span></span><br></pre></td></tr></table></figure>
<h5 id="内置变量FILENAME"><a href="#内置变量FILENAME" class="headerlink" title="内置变量FILENAME"></a>内置变量FILENAME</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print FILENAME,FNR,$0&#125;' test test1</span><br><span class="line">test 1 abc 345 ssd asdf lkj;l</span><br><span class="line">test 2 123 klj adf daff adeills adsfei</span><br><span class="line">test1 1 aaa#dfa#123#jkl;</span><br><span class="line">test1 2 aiew#adkf#alkdjf#asdjfj</span><br><span class="line"><span class="meta">#</span><span class="bash"> FILENAME是为了显示文件名的。上面每行都打印了文件名，行号，文件内容</span></span><br></pre></td></tr></table></figure>
<h5 id="内置变量ARGC与ARGV"><a href="#内置变量ARGC与ARGV" class="headerlink" title="内置变量ARGC与ARGV"></a>内置变量ARGC与ARGV</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa",ARGV[1]&#125;' test test1</span><br><span class="line">aaa test</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa",ARGV[1],ARGV[2]&#125;' test test1</span><br><span class="line">aaa test test1</span><br><span class="line"><span class="meta">#</span><span class="bash"> ARGV内置变量表示的是一个数组.数组的索引都是从0开始的，所以，ARGV[1]表示引用ARGV数组中的第二个元素的值。命令后的文件名组成了这个数组，使用ARGV调用数组中的元素值，ARGV[1]对应的值为<span class="built_in">test</span>，ARGV[2]对应的值为test1，ARGV[0]对应的值为awk</span></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa",ARGV[0]&#125;' test</span><br><span class="line">aaa awk</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;print "aaa",ARGV[0],ARGV[1],ARGV[2],ARGC&#125;' test test1</span><br><span class="line">aaa awk test test1 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在上面的例子中，应该有三个参数，awk、<span class="built_in">test</span>、test1，这三个参数作为数组的元素存放于ARGV中，而ARGC则表示参数的数量，也可以理解为ARGV数组的长度。</span></span><br></pre></td></tr></table></figure>
<h5 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 自定义变量方法</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法一：-v varname=value  变量名区分字符大小写。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法二：在program中直接定义。</span></span><br><span class="line"></span><br><span class="line">* 方法一</span><br><span class="line">[root@bogon ~]# awk -v myVar="testVar" 'BEGIN&#123;print myVar&#125;'</span><br><span class="line">testVar</span><br><span class="line"></span><br><span class="line">* 方法二</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;myvar="ttt";print myvar&#125;'</span><br><span class="line">ttt</span><br><span class="line"><span class="meta">#</span><span class="bash"> ttt两侧一定要使用双引号，不能使用单引号。分号两侧有没有空格都可以。</span></span><br><span class="line"></span><br><span class="line">* 一次定义多个变量</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;myvar1="111";myvar2="222";print myvar1,myvar2&#125;'</span><br><span class="line">111 222</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# abc=123</span><br><span class="line">[root@bogon ~]# awk -v myvar=$abc 'BEGIN&#123;print myvar&#125;'</span><br><span class="line">123</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要在awk中引用shell中的变量的时候，可以通过方法一间接的引用。</span></span><br></pre></td></tr></table></figure>
<h4 id="printf命令"><a href="#printf命令" class="headerlink" title="printf命令"></a>printf命令</h4><ul>
<li>printf命令的作用是按照我们指定的格式输出文本。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 语法</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">printf</span> <span class="string">"指定的格式"</span> <span class="string">"文本1"</span> <span class="string">"文本2"</span> <span class="string">"文本3"</span> ......</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# echo abc</span><br><span class="line">abc</span><br><span class="line">[root@bogon ~]# printf abc</span><br><span class="line">abc[root@bogon ~]#</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span>命令会对输出的文本进行换行，而<span class="built_in">printf</span>命令则不会对输出的文本进行换行</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# echo -e "abc \ndef \njkl \ndfj"</span><br><span class="line">abc </span><br><span class="line">def </span><br><span class="line">jkl </span><br><span class="line">dfj</span><br><span class="line">[root@bogon ~]# printf "abc \ndef \njkl \ndfj \n"</span><br><span class="line">abc </span><br><span class="line">def </span><br><span class="line">jkl </span><br><span class="line">dfj</span><br><span class="line">[root@bogon ~]# printf "%s\n" abc def jkl dfj</span><br><span class="line">abc</span><br><span class="line">def</span><br><span class="line">jkl</span><br><span class="line">dfj</span><br><span class="line"><span class="meta">#</span><span class="bash"> 前两种方法要使用转义符\n进行换行。第三条命令中的每一个<span class="string">"文本"</span>都会被当做参数项传入<span class="built_in">printf</span>命令，而每个被传入的参数都会按照指定的<span class="string">"格式"</span>被<span class="string">"格式化"</span>。<span class="string">"%s\n"</span>就是格式，而后面的每一段字符串，都被当做参数传入到了<span class="built_in">printf</span>命令中，并按照我们指定的格式进行了格式化。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %s是<span class="string">"格式替换符"</span>。使用<span class="string">"%s"</span>代替传入的每一个参数，上面命令中的参数就是abc def jkl dfj，如果我们指定的格式为<span class="string">"%s\n"</span>，当abc被当做参数传入<span class="built_in">printf</span>命令时，<span class="built_in">printf</span>就会把<span class="string">"%s\n"</span>中的%s替换成abc，于是，abc就变成了我们指定的格式<span class="string">"abc\n"</span>，最终<span class="built_in">printf</span>输出的就是格式化后的<span class="string">"abc\n"</span>，以此类推，每一段文本都被当做一个参数传入<span class="built_in">printf</span>命令，然后按照指定的格式输出了。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# printf "%s\n" 1 11 213 11123</span><br><span class="line">1</span><br><span class="line">11</span><br><span class="line">213</span><br><span class="line">11123</span><br><span class="line">[root@bogon ~]# printf "%f\n" 1 11 213 11123</span><br><span class="line">1.000000</span><br><span class="line">11.000000</span><br><span class="line">213.000000</span><br><span class="line">11123.000000</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"%f"</span>也代替了每一个传入的参数，它会将每一个传入的参数转换成<span class="string">"浮点类型"</span></span></span><br><span class="line"></span><br><span class="line">* 格式替换符</span><br><span class="line"><span class="meta">#</span><span class="bash"> %s 字符串</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %f 浮点格式（也就是我们概念中的<span class="built_in">float</span>或者double）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %b 相对应的参数中包含转义字符时，可以使用此替换符进行替换，对应的转义字符会被转义。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %c ASCII字符。显示相对应参数的第一个字符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %d, %i 十进制整数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %o 不带正负号的八进制值</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %u 不带正负号的十进制值</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %x 不带正负号的十六进制值，使用a至f表示10至15</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %X 不带正负号的十六进制值，使用A至F表示10至15</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> %% 表示<span class="string">"%"</span>本身</span></span><br><span class="line">* printf常用的转义符</span><br><span class="line"><span class="meta">#</span><span class="bash"> \a 警告字符，通常为ASCII的BEL字符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \b 后退</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \c 抑制（不显示）输出结果中任何结尾的换行字符（只在%b格式指示符控制下的参数字符串中有效），而且，任何留在参数里的字符、任何接下来的参数以及任何留在格式字符串中的字符，都被忽略</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \f 换页（formfeed）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \n 换行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \r 回车（Carriage <span class="built_in">return</span>）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \t 水平制表符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \v 垂直制表符</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \\ 一个字面上的反斜杠字符，即<span class="string">"\"本身。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \ddd 表示1到3位数八进制值的字符，仅在格式字符串中有效</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> \0ddd 表示1到3位的八进制值字符</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# printf "( %s ) " 1 23 234 23423;echo ""</span><br><span class="line">( 1 ) ( 23 ) ( 234 ) ( 23423 )</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为每个传入的参数添加一对<span class="string">"括号"</span>，并且括号内侧需要有空格。最后的<span class="built_in">echo</span>命令是为了换行</span></span><br><span class="line">[root@bogon ~]# printf "%s\t" 1 23 234 23423;echo ""</span><br><span class="line">1	23	234	23423</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"制表符"</span>隔开每个参数</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# printf "%s %s\n" a b df ad e r</span><br><span class="line">a b</span><br><span class="line">df ad</span><br><span class="line">e r</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定的<span class="string">"格式"</span>中所包含的<span class="string">"格式替换符"</span>的数量，就代表每次格式化的参数的数量，每个<span class="string">"格式替换符"</span>与参数都是一一对应的</span></span><br><span class="line">[root@bogon ~]# printf "%s %s %s\n" a b c d e f </span><br><span class="line">a b c</span><br><span class="line">d e f</span><br><span class="line">[root@bogon ~]# printf "%s %s %s\n" 姓名 性别 年龄 董鹏 男 29 少松 女 39</span><br><span class="line">姓名 性别 年龄</span><br><span class="line">董鹏 男 29</span><br><span class="line">少松 女 39</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面的年龄与其上面的标题没有对齐</span></span><br><span class="line">[root@bogon ~]# printf "%7s %5s %4s\n" 姓名 性别 年龄 董鹏 男 29 少松 女 39</span><br><span class="line"> 姓名 性别 年龄</span><br><span class="line"> 董鹏   男   29</span><br><span class="line"> 少松   女   39</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在原来的<span class="string">"格式替换符"</span>中间加入了特定的数字，可以使输出的文字向右对齐。如果想向左对齐，就将数字改为负数，如：%-9s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果使用%+9s，表示给后面对应的参数前加一个+号。</span></span><br><span class="line">[root@bogon ~]# printf "aaa fff\n";printf "%-9s %-12f \n" abc 123.123123 bbb 2312.12345</span><br><span class="line">aaa fff</span><br><span class="line">abc       123.123123   </span><br><span class="line">bbb       2312.123450</span><br><span class="line">[root@bogon ~]# printf "aaa fff\n";printf "%-9s %-12.2f \n" abc 123.123123 bbb 2312.12345</span><br><span class="line">aaa fff</span><br><span class="line">abc       123.12       </span><br><span class="line">bbb       2312.12 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一条命令的数字修饰符为12，表示对应的替换符<span class="string">"%f"</span>的输出宽度为12个字符，第二条命令的数字修饰符为12.2 ，表示对应的替换符<span class="string">"%f"</span>的输出宽度为12个字符，并且小数点的精度为2。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# printf "aaa fff\n";printf "%-9s %-12d \n" abc 123 bbb 2312</span><br><span class="line">aaa fff</span><br><span class="line">abc       123          </span><br><span class="line">bbb       2312 </span><br><span class="line">[root@bogon ~]# printf "aaa fff\n";printf "%-9s %-12.4d \n" abc 123 bbb 2312</span><br><span class="line">aaa fff</span><br><span class="line">abc       0123         </span><br><span class="line">bbb       2312</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当格式替换符为<span class="string">"%d"</span>时，如果数字修饰符带有小数点，则数字修饰符小数点后的数字表示整数的长度，长度不够时，高位用0补全</span></span><br></pre></td></tr></table></figure>
<h4 id="printf动作"><a href="#printf动作" class="headerlink" title="printf动作"></a>printf动作</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# awk '&#123;print $1&#125;' test</span><br><span class="line">abc</span><br><span class="line">123</span><br><span class="line">[root@bogon ~]# awk '&#123;printf $1&#125;' test</span><br><span class="line">abc123[root@bogon ~]#</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">printf</span>动作不会自动换行</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;printf "%s\n",$1&#125;' test</span><br><span class="line">abc</span><br><span class="line">123</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用格式替换符，不要忘记<span class="variable">$1</span>前面的逗号</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;printf "%s\n",1,2,3,4,5&#125;'</span><br><span class="line">1</span><br><span class="line">[root@bogon ~]# awk 'BEGIN&#123;printf "%s\n%s\n%s\n%s\n%s\n",1,2,3,4,5&#125;'</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在awk中，格式替换符的数量必须与传入的参数的数量相同。也就是格式替换符必须与需要格式化的参数一一对应。不可以像使用<span class="built_in">printf</span>命令一样，一个格式替换符可以反复使用。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="built_in">printf</span>动作注意事项</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. 使用<span class="built_in">printf</span>动作输出的文本不会换行，如果需要换行，可以在对应的<span class="string">"格式替换符"</span>后加入<span class="string">"\n"</span>进行转义。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 使用<span class="built_in">printf</span>动作时，<span class="string">"指定的格式"</span> 与 <span class="string">"被格式化的文本"</span> 之间，需要用<span class="string">"逗号"</span>隔开。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 使用<span class="built_in">printf</span>动作时，<span class="string">"格式"</span>中的<span class="string">"格式替换符"</span>必须与 <span class="string">"被格式化的文本"</span> 一一对应。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# awk '&#123;printf "第一列： %s 第二列： %s\n",$1,$2&#125;' test</span><br><span class="line">第一列： abc 第二列： 345</span><br><span class="line">第一列： 123 第二列： klj</span><br><span class="line">[root@bogon ~]# awk -v FS="#" '&#123;printf "第一列： %s 第二列： %s\n",$1,$2&#125;' test1</span><br><span class="line">第一列： aaa 第二列： dfa</span><br><span class="line">第一列： aiew 第二列： adkf</span><br><span class="line">[root@bogon ~]# awk -v FS=":" 'BEGIN&#123;printf "%-10s\t %s\n","用户名称","用户ID"&#125;&#123;printf "%-10s\t %s\n",$1,$3&#125;' /etc/passwd</span><br><span class="line">用户名称      	 用户ID</span><br><span class="line">root      	 0</span><br><span class="line">bin       	 1</span><br><span class="line">daemon    	 2</span><br><span class="line">adm       	 3</span><br><span class="line">lp        	 4</span><br><span class="line">sync      	 5</span><br><span class="line">shutdown  	 6</span><br><span class="line">halt      	 7</span><br><span class="line">mail      	 8</span><br><span class="line">operator  	 11</span><br><span class="line">games     	 12</span><br><span class="line">ftp       	 14</span><br><span class="line">nobody    	 99</span><br><span class="line">systemd-network	 192</span><br><span class="line">dbus      	 81</span><br><span class="line">polkitd   	 999</span><br><span class="line">postfix   	 89</span><br><span class="line">sshd      	 74</span><br><span class="line">openvpn   	 998</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/16/iptables动作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/16/iptables动作/" itemprop="url">
                  iptables动作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-16 09:01:54 / 修改時間：11:40:04" itemprop="dateCreated datePublished" datetime="2018-10-16T09:01:54+08:00">2018-10-16</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>“动作”与”匹配条件”一样，也有”基础”与”扩展”之分。同样，使用扩展动作也需要借助扩展模块，但是，扩展动作可以直接使用，不用像使用”扩展匹配条件”那样指定特定的模块。</p>
</blockquote>
<h4 id="REJECT"><a href="#REJECT" class="headerlink" title="REJECT"></a>REJECT</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 常用选项为--reject-with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可用值如下:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-net-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-host-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-port-unreachable,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-proto-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-net-prohibited</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-host-pro-hibited</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-admin-prohibited</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当不设置任何值时，默认值为icmp-port-unreachable。</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -I INPUT -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝所有主机访问本机</span></span><br><span class="line">[root@localhost ~]# ping 10.5.5.90</span><br><span class="line">PING 10.5.5.90 (10.5.5.90) 56(84) bytes of data.</span><br><span class="line">From 10.5.5.90 icmp_seq=1 Destination Port Unreachable</span><br><span class="line">From 10.5.5.90 icmp_seq=2 Destination Port Unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时用其他主机ping本机提示是“Destination Port Unreachable”</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line">[root@localhost ~]# iptables -A INPUT -j REJECT --reject-with icmp-host-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改提示信息为“icmp-host-unreachable”</span></span><br><span class="line">[root@localhost ~]# ping 10.5.5.90</span><br><span class="line">PING 10.5.5.90 (10.5.5.90) 56(84) bytes of data.</span><br><span class="line">From 10.5.5.90 icmp_seq=1 Destination Host Unreachable</span><br><span class="line">From 10.5.5.90 icmp_seq=2 Destination Host Unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用其他主机ping本机时提示已改为“Destination Host Unreachable”</span></span><br></pre></td></tr></table></figure>
<h4 id="LOG"><a href="#LOG" class="headerlink" title="LOG"></a>LOG</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用LOG动作，可以将符合条件的报文的相关信息记录到日志中，但当前报文具体是被<span class="string">"接受"</span>，还是被<span class="string">"拒绝"</span>，都由后面的规则控制</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> --<span class="built_in">log</span>-level选项可以指定记录日志的日志级别，可用级别有emerg，alert，crit，error，warning，notice，info，debug。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --<span class="built_in">log</span>-prefix选项可以给记录到的相关信息添加<span class="string">"标签"</span>之类的信息，以便区分各种记录到的报文信息，方便在分析时进行过滤。--<span class="built_in">log</span>-prefix对应的值不能超过29个字符。</span></span><br><span class="line"></span><br><span class="line">* 基本设置</span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -j LOG</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上述规则表示所有发往22号端口的tcp报文都符合条件，所以都会被记录到日志中，查看/var/<span class="built_in">log</span>/messages即可看到对应报文的相关信息。但是上述规则只是用于示例，因为上例中使用的匹配条件过于宽泛。所以在使用LOG动作时，匹配条件应该尽量写的精确一些，匹配到的报文数量也会大幅度的减少，这样冗余的日志信息就会变少，同时日后分析日志时，日志中的信息可用程度更高。</span></span><br><span class="line">[root@localhost ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 48 packets, 4200 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1          46     3296 LOG        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22 LOG flags 0 level 4</span><br><span class="line">[root@localhost ~]# tail -f /var/log/messages </span><br><span class="line">Oct 16 17:27:36 localhost kernel: IN=eno16777736 OUT= MAC=00:0c:29:45:17:9b:50:7b:9d:65:f9:ff:08:00 SRC=10.5.5.23 DST=10.5.5.90 LEN=40 TOS=0x00 PREC=0x00 TTL=64 ID=2314 DF PROTO=TCP SPT=51108 DPT=22 WINDOW=16243 RES=0x00 ACK URGP=0 </span><br><span class="line">Oct 16 17:27:37 localhost kernel: IN=eno16777736 OUT= MAC=00:0c:29:45:17:9b:50:7b:9d:65:f9:ff:08:00 SRC=10.5.5.23 DST=10.5.5.90 LEN=92 TOS=0x00 PREC=0x00 TTL=64 ID=2323 DF PROTO=TCP SPT=51108 DPT=22 WINDOW=16243 RES=0x00 ACK PSH URGP=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> LOG动作默认会将报文的相关信息记录在/var/<span class="built_in">log</span>/message文件中</span></span><br><span class="line">[root@localhost ~]# vim /etc/rsyslog.conf</span><br><span class="line">	kern.warning /var/log/iptables.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入上面一行，让iptables将日志记录在其他位置	</span></span><br><span class="line">[root@localhost ~]# systemctl restart rsyslog</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启日志服务</span></span><br><span class="line"></span><br><span class="line">* --log-prefix</span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -m state --state NEW -j LOG --log-prefix "want-in-from-port-22"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将主动连接22号端口的报文的相关信息都记录到日志中，并且把这类记录命名为<span class="string">"want-in-from-port-22"</span></span></span><br><span class="line">[root@localhost ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 44 packets, 3150 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 LOG        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22 state NEW LOG flags 0 level 4 prefix "want-in-from-port-22"</span><br><span class="line">[root@localhost ~]# tail -f /var/log/iptables.log </span><br><span class="line">Oct 16 17:41:08 localhost kernel: want-in-from-port-22IN=eno16777736 OUT= MAC=00:0c:29:45:17:9b:00:0c:29:96:6b:bf:08:00 SRC=10.5.5.91 DST=10.5.5.90 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=7879 DF PROTO=TCP SPT=42102 DPT=22 WINDOW=14600 RES=0x00 SYN URGP=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用其他主机连接本机时会有相关记录。这条日志中包含<span class="string">"标签"</span>：want-in-from-port-22，如果有很多日志记录，我们就能通过这个<span class="string">"标签"</span>进行筛选了，这样方便我们查看日志，同时，从上述记录中还能够得知报文的源IP与目标IP，源端口与目标端口等信息，从上述日志我们能够看出，10.5.5.91这个IP想要在17:41:08连接到10.5.5.91（当前主机的IP）的22号端口，报文由eno16777736网卡进入，eno16777736网卡的MAC地址为00:0c:29:45:17:9b，客户端网卡的mac地址为00:0c:29:96:6b:bf。</span></span><br></pre></td></tr></table></figure>
<h4 id="测试源地址与目标地址转换"><a href="#测试源地址与目标地址转换" class="headerlink" title="测试源地址与目标地址转换"></a>测试源地址与目标地址转换</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 准备四台主机，一台主机为公网主机，一台为防火墙，两台为内网主机。使用公网主机通过防火墙访问内网linux服务器。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A 公网主机IP：10.5.5.90</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> B 防火墙IP：10.5.5.91、192.168.116.129</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> C 内网linux服务器IP：192.168.116.130</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> D 内网windows主机IP：192.168.116.131</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将主机C和D的网关都指向B的内网地址，主机A和B的公网地址是桥接到宿主机的网卡上，打开B防火墙的路由功能ip_forward，在A和C主机上启动httpd服务。</span></span><br></pre></td></tr></table></figure>
<h5 id="SNAT"><a href="#SNAT" class="headerlink" title="SNAT"></a>SNAT</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t nat -A POSTROUTING -s 192.168.116.0/24 -j SNAT --to-source 10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加规则，让内网主机经过防火墙出去时的地址都改为防火墙的外网地址。<span class="string">"-t nat"</span>表示操作nat表。filter表的功能是过滤，nat表的功能就是地址转换，所以我们需要在nat表中定义nat规则。<span class="string">"-A POSTROUTING"</span>表示将SNAT规则添加到POSTROUTING链的末尾，在centos7中，SNAT规则只能存在于POSTROUTING链与INPUT链中，在centos6中，SNAT规则只能存在于POSTROUTING链中。<span class="string">"-j SNAT"</span>表示使用SNAT动作，对匹配到的报文进行处理，对匹配到的报文进行源地址转换。<span class="string">"--to-source 10.5.5.91"</span>表示将匹配到的报文的源IP修改为10.5.5.91</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在centos7中，SNAT规则也可以定义在INPUT链中，我们可以这样理解，发往本机的报文经过INPUT链以后报文就到达了本机，如果再不修改报文的源地址，就没有机会修改了。</span></span><br><span class="line">[root@localhost ~]# iptables -t nat --line -nvxL</span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 SNAT       all  --  *      *       192.168.116.0/24     0.0.0.0/0            to:10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置上面的规则后就可以ping通外网主机了</span></span><br><span class="line">* A</span><br><span class="line">[root@localhost ~]# tcpdump -i eno16777736 -nn icmp</span><br><span class="line">18:41:22.375035 IP 10.5.5.91 &gt; 10.5.5.90: ICMP echo request, id 14189, seq 17, length 64</span><br><span class="line">18:41:22.375090 IP 10.5.5.90 &gt; 10.5.5.91: ICMP echo reply, id 14189, seq 17, length 64</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时在主机A上抓包，用C主机ping主机A，可以看到是10.5.5.91发来的数据。在主机C上也可以看到是主机A返回的信息。在C主机上抓包也可以看到是外网主机返回的信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在A主机上不要添加到内网的路由，这样，在防火墙没有添加SNAT规则时，内外网是不能ping通的，当添加了SNAT规则后，内网主机就可以ping通外网了</span></span><br></pre></td></tr></table></figure>
<h5 id="DNAT"><a href="#DNAT" class="headerlink" title="DNAT"></a>DNAT</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t nat -I PREROUTING -d 10.5.5.91 -p tcp --dport 3389 -j DNAT --to-destination 192.168.116.131:3389</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入一条规则，在PREROUTING链上，目标地址是防火墙的外网地址，端口是3389。目标地址转换为内网地址192.168.116.131:3389。实际就是地址与端口映射，将外网的地址与端口映射为内网的地址与端口</span></span><br><span class="line">[root@localhost ~]# iptables -t nat --line -nvxL</span><br><span class="line">Chain PREROUTING (policy ACCEPT 18 packets, 2657 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           1       52 DNAT       tcp  --  *      *       0.0.0.0/0            10.5.5.91            tcp dpt:3389 to:192.168.116.131:3389</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 18 packets, 2657 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 1 packets, 52 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           6      904 SNAT       all  --  *      *       192.168.116.0/24     0.0.0.0/0            to:10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置内网windows主机可以远程访问，之后用本机远程连接10.5.5.91，也就是防火墙地址，这时是可以连接到内网主机192.168.116.131上的。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 理论上只配置DNAT规则即可，但是如果在测试时无法正常DNAT，可以尝试配置对应的SNAT，此处按照配置SNAT的流程进行。SNAT规则与上面是一样的，就是将内网的主机出去的地址都改为防火墙的地址。</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -t nat -I PREROUTING -d 10.5.5.91 -p tcp --dport 8080 -j DNAT --to-destination 192.168.116.130:80</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加一条端口映射，将外网的8080端口映射到内网的80端口上</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这次，我们不用再次定义SNAT规则了，因为之前已经定义过SNAT规则，上次定义的SNAT规则只要定义一次就行，而DNAT规则则需要根据实际的情况去定义。</span></span><br></pre></td></tr></table></figure>
<h4 id="MASQUERADE"><a href="#MASQUERADE" class="headerlink" title="MASQUERADE"></a>MASQUERADE</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当我们拨号网上时，每次分配的IP地址往往不同，不会长期分给我们一个固定的IP地址，如果这时，我们想要让内网主机共享公网IP上网，就会很麻烦，因为每次IP地址发生变化以后，我们都要重新配置SNAT规则，这样显得不是很人性化，我们通过MASQUERADE即可解决这个问题，MASQUERADE会动态的将源地址转换为可用的IP地址，其余与SNAT实现的功能完全一致，都是修改源地址，只不过SNAT需要指明将报文的源地址改为哪个IP，而MASQUERADE则不用指定明确的IP，会动态的将报文的源地址修改为指定网卡上可用的IP地址</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -t nat -I POSTROUTING -s 192.168.116.0/24 -o eno16777736 -j MASQUERADE</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过外网网卡出去的报文在经过POSTROUTING链时，会自动将报文的源地址修改为外网网卡上可用的IP地址，这时，即使外网网卡中的公网IP地址发生了改变，也能够正常的、动态的将内部主机的报文的源IP映射为对应的公网IP。可以把MASQUERADE理解为动态的、自动化的SNAT，如果没有动态SNAT的需求，没有必要使用MASQUERADE，因为SNAT更加高效。</span></span><br></pre></td></tr></table></figure>
<h4 id="REDIRECT"><a href="#REDIRECT" class="headerlink" title="REDIRECT"></a>REDIRECT</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用REDIRECT动作可以在本机上进行端口映射</span></span><br><span class="line">[root@localhost ~]# iptables -t nat -A PREROUTING -p tcp --dport 19000 -j REDIRECT --to-ports 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将本机的22端口映射到本机的19000端口上。REDIRECT规则只能定义在PREROUTING链或者OUTPUT链中。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/15/iptables网络防火墙/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/15/iptables网络防火墙/" itemprop="url">
                  iptables网络防火墙
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-15 14:32:53 / 修改時間：17:05:31" itemprop="dateCreated datePublished" datetime="2018-10-15T14:32:53+08:00">2018-10-15</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li><p>网络防火墙往往处于网络的入口或者边缘</p>
</li>
<li><p>网络防火墙的职责就是”过滤并转发”。要想”过滤”，只能在INPUT、OUTPUT、FORWARD三条链中实现，要想”转发”，报文则只会经过FORWARD链（发往本机的报文才会经过INPUT链），所以，iptables的角色变为”网络防火墙”时，规则只能定义在FORWARD链中。</p>
</li>
</ul>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 准备三台主机，一台为外网主机，一台为内网主机，一台允当防火墙</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A外网主机IP：10.5.5.90</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> B内网主机IP：192.168.116.130</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> C网络防火墙IP：192.168.116.129、10.5.5.91</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将虚拟机B的第二块网卡和C的网卡设置为仅主机</span></span><br><span class="line">* C</span><br><span class="line">[root@localhost ~]# vim /etc/sysconfig/network-scripts/ifcfg-eno16777736</span><br><span class="line">    IPADDR=192.168.116.130</span><br><span class="line">    NETMASK=255.255.255.0</span><br><span class="line">    GATEWAY=192.168.116.129</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将C主机的网关指向B（防火墙）主机的内网地址192.168.116.129</span></span><br><span class="line"></span><br><span class="line">* A</span><br><span class="line">[root@localhost ~]#route add -net 192.168.116.0/24 gw 10.5.5.91</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给外网主机加一条路由，让外网主机知道如何到内网主机</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 现在外网与内网主机还不能互相ping通，因为防火墙没有路由数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为在CentOS中，IP地址属于主机，所以内外网的主机都可以ping通防火墙</span></span><br><span class="line"></span><br><span class="line">* B</span><br><span class="line">[root@localhost ~]# echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启防火墙路由功能</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时内外网可以互相ping通了。</span></span><br><span class="line">[root@localhost ~]# iptables -A FORWARD -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝所有数据转发。这时内外网又不能互相ping通了。</span></span><br><span class="line"></span><br><span class="line">* A</span><br><span class="line">[root@localhost ~]# vim /var/www/html/index.html</span><br><span class="line">	10.5.5.90</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加默认主页</span></span><br><span class="line">[root@localhost ~]# systemctl start httpd</span><br><span class="line"></span><br><span class="line">* C</span><br><span class="line">[root@localhost ~]# vim /var/www/html/index.html</span><br><span class="line">	192.168.116.130</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加默认主页</span></span><br><span class="line">[root@localhost ~]# systemctl start httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动两台主机的httpd服务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时两台主机是不能互相访问的</span></span><br><span class="line"></span><br><span class="line">* B</span><br><span class="line">[root@localhost ~]# iptables -I FORWARD -s 192.168.116.0/24 -p tcp --dport 80 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 让源地址是192.168.116.0网段的主机可以访问外部的80端口。只加入这一条还不行，这只是数据流出的规则，还要加数据流入的规则</span></span><br><span class="line">[root@localhost ~]# iptables -I FORWARD -d 192.168.116.0/24 -p tcp --sport 80 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入此条后，192.168.116.0网段的主机就可以访问外部的80端口了。</span></span><br><span class="line">[root@localhost ~]# iptables -D FORWARD 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除FORWARD中的第一条规则</span></span><br><span class="line">[root@localhost ~]# iptables -I FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入这一条就可以将绝大多数响应报文放行了。配置完上述规则后，我们只要考虑请求报文的方向就行了，而回应报文，上述一条规则就能搞定，这样配置，即使以后有更多服务的响应报文需要放行，我们也不用再去针对响应报文设置规则了</span></span><br><span class="line">[root@localhost ~]# iptables -I FORWARD -s 192.168.116.0/24 -p tcp --dport 22 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入这一条就可以实现内网主机使用ssh连接外部主机了</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/15/iptables自定义规则链/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/15/iptables自定义规则链/" itemprop="url">
                  iptables自定义规则链
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-15 14:05:17 / 修改時間：14:32:56" itemprop="dateCreated datePublished" datetime="2018-10-15T14:05:17+08:00">2018-10-15</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="创建自定义规则链"><a href="#创建自定义规则链" class="headerlink" title="创建自定义规则链"></a>创建自定义规则链</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当默认链中的规则非常多时，不方便我们管理。所以要自定义规则链</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 自定义链并不能直接使用，而是需要被默认链引用才能够使用</span></span><br><span class="line"></span><br><span class="line">* 创建自定义链</span><br><span class="line">[root@bogon ~]# iptables -t filter -N IN_WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"-t filter"</span>表示操作的表为filter表，与之前的示例相同，省略-t选项时，缺省操作的就是filter表。<span class="string">"-N IN_WEB"</span>表示创建一个自定义链，自定义链的名称为<span class="string">"IN_WEB"</span></span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line">2         386    26796 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">3        4087   278278 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 44 packets, 4228 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain IN_WEB (0 references)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看filter表中的链，这条自定义链的引用计数为0 (0 references)，也就是说，这条自定义链还没有被任何默认链所引用，所以，即使IN_WEB中配置了规则，也不会生效</span></span><br><span class="line"></span><br><span class="line">* 创建自定义链规则</span><br><span class="line">[root@bogon ~]# iptables -I IN_WEB -s 10.5.5.249 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables --line -nvxL IN_WEB</span><br><span class="line">Chain IN_WEB (0 references)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     all  --  *      *       10.5.5.249           0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自定义链中已经有了一条规则，但是目前，这条规则无法匹配到任何报文，因为我们并没有在任何默认链中引用它。</span></span><br><span class="line"></span><br><span class="line">* 引用自定义链</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -j IN_WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在INPUT链中添加了一条规则，访问本机80端口的tcp报文将会被这条规则匹配到，而上述规则中的<span class="string">"-j IN_WEB"</span>表示：访问80端口的tcp报文将由自定义链<span class="string">"IN_WEB"</span>中的规则进行处理。此处，我们将<span class="string">"动作"</span>替换为了<span class="string">"自定义链"</span>，当<span class="string">"-j"</span>对应的值为一个自定义链时，就表示被当前规则匹配到的报文将交由对应的自定义链处理。当IN_WEB自定义链被INPUT链引用以后，可以发现，IN_WEB链的引用计数已经变为1，表示这条自定义链已经被引用了1次，自定义链还可以引用其他的自定义链</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 IN_WEB     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">2           0        0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line">3         663    46156 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">4        5196   351595 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 76 packets, 7396 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain IN_WEB (1 references)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     all  --  *      *       10.5.5.249           0.0.0.0/0            reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>
<h4 id="重命名自定义链"><a href="#重命名自定义链" class="headerlink" title="重命名自定义链"></a>重命名自定义链</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# iptables -E IN_WEB WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"-E"</span>选项可以修改自定义链名</span></span><br><span class="line">[root@bogon ~]# iptables -nvL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">   80  5672 WEB        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line">  888 62080 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line"> 6265  425K REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 24 packets, 2328 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain WEB (2 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    1    60 REJECT     all  --  *      *       10.5.5.249           0.0.0.0/0            reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>
<h4 id="删除自定义链"><a href="#删除自定义链" class="headerlink" title="删除自定义链"></a>删除自定义链</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"-X"</span>选项可以删除自定义链，但是删除自定义链时，需要满足两个条件：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1、自定义链没有被任何默认链引用，即自定义链的引用计数为0。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、自定义链中没有任何规则，即自定义链为空。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -X WEB</span><br><span class="line">iptables: Too many links.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提示：Too many links，是因为WEB链已经被默认链所引用</span></span><br><span class="line">[root@bogon ~]# iptables -D INPUT 1</span><br><span class="line">[root@bogon ~]# iptables -X WEB</span><br><span class="line">iptables: Directory not empty.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除引用自定义链的规则后，再次尝试删除自定义链，提示：Directory not empty，是因为WEB链中存在规则</span></span><br><span class="line">[root@bogon ~]# iptables -t filter -F WEB</span><br><span class="line">[root@bogon ~]# iptables -t filter -X WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除规则后再删除自定义链就没问题了。使用<span class="string">"-X"</span>选项可以删除一个引用计数为0的、空的自定义链</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/12/iptables匹配条件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/12/iptables匹配条件/" itemprop="url">
                  iptables匹配条件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-12 16:35:15" itemprop="dateCreated datePublished" datetime="2018-10-12T16:35:15+08:00">2018-10-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-15 13:55:17" itemprop="dateModified" datetime="2018-10-15T13:55:17+08:00">2018-10-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基本匹配条件"><a href="#基本匹配条件" class="headerlink" title="基本匹配条件"></a>基本匹配条件</h3><h4 id="指定地址"><a href="#指定地址" class="headerlink" title="指定地址"></a>指定地址</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">* 一次指定多个源地址</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249,10.5.5.224 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用逗号分隔多个地址</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 55 packets, 4698 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 DROP       all  --  *      *       10.5.5.224           0.0.0.0/0           </span><br><span class="line">2          12     1008 DROP       all  --  *      *       10.5.5.249           0.0.0.0/0 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定后会一次添加两条规则</span></span><br><span class="line"></span><br><span class="line">* 指定网段</span><br><span class="line">[root@bogon ~]# iptables -I FORWARD -s 10.5.5.0/16 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝10.5.5.0网段的所有地址访问</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL FORWARD</span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 DROP       all  --  *      *       10.5.0.0/16          0.0.0.0/0</span><br><span class="line"></span><br><span class="line">* 对条件取反</span><br><span class="line">[root@bogon ~]# iptables -A INPUT ! -s 10.5.5.25 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"! -s 10.5.5.25"</span>表示对 -s 10.5.5.25这个匹配条件取反， -s 10.5.5.25表示报文源IP地址为10.5.5.25即可满足匹配条件，使用 <span class="string">"!"</span> 取反后则表示，报文源地址IP只要不为10.5.5.25即满足条件，那么，上例中规则表达的意思就是，只要发往本机的报文的源地址不是10.5.5.25，就接受报文。但10.5.5.25还是可以ping通这台主机，因为filter表的INPUT链中只有一条规则，这条规则要表达的意思就是：只要报文的源IP不是10.5.5.25，那么就接受此报文，但并不能代表，报文的源IP是10.5.5.25时，会被拒绝。因为并没有任何一条规则指明源IP是10.5.5.25时，该执行怎样的动作，所以，当来自10.5.5.25的报文经过INPUT链时，并不能匹配上例中的规则，于是，此报文就继续匹配后面的规则，因为只有一条规则，于是，此报文就会去匹配当前链的默认动作(默认策略)，因为默认策略是ACCEPT，所以10.5.5.25还可以ping通这台主机。</span></span><br><span class="line">[root@bogon ~]# iptables --line -vnxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1         159    12226 ACCEPT     all  --  *      *      !10.5.5.25            0.0.0.0/0 </span><br><span class="line"></span><br><span class="line">* 指定目标地址</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -d 10.5.5.22 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-d选项指定目标地址。如果我们不指定任何目标地址，则目标地址默认为0.0.0.0/0，同理，如果我们不指定源地址，源地址默认为0.0.0.0/0。-d选项也可以使用<span class="string">"叹号"</span>进行取反，也能够同时指定多个IP地址，使用<span class="string">"逗号"</span>隔开即可。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 但是请注意，不管是-s选项还是-d选项，取反操作与同时指定多个IP的操作不能同时使用。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当一条规则中有多个匹配条件时，这多个匹配条件之间，默认存在<span class="string">"与"</span>的关系。如上面规则表示源地址与目标地址必须同时能被这两个条件匹配，才算作被当前规则匹配</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1          12     1008 DROP       all  --  *      *       10.5.5.249           10.5.5.22           </span><br><span class="line">2        1978   144348 ACCEPT     all  --  *      *      !10.5.5.25            0.0.0.0/0</span><br></pre></td></tr></table></figure>
<h4 id="协议类型"><a href="#协议类型" class="headerlink" title="协议类型"></a>协议类型</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp -s 10.5.5.249 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝10.5.5.249的tcp请求，所以ssh无法连接，但可以ping通。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当不使用-p指定协议类型时，默认表示所有类型的协议都会被匹配到，与使用-p all的效果相同。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT ! -p udp -s 10.5.5.249 -j DROP</span><br><span class="line">[root@bogon ~]# iptables --line -xvnL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 192 packets, 11044 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1          18     1512 DROP      !udp  --  *      *       10.5.5.249           0.0.0.0/0           </span><br><span class="line">2           0        0 DROP       tcp  --  *      *       10.5.5.249           0.0.0.0/0 </span><br><span class="line"><span class="meta">#</span><span class="bash"> -p用于匹配报文的协议类型,可以匹配的协议类型tcp、udp、udplite、icmp、esp、ah、sctp等（centos7中还支持icmpv6、mh）</span></span><br></pre></td></tr></table></figure>
<h4 id="网卡接口"><a href="#网卡接口" class="headerlink" title="网卡接口"></a>网卡接口</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 流入</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -i eth0 -j DROP</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp ! -i eth0 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> -i用于匹配报文是从哪个网卡接口流入本机的，由于匹配条件只是用于匹配报文流入的网卡，所以在OUTPUT链与POSTROUTING链中不能使用此选项。</span></span><br><span class="line">[root@bogon ~]# iptables --line -xvnL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 52 packets, 4422 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 DROP       icmp --  !eth0  *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">2          25     2100 DROP       icmp --  eth0   *       0.0.0.0/0            0.0.0.0/0</span><br><span class="line"></span><br><span class="line">* 流出</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p icmp -o eth0 -j DROP</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p icmp ! -o eth0 -j DROP</span><br><span class="line">[root@bogon ~]# iptables --line -xvnL OUTPUT</span><br><span class="line">Chain OUTPUT (policy ACCEPT 65 packets, 6908 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 DROP       icmp --  *      !eth0   0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">2          23     1932 DROP       icmp --  *      eth0    0.0.0.0/0            0.0.0.0/0</span><br></pre></td></tr></table></figure>
<h3 id="扩展匹配条件"><a href="#扩展匹配条件" class="headerlink" title="扩展匹配条件"></a>扩展匹配条件</h3><h4 id="tcp扩展模块"><a href="#tcp扩展模块" class="headerlink" title="tcp扩展模块"></a>tcp扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">* 目标端口</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp -m tcp --dport 22 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-m选项来指定扩展模块，如果想要使用--dport这个扩展匹配条件，则必须依靠某个扩折模块完成，上例中，这个扩展模块就是tcp扩展模块。 -m tcp表示使用tcp扩展模块，--dport表示tcp扩展模块中的一个扩展匹配条件，可用于匹配报文的目标端口。-p tcp与 -m tcp并不冲突，-p用于匹配报文的协议，-m 用于指定扩展模块的名称，正好，这个扩展模块也叫tcp。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 基本匹配条件我们可以直接使用，而如果想要使用扩展匹配条件，则需要依赖一些扩展模块</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 扩展匹配条件是可以取反的，同样是使用<span class="string">"!"</span>进行取反，比如 <span class="string">"! --dport 22"</span>，表示目标端口不是22的报文将会被匹配到。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp --dport 22 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以省略-m选项。当使用-p选项指定了报文的协议时，如果在没有使用-m指定对应的扩展模块名称的情况下，使用了扩展匹配条件，  iptables默认会调用与-p选项对应的协议名称相同的模块。</span></span><br><span class="line"></span><br><span class="line">* 源端口</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp --sport 22 -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables --line -xvnL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 59 packets, 4224 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 ACCEPT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            tcp spt:22</span><br><span class="line">2           1       60 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            tcp dpt:22 reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">* 指定端口范围</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp --dport 22:25 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables --line -xvnL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 9 packets, 662 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            tcp dpts:22:25 reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> --dport 22:25表示目标端口为22到25之间的所有端口</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp --dport :22 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp --sport 80: -j REJECT </span><br><span class="line">[root@bogon ~]# iptables --line -xvnL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 46 packets, 3358 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            tcp spts:80:65535 reject-with icmp-port-unreachable</span><br><span class="line">2           0        0 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            tcp dpts:0:22 reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> --sport和--dport都可以指定多个端口，第一条表示从0到22端口，第二条表示80端口到65535端口</span></span><br><span class="line"></span><br><span class="line">* --tcp-flags</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"--tcp-flags"</span>指的就是tcp头中的标志位，我们可以通过此扩展匹配条件，去匹配tcp报文的头部的标识位，然后根据标识位的实际情况实现访问控制的功能。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp -m tcp --dport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"-m tcp --dport 22"</span>的表示使用tcp扩展模块，指定目标端口为22号端口(ssh默认端口)，<span class="string">"--tcp-flags"</span>用于匹配报文tcp头部的标志位，<span class="string">"SYN,ACK,FIN,RST,URG,PSH SYN"</span>就是用于配置我们要匹配的标志位的，我们可以把这串字符拆成两部分去理解，第一部分为<span class="string">"SYN,ACK,FIN,RST,URG,PSH"</span>，第二部分为<span class="string">"SYN"</span>。第一部分表示：我们需要匹配报文tcp头中的哪些标志位，这里指定了六个标志位。第二部分表示：第一部分的标志位列表中，哪些标志位必须为1，这里指定的是SYN标志位必须为1，其他标志位必须为0。也就是tcp三次握手时第一次握手时的情况。</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 44 packets, 3226 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22 flags:0x3F/0x02 reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN -j REJECT</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp -m tcp --sport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN,ACK -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一条命令匹配到的报文是第一次握手的报文，第二条命令匹配到的报文是第二次握手的报文。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp -m tcp --dport 22 --tcp-flags ALL SYN -j REJECT</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp -m tcp --sport 22 --tcp-flags ALL SYN,ACK -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面两条命令可以简写成这样，也就是将六个标志位用ALL代替</span></span><br><span class="line"></span><br><span class="line">* --syn</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp -m tcp --dport 22 --syn -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"--syn"</span>选项匹配第一次握手，这相当于使用<span class="string">"--tcp-flags SYN,RST,ACK,FIN  SYN"</span>，也就是说，可以使用<span class="string">"--syn"</span>选项去匹配tcp新建连接的请求报文。</span></span><br></pre></td></tr></table></figure>
<h4 id="udp扩展"><a href="#udp扩展" class="headerlink" title="udp扩展"></a>udp扩展</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# iptables -I INPUT -p udp -m udp --dport 137 -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p udp -m udp --dport 138 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 放行samba服务的137与138这两个UDP端口</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p udp --dport 137 -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p udp --dport 138 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以省略-m选项</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p udp --dport 137:157 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开放137到157之间的所有udp端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> udp中的--sport与--dport也只能指定连续的端口范围，并不能一次性指定多个离散的端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用multiport扩展模块，即可指定多个离散的UDP端口</span></span><br></pre></td></tr></table></figure>
<h4 id="icmp扩展"><a href="#icmp扩展" class="headerlink" title="icmp扩展"></a>icmp扩展</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ICMP协议的全称为Internet Control Message Protocol，翻译为互联网控制报文协议，它主要用于探测网络上的主机是否可用，目标是否可达，网络是否通畅，路由是否可用等。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们平常使用ping命令ping某主机时，如果主机可达，对应主机会对我们的ping请求做出回应（此处不考虑禁ping等情况），也就是说，我们发出ping请求，对方回应ping请求，虽然ping请求报文与ping回应报文都属于ICMP类型的报文，但是如果在概念上细分的话，它们所属的类型还是不同的，我们发出的ping请求属于类型8的icmp报文，而对方主机的ping回应报文则属于类型0的icmp报文，根据应用场景的不同，icmp报文被细分为如下各种类型。</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/iptables/icmp.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 从上图可以看出，所有表示<span class="string">"目标不可达"</span>的icmp报文的<span class="built_in">type</span>码为3，而<span class="string">"目标不可达"</span>又可以细分为多种情况，是网络不可达呢？还是主机不可达呢？再或者是端口不可达呢？所以，为了更加细化的区分它们，icmp对每种<span class="built_in">type</span>又细分了对应的code，用不同的code对应具体的场景，  所以，我们可以使用<span class="built_in">type</span>/code去匹配具体类型的ICMP报文，比如可以使用<span class="string">"3/1"</span>表示主机不可达的icmp报文。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上图中的第一行就表示ping回应报文，它的<span class="built_in">type</span>为0，code也为0，从上图可以看出，ping回应报文属于查询类（query）的ICMP报文，从大类上分，ICMP报文还能分为查询类与错误类两大类，目标不可达类的icmp报文则属于错误类报文。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 而我们发出的ping请求报文对应的<span class="built_in">type</span>为8，code为0。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上例中，我们并没有使用任何扩展匹配条件，我们只是使用<span class="string">"-p icmp"</span>匹配了所有icmp协议类型的报文。如果进行了上述设置，别的主机向我们发送的ping请求报文无法进入防火墙，我们向别人发送的ping请求对应的回应报文也无法进入防火墙。所以，我们既无法ping通别人，别人也无法ping通我们。</span></span><br><span class="line">[root@bogon ~]# iptables -F</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -m icmp --icmp-type 8/0 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 本机可以ping通外部主机，但外部主机不能ping通本机</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"-m icmp"</span>表示使用icmp扩展，因为上例中使用了<span class="string">"-p icmp"</span>，所以<span class="string">"-m icmp"</span>可以省略，使用<span class="string">"--icmp-type"</span>选项表示根据具体的<span class="built_in">type</span>与code去匹配对应的icmp报文，而上图中的<span class="string">"--icmp-type 8/0"</span>表示icmp报文的<span class="built_in">type</span>为8，code为0才会被匹配到，也就是只有ping请求类型的报文才能被匹配到，所以，别人对我们发起的ping请求将会被拒绝通过防火墙，而我们之所以能够ping通别人，是因为别人回应我们的报文的icmp <span class="built_in">type</span>为0，code也为0，所以无法被上述规则匹配到，所以我们可以看到别人回应我们的信息。</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -m icmp --icmp-type 8 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为<span class="built_in">type</span>为8的类型下只有一个code为0的类型，所以我们可以省略对应的code</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -m icmp --icmp-type "echo-request" -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们可以用icmp报文的描述名称去匹配对应类型的报文。使用 --icmp-type <span class="string">"echo-request"</span>与 --icmp-type 8/0的效果完全相同</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 名称中的<span class="string">"空格"</span>需要替换为<span class="string">"-"</span>，如<span class="built_in">echo</span> request要命令中要写为<span class="built_in">echo</span>-request</span></span><br></pre></td></tr></table></figure>
<h4 id="multiport扩展模块"><a href="#multiport扩展模块" class="headerlink" title="multiport扩展模块"></a>multiport扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* 指定不连续端口</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp -m multiport --dports 22,36,80 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 121 packets, 7270 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            multiport dports 22,36,80 reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁止来自249的主机上的tcp报文访问本机的22号端口、36号端口以及80号端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用multiport模块的--sports扩展条件同时指定多个离散的源端口。使用multiport模块的--dports扩展条件同时指定多个离散的目标端口</span></span><br><span class="line"></span><br><span class="line">* 指定连续端口</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -s 10.5.5.249 -p tcp -m multiport --dports 22,80:88 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 47 packets, 3474 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       10.5.5.249           0.0.0.0/0            multiport dports 22,80:88 reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用multiport模块的--sports与--dpors时，也可以指定连续的端口范围，并且能够在指定连续的端口范围的同时，指定离散的端口号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝来自10.5.5.249的tcp报文访问当前主机的22号端口以及80到88之间的所有端口号</span></span><br></pre></td></tr></table></figure>
<h4 id="iprange扩展模块"><a href="#iprange扩展模块" class="headerlink" title="iprange扩展模块"></a>iprange扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用iprange扩展模块可以指定<span class="string">"一段连续的IP地址范围"</span>，用于匹配报文的源地址或者目标地址。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iprange扩展模块中有两个扩展匹配条件可以使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --src-range</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --dst-range</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -m iprange --src-range 10.5.5.240-10.5.5.249 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables --line -nxvL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 208 packets, 11763 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            source IP range 10.5.5.240-10.5.5.249 reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果报文的源IP地址在10.5.5.240到10.5.5.249之间，则丢弃报文，IP段的始末IP使用<span class="string">"横杠"</span>连接，--src-range与--dst-range和其他匹配条件一样，能够使用<span class="string">"!"</span>取反</span></span><br></pre></td></tr></table></figure>
<h4 id="string扩展模块"><a href="#string扩展模块" class="headerlink" title="string扩展模块"></a>string扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用string扩展模块，可以指定要匹配的字符串，如果报文中包含对应的字符串，则符合匹配条件。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> string模块的常用选项</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --algo：用于指定匹配算法，可选的算法有bm与kmp，此选项为必须选项，我们不用纠结于选择哪个算法，但是我们必须指定一个。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --string：用于指定需要匹配的字符串。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面在10.5.5.249上部署</span></span><br><span class="line">[root@test html]# yum install -y httpd</span><br><span class="line">[root@test html]# vim /var/www/html/index.html</span><br><span class="line">	OOXX</span><br><span class="line">[root@test html]# vim /var/www/html/index1.html</span><br><span class="line">	Hello World</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面到10.5.5.22主机访问</span></span><br><span class="line">[root@bogon ~]# curl 10.5.5.249</span><br><span class="line">OOXX</span><br><span class="line">[root@bogon ~]# curl 10.5.5.249/index1.html</span><br><span class="line">Hello World</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在249主机上安装httpd，提供两个网页，内容分别为OOXX和Hello World。此时在另一台主机可以正常访问</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -m string --algo bm --string "OOXX" -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果报文中包含<span class="string">"OOXX"</span>字符，我们就拒绝报文进入本机。<span class="string">'-m string'</span>表示使用string模块，<span class="string">'--algo bm'</span>表示使用bm算法去匹配指定的字符串，<span class="string">' --string "OOXX" '</span>则表示我们想要匹配的字符串为<span class="string">"OOXX"</span></span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 51 packets, 3603 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  "OOXX" ALGO name bm TO 65535 reject-with icmp-port-unreachable</span><br><span class="line">[root@bogon ~]# curl 10.5.5.249</span><br><span class="line">^C</span><br><span class="line">[root@bogon ~]# curl 10.5.5.249/index1.html</span><br><span class="line">Hello World</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在22主机上设置规则后，因为249主机的默认页中包含“OOXX”，所以访问时会停留在空白处，没有信息返回。如果访问index1.html页面是没有问题的。</span></span><br></pre></td></tr></table></figure>
<h4 id="time扩展模块"><a href="#time扩展模块" class="headerlink" title="time扩展模块"></a>time扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 可以通过time扩展模块，根据时间段区匹配报文，如果报文到达的时间在指定的时间范围以内，则符合匹配条件。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --monthdays与--weekdays可以使用<span class="string">"!"</span>取反，其他选项不能取反。</span></span><br><span class="line"></span><br><span class="line">* 指定时间</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --timestart 09:00:00 --timestop 18:00:00 -j REJECT</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 443 -m time --timestart 09:00:00 --timestop 18:00:00 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每天早上9点到下午6点不能看网页。<span class="string">"-m time"</span>表示使用time扩展模块，--timestart选项用于指定起始时间，--timestop选项用于指定结束时间。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试时，此条设置完未生效，依然可以访问网页</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL OUTPUT</span><br><span class="line">Chain OUTPUT (policy ACCEPT 37 packets, 3516 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443 TIME from 09:00:00 to 18:00:00 UTC reject-with icmp-port-unreachable</span><br><span class="line">2           0        0 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 TIME from 09:00:00 to 18:00:00 UTC reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">* 按周指定日期</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --weekdays 6,7 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只有周六日不能看网页。使用--weekdays选项可以指定每个星期的具体哪一天，可以同时指定多个，用逗号隔开，除了能够数字表示<span class="string">"星期几"</span>,还能用缩写表示，例如：Mon, Tue, Wed, Thu, Fri, Sat, Sun</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --timestart 09:00:00 --timestop 18:00:00 --weekdays 6,7 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将上面两种方法结合使用。指定只有周六日的早上9点到下午6点不能浏览网页。</span></span><br><span class="line"></span><br><span class="line">* 指月指定日期</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --monthdays 22,23 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用--monthdays选项可以具体指定的每个月的22号，23号不能访问网页。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --weekdays 5 --monthdays 22,23,24,25,26,27,28 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当一条规则中同时存在多个条件时，多个条件之间默认存在<span class="string">"与"</span>的关系。所以，上面的规则表示匹配的时间必须为星期五，并且这个<span class="string">"星期五"</span>同时还需要是每个月的22号到28号之间的一天，也就表示每个月的第4个星期五</span></span><br><span class="line"></span><br><span class="line">* 指定具体时间</span><br><span class="line">[root@bogon ~]# iptables -I OUTPUT -p tcp --dport 80 -m time --datestart 2018-10-15 --datestop 2018-10-19 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用--datestart 选项与-datestop选项，指定具体的日期范围。测试中，此条可以生效。</span></span><br></pre></td></tr></table></figure>
<p>####　connlimit扩展模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用connlimit扩展模块，可以限制每个IP地址同时链接到server端的链接数量，注意：我们不用指定IP，其默认就是针对<span class="string">"每个客户端IP"</span>，即对单IP的并发连接数限制。</span></span><br><span class="line"></span><br><span class="line">* --connlimit-above</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 超过两个连接就拒绝。使用<span class="string">"-m connlimit"</span>指定使用connlimit扩展，使用<span class="string">"--connlimit-above 2"</span>表示限制每个IP的链接数量上限为2，再配合-p tcp --dport 22，即表示限制每个客户端IP的ssh并发链接数量不能超过(above)2。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> centos6中，我们可以对--connlimit-above选项进行取反</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -m connlimit ! --connlimit-above 2 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每个客户端IP的ssh链接数量只要不超过两个，则允许链接。但上例的规则并不能表示：每个客户端IP的ssh链接数量超过两个则拒绝链接。因为匹配不到时要匹配默认规则，如果默认规则是ACCEPT,那么依然可以连接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 即使我们配置了上例中的规则，也不能达到<span class="string">"限制"</span>的目的，所以我们通常并不会对此选项取反，因为既然使用了此选项，我们的目的通常就是<span class="string">"限制"</span>连接数量。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> centos7中iptables为我们提供了一个新的选项，--connlimit-upto，这个选项的含义与<span class="string">"! --commlimit-above"</span>的含义相同，即链接数量未达到指定的连接数量之意，所以综上所述，--connlimit-upto选项也不常用。</span></span><br><span class="line"></span><br><span class="line">* --connlimit-mask</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 2 --connlimit-mask 24 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"--connlimit-mask 24"</span>表示某个C类网段。上面规则表示，一个最多包含254个IP的C类网络中，同时最多只能有2个ssh客户端连接到当前服务器</span></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 10 --connlimit-mask 27 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"--connlimit-mask 27"</span>表示某个C类网段，通过计算后可以得知，这个网段中最多只能有30台机器（30个IP），这30个IP地址最多只能有10个ssh连接同时连接到服务器端</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在不使用--connlimit-mask的情况下，连接数量的限制是针对<span class="string">"每个IP"</span>而言的，当使用了--connlimit-mask选项以后，则可以针对<span class="string">"某类IP段内的一定数量的IP"</span>进行连接数量的限制</span></span><br></pre></td></tr></table></figure>
<h4 id="limit扩展模块"><a href="#limit扩展模块" class="headerlink" title="limit扩展模块"></a>limit扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">limit</span>模块是对<span class="string">"报文到达速率"</span>进行限制的.如果想要限制单位时间内流入的包的数量，就能用<span class="built_in">limit</span>模块</span></span><br><span class="line"></span><br><span class="line">* --limit</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -m limit --limit 10/minute -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"-p icmp"</span>表示我们针对ping请求添加了一条规则（ping使用icmp协议），<span class="string">"-m limit"</span>表示使用<span class="built_in">limit</span>模块， <span class="string">"--limit 10/minute -j ACCEPT"</span>表示每分钟最多放行10个包，就相当于每6秒钟最多放行一个包</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 5950 packets, 5128996 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1         111     9416 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 10/min burst 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的规则并不会起作用。因为每6秒放行一个包，那么iptables就会计时，每6秒一个轮次，到第6秒时，达到的报文就会匹配到对应的规则，执行对应的动作ACCEPT。那么在第6秒之前到达的包，则无法被上述规则匹配到。那么这些包就要向下匹配策略中的其他规则，如果都不能匹配，就会匹配默认策略，因为默认策略是ACCEPT，所以ping此主机的时候还是会正常运行。</span></span><br><span class="line">[root@bogon ~]# iptables -A INPUT -p icmp -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拒绝所有的ping包</span></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 6 packets, 428 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1         150    12692 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 10/min burst 5</span><br><span class="line">2          56     4704 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一条规则表示每分钟最多放行10个icmp包，也就是6秒放行一个，第6秒的icmp包会被上例中的第一条规则匹配到，第6秒之前的包则不会被第一条规则匹配到，于是被后面的拒绝规则匹配到了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时再ping此主机时就可以发现每6秒才能ping通一次了。但还有一个问题，就是最开始的5个ping包是不受限制的，可以正常ping通。现象如下，下面解释原因</span></span><br><span class="line">[root@test ~]# ping 10.5.5.22</span><br><span class="line">PING 10.5.5.22 (10.5.5.22) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=1 ttl=64 time=0.248 ms</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=2 ttl=64 time=0.355 ms</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=3 ttl=64 time=0.332 ms</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=4 ttl=64 time=0.261 ms</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=5 ttl=64 time=0.528 ms</span><br><span class="line">From 10.5.5.22 icmp_seq=6 Destination Port Unreachable</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=7 ttl=64 time=0.418 ms</span><br><span class="line">From 10.5.5.22 icmp_seq=8 Destination Port Unreachable</span><br><span class="line">From 10.5.5.22 icmp_seq=9 Destination Port Unreachable</span><br><span class="line">From 10.5.5.22 icmp_seq=10 Destination Port Unreachable</span><br><span class="line">From 10.5.5.22 icmp_seq=11 Destination Port Unreachable</span><br><span class="line">From 10.5.5.22 icmp_seq=12 Destination Port Unreachable</span><br><span class="line">64 bytes from 10.5.5.22: icmp_seq=13 ttl=64 time=0.435 ms</span><br><span class="line">From 10.5.5.22 icmp_seq=14 Destination Port Unreachable</span><br><span class="line">From 10.5.5.22 icmp_seq=15 Destination Port Unreachable</span><br><span class="line"></span><br><span class="line">* --limit-burst</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"--limit-burst"</span>可以指定<span class="string">"空闲时可放行的包的数量。在不使用"</span>--<span class="built_in">limit</span>-burst<span class="string">"选项明确指定放行包的数量时，默认值为5，所以才会有上面的现象。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果想要彻底了解<span class="built_in">limit</span>模块的工作原理，我们需要先了解一下<span class="string">"令牌桶"</span>算法，因为<span class="built_in">limit</span>模块使用了令牌桶算法。我们可以这样想象，有一个木桶，木桶里面放了5块令牌，而且这个木桶最多也只能放下5块令牌，所有报文如果想要出关入关，都必须要持有木桶中的令牌才行，这个木桶有一个神奇的功能，就是每隔6秒钟会生成一块新的令牌，如果此时，木桶中的令牌不足5块，那么新生成的令牌就存放在木桶中，如果木桶中已经存在5块令牌，新生成的令牌就无处安放了，只能溢出木桶（令牌被丢弃），如果此时有5个报文想要入关，那么这5个报文就去木桶里找令牌，正好一人一个，于是他们5个手持令牌，快乐的入关了，此时木桶空了，再有报文想要入关，已经没有对应的令牌可以使用了，但是，过了6秒钟，新的令牌生成了，此刻，正好来了一个报文想要入关，于是，这个报文拿起这个令牌，就入关了，在这个报文之后，如果很长一段时间内没有新的报文想要入关，木桶中的令牌又会慢慢的积攒了起来，直到达到5个令牌，并且一直保持着5个令牌，直到有人需要使用这些令牌，这就是令牌桶算法的大致逻辑。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"--limit"</span>选项就是用于指定<span class="string">"多长时间生成一个新令牌的"</span>，<span class="string">"--limit-burst"</span>选项就是用于指定<span class="string">"木桶中最多存放几个令牌的"</span></span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p icmp -m limit --limit-burst 1 --limit 10/minute -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="string">"--limit"</span>选项时，可以选择的时间单位有多种，如：/second、/minute、/hour、/day。比如，3/second表示每秒生成3个<span class="string">"令牌"</span>，30/minute表示没分钟生成30个<span class="string">"令牌"</span>。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables --line -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 174 packets, 11316 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1          13     1092 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 10/min burst 1</span><br><span class="line">2         194    16296 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>
<h4 id="state扩展模块"><a href="#state扩展模块" class="headerlink" title="state扩展模块"></a>state扩展模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 对于state模块而言的<span class="string">"连接"</span>并不能与tcp的<span class="string">"连接"</span>画等号，在TCP/IP协议簇中，UDP和ICMP是没有所谓的连接的，但是对于state模块来说，tcp报文、udp报文、icmp报文都是有连接状态的。对于state模块而言，只要两台机器在<span class="string">"你来我往"</span>的通信，就算建立起了连接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> state模块中的报文状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NEW：连接中的第一个包，状态就是NEW，我们可以理解为新连接的第一个包的状态为NEW。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ESTABLISHED：我们可以把NEW状态包后面的包的状态理解为ESTABLISHED，表示连接已建立。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RELATED：从字面上理解RELATED译为关系、相关的，但是这样仍然不容易理解，我们举个例子。比如FTP服务，FTP服务端会建立两个进程，一个命令进程，一个数据进程。命令进程负责服务端与客户端之间的命令传输（我们可以把这个传输过程理解成state中所谓的一个<span class="string">"连接"</span>，暂称为<span class="string">"命令连接"</span>）。数据进程负责服务端与客户端之间的数据传输 ( 我们把这个过程暂称为<span class="string">"数据连接"</span> )。但是具体传输哪些数据，是由命令去控制的，所以，<span class="string">"数据连接"</span>中的报文与<span class="string">"命令连接"</span>是有<span class="string">"关系"</span>的。那么，<span class="string">"数据连接"</span>中的报文可能就是RELATED状态，因为这些报文与<span class="string">"命令连接"</span>中的报文有关系。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># (注：如果想要对ftp进行连接追踪，需要单独加载对应的内核模块nf_conntrack_ftp，如果想要自动加载，可以配置/etc/sysconfig/iptables-config文件)</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> INVALID：如果一个包没有办法被识别，或者这个包没有任何状态，那么这个包的状态就是INVALID，我们可以主动屏蔽状态为INVALID的报文。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> UNTRACKED：报文的状态为untracked时，表示报文未被追踪，当报文的状态为Untracked时通常表示无法找到相关的连接。</span></span><br><span class="line"></span><br><span class="line">[root@bogon ~]# iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -A INPUT -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将状态为RELATED和ESTABLISHED的报文都放行，这样，就表示只有回应我们的报文能够通过防火墙，如果是别人主动发送过来的新的报文，则无法通过防火墙。如想通过ssh连接本机，是不行的，但本机可以ssh连接其他主机。</span></span><br></pre></td></tr></table></figure>
<h3 id="黑白名单机制"><a href="#黑白名单机制" class="headerlink" title="黑白名单机制"></a>黑白名单机制</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当链的默认策略为ACCEPT时，链中的规则对应的动作应该为DROP或者REJECT，表示只有匹配到规则的报文才会被拒绝，没有被规则匹配到的报文都会被默认接受，这就是<span class="string">"黑名单"</span>机制。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当链的默认策略为DROP时，链中的规则对应的动作应该为ACCEPT，表示只有匹配到规则的报文才会被放行，没有被规则匹配到的报文都会被默认拒绝，这就是<span class="string">"白名单"</span>机制。</span></span><br><span class="line"></span><br><span class="line">* 白名单</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -I INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -P INPUT DROP</span><br><span class="line">[root@bogon ~]# iptables --line -nxvL INPUT</span><br><span class="line">Chain INPUT (policy DROP 336 packets, 17902 bytes)</span><br><span class="line">num      pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">1           0        0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line">2         130     9172 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 放行22与80端口，并将默认策略改为DROP，这样其他端口都是无法访问的。因为只改了INPUT链为DROP，OUTPUT链的默认策略还是ACCEPT，所以可以访问80与22端口。如果OUTPUT的默认策略也是DROP，那就要再写两条出的规则。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果此时有误操作，删除了防火墙规则，那么所有连接就都无法进来了。也就是无法通过远程连接主机了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果想要使用<span class="string">"白名单"</span>的机制，最好将链的默认策略保持为<span class="string">"ACCEPT"</span>，然后将<span class="string">"拒绝所有请求"</span>这条规则放在链的尾部，将<span class="string">"放行规则"</span>放在前面，这样做，既能实现<span class="string">"白名单"</span>机制，又能保证在规则被清空时，管理员还有机会连接到主机</span></span><br><span class="line">[root@bogon ~]# iptables -P INPUT ACCEPT</span><br><span class="line">[root@bogon ~]# iptables -A INPUT -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当所有放行规则设置完成后，在INPUT链的尾部，设置一条拒绝所有请求的规则。这样就能必免上面的问题了</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">54</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
