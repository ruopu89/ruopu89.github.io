<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/3/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/20/varnish使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/20/varnish使用/" itemprop="url">
                  varnish使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-20 10:16:40 / 修改時間：11:54:26" itemprop="dateCreated datePublished" datetime="2019-06-20T10:16:40+08:00">2019-06-20</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/缓存服务/" itemprop="url" rel="index"><span itemprop="name">缓存服务</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">yum install -y varnish </span><br><span class="line">yum install -y varnish-docs.x86_64</span><br></pre></td></tr></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/varnish:</span><br><span class="line">NFILES=131072        # 所能够打开的最大文件数</span><br><span class="line">MEMLOCK=82000       # 用多大内存空间保存日志信息</span><br><span class="line">NPROCS="unlimited"</span><br><span class="line">DAEMON_COREFILE_LIMIT="unlimited"    # 进程核心转储所使用的内存空间，unlimited表示无上限</span><br><span class="line">RELOAD_VCL=1        # 重新启动服务时是否重新读取VCL并重新编译的</span><br><span class="line">VARNISH_VCL_CONF=/etc/varnish/config/default.vcl        # 默认读取的VCL文件</span><br><span class="line">VARNISH_LISTEN_PORT=6081        # 监听的端口，默认监听6081</span><br><span class="line">VARNISH_ADMIN_LISTEN_ADDRESS=127.0.0.1        # 管理接口监听的地址</span><br><span class="line">VARNISH_ADMIN_LISTEN_PORT=6082        # 管理接口监听的端口</span><br><span class="line">VARNISH_SECRET_FILE=/etc/varnish/secret        # 使用的密钥文件</span><br><span class="line">VARNISH_MIN_THREADS=50        # 最少线程数</span><br><span class="line">VARNISH_MAX_THREADS=1000        # 最大线程数</span><br><span class="line">VARNISH_THREAD_TIMEOUT=120        # 线程的超时时间</span><br><span class="line">VARNISH_STORAGE_SIZE=2046M        # 存储文件的大小</span><br><span class="line">VARNISH_STORAGE="malloc,$&#123;VARNISH_STORAGE_SIZE&#125;"        # 存储的文件格式</span><br><span class="line"><span class="meta">#</span><span class="bash"> file：单个文件，不支持持久机制</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> malloc：内存</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> persistent：基于文件的持久存储</span></span><br><span class="line">VARNISH_TTL=120       # 联系后端服务器的超时时间</span><br><span class="line">DAEMON_OPTS="-a $&#123;VARNISH_LISTEN_ADDRESS&#125;:$&#123;VARNISH_LISTEN_PORT&#125; \</span><br><span class="line">             -f $&#123;VARNISH_VCL_CONF&#125; \</span><br><span class="line">             -T $&#123;VARNISH_ADMIN_LISTEN_ADDRESS&#125;:$&#123;VARNISH_ADMIN_LISTEN_PORT&#125; \</span><br><span class="line">             -t $&#123;VARNISH_TTL&#125; \</span><br><span class="line">             -p thread_pool_min=$&#123;VARNISH_MIN_THREADS&#125; \</span><br><span class="line">             -p thread_pool_max=$&#123;VARNISH_MAX_THREADS&#125; \</span><br><span class="line">             -p thread_pool_timeout=$&#123;VARNISH_THREAD_TIMEOUT&#125; \</span><br><span class="line">             -u varnish -g varnish \</span><br><span class="line">             -S $&#123;VARNISH_SECRET_FILE&#125; \</span><br><span class="line">             -s $&#123;VARNISH_STORAGE&#125;"       # 使用定义的各高级配置的参数</span><br></pre></td></tr></table></figure>
<h4 id="vcl文件"><a href="#vcl文件" class="headerlink" title="vcl文件"></a>vcl文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/varnish/default.vcl</span><br><span class="line">vcl 4.0;</span><br><span class="line"></span><br><span class="line">backend default &#123;</span><br><span class="line">    .host = "192.168.1.109";		# 后端服务器地址</span><br><span class="line">    .port = "80";		# 后端服务器端口</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 目前只测试varnish是否可以正常工作，尚未定义缓存属性信息</span></span><br><span class="line">systemctl start varnish</span><br></pre></td></tr></table></figure>
<h4 id="安装配置web服务"><a href="#安装配置web服务" class="headerlink" title="安装配置web服务"></a>安装配置web服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y httpd php php-mysql</span><br><span class="line">vim /var/www/html/index.html</span><br><span class="line">&lt;h1&gt;www.abc.com and varnish of backend&lt;/h1&gt;</span><br><span class="line">&lt;h2&gt;node1.abc.com&lt;/h2&gt;</span><br><span class="line">systemctl start httpd</span><br><span class="line">访问IP:80</span><br><span class="line">访问IP:6081</span><br></pre></td></tr></table></figure>
<h4 id="设置响应是否命中"><a href="#设置响应是否命中" class="headerlink" title="设置响应是否命中"></a>设置响应是否命中</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim default.vcl</span><br><span class="line">sub vcl_deliver &#123;</span><br><span class="line">    if (obj.hits &gt; 0)&#123;</span><br><span class="line">        set resp.http.X-Cache = "HIT from";</span><br><span class="line">        # 判断如果命中了就在http响应首部设置X-Cache为HIT</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        set resp.http.X-Cache = "MISS";</span><br><span class="line">        # 否则就在http响应首部设置X-Cache为MISS</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的语法是<span class="keyword">if</span>(条件)&#123;方法&#125;<span class="keyword">else</span>&#123;方法&#125;，如果满足<span class="keyword">if</span>后面小括号中的条件，就执行小括号后面大括号中的方法，否则执行<span class="keyword">else</span>后面大括号中的方法。</span></span><br><span class="line">varnishadm -S /etc/varnish/secret -T 127.0.0.1:6082</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接varnish，进入varnish的命令操作</span></span><br><span class="line">vcl.load test1 /etc/varnish/default.vcl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在命令行中输入上面命令，加载default.vcl文件，test1是自定义的名称，这应该是一个策略的名称，策略的名称每次都不能一样。</span></span><br><span class="line">vcl.list</span><br><span class="line">vcl.show test1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看test1的策略内容</span></span><br><span class="line">访问IP:6081，之后按F12查看是否有X-Cache一项，如果没有此项，可以重启一下varnish。之后可以看到X-Cache一项为MISS，再次刷新后，此项变为HIT。</span><br></pre></td></tr></table></figure>
<h4 id="指定某些文件不能查缓存"><a href="#指定某些文件不能查缓存" class="headerlink" title="指定某些文件不能查缓存"></a>指定某些文件不能查缓存</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim default.vcl</span><br><span class="line">vcl 4.0;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Default backend definition. Set this to point to your content server.</span></span><br><span class="line">backend default &#123;</span><br><span class="line">    .host = "192.168.1.109";</span><br><span class="line">    .port = "80";</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_recv &#123;</span><br><span class="line"> if (req.url ~ "test.html")&#123;</span><br><span class="line">   return(pass);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">return</span>(lookup);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里不可以加<span class="built_in">return</span>(lookup)，因为varnish4中使用<span class="built_in">return</span>(<span class="built_in">hash</span>)代替了<span class="built_in">return</span>(lookup)。</span></span><br><span class="line">vcl.load test2 /etc/varnish/default.vcl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加载策略</span></span><br><span class="line">访问IP:6081/test.html，无论如何刷新，F12中的x-cache都是MISS</span><br></pre></td></tr></table></figure>
<h4 id="vcl配置文件"><a href="#vcl配置文件" class="headerlink" title="vcl配置文件"></a>vcl配置文件</h4><h5 id="VCL中内置预设变量"><a href="#VCL中内置预设变量" class="headerlink" title="VCL中内置预设变量"></a>VCL中内置预设变量</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">req：The request object，请求到达时可用的变量(客户端发送的请求对象)</span><br><span class="line">bereq：The backend request object，向后端主机请求时可用的变量</span><br><span class="line">beresp：The backend response object，从后端主机获取内容时可用的变量(后端响应请求对象)</span><br><span class="line">resp：The HTTP response object，对客户端响应时可用的变量(返回给客户端的响应对象)</span><br><span class="line">obj：存储在内存中时对象属性相关的可用的变量(高速缓存对象，缓存后端响应请求内容)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">预设变量是系统固定的，请求进入对应的vcl子程序后便生成，这些变量可以方便子程序提取，当然也可以自定义一些全局变量。</span><br><span class="line">当前时间：</span><br><span class="line">now :作用：返回当前时间戳。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">客户端：（客户端基本信息）</span><br><span class="line">client.ip：返回客户端IP地址。</span><br><span class="line">注：原client.port已经弃用，如果要取客户端请求端口号使用 std.port(client.ip)，需要import std;才可以使用std</span><br><span class="line">client.identity：用于装载客户端标识码。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">服务器：（服务器基本信息）</span><br><span class="line">注：原server.port已经弃用，如果要取服务器端口号使用 std.port(server.ip)，需要import std;才可以使用std</span><br><span class="line">server.hostname：服务器主机名。</span><br><span class="line">server.identity：服务器身份标识。</span><br><span class="line">server.ip：返回服务器端IP地址。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">req :（客户端发送的请求对象）</span><br><span class="line">req：整个HTTP请求数据结构</span><br><span class="line">req.backend_hint：指定请求后端节点，设置后 bereq.backend 才能获取后端节点配置数据</span><br><span class="line">req.can_gzip：客户端是否接受GZIP传输编码。</span><br><span class="line">req.hash_always_miss：是否强制不命中高速缓存，如果设置为true，则高速缓存不会命中，一直会从后端获取新数据。</span><br><span class="line">req.hash_ignore_busy：忽略缓存中忙碌的对象，多台缓存时可以避免死锁。</span><br><span class="line">req.http：对应请求HTTP的header。</span><br><span class="line">req.method：请求类型（如 GET , POST）。</span><br><span class="line">req.proto：客户端使用的HTTP协议版本。</span><br><span class="line">req.restarts：重新启动次数。默认最大值是4</span><br><span class="line">req.ttl：缓存有剩余时间。</span><br><span class="line">req.url：请求的URL。</span><br><span class="line">req.xid：唯一ID。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bereq：（发送到后端的请求对象，基于req对象）</span><br><span class="line">bereq：整个后端请求后数据结构。</span><br><span class="line">bereq.backend：所请求后端节点配置。</span><br><span class="line">bereq.between_bytes_timeout：从后端每接收一个字节之间的等待时间（秒）。</span><br><span class="line">bereq.connect_timeout：连接后端等待时间（秒），最大等待时间。</span><br><span class="line">bereq.first_byte_timeout：等待后端第一个字节时间（秒），最大等待时间。</span><br><span class="line">bereq.http：对应发送到后端HTTP的header信息。</span><br><span class="line">bereq.method：发送到后端的请求类型（如：GET , POST）。</span><br><span class="line">bereq.proto：发送到后端的请求的HTTP版本。</span><br><span class="line">bereq.retries：相同请求重试计数。</span><br><span class="line">bereq.uncacheable：无缓存这个请求。</span><br><span class="line">bereq.url：发送到后端请求的URL。</span><br><span class="line">bereq.xid：请求唯一ID。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">beresp：（后端响应请求对象）</span><br><span class="line">beresp：整个后端响应HTTP数据结构。</span><br><span class="line">beresp.backend.ip：后端响应的IP。</span><br><span class="line">beresp.backend.name：响应后端配置节点的name。</span><br><span class="line">beresp.do_gunzip：默认为 false 。缓存前解压该对象</span><br><span class="line">beresp.do_gzip：默认为 false 。缓存前压缩该对象</span><br><span class="line">beresp.grace：设置当前对象缓存过期后可额外宽限时间，用于特殊请求加大缓存时间，当并发量巨大时，不易设置过大否则会堵塞缓存，一般可设置 1m 左右，当beresp.ttl=0s时该值无效。</span><br><span class="line">beresp.http：对应的HTTP请求header</span><br><span class="line">beresp.keep：对象缓存后带保持时间</span><br><span class="line">beresp.proto：响应的HTTP版本</span><br><span class="line">beresp.reason：由服务器返回的HTTP状态信息</span><br><span class="line">beresp.status：由服务器返回的状态码</span><br><span class="line">beresp.storage_hint：指定保存的特定存储器</span><br><span class="line">beresp.ttl：该对象缓存的剩余时间，指定统一缓存剩余时间。</span><br><span class="line">beresp.uncacheable：继承bereq.uncacheable，是否不缓存</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OBJ ：（高速缓存对象，缓存后端响应请求内容）</span><br><span class="line">obj.grace：该对象额外宽限时间</span><br><span class="line">obj.hits：缓存命中次数，计数器从1开始，当对象缓存该值为1，一般可以用于判断是否有缓存，当前该值大于0时则为有缓存。</span><br><span class="line">obj.http：对应HTTP的header</span><br><span class="line">obj.proto：HTTP版本</span><br><span class="line">obj.reason：服务器返回的HTTP状态信息</span><br><span class="line">obj.status：服务器返回的状态码</span><br><span class="line">obj.ttl：该对象缓存剩余时间（秒）</span><br><span class="line">obj.uncacheable：不缓存对象</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">resp :（返回给客户端的响应对象）</span><br><span class="line">resp：整个响应HTTP数据结构。</span><br><span class="line">resp.http：对应HTTP的header。</span><br><span class="line">resp.proto：编辑响应的HTTP协议版本。</span><br><span class="line">resp.reason：将要返回的HTTP状态信息。</span><br><span class="line">resq.status：将要返回的HTTP状态码。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">存储 ：</span><br><span class="line">storage.&lt;name&gt;.free_space：存储可用空间（字节数）。</span><br><span class="line">storage.&lt;name&gt;.used_space：存储已经使用空间（字节数）。</span><br><span class="line">storage.&lt;name&gt;.happy：存储健康状态。</span><br></pre></td></tr></table></figure>
<h5 id="特定功能性语句"><a href="#特定功能性语句" class="headerlink" title="特定功能性语句"></a>特定功能性语句</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">ban(expression)：清除指定对象缓存</span><br><span class="line">call(subroutine)：调用子程序，如：call(name);</span><br><span class="line">hash_data(input)：生成hash键，用于制定hash键值生成结构，只能在vcl_hash子程序中使用。调用hash_data(input) 后，即这个hash为当前页面的缓存hash键值，无需其它获取或操作，如:</span><br><span class="line">=======================================================================================</span><br><span class="line">sub vcl_hash&#123;</span><br><span class="line">       hash_data(client.ip);</span><br><span class="line">       return(lookup);</span><br><span class="line">&#125;</span><br><span class="line">=======================================================================================</span><br><span class="line">注意：return(lookup);是默认返回值，所以可以不写。</span><br><span class="line">new()：创建一个vcl对象，只能在vcl_init子程序中使用。</span><br><span class="line">return()：结束当前子程序，并指定继续下一步动作，如：return (ok); 每个子程序可指定的动作均有不同。</span><br><span class="line">rollback()：恢复HTTP头到原来状态，已经弃用，使用 std.rollback() 代替。</span><br><span class="line">synthetic(STRING)：合成器，用于自定义一个响应内容，比如当请求出错时，可以返回自定义 404 内容，而不只是默认头信息，只能在 vcl_synth 与 vcl_backend_error 子程序中使用，如：</span><br><span class="line">=======================================================================================</span><br><span class="line">sub vcl_synth &#123;</span><br><span class="line">    //自定义内容</span><br><span class="line">    synthetic (&#123;"</span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;</span><br><span class="line">&lt;html lang="zh-cn"&gt;</span><br><span class="line">   &lt;head&gt;</span><br><span class="line">   &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt;</span><br><span class="line">      &lt;title&gt;error&lt;/title&gt;</span><br><span class="line">   &lt;/head&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">      &lt;h1&gt;Error&lt;/h1&gt;</span><br><span class="line">      &lt;h3&gt;这只是一个测试自定义响应异常内容&lt;/h3&gt;</span><br><span class="line">   &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">    "&#125;);</span><br><span class="line">    //只交付自定义内容</span><br><span class="line">    return(deliver);</span><br><span class="line">=======================================================================================</span><br><span class="line">regsub(str, regex, sub)：使用正则替换第一次出现的字符串，第一个参数为待处理字符串，第二个参数为正则表达式，第三个为替换为字符串。</span><br><span class="line">regsuball(str, regex, sub)：使用正则替换所有匹配字符串。参数与regsuball相同。</span><br><span class="line">具体变量详见：</span><br><span class="line">https://www.varnish-cache.org/docs/4.0/reference/vcl.html#reference-vcl</span><br></pre></td></tr></table></figure>
<h5 id="return-语句"><a href="#return-语句" class="headerlink" title="return 语句"></a>return 语句</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">return 语句是终止子程序并返回动作，所有动作都根据不同的vcl子程序限定来选用。</span><br><span class="line">https://www.varnish-cache.org/docs/4.0/users-guide/vcl-built-in-subs.html</span><br><span class="line"></span><br><span class="line">语法：return(action);</span><br><span class="line">常用的动作：</span><br><span class="line">abandon  放弃处理，并生成一个错误。</span><br><span class="line">deliver  交付处理</span><br><span class="line">fetch  从后端取出响应对象</span><br><span class="line">hash  哈希缓存处理</span><br><span class="line">lookup 查找缓存对象</span><br><span class="line">ok 继续执行</span><br><span class="line">pass  进入pass非缓存模式</span><br><span class="line">pipe 进入pipe非缓存模式</span><br><span class="line">purge 清除缓存对象，构建响应</span><br><span class="line">restart 重新开始</span><br><span class="line">retry 重试后端处理</span><br><span class="line">synth(status code,reason) 合成返回客户端状态信息</span><br></pre></td></tr></table></figure>
<h5 id="varnish中内置子程序"><a href="#varnish中内置子程序" class="headerlink" title="varnish中内置子程序"></a>varnish中内置子程序</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">注意：varnish内置子程序均有自己限定的返回动作  return （动作）;  不同的动作将调用对应下一个子程序。</span><br><span class="line"></span><br><span class="line">vcl_recv子程序：</span><br><span class="line">开始处理请求，通过 return (动作); 选择varnish处理模式，默认进入hash缓存模式（即return(hash);），缓存时间为配置项default_ttl（默认为 120秒）过期保持时间default_grace（默认为10秒）。该子程序一般用于模式选择，请求对象缓存及信息修改，后端节点修改，终止请求等操作。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line">pass  进入pass模式，并进入vcl_pass子程序。</span><br><span class="line">pipe  进入pipe模式，并进入vcl_pipe子程序。</span><br><span class="line">hash  进入hash缓存模式，并进入vcl_hash子程序，默认返回值。</span><br><span class="line">purge  清除缓存等数据，子程序先从vcl_hash再到vcl_purge。</span><br><span class="line"></span><br><span class="line">vcl_pipe子程序：</span><br><span class="line">pipe模式处理，该模式主要用于直接取后端响应内容返回客户端，可定义响应内容返回客户端。该子程序一般用于需要及时且不作处理的后端信息，取出后端响应内容后直接交付到客户端不进入vcl_deliver子程序处理。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，bereq，req，storage</span><br><span class="line">写：client，bereq，req</span><br><span class="line">返回值：</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line">pipe  继续pipe模式，进入后端vcl_backend_fetch子程序，默认返回值。</span><br><span class="line"></span><br><span class="line">vcl_pass子程序：</span><br><span class="line">pass模式处理，该模式类似hash缓存模式，仅不做缓存处理。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line">fetch  继续pass模式，进入后端vcl_backend_fetch子程序，默认返回值。</span><br><span class="line"></span><br><span class="line">vcl_hit子程序：</span><br><span class="line">hash缓存模式时，存在hash缓存时调用，用于缓存处理，可放弃或修改缓存。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，obj，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">restart 重启请求。</span><br><span class="line">deliver 交付缓存内容，进入vcl_deliver子程序处理，默认返回值。</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line"></span><br><span class="line">vcl_miss子程序：</span><br><span class="line">hash缓存模式时，不存在hash缓存时调用，用于判断性的选择进入后端取响应内容，可以修改为pass模式。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">restart 重启请求。</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line">pass 切换到pass模式，进入vcl_pass子程序。</span><br><span class="line">fetch  正常取后端内容再缓存，进入vcl_backend_fetch子程序，默认返回值。</span><br><span class="line"></span><br><span class="line">vcl_hash子程序：</span><br><span class="line">hash缓存模式，生成hash值作为缓存查找键名提取缓存内容，主要用于缓存hash键值处理，可使用hash_data(string)指定键值组成结构，可在同一个页面通过IP或cookie生成不同的缓存键值。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">lookup 查找缓存对象，存在缓存进入vcl_hit子程序，不存在缓存进入vcl_miss子程序，当使用了purge清理模式时会进入vcl_purge子程序，默认返回值。</span><br><span class="line"></span><br><span class="line">vcl_purge子程序：</span><br><span class="line">清理模式，当查找到对应的缓存时清除并调用，用于请求方法清除缓存，并报告.</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，storage</span><br><span class="line">写：client，req</span><br><span class="line">返回值：</span><br><span class="line">synth(status code,reason);  定义响应内容。</span><br><span class="line">restart 重启请求。</span><br><span class="line"></span><br><span class="line">vcl_deliver子程序：</span><br><span class="line">客户端交付子程序，在vcl_backend_response子程序后调用（非pipe模式），或vcl_hit子程序后调用，可用于追加响应头信息，cookie等内容。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，resp，obj，storage</span><br><span class="line">写：client，req，resp</span><br><span class="line">返回值：</span><br><span class="line">deliver 正常交付后端或缓存响应内容，默认返回值。</span><br><span class="line">restart 重启请求。</span><br><span class="line"></span><br><span class="line">vcl_backend_fetch子程序：</span><br><span class="line">发送后端请求之前调用，可用于改变请求地址或其它信息，或放弃请求。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：server，bereq，storage</span><br><span class="line">写：bereq</span><br><span class="line">返回值：</span><br><span class="line">fetch 正常发送请求到到后端取出响应内容，进入vcl_backend_response子程序，默认返回值。</span><br><span class="line">abandon 放弃后端请求，并生成一个错误，进入vcl_backend_error子程序。</span><br><span class="line"></span><br><span class="line">vcl_backend_response子程序：</span><br><span class="line">后端响应后调用，可用于修改缓存时间及缓存相关信息。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：server，bereq，beresp，storage</span><br><span class="line">写：bereq，beresp</span><br><span class="line">返回值：</span><br><span class="line">deliver 正常交付后端响应内容，进入vcl_deliver子程序，默认返回值。</span><br><span class="line">abandon 放弃后端请求，并生成一个错误，进入vcl_backend_error子程序。</span><br><span class="line">retry 重试后端请求，重试计数器加1，当超过配置中max_retries值时会报错并进入vcl_backend_error子程序。</span><br><span class="line"></span><br><span class="line">vcl_backend_error子程序：</span><br><span class="line">后端处理失败调用，异常页面展示效果处理，可自定义错误响应内容，或修改beresp.status与beresp.http.Location重定向等。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：server，bereq，beresp，storage</span><br><span class="line">写：bereq，beresp</span><br><span class="line">返回值：</span><br><span class="line">deliver 只交付 sysnthetic(string) 自定义内容，默认返回后端异常标准错误内容。</span><br><span class="line">retry 重试后端请求，重试计数器加1，当超过配置中max_retries值时会报错并进入vcl_backend_error子程序。</span><br><span class="line"></span><br><span class="line">vcl_synth子程序：</span><br><span class="line">自定义响应内容。可以通过synthetic（）和返回值 synth调用，这里可以自定义异常显示内容，也可以修改resp.status与resp.http.Location重定向。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：client，server，req，resp，storage</span><br><span class="line">写：req，resp</span><br><span class="line">返回值：</span><br><span class="line">deliver 只交付 sysnthetic(string) 自定义内容，默认返回 sysnth 异常指定状态码与错误内容。</span><br><span class="line">restart 重启请求。</span><br><span class="line"></span><br><span class="line">vcl_init子程序：</span><br><span class="line">加载vcl时最先调用，用于初始化VMODs，该子程序不参与请求处理，仅在vcl加载时调用一次。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：server</span><br><span class="line">写：无</span><br><span class="line">返回值：</span><br><span class="line">ok 正常返回，进入vcl_recv子程序，默认返回值。</span><br><span class="line"></span><br><span class="line">vcl_fini子程序：</span><br><span class="line">卸载当前vcl配置时调用，用于清理VMODs，该子程序不参与请求处理，仅在vcl正常丢弃后调用。</span><br><span class="line">可操作对象：（部分或全部值）</span><br><span class="line">读：server</span><br><span class="line">写：无</span><br><span class="line">返回值：</span><br><span class="line">ok 正常返回，本次vcl将释放，默认返回值。</span><br></pre></td></tr></table></figure>
<p>varnish子程序调用流程图，通过大部分子程序的return返回值进入下一步行动：</p>
<p><img src="/images/varnish/varnish子程序return返回值.png" alt=""></p>
<h5 id="优雅模式-Garce-mode"><a href="#优雅模式-Garce-mode" class="headerlink" title="优雅模式(Garce mode)"></a>优雅模式(Garce mode)</h5><p>Varnish中的请求合并</p>
<p>当几个客户端请求同一个页面的时候，varnish只发送一个请求到后端服务器，然后让其他几个请求挂起并等待返回结果；获得结果后，其它请求再复制后端的结果发送给客户端；</p>
<p>但如果同时有数以千计的请求，那么这个等待队列将变得庞大，这将导致2类潜在问题：</p>
<p>惊群问题(thundering herd problem)，即突然释放大量的线程去复制后端返回的结果，将导致负载急速上升；没有用户喜欢等待；</p>
<p>为了解决这类问题，可以配置varnish在缓存对象因超时失效后再保留一段时间，以给那些等待的请求返回过去的文件内容(stale content)，配置案例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sub vcl_recv &#123;</span><br><span class="line">if (! req.backend.healthy) &#123;</span><br><span class="line">set req.grace = 5m;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">set req.grace = 15s;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">sub vcl_fetch &#123;</span><br><span class="line">set beresp.grace = 30m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上配置表示varnish将会将失效的缓存对象再多保留30分钟，此值等于最大的req.grace值即可；</p>
<p>而根据后端主机的健康状况，varnish可向前端请求分别提供5分钟内或15秒内的过期内容</p>
<h5 id="后端服务器地址池配置及后端服务器健康检查"><a href="#后端服务器地址池配置及后端服务器健康检查" class="headerlink" title="后端服务器地址池配置及后端服务器健康检查"></a>后端服务器地址池配置及后端服务器健康检查</h5><h6 id="后端服务器定义"><a href="#后端服务器定义" class="headerlink" title="后端服务器定义"></a>后端服务器定义</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">命令：backend。这个定义为最基本的反向入口定义，用于varnish连接对应的服务器，如果没有定义或定义错误则用户无法访问正常页面。</span><br><span class="line">语法格式：</span><br><span class="line">backend name&#123;</span><br><span class="line">    .attribute = "value";</span><br><span class="line">&#125;</span><br><span class="line">说明：backend 是定义后端关键字，name 是当前后端节点的别名，多个后端节点时，name 名不能重复，否则覆盖。花括号里面定义当前节点相关的属性（键=值）。除默认节点外其它节点定义后必需有调用，否则varnish无法启动。后端是否正常可以通过std.healthy(backend)判断。</span><br><span class="line"></span><br><span class="line">支持运算符:</span><br><span class="line">=   （赋值运算）</span><br><span class="line">==  （相等比较）</span><br><span class="line">~    （匹配，可以使用正则表达式，或访问控制列表）</span><br><span class="line">!~    （不匹配，可以使用正则表达式，或访问控制列表）</span><br><span class="line">！  （非）</span><br><span class="line">&amp;&amp;   （逻辑与）</span><br><span class="line">||   （逻辑或）</span><br><span class="line"></span><br><span class="line">属性列表：</span><br><span class="line">.host="xxx.xxx.xxx.xxx";      //要转向主机（即后端主机）的IP或域名，必填键/值对。</span><br><span class="line">.port="8080";        //主机连接端口号或协议名（HTTP等），默认80</span><br><span class="line">.host_header='';    //请示主机头追加内容</span><br><span class="line">.connect_timeout=1s;     //连接后端的超时时间</span><br><span class="line">.first_byte_timeout=5s;    //等待从后端返回的第一个字节时间</span><br><span class="line">.between_bytes_timeout=2s;     //每接收一个字节之间等待时间</span><br><span class="line">.probe=probe_name;        //监控后端主机的状态,指定外部监控name或者内部直接添加</span><br><span class="line">.max_connections=200;    //设置最大并发连接数，超过这个数后连接就会失败</span><br><span class="line"></span><br><span class="line">例：（下面两个例子结果是一样的，但第二个例子中更适用于集群，可以方便批量修改）</span><br><span class="line">backend web&#123;</span><br><span class="line">    .host="192.168.197.180";</span><br><span class="line">    .port="80";</span><br><span class="line">    .probe=&#123;          //直接追加监控块.probe是一个的参数</span><br><span class="line">        .url="/";</span><br><span class="line">        .timeout=2s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">或</span><br><span class="line">probe web_probe&#123;   //监控必需定义在前面，否则后端调用找不到监控块。</span><br><span class="line">    .url="/";</span><br><span class="line">    .timeout=2s;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">backend web&#123;</span><br><span class="line">    .host="192.168.197.180";</span><br><span class="line">    .port="80";</span><br><span class="line">    .probe=web_probe;   //调用外部共用监控块</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="监视器定义"><a href="#监视器定义" class="headerlink" title="监视器定义"></a>监视器定义</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">命令：probe 。监控可以循环访问指定的地址，通过响应时间判定服务器是否空闲或正常。这类命令非常适用于集群中某些节点服务器崩溃或负载过重，而禁止访问这台节点服务器。</span><br><span class="line">语法格式：</span><br><span class="line">probe name&#123;</span><br><span class="line">    .attribute = "value";</span><br><span class="line">&#125;</span><br><span class="line">说明：probe 是定义监控关键字，name 是当前监控点的别名，多个监控节点时，name 名不能重复，否则覆盖。花括号里面定义当前节点相关的属性（键=值）。</span><br><span class="line">没有必填属性，因为默认值就可以正常执行操作。</span><br><span class="line"></span><br><span class="line">属性列表：</span><br><span class="line">.url="/";    //指定监控入口URL地址，默认为"/"</span><br><span class="line">.request="";   //指定监控请求入口地址，比 .url 优先级高。</span><br><span class="line">.expected_response="200";   //请求响应代码，默认是 200</span><br><span class="line">.timeout=2s;   //请求超时时间。</span><br><span class="line">.interval=5s;     //每次轮询请求间隔时间,默认为 5s 。</span><br><span class="line">.initial=-1;     //初始启动时以.window轮询次数中几次良好后续才能使用这个后端服务器节点，默认为 -1 ，则轮询完 .window 所有次数良好判定为正常。</span><br><span class="line">.window=8;   //指定多少轮询次数，用于判定服务器正常，默认是 8。</span><br><span class="line">.threshold=3;   //必须多少次轮询正常才算该后端节点服务器正常,默认是 3。</span><br><span class="line"></span><br><span class="line">例：创建健康监测，定义健康检查名称为backend_healthcheck</span><br><span class="line">probe backend_healthcheck &#123;</span><br><span class="line">        .url = "/";</span><br><span class="line">        .timeout = 1s;</span><br><span class="line">        .interval = 5s;</span><br><span class="line">        .window = 5;</span><br><span class="line">        .threshold = 3;</span><br><span class="line">    &#125;</span><br><span class="line">在上面的例子中varnish将每5s检测后端，超时设为1s。每个检测将会发送get /的请求。如果5个检测中大于3个是成功，varnish就认为后端是健康的，反之，后端就有问题了。</span><br></pre></td></tr></table></figure>
<h6 id="集群负载均衡directors"><a href="#集群负载均衡directors" class="headerlink" title="集群负载均衡directors"></a>集群负载均衡directors</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">varnish可以定义多个后端，也可以将几个后端放在一个后端集群里面已达到负载均衡的目的。</span><br><span class="line">你也可以将几个后端组成一组后端。这个组被叫做Directors。可以提高性能和弹性。</span><br><span class="line">directors是varnish负载均衡模块，使用前必需引入directors模块，directors模块主要包含：</span><br><span class="line">round_robin，random，hash，fallback负载均衡模式。</span><br><span class="line">round_robin : 循环依次逐个选择后端服务器。</span><br><span class="line">random ： 随机选择后端服务器，可设置每个后端权重增加随机率。</span><br><span class="line">hash :  通过散列随机选择对应的后端服务器且保持选择对应关系，下次则直接找对应的后端服务器。</span><br><span class="line">Fallback:后备</span><br><span class="line">注意：random，hash有权重值设置，用于提高随机率。每个后端最好都配置监控器（后端服务器正常监测）以便directors自动屏蔽不正常后端而不进入均衡列队中。</span><br><span class="line">这些操作需要你载入VMOD（varnish module），然后在vcl_init中调用这个VMOD。</span><br><span class="line"></span><br><span class="line">import directors;                # load the directors</span><br><span class="line">backend web1 &#123;</span><br><span class="line">.host = "192.168.197.175";</span><br><span class="line">.port = "80";</span><br><span class="line">.probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">backend web2 &#123;</span><br><span class="line">.host = "192.168.197.176";</span><br><span class="line">.port = "80";</span><br><span class="line">.probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">//初始化处理</span><br><span class="line">sub vcl_init &#123;            //调用vcl_init初始化子程序创建后端主机组，即directors</span><br><span class="line">    new  web_cluster = directors.round_robin(); //使用new关键字创建drector对象,使用round_robin算法</span><br><span class="line">    web_cluster.add_backend(web1);   //添加后端服务器节点</span><br><span class="line">web_cluster.add_backend(web2);</span><br><span class="line">&#125;</span><br><span class="line">//开始处理请求</span><br><span class="line">sub vcl_recv &#123;                     //调用vcl_recv子程序，用于接收和处理请求</span><br><span class="line">    set  req.backend_hint = web_cluster.backend();     //选取后端</span><br><span class="line">&#125;</span><br><span class="line">说明：</span><br><span class="line">set命令是设置变量</span><br><span class="line">unset命令是删除变量</span><br><span class="line">web_cluster.add_backend( backend , real);  添加后端服务器节点，backend 为后端配置别名，real 为权重值，随机率计算公式：100 * (当前权重 / 总权重)。</span><br><span class="line">req.backend_hint是varnish的预定义变量，作用是指定请求后端节点</span><br><span class="line">vcl对象需要使用new关键字创建，所有可创建对象都是内定的，使用前必需import，所有new操作只能在vcl_init子程序中。</span><br><span class="line"></span><br><span class="line">扩展：varnish将不同的url发送到不同的后端server</span><br><span class="line">import directors;                # load the directors</span><br><span class="line">backend web1 &#123;</span><br><span class="line">.host = "192.168.197.175";</span><br><span class="line">.port = "80";</span><br><span class="line">.probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">backend web2 &#123;</span><br><span class="line">.host = "192.168.197.176";</span><br><span class="line">.port = "80";</span><br><span class="line">.probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">backend img1 &#123;</span><br><span class="line">    .host = "img1.lnmmp.com";</span><br><span class="line">    .port = "80";</span><br><span class="line">    .probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">backend img2 &#123;</span><br><span class="line">    .host = "img2.lnmmp.com";</span><br><span class="line">    .port = "80";</span><br><span class="line">    .probe = backend_healthcheck;</span><br><span class="line">&#125;</span><br><span class="line">//初始化处理</span><br><span class="line">sub vcl_init &#123;            //调用vcl_init初始化子程序创建后端主机组，即directors</span><br><span class="line">    new  web_cluster = directors.round_robin(); //使用new关键字创建drector对象,使用round_robin算法</span><br><span class="line">    web_cluster.add_backend(web1);   //添加后端服务器节点</span><br><span class="line">web_cluster.add_backend(web2);</span><br><span class="line">new img_cluster = directors.random();</span><br><span class="line">img_cluster.add_backend(img1,2);   //添加后端服务器节点，并且设置权重值</span><br><span class="line">img_cluster.add_backend(img2,5);</span><br><span class="line">&#125;</span><br><span class="line">//根据不同的访问域名，分发至不同的后端主机组</span><br><span class="line">sub vcl_recv &#123;</span><br><span class="line">if (req.http.host  ~  "(?i)^(www.)?benet.com$") &#123; </span><br><span class="line">        set  req.http.host = "www.benet.com";</span><br><span class="line">        set  req.backend_hint = web_cluster.backend();  //选取后端</span><br><span class="line">    &#125; elsif (req.http.host  ~  "(?i)^images.benet.com$") &#123;</span><br><span class="line">        set  req.backend_hint = img_cluster.backend();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">说明：中的i就是忽略大小写的意思。(?i)表示开启忽略大小写，而(?-i)表示关闭忽略大小写</span><br></pre></td></tr></table></figure>
<h6 id="访问控制列表（ACL）"><a href="#访问控制列表（ACL）" class="headerlink" title="访问控制列表（ACL）"></a>访问控制列表（ACL）</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">创建一个地址列表，用于后面的判断，可以是域名或IP集合。这个可以用于指定某些地址请求入口，防止恶意请求等。</span><br><span class="line">语法格式：</span><br><span class="line">acl  purgers  &#123;</span><br><span class="line">    "127.0.0.1";</span><br><span class="line">"localhost";</span><br><span class="line">“192.168.134.0/24”</span><br><span class="line">    !"192.168.134.1";</span><br><span class="line">&#125;</span><br><span class="line">说明：acl 是访问列表关键字（必需小写），name 是该列表的别名用于调用，花括号内部是地址集。</span><br><span class="line">注意：如果列表中包含了无法解析的主机地址，它会匹配任何地址。</span><br><span class="line">如果不想让它匹配可以在前添加一个 ! 符号，如上面 !"192.168.134.1"; </span><br><span class="line">使用ACL只需要用匹配运算符 ~ 或 !~  如：</span><br><span class="line">sub  vcl_recv &#123;</span><br><span class="line">    if  (req.method == "PURGE") &#123;    //PURGE请求的处理</span><br><span class="line">         if  (client.ip  ~  purgers) &#123;     </span><br><span class="line">              return(purge);</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">            return(synth(403, "Access denied."));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="缓存规则配置"><a href="#缓存规则配置" class="headerlink" title="缓存规则配置"></a>缓存规则配置</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">sub vcl_recv &#123;</span><br><span class="line">  // PURGE请求的处理</span><br><span class="line">  if (req.method == "PURGE") &#123;</span><br><span class="line">    if (!client.ip ~ purgers) &#123;</span><br><span class="line">      return (synth(405, "Not Allowed."));</span><br><span class="line">    &#125;</span><br><span class="line">    return (purge);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  set req.backend_hint = web.backend();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  //将php、asp等动态内容访问请求直接发给后端服务器，不缓存。</span><br><span class="line">  if (req.url ~ "\.(php|asp|aspx|jsp|do|ashx|shtml)($|\?)") &#123;</span><br><span class="line">    return (pass);</span><br><span class="line">  &#125;</span><br><span class="line">  //将非GET和HEAD访问请求直接发给后端服务器，不缓存。例如POST请求。</span><br><span class="line">  if (req.method != "GET" &amp;&amp; req.method != "HEAD") &#123;</span><br><span class="line">        return (pass);</span><br><span class="line">  &#125;</span><br><span class="line">  //如果varnish看到header中有'Authorization'头，它将pass请求。</span><br><span class="line">  if (req.http.Authorization) &#123;</span><br><span class="line">        return (pass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  //带cookie首部的GET请求也缓存</span><br><span class="line">  if (req.url ~ "\.(css|js|html|htm|bmp|png|gif|jpg|jpeg|ico|gz|tgz|bz2|tbz|zip|rar|mp3|mp4|ogg|swf|flv)($|\?)") &#123;</span><br><span class="line">    unset req.http.cookie;</span><br><span class="line">    return (hash);</span><br><span class="line">  &#125;</span><br><span class="line">说明：默认情况，varnish不缓存从后端响应的http头中带有Set-Cookie的对象。如果客户端发送的请求带有Cookie header，varnish将忽略缓存，直接将请求传递到后端。</span><br><span class="line">为发往后端主机的请求添加X-Forward-For首部,首次访问增加X-Forwarded-For 头信息,方便后端程序获取客户端ip，而不是varnish地址</span><br><span class="line"></span><br><span class="line">if (req.restarts == 0) &#123;</span><br><span class="line">        if (req.http.x-forwarded-for) &#123;//如果设置过此header则要再次附加上用逗号隔开</span><br><span class="line">            set req.http.X-Forwarded-For = req.http.X-Forwarded-For + ", " + client.ip;</span><br><span class="line">        &#125; else &#123;//如果只有一层代理的话,就无需设置了</span><br><span class="line">            set req.http.X-Forwarded-For = client.ip;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">说明：X-Forwarded-For是用来识别通过HTTP代理或负载均衡方式连接到Web服务器的客户端最原始的IP地址的HTTP请求头字段</span><br><span class="line">子程序：</span><br><span class="line">子程序是一种类似C的函数，但是程序没有调用参数，子程序以 sub 关键字定义。在VCL里子程序是用于管理程序。</span><br><span class="line">注意：所有VCL内置的程序都是以 vcl_ 开头，并已经预置好，在VCL文件中只要声明对应的内置子程序，都会在对应的流程中调用。</span><br></pre></td></tr></table></figure>
<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line">vcl 4.0;		# 使用varnish版本4的格式.</span><br><span class="line">import std;		# 标准日志需要加载此模块</span><br><span class="line">import directors;		# 加载后端轮询模块，为了可以使用下面的vcl_init</span><br><span class="line"><span class="meta">#</span><span class="bash"> import表示加载varnish模块(VMODs)</span></span><br><span class="line">backend server1 &#123; # Define one backend。定义后端主机，server1是自定义的后端主机名称</span><br><span class="line">  .host = "10.129.14.4";    # Gateway on dl-gw-01</span><br><span class="line">  .port = "8090";           # Port Apache or whatever is listening</span><br><span class="line">  .max_connections = 30000; # That's it</span><br><span class="line"></span><br><span class="line">  .probe = &#123;</span><br><span class="line">    #.url = "/"; # short easy way (GET /)</span><br><span class="line">    # We prefer to only do a HEAD /</span><br><span class="line">    .request =</span><br><span class="line">      "HEAD / HTTP/1.1"</span><br><span class="line">      "Host: localhost"</span><br><span class="line">      "Connection: close"</span><br><span class="line">      "User-Agent: Varnish Health Probe";</span><br><span class="line"></span><br><span class="line">    .interval  = 5s; # check the health of each backend every 5 seconds</span><br><span class="line">    .timeout   = 1s; # timing out after 1 second.</span><br><span class="line">    .window    = 5;  # If 3 out of the last 5 polls succeeded the backend is considered healthy, otherwise it will be marked as sick</span><br><span class="line">    .threshold = 3;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .first_byte_timeout     = 300s;   # How long to wait before we receive a first byte from our backend?</span><br><span class="line">  .connect_timeout        = 5s;     # How long to wait for a backend connection?</span><br><span class="line">  .between_bytes_timeout  = 2s;     # How long to wait between bytes received from our backend?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">backend server2 &#123; # Define one backend</span><br><span class="line">  .host = "10.129.14.5";    #  Gateway on dl-gw-01</span><br><span class="line">  .port = "8090";           # Port Apache or whatever is listening</span><br><span class="line">  .max_connections = 30000; # That's it</span><br><span class="line"></span><br><span class="line">  .probe = &#123;</span><br><span class="line">    #.url = "/"; # short easy way (GET /)</span><br><span class="line">    # We prefer to only do a HEAD /</span><br><span class="line">    .request =</span><br><span class="line">      "HEAD / HTTP/1.1"</span><br><span class="line">      "Host: localhost"</span><br><span class="line">      "Connection: close"</span><br><span class="line">      "User-Agent: Varnish Health Probe";</span><br><span class="line"></span><br><span class="line">    .interval  = 5s; # check the health of each backend every 5 seconds</span><br><span class="line">    .timeout   = 1s; # timing out after 1 second.</span><br><span class="line">    .window    = 5;  # If 3 out of the last 5 polls succeeded the backend is considered healthy, otherwise it will be marked as sick</span><br><span class="line">    .threshold = 3;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .first_byte_timeout     = 300s;   # How long to wait before we receive a first byte from our backend?</span><br><span class="line">  .connect_timeout        = 5s;     # How long to wait for a backend connection?</span><br><span class="line">  .between_bytes_timeout  = 2s;     # How long to wait between bytes received from our backend?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">acl purge &#123;		# 定义允许清理缓存的IP</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ACL we<span class="string">'ll use later to allow purges</span></span></span><br><span class="line">  "localhost";</span><br><span class="line">  "127.0.0.1";</span><br><span class="line">  "::1";</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_init &#123;		# 配置后端集群事件</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called when VCL is loaded, before any requests pass through it.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Typically used to initialize VMODs.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 后端集群有4种模式 random, round-robin, fallback, <span class="built_in">hash</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> random         随机</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> round-robin    轮询</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> fallback        后备</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="built_in">hash</span>        固定后端 根据url(req.http.url) 或用户cookie(req.http.cookie) 或用户session(req.http.sticky)(这个还有其他要配合)</span></span><br><span class="line">  new vdir = directors.round_robin();</span><br><span class="line">  vdir.add_backend(server1);</span><br><span class="line">  vdir.add_backend(server2);</span><br><span class="line"><span class="meta">  #</span><span class="bash"> vdir.add_backend(server...);</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> vdir.add_backend(servern);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_recv &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called at the beginning of a request, after the complete request has been received and parsed.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Its purpose is to decide whether or not to serve the request, how to <span class="keyword">do</span> it, and, <span class="keyword">if</span> applicable,</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="built_in">which</span> backend to use.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> also used to modify the request</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 请求入口，这里一般用作路由处理，判断是否读取缓存和指定该请求使用哪个后端</span></span><br><span class="line">  set req.backend_hint = vdir.backend(); # send all traffic to the vdir director</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Normalize the header, remove the port (<span class="keyword">in</span> <span class="keyword">case</span> you<span class="string">'re testing this on various TCP ports)</span></span></span><br><span class="line">  set req.http.Host = regsub(req.http.Host, ":[0-9]+", "");</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Remove the proxy header (see https://httpoxy.org/<span class="comment">#mitigate-varnish)</span></span></span><br><span class="line">  unset req.http.proxy;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Normalize the query arguments</span></span><br><span class="line">  set req.url = std.querysort(req.url);</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Allow purging</span></span><br><span class="line">  if (req.method == "PURGE") &#123;</span><br><span class="line">    if (!client.ip ~ purge) &#123; # purge is the ACL defined at the begining</span><br><span class="line">      # Not from an allowed IP? Then die with an error.</span><br><span class="line">      return (synth(405, "This IP is not allowed to send PURGE requests."));</span><br><span class="line">    &#125;</span><br><span class="line">    # If you got this stage (and didn't error out above), purge the cached result</span><br><span class="line">    return (purge);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果不是指定IP执行PURGE方法会报错，否则就执行</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Only deal with <span class="string">"normal"</span> types</span></span><br><span class="line">  if (req.method != "GET" &amp;&amp;</span><br><span class="line">      req.method != "HEAD" &amp;&amp;</span><br><span class="line">      req.method != "PUT" &amp;&amp;</span><br><span class="line">      req.method != "POST" &amp;&amp;</span><br><span class="line">      req.method != "TRACE" &amp;&amp;</span><br><span class="line">      req.method != "OPTIONS" &amp;&amp;</span><br><span class="line">      req.method != "PATCH" &amp;&amp;</span><br><span class="line">      req.method != "DELETE") &#123;</span><br><span class="line">    /* Non-RFC2616 or CONNECT which is weird. */</span><br><span class="line">    /*Why send the packet upstream, while the visitor is using a non-valid HTTP method? */</span><br><span class="line">    return (synth(404, "Non-valid HTTP method!"));</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果使用上面指定的方法就报错。</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Only cache GET or HEAD requests. This makes sure the POST requests are always passed.</span></span><br><span class="line">  if (req.method != "GET" &amp;&amp; req.method != "HEAD") &#123;</span><br><span class="line">   return (pass);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (req.url ~ "/aquapaas/rest/usertags/") </span><br><span class="line">		&#123; return (hash); &#125;  </span><br><span class="line"><span class="meta">  #</span><span class="bash"> 如果请求的地址中包含/aquapaas/rest/usertags/，就缓存。</span></span><br><span class="line">  return (pass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The data on <span class="built_in">which</span> the hashing will take place</span></span><br><span class="line">sub vcl_hash &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called after vcl_recv to create a <span class="built_in">hash</span> value <span class="keyword">for</span> the request. This is used as a key</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> to look up the object <span class="keyword">in</span> Varnish.</span></span><br><span class="line"></span><br><span class="line">  hash_data(req.url);</span><br><span class="line"> </span><br><span class="line">  return (lookup);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Handle the HTTP request coming from our backend</span></span><br><span class="line">sub vcl_backend_response &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called after the response headers has been successfully retrieved from the backend.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Sometimes, a 301 or 302 redirect formed via Apache<span class="string">'s mod_rewrite can mess with the HTTP port that is being passed along.</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> This often happens with simple rewrite rules <span class="keyword">in</span> a scenario <span class="built_in">where</span> Varnish runs on :80 and Apache on :8080 on the same box.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> A redirect can <span class="keyword">then</span> often redirect the end-user to a URL on :8080, <span class="built_in">where</span> it should be :80.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> This may need finetuning on your setup.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> To prevent accidental replace, we only filter the 301/302 redirects <span class="keyword">for</span> now.</span></span><br><span class="line">  if (beresp.status == 301 || beresp.status == 302) &#123;</span><br><span class="line">    set beresp.http.Location = regsub(beresp.http.Location, ":[0-9]+", "");</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Don<span class="string">'t cache 50x responses</span></span></span><br><span class="line">  if (beresp.status == 500 || beresp.status == 502 || beresp.status == 503 || beresp.status == 504) &#123;</span><br><span class="line">    return (abandon);        # abandon  放弃处理，并生成一个错误。</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Set 2min cache <span class="keyword">if</span> <span class="built_in">unset</span> <span class="keyword">for</span> static files</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="keyword">if</span> (beresp.ttl &lt;= 0s || beresp.http.Set-Cookie || beresp.http.Vary == <span class="string">"*"</span>) &#123;</span></span><br><span class="line">    # set beresp.ttl = 120s; # Important, you shouldn't rely on this, SET YOUR HEADERS in the backend</span><br><span class="line">    # set beresp.uncacheable = true;</span><br><span class="line">    # return (deliver);</span><br><span class="line"><span class="meta">  #</span><span class="bash"> &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Allow stale content, <span class="keyword">in</span> <span class="keyword">case</span> the backend goes down.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> make Varnish keep all objects <span class="keyword">for</span> 24000 hours beyond their TTL</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="built_in">set</span> beresp.ttl = 5m;</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="built_in">set</span> beresp.grace = 24000h;</span></span><br><span class="line">  </span><br><span class="line">  if ( beresp.status == 200 ) &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash">只有返回状态为200 OK的数据才考虑缓存。</span></span><br><span class="line">	if (bereq.url ~ "/aquapaas/rest/usertags/") &#123; </span><br><span class="line"><span class="meta">		#</span><span class="bash">AAA数据缓存30秒，过期后缓存0秒。</span></span><br><span class="line">		set beresp.ttl = 30s;</span><br><span class="line">		set beresp.grace = 0s;</span><br><span class="line">		&#125; </span><br><span class="line"> &#125; else &#123;</span><br><span class="line"><span class="meta"> #</span><span class="bash">其余数据不缓存。</span></span><br><span class="line"> set beresp.ttl = 0s;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> return (deliver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The routine when we deliver the HTTP request to the user</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Last chance to modify headers that are sent to the client</span></span><br><span class="line">sub vcl_deliver &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called before a cached object is delivered to the client.</span></span><br><span class="line"></span><br><span class="line">  if (obj.hits &gt; 0) &#123; # Add debug header to see if it's a HIT/MISS and the number of hits, disable when not needed</span><br><span class="line">    set resp.http.X-Cache = "HIT";</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    set resp.http.X-Cache = "MISS";</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Please note that obj.hits behaviour changed <span class="keyword">in</span> 4.0, now it counts per objecthead, not per object</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> and obj.hits may not be reset <span class="keyword">in</span> some cases <span class="built_in">where</span> bans are <span class="keyword">in</span> use. See bug 1492 <span class="keyword">for</span> details.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> So take hits with a grain of salt</span></span><br><span class="line">  set resp.http.X-Cache-Hits = obj.hits;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Remove some headers: PHP version</span></span><br><span class="line">  unset resp.http.X-Powered-By;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Remove some headers: Apache version &amp; OS</span></span><br><span class="line">  unset resp.http.Server;</span><br><span class="line">  unset resp.http.X-Drupal-Cache;</span><br><span class="line">  unset resp.http.X-Varnish;</span><br><span class="line">  unset resp.http.Via;</span><br><span class="line">  unset resp.http.Link;</span><br><span class="line">  unset resp.http.X-Generator;</span><br><span class="line"></span><br><span class="line">  return (deliver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_purge &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Only handle actual PURGE HTTP methods, everything <span class="keyword">else</span> is discarded</span></span><br><span class="line">  if (req.method == "PURGE") &#123;</span><br><span class="line">    # restart request</span><br><span class="line">    set req.http.X-Purge = "Yes";</span><br><span class="line">    return (restart);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_synth &#123;</span><br><span class="line">  if (resp.status == 720) &#123;</span><br><span class="line">    # We use this special error status 720 to force redirects with 301 (permanent) redirects</span><br><span class="line">    # To use this, call the following from anywhere in vcl_recv: return (synth(720, "http://host/new.html"));</span><br><span class="line">    set resp.http.Location = resp.reason;</span><br><span class="line">    set resp.status = 301;</span><br><span class="line">    return (deliver);</span><br><span class="line">  &#125; elseif (resp.status == 721) &#123;</span><br><span class="line">    # And we use error status 721 to force redirects with a 302 (temporary) redirect</span><br><span class="line">    # To use this, call the following from anywhere in vcl_recv: return (synth(720, "http://host/new.html"));</span><br><span class="line">    set resp.http.Location = resp.reason;</span><br><span class="line">    set resp.status = 302;</span><br><span class="line">    return (deliver);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return (deliver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_hit &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called when a cache lookup is successful.</span></span><br><span class="line"></span><br><span class="line">  if (obj.ttl &gt;= 0s) &#123;</span><br><span class="line">    # A pure unadultered hit, deliver it</span><br><span class="line">    return (deliver);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> https://www.varnish-cache.org/docs/trunk/users-guide/vcl-grace.html</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> When several clients are requesting the same page Varnish will send one request to the backend and place the others on hold <span class="keyword">while</span> fetching one copy from the backend. In some products this is called request coalescing and Varnish does this automatically.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> If you are serving thousands of hits per second the queue of waiting requests can get huge. There are two potential problems - one is a thundering herd problem - suddenly releasing a thousand threads to serve content might send the load sky high. Secondly - nobody likes to <span class="built_in">wait</span>. To deal with this we can instruct Varnish to keep the objects <span class="keyword">in</span> cache beyond their TTL and to serve the waiting requests somewhat stale content.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> (!std.healthy(req.backend_hint) &amp;&amp; (obj.ttl + obj.grace &gt; 0s)) &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   <span class="built_in">return</span> (deliver);</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   <span class="built_in">return</span> (miss);</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> We have no fresh fish. Lets look at the stale ones.</span></span><br><span class="line">  if (std.healthy(req.backend_hint)) &#123;</span><br><span class="line">    # Backend is healthy. Limit age to 10s.</span><br><span class="line">    if (obj.ttl + 10s &gt; 0s) &#123;</span><br><span class="line">      #set req.http.grace = "normal(limited)";</span><br><span class="line">      return (deliver);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      # No candidate for grace. Fetch a fresh object.</span><br><span class="line">      return (fetch);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    # backend is sick - use full grace</span><br><span class="line">      if (obj.ttl + obj.grace &gt; 0s) &#123;</span><br><span class="line">      #set req.http.grace = "full";</span><br><span class="line">      return (deliver);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      # no graced object.</span><br><span class="line">      return (fetch);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> fetch &amp; deliver once we get the result</span></span><br><span class="line">  return (fetch); # Dead code, keep as a safeguard</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_miss &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called after a cache lookup <span class="keyword">if</span> the requested document was not found <span class="keyword">in</span> the cache. Its purpose</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> is to decide whether or not to attempt to retrieve the document from the backend, and <span class="built_in">which</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> backend to use.</span></span><br><span class="line"></span><br><span class="line">  return (fetch);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub vcl_fini &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Called when VCL is discarded only after all requests have exited the VCL.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Typically used to clean up VMODs.</span></span><br><span class="line"></span><br><span class="line">  return (ok);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/20/python基础练习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/20/python基础练习/" itemprop="url">
                  python基础练习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-20 09:15:56" itemprop="dateCreated datePublished" datetime="2019-06-20T09:15:56+08:00">2019-06-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-09-02 08:59:09" itemprop="dateModified" datetime="2019-09-02T08:59:09+08:00">2019-09-02</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="打印一个边长为n的正方形"><a href="#打印一个边长为n的正方形" class="headerlink" title="打印一个边长为n的正方形"></a>打印一个边长为n的正方形</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">5</span>    <span class="comment"># 设置打印边长的星号数</span></span><br><span class="line">print(<span class="string">'*'</span>*n)    <span class="comment"># 打印第一行</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> (<span class="string">'*'</span>*(n<span class="number">-2</span>)):     <span class="comment"># 设置循环为减去上下两条边的数量</span></span><br><span class="line">    print(<span class="string">'*'</span>+<span class="string">' '</span>*(n<span class="number">-2</span>)+<span class="string">'*'</span>)    </span><br><span class="line">    <span class="comment"># 先打印前面一个星号，再打印减去了前后两个星号的空格，最后打印最后一个星号</span></span><br><span class="line">print(<span class="string">'*'</span>*n)    <span class="comment"># 打印最下面一行</span></span><br><span class="line"></span><br><span class="line">n = <span class="number">6</span></span><br><span class="line">e = -n//<span class="number">2</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(e,n+e):</span><br><span class="line">    <span class="keyword">if</span> i == e <span class="keyword">or</span> i == n+e<span class="number">-1</span>:</span><br><span class="line">        print(<span class="string">'*'</span>*n)    <span class="comment"># 上面判断的是要打印上下两条边</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'*'</span> + <span class="string">' '</span>*(n<span class="number">-2</span>) + <span class="string">'*'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 上面的代码等价于下面的代码</span></span><br><span class="line">n = <span class="number">5</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span> <span class="keyword">or</span> i == n<span class="number">-1</span>:</span><br><span class="line">        print(<span class="string">'*'</span>*n)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'*'</span>+<span class="string">' '</span>*(n<span class="number">-2</span>)+<span class="string">'*'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="求100以内所有奇数的和"><a href="#求100以内所有奇数的和" class="headerlink" title="求100以内所有奇数的和"></a>求100以内所有奇数的和</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sum = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>,<span class="number">2</span>):</span><br><span class="line">    sum += i</span><br><span class="line">print(sum)</span><br></pre></td></tr></table></figure>
<h3 id="求1到5的阶乘之和"><a href="#求1到5的阶乘之和" class="headerlink" title="求1到5的阶乘之和"></a>求1到5的阶乘之和</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法1</span></span><br><span class="line">n = <span class="number">5</span>    <span class="comment"># 控制阶乘的边界</span></span><br><span class="line">sum = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,n+<span class="number">1</span>):</span><br><span class="line">    tmp = <span class="number">1</span>    <span class="comment"># 第一次1的阶乘还是1</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,i+<span class="number">1</span>):</span><br><span class="line">        tmp *= j    <span class="comment"># 第一次1的阶乘是1×1</span></span><br><span class="line">    sum += tmp    <span class="comment"># 第一次sum=0+1</span></span><br><span class="line">print(sum)</span><br><span class="line"><span class="comment"># 1+1*2+1*2*3+1*2*3*4+1*2*3*4*5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法2</span></span><br><span class="line">nums = <span class="number">1</span></span><br><span class="line">sum = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">6</span>):</span><br><span class="line">    nums *= n</span><br><span class="line"><span class="comment"># 这里是乘等，第一次是1×1,第二次是1×1×2,第三次是1×1×2×3，这样就实现了阶乘，再使用下面的方法将每次循环的结果加在一起就形成了阶乘之和。</span></span><br><span class="line">    sum += nums</span><br><span class="line">print(sum)</span><br></pre></td></tr></table></figure>
<h3 id="给一个半径，求圆的面积和周长。圆周率3-14"><a href="#给一个半径，求圆的面积和周长。圆周率3-14" class="headerlink" title="给一个半径，求圆的面积和周长。圆周率3.14"></a>给一个半径，求圆的面积和周长。圆周率3.14</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r=int(input(<span class="string">'r='</span>))</span><br><span class="line">print(<span class="string">'area='</span>+str(<span class="number">3.14</span>*r*r))</span><br><span class="line">print(<span class="string">'circumference='</span>+str(<span class="number">2</span>*<span class="number">3.14</span>*r))</span><br></pre></td></tr></table></figure>
<h3 id="输入两个数，比较大小后，从小到大升序打印"><a href="#输入两个数，比较大小后，从小到大升序打印" class="headerlink" title="输入两个数，比较大小后，从小到大升序打印"></a>输入两个数，比较大小后，从小到大升序打印</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a = input(<span class="string">'first: '</span>)</span><br><span class="line">b = input(<span class="string">'second: '</span>)</span><br><span class="line"><span class="keyword">if</span> a &gt; b:</span><br><span class="line">    print(b, a)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(a, b)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 三元表达式</span></span><br><span class="line">print(b,a) <span class="keyword">if</span> a&gt;b <span class="keyword">else</span> print(a,b)</span><br></pre></td></tr></table></figure>
<h3 id="获取最大值"><a href="#获取最大值" class="headerlink" title="获取最大值"></a>获取最大值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 请输入若干个整数，打印出最大值</span></span><br><span class="line">m = int(input(<span class="string">'Input first number &gt;&gt;&gt;'</span>))</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    c = input(<span class="string">'Input a number &gt;&gt;&gt;'</span>)</span><br><span class="line">    <span class="keyword">if</span> c:</span><br><span class="line">        n = int(c)</span><br><span class="line">        <span class="keyword">if</span> n &gt; m:</span><br><span class="line">            m = n</span><br><span class="line">        print(<span class="string">'Max is'</span>, m)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># m是保存最大值的，c保存每次输入的数字并传给n，用n和m比较。这实际还是在做两个数的比较</span></span><br></pre></td></tr></table></figure>
<h3 id="输入n个数，求每次输入后的算数平均数"><a href="#输入n个数，求每次输入后的算数平均数" class="headerlink" title="输入n个数，求每次输入后的算数平均数"></a>输入n个数，求每次输入后的算数平均数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">0</span>    <span class="comment"># 次数</span></span><br><span class="line">sum = <span class="number">0</span>    <span class="comment"># 和</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    i = input(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="string">'quit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    n += <span class="number">1</span></span><br><span class="line">    sum += int(i)</span><br><span class="line">    avg = sum/n</span><br><span class="line">    print(avg)</span><br></pre></td></tr></table></figure>
<h3 id="打印九九乘法表"><a href="#打印九九乘法表" class="headerlink" title="打印九九乘法表"></a>打印九九乘法表</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">     <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">         print(<span class="string">"%d*%d=%2d"</span> % (i,j,i*j),end=<span class="string">" "</span>)</span><br><span class="line">     print(<span class="string">""</span>)</span><br><span class="line"><span class="number">1</span>*<span class="number">1</span>= <span class="number">1</span> <span class="number">1</span>*<span class="number">2</span>= <span class="number">2</span> <span class="number">1</span>*<span class="number">3</span>= <span class="number">3</span> <span class="number">1</span>*<span class="number">4</span>= <span class="number">4</span> <span class="number">1</span>*<span class="number">5</span>= <span class="number">5</span> <span class="number">1</span>*<span class="number">6</span>= <span class="number">6</span> <span class="number">1</span>*<span class="number">7</span>= <span class="number">7</span> <span class="number">1</span>*<span class="number">8</span>= <span class="number">8</span> <span class="number">1</span>*<span class="number">9</span>= <span class="number">9</span> </span><br><span class="line"><span class="number">2</span>*<span class="number">1</span>= <span class="number">2</span> <span class="number">2</span>*<span class="number">2</span>= <span class="number">4</span> <span class="number">2</span>*<span class="number">3</span>= <span class="number">6</span> <span class="number">2</span>*<span class="number">4</span>= <span class="number">8</span> <span class="number">2</span>*<span class="number">5</span>=<span class="number">10</span> <span class="number">2</span>*<span class="number">6</span>=<span class="number">12</span> <span class="number">2</span>*<span class="number">7</span>=<span class="number">14</span> <span class="number">2</span>*<span class="number">8</span>=<span class="number">16</span> <span class="number">2</span>*<span class="number">9</span>=<span class="number">18</span> </span><br><span class="line"><span class="number">3</span>*<span class="number">1</span>= <span class="number">3</span> <span class="number">3</span>*<span class="number">2</span>= <span class="number">6</span> <span class="number">3</span>*<span class="number">3</span>= <span class="number">9</span> <span class="number">3</span>*<span class="number">4</span>=<span class="number">12</span> <span class="number">3</span>*<span class="number">5</span>=<span class="number">15</span> <span class="number">3</span>*<span class="number">6</span>=<span class="number">18</span> <span class="number">3</span>*<span class="number">7</span>=<span class="number">21</span> <span class="number">3</span>*<span class="number">8</span>=<span class="number">24</span> <span class="number">3</span>*<span class="number">9</span>=<span class="number">27</span> </span><br><span class="line"><span class="number">4</span>*<span class="number">1</span>= <span class="number">4</span> <span class="number">4</span>*<span class="number">2</span>= <span class="number">8</span> <span class="number">4</span>*<span class="number">3</span>=<span class="number">12</span> <span class="number">4</span>*<span class="number">4</span>=<span class="number">16</span> <span class="number">4</span>*<span class="number">5</span>=<span class="number">20</span> <span class="number">4</span>*<span class="number">6</span>=<span class="number">24</span> <span class="number">4</span>*<span class="number">7</span>=<span class="number">28</span> <span class="number">4</span>*<span class="number">8</span>=<span class="number">32</span> <span class="number">4</span>*<span class="number">9</span>=<span class="number">36</span> </span><br><span class="line"><span class="number">5</span>*<span class="number">1</span>= <span class="number">5</span> <span class="number">5</span>*<span class="number">2</span>=<span class="number">10</span> <span class="number">5</span>*<span class="number">3</span>=<span class="number">15</span> <span class="number">5</span>*<span class="number">4</span>=<span class="number">20</span> <span class="number">5</span>*<span class="number">5</span>=<span class="number">25</span> <span class="number">5</span>*<span class="number">6</span>=<span class="number">30</span> <span class="number">5</span>*<span class="number">7</span>=<span class="number">35</span> <span class="number">5</span>*<span class="number">8</span>=<span class="number">40</span> <span class="number">5</span>*<span class="number">9</span>=<span class="number">45</span> </span><br><span class="line"><span class="number">6</span>*<span class="number">1</span>= <span class="number">6</span> <span class="number">6</span>*<span class="number">2</span>=<span class="number">12</span> <span class="number">6</span>*<span class="number">3</span>=<span class="number">18</span> <span class="number">6</span>*<span class="number">4</span>=<span class="number">24</span> <span class="number">6</span>*<span class="number">5</span>=<span class="number">30</span> <span class="number">6</span>*<span class="number">6</span>=<span class="number">36</span> <span class="number">6</span>*<span class="number">7</span>=<span class="number">42</span> <span class="number">6</span>*<span class="number">8</span>=<span class="number">48</span> <span class="number">6</span>*<span class="number">9</span>=<span class="number">54</span> </span><br><span class="line"><span class="number">7</span>*<span class="number">1</span>= <span class="number">7</span> <span class="number">7</span>*<span class="number">2</span>=<span class="number">14</span> <span class="number">7</span>*<span class="number">3</span>=<span class="number">21</span> <span class="number">7</span>*<span class="number">4</span>=<span class="number">28</span> <span class="number">7</span>*<span class="number">5</span>=<span class="number">35</span> <span class="number">7</span>*<span class="number">6</span>=<span class="number">42</span> <span class="number">7</span>*<span class="number">7</span>=<span class="number">49</span> <span class="number">7</span>*<span class="number">8</span>=<span class="number">56</span> <span class="number">7</span>*<span class="number">9</span>=<span class="number">63</span> </span><br><span class="line"><span class="number">8</span>*<span class="number">1</span>= <span class="number">8</span> <span class="number">8</span>*<span class="number">2</span>=<span class="number">16</span> <span class="number">8</span>*<span class="number">3</span>=<span class="number">24</span> <span class="number">8</span>*<span class="number">4</span>=<span class="number">32</span> <span class="number">8</span>*<span class="number">5</span>=<span class="number">40</span> <span class="number">8</span>*<span class="number">6</span>=<span class="number">48</span> <span class="number">8</span>*<span class="number">7</span>=<span class="number">56</span> <span class="number">8</span>*<span class="number">8</span>=<span class="number">64</span> <span class="number">8</span>*<span class="number">9</span>=<span class="number">72</span> </span><br><span class="line"><span class="number">9</span>*<span class="number">1</span>= <span class="number">9</span> <span class="number">9</span>*<span class="number">2</span>=<span class="number">18</span> <span class="number">9</span>*<span class="number">3</span>=<span class="number">27</span> <span class="number">9</span>*<span class="number">4</span>=<span class="number">36</span> <span class="number">9</span>*<span class="number">5</span>=<span class="number">45</span> <span class="number">9</span>*<span class="number">6</span>=<span class="number">54</span> <span class="number">9</span>*<span class="number">7</span>=<span class="number">63</span> <span class="number">9</span>*<span class="number">8</span>=<span class="number">72</span> <span class="number">9</span>*<span class="number">9</span>=<span class="number">81</span> </span><br><span class="line"><span class="comment"># 这种方法没有考虑到边界的问题</span></span><br><span class="line"></span><br><span class="line">方法一：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> j &lt;= i:</span><br><span class="line">            print(j,<span class="string">"*"</span>,i,<span class="string">"="</span>,i*j,end=<span class="string">" "</span>)</span><br><span class="line">    print(<span class="string">" "</span>)</span><br><span class="line"><span class="number">1</span> * <span class="number">1</span> = <span class="number">1</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">2</span> = <span class="number">2</span> <span class="number">2</span> * <span class="number">2</span> = <span class="number">4</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">3</span> = <span class="number">3</span> <span class="number">2</span> * <span class="number">3</span> = <span class="number">6</span> <span class="number">3</span> * <span class="number">3</span> = <span class="number">9</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">4</span> = <span class="number">4</span> <span class="number">2</span> * <span class="number">4</span> = <span class="number">8</span> <span class="number">3</span> * <span class="number">4</span> = <span class="number">12</span> <span class="number">4</span> * <span class="number">4</span> = <span class="number">16</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">5</span> = <span class="number">5</span> <span class="number">2</span> * <span class="number">5</span> = <span class="number">10</span> <span class="number">3</span> * <span class="number">5</span> = <span class="number">15</span> <span class="number">4</span> * <span class="number">5</span> = <span class="number">20</span> <span class="number">5</span> * <span class="number">5</span> = <span class="number">25</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">6</span> = <span class="number">6</span> <span class="number">2</span> * <span class="number">6</span> = <span class="number">12</span> <span class="number">3</span> * <span class="number">6</span> = <span class="number">18</span> <span class="number">4</span> * <span class="number">6</span> = <span class="number">24</span> <span class="number">5</span> * <span class="number">6</span> = <span class="number">30</span> <span class="number">6</span> * <span class="number">6</span> = <span class="number">36</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">7</span> = <span class="number">7</span> <span class="number">2</span> * <span class="number">7</span> = <span class="number">14</span> <span class="number">3</span> * <span class="number">7</span> = <span class="number">21</span> <span class="number">4</span> * <span class="number">7</span> = <span class="number">28</span> <span class="number">5</span> * <span class="number">7</span> = <span class="number">35</span> <span class="number">6</span> * <span class="number">7</span> = <span class="number">42</span> <span class="number">7</span> * <span class="number">7</span> = <span class="number">49</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">8</span> = <span class="number">8</span> <span class="number">2</span> * <span class="number">8</span> = <span class="number">16</span> <span class="number">3</span> * <span class="number">8</span> = <span class="number">24</span> <span class="number">4</span> * <span class="number">8</span> = <span class="number">32</span> <span class="number">5</span> * <span class="number">8</span> = <span class="number">40</span> <span class="number">6</span> * <span class="number">8</span> = <span class="number">48</span> <span class="number">7</span> * <span class="number">8</span> = <span class="number">56</span> <span class="number">8</span> * <span class="number">8</span> = <span class="number">64</span>  </span><br><span class="line"><span class="number">1</span> * <span class="number">9</span> = <span class="number">9</span> <span class="number">2</span> * <span class="number">9</span> = <span class="number">18</span> <span class="number">3</span> * <span class="number">9</span> = <span class="number">27</span> <span class="number">4</span> * <span class="number">9</span> = <span class="number">36</span> <span class="number">5</span> * <span class="number">9</span> = <span class="number">45</span> <span class="number">6</span> * <span class="number">9</span> = <span class="number">54</span> <span class="number">7</span> * <span class="number">9</span> = <span class="number">63</span> <span class="number">8</span> * <span class="number">9</span> = <span class="number">72</span> <span class="number">9</span> * <span class="number">9</span> = <span class="number">81</span></span><br><span class="line"></span><br><span class="line">方法二：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(i,<span class="number">10</span>):</span><br><span class="line">        print(<span class="string">'&#123;&#125;x&#123;&#125;=&#123;&#125;\t'</span>.format(i, j, i*j), end=<span class="string">' '</span>)</span><br><span class="line"><span class="comment">#        print(str(i)+'*'+str(j)+'='+str(i*j),end=' ')</span></span><br><span class="line"><span class="comment">#        print(i,'*',j,'=',i*j,end=' ')</span></span><br><span class="line"><span class="comment"># 上面这样打印也可以，只是很难看</span></span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    <span class="comment"># 最后一行打印的是一个换行符</span></span><br><span class="line"><span class="number">1</span> * <span class="number">1</span> = <span class="number">1</span> <span class="number">1</span> * <span class="number">2</span> = <span class="number">2</span> <span class="number">1</span> * <span class="number">3</span> = <span class="number">3</span> <span class="number">1</span> * <span class="number">4</span> = <span class="number">4</span> <span class="number">1</span> * <span class="number">5</span> = <span class="number">5</span> <span class="number">1</span> * <span class="number">6</span> = <span class="number">6</span> <span class="number">1</span> * <span class="number">7</span> = <span class="number">7</span> <span class="number">1</span> * <span class="number">8</span> = <span class="number">8</span> <span class="number">1</span> * <span class="number">9</span> = <span class="number">9</span> </span><br><span class="line"><span class="number">2</span> * <span class="number">2</span> = <span class="number">4</span> <span class="number">2</span> * <span class="number">3</span> = <span class="number">6</span> <span class="number">2</span> * <span class="number">4</span> = <span class="number">8</span> <span class="number">2</span> * <span class="number">5</span> = <span class="number">10</span> <span class="number">2</span> * <span class="number">6</span> = <span class="number">12</span> <span class="number">2</span> * <span class="number">7</span> = <span class="number">14</span> <span class="number">2</span> * <span class="number">8</span> = <span class="number">16</span> <span class="number">2</span> * <span class="number">9</span> = <span class="number">18</span> </span><br><span class="line"><span class="number">3</span> * <span class="number">3</span> = <span class="number">9</span> <span class="number">3</span> * <span class="number">4</span> = <span class="number">12</span> <span class="number">3</span> * <span class="number">5</span> = <span class="number">15</span> <span class="number">3</span> * <span class="number">6</span> = <span class="number">18</span> <span class="number">3</span> * <span class="number">7</span> = <span class="number">21</span> <span class="number">3</span> * <span class="number">8</span> = <span class="number">24</span> <span class="number">3</span> * <span class="number">9</span> = <span class="number">27</span> </span><br><span class="line"><span class="number">4</span> * <span class="number">4</span> = <span class="number">16</span> <span class="number">4</span> * <span class="number">5</span> = <span class="number">20</span> <span class="number">4</span> * <span class="number">6</span> = <span class="number">24</span> <span class="number">4</span> * <span class="number">7</span> = <span class="number">28</span> <span class="number">4</span> * <span class="number">8</span> = <span class="number">32</span> <span class="number">4</span> * <span class="number">9</span> = <span class="number">36</span> </span><br><span class="line"><span class="number">5</span> * <span class="number">5</span> = <span class="number">25</span> <span class="number">5</span> * <span class="number">6</span> = <span class="number">30</span> <span class="number">5</span> * <span class="number">7</span> = <span class="number">35</span> <span class="number">5</span> * <span class="number">8</span> = <span class="number">40</span> <span class="number">5</span> * <span class="number">9</span> = <span class="number">45</span> </span><br><span class="line"><span class="number">6</span> * <span class="number">6</span> = <span class="number">36</span> <span class="number">6</span> * <span class="number">7</span> = <span class="number">42</span> <span class="number">6</span> * <span class="number">8</span> = <span class="number">48</span> <span class="number">6</span> * <span class="number">9</span> = <span class="number">54</span> </span><br><span class="line"><span class="number">7</span> * <span class="number">7</span> = <span class="number">49</span> <span class="number">7</span> * <span class="number">8</span> = <span class="number">56</span> <span class="number">7</span> * <span class="number">9</span> = <span class="number">63</span> </span><br><span class="line"><span class="number">8</span> * <span class="number">8</span> = <span class="number">64</span> <span class="number">8</span> * <span class="number">9</span> = <span class="number">72</span> </span><br><span class="line"><span class="number">9</span> * <span class="number">9</span> = <span class="number">81</span> </span><br><span class="line"></span><br><span class="line">方法三：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">1</span>,i):</span><br><span class="line">        print(end=<span class="string">"\t "</span>)    <span class="comment"># 这行就是为了打印前面的空行的</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(i,<span class="number">10</span>):</span><br><span class="line">        print(<span class="string">'&#123;&#125;x&#123;&#125;=&#123;&#125;\t'</span>.format(i, j, i*j), end=<span class="string">' '</span>)</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line"><span class="number">1</span>x1=<span class="number">1</span>	 <span class="number">1</span>x2=<span class="number">2</span>	 <span class="number">1</span>x3=<span class="number">3</span>	 <span class="number">1</span>x4=<span class="number">4</span>	 <span class="number">1</span>x5=<span class="number">5</span>	 <span class="number">1</span>x6=<span class="number">6</span>	 <span class="number">1</span>x7=<span class="number">7</span>	 <span class="number">1</span>x8=<span class="number">8</span>	 <span class="number">1</span>x9=<span class="number">9</span>	 </span><br><span class="line">	 <span class="number">2</span>x2=<span class="number">4</span>	 <span class="number">2</span>x3=<span class="number">6</span>	 <span class="number">2</span>x4=<span class="number">8</span>	 <span class="number">2</span>x5=<span class="number">10</span>	 <span class="number">2</span>x6=<span class="number">12</span>	 <span class="number">2</span>x7=<span class="number">14</span>	 <span class="number">2</span>x8=<span class="number">16</span>	 <span class="number">2</span>x9=<span class="number">18</span>	 </span><br><span class="line">	 	 <span class="number">3</span>x3=<span class="number">9</span>	 <span class="number">3</span>x4=<span class="number">12</span>	 <span class="number">3</span>x5=<span class="number">15</span>	 <span class="number">3</span>x6=<span class="number">18</span>	 <span class="number">3</span>x7=<span class="number">21</span>	 <span class="number">3</span>x8=<span class="number">24</span>	 <span class="number">3</span>x9=<span class="number">27</span>	 </span><br><span class="line">	 	 	 <span class="number">4</span>x4=<span class="number">16</span>	 <span class="number">4</span>x5=<span class="number">20</span>	 <span class="number">4</span>x6=<span class="number">24</span>	 <span class="number">4</span>x7=<span class="number">28</span>	 <span class="number">4</span>x8=<span class="number">32</span>	 <span class="number">4</span>x9=<span class="number">36</span>	 </span><br><span class="line">	 	 	 	 <span class="number">5</span>x5=<span class="number">25</span>	 <span class="number">5</span>x6=<span class="number">30</span>	 <span class="number">5</span>x7=<span class="number">35</span>	 <span class="number">5</span>x8=<span class="number">40</span>	 <span class="number">5</span>x9=<span class="number">45</span>	 </span><br><span class="line">	 	 	 	 	 <span class="number">6</span>x6=<span class="number">36</span>	 <span class="number">6</span>x7=<span class="number">42</span>	 <span class="number">6</span>x8=<span class="number">48</span>	 <span class="number">6</span>x9=<span class="number">54</span>	 </span><br><span class="line">	 	 	 	 	 	 <span class="number">7</span>x7=<span class="number">49</span>	 <span class="number">7</span>x8=<span class="number">56</span>	 <span class="number">7</span>x9=<span class="number">63</span>	 </span><br><span class="line">	 	 	 	 	 	 	 <span class="number">8</span>x8=<span class="number">64</span>	 <span class="number">8</span>x9=<span class="number">72</span>	 </span><br><span class="line">	 	 	 	 	 	 	 	 <span class="number">9</span>x9=<span class="number">81</span>	</span><br><span class="line"><span class="comment"># 实际输出要更整齐一些</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">方法四：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>-i):</span><br><span class="line">        print(end=<span class="string">"\t "</span>)            <span class="comment"># 打印每一行前面的Tab键，第一行就要打印9个</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,i+<span class="number">1</span>):</span><br><span class="line">        print(<span class="string">"&#123;&#125;*&#123;&#125;=&#123;&#125;\t"</span>.format(i,j,i*j), end=<span class="string">" "</span>)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">	 	 	 	 	 	 	 	 <span class="number">1</span>*<span class="number">1</span>=<span class="number">1</span>	 </span><br><span class="line">	 	 	 	 	 	 	 <span class="number">2</span>*<span class="number">1</span>=<span class="number">2</span>	 <span class="number">2</span>*<span class="number">2</span>=<span class="number">4</span>	 </span><br><span class="line">	 	 	 	 	 	 <span class="number">3</span>*<span class="number">1</span>=<span class="number">3</span>	 <span class="number">3</span>*<span class="number">2</span>=<span class="number">6</span>	 <span class="number">3</span>*<span class="number">3</span>=<span class="number">9</span>	 </span><br><span class="line">	 	 	 	 	 <span class="number">4</span>*<span class="number">1</span>=<span class="number">4</span>	 <span class="number">4</span>*<span class="number">2</span>=<span class="number">8</span>	 <span class="number">4</span>*<span class="number">3</span>=<span class="number">12</span>	 <span class="number">4</span>*<span class="number">4</span>=<span class="number">16</span>	 </span><br><span class="line">	 	 	 	 <span class="number">5</span>*<span class="number">1</span>=<span class="number">5</span>	 <span class="number">5</span>*<span class="number">2</span>=<span class="number">10</span>	 <span class="number">5</span>*<span class="number">3</span>=<span class="number">15</span>	 <span class="number">5</span>*<span class="number">4</span>=<span class="number">20</span>	 <span class="number">5</span>*<span class="number">5</span>=<span class="number">25</span>	 </span><br><span class="line">	 	 	 <span class="number">6</span>*<span class="number">1</span>=<span class="number">6</span>	 <span class="number">6</span>*<span class="number">2</span>=<span class="number">12</span>	 <span class="number">6</span>*<span class="number">3</span>=<span class="number">18</span>	 <span class="number">6</span>*<span class="number">4</span>=<span class="number">24</span>	 <span class="number">6</span>*<span class="number">5</span>=<span class="number">30</span>	 <span class="number">6</span>*<span class="number">6</span>=<span class="number">36</span>	 </span><br><span class="line">	 	 <span class="number">7</span>*<span class="number">1</span>=<span class="number">7</span>	 <span class="number">7</span>*<span class="number">2</span>=<span class="number">14</span>	 <span class="number">7</span>*<span class="number">3</span>=<span class="number">21</span>	 <span class="number">7</span>*<span class="number">4</span>=<span class="number">28</span>	 <span class="number">7</span>*<span class="number">5</span>=<span class="number">35</span>	 <span class="number">7</span>*<span class="number">6</span>=<span class="number">42</span>	 <span class="number">7</span>*<span class="number">7</span>=<span class="number">49</span>	 </span><br><span class="line">	 <span class="number">8</span>*<span class="number">1</span>=<span class="number">8</span>	 <span class="number">8</span>*<span class="number">2</span>=<span class="number">16</span>	 <span class="number">8</span>*<span class="number">3</span>=<span class="number">24</span>	 <span class="number">8</span>*<span class="number">4</span>=<span class="number">32</span>	 <span class="number">8</span>*<span class="number">5</span>=<span class="number">40</span>	 <span class="number">8</span>*<span class="number">6</span>=<span class="number">48</span>	 <span class="number">8</span>*<span class="number">7</span>=<span class="number">56</span>	 <span class="number">8</span>*<span class="number">8</span>=<span class="number">64</span>	 </span><br><span class="line"><span class="number">9</span>*<span class="number">1</span>=<span class="number">9</span>	 <span class="number">9</span>*<span class="number">2</span>=<span class="number">18</span>	 <span class="number">9</span>*<span class="number">3</span>=<span class="number">27</span>	 <span class="number">9</span>*<span class="number">4</span>=<span class="number">36</span>	 <span class="number">9</span>*<span class="number">5</span>=<span class="number">45</span>	 <span class="number">9</span>*<span class="number">6</span>=<span class="number">54</span>	 <span class="number">9</span>*<span class="number">7</span>=<span class="number">63</span>	 <span class="number">9</span>*<span class="number">8</span>=<span class="number">72</span>	 <span class="number">9</span>*<span class="number">9</span>=<span class="number">81</span></span><br><span class="line"></span><br><span class="line">方法五：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,i+<span class="number">1</span>):</span><br><span class="line">        print(<span class="string">'&#123;&#125;*&#123;&#125;=&#123;&#125;\t'</span>.format(i,j,i*j), end=<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">" "</span>)</span><br><span class="line"><span class="number">1</span>*<span class="number">1</span>=<span class="number">1</span>	 </span><br><span class="line"><span class="number">2</span>*<span class="number">1</span>=<span class="number">2</span>	<span class="number">2</span>*<span class="number">2</span>=<span class="number">4</span>	 </span><br><span class="line"><span class="number">3</span>*<span class="number">1</span>=<span class="number">3</span>	<span class="number">3</span>*<span class="number">2</span>=<span class="number">6</span>	<span class="number">3</span>*<span class="number">3</span>=<span class="number">9</span>	 </span><br><span class="line"><span class="number">4</span>*<span class="number">1</span>=<span class="number">4</span>	<span class="number">4</span>*<span class="number">2</span>=<span class="number">8</span>	<span class="number">4</span>*<span class="number">3</span>=<span class="number">12</span>	<span class="number">4</span>*<span class="number">4</span>=<span class="number">16</span>	 </span><br><span class="line"><span class="number">5</span>*<span class="number">1</span>=<span class="number">5</span>	<span class="number">5</span>*<span class="number">2</span>=<span class="number">10</span>	<span class="number">5</span>*<span class="number">3</span>=<span class="number">15</span>	<span class="number">5</span>*<span class="number">4</span>=<span class="number">20</span>	<span class="number">5</span>*<span class="number">5</span>=<span class="number">25</span>	 </span><br><span class="line"><span class="number">6</span>*<span class="number">1</span>=<span class="number">6</span>	<span class="number">6</span>*<span class="number">2</span>=<span class="number">12</span>	<span class="number">6</span>*<span class="number">3</span>=<span class="number">18</span>	<span class="number">6</span>*<span class="number">4</span>=<span class="number">24</span>	<span class="number">6</span>*<span class="number">5</span>=<span class="number">30</span>	<span class="number">6</span>*<span class="number">6</span>=<span class="number">36</span>	 </span><br><span class="line"><span class="number">7</span>*<span class="number">1</span>=<span class="number">7</span>	<span class="number">7</span>*<span class="number">2</span>=<span class="number">14</span>	<span class="number">7</span>*<span class="number">3</span>=<span class="number">21</span>	<span class="number">7</span>*<span class="number">4</span>=<span class="number">28</span>	<span class="number">7</span>*<span class="number">5</span>=<span class="number">35</span>	<span class="number">7</span>*<span class="number">6</span>=<span class="number">42</span>	<span class="number">7</span>*<span class="number">7</span>=<span class="number">49</span>	 </span><br><span class="line"><span class="number">8</span>*<span class="number">1</span>=<span class="number">8</span>	<span class="number">8</span>*<span class="number">2</span>=<span class="number">16</span>	<span class="number">8</span>*<span class="number">3</span>=<span class="number">24</span>	<span class="number">8</span>*<span class="number">4</span>=<span class="number">32</span>	<span class="number">8</span>*<span class="number">5</span>=<span class="number">40</span>	<span class="number">8</span>*<span class="number">6</span>=<span class="number">48</span>	<span class="number">8</span>*<span class="number">7</span>=<span class="number">56</span>	<span class="number">8</span>*<span class="number">8</span>=<span class="number">64</span>	 </span><br><span class="line"><span class="number">9</span>*<span class="number">1</span>=<span class="number">9</span>	<span class="number">9</span>*<span class="number">2</span>=<span class="number">18</span>	<span class="number">9</span>*<span class="number">3</span>=<span class="number">27</span>	<span class="number">9</span>*<span class="number">4</span>=<span class="number">36</span>	<span class="number">9</span>*<span class="number">5</span>=<span class="number">45</span>	<span class="number">9</span>*<span class="number">6</span>=<span class="number">54</span>	<span class="number">9</span>*<span class="number">7</span>=<span class="number">63</span>	<span class="number">9</span>*<span class="number">8</span>=<span class="number">72</span>	<span class="number">9</span>*<span class="number">9</span>=<span class="number">81</span></span><br></pre></td></tr></table></figure>
<h3 id="打印100以内的斐波那契数列及打印第101项"><a href="#打印100以内的斐波那契数列及打印第101项" class="headerlink" title="打印100以内的斐波那契数列及打印第101项"></a>打印100以内的斐波那契数列及打印第101项</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 费波那契数列由0和1开始，之后的费波那契系数就是由之前的两数相加而得出。首几个费波那契系数是：</span></span><br><span class="line"><span class="comment"># 0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233……（OEIS中的数列A000045）</span></span><br><span class="line"><span class="comment"># 特别指出：0不是第一项，而是第零项。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印100以内的斐波那契数</span></span><br><span class="line">a=<span class="number">0</span></span><br><span class="line">b=<span class="number">1</span></span><br><span class="line">print(a)</span><br><span class="line">print(b)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    c = a + b</span><br><span class="line">    <span class="keyword">if</span> c &gt; <span class="number">100</span>:</span><br><span class="line">    	<span class="keyword">break</span></span><br><span class="line">    print(c)</span><br><span class="line">    a=b</span><br><span class="line">    b=c</span><br><span class="line"><span class="comment"># 如果小于100就打印，大于100就停止。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印101项斐波那契数</span></span><br><span class="line">a = <span class="number">0</span></span><br><span class="line">b = <span class="number">1</span></span><br><span class="line"><span class="comment"># 手动打印前两项</span></span><br><span class="line">print(<span class="string">'&#123;&#125;,&#123;&#125;'</span>.format(<span class="number">0</span>, a))</span><br><span class="line">print(<span class="string">'&#123;&#125;,&#123;&#125;'</span>.format(<span class="number">1</span>, b))</span><br><span class="line">index = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    c = a + b</span><br><span class="line">    a = b</span><br><span class="line">    b = c</span><br><span class="line">    index += <span class="number">1</span></span><br><span class="line">    print(<span class="string">'&#123;&#125;,&#123;&#125;'</span>.format(index, c))</span><br><span class="line">    <span class="comment"># 这里的index就是显示中前面的序号</span></span><br><span class="line">    <span class="keyword">if</span> index == <span class="number">101</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只打印第101项</span></span><br><span class="line">a=<span class="number">0</span></span><br><span class="line">b=<span class="number">1</span></span><br><span class="line"><span class="comment">#print(a)</span></span><br><span class="line"><span class="comment">#print(b)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">101</span>):</span><br><span class="line">    c = a + b</span><br><span class="line">    a=b</span><br><span class="line">    b=c</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">100</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    print(c)</span><br><span class="line">    <span class="comment"># 打印一定要放在最后，因为如果放在c = a + b下方，那么就无法将if判断加入进去了</span></span><br></pre></td></tr></table></figure>
<h3 id="求素数"><a href="#求素数" class="headerlink" title="求素数"></a>求素数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">方法<span class="number">1</span></span><br><span class="line"><span class="comment"># 最简单的思路，按照定义来，假设有一个数n(n&gt;1)，从2开始判断，一直判断到n-1</span></span><br><span class="line">n = <span class="number">12577</span> <span class="comment"># 避开3、5、10、2的倍数</span></span><br><span class="line">flag = <span class="keyword">False</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,n):</span><br><span class="line">    <span class="keyword">if</span> n % i == <span class="number">0</span>:    <span class="comment"># 找到条件是什么</span></span><br><span class="line">        flag = <span class="keyword">True</span></span><br><span class="line">        print(i)	<span class="comment"># 这里打印的是可以整除的数字</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    print(n, <span class="string">'is not a prime number. '</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(n, <span class="string">'is a prime number. '</span>)</span><br><span class="line">    </span><br><span class="line">方法<span class="number">2</span></span><br><span class="line">n = <span class="number">1577</span> <span class="comment"># 避开3、5、10、2的倍数</span></span><br><span class="line"><span class="comment"># 对这个数从2开始测试到n-1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,n):</span><br><span class="line">    <span class="keyword">if</span> n % i == <span class="number">0</span>:    <span class="comment"># 找到条件是什么</span></span><br><span class="line">        print(n, <span class="string">'is not a prime number. '</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(n, <span class="string">'is a prime number'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="求10万内的所有素数"><a href="#求10万内的所有素数" class="headerlink" title="求10万内的所有素数"></a>求10万内的所有素数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 质数（Prime number），又称素数，指在大于1的自然数中，除了1和该数自身外，无法被其他自然数整除的数（也可定义为只有1与该数本身两个正因数的数）。</span></span><br><span class="line"><span class="comment"># 大于1的自然数若不是素数，则称之为合数（也称为合成数）。</span></span><br><span class="line"><span class="comment"># 算术基本定理确立了素数于数论里的核心地位：任何大于1的整数均可被表示成一串唯一素数之乘积。</span></span><br><span class="line"><span class="comment"># 为了确保该定理的唯一性，1被定义为不是素数，因为在因式分解中可以有任意多个1（如3、1×3、1×1×3等都是3的有效约数分解）。</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">t = [<span class="number">2</span>]    <span class="comment"># 素数是从2开始的</span></span><br><span class="line">t0 = time.time()</span><br><span class="line">count = <span class="number">1</span></span><br><span class="line"><span class="comment"># 去掉所有偶数，从3开始迭代，步进为2</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">3</span>,<span class="number">100001</span>,<span class="number">2</span>):</span><br><span class="line">    <span class="keyword">if</span> x &gt; <span class="number">5</span> <span class="keyword">and</span> x % <span class="number">10</span> == <span class="number">5</span>:</span><br><span class="line"><span class="comment"># 所有大于10的质数中，个位数只有1、3、7、9，大于5且以5结尾的整数都能被5整除，这里首先过滤掉大于5且以5结尾的整数</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>, int(x ** <span class="number">0.5</span>) + <span class="number">1</span>, <span class="number">2</span>):    </span><br><span class="line"><span class="comment"># 这里的int最后加1,是因为前包后不包，所以要加1. 这一步就是为了测试当前的数字是否可以被i这个数字整除。</span></span><br><span class="line"><span class="comment"># 比如这时x是49,那么就要测试49是否可以被从3开始，到49开平方后加1的数字，并且去除了偶数，也就是剩下的这些数字整除，如果不能就是素数。</span></span><br><span class="line"><span class="comment"># 这一步是想表达，如果一个整数可以被其平方根因子前面的数整除就一定可以被平方根因子后面的数整除，所以只算平方根因子前面的数就可以了。</span></span><br><span class="line"><span class="comment"># 一个整数的前后对应的两个因子的乘积等于这个整数，所以一个整数如果平方根之前有一个因子，那平方根之后肯定有一个对应的因子，中间是平方根</span></span><br><span class="line"><span class="comment"># 上面所说的“一个整数的前后对应的两个因子的乘积等于这个整数”，是想表示如2*50=100，100就是那个整个，2就是前面的因子，50是后面的因子</span></span><br><span class="line"><span class="comment"># 平方根就在这两个因子之间。</span></span><br><span class="line">        <span class="keyword">if</span> x % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        t.append(x)</span><br><span class="line">print(t)</span><br><span class="line">print(<span class="string">'花费时间: &#123;&#125;'</span>.format(time.time() - t0))</span><br><span class="line">print(<span class="string">'质数个数: &#123;&#125;'</span>.format(count))</span><br><span class="line">print(<span class="string">'质数个数: &#123;&#125;'</span>.format(len(t)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 讲解:</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">100</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">100</span> % i:    <span class="comment"># 如果100与i取余不为1,那么就打印</span></span><br><span class="line">        print(i)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 100 = 2 x 50</span></span><br><span class="line"><span class="comment"># 100 = 4 x 25</span></span><br><span class="line"><span class="comment"># 100 = 5 x 20</span></span><br><span class="line"><span class="comment"># 100 = 10 x 10</span></span><br><span class="line"><span class="comment"># 这样很容易看出，在平方根10之前，如果100有一个因子，那么平方根后面一定有一个对应的因子，而平方根`10x10`是临界点。</span></span><br><span class="line"><span class="comment"># 所以被除数可以从平方根处砍掉后面的部分。</span></span><br><span class="line"><span class="comment"># 上面的意思是想说明，2*50=100和50*2=100是一个意思，所以在平方根上面的因子计算完就可以了，可以忽略掉平方根下面的因子</span></span><br><span class="line"><span class="comment"># 由于相差一个指数，一个整数的平方根通常都比自身小很多，数值越大，相差越大。</span></span><br><span class="line"><span class="comment"># 比如100比10大90，10000比100大9900，这样看就发现数据量减少了不止一星半点。</span></span><br></pre></td></tr></table></figure>
<h3 id="打印菱形"><a href="#打印菱形" class="headerlink" title="打印菱形"></a>打印菱形</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 思路：</span></span><br><span class="line"><span class="comment"># 行号	个数		前空格		总空格数</span></span><br><span class="line"><span class="comment">#  1	   1		3			6</span></span><br><span class="line"><span class="comment">#  2	   3		2			4</span></span><br><span class="line"><span class="comment">#  3	   5		1			2</span></span><br><span class="line"><span class="comment">#  4	   7		0			0</span></span><br><span class="line"><span class="comment">#  5	   5		1			2</span></span><br><span class="line"><span class="comment">#  6	   3		2			4</span></span><br><span class="line"><span class="comment">#  7	   1		3			6</span></span><br><span class="line"><span class="comment"># 这是中心对称的</span></span><br><span class="line"><span class="comment"># 我们关注的是一行如果打满星号总共的数量与前空格一列，每行菱形前面的空格从3-0,再从0-3</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">-3</span>,<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">0</span>:</span><br><span class="line">        prespace = -i</span><br><span class="line">        <span class="comment"># 这里是将数字变为正数</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        prespace = i</span><br><span class="line">    print(<span class="string">' '</span>*prespace+<span class="string">'*'</span>*(<span class="number">7</span>-prespace*<span class="number">2</span>))</span><br><span class="line">    <span class="comment"># 这是发现的公式。' '*prespace是要打印的空格数，'*'*(7-prespace*2))是要打印几个星号。</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 三目运算符方法</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">-3</span>,<span class="number">4</span>):</span><br><span class="line">    prespace=-i <span class="keyword">if</span> (i &lt; <span class="number">0</span>) <span class="keyword">else</span> i</span><br><span class="line">    <span class="comment"># 这里不能写成prespace=-i if (i &lt; 0) else prespace=i，这样会报语法错误。</span></span><br><span class="line">    print(<span class="string">' '</span>*prespace+<span class="string">'*'</span>*(<span class="number">7</span>-prespace*<span class="number">2</span>))</span><br></pre></td></tr></table></figure>
<h3 id="打印对顶三角形"><a href="#打印对顶三角形" class="headerlink" title="打印对顶三角形"></a>打印对顶三角形</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 思路：</span></span><br><span class="line"><span class="comment"># 行号	对称序列	  星号数	  总空格数	前置空格数		后置空格数</span></span><br><span class="line"><span class="comment">#  1		3			7			0		0				0	   </span></span><br><span class="line"><span class="comment">#  2		2			5			2		1				1</span></span><br><span class="line"><span class="comment">#  3		1			3			4		2				2</span></span><br><span class="line"><span class="comment">#  4		0			1			6		3				3</span></span><br><span class="line"><span class="comment">#  5		1			3			4		2				2</span></span><br><span class="line"><span class="comment">#  6		2			5			2		1				1</span></span><br><span class="line"><span class="comment">#  7		3			7			0		0				0</span></span><br><span class="line"><span class="comment"># 可以看出，只与前置空格、起点、终点有关</span></span><br><span class="line">n = <span class="number">7</span></span><br><span class="line">e = n//<span class="number">2</span>		<span class="comment"># 因为是对称问题所以除2？</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(-e, n-e):</span><br><span class="line">    prespace = -i <span class="keyword">if</span> i&lt;<span class="number">0</span> <span class="keyword">else</span> i     <span class="comment"># 这一步是将数字都变为正数</span></span><br><span class="line">    print(<span class="string">' '</span>*(e-prespace) + <span class="string">'*'</span>*(<span class="number">2</span>*prespace+<span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<h3 id="打印闪电"><a href="#打印闪电" class="headerlink" title="打印闪电"></a>打印闪电</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 思路：</span></span><br><span class="line"><span class="comment"># 行号	个数		前空格		后空格数	总空格数	数据</span></span><br><span class="line"><span class="comment">#  1	   1		3			3			6		-3</span></span><br><span class="line"><span class="comment">#  2	   2		2			3			5		-2</span></span><br><span class="line"><span class="comment">#  3	   3		1			3			4		-1</span></span><br><span class="line"><span class="comment">#  4	   7		0			0			0		0</span></span><br><span class="line"><span class="comment">#  5	   3		3			1			4		1</span></span><br><span class="line"><span class="comment">#  6	   2		3			2			5		2</span></span><br><span class="line"><span class="comment">#  7	   1		3			3			6		3</span></span><br><span class="line"><span class="comment"># 看一下上面数据一列</span></span><br><span class="line">方法<span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">-3</span>,<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">' '</span>*(-i)+<span class="string">'*'</span>*(<span class="number">4</span>+i))</span><br><span class="line">    <span class="keyword">elif</span> i &gt; <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">' '</span>*<span class="number">3</span>+<span class="string">'*'</span>*(<span class="number">4</span>-i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'*'</span>*<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">方法<span class="number">2</span></span><br><span class="line">j = <span class="string">'*'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">-3</span>,<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        print(j*<span class="number">7</span>)</span><br><span class="line">    print(<span class="string">" "</span>*(-i) + j*(i+<span class="number">4</span>)) <span class="keyword">if</span> i&lt;<span class="number">0</span> <span class="keyword">else</span> print(<span class="number">3</span>*<span class="string">" "</span> + j*(<span class="number">3</span>-i))</span><br></pre></td></tr></table></figure>
<h3 id="解决猴子吃桃问题"><a href="#解决猴子吃桃问题" class="headerlink" title="解决猴子吃桃问题"></a>解决猴子吃桃问题</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 猴子第一天摘下若干个桃子，当即吃了一半，还不过瘾，又多吃了一个。第二天早上又将剩下的桃子吃掉一半，又多吃了一个。以后每天早上都吃了前一天剩下的一半零一个。到了第10天早上想吃时，只剩下一个桃子了。求第一天共摘了多少个桃子。</span></span><br><span class="line"><span class="comment"># 猴子应该第九天吃完时就已经知道只剩下一个桃子了。</span></span><br><span class="line">n=<span class="number">1</span>    <span class="comment"># 这是最后剩下的桃子的数目</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):   </span><br><span class="line"><span class="comment"># 如果是一个不关心或没用的变量可以使用下划线代替，这个变量在这里只是为了迭代使用的。</span></span><br><span class="line">    n=(n+<span class="number">1</span>)*<span class="number">2</span></span><br><span class="line">    print(n)</span><br><span class="line"><span class="comment"># 从题目中得出公式：x/2-1=n，x是桃子的总数，n是剩下桃子的数目，反过来就得到(n+1)*2就是总的桃子的数目。将这个公式迭代9次就是总的数目。</span></span><br><span class="line"><span class="comment"># 所以用range(1,10)</span></span><br></pre></td></tr></table></figure>
<h3 id="杨辉三角"><a href="#杨辉三角" class="headerlink" title="杨辉三角"></a>杨辉三角</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line">-----------</span><br><span class="line">  方法一</span><br><span class="line">-----------</span><br><span class="line">triangle=[[<span class="number">1</span>],[<span class="number">1</span>,<span class="number">1</span>]]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">6</span>):    </span><br><span class="line"><span class="comment"># 从2开始是因为前两个列表已经有了，所以从2开始</span></span><br><span class="line">    cur = [<span class="number">1</span>]           </span><br><span class="line"><span class="comment"># 这是每个元素的第一个1</span></span><br><span class="line">    pre = triangle[i<span class="number">-1</span>]     </span><br><span class="line"><span class="comment"># 这里定义的pre是要计算的列表元素的上一个元素，也就是triangle列表中的哪个小的列表。如第一次要计算的就是</span></span><br><span class="line"><span class="comment"># 第三个元素，所以pre就是第二个。说明pre等于triangle列表中的第几个列表，如i等于1，那么，pre就等于</span></span><br><span class="line"><span class="comment"># triangle[0]，因为这是triangle中的第一个列表。当第一次i等于2时这里是[1,1]</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(pre)<span class="number">-1</span>):         </span><br><span class="line"><span class="comment"># len(pre)是计算pre这个列表中有几个元素。这个循环就是在凑前后两个1中间的部分。第一次循环时，len(pre)的</span></span><br><span class="line"><span class="comment"># 结果是2，减去1后j等于0。这里这样做是因为在杨辉三角中每行的行号与这一行中元素的个数是一样的。如第三行</span></span><br><span class="line"><span class="comment"># 的列表中就有三个元素，这里减1是因为上面的cur已经定义了每个元素的第一个1，最后的1还没追加，所以减去1</span></span><br><span class="line"><span class="comment"># 就是两个1中间的元素的个数了</span></span><br><span class="line">        cur.append(pre[j]+pre[j+<span class="number">1</span>])        </span><br><span class="line"><span class="comment"># pre[j]+pre[j+1]第一次计算的结果是2，也就是pre[0]+pre[0+1]，这时的pre等于[1,1]，所以pre的第0个</span></span><br><span class="line"><span class="comment"># 和第1个元素都是1，所以相加得2。之后将pre[2]追加到了cur中，cur这时是[1]，所以结果就是[1,2]。再加上</span></span><br><span class="line"><span class="comment"># 下面追加的1，就成了第三个元素[1,2,1]</span></span><br><span class="line">    cur.append(<span class="number">1</span>)   </span><br><span class="line"><span class="comment"># 这是向cur的一个列表中插入1，如原来是[1]，插入后就是[1,1]，这插入的应该是每个元素最后一个1。上面的循环</span></span><br><span class="line"><span class="comment"># 结束到这一步，也就意味着一个元素计算完毕，下面追加到triangle列表中，之后就可以进入下个循环了。</span></span><br><span class="line">    triangle.append(cur)        </span><br><span class="line"><span class="comment"># 这里再将cur追加到现在的triangle中，就有了[[1], [1, 1], [1, 2, 1]]</span></span><br><span class="line">print(triangle)</span><br><span class="line"><span class="comment"># 输出结果：[[1], [1, 1], [1, 2, 1], [1, 3, 3, 1], [1, 4, 6, 4, 1], [1, 5, 10, 10, 5, 1]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法一变体</span></span><br><span class="line">triangle=[]</span><br><span class="line">n = <span class="number">4</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">    row = [<span class="number">1</span>]</span><br><span class="line"><span class="comment"># 这是每一个元素的第一个1</span></span><br><span class="line">    triangle.append(row)</span><br><span class="line"><span class="comment"># 追加row到triangle列表中</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(i<span class="number">-1</span>):    </span><br><span class="line"><span class="comment"># 当i是2的时候会进入这个循环，计算两个1中间的部分，这里j是0</span></span><br><span class="line">        row.append(triangle[i<span class="number">-1</span>][j]+triangle[i<span class="number">-1</span>][j+<span class="number">1</span>])</span><br><span class="line"><span class="comment"># triangle[i-1][j]中的[i-1]表示triangle中的第几个小列表，之后的[j]表示列表中的第几个元素。如果</span></span><br><span class="line"><span class="comment"># i是2的话，那么triangle[i-1]就是triangle中的第1个小列表，也就是[1,1]，这时j等于0,</span></span><br><span class="line"><span class="comment"># triangle[i-1][j]的结果就是1，triangle[i-1][j+1]的结果也是1，但它们表示[1,1]中前后两个不同的1，</span></span><br><span class="line"><span class="comment"># 再将它们相加就是2，这就算出了两个1中间的部分。当i等于3时，这里会循环两次，所以能算出两个3</span></span><br><span class="line">    row.append(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 这是每个元素的最后一个1</span></span><br><span class="line">print(triangle)</span><br><span class="line"><span class="comment"># 输出结果：[[1], [1, 1], [1, 2, 1], [1, 3, 3, 1]]</span></span><br><span class="line"></span><br><span class="line">======================================================================================</span><br><span class="line">triangle = []</span><br><span class="line">row = [<span class="number">1</span>]</span><br><span class="line">triangle.append(row)</span><br><span class="line">row.append(<span class="number">1</span>)</span><br><span class="line">row.append(<span class="number">999</span>)</span><br><span class="line">print(triangle)</span><br><span class="line"><span class="comment"># 发现这样的问题，虽然按顺序执行会先将row插入到triangle中，但之后再向row中插入一个1和999，这时triangle</span></span><br><span class="line"><span class="comment"># 不会是[[1]]，而是[[1,1,999]]。可以向列表中的元素列表中直接添加子元素</span></span><br><span class="line">======================================================================================</span><br><span class="line"></span><br><span class="line">-------------------</span><br><span class="line"> 方法二-<span class="keyword">while</span></span><br><span class="line">-------------------</span><br><span class="line">n = <span class="number">6</span></span><br><span class="line">oldline = []        </span><br><span class="line"><span class="comment"># oldline就是为了凑每行的[1]和1之后的部分</span></span><br><span class="line">newline = [<span class="number">1</span>]</span><br><span class="line">length = <span class="number">0</span></span><br><span class="line">print(newline)      </span><br><span class="line"><span class="comment"># 先打印出第一行的[1]</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,n):        </span><br><span class="line"><span class="comment"># 这里会循环1-5</span></span><br><span class="line">    oldline = newline.copy()</span><br><span class="line"><span class="comment"># 这是浅拷贝。先把每行的第一个1凑出来。第二次循环时，这里的oldline就变成了[1,1]</span></span><br><span class="line">    oldline.append(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 尾部加0,相当于两端加0，这时的oldline是[1,0]</span></span><br><span class="line">    newline.clear()     </span><br><span class="line"><span class="comment"># 清空newline，这时的newline是[]</span></span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> offset &lt;= i:</span><br><span class="line">        newline.append(oldline[offset - <span class="number">1</span>] + oldline[offset])</span><br><span class="line"><span class="comment"># 这里开始凑每行中的所有内容，第一次i是1,offset是0,oldline[0-1] + oldline[0]，这时oldline[-1]</span></span><br><span class="line"><span class="comment"># 是0,oldline[0]是1，这两个数相加也就是[1],下面offset自增加1,因为offset和i都是1,所以还会进一次循</span></span><br><span class="line"><span class="comment"># 环，newline现在是[1]，oldline[1-1] + oldline[1]，这时oldline[0]是1,oldline[1]是0，这两个数</span></span><br><span class="line"><span class="comment"># 相加也是[1]，追加到newline这个空列表中，这时newline是[1,1]。之后offset再增加1,这时offset大于</span></span><br><span class="line"><span class="comment"># i，退出循环。最后就打印出了第二行的[1,1]</span></span><br><span class="line">        offset += <span class="number">1</span></span><br><span class="line">    print(newline)</span><br><span class="line">    </span><br><span class="line">----------------</span><br><span class="line"> 方法二-<span class="keyword">for</span></span><br><span class="line">----------------</span><br><span class="line">n = <span class="number">6</span></span><br><span class="line">oldline = []</span><br><span class="line">newline = [<span class="number">1</span>]</span><br><span class="line">length = <span class="number">0</span></span><br><span class="line">print(newline)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,n):</span><br><span class="line">    oldline = newline.copy()</span><br><span class="line"><span class="comment"># 这是浅拷贝</span></span><br><span class="line">    oldline.append(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 尾部加0,相当于两端加0</span></span><br><span class="line">    newline.clear()</span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(i+<span class="number">1</span>):</span><br><span class="line">        newline.append(oldline[j<span class="number">-1</span>]+oldline[j])</span><br><span class="line">    print(newline)</span><br><span class="line"><span class="comment"># 这个方法与上面的while方面的思路是一样的。</span></span><br><span class="line"></span><br><span class="line">======================================================================================</span><br><span class="line"><span class="comment"># 如何比较两段代码的效率？效率一是看时间，一是看进入循环的次数</span></span><br><span class="line"><span class="comment"># 算质数-1</span></span><br><span class="line"><span class="keyword">import</span> datetime         </span><br><span class="line"><span class="comment"># 要装载这个模块</span></span><br><span class="line">n = <span class="number">100000</span></span><br><span class="line">pn = []</span><br><span class="line">count = <span class="number">0</span>       </span><br><span class="line"><span class="comment"># 这是为了计数。用count计算进入循环的次数</span></span><br><span class="line">start = datetime.datetime.now()     </span><br><span class="line"><span class="comment"># 设置一个开始时间</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">2</span>,n):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pn:        </span><br><span class="line"><span class="comment"># 通过这样的方式，向pn列表中添加元素。第一次pn是空，2会被添加到pn中。之后随着pn的增长，x会与pn中所</span></span><br><span class="line"><span class="comment"># 有的数字进行取余，如果结果是0就跳出与pn列表中数字取余的循环。否则，这个与pn列表中数字取余的数字x</span></span><br><span class="line"><span class="comment"># 就是质数</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> x % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pn.append(x)</span><br><span class="line"><span class="comment">#print(pn)</span></span><br><span class="line">delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line"><span class="comment"># 用现在的时间减去开始时间，.total_seconds计算全部时间差。</span></span><br><span class="line">print(len(pn))</span><br><span class="line">print(count)</span><br><span class="line">print(delta)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 算质数-2</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line">n = <span class="number">100000</span></span><br><span class="line">pn = []</span><br><span class="line">flag = <span class="keyword">False</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line">start = datetime.datetime.now()</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">2</span>,n):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pn:</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> x % i == <span class="number">0</span>:   </span><br><span class="line"><span class="comment"># 这是如果进来了，就不是质数。实际与2、3、5等取余为0的都会在这个条件下被屏蔽掉。</span></span><br><span class="line">            flag = <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> i &gt;= math.ceil(x**<span class="number">0.5</span>):    </span><br><span class="line"><span class="comment"># 这里如果进来了，就是质数。ceil() 函数返回数字的上入整数。x**0.5就是对x开方。到这里的都是筛选过一</span></span><br><span class="line"><span class="comment"># 次的数字了</span></span><br><span class="line">            flag = <span class="keyword">False</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 先用x与i取余，如果是0,就表示不是质数。如果结果都不为0,再用</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">        pn.append(x)</span><br><span class="line"><span class="comment"># print(pn)</span></span><br><span class="line">delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">print(len(pn))    </span><br><span class="line"><span class="comment"># 计算打印的个数</span></span><br><span class="line">print(count)</span><br><span class="line">print(delta)</span><br><span class="line">======================================================================================</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  方法三</span><br><span class="line">------------</span><br><span class="line"><span class="comment"># 尾部追加效率最高</span></span><br><span class="line"><span class="comment"># 能不能一次性开辟空间。所谓一次性开辟，就是将一列先算出来，不断向后追加，直到追加完最后一个1。中间部分先用数字填充，下面两例使用0或1来填充。如[1,0,1] [1,1,1,1]</span></span><br><span class="line"><span class="comment"># 列表解析式</span></span><br><span class="line"><span class="comment"># 循环迭代</span></span><br><span class="line"><span class="comment"># 能不能少算一半的数字</span></span><br><span class="line">triangle = []</span><br><span class="line">n = <span class="number">6</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):      </span><br><span class="line"><span class="comment"># 这里的循环从0-5</span></span><br><span class="line">    row = [<span class="number">1</span>]       </span><br><span class="line"><span class="comment"># 开始的1</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(i):      </span><br><span class="line"><span class="comment"># 当i是0的时候，不会执行其下面的语句，因为k是空。中间填0,尾部填1</span></span><br><span class="line">        row.append(<span class="number">1</span>) <span class="keyword">if</span> k == i<span class="number">-1</span> <span class="keyword">else</span> row.append(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 如果k等于i-1，那么就向row后追加1,否则就追加0</span></span><br><span class="line">    triangle.append(row)        </span><br><span class="line"><span class="comment"># 第一次因为i是0,所以直接到这里，将row插入到triangle列表中，之后到下面的命令，返回到循环的首部。第</span></span><br><span class="line"><span class="comment"># 二次因为i是1,所以执行上面循环的语句，向row中插入1,row变成了[1,1]</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,i//<span class="number">2</span>+<span class="number">1</span>):       </span><br><span class="line"><span class="comment"># 当i是1时，这里是for j in range(1,1)，因为是range(1,1)所以不会向下执行。i=2第三行才能进来</span></span><br><span class="line">        val = triangle[i<span class="number">-1</span>][j<span class="number">-1</span>] + triangle[i<span class="number">-1</span>][j]</span><br><span class="line">        row[j] = val</span><br><span class="line"><span class="comment"># i为2,j为0 1 2,循环1次</span></span><br><span class="line"><span class="comment"># i为3，j为0 1 2 3,循环1次</span></span><br><span class="line"><span class="comment"># i为4,j为0 1 2 3 4,循环2次</span></span><br><span class="line">        <span class="keyword">if</span> i != <span class="number">2</span>*j:</span><br><span class="line">            row[-j<span class="number">-1</span>] = val</span><br><span class="line">print(triangle)</span><br><span class="line"><span class="comment"># 这个方法就是先将一列计算出来，中间部分先用数字填充，最后再一个一个修改中间的数字。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法三变体</span></span><br><span class="line">triangle = []</span><br><span class="line">n = <span class="number">6</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">    row = [<span class="number">1</span>] * (i+<span class="number">1</span>)       </span><br><span class="line"><span class="comment"># 一次性开辟</span></span><br><span class="line">    triangle.append(row)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,i//<span class="number">2</span>+<span class="number">1</span>):       </span><br><span class="line"><span class="comment"># i=2第三行才能进来</span></span><br><span class="line">        val = triangle[i<span class="number">-1</span>][j<span class="number">-1</span>] + triangle[i<span class="number">-1</span>][j]</span><br><span class="line">        row[j] = val</span><br><span class="line">        <span class="keyword">if</span> i != <span class="number">2</span>*j:        </span><br><span class="line"><span class="comment"># 奇数个数的中点跳过</span></span><br><span class="line">            row[-j<span class="number">-1</span>] = val</span><br><span class="line">print(triangle)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/19/varnish概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/19/varnish概念/" itemprop="url">
                  varnish概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-19 14:03:23" itemprop="dateCreated datePublished" datetime="2019-06-19T14:03:23+08:00">2019-06-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-20 10:16:23" itemprop="dateModified" datetime="2019-06-20T10:16:23+08:00">2019-06-20</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/缓存服务/" itemprop="url" rel="index"><span itemprop="name">缓存服务</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ol>
<li><p>varnish的基本介绍</p>
<p>​        Varnish与一般服务器软件类似，就是一个web缓存代理服务器，分为master(management)进程和child(worker，主要做cache的工作)进程。master进程读入命令，进行一些初始化，然后fork(分流)并监控child进程。child进程分配若干线程进行工作，主要包括一些管理线程和很多woker线程。</p>
<p>​        Management进程主要实现应用新的配置、编译VCL、监控varnish、初始化varnish以及提供一个命令行接口等。 Management进程会每隔几秒钟探测一下Child进程以判断其是否正常运行，如果在指定的时长内未得到Child进程的回应，Management将会重启此Child进程。</p>
<p>Child进程包含多种类型的线程，常见的如：</p>
<p>​       Acceptor线程：接收新的连接请求并响应；</p>
<p>​       Worker线程：child进程会为每个会话启动一个worker线程，因此，在高并发的场景中可能会出现数百个worker线程甚至更多；</p>
<p>​       Expiry线程：从缓存中清理过期内容；</p>
<p>​        Varnish依赖“工作区(workspace)”以降低线程在申请或修改内存时出现竞争的可能性。在varnish内部有多种不同的工作区，其中最关键的当属用于管理会话数据的session工作区。</p>
</li>
<li><p>varnish与squid的区别</p>
<p>​        varnish和squid在中小规模的应用上，varnish足够轻量级，足够好用，但是在巨大的并发请求来说，单个varnish所能够承载的并发 访问量大概在5000个连接请求左右，超出5000个可能就得不稳定了；而在这里squid就能表现出良好的性能了，因此在大规模的企业级应用中仍然是以squid居多，而在中小规模的自己公司的反向代理缓存中varnish居多；</p>
</li>
</ol>
<p>   Varnish的优势</p>
<ul>
<li>Varnish的稳定性很高，两者在完成相同负荷的工作时，Squid服务器发生故障的几率要高于Varnish，因为使用Squid要经常重启；</li>
<li>Varnish访问速度更快，因为采用了“Visual Page Cache”技术，所有缓存数据都直接从内存读取，而squid是从硬盘读取，因而Varnish在访问速度方面会更快；</li>
<li>Varnish可以支持更多的并发连接，因为Varnish的TCP连接释放要比Squid快，因而在高并发连接情况下可以支持更多TCP连接；</li>
<li>Varnish可以通过管理端口，使用正则表达式批量的清除部分缓存，而Squid是做不到的；</li>
<li>squid属于是单进程使用单核CPU，但Varnish是通过fork形式打开多进程来做处理，所以可以合理的使用所有核来处理相应的请求；</li>
</ul>
<p>   Varnish的劣势</p>
<ul>
<li>varnish进程一旦Hang、Crash或者重启，缓存数据都会从内存中完全释放，此时所有请求都会发送到后端服务器，在高并发情况下，会给后端服务器造成很大压力；</li>
<li>在varnish使用中如果单个url的请求通过HA/F5等负载均衡，则每次请求落在不同的varnish服务器中，造成请求都会被穿透到后端；而且同样的请求在多台服务器上缓存，也会造成varnish的缓存的资源浪费，造成性能下降；</li>
</ul>
<p>   Varnish劣势的解决方案</p>
<ul>
<li>针 对劣势一：在访问量很大的情况下推荐使用varnish的内存缓存方式启动，而且后面需要跟多台squid服务器。主要为了防止前面的varnish服 务、服务器被重启的情况下，大量请求穿透varnish，这样squid可以就担当第二层CACHE，而且也弥补了varnish缓存在内存中重启都会释 放的问题；</li>
<li>针对劣势二：可以在负载均衡上做url哈希，让单个url请求固定请求到一台varnish服务器上;</li>
</ul>
<ol start="3">
<li><p>varnish的日志说明</p>
<p>​        为了与系统的其它部分进行交互，Child进程使用了可以通过文件系统接口进行访问的共享内存日志(shared memory log)，因此，如果某线程需要记录信息，其仅需要持有一个锁，而后向共享内存中的某内存区域写入数据，再释放持有的锁即可。而为了减少竞争，每个 worker线程都使用了日志数据缓存。</p>
<p>​        共享内存日志大小一般为90M，其分为两部分，前一部分为计数器，后半部分为客户端请求的数据。varnish提供了多个不同的工具如 varnishlog、varnishncsa或varnishstat等来分析共享内存日志中的信息并能够以指定的方式进行显示。</p>
</li>
<li><p>VCL基本介绍</p>
<p>​        Varnish Configuration Language (VCL)是varnish配置缓存策略的工具，它是一种基于“域”(domain specific)的简单编程语言，它支持有限的算术运算和逻辑运算操作、允许使用正则表达式进行字符串匹配、允许用户使用set自定义变量、支持if判断语句，也有内置的函数和变量等。使用VCL编写的缓存策略通常保存至.vcl文件中，其需要编译成二进制的格式后才能由varnish调用。事实上，整个缓存策略就是由几个特定的子例程如vcl_recv、vcl_fetch等组成，它们分别在不同的位置(或时间)执行，如果没有事先为某个位置自定义子例程，varnish将会执行默认的定义。</p>
<p>​        VCL策略在启用前，会由management进程将其转换为C代码，而后再由gcc编译器将C代码编译成二进制程序。编译完成后，management负责将其连接至varnish实例，即child进程。正是由于编译工作在child进程之外完成，它避免了装载错误格式VCL 的风险。因此，varnish修改配置的开销非常小，其可以同时保有几份尚在引用的旧版本配置，也能够让新的配置即刻生效。编译后的旧版本配置通常在 varnish重启时才会被丢弃，如果需要手动清理，则可以使用varnishadm的vcl.discard命令完成。</p>
</li>
<li><p>varnish的后端存储</p>
<p>​        varnish的缓存对象在每次服务重启时都会被清空并重新建立，所以这些服务器都是不应该随便去重启的，varnish为了把数据更持久化的存储，引入了更多的存储机制，所以varnish支持多种不同的后端存储；</p>
<p>​        varnish支持多种不同类型的后端存储，这可以在varnishd启动时使用-s选项指定。后端存储的类型包括：</p>
<ul>
<li><p>file：使用特定的文件存储全部的缓存数据，并通过操作系统的mmap()系统调用将整个缓存文件映射至内存区域(如果条件允许)；</p>
</li>
<li><p>malloc：使用malloc()库调用在varnish启动时向操作系统申请指定大小的内存空间以存储缓存对象；</p>
</li>
<li><p>persistent(experimental)：与file的功能相同，但可以持久存储数据(即重启varnish数据时不会被清除)；仍处于测试期；</p>
</li>
</ul>
<p>​        varnish无法追踪某缓存对象是否存入了缓存文件，从而也就无从得知磁盘上的缓存文件是否可用，因此，file存储方法在varnish停止或重启时会清除数据。而persistent方法的出现对此有了一个弥补，但persistent仍处于测试阶段，例如目前尚无法有效处理要缓存对象总体大小超出缓存空间的情况，所以，其仅适用于有着巨大缓存空间的场景。</p>
<p>​        选择使用合适的存储方式有助于提升系统性，从经验的角度来看，建议在内存空间足以存储所有的缓存对象时使用malloc的方法，反之，file存储将有着更好的性能的表现。然而，需要注意的是，varnishd实际上使用的空间比使用-s选项指定的缓存空间更大，一般说来，其需要为每个缓存对象多使用差不多1K左右的存储空间，这意味着，对于100万个缓存对象的场景来说，其使用的缓存空间将超出指定大小1G左右。另外，为了保存数据结构等，varnish自身也会占去不小的内存空间。</p>
</li>
<li><p>涉及VCL语法的改变点</p>
<ul>
<li>vcl配置文件需明确指定版本：即在vcl文件的第一行写上 vcl 4.0;</li>
<li>vcl_fetch函数被vcl_backend_response代替，且req.*不再适用vcl_backend_response；</li>
<li>后端源服务器组director成为varnish模块，需import directors后再在vcl_init子例程中定义；</li>
<li>自定义的子例程(即一个sub)不能以vcl_开头，调用使用call sub_name；</li>
<li>error()函数被synth()替代；</li>
<li>return(lookup)被return(hash)替代；</li>
<li>使用beresp.uncacheable创建hit_for_pss对象；</li>
<li>变量req.backend.healty被std.healthy(req.backend)替代；</li>
<li>变量req.backend被req.backend_hint替代；</li>
<li>关键字remove被unset替代；</li>
</ul>
<p>详见：<a href="https://www.varnish-cache.org/docs/4.0/whats-new/index.html#whats-new-index" target="_blank" rel="noopener">https://www.varnish-cache.org/docs/4.0/whats-new/index.html#whats-new-index</a></p>
</li>
<li><p>架构及文件缓存的工作流程</p>
<p><img src="/images/varnish/varnish文件缓存.png" alt=""></p>
<ul>
<li>Varnish 分为 master 进程和 child 进程；</li>
<li>Master 进程读入存储配置文件，调用合适的存储类型，然后创建 / 读入相应大小的缓存文件，接着 master 初始化管理该存储空间的结构体，然后 fork 并监控 child 进程；</li>
<li>Child 进程在主线程的初始化的过程中，将前面打开的存储文件整个 mmap 到内存中，此时创建并初始化空闲结构体，挂到存储管理结构体，以待分配；</li>
<li>对外管理接口分为3种，分别是命令行接口、Telnet接口和Web接口；</li>
<li>同时在运行过程中修改的配置，可以由VCL编译器编译成C语言，并组织成共享对象(Shared Object)交由Child进程加载使用；</li>
</ul>
<p><img src="/images/varnish/varnish文件缓存2.png" alt=""></p>
<p>Child 进程分配若干线程进行工作，主要包括一些管理线程和很多 worker 线程，可分为：</p>
<ul>
<li>Accept线程：接受请求，将请求挂在overflow队列上；</li>
<li>Work线程：有多个，负责从overflow队列上摘除请求，对请求进行处理，直到完成，然后处理下一个请求；</li>
<li>Epoll线程：一个请求处理称为一个session，在session周期内，处理完请求后，会交给Epoll处理，监听是否还有事件发生；</li>
<li>Expire线程：对于缓存的object，根据过期时间，组织成二叉堆，该线程周期检查该堆的根，处理过期的文件，对过期的数据进行删除或重取操作；</li>
</ul>
</li>
<li><p>varnish的工作原理及工作流程</p>
<p>官方提供的工作流程图:</p>
<p><img src="/images/varnish/varnish架构.jpg" alt=""></p>
<p>vcl的工作方式是基于状态引擎(state engine)来实现的；上图说明：</p>
<p>​        vcl_recv的结果如果可以查询缓存并可以识别，那就要到vcl_hash这步了，如果无法识别那就通过pipe(管道)送给vcl_pipe，如果能识别，但不是一个可缓存的对象，那就通过pass送到vcl_pass去。vcl_hash之后就可查看缓存中有没有了，有这个请求的对象就表示命中 (vcl_hit)，如果没有那就表示未命中(vcl_miss)，如果命中的就可以直接通过deliver直接送给vcl_deliver响应了，如果未命中就通过fetch交给vcl_fatch去后端服务器上去取数据，取回数据之后如果数据可以缓存就缓存(cache)，本地缓存完之后再构建响应，如果不可以缓存就不做缓存交给vcl_deliver响应了；而如果命中了交给vcl_pass，交给pass之后就要到Fetch objet from backend后端服务器上去取数据了，这是因为这个命中的对象可能是过期或者是要做单独额外的处理的；这就是vcl的状态引擎过程。</p>
</li>
<li><p>Varnish 处理 HTTP 请求的过程如下</p>
<ol>
<li>Receive 状态（vcl_recv）：也就是请求处理的入口状态，根据 VCL 规则判断该请求应该 pass（vcl_pass）或是 pipe（vcl_pipe），还是进入 lookup（本地查询）；</li>
<li>Lookup 状态：进入该状态后，会在 hash 表中查找数据，若找到，则进入 hit（vcl_hit）状态，否则进入 miss（vcl_miss）状态；</li>
<li>Pass（vcl_pass）状态：在此状态下，会直接进入后端请求，即进入 fetch（vcl_fetch）状态；</li>
<li>Fetch（vcl_fetch）状态：在 fetch 状态下，对请求进行后端获取，发送请求，获得数据，并根据设置进行本地存储；</li>
<li>Deliver（vcl_deliver）状态：将获取到的数据发给客户端，然后完成本次请求；</li>
</ol>
<p>注：Varnish4中在vcl_fetch部分略有出入，已独立为vcl_backend_fetch和vcl_backend_response2个函数；</p>
</li>
<li><p>内置函数(也叫子例程)</p>
<ul>
<li>vcl_recv：用于接收和处理请求；当请求到达并成功接收后被调用，通过判断请求的数据来决定如何处理请求；</li>
<li>vcl_pipe：此函数在进入pipe模式时被调用，用于将请求直接传递至后端主机，并将后端响应原样返回客户端；</li>
<li>vcl_pass：此函数在进入pass模式时被调用，用于将请求直接传递至后端主机，但后端主机的响应并不缓存直接返回客户端；</li>
<li>vcl_hit：在执行 lookup 指令后，在缓存中找到请求的内容后将自动调用该函数；</li>
<li>vcl_miss：在执行 lookup 指令后，在缓存中没有找到请求的内容时自动调用该方法，此函数可用于判断是否需要从后端服务器获取内容；</li>
<li>vcl_hash：在vcl_recv调用后为请求创建一个hash值时，调用此函数；此hash值将作为varnish中搜索缓存对象的key；</li>
<li>vcl_purge：pruge操作执行后调用此函数，可用于构建一个响应；</li>
<li>vcl_deliver：将在缓存中找到请求的内容发送给客户端前调用此方法；</li>
<li>vcl_backend_fetch：向后端主机发送请求前，调用此函数，可修改发往后端的请求；</li>
<li>vcl_backend_response：获得后端主机的响应后，可调用此函数；</li>
<li>vcl_backend_error：当从后端主机获取源文件失败时，调用此函数；</li>
<li>vcl_init：VCL加载时调用此函数，经常用于初始化varnish模块(VMODs)</li>
<li>vcl_fini：当所有请求都离开当前VCL，且当前VCL被弃用时，调用此函数，经常用于清理varnish模块；</li>
</ul>
</li>
<li><p>VCL中内置公共变量</p>
<p>变量(也叫object)适用范围</p>
<p><img src="/images/varnish/varnish内置公共变量.jpg" alt=""></p>
</li>
<li><p>变量类型详解</p>
<p><img src="/images/varnish/varnish变量类型详解.jpg" alt=""></p>
<ul>
<li>req：The request object，请求到达时可用的变量</li>
<li>bereq：The backend request object，向后端主机请求时可用的变量</li>
<li>beresp：The backend response object，从后端主机获取内容时可用的变量</li>
<li>resp：The HTTP response object，对客户端响应时可用的变量</li>
<li>obj：存储在内存中时对象属性相关的可用的变量</li>
</ul>
<p>具体变量详见：<a href="https://www.varnish-cache.org/docs/4.0/reference/vcl.html#reference-vcl" target="_blank" rel="noopener">https://www.varnish-cache.org/docs/4.0/reference/vcl.html#reference-vcl</a></p>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/11/mysql问题解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/11/mysql问题解决/" itemprop="url">
                  mysql问题解决
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-06-11 16:59:50 / 修改時間：17:08:18" itemprop="dateCreated datePublished" datetime="2019-06-11T16:59:50+08:00">2019-06-11</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="登录数据库后无法对数据库操作"><a href="#登录数据库后无法对数据库操作" class="headerlink" title="登录数据库后无法对数据库操作"></a>登录数据库后无法对数据库操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 登录数据库后无法对数据库操作，使用任何命令都会提示“You must reset your password using ALTER USER statement before executing this statement.”</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 有一说是因为密码过期，所以会这样。解决方法如下：</span></span><br><span class="line">vim /usr/lib/systemd/system/mysqld.service </span><br><span class="line">ExecStart=/usr/sbin/mysqld --daemonize --skip-grant-tables --skip-networking --pid-file=/var/run/mysqld/mysqld.pid $MYSQLD_OPTS</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入--skip-grant-tables --skip-networking，可以免密码登录</span></span><br><span class="line">mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 登录</span></span><br><span class="line">use mysql；</span><br><span class="line">desc user；</span><br><span class="line">authentication_string  | text                              | YES  |     | NULL                  |       |</span><br><span class="line">| password_expired       | enum('N','Y')                     | NO   |     | N </span><br><span class="line"><span class="meta">#</span><span class="bash"> 说是从上面两条信息可以看出password_expired过期。</span></span><br><span class="line">UPDATE user SET authentication_string=PASSWORD('DaaS_mysql_201!'),password_expired='N' WHERE User='root'; </span><br><span class="line">select authentication_string,password_expired from user where user='root';</span><br><span class="line">+-------------------------------------------+------------------+</span><br><span class="line">| authentication_string                     | password_expired |</span><br><span class="line">+-------------------------------------------+------------------+</span><br><span class="line">| *5ECB9CC025100F03131724B02A092F02D9417C96 | N                |</span><br><span class="line">+-------------------------------------------+------------------+</span><br><span class="line">desc user;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此命令又看了一次，与上面查询的没有区别。所以不知道如何证明是过期了？</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 之后将上面的免密码登录恢复回去。再操作就正常了。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/30/解决服务器千兆网卡显示只有百兆速度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/30/解决服务器千兆网卡显示只有百兆速度/" itemprop="url">
                  解决服务器千兆网卡显示只有百兆速度
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-05-30 16:02:47" itemprop="dateCreated datePublished" datetime="2019-05-30T16:02:47+08:00">2019-05-30</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-11 11:33:01" itemprop="dateModified" datetime="2019-06-11T11:33:01+08:00">2019-06-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">ethtool eno1</span><br><span class="line">Settings for eno1:</span><br><span class="line">        Supported ports: [ TP ]</span><br><span class="line">        Supported link modes:   10baseT/Half 10baseT/Full </span><br><span class="line">                                100baseT/Half 100baseT/Full </span><br><span class="line">                                1000baseT/Full </span><br><span class="line">        Supported pause frame use: Symmetric</span><br><span class="line">        Supports auto-negotiation: Yes</span><br><span class="line">        Advertised link modes:  10baseT/Half 10baseT/Full </span><br><span class="line">                                100baseT/Half 100baseT/Full </span><br><span class="line">                                1000baseT/Full </span><br><span class="line">        Advertised pause frame use: Symmetric</span><br><span class="line">        Advertised auto-negotiation: Yes</span><br><span class="line">        Speed: 100Mb/s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用命令查看时，虽然显示是千兆网卡，但Speed只有100Mb/s</span></span><br><span class="line">ethtool -s eno1 speed 1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用上面命令可能将网卡重新设置为1000Mb/s</span></span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-eno1</span><br><span class="line">ETHTOOL_OPTS="speed 1000 duplex full autoneg off"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在网卡配置中加入上面一行，可以强制将网卡设置为千兆。</span></span><br><span class="line"></span><br><span class="line">==============================================================================================</span><br><span class="line">ethtool命令的简单使用</span><br><span class="line">ethtool ethX</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看网卡信息</span></span><br><span class="line">ethtool –h		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示ethtool的命令帮助(<span class="built_in">help</span>)</span></span><br><span class="line">ethtool –i ethX </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询ethX网口的相关信息</span></span><br><span class="line">ethtool –d ethX </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询ethX网口注册性信息</span></span><br><span class="line">ethtool –r ethX </span><br><span class="line"><span class="meta">#</span><span class="bash"> 重置ethX网口到自适应模式</span></span><br><span class="line">ethtool –S ethX </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询ethX网口收发包统计</span></span><br><span class="line">ethtool –s ethX [speed 10|100|1000] [duplex half|full] [autoneg on|off] [port tp|aui|bnc|mii] </span><br><span class="line"><span class="meta">#</span><span class="bash"> [speed 10|100|1000]     设置网口速率10/100/1000M</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [duplex half|full]     设置网口半/全双工</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [autoneg on|off]     设置网口是否自协商</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [port tp|aui|bnc|mii]      设置网口类型</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/29/Tilix连接远程主机/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/29/Tilix连接远程主机/" itemprop="url">
                  Tilix连接远程主机
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-05-29 17:19:42" itemprop="dateCreated datePublished" datetime="2019-05-29T17:19:42+08:00">2019-05-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-09-30 11:43:10" itemprop="dateModified" datetime="2019-09-30T11:43:10+08:00">2019-09-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>打开首选项–&gt;书签–&gt;添加书签</li>
</ol>
<p><img src="/images/tilix/tillix添加书签.png" alt=""></p>
<ol start="2">
<li>输入信息</li>
</ol>
<p><img src="/images/tilix/tillix添加书签2.png" alt=""></p>
<ol start="3">
<li>连接测试</li>
</ol>
<p><img src="/images/tilix/tillix连接1.png" alt=""></p>
<p><img src="/images/tilix/tillix连接2.png" alt=""></p>
<p><img src="/images/tilix/tillix连接3.png" alt=""></p>
<ol start="4">
<li>创建密码，在确定添加时可能会要求输入密码，不然无法添加</li>
</ol>
<p><img src="/images/tilix/tillix创建密码1.png" alt=""></p>
<p><img src="/images/tilix/tillix创建密码2.png" alt=""></p>
<p><img src="/images/tilix/tillix创建密码3.png" alt=""></p>
<p><img src="/images/tilix/tillix创建密码4.png" alt=""></p>
<ol start="5">
<li>连接时，选择书签中创建的远程服务器成功后，可以再从助手中选择创建的密码，这样就可以连接上远程服务器了。如果之前就将本机的公钥发送到了远程的主机，就不需要再选择密码了，选择远程主机时就可以连接上了。</li>
<li>如果创建的远程连接信息有误，可以到Profiles -&gt; Edit Profile -&gt; Bookmarks中修改或删除</li>
<li>如果连接时需要密钥对，需要在输入完Name、Host、User后，在Parameters中输入-i “awsTest.pem”。这样就可以登录了。另外，如登录aws时，官方还会提供登录的方法。如登录时Redhat系统要使用ec2-user用户，ubuntu系统使用ubuntu，看一下官方的提示信息。进入系统后可以使用sudo passwd修改root密码。如果连接时的密钥没有了，可以在aws页面中的密钥对页面里重新创建。下图为官方提供的方法与tilix的配置方法</li>
</ol>
<p><img src="/images/tilix/aws登录方法0" alt=""></p>
<p><img src="/images/tilix/aws登录方法1" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/29/使用默认终端连接远程服务器-ssh-config的作用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/29/使用默认终端连接远程服务器-ssh-config的作用/" itemprop="url">
                  使用默认终端连接远程服务器(.ssh/config的作用)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-05-29 14:02:30 / 修改時間：14:14:26" itemprop="dateCreated datePublished" datetime="2019-05-29T14:02:30+08:00">2019-05-29</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">如果使用系统上的默认终端连接多个远程终端？</span><br><span class="line">1. 创建公钥并传到远程服务器</span><br><span class="line">ssh-keygen -t rsa -P ''</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub 10.129.14.4</span><br><span class="line"></span><br><span class="line">2. 配置</span><br><span class="line">vim .ssh/config</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此文件开始是没有的，手动添加即可</span></span><br><span class="line">Host dl-gw-01              # 在ssh连接时要使用的远程主机名，这个名字是自定义的</span><br><span class="line">    HostName 10.129.14.4		# 远程主机地址</span><br><span class="line">    Port 22		# 远程主机ssh端口</span><br><span class="line">    User root		# 远程主机的用户名</span><br><span class="line"></span><br><span class="line">3. 关闭服务器上的密码认证，开启公钥认证，在/etc/ssh/sshd_conf中修改下面即可</span><br><span class="line">PubkeyAuthentication yes 			# 开启公钥认证</span><br><span class="line">PasswordAuthentication no			# 关闭密码认证</span><br><span class="line"></span><br><span class="line">4. .ssh/config的使用方法</span><br><span class="line">Host dl-gw-01</span><br><span class="line">    HostName 10.129.14.4</span><br><span class="line">    </span><br><span class="line">Host dl-gw-02</span><br><span class="line">    HostName 10.129.14.5</span><br><span class="line">    </span><br><span class="line">Host dl-gw-*</span><br><span class="line">    User root		# 这样使用的方式是一个通用配置，只要是dl-gw-开头的主机都使用root用户登录</span><br><span class="line">   </span><br><span class="line">Host *</span><br><span class="line">    Port 22		# 这样使用通用配置也可以</span><br><span class="line">    </span><br><span class="line">5. 连接</span><br><span class="line">ssh dl-gw-01</span><br></pre></td></tr></table></figure>
<p>参考：<a href="https://www.cnblogs.com/xjshi/p/9146296.html" target="_blank" rel="noopener">https://www.cnblogs.com/xjshi/p/9146296.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/24/网络工具使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/24/网络工具使用/" itemprop="url">
                  网络工具使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-05-24 23:29:55" itemprop="dateCreated datePublished" datetime="2019-05-24T23:29:55+08:00">2019-05-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-11 11:32:42" itemprop="dateModified" datetime="2019-06-11T11:32:42+08:00">2019-06-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="针对协议抓包"><a href="#针对协议抓包" class="headerlink" title="针对协议抓包"></a>针对协议抓包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i ens1f0 icmp -vv -nn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以直接指定协议，但后面不能使用host参数。测试发现，如果不加-nn选项，tcpdump不会抓到任何包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -n是对地址以数字方式显式，否则显式为主机名，也就是说-n选项不做主机名解析。-nn除了-n的作用外，还把端口显示为数值，否则显示端口服务名。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -v是显示详细信息，加一个v就可以显示更详细的信息，最多是-vvv。</span></span><br></pre></td></tr></table></figure>
<h3 id="使用指定网卡ping"><a href="#使用指定网卡ping" class="headerlink" title="使用指定网卡ping"></a>使用指定网卡ping</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping -I ens1f0 10.129.14.65</span><br></pre></td></tr></table></figure>
<h3 id="CentOS服务器多网卡配置"><a href="#CentOS服务器多网卡配置" class="headerlink" title="CentOS服务器多网卡配置"></a>CentOS服务器多网卡配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">问题：在某服务器上安装CentOS7.3系统，配置两个网段的IP地址，一为10.129.14.16/27，一为10.129.14.40/27。客户端使用10.129.27/27，网关10.129.14.1。使用客户端ping服务器两地址时，只能ping能10.129.14.16/27，ping10.129.14.40/27时页面停住不动，查看服务器，应该是ping包可以到达服务器，但无法返回。</span><br><span class="line"></span><br><span class="line">解决：</span><br><span class="line">1. 配置服务器网卡</span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-enp96s0f0</span><br><span class="line">TYPE="Ethernet"</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">DEFROUTE="yes"</span><br><span class="line">NAME="enp96s0f0"</span><br><span class="line">UUID="5f90c86f-c21f-489e-ae8f-cf36e6eac588"</span><br><span class="line">DEVICE="enp96s0f0"</span><br><span class="line">ONBOOT="yes"</span><br><span class="line">DNS1="202.96.209.6"</span><br><span class="line">DNS2="202.96.209.133"</span><br><span class="line">IPADDR=10.129.14.16</span><br><span class="line">PREFIX=27</span><br><span class="line"><span class="meta">#</span><span class="bash">GATEWAY=10.129.14.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注释网卡配置中的GATEWAY一项，多块网卡都要注释</span></span><br><span class="line"></span><br><span class="line">2. 配置策略路由表</span><br><span class="line">vim /etc/iproute2/rt_tables </span><br><span class="line">252 enp96s0f1-32</span><br><span class="line">251 enp96s0f0-0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入上面两行，前面的数字是路由表的编号，后面是自定义的表名。路由表的编号是自定义的，但linux最多可管理255个表，不要超过这个数字，另外，rt_table中原有的编号不要动，自定义的表编号也不要与原有的编号冲突。</span></span><br><span class="line"></span><br><span class="line">3. 配置策略路由</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将路由规则加入CentOS7中的/etc/rc.d/init.d/network中可以使重启网卡时路由依然生效，方法如下</span></span><br><span class="line">vim /etc/rc.d/init.d/network</span><br><span class="line">ip route flush table enp96s0f0-0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 先清空策略路由表</span></span><br><span class="line">ip route add default via 10.129.14.1 dev enp96s0f0 src 10.129.14.16 table enp96s0f0-0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加一条策略路由规则，下一跳到10.129.14.1，网卡是enp96s0f0，源地址为10.129.14.16，添加到策略路由表enp96s0f0-0</span></span><br><span class="line">ip rule add from 10.129.14.16 table enp96s0f0-0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将从10.129.14.16经过的数据包都从enp96s0f0-0策略路由表中走</span></span><br><span class="line">ip route flush table enp96s0f1-32</span><br><span class="line">ip route add default via 10.129.14.33 dev enp96s0f1 src 10.129.14.40 table enp96s0f1-32</span><br><span class="line">ip rule add from 10.129.14.40 table enp96s0f1-32</span><br><span class="line"></span><br><span class="line">ip route add default via 10.129.14.1 dev enp96s0f0</span><br><span class="line"></span><br><span class="line">exit $rc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里要注意，一定要添加在最后一行的<span class="built_in">exit</span> <span class="variable">$rc</span>之上。</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart network</span><br><span class="line">ip route</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看路由，加入的默认路由生效了</span></span><br><span class="line">ip rule</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看生效的策略路由表</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最后，测试的机器上也要加一条到某网段的路由，如sudo ip route add 10.129.14.32/27 via 10.129.14.1。因为默认会从无线走如果不加这条路由规则，就要将无线断开或删除这条默认路由</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时客户端就可以ping通服务器的两个ip地址了</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/24/zookeeper问题解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/24/zookeeper问题解决/" itemprop="url">
                  zookeeper问题解决
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-05-24 23:13:29 / 修改時間：23:24:11" itemprop="dateCreated datePublished" datetime="2019-05-24T23:13:29+08:00">2019-05-24</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/消息队列/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="查看状态显示”not-running”"><a href="#查看状态显示”not-running”" class="headerlink" title="查看状态显示”not running”"></a>查看状态显示”not running”</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看zookeeper集群状态显示有<span class="string">"not running"</span>字样</span></span><br><span class="line">bin/zkServer.sh status</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看状态</span></span><br><span class="line">tail -100 zookeeper.out</span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper的启动信息在此文件中，此文件在zkServer.sh中定义，内容大概为<span class="string">"_ZOO_DAEMON_OUT="</span><span class="variable">$ZOO_LOG_DIR</span>/zookeeper.out<span class="string">"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动失败时，在此文件中显示<span class="string">"Unexpected exception causing shutdown while sock still open"</span>，解决办法一般有三，如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. 将zookeeper主机名更改为IP地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 以递减的id序列启动zookeeper实例。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 将initSize从5增加到100</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此次大连广电的zookeeper集群不能启动的原因是没有把/xor/data0和data1里的zookeeper目录下的所有文件的属主和属组改为hadoop，因为启动zookeeper的是hadoop，不知道是哪设置的，在supervisord.conf中改user是没用的。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/16/分区工具parted/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/16/分区工具parted/" itemprop="url">
                  分区工具parted
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2019-05-16 16:57:09" itemprop="dateCreated datePublished" datetime="2019-05-16T16:57:09+08:00">2019-05-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-05-17 18:19:00" itemprop="dateModified" datetime="2019-05-17T18:19:00+08:00">2019-05-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">parted</span><br><span class="line">select /dev/sdb         #切换磁盘</span><br><span class="line">mklable gpt         # 切换为gpt模式</span><br><span class="line">mkpart primary 0 -1         # 创建磁盘，命名为primary，0 -1表示分配所有磁盘空间</span><br><span class="line">toggle 1 lvm        # 将第1个分区改为lvm</span><br><span class="line">print       # 查看</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里有一个问题，分配大于2TB空间的磁盘，在查看分区时会有一个Partition 1 does not start on physical sector boundary.的提示</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以使用gdisk工具分配大于2TB空间的磁盘，使用方法与fdisk类似。</span></span><br><span class="line"></span><br><span class="line">unit TB		# 设置单位为TB</span><br><span class="line">mkpart primary 0 3 		# 设置为一个主分区,大小为3TB，开始是0，结束是3</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">157</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">122</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
