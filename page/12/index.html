<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/12/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/12/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/19/Wireshark使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/19/Wireshark使用/" itemprop="url">
                  Wireshark使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-19 14:57:55" itemprop="dateCreated datePublished" datetime="2018-11-19T14:57:55+08:00">2018-11-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-06-11 11:33:55" itemprop="dateModified" datetime="2019-06-11T11:33:55+08:00">2019-06-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>打开软件后，要选择对哪块网卡抓包，双击即可进入。或点击前头指向的图标</p>
<p><img src="/images/Wireshark/Wireshark启动1.jpg" alt=""></p>
<p>方框部分表示启用混杂模式，然后点击start即可。如果不选择混杂模式，那么抓到的包就都是从选择的网卡进或出的包，也就是只抓取与本机相关的包。如果选择混杂模式，那么经过本机网卡的包都会被抓取。</p>
<p><img src="/images/Wireshark/Wireshark启动2.jpg" alt=""></p>
<p>下面方框部分是抓包筛选器，可以通过筛选器过滤掉不想要的数据包</p>
<p><img src="/images/Wireshark/Wireshark启动3.jpg" alt=""></p>
<p>点击方框部分可以创建一个新的抓包筛选器</p>
<p><img src="/images/Wireshark/Wireshark启动4.jpg" alt=""></p>
<p><img src="/images/Wireshark/Wireshark启动5.jpg" alt=""></p>
<p>比如只想抓IP地址是192.168.2.1的数据包，就可以选择下面方框部分</p>
<p><img src="/images/Wireshark/Wireshark启动6.jpg" alt=""></p>
<p>也可以只抓IP的包（方框部分），或管理筛选器规则（箭头部分）</p>
<p><img src="/images/Wireshark/Wireshark启动7.jpg" alt=""></p>
<p>下面是管理筛选器页面，可以自定义或删除规则</p>
<p><img src="/images/Wireshark/Wireshark启动8.jpg" alt=""></p>
<p>也可以手动输入，这里表示只抓取与本机IP相关的包，用host引导</p>
<p><img src="/images/Wireshark/Wireshark启动9.jpg" alt=""></p>
<p>这时可以看到页面中标明只抓取本机的包</p>
<p><img src="/images/Wireshark/Wireshark启动10.jpg" alt=""></p>
<p>中间部分是包的分层，从方框中的信息可以看到目标地址是本机。</p>
<p><img src="/images/Wireshark/Wireshark启动11.jpg" alt=""></p>
<p>先要停止抓包，才能保存</p>
<p><img src="/images/Wireshark/Wireshark启动12.jpg" alt=""></p>
<p><img src="/images/Wireshark/Wireshark启动13.jpg" alt=""></p>
<p>可以选择保存类型，建议使用pcap的格式，这种格式使用更广泛，也就是下图中的第二种格式，在保存时还可以选择Compress with gzip来进行压缩保存</p>
<p><img src="/images/Wireshark/Wireshark启动14.jpg" alt=""></p>
<p>首选项</p>
<p><img src="/images/Wireshark/Wireshark启动15.jpg" alt=""></p>
<p>调整结构</p>
<p><img src="/images/Wireshark/Wireshark启动16.jpg" alt=""></p>
<p>调整后的效果，这里取消了16进制信息的显示</p>
<p><img src="/images/Wireshark/Wireshark启动17.jpg" alt=""></p>
<p>还可以对包的显示信息列进行调整，也可以添加或删除</p>
<p><img src="/images/Wireshark/Wireshark启动18.jpg" alt=""></p>
<p>方框中是wireshark可以解码的所有协议类型</p>
<p><img src="/images/Wireshark/Wireshark启动19.jpg" alt=""></p>
<p>数据会先经过抓包筛选器进行过滤，之后再对抓到的包进行显示筛选</p>
<p>方框部分就是显示筛选器</p>
<p><img src="/images/Wireshark/Wireshark启动20.jpg" alt=""></p>
<p>只想查看到DNS相关的包，输入好后按右面的箭头进行应用。</p>
<p><img src="/images/Wireshark/Wireshark启动21.jpg" alt=""></p>
<p>这里想创建一个组合的显示条件，输入udp，之后在包分层中按红框选择，在Source上右键，选择Apply as Filter中的and not selected。之后就会在显示筛选器中出现一条筛选语句。这条语句表示，即是udp的包，但来源不是192.168.0.20地址的包</p>
<p><img src="/images/Wireshark/Wireshark启动22.jpg" alt=""></p>
<p>也可以把规则改为目的地址ip.dst，或地址ip.addr。筛选完成后可再按上面步骤进一步筛选，一定要选择and not selected，这样规则就会叠加。</p>
<p><img src="/images/Wireshark/Wireshark启动23.jpg" alt=""></p>
<h3 id="Wireshark信息统计"><a href="#Wireshark信息统计" class="headerlink" title="Wireshark信息统计"></a>Wireshark信息统计</h3><p>统计功能基本都在Statistics菜单下</p>
<p><img src="/images/Wireshark/Wireshark信息统计1.jpg" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/19/tcpdump命令使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/19/tcpdump命令使用/" itemprop="url">
                  tcpdump命令使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-19 10:27:01 / 修改時間：14:38:30" itemprop="dateCreated datePublished" datetime="2018-11-19T10:27:01+08:00">2018-11-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="tcpdump命令使用"><a href="#tcpdump命令使用" class="headerlink" title="tcpdump命令使用"></a>tcpdump命令使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">* tcpdump如果不指定字节大小，默认只抓每个包的前68个字节。通常是把tcp、ip、还有包头可以抓完整的</span><br><span class="line">例：</span><br><span class="line">root@kali:~# tcpdump -i eth0 -s 0 -w a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> -i指定网卡；-s指定数据包的大小，如果用0就表示全部包，这里应该指定的是多少字节；-w指定将结果保存到一个文件中。这会抓取到所有经过eth0端口的包。70900 packets captured表示抓到了70900个包</span></span><br><span class="line">ping 172.16.0.108</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用另一台主机ping这台kali，产生一些数据包</span></span><br><span class="line">tcpdump -r a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 读取刚才生成的包文件</span></span><br><span class="line">tcpdump -A -r a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用ASCII码的格式显示包</span></span><br><span class="line">tcpdump -X -r a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用16进制的格式显示包</span></span><br><span class="line">tcpdump -i eth0 tcp port 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 抓取eth0上的tcp协议端口22的包，这叫抓包筛选器</span></span><br><span class="line">nc -nv 172.16.0.108 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用nc命令连接地址的端口</span></span><br><span class="line">nc -nv 172.16.0.108 80</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接80端口，但这时是不会抓取包的，因为只监听了网络的22端口</span></span><br><span class="line"></span><br><span class="line">例：显示筛选器</span><br><span class="line">tcpdump -n -r http.cap | awk '&#123;print $3&#125;' | sort -u</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示筛选器。-n表示不对包内的地址做名称解析。sort的-u选项是去除重复的项</span></span><br><span class="line">tcpdump -n src host 172.16.0.108 -r a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> src host表示源地址，这是只显示源地址是172.16.0.108的包</span></span><br><span class="line">tcpdump -n dst host 172.16.0.108 -r a.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示目标地址</span></span><br><span class="line">tcpdump -n port 53 -r http.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示端口为53的包</span></span><br><span class="line">tcpdump -n tcp port 53 -r http.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示tcp的包，也可以显示udp协议的包</span></span><br><span class="line">tcpdump -nX port 80 -r http.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以加上X选项，以16进制显示</span></span><br><span class="line"></span><br><span class="line">* 高级筛选</span><br><span class="line">可以筛选包头里其他部分。图中是TCP的包头结构，以8个位为一个字节，每一行的内容表示4个字节，0-7是一个字节，8-16又是一个字节。一共是32个位。源端口占用了前面的16个位，也就是两个字节。目的端口占用后面的2个位（16个字节）。之后的Sequence Number和Acknowledgment Number都是占用32个位的，也就是4个字节。下面一个字节被分成了两个部分，第一部分是数据的偏移量，如果这时包被分段了，那么就会有数据的偏移量，保留了几个位之后，后面的就是tcp的flag，也就是标签位，表示当前这个包是什么类型的包，如是SYN包，还是回的ACK+SYN包，每一个位表示一个包的类型，如FIN是1，就表示FIN的flag标签的包，也就是哪位是1，就表示是那个位对应的类型的包有效。三次握手后，客户端发送的就是ACK+PSH包，这时这两个会标记为1，表示这是数据传输最起始的步骤。使用筛选时，如果不想看握手的包，就可以指定ACK+PSH为1的数据包。在图中，类型有8个，每个占用一个位，一共8位，我们要筛选的就是ACK+PSH是1，其他位都是0的包，计算成十进制就是24，二进制是00011000，所以转换为十进制是24。另外在表示类型的行上面有三行，共占12个字节。在类型前面的Data Offset和Res.还占用了一个字节，所以tcp的flag位是tcp包头时的每14个字节。（因为tcp包头的字节是从0开始的，这里只筛选tcp包头里第14个字节，但从表达式来说，应该是第13号。也就是第13号字节，实际就是第14个字节）转换为十进制是24的这些数据包，表达式命令如果</span><br><span class="line">tcpdump -A -n 'tcp[13] = 24' -r http.cap</span><br></pre></td></tr></table></figure>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>用简单的话来定义tcpdump，就是：dump the traffic on a network，根据使用者的定义对网络上的数据包进行截获的包分析工具。 tcpdump可以将网络中传送的数据包的“头”完全截获下来提供分析。它支持针对网络层、协议、主机、网络或端口的过滤，并提供and、or、not等逻辑语句来帮助你去掉无用的信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">* 默认启动</span><br><span class="line">tcpdump</span><br><span class="line"><span class="meta">#</span><span class="bash"> 普通情况下，直接启动tcpdump将监视第一个网络接口上所有流过的数据包。</span></span><br><span class="line"></span><br><span class="line">* 监视指定网络接口的数据包</span><br><span class="line">tcpdump -i eth1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用-i选项指定网卡。如果不指定网卡，默认tcpdump只会监视第一个网络接口，一般是eth0</span></span><br><span class="line"> </span><br><span class="line">* 监视指定主机的数据包</span><br><span class="line">tcpdump host sundown</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印所有进入或离开sundown的数据包.</span></span><br><span class="line"></span><br><span class="line">tcpdump host 210.27.48.1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以指定ip,例如截获所有210.27.48.1 的主机收到的和发出的所有的数据包</span></span><br><span class="line"></span><br><span class="line">tcpdump host helios and \( hot or ace \)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印helios 与 hot 或者与 ace 之间通信的数据包</span></span><br><span class="line"></span><br><span class="line">tcpdump host 210.27.48.1 and \ (210.27.48.2 or 210.27.48.3 \) </span><br><span class="line"><span class="meta">#</span><span class="bash"> 截获主机210.27.48.1 和主机210.27.48.2 或210.27.48.3的通信</span></span><br><span class="line"></span><br><span class="line">tcpdump ip host ace and not helios</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印ace与任何其他主机之间通信的IP 数据包, 但不包括与helios之间的数据包.</span></span><br><span class="line"></span><br><span class="line">tcpdump ip host 210.27.48.1 and ! 210.27.48.2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取主机210.27.48.1除了和主机210.27.48.2之外所有主机通信的ip包</span></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 src host hostname</span><br><span class="line"><span class="meta">#</span><span class="bash"> 截获主机hostname发送的所有数据</span></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 dst host hostname</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监视所有发送到主机hostname的数据包</span></span><br><span class="line"> </span><br><span class="line">* 监视指定主机和端口的数据包</span><br><span class="line"></span><br><span class="line">tcpdump tcp port 23 and host 210.27.48.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取主机210.27.48.1接收或发出的telnet包</span></span><br><span class="line"></span><br><span class="line">tcpdump udp port 123 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 对本机的udp 123 端口进行监视，123为ntp的服务端口</span></span><br><span class="line"> </span><br><span class="line">* 监视指定网络的数据包</span><br><span class="line">tcpdump net ucb-ether</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印本地主机与Berkeley网络上的主机之间的所有通信数据包(nt: ucb-ether, 此处可理解为<span class="string">'Berkeley网络'</span>的网络地址,此表达式最原始的含义可表达为: 打印网络地址为ucb-ether的所有数据包)</span></span><br><span class="line"></span><br><span class="line">tcpdump 'gateway snup and (port ftp or ftp-data)'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印所有通过网关snup的ftp数据包(注意, 表达式被单引号括起来了, 这可以防止shell对其中的括号进行错误解析)</span></span><br><span class="line"></span><br><span class="line">tcpdump ip and not net localnet</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印所有源地址或目标地址是本地主机的IP数据包(如果本地网络通过网关连到了另一网络, 则另一网络并不能算作本地网络.(nt: 此句翻译曲折,需补充).localnet 实际使用时要真正替换成本地网络的名字)</span></span><br><span class="line"> </span><br><span class="line">* 监视指定协议的数据包</span><br><span class="line">tcpdump 'tcp[tcpflags] &amp; (tcp-syn|tcp-fin) != 0 and not src and dst net localnet'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印TCP会话中的的开始和结束数据包, 并且数据包的源或目的不是本地网络上的主机.(nt: localnet, 实际使用时要真正替换成本地网络的名字)</span></span><br><span class="line"></span><br><span class="line">tcpdump 'tcp port 80 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0)'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印所有源或目的端口是80, 网络层协议为IPv4, 并且含有数据,而不是SYN,FIN以及ACK-only等不含数据的数据包.(ipv6的版本的表达式可做练习)(nt: 可理解为, ip[2:2]表示整个ip数据包的长度, (ip[0]&amp;0xf)&lt;&lt;2)表示ip数据包包头的长度(ip[0]&amp;0xf代表包中的IHL域, 而此域的单位为32bit, 要换算成字节数需要乘以4,　即左移2.　(tcp[12]&amp;0xf0)&gt;&gt;4 表示tcp头的长度, 此域的单位也是32bit,　换算成比特数为 ((tcp[12]&amp;0xf0) &gt;&gt; 4)　&lt;&lt;　２,　 即 ((tcp[12]&amp;0xf0)&gt;&gt;2).　((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0　表示: 整个ip数据包的长度减去ip头的长度,再减去 tcp头的长度不为0, 这就意味着, ip数据包中确实是有数据.对于ipv6版本只需考虑ipv6头中的<span class="string">'Payload Length'</span> 与 <span class="string">'tcp头的长度'</span>的差值, 并且其中表达方式<span class="string">'ip[]'</span>需换成<span class="string">'ip6[]'</span>.)</span></span><br><span class="line"></span><br><span class="line">tcpdump 'gateway snup and ip[2:2] &gt; 576'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印长度超过576字节, 并且网关地址是snup的IP数据包</span></span><br><span class="line"></span><br><span class="line">tcpdump 'ether[0] &amp; 1 = 0 and ip[16] &gt;= 224'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印所有IP层广播或多播的数据包， 但不是物理以太网层的广播或多播数据报</span></span><br><span class="line"></span><br><span class="line">tcpdump 'icmp[icmptype] != icmp-echo and icmp[icmptype] != icmp-echoreply'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印除<span class="string">'echo request'</span>或者<span class="string">'echo reply'</span>类型以外的ICMP数据包( 比如,需要打印所有非ping 程序产生的数据包时可用到此表达式 . (nt: <span class="string">'echo reuqest'</span> 与 <span class="string">'echo reply'</span> 这两种类型的ICMP数据包通常由ping程序产生))</span></span><br><span class="line"></span><br><span class="line">tcpdump tcp -i eth1 -t -s 0 -c 100 and dst port ! 22 and src net 192.168.1.0/24 -w ./target.cap</span><br><span class="line"><span class="meta">#</span><span class="bash"> tcp: ip icmp arp rarp 和 tcp、udp、icmp这些选项等都要放到第一个参数的位置，用来过滤数据报的类型</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -i eth1 : 只抓经过接口eth1的包 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -t : 不显示时间戳 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -s 0 : 抓取数据包时默认抓取长度为68字节。加上-S 0 后可以抓到完整的数据包 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -c 100 : 只抓取100个数据包 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -dst port ! 22 : 不抓取目标端口是22的数据包 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -src net 192.168.1.0/24 : 数据包的源网络地址为192.168.1.0/24 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -w ./target.cap : 保存成<span class="built_in">cap</span>文件，方便用ethereal(即wireshark)分析</span></span><br><span class="line"></span><br><span class="line">* 使用tcpdump抓取HTTP包</span><br><span class="line">tcpdump  -XvvennSs 0 -i eth0 tcp[20:2]=0x4745 or tcp[20:2]=0x4854</span><br><span class="line"><span class="meta">#</span><span class="bash"> 0x4745 为<span class="string">"GET"</span>前两个字母<span class="string">"GE"</span>,0x4854 为<span class="string">"HTTP"</span>前两个字母<span class="string">"HT"</span>。</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> tcpdump 对截获的数据并没有进行彻底解码，数据包内的大部分内容是使用十六进制的形式直接打印输出的。显然这不利于分析网络故障，通常的解决办法是先使用带-w参数的tcpdump 截获数据并保存到文件中，然后再使用其他程序(如Wireshark)进行解码分析。当然也应该定义过滤规则，以避免捕获的数据包填满整个硬盘。</span></span><br></pre></td></tr></table></figure>
<h3 id="tcpdump的简单选项介绍"><a href="#tcpdump的简单选项介绍" class="headerlink" title="tcpdump的简单选项介绍"></a>tcpdump的简单选项介绍</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">tcpdump采用命令行方式，它的命令格式为：</span><br><span class="line"></span><br><span class="line">　　tcpdump [ -adeflnNOpqStvx ] [ -c 数量 ] [ -F 文件名 ]</span><br><span class="line"></span><br><span class="line">　　　　　　　　　　[ -i 网络接口 ] [ -r 文件名] [ -s snaplen ]</span><br><span class="line"></span><br><span class="line">                                       [ -T 类型 ] [ -w 文件名 ] [表达式 ]</span><br><span class="line"></span><br><span class="line">-a 　　　# 将网络地址和广播地址转变成名字；</span><br><span class="line">-A  # 以ASCII码方式显示每一个数据包(不会显示数据包中链路层头部信息). 在抓取包含网页数据的数据包时, 可方便查看数据(nt: 即Handy for capturing web pages).</span><br><span class="line">-c  count     # tcpdump将在接受到count个数据包后退出.</span><br><span class="line">-C  file-size (nt: 此选项用于配合-w file 选项使用)     # 该选项使得tcpdump在把原始数据包直接保存到文件中之前, 检查此文件大小是否超过file-size. 如果超过了, 将关闭此文件,另创一个文件继续用于原始数据包的记录. 新创建的文件名与-w 选项指定的文件名一致, 但文件名后多了一个数字.该数字会从1开始随着新创建文件的增多而增加. file-size的单位是百万字节(nt: 这里指1,000,000个字节,并非1,048,576个字节, 后者是以1024字节为1k, 1024k字节为1M计算所得, 即1M=1024 ＊ 1024 ＝ 1,048,576)</span><br><span class="line">-d  # 以容易阅读的形式,在标准输出上打印出编排过的包匹配码, 随后tcpdump停止.(nt | rt: human readable, 容易阅读的,通常是指以ascii码来打印一些信息. compiled, 编排过的. packet-matching code, 包匹配码,含义未知, 需补充)</span><br><span class="line">-dd # 以C语言的形式打印出包匹配码.</span><br><span class="line">-ddd # 以十进制数的形式打印出包匹配码(会在包匹配码之前有一个附加的'count'前缀).</span><br><span class="line">-D  # 打印系统中所有tcpdump可以在其上进行抓包的网络接口. 每一个接口会打印出数字编号, 相应的接口名字, 以及可能的一个网络接口描述. 其中网络接口名字和数字编号可以用在tcpdump 的-i flag 选项(nt: 把名字或数字代替flag), 来指定要在其上抓包的网络接口.此选项在不支持接口列表命令的系统上很有用(nt: 比如, Windows 系统, 或缺乏 ifconfig -a 的UNIX系统); 接口的数字编号在windows 2000 或其后的系统中很有用, 因为这些系统上的接口名字比较复杂, 而不易使用. 如果tcpdump编译时所依赖的libpcap库太老,-D 选项不会被支持, 因为其中缺乏 pcap_findalldevs()函数.</span><br><span class="line">-e  # 每行的打印输出中将包括数据包的数据链路层头部信息</span><br><span class="line">-E  spi@ipaddr algo:secret,...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可通过spi@ipaddr algo:secret 来解密IPsec ESP包(nt | rt:IPsec Encapsulating Security Payload,IPsec 封装安全负载, IPsec可理解为, 一整套对ip数据包的加密协议, ESP 为整个IP 数据包或其中上层协议部分被加密后的数据,前者的工作模式称为隧道模式; 后者的工作模式称为传输模式 . 工作原理, 另需补充).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要注意的是, 在终端启动tcpdump 时, 可以为IPv4 ESP packets 设置密钥(secret）.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可用于加密的算法包括des-cbc, 3des-cbc, blowfish-cbc, rc3-cbc, cast128-cbc, 或者没有(none).默认的是des-cbc(nt: des, Data Encryption Standard, 数据加密标准, 加密算法未知, 另需补充).secret 为用于ESP 的密钥, 使用ASCII 字符串方式表达. 如果以 0x 开头, 该密钥将以16进制方式读入.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 该选项中ESP 的定义遵循RFC2406, 而不是 RFC1827. 并且, 此选项只是用来调试的, 不推荐以真实密钥(secret)来使用该选项, 因为这样不安全: 在命令行中输入的secret 可以被其他人通过ps 等命令查看到.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 除了以上的语法格式(nt: 指spi@ipaddr algo:secret), 还可以在后面添加一个语法输入文件名字供tcpdump 使用(nt：即把spi@ipaddr algo:secret,... 中...换成一个语法文件名). 此文件在接受到第一个ESP　包时会打开此文件, 所以最好此时把赋予tcpdump 的一些特权取消(nt: 可理解为, 这样防范之后, 当该文件为恶意编写时,不至于造成过大损害).</span></span><br><span class="line">-f  # 显示外部的IPv4 地址时(nt: foreign IPv4 addresses, 可理解为, 非本机ip地址), 采用数字方式而不是名字.(此选项是用来对付Sun公司的NIS服务器的缺陷(nt: NIS, 网络信息服务, tcpdump 显示外部地址的名字时会用到她提供的名称服务): 此NIS服务器在查询非本地地址名字时,常常会陷入无尽的查询循环). 由于对外部(foreign)IPv4地址的测试需要用到本地网络接口(nt: tcpdump 抓包时用到的接口)及其IPv4 地址和网络掩码. 如果此地址或网络掩码不可用, 或者此接口根本就没有设置相应网络地址和网络掩码(nt: linux 下的 'any' 网络接口就不需要设置地址和掩码, 不过此'any'接口可以收到系统中所有接口的数据包), 该选项不能正常工作.</span><br><span class="line">-F  file     #使用file 文件作为过滤条件表达式的输入, 此时命令行上的输入将被忽略.</span><br><span class="line">-i  interface</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定tcpdump 需要监听的接口.  如果没有指定, tcpdump 会从系统接口列表中搜寻编号最小的已配置好的接口(不包括 loopback 接口).一但找到第一个符合条件的接口, 搜寻马上结束.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在采用2.2版本或之后版本内核的Linux 操作系统上, <span class="string">'any'</span> 这个虚拟网络接口可被用来接收所有网络接口上的数据包(nt: 这会包括目的是该网络接口的, 也包括目的不是该网络接口的). 需要注意的是如果真实网络接口不能工作在<span class="string">'混杂'</span>模式(promiscuous)下,则无法在<span class="string">'any'</span>这个虚拟的网络接口上抓取其数据包.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果 -D 标志被指定, tcpdump会打印系统中的接口编号，而该编号就可用于此处的interface 参数.</span></span><br><span class="line">-l  # 对标准输出进行行缓冲(nt: 使标准输出设备遇到一个换行符就马上把这行的内容打印出来).在需要同时观察抓包打印以及保存抓包记录的时候很有用. 比如, 可通过以下命令组合来达到此目的:     ``tcpdump  -l  |  tee dat'' 或者 ``tcpdump  -l   &gt; dat  &amp;  tail  -f  dat''.(nt: 前者使用tee来把tcpdump 的输出同时放到文件dat和标准输出中, 而后者通过重定向操作'&gt;', 把tcpdump的输出放到dat 文件中, 同时通过tail把dat文件中的内容放到标准输出中)</span><br><span class="line">-L  # 列出指定网络接口所支持的数据链路层的类型后退出.(nt: 指定接口通过-i 来指定)</span><br><span class="line">-m  module     # 通过module 指定的file 装载SMI MIB 模块(nt: SMI，Structure of Management Information, 管理信息结构MIB, Management Information Base, 管理信息库. 可理解为, 这两者用于SNMP(Simple Network Management Protoco)协议数据包的抓取. 具体SNMP 的工作原理未知, 另需补充). 此选项可多次使用, 从而为tcpdump 装载不同的MIB 模块.</span><br><span class="line">-M  # secret  如果TCP 数据包(TCP segments)有TCP-MD5选项(在RFC 2385有相关描述), 则为其摘要的验证指定一个公共的密钥secret.</span><br><span class="line">-n  # 不对地址(比如, 主机地址, 端口号)进行数字表示到名字表示的转换.</span><br><span class="line">-nn：    # 指定将每个监听到的数据包中的域名转换成IP、端口从应用名称转换成端口号后显示</span><br><span class="line">-N  # 不打印出host 的域名部分. 比如, 如果设置了此选现, tcpdump 将会打印'nic' 而不是 'nic.ddn.mil'.</span><br><span class="line">-O  # 不启用进行包匹配时所用的优化代码. 当怀疑某些bug是由优化代码引起的, 此选项将很有用.</span><br><span class="line">-p  # 一般情况下, 把网络接口设置为非'混杂'模式. 但必须注意 , 在特殊情况下此网络接口还是会以'混杂'模式来工作； 从而, '-p' 的设与不设, 不能当做以下选现的代名词:'ether host &#123;local-hw-add&#125;' 或  'ether broadcast'(nt: 前者表示只匹配以太网地址为host 的包, 后者表示匹配以太网地址为广播地址的数据包).</span><br><span class="line">-q  # 快速(也许用'安静'更好?)打印输出. 即打印很少的协议相关信息, 从而输出行都比较简短.</span><br><span class="line">-R  # 设定tcpdump 对 ESP/AH 数据包的解析按照 RFC1825而不是RFC1829(nt: AH, 认证头, ESP， 安全负载封装, 这两者会用在IP包的安全传输机制中). 如果此选项被设置, tcpdump 将不会打印出'禁止中继'域(nt: relay prevention field). 另外,由于ESP/AH规范中没有规定ESP/AH数据包必须拥有协议版本号域,所以tcpdump不能从收到的ESP/AH数据包中推导出协议版本号.</span><br><span class="line">-r  file     # 从文件file 中读取包数据. 如果file 字段为 '-' 符号, 则tcpdump 会从标准输入中读取包数据.</span><br><span class="line">-S  # 打印TCP 数据包的顺序号时, 使用绝对的顺序号, 而不是相对的顺序号.(nt: 相对顺序号可理解为, 相对第一个TCP 包顺序号的差距,比如, 接受方收到第一个数据包的绝对顺序号为232323, 对于后来接收到的第2个,第3个数据包, tcpdump会打印其序列号为1, 2分别表示与第一个数据包的差距为1 和 2. 而如果此时-S 选项被设置, 对于后来接收到的第2个, 第3个数据包会打印出其绝对顺序号:232324, 232325).</span><br><span class="line">-s  snaplen     # 设置tcpdump的数据包抓取长度为snaplen, 如果不设置默认将会是68字节(而支持网络接口分接头(nt: NIT, 上文已有描述,可搜索'网络接口分接头'关键字找到那里)的SunOS系列操作系统中默认的也是最小值是96).68字节对于IP, ICMP(nt: Internet Control Message Protocol,因特网控制报文协议), TCP 以及 UDP 协议的报文已足够, 但对于名称服务(nt: 可理解为dns, nis等服务), NFS服务相关的数据包会产生包截短. 如果产生包截短这种情况, tcpdump的相应打印输出行中会出现''[|proto]''的标志（proto 实际会显示为被截短的数据包的相关协议层次). 需要注意的是, 采用长的抓取长度(nt: snaplen比较大), 会增加包的处理时间, 并且会减少tcpdump 可缓存的数据包的数量， 从而会导致数据包的丢失. 所以, 在能抓取我们想要的包的前提下, 抓取长度越小越好.把snaplen 设置为0 意味着让tcpdump自动选择合适的长度来抓取数据包.</span><br><span class="line">-T  type    # 强制tcpdump按type指定的协议所描述的包结构来分析收到的数据包.  目前已知的type 可取的协议为:     aodv (Ad-hoc On-demand Distance Vector protocol, 按需距离向量路由协议, 在Ad hoc(点对点模式)网络中使用),     cnfp (Cisco  NetFlow  protocol),  rpc(Remote Procedure Call), rtp (Real-Time Applications protocol),     rtcp (Real-Time Applications con-trol protocol), snmp (Simple Network Management Protocol),     tftp (Trivial File Transfer Protocol, 碎文件协议), vat (Visual Audio Tool, 可用于在internet 上进行电     视电话会议的应用层协议), 以及wb (distributed White Board, 可用于网络会议的应用层协议).</span><br><span class="line">-t     # 在每行输出中不打印时间戳</span><br><span class="line">-tt    # 不对每行输出的时间进行格式处理(nt: 这种格式一眼可能看不出其含义, 如时间戳打印成1261798315)</span><br><span class="line">-ttt   # tcpdump 输出时, 每两行打印之间会延迟一个段时间(以毫秒为单位)</span><br><span class="line">-tttt  # 在每行打印的时间戳之前添加日期的打印</span><br><span class="line">-u     # 打印出未加密的NFS 句柄(nt: handle可理解为NFS 中使用的文件句柄, 这将包括文件夹和文件夹中的文件)</span><br><span class="line">-U    # 使得当tcpdump在使用-w 选项时, 其文件写入与包的保存同步.(nt: 即, 当每个数据包被保存时, 它将及时被写入文件中,而不是等文件的输出缓冲已满时才真正写入此文件)。-U 标志在老版本的libcap库(nt: tcpdump 所依赖的报文捕获库)上不起作用, 因为其中缺乏pcap_cump_flush()函数.</span><br><span class="line">-v    # 当分析和打印的时候, 产生详细的输出. 比如, 包的生存时间, 标识, 总长度以及IP包的一些选项. 这也会打开一些附加的包完整性检测, 比如对IP或ICMP包头部的校验和.</span><br><span class="line">-vv   # 产生比-v更详细的输出. 比如, NFS回应包中的附加域将会被打印, SMB数据包也会被完全解码.</span><br><span class="line">-vvv  # 产生比-vv更详细的输出. 比如, telent 时所使用的SB, SE 选项将会被打印, 如果telnet同时使用的是图形界面, 其相应的图形选项将会以16进制的方式打印出来(nt: telnet 的SB,SE选项含义未知, 另需补充).</span><br><span class="line">-w    # 把包数据直接写入文件而不进行分析和打印输出. 这些包数据可在随后通过-r 选项来重新读入并进行分析和打印.</span><br><span class="line">-W    filecount      # 此选项与-C 选项配合使用, 这将限制可打开的文件数目, 并且当文件数据超过这里设置的限制时, 依次循环替代之前的文件, 这相当于一个拥有filecount 个文件的文件缓冲池. 同时, 该选项会使得每个文件名的开头会出现足够多并用来占位的0, 这可以方便这些文件被正确的排序.</span><br><span class="line">-x    # 当分析和打印时, tcpdump 会打印每个包的头部数据, 同时会以16进制打印出每个包的数据(但不包括连接层的头部).总共打印的数据大小不会超过整个数据包的大小与snaplen 中的最小值. 必须要注意的是, 如果高层协议数据没有snaplen 这么长,并且数据链路层(比如, Ethernet层)有填充数据, 则这些填充数据也会被打印.(nt: so for link  layers  that pad, 未能衔接理解和翻译, 需补充 )</span><br><span class="line">-xx   # tcpdump 会打印每个包的头部数据, 同时会以16进制打印出每个包的数据, 其中包括数据链路层的头部.</span><br><span class="line">-X    # 当分析和打印时, tcpdump 会打印每个包的头部数据, 同时会以16进制和ASCII码形式打印出每个包的数据(但不包括连接层的头部).这对于分析一些新协议的数据包很方便.</span><br><span class="line">-XX   # 当分析和打印时, tcpdump 会打印每个包的头部数据, 同时会以16进制和ASCII码形式打印出每个包的数据, 其中包括数据链路层的头部.这对于分析一些新协议的数据包很方便.</span><br><span class="line">-y    # datalinktype       设置tcpdump 只捕获数据链路层协议类型是datalinktype的数据包</span><br><span class="line">-Z    user      # 使tcpdump 放弃自己的超级权限(如果以root用户启动tcpdump, tcpdump将会有超级用户权限), 并把当前tcpdump的用户ID设置为user, 组ID设置为user首要所属组的ID(nt: tcpdump 此处可理解为tcpdump 运行之后对应的进程)。此选项也可在编译的时候被设置为默认打开.(nt: 此时user 的取值未知, 需补充)</span><br></pre></td></tr></table></figure>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">tcpdump –i eth0 ‘port 1111’ -X -c 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> -i 是interface的含义，是指我们有义务告诉tcpdump希望他去监听哪一个网卡,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -X告诉tcpdump命令，需要把协议头和包内容都原原本本的显示出来（tcpdump会以16进制和ASCII的形式显示），这在进行协议分析时是绝对的利器。port 1111我们只关心源端口或目的端口是1111的数据包.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -c 是Count的含义，这设置了我们希望tcpdump帮我们抓几个包。</span></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 port 1111 -l | awk '&#123;print $1&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提取包的每一行的第一个域(时间域)，这种情况下我们就需要-l将默认的全缓冲变为行缓冲了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -l选项的作用就是将tcpdump的输出变为“行缓冲”方式，这样可以确保tcpdump遇到的内容一旦是换行符即将缓冲的内容输出到标准输出，以便于利用管道或重定向方式来进行后续处理。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Linux/UNIX的标准I/O提供了全缓冲、行缓冲和无缓冲三种缓冲方式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 标准错误是不带缓冲的，终端设备常为行缓冲，而其他情况默认都是全缓冲的。</span></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 port 1111 -c 3 -w cp.pcap</span><br><span class="line"><span class="meta">#</span><span class="bash"> -w 直接将包写入文件中(即原始包，如果使用 重定向 &gt; 则只是保存显示的结果，而不是原始文件)，即所谓的“流量保存”---就是把抓到的网络包能存储到磁盘上，保存下来，为后续使用。参数-r 达到“流量回放”---就是把历史上的某一时间段的流量，重新模拟回放出来，用于流量分析。</span></span><br><span class="line"></span><br><span class="line">tcpdump i- eth0 'port 1111' -c 3 -r cp.pcap </span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过-w选项将流量都存储在cp.pcap(二进制格式)文件中了.可以通过 –r 读取raw packets文件 cp.pcap. </span></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 -e -nn -X -c 2 'port1111'</span><br><span class="line"><span class="meta">#</span><span class="bash"> -n不把网络地址转换成名字</span></span><br><span class="line"></span><br><span class="line">ruopu@ruopu-PC:~$ sudo tcpdump -i enp0s25 -e -nnvv -X -c 2 'port 80'</span><br><span class="line">tcpdump: listening on enp0s25, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">14:09:31.285330 50:7b:9d:65:f9:ff &gt; 8c:a6:df:ec:9e:52, ethertype IPv4 (0x0800), length 74: (tos 0x0, ttl 64, id 15932, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    192.168.0.89.43174 &gt; 101.37.97.51.80: Flags [S], cksum 0x8788 (incorrect -&gt; 0xa52d), seq 1891133781, win 29200, options [mss 1460,sackOK,TS val 4099617288 ecr 0,nop,wscale 7], length 0</span><br><span class="line">	0x0000:  4500 003c 3e3c 4000 4006 7526 c0a8 0059  E..&lt;&gt;&lt;@.@.u&amp;...Y</span><br><span class="line">	0x0010:  6525 6133 a8a6 0050 70b8 6955 0000 0000  e%a3...Pp.iU....</span><br><span class="line">	0x0020:  a002 7210 8788 0000 0204 05b4 0402 080a  ..r.............</span><br><span class="line">	0x0030:  f45b 3208 0000 0000 0103 0307            .[2.........</span><br><span class="line">14:09:31.320699 8c:a6:df:ec:9e:52 &gt; 50:7b:9d:65:f9:ff, ethertype IPv4 (0x0800), length 66: (tos 0x0, ttl 51, id 0, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    101.37.97.51.80 &gt; 192.168.0.89.43174: Flags [S.], cksum 0x9a5b (correct), seq 1054611816, ack 1891133782, win 29200, options [mss 1444,nop,nop,sackOK,nop,wscale 9], length 0</span><br><span class="line">	0x0000:  4500 0034 0000 4000 3306 c06a 6525 6133  E..4..@.3..je%a3</span><br><span class="line">	0x0010:  c0a8 0059 0050 a8a6 3edc 1968 70b8 6956  ...Y.P..&gt;..hp.iV</span><br><span class="line">	0x0020:  8012 7210 9a5b 0000 0204 05a4 0101 0402  ..r..[..........</span><br><span class="line">	0x0030:  0103 0309                                ....</span><br><span class="line">2 packets captured</span><br><span class="line">3 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line"><span class="meta">#</span><span class="bash"> tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode表示使用选项-v和-vv可以看到更完全的输出信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> listening on enp0s25, link-type EN10MB (Ethernet), capture size 262144 bytes表示监听enp0s25网卡，它的链路层是基于以太网的，要抓的包大小限制为262144字节。包大小限制值可以通过-s选项来设置。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 14:09:31.285330 表示这个包被抓到的“时”、“分”、“秒”、“微秒”</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 50:7b:9d:65:f9:ff &gt; 8c:a6:df:ec:9e:52表示从哪个MAC地址发往哪个MAC地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ethertype IPv4 (0x0800)表示Ethernet帧的协议类型为ipv4，代码为0x0800</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> length 74表示以太帧长度为74</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 192.168.0.89.43174 &gt; 101.37.97.51.80表示源IP192.168.0.89，端口43174向101.37.97.51的80号端口传输数据。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Flags [S]表示是syn建立连接包(即三次握手的第一次握手)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> seq 1891133781 表示序号为1891133781</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> win 29200  表示窗口大小为29200</span></span><br><span class="line"></span><br><span class="line">* tcpdump过滤语句</span><br><span class="line"><span class="meta">#</span><span class="bash"> 过滤表达式大体可以分成三种过滤条件，“类型”、“方向”和“协议”，这三种条件的搭配组合就构成了我们的过滤表达式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关于类型的关键字，主要包括host，net，port, 例如 host 210.45.114.211，指定主机210.45.114.211，net 210.11.0.0 指明210.11.0.0是一个网络地址，port 21 指明端口号是21。如果没有指定类型，缺省的类型是host.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关于传输方向的关键字，主要包括src , dst ,dst or src, dst and src ,这些关键字指明了传输的方向。例：src 210.45.114.211 ,指明ip包中源地址是210.45.114.211, dst net 210.11.0.0 指明目的网络地址是210.11.0.0。如果没有指明方向关键字，则缺省是src or dst关键字。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关于协议的关键字，主要包括 ether,ip,ip6,arp,rarp,tcp,udp等类型。这几个的包的协议内容。如果没有指定任何协议，则tcpdump将会监听所有协议的信息包。</span></span><br><span class="line"></span><br><span class="line"> tcpdump -i eth0 -nn -c 1 'tcp'</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 只抓tcp的包</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 除了这三种类型的关键字之外，其他重要的关键字：gateway, broadcast,less,greater。还有三种逻辑运算，取非运算是 <span class="string">'not '</span>,<span class="string">'! '</span>, 与运算是<span class="string">'and'</span>,<span class="string">'&amp;&amp;'</span>;或运算是<span class="string">'or'</span>,<span class="string">'||'</span>；</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump -i eth0 -c 10 'dst port 21 or dst port 80'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只想查目标机器端口是21或80的网络包，其他端口的我不关注</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump -i eth0 -c 3 'host 172.16.0.11 and (210.45.123.249 or 210.45.123.248)'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 想要截获主机172.16.0.11 和主机210.45.123.249或 210.45.123.248的通信，使用命令(注意括号的使用)</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump 'port ftp or ftp-data'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 想获取使用ftp端口和ftp数据端口的网络包这里 ftp、ftp-data到底对应哪个端口？ linux系统下 /etc/services这个文件里面，就存储着所有知名服务和传输层端口的对应关系。如果你直接把/etc/services里的ftp对应的端口值从21改为了3333，那么tcpdump就会去抓端口含有3333的网络包了。</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump ip ‘host 172.16.0.11 and ! 210.45.123.249’</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果想要获取主机172.16.0.11除了和主机210.45.123.249之外所有主机通信的ip包</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump -i eth0 ‘host 172.16.0.11 and ! port 80 and ! port 25 and ! port 110’</span><br><span class="line"><span class="meta">#</span><span class="bash"> 抓172.16.0.11的80端口和110和25以外的其他端口的包</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump -i eth0 'host 172.16.0.11 and host google.com and tcp[tcpflags]&amp;tcp-syn!=0' -c 3 -nn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取172.16.10.11和google.com之间建立TCP三次握手中带有SYN标记位的网络包</span></span><br><span class="line"></span><br><span class="line">proto [expr : size]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Proto即protocol的缩写，它表示这里要指定的是某种协议名称，如ip,tcp,udp等。总之可以指定的协议有十多种，如链路层协议 ether,fddi,tr,wlan,ppp,slip,link,网络层协议ip,ip6,arp,rarp,icmp传输层协议tcp,udp等。expr用来指定数据报字节单位的偏移量，该偏移量相对于指定的协议层，默认的起始位置是0；而size表示从偏移量的位置开始提取多少个字节，可以设置为1、2、4,默认为1字节。如果只设置了expr，而没有设置size，则默认提取1个字节。比如ip[2:2]，就表示提取出第3、4个字节；而ip[0]则表示提取ip协议头的第一个字节。在我们提取了特定内容之后，我们就需要设置我们的过滤条件了，我们可用的“比较操作符”包括：&gt;，&lt;，&gt;=，&lt;=，=，!=，总共有6个。</span></span><br><span class="line"></span><br><span class="line">sudo tcpdump 'tcp[13] &amp; 3 != 0 and not(src and dst net 172.16.0.0)' -nn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 截取每个TCP会话的起始和结束报文(SYN 和 FIN 报文), 而且会话方中有一个远程主机.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tcp偏移13字节的位置为2位保留位和6位标志位(URG,ACK,PSH,RST,SYN,FIN), 所以与3相与就可以得出SYN,FIN其中是否一个置位1. 从上面可以看到在写过滤表达式时，需要我们对协议格式比较理解才能把表达式写对。为了让tcpdump工具更人性化一些，有一些常用的偏移量，可以通过一些名称来代替，比如icmptype表示ICMP协议的类型域、icmpcode表示ICMP的code域，tcpflags则表示TCP协议的标志字段域。更进一步的，对于ICMP的类型域，可以用这些名称具体指代：icmp-echoreply, icmp-unreach, icmp-sourcequench, icmp-redirect,icmp-echo, icmp-routeradvert, icmp-routersolicit, icmp-timxceed, icmp-paramprob,icmp-tstamp, icmp-tstampreply, icmp-ireq, icmp-ireqreply, icmp-maskreq,icmp-maskreply。而对于TCP协议的标志字段域，则可以细分为tcp-fin, tcp-syn, tcp-rst, tcp-push, tcp-ack, tcp-urg。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/19/nc命令使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/19/nc命令使用/" itemprop="url">
                  nc命令使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-19 10:02:36" itemprop="dateCreated datePublished" datetime="2018-11-19T10:02:36+08:00">2018-11-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-12-25 10:22:37" itemprop="dateModified" datetime="2018-12-25T10:22:37+08:00">2018-12-25</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="nc命令使用方法"><a href="#nc命令使用方法" class="headerlink" title="nc命令使用方法"></a>nc命令使用方法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">* 将nc命令当telnet使用</span><br><span class="line">语法：</span><br><span class="line">nc -nv IP PORT</span><br><span class="line">例：</span><br><span class="line">mtr 202.106.0.20</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用mtr命令追踪一下路由</span></span><br><span class="line">nc -nv 123.125.50.29 110</span><br><span class="line"><span class="meta">#</span><span class="bash"> -n表示不使用DNS解析(不建议在nc后使用域名)；-v表示显示详细信息。连接163邮箱服务器。进入后可以使用一些命令，但识别的都是base64加密后的数据</span></span><br><span class="line">base64</span><br><span class="line">	zheng.yao@ccgoldenet.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入base64命令后按回车，之后等待输入数据，输入完成后按回车再按Ctrl+d结束，就会产生一个base64编码后的数据</span></span><br><span class="line">nc -vn 123.125.50.138 25</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接163的smtp服务器。</span></span><br><span class="line">nc -vn 1.1.1.1 80</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接后都会提示端口的状态，如open表示打开状态</span></span><br><span class="line">	head /</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入后，可以用head请求头信息</span></span><br><span class="line"></span><br><span class="line">* 使用NC传输文本信息</span><br><span class="line">A：nc -l -p 333</span><br><span class="line"><span class="meta">#</span><span class="bash"> -l(listen)表示要监听端口，-p指定端口号。这可以起到一个服务端的功能</span></span><br><span class="line">B：nc -nv 1.1.1.1 333</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接后，这两台主机就可以聊天了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个功能不为聊天，实际是为电子取证所用</span></span><br><span class="line"></span><br><span class="line">A：nc -l -p 333</span><br><span class="line">B：ls -l | nc -nv 1.1.1.1 333</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将本机ls -l显示的信息传到nc服务器上。这是远程电子审计的标准方法</span></span><br><span class="line"></span><br><span class="line">A：nc -l -p 333 &gt; ps.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将结果重定向到一个文件中</span></span><br><span class="line">B：ps aux|nc -nv 1.1.1.1 333 -q 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 收集进程信息。-q表示标准结果输出后，delay（延迟）一定时间就退出。1就是延迟的时间，表示1秒</span></span><br><span class="line">A： cat ps.txt</span><br><span class="line"></span><br><span class="line">A：nc -l -p 333 &gt; lsof.txt</span><br><span class="line">B：lsof | nc -nv 1.1.1.1 333 -q 1</span><br><span class="line">A： cat lsof.txt</span><br><span class="line"></span><br><span class="line">* 使用NC传输文件/目录</span><br><span class="line">** 传输文件</span><br><span class="line">A：nc -lp 333 &gt; 1.mp4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收端打开333端口，接收到的内容输入到一个文件名</span></span><br><span class="line">B：nc -nv 1.1.1.1 333 &lt; 1.mp4 -q 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送文件到接收端。在windows上使用上面的命令会报错，可能是安装的是netcat软件。需要使用下面命令</span></span><br><span class="line">nc -w 1 1.1.1.1 333 &lt; 1.mp4</span><br><span class="line">或</span><br><span class="line">A：nc -q 1 -lp 333 &lt; a.mp4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从服务器向客户端收送文件，这就成了发送端。这像是一个下载的过程。连接完成后1秒断开</span></span><br><span class="line">B：nc -nv 1.1.1.1 333 &gt; 2.mp4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端成了接收端。</span></span><br><span class="line"></span><br><span class="line">** 传输目录</span><br><span class="line">A：tar -cvf - music/ | nc -lp 333 -q 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打包目录，通过管道入到nc中。视频中强调，cvf后面的横线不能少，少了就不能打包成tar文件了。在 GNU 指令中，如果单独使用 - 符号，不加任何该加的文件名称时，代表<span class="string">"标准输入"</span>的意思。这是 GNU指令的共通选项。如：tar xpvf -，这里的 - 符号，既代表从标准输入读取资料。不过，在 <span class="built_in">cd</span> 指令中则比较特别，<span class="built_in">cd</span> -，这代表变更工作目录到<span class="string">"上一次"</span>工作目录。</span></span><br><span class="line">B：nc -nv 1.1.1.1 333 |tar -xvf -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接到nc，将打包的目录解压到本地</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以反方向传输。</span></span><br><span class="line"></span><br><span class="line">** 加密传文件</span><br><span class="line">A：nc -lp 333 | mcrypt --flush -Fbqd -a rijindael-256 -m ecb &gt; 1.mp4</span><br><span class="line"><span class="meta">#</span><span class="bash"> A端先监听端口，等待别人给其传文件。收到文件后给后面的解密命令解密，之后重新输出一个文件。接收到文件后会提示输入密码</span></span><br><span class="line">B：mcrypt --flush -Fbq -a rijindael-256 -m ecb &lt; a.mp4 | nc -nv 1.1.1.1 333 -q 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将加密文件转给A主机。两边的加密方式应该一致。加密时需要输入两次密码</span></span><br><span class="line"></span><br><span class="line">* 使用NC做流媒体服务</span><br><span class="line">A： cat 1.mp4 | nc -lp 333</span><br><span class="line"><span class="meta">#</span><span class="bash"> mp4文件也可以用cat打开</span></span><br><span class="line">B：nc -nv 1.1.1.1 333 | mplayer -vo x11 -cache 3000 -</span><br><span class="line"><span class="meta">#</span><span class="bash"> mplayer是一个播放器，其他支持命令行的播放器也可以</span></span><br><span class="line"></span><br><span class="line">* 使用NC做端口扫描</span><br><span class="line">nc -nvz 1.1.1.1 1-65535</span><br><span class="line">nc -nvzu 1.1.1.1 1-1024</span><br><span class="line"><span class="meta">#</span><span class="bash"> -z表示使用0输入/输出模式，只在扫描通信端口时使用。默认使用tcp端口，-u表示扫描udp的端口。每一个扫描器扫描的结果都不是完全准确的，可能被防火墙拦截。建议使用多个工具进行扫描</span></span><br><span class="line"></span><br><span class="line">* 使用NC做远程克隆硬盘</span><br><span class="line">A：nc -lp 333 | dd of=/dev/sda</span><br><span class="line">B：dd if=/dev/sda | nc -nv 1.1.1.1 333 -q 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 远程电子取证，可以将目标服务器硬盘远程复制，或者内存。这是块级别的备份。不会只拷贝文件，它会将磁盘扇区上的所有数据都拷贝过来。dd命令就是块级别的复制。<span class="keyword">if</span>表示input file</span></span><br><span class="line"></span><br><span class="line">* 使用NC做远程控制</span><br><span class="line">** 正向</span><br><span class="line">A： nc -lp 333 -c bash</span><br><span class="line">B： nc -nv 1.1.1.1 333</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端控制服务器。连接后可以使用bash命令</span></span><br><span class="line"></span><br><span class="line">** 反向</span><br><span class="line">A：nc -lp 333</span><br><span class="line">B：nc -nv 1.1.1.1 333 -c bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务器控制客户端</span></span><br><span class="line"></span><br><span class="line">注：windows用户把bash改成cmd</span><br><span class="line"></span><br><span class="line">* NC-NCAT</span><br><span class="line">NC缺乏加密和身份验证的能力</span><br><span class="line">NCAT包含于nmap工具包中。NCAT与NC是不一样的</span><br><span class="line">A：ncat -c bash --allow 1.1.1.1 -vnl 333 --ssl</span><br><span class="line"><span class="meta">#</span><span class="bash"> --allow表示允许哪个IP地址来连接本服务器</span></span><br><span class="line">B：ncat -nv 1.1.1.1 333 --ssl；监听的是333端口，--ssl表示ssl加密</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不同系统/平台的NC参数功能不尽相同</span></span><br></pre></td></tr></table></figure>
<h3 id="mtr命令"><a href="#mtr命令" class="headerlink" title="mtr命令"></a>mtr命令</h3><p>mtr命令可以结合ping nslookup tracert 来判断网络的相关特性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">* 参数</span><br><span class="line">mtr -r</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以报告模式显示</span></span><br><span class="line"></span><br><span class="line">mtr -s </span><br><span class="line"><span class="meta">#</span><span class="bash"> 用来指定ping数据包的大小</span></span><br><span class="line"></span><br><span class="line">mtr -c </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置每秒发送数据包的数量</span></span><br><span class="line"></span><br><span class="line">mtr -n </span><br><span class="line"><span class="meta">#</span><span class="bash"> no-dns不对IP地址做域名解析</span></span><br><span class="line"></span><br><span class="line">mtr -a </span><br><span class="line"><span class="meta">#</span><span class="bash"> 来设置发送数据包的IP地址 这个对一个主机由多个IP地址是有用的</span></span><br><span class="line"></span><br><span class="line">mtr -i </span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用这个参数来设置ICMP返回之间的要求默认是1秒</span></span><br><span class="line"></span><br><span class="line">mtr -4 </span><br><span class="line"><span class="meta">#</span><span class="bash"> IPv4</span></span><br><span class="line"></span><br><span class="line">mtr -6 </span><br><span class="line"><span class="meta">#</span><span class="bash"> IPv6</span></span><br><span class="line"></span><br><span class="line">ruopu@ruopu-PC:~$ mtr -r 202.108.33.94</span><br><span class="line">Start: 2018-11-19T11:09:25+0800</span><br><span class="line">HOST: ruopu-PC                    Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1.|-- _gateway                   0.0%    10    0.3   0.4   0.3   0.5   0.1</span><br><span class="line">  2.|-- 106.38.38.81               0.0%    10    3.2   8.7   3.1  54.0  15.9</span><br><span class="line">  3.|-- 237.235.120.106.static.bj 10.0%    10    2.8   3.0   2.8   4.4   0.5</span><br><span class="line">  4.|-- 202.97.57.201              0.0%    10    3.3   3.4   3.2   3.8   0.2</span><br><span class="line">  5.|-- 202.97.88.246             60.0%    10    3.2   3.2   3.1   3.3   0.1</span><br><span class="line">  6.|-- 219.158.44.133             0.0%    10   10.7   8.2   3.5  12.7   2.7</span><br><span class="line">  7.|-- 219.158.3.77               0.0%    10    9.3   7.7   4.8  10.3   2.2</span><br><span class="line">  8.|-- 124.65.194.174            40.0%    10    3.5   3.6   3.4   3.7   0.1</span><br><span class="line">  9.|-- 61.148.143.30              0.0%    10    3.2   3.9   3.2   5.9   0.8</span><br><span class="line"> 10.|-- 210.74.176.138             0.0%    10    3.5   4.1   3.1   8.6   1.6</span><br><span class="line"> 11.|-- ???                       100.0    10    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> ruopu-PC一列显示的是IP地址或本机域名；Snt一列显示的是设置每秒发送数据包的数量，默认值是10，可以通过参数-c来指定。</span></span><br><span class="line"></span><br><span class="line">ruopu@ruopu-PC:~$ mtr -r -c 15 202.108.33.94</span><br><span class="line">Start: 2018-11-19T11:12:54+0800</span><br><span class="line">HOST: ruopu-PC                    Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1.|-- _gateway                   0.0%    15    0.4   0.4   0.3   0.5   0.1</span><br><span class="line">  2.|-- 106.38.38.81               0.0%    15  187.6  65.7   3.7 187.6  59.1</span><br><span class="line">  3.|-- 237.235.120.106.static.bj  0.0%    15    3.0   3.9   2.6  12.4   2.8</span><br><span class="line">  4.|-- 202.97.57.237              0.0%    15    4.4   6.5   4.0  14.6   3.0</span><br><span class="line">  5.|-- 202.97.57.114              0.0%    15   35.1  17.8   2.9  50.9  17.5</span><br><span class="line">  6.|-- 219.158.44.129             0.0%    15   12.5   7.9   3.3  20.7   4.4</span><br><span class="line">  7.|-- 219.158.3.77               0.0%    15    4.4   6.6   3.1   9.9   2.3</span><br><span class="line">  8.|-- 124.65.194.118            66.7%    15    3.9  12.1   3.7  43.0  17.3</span><br><span class="line">  9.|-- 61.148.143.22              0.0%    15    3.2   7.3   3.2  35.8   9.1</span><br><span class="line"> 10.|-- 210.74.178.198             0.0%    15    3.9   4.2   3.5  10.8   1.8</span><br><span class="line"> 11.|-- ???                       100.0    15    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> HOST:ruopu-PC一列显示的是途经的IP地址或本机域名；Loss%列显示的是每个对应IP的丢包率，只有最后的目标丢包才算是真正的丢包；Snt一列显示的是设置每秒发送数据包的数量，默认值是10，可以通过参数-c来指定；Last列显示的是最近一次的返回时延，按毫秒计算；Avg列显示的是发送ping包的平均时延；Best烈显示的是最好或时延最短的；Wrst列显示的是最差或时延最长的；StDev列显示的是标准偏差。</span></span><br><span class="line"></span><br><span class="line">ruopu@ruopu-PC:~$ sudo mtr -i 0.1 -n -c 100 202.108.33.94</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对不标IP不做解析，ping100次，每0.1秒返回一次结果</span></span><br><span class="line"></span><br><span class="line">ruopu@ruopu-PC:~$ mtr -r -n -c 30 -s 1024 www.baidu.com</span><br><span class="line">Start: 2018-11-19T11:28:06+0800</span><br><span class="line">HOST: ruopu-PC                    Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1.|-- 192.168.0.1                0.0%    30    0.6   0.6   0.5   0.7   0.1</span><br><span class="line">  2.|-- 106.38.38.81               0.0%    30   16.8  56.8  11.6 160.8  36.0</span><br><span class="line">  3.|-- ???                       100.0    30    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  4.|-- 220.181.0.234             83.3%    30    6.1   5.6   4.6   6.1   0.6</span><br><span class="line">  5.|-- 218.30.112.130            60.0%    30    5.0   5.7   4.9  10.3   1.6</span><br><span class="line">  6.|-- 180.149.128.138           26.7%    30   10.6 270.4   6.8 1008. 355.7</span><br><span class="line">  7.|-- 180.149.129.6              0.0%    30    5.3   5.8   4.7  16.9   2.8</span><br><span class="line">  8.|-- ???                       100.0    30    0.0   0.0   0.0   0.0   0.0</span><br><span class="line">  9.|-- ???                       100.0    30    0.0   0.0   0.0   0.0   0.0</span><br><span class="line"> 10.|-- 180.149.132.151            0.0%    30    5.8   6.8   5.7  16.6   2.8</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/18/jdyc备份服务器搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/18/jdyc备份服务器搭建/" itemprop="url">
                  jdyc备份服务器搭建
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-18 11:18:41" itemprop="dateCreated datePublished" datetime="2018-11-18T11:18:41+08:00">2018-11-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-19 08:25:14" itemprop="dateModified" datetime="2018-11-19T08:25:14+08:00">2018-11-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/jdbc/" itemprop="url" rel="index"><span itemprop="name">jdbc</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="搭建服务器过程"><a href="#搭建服务器过程" class="headerlink" title="搭建服务器过程"></a>搭建服务器过程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* Server</span><br><span class="line">1. 创建CentOS7服务器</span><br><span class="line">2. 创建备份目录</span><br><span class="line">mkdir /home/logsbackup</span><br><span class="line">3. 将本地地址映射出去</span><br><span class="line"></span><br><span class="line">* Client</span><br><span class="line">ssh-keygen -t rsa -P ''</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub 1.1.1.1</span><br><span class="line">vim /root/sh/logsbackup.sh</span><br><span class="line">    #!/bin/bash</span><br><span class="line">    #</span><br><span class="line">    cd /usr/local/logs</span><br><span class="line">    tar -zcf netty.log-$(date -d yesterday +%Y-%m-%d).tar.gz netty.log-$(date -d yesterday +%Y-%m-%d).*.log</span><br><span class="line">    scp -P 3999 netty.log-$(date -d yesterday +%Y-%m-%d).tar.gz 1.1.1.1:/home/logsbackup</span><br><span class="line">    rm -rf netty.log-$(date -d yesterday +%Y-%m-%d).*.log</span><br><span class="line">    echo $(date +%Y-%m-%d-%T) &gt;&gt; /root/sh/logsbackup.txt	</span><br><span class="line">crontab -e</span><br><span class="line"> 	0 1 * * * /bin/bash /root/sh/logsbackup.sh</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/16/docker学习一：基本概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/16/docker学习一：基本概念/" itemprop="url">
                  docker学习一：基本概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-16 11:11:26" itemprop="dateCreated datePublished" datetime="2018-11-16T11:11:26+08:00">2018-11-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-02 09:57:30" itemprop="dateModified" datetime="2019-02-02T09:57:30+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><ol>
<li><p>Docker 和传统虚拟化方式的不同之处在于传统虚拟机技术是虚拟出一套硬件后,在其上运行一个完整操作系统,在该系统上再运行所需应用进程;而容器内的应用进程直接运行于宿主的内核,容器内没有自己的内核,而且也没有进行硬件虚拟。因此容器要比传统虚拟机更为轻便。</p>
</li>
<li><p>Docker 镜像(Image),就相当于是一个root文件系统。Docker 镜像是一个特殊的文件系统,除了提供容器运行时所需的程序、库、资源、配置等文件外,还包含了一些为运行时准备的一些配置参数(如匿名卷、环境变量、用户等)。镜像不包含任何动态数据,其内容在构建之后也不会被改变。</p>
</li>
<li><p>因为镜像包含操作系统完整的root文件系统,其体积往往是庞大的,因此在 Docker 设计时,就充分利用 Union FS 的技术,将其设计为分层存储的架构。所以严格来说,镜像并非是像一个 ISO 那样的打包文件,镜像只是一个虚拟的概念,其实际体现并非由一个文件组成,而是由一组文件系统组成,或者说,由多层文件系统联合组成。镜像构建时,会一层层构建,前一层是后一层的基础。每一层构建完就不会再发生改变,后一层上的任何改变只发生在自己这一层。比如,删除前一层文件的操作,实际不是真的删除前一层的文件,而是仅在当前层标记为该文件已删除。在最终容器运行的时候,虽然不会看到这个文件,但是实际上该文件会一直跟随镜像。因此,在构建镜像的时候,需要额外小心,每一层尽量只包含该层需要添加的东西,任何额外的东西应该在该层构建结束前清理掉。分层存储的特征还使得镜像的复用、定制变的更为容易。甚至可以用之前构建好的镜像作为基础层,然后进一步添加新的层,以定制自己所需的内容,构建新的镜像。</p>
</li>
<li><p>镜像(Image)和容器(Container)的关系,就像是面向对象程序设计中的类和实例一样,镜像是静态的定义,容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。<br>容器的实质是进程,但与直接在宿主执行的进程不同,容器进程运行于属于自己的独立的命名空间。因此容器可以拥有自己的root文件系统、自己的网络配置、自己的进程空间,甚至自己的用户 ID 空间。容器内的进程是运行在一个隔离的环境里,使用起来,就好像是在一个独立于宿主的系统下操作一样。这种特性使得容器封装的应用比直接在宿主运行更加安全。<br>前面讲过镜像使用的是分层存储,容器也是如此。每一个容器运行时,是以镜像为基础层,在其上创建一个当前容器的存储层,我们可以称这个为容器运行时读写而准备的存储层为容器存储层。<br>容器存储层的生存周期和容器一样,容器消亡时,容器存储层也随之消亡。因此,任何保存于容器存储层的信息都会随容器删除而丢失。<br>按照 Docker 最佳实践的要求,容器不应该向其存储层内写入任何数据,容器存储层要保持无状态化。所有的文件写入操作,都应该使用 数据卷(Volume)、或者绑定宿主目录,在这些位置的读写会跳过容器存储层,直接对宿主(或网络存储)发生读写,其性能和稳定性更高。<br>数据卷的生存周期独立于容器,容器消亡,数据卷不会消亡。因此,使用数据卷后,容器删除或者重新运行之后,数据却不会丢失。</p>
</li>
<li><p>Docker Registry</p>
<p>镜像构建完成后,可以很容易的在当前宿主机上运行,但是,如果需要在其它服务器上使用这个镜像,我们就需要一个集中的存储、分发镜像的服务,Docker Registry 就是这样的服务。<br>一个 Docker Registry 中可以包含多个仓库(Repository);每个仓库可以包含多个标签(Tag);每个标签对应一个镜像。<br>通常,一个仓库会包含同一个软件不同版本的镜像,而标签就常用于对应该软件的各个版本。我们可以通过&lt;仓库名&gt;:&lt;标签&gt;的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签,将以latest作为默认标签。<br>以 Ubuntu 镜像为例,ubuntu是仓库的名字,其内包含有不同的版本标签,如,14.04、16.04。我们可以通过 ubuntu:14.04,或者ubuntu:16.04。来具体指定所需哪个版本的镜像。如果忽略了标签,比如ubuntu,那将视为ubuntu:latest。<br>仓库名经常以两段式路径形式出现,比如jwilder/nginx-proxy,前者往往意味着 Docker Registry 多用户环境下的用户名,后者则往往是对应的软件名。但这并非绝对,取决于所使用的具体 Docker Registry 的软件或服务。</p>
</li>
<li><p>Docker Registry 公开服务<br>Docker Registry 公开服务是开放给用户使用、允许用户管理镜像的 Registry 服务。一般这类公开服务允许用户免费上传、下载公开的镜像,并可能提供收费服务供用户管理私有镜像。<br>最常使用的 Registry 公开服务是官方的 Docker Hub,这也是默认的 Registry,并拥有大量的高质量的官方镜像。除此以外,还有 CoreOS 的 Quay.io,CoreOS 相关的镜像存储在这里;Google 的 Google Container Registry,Kubernetes 的镜像使用的就是这个服务。<br>由于某些原因,在国内访问这些服务可能会比较慢。国内的一些云服务商提供了针对 Docker Hub 的镜像服务(<br>Registry Mirror),这些镜像服务被称为加速器。常见的有 阿里云加速器、DaoCloud 加速器等。使用加速器会直接从国内的地址下载 Docker Hub 的镜像,比直接从 Docker Hub 下载速度会提高很多。<br>国内也有一些云服务商提供类似于 Docker Hub 的公开服务。比如时速云镜像仓库、网易云镜像服务、DaoCloud 镜像市场、阿里云镜像库等。</p>
</li>
<li><p>私有 Docker Registry<br>除了使用公开服务外,用户还可以在本地搭建私有Docker Registry。Docker 官方提供了Docker Registry 镜像,可以直接使用做为私有Registry服务。<br>开源的 Docker Registry 镜像只提供了 Docker Registry API 的服务端实现,足以支持docker命令,不影响使用。但不包含图形界面,以及镜像维护、用户管理、访问控制等高级功能。在官方的商业化版本 Docker Trusted Registry 中,提供了这些高级功能。</p>
<p>除了官方的 Docker Registry 外,还有第三方软件实现了 Docker Registry API,甚至提供了用户界面以及一些高级功能。比如,VMWare Harbor 和 Sonatype Nexus。</p>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/15/阿里云调整/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/15/阿里云调整/" itemprop="url">
                  阿里云调整
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-15 13:04:26" itemprop="dateCreated datePublished" datetime="2018-11-15T13:04:26+08:00">2018-11-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-21 10:56:24" itemprop="dateModified" datetime="2018-11-21T10:56:24+08:00">2018-11-21</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="报警"><a href="#报警" class="headerlink" title="报警"></a>报警</h3><p>可以先创建报警人组与报警人，这里只是对硬件的资源的基本监控。</p>
<p><img src="/images/alichange/监控报警1.jpg" alt=""></p>
<p><img src="/images/alichange/监控报警2.jpg" alt=""></p>
<p><img src="/images/alichange/监控报警3.jpg" alt=""></p>
<p><img src="/images/alichange/监控报警4.jpg" alt=""></p>
<p><img src="/images/alichange/监控报警5.jpg" alt=""></p>
<p><img src="/images/alichange/报警人1.jpg" alt=""></p>
<p><img src="/images/alichange/报警人2.jpg" alt=""></p>
<h3 id="创建交换机"><a href="#创建交换机" class="headerlink" title="创建交换机"></a>创建交换机</h3><p>建议将所有ECS虚拟机放在一个交换机中，这样便于管理，也可以避免不同交换机间通信需要进行一次路由的问题。</p>
<p><img src="/images/alichange/vpc1.jpg" alt=""></p>
<p><img src="/images/alichange/vpc2.jpg" alt=""></p>
<p><img src="/images/alichange/vpc3.jpg" alt=""></p>
<h3 id="共享带宽"><a href="#共享带宽" class="headerlink" title="共享带宽"></a>共享带宽</h3><p>购买NAT网关，设置DNAT，将需要外网访问的内网地址加入DNAT。SNAT中要匹配现有的所有交换机</p>
<p><img src="/images/alichange/NAT1.jpg" alt=""></p>
<p><img src="/images/alichange/NAT2.jpg" alt=""></p>
<p><img src="/images/alichange/NAT3.jpg" alt=""></p>
<p><img src="/images/alichange/NAT4.jpg" alt=""></p>
<p><img src="/images/alichange/NAT5.jpg" alt=""></p>
<p><img src="/images/alichange/NAT6.jpg" alt=""></p>
<h3 id="内网负载均衡"><a href="#内网负载均衡" class="headerlink" title="内网负载均衡"></a>内网负载均衡</h3><p>主要为RabbitMQ使用。在监听中定义要监听的端口，在默认服务器组中加入两台服务器，这样就会监听两个服务器的这些定义了的端口</p>
<p><img src="/images/alichange/balance1.jpg" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/15/KVM使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/15/KVM使用/" itemprop="url">
                  KVM使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-11-15 09:28:28" itemprop="dateCreated datePublished" datetime="2018-11-15T09:28:28+08:00">2018-11-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-10-23 14:22:35" itemprop="dateModified" datetime="2019-10-23T14:22:35+08:00">2019-10-23</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/虚拟化/" itemprop="url" rel="index"><span itemprop="name">虚拟化</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="KVM安装"><a href="#KVM安装" class="headerlink" title="KVM安装"></a>KVM安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">安装环境在CentOS6.6_x64</span><br><span class="line">* 方法一</span><br><span class="line">1. 查看是否支持虚拟化</span><br><span class="line">egrep '(vmx|svm)' /proc/cpuinfo</span><br><span class="line">2. 关闭SELinux和防火墙</span><br><span class="line">setenforce 0</span><br><span class="line">getenforce</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">3. 加载kvm模块</span><br><span class="line">modprobe kvm</span><br><span class="line">4. 查看是否加载kvm</span><br><span class="line">lsmod | grep kvm</span><br><span class="line">5. 安装KVM软件</span><br><span class="line">yum -y install qemu-kvm qemu-kvm-tools</span><br><span class="line">6. 因为安装后qemu-kvm命令不在环境变量中，所以要添加</span><br><span class="line">ln -sv /usr/libexec/qemu-kvm /usr/sbin</span><br><span class="line">7. qemu-kvm查看帮助、支持模拟的PC、可模拟的CPU架构</span><br><span class="line">qemu-kvm -h</span><br><span class="line">qemu-kvm -M ?</span><br><span class="line">qemu-kvm -cpu ?</span><br><span class="line">8. 安装VNC服务端</span><br><span class="line">yum -y install tigervnc-server</span><br><span class="line">9. 将系统镜像文件复制到服务器</span><br><span class="line">10. 创建虚拟机的镜像文件目录并创建镜像文件</span><br><span class="line">mkdir /images/vm1 -pv</span><br><span class="line">qemu-img create -f qcow2 -o size=100G /images/vm1/ubuntu.qcow2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建虚拟机前，需要先有一个虚拟磁盘文件，不然无法创建虚拟机</span></span><br><span class="line">11. 创建虚拟机</span><br><span class="line">qemu-kvm -name "ubuntu10" -m 1024 -smp 2 -hda /images/vm1/ubuntu.qcow2 -cdrom ubuntu-10.01.***.iso -vnc :0 -boot order=dc</span><br><span class="line"><span class="meta">#</span><span class="bash"> -name是取一个虚拟机的名字；-m指定内存大小；-smp指定CPU的颗数，但不要超过物理核心数；-hda是指定磁盘镜像，因为是本地第一个分区所以用-hda；-cdrom是指定光盘镜像；-boot是指定启动次序，这里的d指使用一次；-net nic是指定网卡的，指定nic会向某个接口进行桥连接，如果不能连接会报错，所以这里不用此选项；-vnc :0是为了避免vnc连接失败。启动后提示在5900上启动了vnc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发现在ubuntu18.04中找不到qemu-kvm命令，即使安装了qemu-kvm包。</span></span><br><span class="line">12. 在CentOS上安装vnc客户端测试</span><br><span class="line">yum -y install tigervnc</span><br><span class="line">13. 连接VNC服务器进行安装</span><br><span class="line">vncviewer :5900</span><br><span class="line">14. windows上安装VNC-viewer软件，连接时输入IP:5900，NAME输入在qemu-kvm创建时用-name创建的虚拟机名字</span><br><span class="line">15. 安装xp系统</span><br><span class="line">qemu-img create -f qcow2 -o size=100G /images/vm1/xp.qcow2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建虚拟磁盘</span></span><br><span class="line">qemu-kvm -name "winxp" -m 768 -smp 4 -drive file=/images/vm1/xp.qcow2,if=ide,index=0,media=disk,format=qcow2 -drive file=/root/winxp_ghost.iso,media=cdrom,index=1 -vnc :0 -boot order=dc</span><br><span class="line"><span class="meta">#</span><span class="bash"> -drive中的第一個file指定磁盤映像文件，<span class="keyword">if</span>指定磁盤接口類型，index表示爲第幾個設備，0爲第一個設備，從0開始編號，media=disk表示是一個磁盤設備，format=qcow2是指定映像文件的格式。第二個file指定光盤映像文件，media=cdrom是指明是一個光盤。啓動成功。</span></span><br><span class="line">16. 安装openSUSE</span><br><span class="line">qemu-kvm -m 2048 -name opensuse -drive file=/home/ruopu/private1/VirtaulOS/openSUSE/openSUSE.qcow2,media=disk,format=qcow2,if=ide -net nic -boot c</span><br><span class="line"></span><br><span class="line">* 方法二</span><br><span class="line">1. 查看是否支持虚拟化</span><br><span class="line">egrep '(vmx|svm)' /proc/cpuinfo</span><br><span class="line">2. 关闭SELinux和防火墙</span><br><span class="line">setenforce 0</span><br><span class="line">getenforce</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">3. 加载kvm模块</span><br><span class="line">modprobe kvm</span><br><span class="line">4. 查看是否加载kvm</span><br><span class="line">lsmod | grep kvm</span><br><span class="line">5. 安装依赖软件</span><br><span class="line">yum install -y qemu-kvm libvirt virt-install bridge-utils tigervnc tigervnc-server virt-manager</span><br><span class="line"><span class="meta">#</span><span class="bash"> virt-manager是一个图形管理页面</span></span><br><span class="line">6. 开启kvm服务，并且设置其开机自动启动</span><br><span class="line">systemctl start libvirtd</span><br><span class="line">systemctl enable libvirtd</span><br><span class="line">systemctl status libvirtd</span><br><span class="line">systemctl is-enabled libvirtd</span><br><span class="line">7. 配置网桥模式。配置好之后会有br0和virbr0两个网卡</span><br><span class="line">cd /etc/sysconfig/network-scripts</span><br><span class="line">cp ifcfg-eno16777736 ifcfg-eno16777736.bak</span><br><span class="line">vim ifcfg-br0</span><br><span class="line">    BOOTPROTO=static</span><br><span class="line">    DEVICE=br0</span><br><span class="line">    TYPE=Bridge</span><br><span class="line">    NM_CONTROLLED=no</span><br><span class="line">    IPADDR=192.168.1.90</span><br><span class="line">    NETMASK=255.255.255.0</span><br><span class="line">    GATEWAY=192.168.1.1</span><br><span class="line">    DNS1=192.168.1.1</span><br><span class="line">vim ifcfg-eno16777736</span><br><span class="line">    BOOTPROTO=none</span><br><span class="line">    DEVICE=enp0s25</span><br><span class="line">    NM_CONTROLLED=no	</span><br><span class="line">    # 此条必须配置。这是NetworkManager的参数，如果是yes，那么会实时生效，修改后无需要重启网卡立即生效。通常不使用NetworkManager管理网络</span><br><span class="line">    ONBOOT=yes</span><br><span class="line">    BRIDGE=br0</span><br><span class="line">systemctl restart network</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可按此方法配置多个网桥设备</span></span><br><span class="line">8. 复制系统镜像文件到服务器</span><br><span class="line">9. 创建虚拟磁盘，这里创建的镜像文件格式建议用.img格式。</span><br><span class="line">qemu-img create -f qcow2 -o size=50G centos7.img</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要事先创建磁盘文件，不然下面的命令会报错“ERROR Format cannot be specified <span class="keyword">for</span> unmanaged storage.”，这应该是virt-manager 没有找到存储池的问题</span></span><br><span class="line">qemu-img create -f qcow2 -opreallocation=metadata RHEL7.img 40G</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样创建磁盘也可以，重要的是-opreallocation=metadata选项，可以预分配磁盘，硬盘空间不会立即分配出去</span></span><br><span class="line">10. 创建虚拟机 </span><br><span class="line">virt-install -n xp -r 1024 --vcpus 2 --disk /images/xp.img,format=qcow2,size=50 --network bridge=br0 --os-type=windows --cdrom /images/vm1/xp.iso --vnc --vncport=5900 --vnclisten=0.0.0.0 --accelerate</span><br><span class="line"></span><br><span class="line">virt-install -n centos6 -r 1024 --vcpus 2 --disk /images/centos.img,format=qcow2,size=30 --network bridge=br0 --network bridge=br1 --os-type=linux --cdrom /images/vm1/centos6.iso --vnc --vncport=5900 --vnclisten=0.0.0.0 --accelerate </span><br><span class="line"><span class="meta">#</span><span class="bash"> --accelerate表示KVM或KQEMU内核加速,这个选项是推荐最好加上。如果KVM和KQEMU都支持，KVM加速器优先使用。--vncport指定端口，--vnclisten很重要，0.0.0.0表示监听在所有端口，不指定的话会监听在本地回环地址，用vncviewer是不能连接的。另外，不能两个VNC软件同时连接虚拟机；--disk /images/centos.img,format=qcow2,size=30是一定要定义的，这与上面创建的磁盘大小没有关系，如果这里不指定磁盘大小，在安装时会显示磁盘大小是0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在启动KVM时，提示<span class="string">"ioctl(KVM_CREATE_VM) failed: 16 Device or resource busy"</span>。这是因为有另一个虚拟程序在运行，它锁定了虚拟化功能。如VirtualBox在运行时，就不能启动KVM虚拟机了。</span></span><br></pre></td></tr></table></figure>
<h3 id="查看虚拟机状态"><a href="#查看虚拟机状态" class="headerlink" title="查看虚拟机状态"></a>查看虚拟机状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh list --all</span><br></pre></td></tr></table></figure>
<h3 id="虚拟机的启动、停止与删除"><a href="#虚拟机的启动、停止与删除" class="headerlink" title="虚拟机的启动、停止与删除"></a>虚拟机的启动、停止与删除</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">* 启动</span><br><span class="line">virsh start xp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动虚拟机</span></span><br><span class="line">virsh create /etc/libvirt/qemu/C7.xml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过配置文件启动虚拟机</span></span><br><span class="line">virsh autostart RHEL</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置开机自启动虚拟机</span></span><br><span class="line"></span><br><span class="line">* 关闭</span><br><span class="line">virsh shutdown xp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭虚拟机</span></span><br><span class="line">systemctl start acpid</span><br><span class="line">systemctl enable acpid</span><br><span class="line">virsh shutdown RHEL</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认情况下virsh工具不能对linux虚拟机进行关机操作，linux操作系统需要开启与启动acpid服务。在安装KVM linux虚拟机必须配置此服务。</span></span><br><span class="line">virsh destroy RHEL</span><br><span class="line"><span class="meta">#</span><span class="bash"> 强制关闭虚拟机RHEL</span></span><br><span class="line"></span><br><span class="line">* 删除</span><br><span class="line">virsh undefine RHEL</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除虚拟机，前提条件是这个虚拟机没有快照文件，如果有就要先删除快照再删除虚拟机。该命令只是删除RHEL虚拟机的配置文件，并不删除虚拟磁盘文件。</span></span><br><span class="line"></span><br><span class="line">* 挂起服务器</span><br><span class="line">virsh suspend RHEL</span><br><span class="line"></span><br><span class="line">* 恢复服务器</span><br><span class="line">virsh  resume RHEL</span><br><span class="line"></span><br><span class="line">* 导出KVM虚拟机配置文件</span><br><span class="line">virsh dumpxml RHEL &gt; /etc/libvirt/qemu/wintest02.xml</span><br><span class="line"></span><br><span class="line">*  重新定义虚拟机配置文件</span><br><span class="line">mv /etc/libvirt/qemu/C7_1.xml /etc/libvirt/qemu/C7.xml</span><br><span class="line">virsh define /etc/libvirt/qemu/C7.xml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过导出备份的配置文件恢复原KVM虚拟机的定义，并重新定义虚拟机。</span></span><br></pre></td></tr></table></figure>
<h3 id="修改现有虚拟机配置"><a href="#修改现有虚拟机配置" class="headerlink" title="修改现有虚拟机配置"></a>修改现有虚拟机配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh edit RHEL</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这会打开虚拟机的配置文件，在虚拟机关机状态下修改后保存并启动虚拟机就会生效。如果用vim修改/etc/libvirt/qemu/目录中的虚拟机的xml文件是不能生效的</span></span><br><span class="line">virsh dominfo RHEL</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改完以后用此命令查看现在的虚拟机的配置</span></span><br></pre></td></tr></table></figure>
<h3 id="添加、删除网卡"><a href="#添加、删除网卡" class="headerlink" title="添加、删除网卡"></a>添加、删除网卡</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@ccjd shaosong]# virsh domiflist SScentos7</span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet0      bridge     br0        -           52:54:00:7e:7b:7e</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看网卡信息</span></span><br><span class="line">[root@ccjd shaosong]# virsh attach-interface SScentos7 --type bridge --source br1</span><br><span class="line">Interface attached successfully</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给SScentos7虚拟机临时添加一块叫br1的网卡</span></span><br><span class="line">[root@ccjd shaosong]# virsh domiflist SScentos7</span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet0      bridge     br0        -           52:54:00:7e:7b:7e</span><br><span class="line">vnet1      bridge     br1        -           52:54:00:b9:a1:e2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再查看时已多了一块网卡，在虚拟机中也可以看到此网卡，并且可以使用。</span></span><br><span class="line">[root@ccjd shaosong]# virsh attach-interface SScentos7 --type bridge --source br1 --config</span><br><span class="line"><span class="meta">#</span><span class="bash"> 永久添加网卡，使用--config选项</span></span><br><span class="line">Interface attached successfully</span><br><span class="line">[root@ccjd shaosong]# virsh edit SScentos7</span><br><span class="line">Domain SScentos7 XML configuration not changed.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看虚拟机的配置文件，可以看到多了一个新网卡的配置信息</span></span><br><span class="line"> &lt;interface type='bridge'&gt;</span><br><span class="line">      &lt;mac address='52:54:00:7e:7b:7e'/&gt;</span><br><span class="line">      &lt;source bridge='br0'/&gt;</span><br><span class="line">      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">    &lt;interface type='bridge'&gt;</span><br><span class="line">      &lt;mac address='52:54:00:5a:89:15'/&gt;</span><br><span class="line">      &lt;source bridge='br1'/&gt;</span><br><span class="line">      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">[root@ccjd shaosong]# virsh shutdown SScentos7</span><br><span class="line">Domain SScentos7 is being shutdown</span><br><span class="line">[root@ccjd shaosong]# virsh start SScentos7</span><br><span class="line">Domain SScentos7 started</span><br><span class="line">[root@ccjd shaosong]# virsh domiflist SScentos7</span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet0      bridge     br0        -           52:54:00:7e:7b:7e</span><br><span class="line">vnet1      bridge     br1        -           52:54:00:5a:89:15</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启虚拟机可以看到网卡被永久添加上了</span></span><br><span class="line">[root@ccjd shaosong]# virsh detach-interface SScentos7 --type bridge --mac 52:54:00:5a:89:15 --config</span><br><span class="line">Interface attached successfully</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除虚拟机网卡</span></span><br></pre></td></tr></table></figure>
<h3 id="克隆虚拟机"><a href="#克隆虚拟机" class="headerlink" title="克隆虚拟机"></a>克隆虚拟机</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virt-clone -o C7 -n C7-1 -f /data/c7_1.img -f /data/c7_2.img</span><br><span class="line"><span class="meta">#</span><span class="bash"> C7是现有的域名(虚拟机名)，C7-1是要创建的域名，c7_1.img是要创建的镜像文件，这里不需要事先创建虚拟磁盘。这条命令是说将C7域克隆一个叫C7-1的域，创建的镜像文件在/data目录下，叫c7_1.img。克隆时要关闭虚拟机。如果有多个磁盘，要用多个-f选项指定。这里不需要指定原来的*.img镜像文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 克隆的问题是都会使用同样的VNC端口，这样就不能将所有克隆虚拟机都启动，需要使用<span class="string">"virsh edit 虚拟机名"</span>，打开虚拟机的配置文件，找到VNC的端口号并修改。之后保存退出才能启动。</span></span><br></pre></td></tr></table></figure>
<h3 id="快照"><a href="#快照" class="headerlink" title="快照"></a>快照</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* 创建</span><br><span class="line">virsh snapshot-create C7</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建域名叫C7的快照；快照配置文件在/var/lib/libvirt/qemu/snapshot/虚拟机名称/下</span></span><br><span class="line">virsh snapshot-list C7</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看C7域的快照</span></span><br><span class="line">virsh snapshot-current C7</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前虚拟机镜像快照的版本</span></span><br><span class="line">virsh snapshot-create-as C7 centos_install_ftp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为虚拟机C7创建快照，快照名称为centos_install_ftp</span></span><br><span class="line"></span><br><span class="line">* 恢复虚拟机快照</span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复虚拟机快照必须关闭虚拟机。</span></span><br><span class="line">virsh domstate winxp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 确认虚拟机状态</span></span><br><span class="line">virsh snapshot-revert winxp 1515577720</span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复快照。1515577720是winxp快照的名字，如果有多个快照，要先用virsh snapshot-list winxp查看快照名字</span></span><br><span class="line">qemu-img info winxp.img</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看镜像的快照名字，可能有多个</span></span><br><span class="line"></span><br><span class="line">* 删除</span><br><span class="line">virsh snapshot-delete winxp 1515577720</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除winxp的叫1515577720的快照</span></span><br></pre></td></tr></table></figure>
<h3 id="重命名虚拟机"><a href="#重命名虚拟机" class="headerlink" title="重命名虚拟机"></a>重命名虚拟机</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1. 关闭虚拟机</span><br><span class="line">2. 导出虚拟机配置文件</span><br><span class="line">cd /etc/libvirt/qemu/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到虚拟机配置文件目录</span></span><br><span class="line">virsh dumpxml Ytest &gt; openvpn.xml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出Ytest虚拟机的配置文件，叫openvpn.xml</span></span><br><span class="line">virsh snapshot-delete Ytest 1540542652</span><br><span class="line"><span class="meta">#</span><span class="bash"> 先删除之前的虚拟机快照，如果不删除快照是不能删除虚拟机的</span></span><br><span class="line">virsh undefine Ytest</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除虚拟机</span></span><br><span class="line">vim openvpn.xml</span><br><span class="line">    &lt;domain type='kvm'&gt;</span><br><span class="line">      &lt;name&gt;openvpn&lt;/name&gt;	# 修改虚拟机的名字</span><br><span class="line">    .......</span><br><span class="line">    &lt;disk type='file' device='disk'&gt;</span><br><span class="line">          &lt;driver name='qemu' type='qcow2' cache='none'/&gt;</span><br><span class="line">          &lt;source file='/home/IOS/openvpn/openvpn.img'/&gt;	# 修改虚拟机磁盘的路径</span><br><span class="line">cd /home/IOS</span><br><span class="line">mv Ytest/ openvpn</span><br><span class="line">mv Ytest.img openvpn.img</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改之前的虚拟机的目录名称与磁盘文件名称</span></span><br><span class="line">virsh define openvpn.xml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再加载新命名的虚拟机的配置文件</span></span><br><span class="line">virsh list --all</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是否有新命名的虚拟机</span></span><br><span class="line">virsh start openvpn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动新命名的虚拟机</span></span><br></pre></td></tr></table></figure>
<h3 id="修改虚拟机硬件配置"><a href="#修改虚拟机硬件配置" class="headerlink" title="修改虚拟机硬件配置"></a>修改虚拟机硬件配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ccjd qemu]# virsh edit gitlab</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改虚拟机配置文件</span></span><br><span class="line">    &lt;domain type='kvm'&gt;</span><br><span class="line">      &lt;name&gt;gitlab&lt;/name&gt;</span><br><span class="line">      &lt;uuid&gt;77890890-312b-bfed-83ed-c53665cf86d1&lt;/uuid&gt;</span><br><span class="line">      &lt;memory unit='KiB'&gt;8192000&lt;/memory&gt;</span><br><span class="line">      &lt;currentMemory unit='KiB'&gt;8192000&lt;/currentMemory&gt;</span><br><span class="line">      &lt;vcpu placement='static'&gt;4&lt;/vcpu&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 8192000为内存大小，4为CPU核心数。修改后保存，再启动虚拟机即可。</span></span><br></pre></td></tr></table></figure>
<h3 id="给KVM虚拟机添加磁盘"><a href="#给KVM虚拟机添加磁盘" class="headerlink" title="给KVM虚拟机添加磁盘"></a>给KVM虚拟机添加磁盘</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1. cd /home/IOS/RHEL7</span><br><span class="line">2. qemu-img create -f raw RHEL7_1.img 10G</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个磁盘，格式是raw</span></span><br><span class="line">3. virsh edit RHEL7</span><br><span class="line">    &lt;disk type='file' device='disk'&gt;</span><br><span class="line">      &lt;driver name='qemu' type='raw' cache='none'/&gt;</span><br><span class="line">      &lt;source file='/home/IOS/RHEL/RHEL7_1.img'/&gt;</span><br><span class="line">      &lt;target dev='sda' bus='scsi'/&gt;</span><br><span class="line">      &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;disk type='file' device='disk'&gt;</span><br><span class="line">      &lt;driver name='qemu' type='raw' cache='none'/&gt;</span><br><span class="line">      &lt;source file='/home/IOS/RHEL/RHEL7_2.img'/&gt;</span><br><span class="line">      &lt;target dev='hda' bus='ide'/&gt;</span><br><span class="line">      &lt;address type='drive' controller='0' bus='0' target='0' unit='1'/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 原来的硬盘是hda，bus是ide，如果新磁盘与原磁盘一样是ide的，那么要改下面的unit的数字，不一样就可以，不然无法启动。如果磁盘类型不一样，可以直接改类型即可，如上面的类型就是 &lt;target dev=<span class="string">'sda'</span> bus=<span class="string">'scsi'</span>/&gt;，unit是按类型向下编号的，不一样就可以。</span></span><br><span class="line">4. tail -100 /var/log/libvirt/qemu/RHEL7.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果不能启动，可以查看此日志，寻找原因。日志是以虚拟机名命名的。</span></span><br></pre></td></tr></table></figure>
<h3 id="kvm开启虚拟化"><a href="#kvm开启虚拟化" class="headerlink" title="kvm开启虚拟化"></a>kvm开启虚拟化</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 先检查 KVM host（宿主机/母机）上的kvm_intel模块是否打开了嵌套虚拟机功能（默认是开启的）：</span></span><br><span class="line">1. modinfo kvm_intel | grep nested</span><br><span class="line">      parm: nested:bool</span><br><span class="line">2. cat /sys/module/kvm_intel/parameters/nested</span><br><span class="line">      Y</span><br><span class="line">3. 如果上面的显示结果不是 Y 的话需要开启 nested：</span><br><span class="line">modprobe -r kvm-intel</span><br><span class="line">modprobe kvm-intel nested=1</span><br><span class="line">cat /sys/module/kvm_intel/parameters/nested</span><br><span class="line">    Y</span><br><span class="line">4. 如果使用libvirt管理虚拟机,需要修改虚拟机xml文件中CPU的定义,下面定义方法都可以:</span><br><span class="line">* 方法一</span><br><span class="line">virsh edit debian9.3</span><br><span class="line">  &lt;cpu mode='custom' match='exact'&gt;</span><br><span class="line">    &lt;model fallback='allow'&gt;core2duo&lt;/model&gt;</span><br><span class="line">    &lt;feature policy='require' name='vmx'/&gt;	# 添加这一行</span><br><span class="line">  &lt;/cpu&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash">这种方式为虚拟机定义需要模拟的CPU类型<span class="string">"core2duo"</span>,并且为虚拟机添加<span class="string">"vmx"</span>特性</span></span><br><span class="line"></span><br><span class="line">* 方法二</span><br><span class="line">  &lt;cpu mode='host-model'&gt;</span><br><span class="line">    &lt;model fallback='allow'/&gt;</span><br><span class="line">  &lt;/cpu&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 参考：https://www.cnblogs.com/chimeiwangliang/p/7862229.html</span></span><br></pre></td></tr></table></figure>
<h3 id="虚拟机静态迁移"><a href="#虚拟机静态迁移" class="headerlink" title="虚拟机静态迁移"></a>虚拟机静态迁移</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* 静态迁移就是虚拟机在关机状态下，拷贝虚拟机虚拟磁盘文件与配置文件到目标虚拟主机中，实现的迁移。</span><br><span class="line"><span class="meta">#</span><span class="bash"> 虚拟主机各自使用本地存储存放虚拟机磁盘文件。本文实现基于本地磁盘存储虚拟机磁盘文件的迁移方式。虚拟主机之间使用共享存储存放虚拟机磁盘文件，该方式只是在目标虚拟主机上重新定义虚拟机就可以了。</span></span><br><span class="line">1. 先确定虚拟机关机</span><br><span class="line">virsh list --all</span><br><span class="line">2. 准备迁移winxp虚拟机，查看此虚拟机配置的磁盘文件</span><br><span class="line">virsh domblklist winxp</span><br><span class="line">3. 导出虚拟机配置文件</span><br><span class="line">virsh dumpxml winxp &gt; /root/winxp.xml</span><br><span class="line">4. 拷贝配置文件到目标虚拟主机上</span><br><span class="line">scp /root/winxp.xml root@192.168.1.11:/etc/libvirt/qemu/</span><br><span class="line">5. 拷贝虚拟机磁盘文件到目标虚拟机</span><br><span class="line">scp winxp.img root@192.168.1.11:/data</span><br><span class="line">6. 到目标主机上查看。目标主机的目录结构要与源虚拟主机一致</span><br><span class="line">7. 定义注册虚拟主机</span><br><span class="line">virsh define /etc/libvirt/qemu/winxp.xml</span><br><span class="line">8. 启动虚拟机</span><br><span class="line">virsh start winxp</span><br></pre></td></tr></table></figure>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/libvirt</span><br><span class="line"><span class="meta">#</span><span class="bash"> qemu配置文件位置 </span></span><br><span class="line">/etc/libvirt/qemu</span><br><span class="line"><span class="meta">#</span><span class="bash"> 虚拟机配置文件位置</span></span><br></pre></td></tr></table></figure>
<h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><h4 id="VNC软件无法正常连接"><a href="#VNC软件无法正常连接" class="headerlink" title="VNC软件无法正常连接"></a>VNC软件无法正常连接</h4><ol>
<li>在windows主机上安装VNC Viewer，使用此软件打开虚拟机。另外，用此工具连接后可能会有错误提示“ZlibInStream:Inflate Failed”，并且不断刷新页面，无法正常进入。如下：</li>
</ol>
<p><img src="/images/KVM/winconnect1.jpg" alt=""></p>
<ol start="2">
<li>设置图像，从高到低试，测试时选择High就可以正常连接了。</li>
</ol>
<p><img src="/images/KVM/winconnect2.jpg" alt=""></p>
<p><img src="/images/KVM/winconnect3.jpg" alt=""></p>
<h4 id="virt-manager键盘输入错乱"><a href="#virt-manager键盘输入错乱" class="headerlink" title="virt-manager键盘输入错乱"></a>virt-manager键盘输入错乱</h4><ol>
<li>需要在Details中的VNC中选择en-us</li>
</ol>
<p><img src="/images/KVM/vncconnect1.jpg" alt=""></p>
<h4 id="从远程打开KVM的图形管理页面"><a href="#从远程打开KVM的图形管理页面" class="headerlink" title="从远程打开KVM的图形管理页面"></a>从远程打开KVM的图形管理页面</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* CentOS6.6系统</span><br><span class="line">yum groupinstall "X 窗口系统"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 远程连接服务器，使用ssh -X IP</span></span><br><span class="line">virt-manager</span><br><span class="line">错误提示：</span><br><span class="line">    ”process 63345: D-Bus library appears to be incorrectly set up; failed to read machine uuid: Failed to open "/var/lib/dbus/machine-id": 没有那个文件或目录</span><br><span class="line">    See the manual page for dbus-uuidgen to correct this issue.</span><br><span class="line">      D-Bus not built with -rdynamic so unable to print a backtrace“</span><br></pre></td></tr></table></figure>
<p><img src="/images/KVM/openkvm.jpg" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">解决办法：</span><br><span class="line">dbus-uuidgen &gt; /var/lib/dbus/machine-id</span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行此命令后就可以远程打开virt-manager了，但是乱码</span></span><br><span class="line"></span><br><span class="line">yum groupinstall "中文支持"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装完中文后，乱码就解决了。</span></span><br></pre></td></tr></table></figure>
<h4 id="报错error-unsupported-configuration-Unable-to-find-security-driver-for-label-selinux"><a href="#报错error-unsupported-configuration-Unable-to-find-security-driver-for-label-selinux" class="headerlink" title="报错error: unsupported configuration: Unable to find security driver for label selinux"></a>报错error: unsupported configuration: Unable to find security driver for label selinux</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">virsh edit 虚拟机名</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除最后有selinux的行，再启动就没问题了。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/27/openvpn搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/27/openvpn搭建/" itemprop="url">
                  openvpn搭建
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-27 16:42:18" itemprop="dateCreated datePublished" datetime="2018-10-27T16:42:18+08:00">2018-10-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-07 12:21:10" itemprop="dateModified" datetime="2018-11-07T12:21:10+08:00">2018-11-07</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">* ServerIP: 10.5.5.27、192.168.0.181</span><br><span class="line">yum install -y epel-release</span><br><span class="line">yum install -y openvpn easy-rsa</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装openvpn</span></span><br><span class="line">cp /usr/share/doc/openvpn-2.4.6/sample/sample-config-files/server.conf /etc/openvpn/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝该示例配置文件到配置目录</span></span><br><span class="line">vim /etc/openvpn/server.conf</span><br><span class="line">    local 10.5.5.27</span><br><span class="line">    port 1194	</span><br><span class="line">    # 定义openvpn使用端口</span><br><span class="line">    proto tcp	</span><br><span class="line">    # 通过udp协议连接，也可以使用tcp协议。建议使用TCP协议，这样更稳定。</span><br><span class="line">    dev tun		</span><br><span class="line">    # 定义openvpn运行模式，openvpn有两种运行模式一种是tap模式的以太网通道，一种是tun模式的路由 IP 通道。</span><br><span class="line">    ca /etc/openvpn/easy-rsa/pki/ca.crt		</span><br><span class="line">    # openvpn使用的CA证书文件，CA证书主要用于验证客户证书的合法性，存放位置请依据实际情况自行改动</span><br><span class="line">    cert /etc/openvpn/easy-rsa/pki/issued/server.crt</span><br><span class="line">    # openvpn服务器端使用的证书文件，存放位置请依据实际情况自行改动</span><br><span class="line">    key /etc/openvpn/easy-rsa/pki/private/server.key  # This file should be kept secret</span><br><span class="line">    # 服务器密钥存放位置，请依据实际情况自行改动</span><br><span class="line">    dh /etc/openvpn/easy-rsa/pki/dh.pem</span><br><span class="line">    # Diffie hellman文件，存放位置请依据实际情况自行改动</span><br><span class="line">    server 10.8.0.0 255.255.255.0</span><br><span class="line">    # openvpn在使用tun路由模式时，分配给client端分配的IP地址段，虚拟局域网网段设置，请依据须要自行改动，不支持和拔号网卡位于同一网段</span><br><span class="line">    ifconfig-pool-persist ipp.txt</span><br><span class="line">    # 在openvpn重新启动时,再次连接的client将依旧被分配和曾经一样的IP地址</span><br><span class="line">    push "route 192.168.0.0 255.255.255.0"</span><br><span class="line">    # 为客户端创建对应的路由,以另其与公司网内部服务器通信,但记住，公司网内部服务器也需要有可用路由返回到客户端</span><br><span class="line">    ;push "redirect-gateway def1 bypass-dhcp"</span><br><span class="line">    # 测试发现，不加此条，在客户端连接openvpn后，可以连通外网，加此条无法解析外网地址。</span><br><span class="line">    push "dhcp-option DNS 114.114.114.114"</span><br><span class="line">    push "dhcp-option DNS 114.114.115.115"</span><br><span class="line">    # 向客户端推送的DNS信息，DNS配置，依据实际情况配置</span><br><span class="line">    keepalive 10 120</span><br><span class="line">    # 活动连接保时期限</span><br><span class="line">    tls-auth ta.key 0 # This file is secret</span><br><span class="line">    cipher AES-256-CBC</span><br><span class="line">    comp-lzo</span><br><span class="line">    max-clients 10</span><br><span class="line">    user nobody</span><br><span class="line">    group nobody</span><br><span class="line">    persist-key</span><br><span class="line">    persist-tun</span><br><span class="line">    status openvpn-status.log</span><br><span class="line">    log-append  openvpn.log</span><br><span class="line">    verb 3</span><br><span class="line">mkdir -p /etc/openvpn/easy-rsa/keys</span><br><span class="line">cp -rf /usr/share/easy-rsa/3.0.3/* /etc/openvpn/easy-rsa/</span><br><span class="line">cp /usr/share/doc/easy-rsa-3.0.3/vars.example /etc/openvpn/easy-rsa/vars</span><br><span class="line">cd /etc/openvpn/easy-rsa/</span><br><span class="line">vim vars </span><br><span class="line">    set_var EASYRSA	"$PWD"</span><br><span class="line">    set_var EASYRSA_PKI		"$EASYRSA/pki"</span><br><span class="line">    # 定义key的生成目录</span><br><span class="line">    set_var EASYRSA_DN	"cn_only"</span><br><span class="line">    set_var EASYRSA_REQ_COUNTRY	"CN"</span><br><span class="line">    # 定义所在的国家       </span><br><span class="line">    set_var EASYRSA_REQ_PROVINCE	"BJ"</span><br><span class="line">    # 定义所在的省         </span><br><span class="line">    set_var EASYRSA_REQ_CITY	"BeiJing"</span><br><span class="line">    # 定义所在的城市    </span><br><span class="line">    set_var EASYRSA_REQ_ORG	"ccjd"</span><br><span class="line">    # 定义所在的组织        </span><br><span class="line">    set_var EASYRSA_REQ_EMAIL	"ccjd@goldenet.com"</span><br><span class="line">    # 定义邮箱           </span><br><span class="line">    set_var EASYRSA_REQ_OU		"IT"</span><br><span class="line">    # 定义所在单位  </span><br><span class="line">    set_var EASYRSA_KEY_SIZE	2048</span><br><span class="line">    # 定义生成私钥的大小，一般为1024或2048，默认为2048位。这个就是我们在执行build-dh命令生成dh2048文件的依据。</span><br><span class="line">    set_var EASYRSA_ALGO		rsa</span><br><span class="line">    set_var EASYRSA_CA_EXPIRE	3650</span><br><span class="line">    # ca证书有效期，默认为3650天，即十年            </span><br><span class="line">    set_var EASYRSA_CERT_EXPIRE	3650</span><br><span class="line">    # 定义秘钥的有效期，默认为3650天，即十年             </span><br><span class="line">    set_var EASYRSA_NS_SUPPORT	"no"</span><br><span class="line">    set_var EASYRSA_NS_COMMENT	"Easy-RSA Generated Certificate"</span><br><span class="line">    set_var EASYRSA_EXT_DIR	"$EASYRSA/x509-types"</span><br><span class="line">    set_var EASYRSA_SSL_CONF	"$EASYRSA/openssl-1.0.cnf"</span><br><span class="line">    set_var EASYRSA_DIGEST		"sha256"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置证书文件，修改上面的行</span></span><br><span class="line">./easyrsa init-pki</span><br><span class="line"><span class="meta">#</span><span class="bash"> 到easy-rsa目录下，初始化，会在当前目录创建PKI目录，用于存储一些中间变量及最终生成的证书 </span></span><br><span class="line">./easyrsa build-ca nopass</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建根证书，nopass表示不设置密码，一直回车即可。会生成根证书：ca.crt，文件在：/etc/openvpn/easy-rsa/pki/ca.crt</span></span><br><span class="line">./easyrsa gen-dh</span><br><span class="line">openvpn --genkey --secret ta.key</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建ta.key</span></span><br><span class="line">cp -r ta.key /etc/openvpn/</span><br><span class="line">./easyrsa gen-req server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建服务端证书，生成请求，使用gen-req来生成req，创建server端证书和private key。也可以在之后使用nopass，或设置密码。生成服务器证书：/etc/openvpn/easy-rsa/pki/private/server.key、/etc/openvpn/easy-rsa/pki/reqs/server.req</span></span><br><span class="line">./easyrsa sign-req server server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 签发证书,签约服务端证书，给server端证书做签名，首先是对一些信息的确认，可以输入yes，然后输入build-ca时设置的那个密码，因上面没有设置密码，所以会直接通过。生成服务端签名证书：/etc/openvpn/easy-rsa/pki/issued/server.crt</span></span><br><span class="line">./easyrsa build-client-full ccjd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成客户端用户证书，ccjd是用户名，需要输入客户端密码与ca密码（上面没有设置）。生成客户端用户签名证书：/etc/openvpn/easy-rsa/pki/issued/ccjdname.crt、/etc/openvpn/easy-rsa/pki/private/ccjdname.key、/etc/openvpn/easy-rsa/pki/reqs/ccjdname.req</span></span><br><span class="line">systemctl start openvpn@server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动服务，启动时输入创建服务端证书时输入的密码，第一次启动可能不成功，可以再使用此命令启动，直到需要输入密码为止</span></span><br><span class="line">	systemd-tty-ask-password-agent</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 启动后输入上面命令，再输入密码</span></span><br><span class="line">ss -tlnu</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是否监听了udp的1194端口，如果没有监听，可以再执行启动命令，直到监听端口为止</span></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加路由转发功能</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line">	net.ipv4.ip_forward = 1</span><br><span class="line">sysctl -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种方法也可以开启转发功能，sysctl -p是使用配置文件生效</span></span><br><span class="line">iptables -t nat -I POSTROUTING -s 10.8.0.0/24 -j SNAT --to-source 192.168.0.181</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置完生效可能有此慢，需要等半分钟</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为是固定IP，只是想让连接openvpn的主机可以访问另一个网段的主机，所以这里用了源地址转换，所有连接openvpn的主机会使用openvpn服务器的192地址与192.168.0.0/24网段的主机通信。如果是动态IP，也可以使用命令：iptables -t nat -I POSTROUTING -s 10.8.0.0/24 -j MASQUERADE</span></span><br><span class="line">tcpdump -i tun0 -nn</span><br></pre></td></tr></table></figure>
<h3 id="windows-Client"><a href="#windows-Client" class="headerlink" title="windows Client"></a>windows Client</h3><ul>
<li>下载安装openvpn-install-2.3.3-I002-i686，安装时选中所有选项</li>
<li>将安装目录中的sample-config目录中的Client.ovpn文件放入安装目录中的config目录中。将服务器端的ccjd.key、ca.crt、ta.key、ccjd.crt四个文件也放入config目录中</li>
<li>设置客户端配置文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">client</span><br><span class="line">dev tun</span><br><span class="line">proto tcp</span><br><span class="line">remote 10.5.5.27 1194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">remote-cert-tls server</span><br><span class="line">ca ca.crt</span><br><span class="line">cert ccjd.crt</span><br><span class="line">key ccjd.key</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">push dhcp-option DNS 114.114.114.114</span><br><span class="line">push dhcp-option DNS 8.8.8.8</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">log-append ccjd.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义此条后，启动软件后在config目录中会有ccjd.log文件，其中记录了启动失败的原因。</span></span><br><span class="line">status ccjd-status.log</span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure>
<ul>
<li>使用管理者权限启动OpenVPN GUI，在屏幕右下角会有一个加锁的窗口的标志，如果连接成功，这个标志会变为绿色。因为要添加路由表，所以使用管理员权限打开客户端，如果用普通用户启动客户端是没法添加路由条目的，连接后也无法使用。</li>
<li>启动失败，可以查看config目录中的ccjd.log文件</li>
<li>注意客户端主机的系统时间，时间不对也会影响连接</li>
<li>调整客户端网卡配置到，一定要重新连接openvpn。可以在任务管理器中杀死两个openvpn的进程。</li>
<li>连接后，在客户端查看路由表，应该有加红框的两条路由</li>
</ul>
<p><img src="/images/openvpn/openvpn1.jpg" alt=""></p>
<h3 id="CentOS7-Client"><a href="#CentOS7-Client" class="headerlink" title="CentOS7_Client"></a>CentOS7_Client</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release</span><br><span class="line">yum install -y openvpn</span><br><span class="line">vim /etc/openvpn/client/ccjd.ovpn</span><br><span class="line">	client</span><br><span class="line">    dev tun</span><br><span class="line">    proto tcp</span><br><span class="line">    remote 10.5.5.27 1194</span><br><span class="line">    resolv-retry infinite</span><br><span class="line">    nobind</span><br><span class="line">    remote-cert-tls server</span><br><span class="line">    ca ca.crt</span><br><span class="line">    cert ccjd.crt</span><br><span class="line">    key ccjd.key</span><br><span class="line">    tls-auth ta.key 1</span><br><span class="line">    persist-key</span><br><span class="line">    persist-tun</span><br><span class="line">    comp-lzo</span><br><span class="line">	verb 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端配置文件</span></span><br><span class="line">apt install -y openssl libssl-dev lzop</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装openssl和lzo，lzo用于压缩通讯数据加快传输速度</span></span><br><span class="line">* 将ca.crt、ta.key、ccjd.crt、ccjd.key四个文件放入/etc/openvpn目录下</span><br><span class="line">openvpn --daemon --cd /etc/openvpn --config /etc/openvpn/client/ccjd.ovpn --log-append /var/log/openvpn.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动客户端</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --daemon：openvpn以daemon方式启动。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --<span class="built_in">cd</span> dir：配置文件的目录，openvpn初始化前，先切换到此目录。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --config file：客户端配置文件的路径。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --<span class="built_in">log</span>-append file：日志文件路径，如果文件不存在会自动创建。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> **测试发现，如果是ubuntu18.04系统，在启动客户端时，不能加入--daemon选项，如果加入此选项，就无法输入密码。不加此选项才可以输入密码。直接在后台运行会停止程序，可以在启动后使用Ctrl+z让程序在后台运行，之后用```<span class="built_in">bg</span> 运行号```，让后台程序运行。运行号是用<span class="built_in">jobs</span>命令查看到的**</span></span><br><span class="line">tail -f /var/log/openvpn.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看启动日志</span></span><br><span class="line">ip a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是否有openvpn分配的IP地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接后的问题是，有时ping192.168.0.1不通，以为是多个客户端同时使用了一个帐号，但只有一个客户端使用此帐号连接时也会有此问题。要等上一会儿才有反应。测试发现，长ping时，一段时间后就会停下来，再过2－3分钟后又可以ping了</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/22/Jenkins安装与部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/22/Jenkins安装与部署/" itemprop="url">
                  Jenkins安装与部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-22 10:18:30" itemprop="dateCreated datePublished" datetime="2018-10-22T10:18:30+08:00">2018-10-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2019-02-01 18:08:34" itemprop="dateModified" datetime="2019-02-01T18:08:34+08:00">2019-02-01</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/持续集成与部署/" itemprop="url" rel="index"><span itemprop="name">持续集成与部署</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Jenkins简单部署"><a href="#Jenkins简单部署" class="headerlink" title="Jenkins简单部署"></a>Jenkins简单部署</h2><h3 id="rpm包安装启动"><a href="#rpm包安装启动" class="headerlink" title="rpm包安装启动"></a>rpm包安装启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">============================================================================================</span><br><span class="line">环境</span><br><span class="line">准备两台主机</span><br><span class="line">node1：地址：192.168.1.63</span><br><span class="line">node2：地址：192.168.1.64</span><br><span class="line">============================================================================================</span><br><span class="line">------------</span><br><span class="line">  jenkins</span><br><span class="line">------------  </span><br><span class="line">[root@jenkins ~]# yum install -y java-1.8.0-openjdk-devel</span><br><span class="line">[root@jenkins ~]# yum install -y jenkins-2.60.3-1.1.noarch.rpm</span><br><span class="line">[root@jenkins ~]# systemctl start jenkins</span><br><span class="line">[root@jenkins ~]# ss -tln</span><br><span class="line">State       Recv-Q Send-Q            Local Address:Port                           Peer Address:Port              </span><br><span class="line">LISTEN      0      128                           *:111                                       *:*                  </span><br><span class="line">LISTEN      0      128                           *:22                                        *:*                  </span><br><span class="line">LISTEN      0      100                   127.0.0.1:25                                        *:*                  </span><br><span class="line">LISTEN      0      128                          :::111                                      :::*                  </span><br><span class="line">LISTEN      0      50                           :::8080</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到监控了8080端口</span></span><br><span class="line">[root@jenkins ~]# vim /etc/sysconfig/jenkins</span><br><span class="line">JENKINS_JAVA_OPTIONS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整jenkins的使用内存，默认此项是-Djava.awt.headless=<span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xms：初始堆内存Heap大小，使用的最小内存，cpu性能高时此值应设的大一些</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xmx：初始堆内存heap最大值，使用的最大内存</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -XX:MaxPermSize:设定最大内存的永久保存区域</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -Xms与-Xmx设置相同的值，需要根据实际情况设置，增大内存可以提高读写性能</span></span><br><span class="line">访问http://192.168.1.63:8080</span><br></pre></td></tr></table></figure>
<h3 id="tomcat启动"><a href="#tomcat启动" class="headerlink" title="tomcat启动"></a>tomcat启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">  jenkins</span><br><span class="line">------------  </span><br><span class="line">[root@jenkins ~]# yum install -y tomcat</span><br><span class="line">[root@jenkins ~]# cp /usr/lib/jenkins/jenkins.war /usr/share/tomcat/webapps/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将上面安装的jenkins的war包复制到tomcat的部署目录下，也可以直接下载jenkins的war包</span></span><br><span class="line">[root@jenkins ~]# vim /etc/sysconfig/tomcat</span><br><span class="line">JAVA_OPTS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整tomcat使用jvm内存</span></span><br><span class="line">[root@jenkins ~]# systemctl start tomcat</span><br><span class="line">[root@jenkins ~]# ps aux|grep tomcat</span><br><span class="line">tomcat     2242 17.4 40.8 3718460 763224 ?      Ssl  19:27   0:21 /usr/lib/jvm/jre/bin/java -Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m -classpath /usr/share/tomcat/bin/bootstrap.jar:/usr/share/tomcat/bin/tomcat-juli.jar:/usr/share/java/commons-daemon.jar -Dcatalina.base=/usr/share/tomcat -Dcatalina.home=/usr/share/tomcat -Djava.endorsed.dirs= -Djava.io.tmpdir=/var/cache/tomcat/temp -Djava.util.logging.config.file=/usr/share/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager org.apache.catalina.startup.Bootstrap start</span><br><span class="line"></span><br><span class="line">访问http://192.168.1.63:8080/jenkins</span><br><span class="line">[root@jenkins ~]# cat /usr/share/tomcat/.jenkins/secrets/initialAdminPassword </span><br><span class="line">cdc0bfcfa03e4d2da4f7232b213c50c1</span><br><span class="line"><span class="meta">#</span><span class="bash">  查看登录jenkins的默认密码</span></span><br></pre></td></tr></table></figure>
<h3 id="安装maven"><a href="#安装maven" class="headerlink" title="安装maven"></a>安装maven</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">  maven</span><br><span class="line">------------</span><br><span class="line">[root@maven ~]# yum install -y java-1.8.0-openjdk-devel  tomcat tomcat-admin-webapps</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在当前主机上安装一个tomcat，稍后测试maven构建的包是否可以正常运行</span></span><br><span class="line">[root@maven ~]# yum install -y maven git</span><br><span class="line">[root@maven ~]# git clone https://github.com/mageedu/spring-boot-web-jsp.git</span><br><span class="line"><span class="meta">#</span><span class="bash"> 克隆一个java代码测试。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对maven来说最重要的是pom.xml文件，它描述了这个代码是如何构建的</span></span><br><span class="line">[root@maven ~]# cd spring-boot-web-jsp/</span><br><span class="line">[root@maven ~]# vim /etc/maven/settings.xml</span><br><span class="line">&lt;mirrors&gt;</span><br><span class="line">&lt;mirror&gt;</span><br><span class="line">       &lt;id&gt;nexus-osc&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus osc&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> mirrors段添加国内源地址。</span></span><br><span class="line">&lt;profile&gt;</span><br><span class="line">    &lt;id&gt;jdk-1.4&lt;/id&gt;</span><br><span class="line">    &lt;activation&gt;</span><br><span class="line">    &lt;jdk&gt;1.4&lt;/jdk&gt;</span><br><span class="line">    &lt;/activation&gt;</span><br><span class="line">    &lt;repositories&gt;</span><br><span class="line">        &lt;repository&gt;</span><br><span class="line">            &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;local private nexus&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">            &lt;releases&gt;</span><br><span class="line">                &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">            &lt;/releases&gt;</span><br><span class="line">            &lt;snapshots&gt;</span><br><span class="line">                &lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">            &lt;/snapshots&gt;</span><br><span class="line">        &lt;/repository&gt;</span><br><span class="line">    &lt;/repositories&gt;</span><br><span class="line">    &lt;pluginRepositories&gt;</span><br><span class="line">        &lt;pluginRepository&gt;</span><br><span class="line">            &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;local private nexus&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">            &lt;releases&gt;</span><br><span class="line">                &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">            &lt;/releases&gt;</span><br><span class="line">            &lt;snapshots&gt;</span><br><span class="line">                &lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">            &lt;/snapshots&gt;</span><br><span class="line">        &lt;/pluginRepository&gt;</span><br><span class="line">    &lt;/pluginRepositories&gt;</span><br><span class="line">&lt;/profile&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Maven 还需要安装一些插件包，这些插件包的下载地址也让其指向 oschina.net 的 Maven 地址。在&lt;profiles&gt;中插入</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要修改为国内源，不然构建速度将非常慢。尤其是在jenkins中</span></span><br><span class="line">[root@maven spring-boot-web-jsp]# mvn package</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开始构建。</span></span><br><span class="line">[root@maven ~]# vim /etc/tomcat/tomcat-users.xml</span><br><span class="line">&lt;role rolename="manager-gui"/&gt; </span><br><span class="line">&lt;role rolename="manager-script"/&gt;</span><br><span class="line">&lt;user name="tomcat" password="tomcat" roles="manager-gui,manager-script" /&gt;</span><br><span class="line">[root@maven ~]# vim /etc/sysconfig/tomcat</span><br><span class="line">JAVA_OPTS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line">[root@maven ~]# systemctl start tomcat</span><br><span class="line">[root@maven spring-boot-web-jsp]# ls target/</span><br><span class="line">classes            maven-archiver  spring-boot-web-jsp-1.0      spring-boot-web-jsp-1.0.war.original</span><br><span class="line">generated-sources  maven-status    spring-boot-web-jsp-1.0.war</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到构建后有了war包</span></span><br><span class="line">[root@maven spring-boot-web-jsp]# cp target/spring-boot-web-jsp-1.0.war /usr/share/tomcat/webapps/</span><br><span class="line">访问http://192.168.1.64:8080/spring-boot-web-jsp-1.0/，可以看到部署的结果了</span><br></pre></td></tr></table></figure>
<h3 id="测试jenkins"><a href="#测试jenkins" class="headerlink" title="测试jenkins"></a>测试jenkins</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">  jenkins</span><br><span class="line">------------  </span><br><span class="line">[root@jenkins ~]# scp jenkins.war 192.168.1.64:/usr/share/tomcat/webapps/</span><br><span class="line"><span class="meta">#</span><span class="bash"> jenkins.war包的属主属组应该是tomcat，权限是644</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  maven</span><br><span class="line">------------</span><br><span class="line">[root@maven webapps]# cat /usr/share/tomcat/.jenkins/secrets/initialAdminPassword </span><br><span class="line">083cbf58aefd411b89558aea505f3e94</span><br><span class="line">[root@maven webapps]# vim /etc/tomcat/server.xml</span><br><span class="line">&lt;Connector port="8080" protocol="HTTP/1.1"</span><br><span class="line">               connectionTimeout="20000"</span><br><span class="line">               redirectPort="8443" URIEncoding="UTF-8"/&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash">  让tomcat可以使用UTF-8编码。这是为了让jenkins不再报需要使用UTF-8编码的错误</span></span><br><span class="line">[root@maven webapps]# systemctl restart tomcat</span><br><span class="line">访问http://192.168.1.64:8080/jenkins/  --&gt;  输入密码  --&gt;  选择默认插件  --&gt;  创建新用户  --&gt; 在系统管理中配置jenkins的环境  --&gt;  到系统管理中的global tool configuration中配置JDK的别名和路径，取消自动安装，路径写/usr即可  --&gt;  git工具被默认配置了，因为git包已经安装了。Gradle是java的新的构建工具  --&gt;  配置Mave，使用mvn -v查看版本，将版本号输入到Name中，如maven-3.0.5，路径写/usr</span><br><span class="line"></span><br><span class="line">新建一个任务，叫spring-boot-web-jsp。一般构建选择两种，一是自由风格，一是pipeline（流水线），这里选自由风格。选择github project，输入https://github.com/mageedu/spring-boot-web-jsp.git，这是给定一个代码路径，点击高级可显示Display name输入spring-boot-web，这是自定义的。源码管理中的Git是指如果要推送到远程服务器上，在这里要输入地址，用户名和密码或密钥，在这里还是输入https://github.com/mageedu/spring-boot-web-jsp.git，源码管理不做配置也可以，但测试中发现一定要配置源码管理的地址，不然会提示找不到pom.xml文件。构建触发器是指如果代码更新了要怎么办或什么条件下进行构建。第一可以自定义脚本来触发，build after other projects are built指在其他项目构建完触发，build pericxfically是周期性构建，每隔一段时间就看一下源代码是否有变化，有变化就构建，GitHub hook trigger for GITScrn polling是如果GitHub上注册的hook有变化，就会发送通知，下载代码构建，Poll SCM是不断向github轮询，有符合条件的就构建，这里可以在日程表中写入H/5 * * * *，表示每5分钟轮询一次。在构建中可以选择Invoke top-level Maven targets，表示一个顶级的maven构建，在Maven Version中选择安装的maven版本，Goals中输入构建的路径，这种方式易出错。选择Execute shell表示脚本构建，在Command中写入/usr/bin/mvn package即可，它会自动切换到构建目录下构建。构建后操作就是要发布了。视频中这里没有选择。直接点击项目中的立即构建了，在构建中可以选择console一项，可以打开一个窗口查看构建的过程。</span><br><span class="line"></span><br><span class="line">[root@maven webapps]# cd /usr/share/tomcat/.jenkins/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 构建完成后进入此目录</span></span><br><span class="line">[root@maven .jenkins]# ls workspace/spring-boot-web-jsp/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在workspace目录中有构建完的程序</span></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  jenkins</span><br><span class="line">------------ </span><br><span class="line">[root@jenkins ~]# rm -rf /usr/share/tomcat/webapps/jenkins*</span><br><span class="line">[root@jenkins ~]# cd /etc/tomcat/</span><br><span class="line">[root@jenkins tomcat]# vim tomcat-users.xml</span><br><span class="line">&lt;role rolename="manager-script"/&gt; </span><br><span class="line">&lt;user name="admin" password="admin" roles="manager-script" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash">  我们要将maven上构建的结果在 jenkins上的tomcat上运行，所以需要这里打开manager-script功能。</span></span><br><span class="line">[root@jenkins tomcat]# systemctl restart tomcat</span><br><span class="line">[root@jenkins tomcat]# ss -tln</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  maven</span><br><span class="line">------------</span><br><span class="line">选择系统管理中的管理插件，在可选插件中选择安装Deploy to container，选择安装完成后重启Jenkins。进入spring-boot-web-jsp项目中，点击配置，选择构建后操作中的Deploy war/ear to a container，这是刚安装的插件，WAR/EAR files输入**target/*.war，（**表示任意个路径下的target目录中的.war文件。也可以写为**/*.war或*.war）。Context path可以不改，使用默认，这里使用/test-spring（这是部署到node1的tomcat上的目录的名称）。Containers选择Tomcat7.*，用户名和密码就是上面配置的manager-script的用户名和密码，输入两次tomcat。Tomcat URL输入http://IP:8080/，这是tomcat的访问路径。如果要构建多个tomcat，可以再添加Add Container就可以了。最后保存。</span><br><span class="line">点击项目中的立即构建。构建中出了问题，一直提示没有权限部署。因为node1上没有安装tomcat-admin-webapps</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  jenkins</span><br><span class="line">------------ </span><br><span class="line">[root@jenkins tomcat]# yum install -y tomcat-admin-webapps</span><br><span class="line">[root@jenkins tomcat]# ls webapps/</span><br><span class="line">host-manager  manager  test-spring  test-spring.war</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在此目录下有刚部署的<span class="built_in">test</span>-spring.war文件</span></span><br><span class="line"></span><br><span class="line">访问http://192.168.1.63:8080/test-spring/</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">  maven</span><br><span class="line">------------</span><br><span class="line">[root@maven .jenkins]# rm -rf workspace/spring-boot-web-jsp/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除代码，测试重新构建</span></span><br><span class="line">[root@maven .jenkins]# cd</span><br><span class="line">[root@maven ~]# ls</span><br><span class="line">anaconda-ks.cfg  netty-new.jar  spring-boot-web-jsp</span><br><span class="line">[root@maven ~]# vim spring-boot-web-jsp/src/main/resources/application.properties</span><br><span class="line">spring.mvc.view.prefix: /WEB-INF/jsp/</span><br><span class="line">spring.mvc.view.suffix: .jsp</span><br><span class="line"></span><br><span class="line">welcome.message: Hi Jenkins, Test.com, iunx.io.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改这个文件中的显示内容，再保存，这里修改了Test.com, iunx.io.</span></span><br><span class="line">[root@maven ~]# vim spring-boot-web-jsp/src/main/resources/static/css/main.css</span><br><span class="line">h1&#123;</span><br><span class="line">        color:#FFFF00;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">h2&#123;</span><br><span class="line">        color:#0000FF;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改颜色</span></span><br><span class="line">cd spring-boot-web-jsp</span><br><span class="line">git add .</span><br><span class="line">git commit -m "version 4.2.0"</span><br><span class="line">git push </span><br><span class="line">点击自动构建</span><br><span class="line">如果是灰度发布，可以使用脚本，脚本可实现将指定文件发送到服务器并部署</span><br><span class="line">回滚到之前的版本，可以在构建时指定构建的版本就可以了，使用git克隆时就克隆指定的版本就可以了。</span><br><span class="line">在ganneral最上方的一栏中可以选择参数化构建过程。</span><br><span class="line">参考：blog.ramanshalupau.com/parameterized-jenkins-build-for-rollback-purposes，实现滚动发布与回滚</span><br></pre></td></tr></table></figure>
<h2 id="Jenkins-amp-Gitlab"><a href="#Jenkins-amp-Gitlab" class="headerlink" title="Jenkins&amp;Gitlab"></a>Jenkins&amp;Gitlab</h2><h3 id="Jenkins依赖环境准备"><a href="#Jenkins依赖环境准备" class="headerlink" title="Jenkins依赖环境准备"></a>Jenkins依赖环境准备</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">* 安装java环境</span><br><span class="line">[root@jenkins ~]# ll</span><br><span class="line">total 83356</span><br><span class="line">-rw-------. 1 root root     1292 Oct 24 05:42 anaconda-ks.cfg</span><br><span class="line">-rwxr-xr-x  1 root root  9621331 Feb  1 12:51 apache-tomcat-8.5.33.tar.gz</span><br><span class="line">-rwxr-xr-x  1 root root 75728164 Feb  1 12:51 jenkins.war</span><br><span class="line">[root@jenkins ~]# yum install -y java-1.8.0-openjdk-devel</span><br><span class="line">[root@jenkins ~]# vim /etc/profile.d/java.sh</span><br><span class="line">	export JAVA_HOME=/usr</span><br><span class="line">[root@jenkins ~]# . /etc/profile.d/java.sh</span><br><span class="line">[root@jenkins ~]# java -version</span><br><span class="line">openjdk version "1.8.0_181"</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_181-b13)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)</span><br><span class="line"></span><br><span class="line">* tomcat环境</span><br><span class="line">[root@jenkins ~]# tar xf apache-tomcat-8.5.33.tar.gz -C /usr/local/</span><br><span class="line">[root@jenkins ~]# cd /usr/local/</span><br><span class="line">[root@jenkins local]# ln -sv apache-tomcat-8.5.33/ tomcat</span><br><span class="line">'tomcat' -&gt; 'apache-tomcat-8.5.33/'</span><br><span class="line">[root@jenkins local]# cp /root/jenkins.war tomcat/webapps/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上传Jenkins.war文件到tomcat服务器，放入webapps目录中</span></span><br><span class="line">[root@jenkins tomcat]# vim /usr/local/tomcat/conf/tomcat-users.xml</span><br><span class="line">      &lt;role rolename="manager-gui"/&gt;</span><br><span class="line">      &lt;role rolename="manager-script"/&gt;</span><br><span class="line">      &lt;role rolename="manager-jmx"/&gt;</span><br><span class="line">      &lt;role rolename="manager-status"/&gt;</span><br><span class="line">      &lt;user username="tomcat_user" password="tomcat" roles="manager-gui,manager-script,manager-jmx,manager-status"/&gt;</span><br><span class="line">[root@jenkins tomcat]# vim /usr/local/tomcat/conf/server.xml</span><br><span class="line">    &lt;Connector port="8080" protocol="HTTP/1.1"</span><br><span class="line">               connectionTimeout="20000"</span><br><span class="line">               redirectPort="8443" URIEncoding="UTF-8" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入URIEncoding=<span class="string">"UTF-8"</span>地址的编码解码字符集</span></span><br><span class="line">[root@jenkins local]# vim /usr/local/tomcat/bin/catalina.sh</span><br><span class="line">    JAVA_OPTS="-Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调整tomcat使用jvm内存</span></span><br><span class="line">[root@jenkins tomcat]# /usr/local/tomcat/bin/startup.sh</span><br><span class="line">[root@jenkins tomcat]# tail -f /usr/local/tomcat/logs/catalina.out</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看启动过程</span></span><br><span class="line">[root@jenkins local]# ps aux|grep tomcat</span><br><span class="line">root       3101 33.7 38.4 3704844 717556 pts/0  Sl   13:02   0:17 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.awt.headless=true -Xms1024m -Xmx1024m -XX:MaxNewSize=512m -XX:MaxPermSize=512m -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line">[root@jenkins tomcat]# cat /root/.jenkins/secrets/initialAdminPassword </span><br><span class="line">2296380bbe5e4753bc970240aca8ae2d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是打开jenkins页面时要输入的密码，这也是Jenkins的admin管理员的登录密码</span></span><br><span class="line"></span><br><span class="line">* 安装git</span><br><span class="line">[root@jenkins ~]# yum install -y git</span><br></pre></td></tr></table></figure>
<ul>
<li>下面访问10.5.5.250:8080/jenkins</li>
</ul>
<p><img src="/images/jenkins/jenkins1.jpg" alt=""></p>
<ul>
<li>选择安装推荐的插件。如果有软件安装失败，可在安装完后点Retry，再次安装。安装成功进入jenkins后，还要重启一次jenkins服务才能正常访问</li>
</ul>
<p><img src="/images/jenkins/jenkins2.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkins3.jpg" alt=""></p>
<ul>
<li>创建用户，或使用admin用户登录</li>
</ul>
<p><img src="/images/jenkins/jenkins4.jpg" alt=""></p>
<ul>
<li>确认</li>
</ul>
<p><img src="/images/jenkins/jenkins5.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkins6.jpg" alt=""></p>
<ul>
<li>完成上述步骤后可以正常登录，但测试发现chrome浏览器访问时显示空白页面，使用firefox浏览器没有问题</li>
</ul>
<p><img src="/images/jenkins/jenkins7.jpg" alt=""></p>
<ul>
<li>更换火狐浏览器后可以到登录页面，但输入用户名和密码后还是空白页面。解决方法如下：</li>
</ul>
<p><img src="/images/jenkins/jenkins8.jpg" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins tomcat]# tail -f /var/log/messages </span><br><span class="line">Oct 21 22:30:35 jenkins systemd: Stopped IPv4 firewall with iptables.</span><br><span class="line">Oct 21 22:30:35 jenkins systemd: Unit iptables.service entered failed state.</span><br><span class="line">Oct 21 22:30:35 jenkins systemd: iptables.service failed.</span><br><span class="line">Oct 21 22:43:01 jenkins systemd: Started Session 4057 of user root.</span><br><span class="line">Oct 21 22:43:01 jenkins systemd: Starting Session 4057 of user root.</span><br><span class="line">Oct 21 22:57:11 jenkins systemd: Stopping The Apache HTTP Server...</span><br><span class="line">Oct 21 22:57:13 jenkins systemd: Stopped The Apache HTTP Server.</span><br><span class="line">Oct 21 22:57:18 jenkins systemd: Reloading.</span><br><span class="line">Oct 21 22:57:18 jenkins systemd: [/usr/lib/systemd/system/vzfifo.service:19] Support for option SysVStartPriority= has been removed and it is ignored</span><br><span class="line">Oct 21 23:15:06 jenkins systemd: Configuration file /usr/lib/systemd/system/ebtables.service is marked executable. Please remove executable permission bits. Proceeding anyway.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统日志发现，要求取消/usr/lib/systemd/system/ebtables.service的可执行权限。</span></span><br><span class="line">[root@jenkins tomcat]# chmod 744 /usr/lib/systemd/system/ebtables.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 取消属组和其他人的执行权限</span></span><br><span class="line">[root@jenkins tomcat]# lsof -i:8080</span><br><span class="line">[root@jenkins tomcat]# kill -9 1181</span><br><span class="line">[root@jenkins tomcat]# /usr/local/tomcat/bin/startup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭tomcat并重新启动</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以正常访问了，使用chrome浏览器也没有问题了。但因为chrome浏览器的语言的繁体中文，所以Jenkins登录后也是繁体中文</li>
</ul>
<p><img src="/images/jenkins/jenkins9.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkins10.jpg" alt=""></p>
<h3 id="配置JDK和Maven并安装Deploy插件"><a href="#配置JDK和Maven并安装Deploy插件" class="headerlink" title="配置JDK和Maven并安装Deploy插件"></a>配置JDK和Maven并安装Deploy插件</h3><ul>
<li>登录Jenkins</li>
</ul>
<p><img src="/images/jenkins/jenkins配置1.jpg" alt=""></p>
<ul>
<li>选择全局安全配置</li>
</ul>
<p><img src="/images/jenkins/jenkins配置2.jpg" alt=""></p>
<ul>
<li>选择允许用户注册。授权策略可以先任何用户可以做任何事，方便测试使用。也可以是默认的登录用户可以做任何事。最后保存</li>
</ul>
<p><img src="/images/jenkins/jenkins配置3.jpg" alt=""></p>
<ul>
<li>选全局工具配置</li>
</ul>
<p><img src="/images/jenkins/jenkins配置4.jpg" alt=""></p>
<ul>
<li>上面两项都选择文件系统中的settings文件，之后需要输入maven的settings文件路径。JDK也一样要输入JAVA_HOME的路径，同时自定义一个别名。取消自动安装。下面的Git因为还没有，所以可以删除。Maven同JDK，需要自定义名称并输入MAVEN_HOME</li>
</ul>
<p><img src="/images/jenkins/jenkins配置5.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkins配置6.jpg" alt=""></p>
<ul>
<li>Maven的安装</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">到http://mirrors.shu.edu.cn/apache//maven/maven-3/3.5.4/binaries/下载Maven的二进制包，保存到/root目录下</span><br><span class="line">[root@jenkins ~]# tar xf apache-maven-3.5.4-bin.tar.gz -C /usr/local/</span><br><span class="line">[root@jenkins ~]# vim /etc/profile.d/maven.sh</span><br><span class="line">	export PATH=$PATH:/usr/local/apache-maven-3.5.4/bin</span><br><span class="line">	export MAVEN_HOME=/usr/local/apache-maven-3.5.4</span><br><span class="line">[root@jenkins ~]# . /etc/profile.d/maven.sh</span><br><span class="line">[root@jenkins ~]# mvn -version</span><br><span class="line">Apache Maven 3.5.4 (1edded0938998edf8bf061f1ceb3cfdeccf443fe; 2018-06-17T18:33:14Z)</span><br><span class="line">Maven home: /usr/local/apache-maven-3.5.4</span><br><span class="line">Java version: 1.8.0_181, vendor: Oracle Corporation, runtime: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.181-3.b13.el7_5.x86_64/jre</span><br><span class="line">Default locale: en_US, platform encoding: ANSI_X3.4-1968</span><br><span class="line">OS name: "linux", version: "4.15.17-1-pve", arch: "amd64", family: "unix"</span><br><span class="line">[root@jenkins local]# vim /usr/local/apache-maven-3.5.4/conf/settings.xml</span><br><span class="line">&lt;mirrors&gt;</span><br><span class="line">&lt;mirror&gt;</span><br><span class="line">       &lt;id&gt;nexus-osc&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus osc&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> mirrors段添加国内源地址。</span></span><br><span class="line">&lt;profile&gt;</span><br><span class="line">    &lt;id&gt;jdk-1.4&lt;/id&gt;</span><br><span class="line">    &lt;activation&gt;</span><br><span class="line">    &lt;jdk&gt;1.4&lt;/jdk&gt;</span><br><span class="line">    &lt;/activation&gt;</span><br><span class="line">    &lt;repositories&gt;</span><br><span class="line">        &lt;repository&gt;</span><br><span class="line">            &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;local private nexus&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">            &lt;releases&gt;</span><br><span class="line">                &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">            &lt;/releases&gt;</span><br><span class="line">            &lt;snapshots&gt;</span><br><span class="line">                &lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">            &lt;/snapshots&gt;</span><br><span class="line">        &lt;/repository&gt;</span><br><span class="line">    &lt;/repositories&gt;</span><br><span class="line">    &lt;pluginRepositories&gt;</span><br><span class="line">        &lt;pluginRepository&gt;</span><br><span class="line">            &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;local private nexus&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">            &lt;releases&gt;</span><br><span class="line">                &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">            &lt;/releases&gt;</span><br><span class="line">            &lt;snapshots&gt;</span><br><span class="line">                &lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">            &lt;/snapshots&gt;</span><br><span class="line">        &lt;/pluginRepository&gt;</span><br><span class="line">    &lt;/pluginRepositories&gt;</span><br><span class="line">&lt;/profile&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Maven 还需要安装一些插件包，这些插件包的下载地址也让其指向 oschina.net 的 Maven 地址。在&lt;profiles&gt;中插入</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一定要修改为国内源，不然构建速度将非常慢。尤其是在jenkins中</span></span><br></pre></td></tr></table></figure>
<ul>
<li>选择插件管理</li>
</ul>
<p><img src="/images/jenkins/jenkins配置7.jpg" alt=""></p>
<ul>
<li>安装插件deploy to container，这个插件是让jenkins成功构建后可以部署war包到tomcat的</li>
</ul>
<p><img src="/images/jenkins/jenkins配置8.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkins配置9.jpg" alt=""></p>
<h3 id="gitlab安装"><a href="#gitlab安装" class="headerlink" title="gitlab安装"></a>gitlab安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">下载gitlab-ce-10.6.1-ce.0.el7.x86_64.rpm到/root目录</span><br><span class="line">[root@localhost ~]# yum install -y gitlab-ce-10.6.1-ce.0.el7.x86_64.rpm</span><br><span class="line">[root@localhost ~]# vim /etc/gitlab/gitlab.rb</span><br><span class="line">	external_url 'http://10.5.5.199'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置服务地址</span></span><br><span class="line">[root@localhost ~]# gitlab-ctl reconfigure</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是一个初始化的过程</span></span><br><span class="line">访问IP，要求设置root密码，需要是一个复杂的密码，之后就可以正常登录了</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果访问出现502错误，可以查看是否之前安装并启动过web服务或tomcat服务，卸载服务并重启gitlab后就可以正常访问了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [root@gitlab ~]<span class="comment"># gitlab-ctl restart		# 重启gitlab命令</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 另外也可以查看一下内存是否不足</span></span><br></pre></td></tr></table></figure>
<h3 id="获取gitlab的token"><a href="#获取gitlab的token" class="headerlink" title="获取gitlab的token"></a>获取gitlab的token</h3><ul>
<li>使用root用户登录</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken1.jpg" alt=""></p>
<ul>
<li>选择左下角的settings，并勾选最下方的“Allow requests to the local network from hooks and services”并保存。此项非常关键，如果不勾选此项，之后测试连接jenkins时会报500错误</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken2.jpg" alt=""></p>
<ul>
<li>登出root用户，重新注册一个新用户</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken3.jpg" alt=""></p>
<ul>
<li>选择用户的settings，并选择左侧的”Access Tokens”</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken4.jpg" alt=""></p>
<ul>
<li>创建Token</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken5.jpg" alt=""></p>
<ul>
<li>得到一个Token，这个很重要，需要记录，如果关闭此页面，之后就找不到这个Token了</li>
</ul>
<p><img src="/images/jenkins/gitlabgetToken6.jpg" alt=""></p>
<h3 id="创建一个git项目"><a href="#创建一个git项目" class="headerlink" title="创建一个git项目"></a>创建一个git项目</h3><ul>
<li>使用普通用户登录，到首页创建项目</li>
</ul>
<p><img src="/images/jenkins/gitlab项目1.jpg" alt=""></p>
<p><img src="/images/jenkins/gitlab项目2.jpg" alt=""></p>
<ul>
<li>这两条命令在设置jenkins时有用</li>
</ul>
<p><img src="/images/jenkins/gitlab项目3.jpg" alt=""></p>
<h3 id="生成访问Gitlab的ssh秘钥。"><a href="#生成访问Gitlab的ssh秘钥。" class="headerlink" title="生成访问Gitlab的ssh秘钥。"></a>生成访问Gitlab的ssh秘钥。</h3><blockquote>
<p> <strong>从gitlab以SSH方式拉取或提交代码需要用到这个SSH 秘钥</strong>，哪台机器需要从gitlab上拉取代码，就在哪台机器上生成一次SSH Key，因此，在jenkins服务器上，以及你的开发PC上，都需要生成SSH密钥。</p>
</blockquote>
<p><img src="/images/jenkins/gitlabssh1.jpg" alt=""></p>
<ul>
<li>在jenkins与要部署代码的服务器上执行生成秘钥的命令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins conf]# ssh-keygen -t rsa -P ''</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Created directory '/root/.ssh'.</span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">69:1e:73:2b:de:c8:e8:23:79:9a:0a:96:6f:e8:8a:b8 root@jenkins</span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|                 |</span><br><span class="line">|                 |</span><br><span class="line">|                 |</span><br><span class="line">|         .       |</span><br><span class="line">|        S .      |</span><br><span class="line">|  .    o + .     |</span><br><span class="line">|.o.  .  o .      |</span><br><span class="line">|+o..o.o+ +       |</span><br><span class="line">|Eoooo=o.+ .      |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@jenkins conf]# cat /root/.ssh/id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDZS8mV9dyi2kOCnhe3o5V/bc8EEln6cVpNXQ16P4lKvAYSdcmrRTYdWapsssJAzjWnA5Pa/u32n/OWKTZDq+qmV3IxlQwuOVI7AeB5TJTuawk90f/1fj7aN1963yOvlZthS8dRUvEcrq+HHpekmAH+mLDeQGYcZEoNsovl1Cvp3TVNDC/7sKds7yoYmHupknyn5d7tgGID8Up02DJlgUQK6V7ZvivjRxAaYAjsWSEktIZK0jv0uWqo6cSddC/rLERGL4spjdwqErFKDQ8SVhArD5zR7L5Lpf9McbxFLFpMMN0I2U+udCXa8n7vwbzHTyaFU+ZvUkX80ykDpMJIW5ot root@jenkins</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将此公钥放入gitlab中</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/jenkins/gitlabssh2.jpg" alt=""></p>
<p><img src="/images/jenkins/gitlabssh3.jpg" alt=""></p>
<h3 id="jenkins中安装gitlab插件"><a href="#jenkins中安装gitlab插件" class="headerlink" title="jenkins中安装gitlab插件"></a>jenkins中安装gitlab插件</h3><blockquote>
<p>需要的插件：</p>
<ul>
<li>GitLab Hook：使 gitlab web 挂钩能够用于触发 gitlab 项目上的 smc 轮询</li>
<li>GitLab：这个插件允许 gitlab 触发 jenkins 构建, 并在 gitlab ui 中显示它们的结果。</li>
<li>Gitlab Authentication：这是使用 gitlab oauth 的身份验证插件。</li>
<li>Git Parameter：增加了从项目中配置的 git 存储库中选择分支、标记或修订的功能。</li>
<li>Build Authorization Token Root：即使匿名用户看不到 jenkins, 也可以访问生成和相关的 rest 生成触发器</li>
<li>Publish Over SSH：通过 ssh 发送生成项目</li>
</ul>
</blockquote>
<p><img src="/images/jenkins/gitlabPlugin1.jpg" alt=""></p>
<p><img src="/images/jenkins/gitlabPlugin2.jpg" alt=""></p>
<p><img src="/images/jenkins/gitlabPlugin3.jpg" alt=""></p>
<h3 id="jenkins中设置token"><a href="#jenkins中设置token" class="headerlink" title="jenkins中设置token"></a>jenkins中设置token</h3><blockquote>
<p>jenkins可以通过从gitlab上得到的token，与gitlab协同工作</p>
</blockquote>
<p><img src="/images/jenkins/jenkinsgitlabtoken1.jpg" alt=""></p>
<p><img src="/images/jenkins/jenkinsgitlabtoken2.jpg" alt=""></p>
<ul>
<li><p>Connection name可以自定义；Gitlab host URL是gitlab的访问地址；最后设置Credentials</p>
<p><img src="/images/jenkins/jenkinsgitlabtoken3.jpg" alt=""></p>
</li>
<li><p>在弹出的窗口中选择类型为GitLab API token，之后输入在gitlab中取得的项目的token，最后添加</p>
</li>
</ul>
<p><img src="/images/jenkins/jenkinsgitlabtoken4.jpg" alt=""></p>
<ul>
<li>选择刚创建的”GitLab API token”，然后点击”Test Connection”测试是否连接正常，如果没有问题就保存。这里的配置会在创建任务后的第一个General页面的”GitLab Connection”中自动引用</li>
</ul>
<p><img src="/images/jenkins/jenkinsgitlabtoken5.jpg" alt=""></p>
<h3 id="jenkins中设置Publish-over-SSH"><a href="#jenkins中设置Publish-over-SSH" class="headerlink" title="jenkins中设置Publish over SSH"></a>jenkins中设置Publish over SSH</h3><ul>
<li>进入设置</li>
</ul>
<p><img src="/images/jenkins/jenkinsSSH1.jpg" alt=""></p>
<ul>
<li>输入jenkins服务器的私钥，也就是用户家目录中.ssh中的id_rsa文件的内容（这是为了可以通过jenkins的公钥与私钥进行配对，使jenkins可以在远程主机上操作，当然也需要jenkins将公钥传到远程主机），SSH Servers中设置自定义Name，Hostname是要部署代码的服务器地址，Username是登录用的用户名，Remote Directory这里设置为了/usr/share/nginx/html，之后jenkins就可以向这个目录部署网页文件了</li>
</ul>
<p><img src="/images/jenkins/jenkinsSSH2.jpg" alt=""></p>
<h3 id="配置git插件"><a href="#配置git插件" class="headerlink" title="配置git插件"></a>配置git插件</h3><ul>
<li>打开系统管理中的系统设置</li>
</ul>
<p><img src="/images/jenkins/git插件1.jpg" alt=""></p>
<ul>
<li>选择Git plugin</li>
</ul>
<p><img src="/images/jenkins/git插件2.jpg" alt=""></p>
<ul>
<li>设置Git插件的全局配置，然后点击“apply”——“save”。全局配置就是上面“Gitlab创建项目”部分中的global setting ，也就是git的用户名和邮箱地址。在项目第一次commit前，这些信息都可以在GitLab的项目的首页里找到</li>
</ul>
<p><img src="/images/jenkins/git插件3.jpg" alt=""></p>
<h3 id="创建一个Jenkins-Job"><a href="#创建一个Jenkins-Job" class="headerlink" title="创建一个Jenkins Job"></a>创建一个Jenkins Job</h3><blockquote>
<p>在jenkins里，一个任务叫做一个job。一般我们的项目会有多个分支，比如开发分支和产品分支，我们可以对每一个分支都新建一个job，比如，我们对开发分支创建一个测试的job，每次有代码提交就自动运行一次测试，对产品分支创建一个打包的job，每次有代码提交就运行打包任务。</p>
<p>在系统设置中设置的项就是为了可以在任务中得到引用。</p>
</blockquote>
<p><img src="/images/jenkins/创建jenkinsjob1.jpg" alt=""></p>
<ul>
<li>创建的job最好与gitlab中的项目名一致</li>
</ul>
<p><img src="/images/jenkins/创建jenkinsjob2.jpg" alt=""></p>
<h3 id="配置Job"><a href="#配置Job" class="headerlink" title="配置Job"></a>配置Job</h3><ul>
<li>在源码管理里，选择Git，并输入路径，路径可以在gitlab的项目首页上看到</li>
</ul>
<p><img src="/images/jenkins/配置job1.jpg" alt=""></p>
<ul>
<li>添加用户，类型选“SSH Username with private key”；Username填root；选择PrivateKey中的Enter directly，在下面的key中输入jenkins服务器的私钥，可以用命令<code>cat /root/.ssh/id_rsa</code>查看。也里是指使用jenkins服务器上root用户的私钥访问gitlab上的项目，与gitlab上的jenkins服务器的root用户的公钥进行验证。</li>
</ul>
<p><img src="/images/jenkins/配置job2.jpg" alt=""></p>
<blockquote>
<p>在Repository URL下面的红字提示“Failed to connect to repository : Error performing command: git ls-remote -h <a href="mailto:git@10.5.5.11" target="_blank" rel="noopener">git@10.5.5.11</a>:test/ccjdtest.git HEAD”是因为jenkins服务器上没有安装git，安装后解决。</p>
</blockquote>
<p><img src="/images/jenkins/配置job3.jpg" alt=""></p>
<blockquote>
<p>jenkins job默认对master分支进行构建，你也可以自定义分支。这要求你的Gitlab代码仓库中要存在这个分支，一般来说，就是要向代码仓库提交一次更改，请 <strong>自行完成</strong>（Gitlab项目刚创建时是空的，一个分支也没有，这样的话，自动构建时会出错）</p>
</blockquote>
<p><img src="/images/jenkins/配置job4.jpg" alt=""></p>
<ul>
<li>配置构建触发器，选择Build一行，后面的地址就是jenkins上放项目的路径，再选择下面的高级</li>
</ul>
<p><img src="/images/jenkins/配置job5.jpg" alt=""></p>
<ul>
<li>选择Filter branches by regex，表示要触发自动部署的分支，在下面的Target Branch Regex中输入”.*master”，这是正则表达式，表示分支名。最后点击Generate，生成gitlab webhook的安全令牌，在配置gitlab时有用。</li>
</ul>
<p><img src="/images/jenkins/配置job6.jpg" alt=""></p>
<ul>
<li>构建，选择新增中的send files or … over SSH</li>
</ul>
<p><img src="/images/jenkins/配置job7.jpg" alt=""></p>
<ul>
<li>这里的Name中会有在Jenkins的设置中设置的Publish over SSH的服务器名字，下面的Source files中输入“**/**”，Remote directory中要部署到远程服务器的路径，Exec command是在远程服务器部署完代码后要执行的命令</li>
</ul>
<h3 id="gitlab上设置webhook"><a href="#gitlab上设置webhook" class="headerlink" title="gitlab上设置webhook"></a>gitlab上设置webhook</h3><ul>
<li>到gitlab的项目中设置集成</li>
</ul>
<p><img src="/images/jenkins/webhook1.jpg" alt=""></p>
<ul>
<li>URL与Secret Token都是在Jenkins中的项目配置中取得的，取消SSL的勾选，最后添加</li>
</ul>
<p><img src="/images/jenkins/webhook2.jpg" alt=""></p>
<ul>
<li>添加后在下面的Webhooks中就会有添加的项，点Test中的Push events测试。这里一定要在gitlab的项目中有一个文件，如果没有，测试时会提示“Hook execution failed: Ensure the project has at least one commit.”。可以在gitlab项目中创建一个README文件</li>
</ul>
<p><img src="/images/jenkins/webhook3.jpg" alt=""></p>
<ul>
<li>如果测试正常，在页面最上方会有HTTP 200的提示</li>
</ul>
<p><img src="/images/jenkins/webhook4.jpg" alt=""></p>
<ul>
<li>webhook就是为了在有人上传代码时，就会触发上面设置的地址，只要触发这个地址，jenkins就会自动部署</li>
</ul>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><ul>
<li>到要部署代码的服务器上，安装nginx。</li>
<li>到jenkins服务器上安装git，准备拉取代码</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-------------</span><br><span class="line">  jenkins</span><br><span class="line">-------------</span><br><span class="line">ssh-copy-id -i /root/.ssh/id_rsa.pub 10.5.5.22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 要与部署代码的服务器实现密钥通讯</span></span><br><span class="line">git clone git@10.5.5.11:test/ccjdtest.git</span><br><span class="line">cd ccjdtest/</span><br><span class="line">echo "test Jenkins" &gt; index.html</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个文件</span></span><br><span class="line">git config --global user.email "test@ccjd.com"</span><br><span class="line">git config --global user.name "test"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这两项是在gitlab中创建项目时设置的</span></span><br><span class="line">git add .</span><br><span class="line">git commit -m 'add index.html'</span><br><span class="line">git push</span><br><span class="line"><span class="meta">#</span><span class="bash"> 推送到gitlab服务器</span></span><br></pre></td></tr></table></figure>
<ul>
<li>到jenkins中查看项目情况，如果配置正确，推送代码到gitlab后，这里会有提示</li>
</ul>
<p><img src="/images/jenkins/测试1.jpg" alt=""></p>
<ul>
<li>到部署代码的服务器上查看，index.html文件已放入了/usr/share/nginx/html目录中，并且服务已重新启动。访问页面变成了我们设置的内容。</li>
</ul>
<h3 id="测试maven手动部署"><a href="#测试maven手动部署" class="headerlink" title="测试maven手动部署"></a>测试maven手动部署</h3><h4 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h4><ol>
<li>注册gitlab帐号</li>
<li>创建git项目</li>
<li>将上传代码的主机、Jenkins服务器、与部署代码的服务器的公钥上传到gitlab</li>
<li>将项目clone到本地</li>
<li>将本地代码push到gitlab</li>
<li>在Jenkins中创建Job</li>
<li>设置Job中的git地址，Jenkins登录git的用户名与私钥。新建构建“调用顶层Maven目标”</li>
<li>第一次构建，要到Job中点击“立即构建”</li>
<li>构建后操作</li>
</ol>
<h4 id="设置Job"><a href="#设置Job" class="headerlink" title="设置Job"></a>设置Job</h4><ul>
<li>设置Job，输入git地址，设置jenkins服务器登录gitlib时用的用户名与私钥，这样私钥与jenkins上传到gitlab上的公钥就可以配对了</li>
</ul>
<p><img src="/images/jenkins/设置job1.jpg" alt=""></p>
<ul>
<li>设置构建，选择调用顶层Maven目标</li>
</ul>
<p><img src="/images/jenkins/设置job2.jpg" alt=""></p>
<ul>
<li>Maven版本是在jenkins设置中设置好的，目标是一条Maven命令：“clean install -Dmaven.test.skip=true”</li>
</ul>
<p><img src="/images/jenkins/设置job3.jpg" alt=""></p>
<ul>
<li>设置构建后操作。WAR/EAR files是一个相对路径，相对/root/.jenkins/workspace/echarging/而言，echarging是项目的名称，项目下的target中有war文件，这里输入c-rest/target表示在项目目录下还有一层。Context path是访问的名称，之后就可以使用IP:8080/rest访问了。再选择下面的Containers为Tomcat8.x，这要根据实际情况选择，然后添加一个可以访问tomcat的manager_webapp页面的用户名和密码，这是在部署代码的tomcat中设置的。下面就是Tomcat的访问地址。都输入正确后保存即可。这样，在Maven处理完代码后，就会自动部署到部署代码的tomcat服务器上了。</li>
</ul>
<p><img src="/images/jenkins/设置job4.jpg" alt=""></p>
<ul>
<li>在部署代码的服务器上设置tomcat</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon local]# yum install -y java-1.8.0-openjdk-devel</span><br><span class="line">[root@bogon ~]# vim /etc/profile.d/java.sh</span><br><span class="line">	export JAVA_HOME=/usr</span><br><span class="line">[root@bogon tomcat]# vim /usr/local/tomcat/conf/tomcat-users.xml</span><br><span class="line">      &lt;role rolename="manager-gui"/&gt;</span><br><span class="line">      &lt;role rolename="manager-script"/&gt;</span><br><span class="line">      &lt;role rolename="manager-jmx"/&gt;</span><br><span class="line">      &lt;role rolename="manager-status"/&gt;</span><br><span class="line">      &lt;user username="tomcat_user" password="tomcat" roles="manager-gui,manager-script,manager-jmx,manager-status"/&gt;</span><br><span class="line">[root@bogon tomcat]# vim webapps/manager/META-INF/context.xml</span><br><span class="line">	&lt;Context antiResourceLocking="false" privileged="true" &gt;</span><br><span class="line">  &lt;Valve className="org.apache.catalina.valves.RemoteAddrValve"</span><br><span class="line">         allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10.5.5.90|10.5.5.9" /&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里加入两个地址，一个是本地的地址，为了测试页面是否可以打开。一个是jenkins的地址。如果不加jenkins的地址，jenkins的部署会报错。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>到Job中，点击立即构建</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-------------</span><br><span class="line">  jenkins</span><br><span class="line">-------------</span><br><span class="line">1. 全局安全设置，可以用户注册</span><br><span class="line">2. 系统设置中设置maven和java的家目录</span><br><span class="line">3. 安装deploy to container及gitlib相关插件</span><br><span class="line">4. jenkins中设置token，使jenkins与gitlab可以联合工作</span><br><span class="line">5. 配置publish over ssh，使jenkins可以使用ssh方法发送文件到远程服务器，或在远程服务器上执行命令。当然还需要将jenkins的公钥传输到远程主机</span><br><span class="line">6. 配置git，使用jenkins可以到远程的gitlab上进行验证</span><br><span class="line">7. 配置JOB</span><br><span class="line">7.1 源码管理中使用git，创建一个带有jenkins服务器上私钥的用户名，让jenkins可以使用私钥与github上的jenkins的公钥配对。让gitlab可以将代码推送到jenkins。</span><br><span class="line">7.2 构建触发器选择Build when a change is pushed to GitLab. (当更改推送到 gitlab 时生成。)，这是为了让gitlab可以向jenkins发送POST请求的。之后设置自动触发的分支，生成一个webhook安全令牌。</span><br><span class="line">7.3 构建，选择Send files or execute commands over SSH，也就是在构建期间通过ssh作为构建步骤发送文件或执行命令的方法，之后可以设置要部署的服务器，这个服务器是在publish over ssh中设置好的某台服务器，还可以设置代码的源路径，要部署的远程服务器的路径，要在远程服务器上执行的命令等。</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">  gitlab</span><br><span class="line">-----------</span><br><span class="line">1. 生成token，给jenkins使用</span><br><span class="line">2. 为某个项目设置webhook。设置jenkins的URL与jenkins中生成的webhook安全令牌，使gitlab知道如何通知jenkins</span><br><span class="line">3. 当项目中的代码发生变化时，gitlab会将代码推送到jenkins主机进行部署</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/19/RabbitMQ基本命令与配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/19/RabbitMQ基本命令与配置/" itemprop="url">
                  RabbitMQ基本命令与配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-19 09:19:56 / 修改時間：13:46:31" itemprop="dateCreated datePublished" datetime="2018-10-19T09:19:56+08:00">2018-10-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/消息队列/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><h5 id="rabbitmq-server命令"><a href="#rabbitmq-server命令" class="headerlink" title="rabbitmq server命令"></a>rabbitmq server命令</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">systemctl start rabbitmq-server</span><br><span class="line">systemctl stop rabbitmq-server</span><br><span class="line">systemctl status rabbitmq-server</span><br><span class="line">systemctl rotate-logs rabbitmq-server</span><br><span class="line">systemctl restart rabbitmq-server</span><br><span class="line">systemctl condrestart rabbitmq-server</span><br><span class="line">systemctl try-restart rabbitmq-server</span><br><span class="line">systemctl reload rabbitmq-server</span><br><span class="line">systemctl force-reload rabbitmq-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> rabbitmq默认监听5672端口，网页管理页面监听15672端口</span></span><br></pre></td></tr></table></figure>
<h5 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">** 开启插件</span><br><span class="line">rabbitmq-plugins enable 插件名</span><br><span class="line">** 关闭插件</span><br><span class="line">rabbitmq-plugins disable 插件名</span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启rabbitmq web管理页面插件</span></span><br></pre></td></tr></table></figure>
<h5 id="rabbitmqctl命令"><a href="#rabbitmqctl命令" class="headerlink" title="rabbitmqctl命令"></a>rabbitmqctl命令</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">* 创建用户，设置密码</span><br><span class="line">rabbitmqctl add_user username password</span><br><span class="line"></span><br><span class="line">* 分配用户标签-设置为管理用户。默认用户名密码为guest</span><br><span class="line">rabbitmqctl set_user_tags username tag</span><br><span class="line"><span class="meta">#</span><span class="bash"> Tag可以为：administrator,monitoring, management等</span></span><br><span class="line"></span><br><span class="line">* 查看现有用户信息</span><br><span class="line">rabbitmqctl list_users</span><br><span class="line"></span><br><span class="line">* 删除用户</span><br><span class="line">rabbitmqctl delete_user username</span><br><span class="line"></span><br><span class="line">* 修改用户密码</span><br><span class="line">rabbitmqctl change_password username password</span><br><span class="line"></span><br><span class="line">* 查看所有队列消息</span><br><span class="line">rabbitmqctl list_queues</span><br><span class="line"></span><br><span class="line">* 清除所有队列</span><br><span class="line">rabbitmqctl reset</span><br><span class="line"></span><br><span class="line">* 新建虚拟机</span><br><span class="line">rabbitmqctl add_vhost  虚拟机名</span><br><span class="line"></span><br><span class="line">* 撤销虚拟机</span><br><span class="line">rabbitmqctl delete_vhost 虚拟机名</span><br><span class="line"></span><br><span class="line">* 服务器状态</span><br><span class="line">rabbitmqctl status</span><br></pre></td></tr></table></figure>
<h5 id="防火墙设置"><a href="#防火墙设置" class="headerlink" title="防火墙设置"></a>防火墙设置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 15672 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 25672 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 5672 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 4369 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 5671 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h4 id="rabbitmq配置"><a href="#rabbitmq配置" class="headerlink" title="rabbitmq配置"></a>rabbitmq配置</h4><h5 id="RabbitMQ支持三种配置方式："><a href="#RabbitMQ支持三种配置方式：" class="headerlink" title="RabbitMQ支持三种配置方式："></a><strong>RabbitMQ支持三种配置方式：</strong></h5><ul>
<li>读取环境变量中配置， 这包括shell中环境变量和rabbitmq-env.conf/rabbitmq-env-conf.bat文件中配置的环境变量</li>
</ul>
<p>&emsp;&emsp;可配置如端口、配置文件指定自定义位置、节点名字等信息。</p>
<ul>
<li>读取配置文件rabbitmq.config</li>
</ul>
<p>&emsp;&emsp;可配置权限、集群、插件设置等高级信息， 当然也可配置端口等简单信息</p>
<ul>
<li>通过运行命令时指定参数</li>
</ul>
<p>&emsp;&emsp;通常用来配置集群范围信息， 用来运行时动态传入</p>
<h5 id="环境变量读取优先级"><a href="#环境变量读取优先级" class="headerlink" title="环境变量读取优先级"></a><strong>环境变量读取优先级</strong></h5><ul>
<li><p>读取shell中环境变量</p>
</li>
<li><p>读取rabbitmq-env.conf/rabbitmq-env-conf.bat中的</p>
</li>
<li><p>读取默认的</p>
</li>
</ul>
<h5 id="rabbitmq-env-conf-rabbitmq-env-conf-bat-详解（颜色标注的为常用配置）"><a href="#rabbitmq-env-conf-rabbitmq-env-conf-bat-详解（颜色标注的为常用配置）" class="headerlink" title="rabbitmq-env.conf/rabbitmq-env-conf.bat 详解（颜色标注的为常用配置）"></a><strong>rabbitmq-env.conf/rabbitmq-env-conf.bat 详解（颜色标注的为常用配置）</strong></h5><table>
<thead>
<tr>
<th style="text-align:left">变量名称</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">RABBITMQ_NODE_IP_ADDRESS</td>
<td>默认为空字符串， 即绑定所有网络接口</td>
<td>如果想绑定到一个固定的IP可以使用此变量. 如果要绑定到两个或两个以上只能通过rabbitmq.config中的tcp_listeners来设置。</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_NODE_PORT</td>
<td>5672</td>
<td>供客户端建立连接端口</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_DIST_PORT</td>
<td>RABBITMQ_NODE_PORT + 20000</td>
<td>用于节点和CLI工具连接的端口， 如果rabbitmq.config中配置了kernel.inet_dist_listen_min 或 kernel.inet_dist_listen_max该参数将被忽略</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_NODENAME</td>
<td>Unix*: rabbit@$HOSTNAMEWindows: rabbit@%COMPUTERNAME%</td>
<td>节点名字， 必须唯一</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_CONF_ENV_FILE</td>
<td>Generic UNIX - $RABBITMQ_HOME/etc/rabbitmq/Debian - /etc/rabbitmq/RPM - /etc/rabbitmq/Mac OS X (Homebrew) - ${install_prefix}/etc/rabbitmq/, the Homebrew prefix is usually /usr/localWindows - %APPDATA%\RabbitMQ\</td>
<td>rabbitmq-env.conf/rabbitmq-env-conf.bat 默认位置， 不同系统不同安装方式位置也不同， 如果默认位置没找到则需在该位置手动创建一个</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_CONFIG_FILE</td>
<td>同上</td>
<td>rabbitmq.config 默认位置。 如果默认位置没找到则需在该位置手动创建一个</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_USE_LONGNAME</td>
<td>官网没说。。。。应该是false。。。</td>
<td>取值： true 或 false。  如果配置为true， 这将导致RabbitMQ使用完全限定的名称来标识节点</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_SERVICENAME</td>
<td>Windows Service: RabbitMQ</td>
<td>服务名称</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_CONSOLE_LOG</td>
<td>只在控制台输出日志， 日志不会持久化到文件</td>
<td>取值： new 或 reuse。两种取值都是将控制台输出从服务器重定向到名为%rabbitmqservicename%（上面那个变量）的文件。　　1）默认： 不设置， 控制台的日志不会被持久化到文件　　2）new： 每次启动时都会创建一个新的文件　　3）reuse： 每次启动服务器都会重用该日志文件</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_CTL_ERL_ARGS</td>
<td>None</td>
<td>在调用rabbitmqctl时使用的erl命令的参数。应该仅用于调试目的。</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_SERVER_ERL_ARGS</td>
<td>Unix*:”+K true +A30 +P 1048576 -kernel inet_default_connect_options [{nodelay,true}]”Windows: None</td>
<td>在调用RabbitMQ服务器时使用的erl命令的标准参数， 应该仅用于调试目的</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS</td>
<td>Unix*: NoneWindows: None</td>
<td>在调用RabbitMQ服务器时使用的erl命令的附加参数。这个变量的值被附加到参数的默认列表(RABBITMQ_SERVER_ERL_ARGS).</td>
</tr>
<tr>
<td style="text-align:left">RABBITMQ_SERVER_START_ARGS</td>
<td>None</td>
<td>在调用RabbitMQ服务器时使用的erl命令的额外参数。这不会覆盖RABBITMQ_SERVER_ERL_ARGS.</td>
</tr>
<tr>
<td style="text-align:left">HOSTNAME</td>
<td>Unix, Linux: <code>env hostname</code>MacOSX: <code>env hostname -s</code></td>
<td>当前机器名称</td>
</tr>
<tr>
<td style="text-align:left">COMPUTERNAME</td>
<td>Windows: localhost</td>
<td>当前机器名称， windows使用该变量</td>
</tr>
<tr>
<td style="text-align:left">ERLANG_SERVICE_MANAGER_PATH</td>
<td>Windows Service: %ERLANG_HOME%\erts-x.x.x\bin</td>
<td>erlsrv.exe的路径， erlsrv.exe这个是erlang服务的包装脚本</td>
</tr>
</tbody>
</table>
<h3 id=""><a href="#" class="headerlink" title=" "></a> </h3><h5 id="rabbitmq-config详解（核心配置）"><a href="#rabbitmq-config详解（核心配置）" class="headerlink" title="rabbitmq.config详解（核心配置）"></a><strong>rabbitmq.config详解（核心配置）</strong></h5><p>&emsp;&emsp;该配置文件使用的是Erlang标准配置文件，语法请参照<a href="http://erlang.org/doc/man/config.html" target="_blank" rel="noopener">这里</a></p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">例： </span><br><span class="line">  [</span><br><span class="line">    &#123;rabbit, [&#123;tcp_listeners, [<span class="number">5673</span>]&#125;]&#125;</span><br><span class="line">  ].</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>key</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>tcp_listeners</td>
<td>监听AMQP连接的端口或主机/对。 Default: [5672]</td>
</tr>
<tr>
<td>num_tcp_acceptors</td>
<td>Erlang进程的数量，接受TCP监听器的连接数。 Default: 10</td>
</tr>
<tr>
<td>handshake_timeout</td>
<td>对AMQP 0-8/0-9/0-9-1握手的最大时间(在套接字连接和SSL握手之后)，以毫秒为间隔 Default: 10000</td>
</tr>
<tr>
<td>ssl_listeners</td>
<td>如上所述，用于SSL连接。 Default: []</td>
</tr>
<tr>
<td>num_ssl_acceptors</td>
<td>用于接受SSL监听连接的Erlang进程的数量。 Default: 1</td>
</tr>
<tr>
<td>ssl_options</td>
<td>SSL配置参数. 详情请看 <a href="http://www.rabbitmq.com/ssl.html#enabling-ssl" target="_blank" rel="noopener">SSL documentation</a>.Default: []</td>
</tr>
<tr>
<td>ssl_handshake_timeout</td>
<td>SSL握手超时，以毫秒为间隔。 Default: 5000</td>
</tr>
<tr>
<td>vm_memory_high_watermark</td>
<td>触发流控制的内存阈值。详情请看 <a href="http://www.rabbitmq.com/memory.html" target="_blank" rel="noopener">memory-based flow control</a>.Default: 0.4</td>
</tr>
<tr>
<td>vm_memory_high_watermark_paging_ratio</td>
<td>设置当内存使用超过总内存百分比多少时，队列开始将消息持久化到磁盘以释放内存。 详情请看 <a href="http://www.rabbitmq.com/memory.html" target="_blank" rel="noopener">memory-based flow control</a>.Default: 0.5</td>
</tr>
<tr>
<td>disk_free_limit</td>
<td>RabbitMQ存储数据的分区的磁盘空间限制。当可用的磁盘空间低于这个限制时，就会触发流控制。值可以相对于RAM的总数设置(例如，内存比例，1.0)。该值也可以设置为整数的字节数。或者，单位(例如“50 mb”)。默认情况下，空闲磁盘空间必须超过50MB。详情请看 <a href="http://www.rabbitmq.com/disk-alarms.html" target="_blank" rel="noopener">Disk Alarms</a>.Default: 50000000</td>
</tr>
<tr>
<td>log_levels</td>
<td>控制日志的粒度。该值是一个日志事件类别和日志级别对的列表。 可设置级别：　　‘none’　　‘error’　　‘warning’　　‘info’ 　　‘debug’ 　　以上下一层级别的日志输出均包含上层级别日志输出（如： warning包含warning和error）, none为不输出日志 另外，当前未分类的事件总是记录在日志中The categories are:channel - 所有与AMQP通道有关的事件connection - 对于所有与网络连接有关的事件federation - 对于所有与<a href="http://www.rabbitmq.com/federation.html" target="_blank" rel="noopener">federation</a>有关的事件mirroring - 对于与镜像队列相关的所有事件Default: [{connection, info}]</td>
</tr>
<tr>
<td>frame_max</td>
<td>框架最大允许大小(以字节为单位)与消费者进行数据交换。设置为0意味着“无限”，但会在一些QPid客户端触发一个bug。设置更大的值可能会提高吞吐量;设置较小的值可能会提高延迟。Default: 131072</td>
</tr>
<tr>
<td>channel_max</td>
<td>与消费者进行谈判的最大允许数量。设置为0意味着“无限”。使用更多的通道会增加代理的内存占用。Default: 0</td>
</tr>
<tr>
<td>channel_operation_timeout</td>
<td>通道操作超时为毫秒(内部使用，由于消息传递协议的差异和限制而不直接暴露于客户机)。 Default: 15000</td>
</tr>
<tr>
<td>heartbeat</td>
<td>该值表示服务器在连接中发送的心跳延迟，在几秒钟内。优化框架。如果设置为0，则会禁用心跳。客户端可能不会遵循服务器的建议，请参阅AMQP参考以了解更多细节。在有大量连接的情况下，禁用心跳可能改善性能，但可能会导致连接在关闭非活动连接的网络设备的出现。Default: 60 (580 prior to release 3.5.5)</td>
</tr>
<tr>
<td>default_vhost</td>
<td>当RabbitMQ创建一个新的数据库时，创建一个虚拟主机。交换amq.rabbitmq.logwill存在于这个虚拟主机中。Default: &lt;&lt;”/“&gt;&gt;</td>
</tr>
<tr>
<td>default_user</td>
<td>当RabbitMQ从头创建一个新数据库时，要创建用户名。  Default: &lt;&lt;”guest”&gt;&gt;</td>
</tr>
<tr>
<td>default_pass</td>
<td>默认用户的密码。 Default: &lt;&lt;”guest”&gt;&gt;</td>
</tr>
<tr>
<td>default_user_tags</td>
<td>默认用户的标记。 Default: [administrator]</td>
</tr>
<tr>
<td>default_permissions</td>
<td>在创建时分配给默认用户的权限。 Default:  [&lt;&lt;”.<em>“&gt;&gt;, &lt;&lt;”.</em>“&gt;&gt;, &lt;&lt;”.*”&gt;&gt;]</td>
</tr>
<tr>
<td>loopback_users</td>
<td>只允许通过环回接口连接到代理的用户列表(即localhost)。 如果您希望允许缺省的来宾用户远程连接，则需要将其更改为 [].Default:  [&lt;&lt;”guest”&gt;&gt;]</td>
</tr>
<tr>
<td>cluster_nodes</td>
<td>当一个节点开始第一次启动时，将它设置为使集群自动发生。元组的第一个元素是节点试图集群到的节点。第二个元素是磁盘或ram，并确定节点类型。 Default: {[], disc}</td>
</tr>
<tr>
<td>server_properties</td>
<td>键值对的列表，在连接上向客户端宣布。 Default: []</td>
</tr>
<tr>
<td>collect_statistics</td>
<td>统计数据收集模式。主要与管理插件有关。选项有: none (不要发布统计数据)coarse (发出每个队列/每个通道/每个连接统计信息)fine (发出的每条数据)通常情况下不需要设置该参数 Default: none</td>
</tr>
<tr>
<td>collect_statistics_interval</td>
<td>统计数据收集间隔以毫秒为间隔。 主要相关插件 <a href="http://www.rabbitmq.com/management.html#statistics-interval" target="_blank" rel="noopener">management plugin</a>.Default: 5000</td>
</tr>
<tr>
<td>management_db_cache_multiplier</td>
<td>管理插件将缓存诸如队列清单之类的代价较高的查询的时间。缓存将把最后一个查询的运行时间乘以这个值，并在此时间内缓存结果。 Default: 5</td>
</tr>
<tr>
<td>auth_mechanisms</td>
<td><a href="http://www.rabbitmq.com/authentication.html" target="_blank" rel="noopener">SASL authentication mechanisms</a> to offer to clients.Default: [‘PLAIN’, ‘AMQPLAIN’]</td>
</tr>
<tr>
<td>auth_backends</td>
<td>List of <a href="http://www.rabbitmq.com/access-control.html" target="_blank" rel="noopener">authentication and authorisation backends</a> to use.Other databases than rabbit_auth_backend_internalare available through <a href="http://www.rabbitmq.com/plugins.html" target="_blank" rel="noopener">plugins</a>.Default: [rabbit_auth_backend_internal]</td>
</tr>
<tr>
<td>reverse_dns_lookups</td>
<td>设置为true，让RabbitMQ对客户端连接执行反向DNS查找，并通过rabbitmqctl和管理插件呈现该信息。 Default: false</td>
</tr>
<tr>
<td>delegate_count</td>
<td>用于集群内部通信的委托进程的数量。当为多核CPU时可以考虑设置该值 Default: 16</td>
</tr>
<tr>
<td>trace_vhosts</td>
<td>Used internally by the <a href="http://www.rabbitmq.com/firehose.html" target="_blank" rel="noopener">tracer</a>. 通常情况下不需要设置该参数Default: []</td>
</tr>
<tr>
<td>tcp_listen_options</td>
<td>默认的套接字选项。通常情况下不需要设置该参数 Default:<code>[{backlog,       128},  {nodelay,       true},  {linger,        {true,0}},  {exit_on_close, false}]</code></td>
</tr>
<tr>
<td>hipe_compile</td>
<td>设置为true，使用HiPE预编译RabbitMQ的部分，这是Erlang的即时编译器。这将增加服务器的吞吐量，以增加启动时间的成本。 您可能会看到，在启动时延迟几分钟，您的性能会提高20-50%。这些数据是高度工作负载和硬件依赖的。HiPE支持可能不会编译到您的Erlang安装中。如果不是这样，启用这个选项只会导致一个警告消息被显示，而启动将照常进行。例如，Debian/Ubuntu用户需要安装erlangbase-base-hipe包。HiPE在某些平台上是不可用的，尤其是Windows。HiPE在17.5之前就已经知道了erlangp/otp版本的问题。HiPE推荐使用最新的erlangp/otp版本Default: false</td>
</tr>
<tr>
<td>cluster_partition_handling</td>
<td>如何处理网络分区。可用模式:  ignorepause_minority{pause_if_all_down, [nodes], ignore \</td>
<td>autoheal} (例: [‘rabbit@node1’, ‘rabbit@node2’])autoheal详情请看<a href="http://www.rabbitmq.com/partitions.html#automatic-handling" target="_blank" rel="noopener">documentation on partitions</a> Default: ignore</td>
</tr>
<tr>
<td>cluster_keepalive_interval</td>
<td>节点应该多频繁地将keepalive消息发送到其他节点(以毫秒为单位)。请注意，这与netticktime不一样; 错过的keepalive消息不会导致节点被认为挂机。 Default: 10000</td>
</tr>
<tr>
<td>queue_index_embed_msgs_below</td>
<td>在消息的字节数中，消息将被直接嵌入到队列索引中。详情请看 <a href="http://www.rabbitmq.com/persistence-conf.html" target="_blank" rel="noopener">persister tuning</a> Default: 4096</td>
</tr>
<tr>
<td>msg_store_index_module</td>
<td>用于队列索引的实现模块。 详情请看 <a href="http://www.rabbitmq.com/persistence-conf.html" target="_blank" rel="noopener">persister tuning</a> Default: rabbit_msg_store_ets_index</td>
</tr>
<tr>
<td>backing_queue_module</td>
<td>队列内容的实现模块。通常情况下不需要设置该参数 Default: rabbit_variable_queue</td>
</tr>
<tr>
<td>msg_store_file_size_limit</td>
<td>Tunable value for the persister.  通常情况下不需要设置该参数Default: 16777216</td>
</tr>
<tr>
<td>mnesia_table_loading_retry_limit</td>
<td>在等待集群中的Mnesia tables可用时，需要重试的次数。 Default: 10</td>
</tr>
<tr>
<td>mnesia_table_loading_retry_timeout</td>
<td>在集群中等待每个重试的时间，以便可用 Default: 30000</td>
</tr>
<tr>
<td>queue_index_max_ journal_entries</td>
<td>Tunable value for the persister.  通常情况下不需要设置该参数Default: 65536</td>
</tr>
<tr>
<td>queue_master_locator</td>
<td>Queue master定位策略可用策略:&lt;&lt;”min-masters”&gt;&gt;&lt;&lt;”client-local”&gt;&gt;&lt;&lt;”random”&gt;&gt;详情请看 <a href="http://www.rabbitmq.com/ha.html#queue-master-location" target="_blank" rel="noopener">documentation on queue master location</a> Default: &lt;&lt;”client-local”&gt;&gt;</td>
</tr>
<tr>
<td>lazy_queue_explicit_gc_run_operation_threshold</td>
<td>调优： 只有在内存压力下有延迟队列时。　　　 这是触发垃圾收集器和其他内存减少活动的阈值。一个低的值可以降低性能，一个高的值可以提高性能，但是会导致更高的内存消耗。通常情况下不需要设置该参数Default: 1000</td>
</tr>
<tr>
<td>queue_explicit_gc_run_operation_threshold</td>
<td>调优： 在内存压力较大时。这是触发垃圾收集器和其他内存减少活动的阈值。一个低的值可以降低性能，一个高的值可以提高性能，但是会导致更高的内存消耗。通常情况下不需要设置该参数Default: 1000</td>
</tr>
</tbody>
</table>
<h5 id="配置条目加密"><a href="#配置条目加密" class="headerlink" title="配置条目加密"></a><strong>配置条目加密</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 可以在RabbitMQ配置文件中加密敏感配置条目（例如密码，包含URL的凭据）。代理在开始时解密加密的条目.请注意，加密配置条目不会使系统有意义地更安全。然而，它们允许RabbitMQ的部署符合各国的规定，要求在配置文件中不应以纯文本形式显示敏感数据。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加密值必须在Erlang加密元组内：&#123;encrypted，...&#125;。以下是默认用户加密密码的配置</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;rabbit, [</span><br><span class="line">  &#123;default_user, &lt;&lt;"guest"&gt;&gt;&#125;,</span><br><span class="line">  &#123;default_pass,</span><br><span class="line">&#123;encrypted,</span><br><span class="line"> &lt;&lt;"cPAymwqmMnbPXXRVqVzpxJdrS8mHEKuo2V+3vt1u/fymexD9oztQ2G/oJ4PAaSb2c5N/hRJ2aqP/X0VAfx8xOQ=="&gt;&gt;</span><br><span class="line">&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;config_entry_decoder, [</span><br><span class="line"> &#123;passphrase, &lt;&lt;"mypassphrase"&gt;&gt;&#125;</span><br><span class="line"> ]&#125;</span><br><span class="line">]&#125;</span><br><span class="line">].</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意configentrydecoder密钥与RabbitMQ用于解密加密值的密码。密码短语不需要在配置文件中进行硬编码，它可以在一个单独的文件中。</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;rabbit, [</span><br><span class="line">  ...</span><br><span class="line">  &#123;config_entry_decoder, [</span><br><span class="line"> &#123;passphrase, &#123;file, "/path/to/passphrase/file"&#125;&#125;</span><br><span class="line"> ]&#125;</span><br><span class="line">]&#125;</span><br><span class="line">].</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当使用&#123;passphrase，prompt&#125;启动时，RabbitMQ也可以要求操作者输入密码</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用rabbitmqctl和encode命令加密值</span></span><br><span class="line"></span><br><span class="line">rabbitmqctl encode '&lt;&lt;"guest"&gt;&gt;' mypassphrase</span><br><span class="line">&#123;encrypted,&lt;&lt;"... long encrypted value..."&gt;&gt;&#125;</span><br><span class="line">rabbitmqctl encode '"amqp://fred:secret@host1.domain/my_vhost"' mypassphrase</span><br><span class="line">&#123;encrypted,&lt;&lt;"... long encrypted value..."&gt;&gt;&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果要解密值，请添加--decode选项</span></span><br><span class="line"></span><br><span class="line">rabbitmqctl encode --decode '&#123;encrypted, &lt;&lt;"..."&gt;&gt;&#125;' mypassphrase</span><br><span class="line">&lt;&lt;"guest"&gt;&gt;</span><br><span class="line">rabbitmqctl encode --decode '&#123;encrypted, &lt;&lt;"..."&gt;&gt;&#125;' mypassphrase</span><br><span class="line">"amqp://fred:secret@host1.domain/my_vhost"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以对不同类型的值进行编码。上面的例子编码了二进制文件（&lt;&lt;“guest”&gt;&gt;）和字符串（“amqp：// fred：secret@host1.domain/my_vhost”）。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加密机制使用PBKDF2从密码短语中产生派生密钥。默认散列函数为SHA512，默认迭代次数为1000.默认密码为AES 256 CBC</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 您可以在配置文件中更改这些默认值：</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;rabbit, [</span><br><span class="line">  ...</span><br><span class="line">  &#123;config_entry_decoder, [</span><br><span class="line"> &#123;passphrase, "mypassphrase"&#125;,</span><br><span class="line"> &#123;cipher, blowfish_cfb64&#125;,</span><br><span class="line"> &#123;hash, sha256&#125;,</span><br><span class="line"> &#123;iterations, 10000&#125;</span><br><span class="line"> ]&#125;</span><br><span class="line">]&#125;</span><br><span class="line">].    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在命令行：</span></span><br><span class="line"></span><br><span class="line">rabbitmqctl encode --cipher blowfish_cfb64 --hash sha256 --iterations 10000 \</span><br><span class="line"> '&lt;&lt;"guest"&gt;&gt;' mypassphrase</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">158</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">123</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
