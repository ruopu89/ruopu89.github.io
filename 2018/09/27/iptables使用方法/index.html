<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="防火墙概念 &amp;emsp;&amp;emsp;iptables是工作在linux内核中的网络防火墙，iptables和netfilter是一组工具，真正起到防火墙作用的是netfilter，netfilter是内核中的一個過濾框架，iptables是一個生成防火牆規則，並能將其符加在netfilter上，真正實現數據報文過濾、NAT、mangle等規則生成的工具。 &amp;emsp;&amp;emsp;防火牆工作在主機或">
<meta name="keywords" content="防火墙">
<meta property="og:type" content="article">
<meta property="og:title" content="iptables使用方法">
<meta property="og:url" content="http://yoursite.com/2018/09/27/iptables使用方法/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:description" content="防火墙概念 &amp;emsp;&amp;emsp;iptables是工作在linux内核中的网络防火墙，iptables和netfilter是一组工具，真正起到防火墙作用的是netfilter，netfilter是内核中的一個過濾框架，iptables是一個生成防火牆規則，並能將其符加在netfilter上，真正實現數據報文過濾、NAT、mangle等規則生成的工具。 &amp;emsp;&amp;emsp;防火牆工作在主機或">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="http://yoursite.com/images/iptables/四表五链详细.jpg">
<meta property="og:image" content="http://yoursite.com/images/iptables/四表五链.png">
<meta property="og:image" content="http://yoursite.com/images/iptables/四表五链鸟哥.jpg">
<meta property="og:updated_time" content="2018-09-29T08:24:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iptables使用方法">
<meta name="twitter:description" content="防火墙概念 &amp;emsp;&amp;emsp;iptables是工作在linux内核中的网络防火墙，iptables和netfilter是一组工具，真正起到防火墙作用的是netfilter，netfilter是内核中的一個過濾框架，iptables是一個生成防火牆規則，並能將其符加在netfilter上，真正實現數據報文過濾、NAT、mangle等規則生成的工具。 &amp;emsp;&amp;emsp;防火牆工作在主機或">
<meta name="twitter:image" content="http://yoursite.com/images/iptables/四表五链详细.jpg">






  <link rel="canonical" href="http://yoursite.com/2018/09/27/iptables使用方法/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>iptables使用方法 | ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/27/iptables使用方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iptables使用方法
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-27 10:49:11" itemprop="dateCreated datePublished" datetime="2018-09-27T10:49:11+08:00">2018-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-09-29 16:24:36" itemprop="dateModified" datetime="2018-09-29T16:24:36+08:00">2018-09-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             閱讀次數： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="防火墙概念"><a href="#防火墙概念" class="headerlink" title="防火墙概念"></a>防火墙概念</h1><blockquote>
<p>&emsp;&emsp;iptables是工作在linux内核中的网络防火墙，iptables和netfilter是一组工具，真正起到防火墙作用的是netfilter，netfilter是内核中的一個過濾框架，iptables是一個生成防火牆規則，並能將其符加在netfilter上，真正實現數據報文過濾、NAT、mangle等規則生成的工具。</p>
<p>&emsp;&emsp;防火牆工作在主機或網絡的邊緣，對進出的數據報文進行檢查監控，按事先定義的規則進行相應處理。防火牆可以是硬件或軟件，規則實施防火，規則包括匹配標準和處理辦法。</p>
<p>&emsp;Framework:</p>
<p>&emsp;默認規則：</p>
<p>&emsp;如果防火牆默認是全部開放的，那就用堵的辦法</p>
<p>&emsp;如果防火牆默認是全部關閉的，那就用通的辦法</p>
<p>&emsp;&emsp;防火牆規則必須放在內核上，因爲我們是不能和內核打交道的，有人在內核的TCP/IP協議棧上開放了幾個位置，開放給用戶空間的應用程序</p>
<p>&emsp;&emsp;netfile就是內核中可以放規則的位置；iptables是工作在用戶空間可以寫規則並可通過系統調用放置在內核相應位置的應用程序；報文流向有三種：進來的，出去的和轉發的，在/proc/sys/net/ipv4/ip_forward中就是定義是否轉發的；根據IP地址完成路由表中的路由決策，無論從哪進來的只要到了TCPIP協議棧後的下一個就是路由決策</p>
</blockquote>
<h1 id="iptables概念"><a href="#iptables概念" class="headerlink" title="iptables概念"></a>iptables概念</h1><blockquote>
<ul>
<li><p>hook function：鈎子函數，有五個位置。分別是input（進）, output（出）, forward（轉發）, prerouting（路由做出前）, postrouting（路由之後再發出）</p>
</li>
<li><p>鈎子函數的規則鏈：INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING；</p>
</li>
<li><p>filter（過濾）：表：INPUT，OUTPUT，FORWARD；</p>
</li>
<li><p>nat（地址轉換）：表：PREROUTING，POSTROUTING，OUTPUT；</p>
</li>
<li><p>mangle（拆開、修改、封裝報文首部）：表：INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING；</p>
</li>
<li><p>過濾與mangle是不能放在一起的；</p>
</li>
<li><p>raw()：表：PREROUTING，OUTPUT</p>
</li>
<li>IINPUT、OUTPUT是從內核空間到用戶空間實現過濾的，是主機防火牆設置，通過本機轉發的通過FORWARD鏈，是網絡防火牆的設置。路由的轉發功能可以是一臺主機上的兩個網段的地址.一臺交換機上可以配置多個網段的地址，但它們之間不能通信，但如果不同網段的主機的網關指向了一臺網關服務器上一塊網卡的兩個不同網段的地址，且服務器上開通了路由的功能，那麼就可以通信了；因爲IP地址不是屬於網卡的，而是屬於主機的，所以一塊網卡可以邊接兩個網絡</li>
<li>啓用了ip_forward鏈，默認所有報文都要轉發</li>
<li><p>應該隔離可以被公網訪問的主機與不能被公網訪問的主機，如在網關服務器上放三塊網卡，其中一塊是面對互聯網的，另一塊是面對內網的，最後一塊面對服務器，開放互聯網訪問時只能從面對互聯網的網卡到面對服務器的網卡；所有在面對內網網卡上的報文要想進來必須得是一個響應，其他不允許，網關服務器被叫做三宿主的主機</p>
</li>
<li><p>netfilter:是一個框架，在TCP/IP協議橈上有5個鈎子函數分別對應5個規則鏈，工作在內核中。不能手動向netfilter中添加數據，要用iptables編寫規則送達netfilter的某個鏈上，但它必須先屬於某張表。默認表是filter，還有nat、mangle表</p>
</li>
<li><p>目標地址轉換在進入時改，源地址轉換在出去的時候改。</p>
</li>
<li><p>可以使用自定義鏈，但只在被默認鏈調用時才能發揮作用，而且如果沒有自定義鏈中的任何規則匹配，還應該有返回機制。用戶可以刪除自定義的空鏈，默認鏈不能刪除。</p>
</li>
<li><p>每個規則都有兩個內置的計數器，一個記錄被匹配的報文個數，一個記錄被匹配的報文大小之和</p>
</li>
<li><p>NAT：Network Address Translation</p>
</li>
<li>DNAT：目標地址轉換，轉換IP報文中的目標IP地址。目標地址轉換DNAT，指在返回結果時將地址轉換爲請求的地址。如一臺服務器上沒有服務，但将其設置成轉換到后端兩臺服務器的地址，一臺80一臺21,用户訪問時訪問的是這臺沒有服務的主機，但返回結果是有服務的兩臺主機的內容，在返回結果時就要將地址轉換成沒有服務的主機的IP。也就是当用户访问一个地址时，这个地址本没有服务，但可将此请求转到相应的地址服务上，并在服务返回结果时自动将源地址转为用户请求的地址，这就是目标地址转换。源地址转换与目标地址转换效果相反。我们只操作一半，另一半转换由服务器自动完成</li>
<li>SNAT：源地址轉換，轉換IP報文中的源IP地址（可在POSTROUTING或OUTPUT上做，對網關來講只在POSTROUTING上作）。雖然稱爲源地址轉換，但目標IP地址也會轉換，只不過回程的目標地址會轉換</li>
<li>在互聯網上發送報文的時候，無論經過任何路由設備源IP與目標IP是不會改變的</li>
<li>對linux主機而言，IP地址是屬於主機的，不屬於網卡,配在什麼網卡上並不重要，關鍵是是否屬於這臺主機，無論是否打開轉發功能。這裏所說指一臺主機ping自己的網關地址，在網關這臺主機上的IP網關地址即使不在一個網段上也沒有開轉發功能，同樣可以被ping通。只有在ping第三臺網關指向這臺網關主機另一個網段IP的主機時，才需要轉發。</li>
<li>對linux主機而言，IP地址是屬於主機的，不屬於網卡,配在什麼網卡上並不重要，關鍵是是否屬於這臺主機，無論是否打開轉發功能。這裏所說指一臺主機ping自己的網關地址，在網關這臺主機上的IP網關地址即使不在一個網段上也沒有開轉發功能，同樣可以被ping通。只有在ping第三臺網關指向了這臺網關主機另一個網段IP的主機時，才需要轉發。</li>
<li>涉及到轉發與本機無關時一定是在FORWARD鏈上做</li>
<li>iptables在二三四層上進行過濾</li>
<li></li>
</ul>
</blockquote>
<h2 id="四表五链"><a href="#四表五链" class="headerlink" title="四表五链"></a>四表五链</h2><ul>
<li><p>filter表——过滤数据包</p>
</li>
<li><p>Nat表——用于网络地址转换（IP、端口）</p>
</li>
<li><p>Mangle表——修改数据包的服务类型、TTL、并且可以配置路由实现QOS</p>
</li>
<li><p>Raw表——决定数据包是否被状态跟踪机制处理</p>
</li>
</ul>
<ul>
<li>INPUT链——进来的数据包应用此规则链中的策略</li>
<li>OUTPUT链——外出的数据包应用此规则链中的策略</li>
<li>FORWARD链——转发数据包时应用此规则链中的策略</li>
<li>PREROUTING链——对数据包作路由选择前应用此链中的规则（所有的数据包进来的时侯都先由这个链处理）</li>
<li>POSTROUTING链——对数据包作路由选择后应用此链中的规则（所有的数据包出来的时侯都先由这个链处理）</li>
</ul>
<p><img src="/images/iptables/四表五链详细.jpg" alt=""></p>
<p><img src="/images/iptables/四表五链.png" alt=""></p>
<p><img src="/images/iptables/四表五链鸟哥.jpg" alt=""></p>
<h2 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h2><p>NEW：新連接請求。主机连接目标主机，在目标主机上看到的第一个想要连接的包<br>ESTABLISHED：已建立的連接。主机已与目标主机进行通信，判断标准只要目标主机回应了第一个包，就进入该状态。<br>INVALID：非法連接請求。无效的封包，例如数据破损的封包状态<br>RELATED：相關聯的。主机已与目标主机进行通信，目标主机发起新的链接方式，例如ftp</p>
<h1 id="规则及语法"><a href="#规则及语法" class="headerlink" title="规则及语法"></a>规则及语法</h1><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t TABLE] COMMAND CHAIN [num] 匹配條件 -j 處理動作</span><br></pre></td></tr></table></figure>
<h2 id="規則：匹配標準"><a href="#規則：匹配標準" class="headerlink" title="規則：匹配標準"></a>規則：匹配標準</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">通用匹配：自身能夠檢查</span><br><span class="line">    -s, --src</span><br><span class="line">    #指定源地址</span><br><span class="line">    -d, --dst</span><br><span class="line">    #指定目標地址       </span><br><span class="line">    -p &#123;tcp|udp|icmp&#125;</span><br><span class="line">    #指定協議</span><br><span class="line">    -i eth* </span><br><span class="line">    #指定數據報文流入的接口，可用於自定義鏈，和以下鏈PREROUTING，INPUT，FORWARD</span><br><span class="line">    -o INTERFACE</span><br><span class="line">    #指定數據報文流出的接口，可用於標準定義的鏈和以下鏈OUTPUT,POSTROUTING,FORWARD</span><br><span class="line"></span><br><span class="line">擴展匹配：依賴模塊才能檢查，在/lib/iptables下的.so擴展模塊</span><br><span class="line">	隱含擴展：不用特別指明由哪個模塊進行的擴展，因爲此時使用-p &#123;tcp|udp|icmp&#125;</span><br><span class="line">	-p tcp</span><br><span class="line">		--sport PORT [-PORT]</span><br><span class="line"><span class="meta">		#</span><span class="bash">源端口；可使用連續端口</span></span><br><span class="line">		--dport PORT [-PORT]</span><br><span class="line"><span class="meta">		#</span><span class="bash">目標端口</span></span><br><span class="line">		--tcp-flags mask comp</span><br><span class="line"><span class="meta">		#</span><span class="bash">只檢查mask指定的標志位，是逗號分隔的標志位列表；comp：此列表中出現的標記位必須爲1；comp中沒出現，而mask中出現的，必須爲0；如：</span></span><br><span class="line">		--tcp-flags SYN，FIN，ACK，RST SYN，ACK 等同 --syn選項</span><br><span class="line"><span class="meta">		#</span><span class="bash">檢查tcp報文的 SYN，FIN，ACK，RST標志位，這些標志位中只能是SYN，ACK爲1，其他爲0</span></span><br><span class="line">		--syn：三次握手的第一次</span><br><span class="line">	-p icmp</span><br><span class="line">		--icmp-type</span><br><span class="line"><span class="meta">		#</span><span class="bash">icmp協議報文的類型，主要有0和8兩種,我們ping別人的時候出去的是8進來的是0,別人ping我們的時候進來的是8出去的是0</span></span><br><span class="line">		0：echo-reply	</span><br><span class="line"><span class="meta">		#</span><span class="bash">響應報文</span></span><br><span class="line">		8：echo-request    </span><br><span class="line"><span class="meta">		#</span><span class="bash">請求報文</span></span><br><span class="line">	-p udp</span><br><span class="line">		--sport</span><br><span class="line">		--dport</span><br><span class="line"></span><br><span class="line">	顯式擴展：必須指明由哪個模塊進行的擴展，在iptables中使用-m選項可完成此功能</span><br><span class="line">	-m EXTESTION_NAME -specific-opt(-m 擴展名 擴展選項)</span><br><span class="line">		* state：#狀態擴展</span><br><span class="line">			--state</span><br><span class="line">			結合ip_conntrack追蹤會話的狀態，有四種，跟據IP、連接追蹤</span><br><span class="line">			NEW：#新連接請求</span><br><span class="line">			ESTABLISHED：#已建立的連接</span><br><span class="line">			INVALID：#非法連接請求</span><br><span class="line">			RELATED：#相關聯的</span><br><span class="line">		例：</span><br><span class="line">		-m state --state NEW -j ACCEPT		</span><br><span class="line"><span class="meta">		#</span><span class="bash">只檢查NEW狀態，狀態爲NEW的可以通過</span></span><br><span class="line">		-m state --state NEW,ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">		#</span><span class="bash">狀態爲NEW和ESTABLISHED的全部放行，與地址，協誶無關</span></span><br><span class="line"></span><br><span class="line">		* multiport：#多端口匹配擴展，可實現離散的多端口匹配</span><br><span class="line">			--source-ports：#源端口</span><br><span class="line">			--destination-ports：#目標端口</span><br><span class="line">			--ports：#不論是上面兩種哪一種端口；另外多個端口可用逗號隔開，但最多只能有15個</span><br><span class="line">		例：</span><br><span class="line">		-m multiport --destination-ports 21,22,80 -j ACCEPT</span><br><span class="line">			</span><br><span class="line">		* iprange：#指定IP範圍</span><br><span class="line">			--src-range</span><br><span class="line">			--dst-range</span><br><span class="line">		例：</span><br><span class="line">		iptables -A INPUT -p tcp -m iprange --src-range 172.16.100.3-172.16.100.100 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT			</span><br><span class="line"><span class="meta">		#</span><span class="bash">源IP是100.3到100的，可以訪問目標端口22,狀態要是NEW或ESTABLISHED</span></span><br><span class="line"></span><br><span class="line">		* connlimit：#連接數限定，也就是線程數，如只能使用5個連接請求</span><br><span class="line">			! --connlimit-above n：#connlimit的上限，但這裏是達到n個</span><br><span class="line">		例：本機的web服務器最多允許同時發起兩個請求進來</span><br><span class="line">        iptables -A INPUT -d 172.16.100.7 -p tcp --dport 80 -m connlimit ! --connlimit-above 2 -j ACCEPT</span><br><span class="line">        #這是沒達到2個就允許，所以一般要在--connlimit-above前加！號。如果不加！号，可改ACCEPT的狀態爲DROP或REJECT了</span><br><span class="line"></span><br><span class="line">		* limit</span><br><span class="line">        	--limit RATE：給的是一個速率，如每秒多少人</span><br><span class="line">            --limit-burst：給的是一個上限，第一批可放行多少個</span><br><span class="line">		例：</span><br><span class="line">		iptables -I INPUT -d 172.16.100.7 -p tcp --dport 22 -m limit --limit 3/minute --limit-burst 3 -j ACCEPT	</span><br><span class="line"><span class="meta">		#</span><span class="bash">每分鍾放行3個，最多一次擁入3個</span></span><br><span class="line">		iptables -R INPUT 3 -d 172.6.100.7 -p icmp --icmp-type 8 -m limit --limit 5/minute --limit-burst 6 -j ACCEPT		</span><br><span class="line"><span class="meta">		#</span><span class="bash">修改第三條規則爲限定每分種5個ping請求，但前6個是很快的</span></span><br><span class="line">		測試，連續打開多個ssh連接服務器</span><br><span class="line"></span><br><span class="line">		* string </span><br><span class="line">        	--algo &#123;bm|kmp&#125;：#指定算法</span><br><span class="line">            --string "STRING"：#指定字符串，支持正則</span><br><span class="line">        例：</span><br><span class="line">        vim /var/www/html/test.html</span><br><span class="line">        	h7n9 </span><br><span class="line">            hello world</span><br><span class="line">		iptables -I INPUT -d 172.16.100.7 -m string --algo kmp --string "h7n9" -j REJECT</span><br><span class="line"><span class="meta">		#</span><span class="bash">上面這條是匹配不到的，因爲當用戶的請求中沒有h7n9，請求頁面時，我們響應的報文是從OUTPUT響應出去的，所以應將規則寫在OUTPUT上</span></span><br><span class="line">		iptables -R OUTPUT 1 -s 172.16.100.7 -m string --algo kmp --string "h7n9" -j REJECT</span><br><span class="line"><span class="meta">		#</span><span class="bash">不能訪問有h7n9的頁面 ,-R選項是修改之意。</span></span><br><span class="line"><span class="meta">		#</span><span class="bash">iptables -L -n -v顯示信息中的pkts是匹配到的規則</span></span><br></pre></td></tr></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">管理規則</span><br><span class="line">    -A：#附加一條規則，在鏈的尾部追加</span><br><span class="line">    -I CHAIN [num]：#插入一條規則，可以指定添加在什麼位置，插入爲對應CHAIN上的第num條，如果省略num則插入爲第一條</span><br><span class="line">    -D CHAIN [num]：#刪除指定鏈中的第num條規則；</span><br><span class="line">    -R CHAIN [num]：#替換指定的規則</span><br><span class="line"></span><br><span class="line">管理鏈</span><br><span class="line">    -F [CHAIN]：#flush：清空指定規則鏈，如果省略CHAIN，則可以實現刪除對應表中的所有鏈</span><br><span class="line">    -p CHAIN：#設定指定鏈的默認策略</span><br><span class="line">    -N：#自定義一個新的空鏈</span><br><span class="line">    -X：#刪除一個自定議的空鏈</span><br><span class="line">    -Z：#置零指定鏈中所有規則的計數器</span><br><span class="line">    -E：#重命名自定義的鏈</span><br><span class="line"></span><br><span class="line">查看類</span><br><span class="line">    -L：#顯示指定表中的規則</span><br><span class="line">    -n：#以數字格式顯示主機地址和端口號，與-L一起使用</span><br><span class="line">    -v：#顯示鏈及規則的詳細信息</span><br><span class="line">    -vv：#顯示更詳細的信息</span><br><span class="line">    -x：#顯示計數器的精確值</span><br><span class="line">    --line-numbers：#顯示規則號碼</span><br></pre></td></tr></table></figure>
<h2 id="動作（target）"><a href="#動作（target）" class="headerlink" title="動作（target）"></a>動作（target）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-j TARGET:跳轉</span><br><span class="line">    ACCEPT：#放行</span><br><span class="line">    DROP：#丟棄</span><br><span class="line">    REJECT：#拒絕</span><br><span class="line">    DNAT：#目標地址轉換</span><br><span class="line">    SNAT：#源地址轉換</span><br><span class="line">    REDIRECT：#端口重定向</span><br><span class="line">    MASQUERADE：#地址僞裝</span><br><span class="line">    LOG：#記錄日志</span><br><span class="line">    MARK：#給報文加上標記</span><br><span class="line">注：只要有允許或拒絕，是做過濾的，一定在filter表上</span><br><span class="line"></span><br><span class="line">-j SNAT：#源地址轉換</span><br><span class="line">	--to-source：#轉換成哪個源地址</span><br><span class="line">	</span><br><span class="line">-j MASQUERADE		</span><br><span class="line"><span class="meta">#</span><span class="bash">外網地址是動態獲取時用此選項，它不需要—to-source選項，可以自動查到上外網的地址。</span></span><br><span class="line"></span><br><span class="line">-j DNAT</span><br><span class="line">	--to-destination IP[:port]</span><br></pre></td></tr></table></figure>
<h2 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables規則保存位置，/etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables.tus		</span><br><span class="line"><span class="meta">#</span><span class="bash">保存方法</span></span><br><span class="line">iptables-restore &lt; /etc/sysconfig/iptables.tus		</span><br><span class="line"><span class="meta">#</span><span class="bash">此爲載入方法</span></span><br></pre></td></tr></table></figure>
<h1 id="例"><a href="#例" class="headerlink" title="例"></a>例</h1><h2 id="查看规则"><a href="#查看规则" class="headerlink" title="查看规则"></a>查看规则</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">例：</span><br><span class="line">	iptables -L -n			</span><br><span class="line"><span class="meta">	#</span><span class="bash">默認顯示filter表</span></span><br><span class="line">	iptables -t filter -L -n</span><br><span class="line">	iptables -t nat -L -n</span><br><span class="line">	iptables -t mangle -L -n</span><br><span class="line"><span class="meta">	#</span><span class="bash">顯示內容中的Chain INPUT一項中沒有寫哪個表，默認就是filter表中的規則，policy表示默認策略，ACCEPT表示其爲默認值時只拒絕已知的壞蛋，如果是DROP就是只接受已知的好人。pkts表示被某一條規則所匹配到的數據包的個數，bytes表示字節數</span></span><br></pre></td></tr></table></figure>
<h2 id="测试1"><a href="#测试1" class="headerlink" title="测试1"></a>测试1</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.7 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -t filter -A OUTPUT -s 172.16.100.7 -d 172.16.0.0/16 -p tcp --sport 22 -j ACCEPT</span><br><span class="line">yum install -y httpd vsftpd mysql-server </span><br><span class="line">service httpd start		</span><br><span class="line"><span class="meta">#</span><span class="bash">啓動服務</span></span><br><span class="line">browser測試是否可以打開ip地址</span><br><span class="line"><span class="meta">#</span><span class="bash">修改默認設置爲都不能訪問本機，之前寫的兩條可以訪問本機22端口ssh服務的規則是爲了不讓遠程連接斷開，如果先寫下面的默認規則會使遠程連接斷開，造成麻煩</span></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP</span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -L -n</span><br><span class="line"><span class="meta">#</span><span class="bash">允計所有外部主機訪問本機的80端口，如果web服務比ssh服務訪問量大要放在其上面，所以這裏用-I選項，默認插入在第一行。當地址爲0.0.0.0的時候可以不寫，所以這裏沒有寫-s選項</span></span><br><span class="line">iptables -I INPUT -d 172.16.100.7 -p tcp --dport 80 -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">進規則</span></span><br><span class="line">iptables -L -n		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看規則</span></span><br><span class="line">iptables -L OUTPUT -s 172.16.100.7 -p tcp --sport 80 -j ACCEPT     </span><br><span class="line"><span class="meta">#</span><span class="bash">出規則</span></span><br><span class="line">echo hello &gt; /var/www/html/index.html		</span><br><span class="line"><span class="meta">#</span><span class="bash">添加默認網頁並測試</span></span><br><span class="line"><span class="meta">#</span><span class="bash">因ping請求使用的是icmp協議，所以這時是不能ping通的。因爲ping命令要先從OUTPUT鏈出去再從INPUT鏈進來，所以用本機ping 127.0.0.1也是不通的</span></span><br><span class="line">iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -i lo -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">-i選項是指定從哪個接口流入的請求</span></span><br><span class="line">iptables -A OUTPUT -s 127.0.0.1 -d 127.0.0.1 -o lo -j ACCEPT  </span><br><span class="line"><span class="meta">#</span><span class="bash">-o選項指定從哪個接口流出</span></span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p icmp --icmp-type 8 -j ACCEPT</span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p icmp --icmp-type 0 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">ping別人的時候，出去的是8,進來的是0，別人ping我們的時候，進來的是8,出去的是0；這樣就可以實現我們ping外面的主機了，但別人是ping不了我們的</span></span><br></pre></td></tr></table></figure>
<h2 id="测试2"><a href="#测试2" class="headerlink" title="测试2"></a>测试2</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -j DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">來自172.16.0.0/16網段的報文無論訪問本機哪個地址都被丟棄。-A表示添加一條規則</span></span><br><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.7  -j DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">來自172.16.0.0/16網段訪問100.7的經過INPUT鏈的都被丟棄</span></span><br><span class="line"></span><br><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.7 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -t filter -A OUTPUT -s 172.16.100.7 -d 172.16.0.0/16 -p tcp --sport 22 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##這兩條命令第一條是進第二條是出，在寫規則時一定要把進出都寫上，意思是放行172.16.0.0/16網段的地址訪問172.16.100.7的22號端口ssh服務</span></span></span><br><span class="line"></span><br><span class="line">iptables -L -n -v</span><br><span class="line"><span class="meta">#</span><span class="bash">lsmod命令可以查看啓動的模塊，這裏查看iptables模塊是否啓動，四個表：iptable_mangle、iptable_nat、iptable_raw、iptable_filter</span></span><br><span class="line">modprobe -r 模塊名			</span><br><span class="line"><span class="meta">#</span><span class="bash">注銷或裝載一個模塊</span></span><br><span class="line"><span class="meta">#</span><span class="bash">iptables不是服務，但有服務腳本；服務腳本的主要作用在於管理保存規則，它保存在內核的內存空間上。可以使用lsmod查看iptables的相關模塊是否加載，啓動與停止服務就是裝載及移除iptables/netfilter相關的內核模塊。模塊一般有：iptables_nat, iptables_filter, iptables_mangle, iptables_raw, ip_nat, ip_conntrack； ip_conntrack是當我們啓用nat功能時，每一個地址轉換的相應的返回的報文是要自動管理的，要追蹤每一個地址轉換的報文的，這就是ip_conntrack的功能。</span></span><br></pre></td></tr></table></figure>
<h2 id="测试3"><a href="#测试3" class="headerlink" title="测试3"></a>测试3</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">我們是一個DNS服務器，用戶請求不是我們負責的域，我們就到互聯網找出結果；默認策略INPUT,OUTPUT,FORWARD都是DORP的話，該怎麼寫規則</span><br><span class="line"><span class="meta">#</span><span class="bash">我們是DNS服務器，應該監聽在UDP的53號端口上，當一個客戶端到我們這來請求解析的時候，我們要允許這個請求進來，源地址是客戶端，目標地址是我們的主機，目標端口是53，這應該放行；出去時原端口是53，目標地址是客戶機；但別人請求的是一個不是我們的主機負責的域時，服務器要去找根，它找根時就不是服務器端了，而是客戶端，這就要放行目標端口；當我們作爲客戶端時與這個服務器就沒關系了。這要寫四條規則，而且這只是UDP，它還要監聽在TCP上，所以一共要写八條规则。</span></span><br><span class="line"></span><br><span class="line">作爲web服務器，只開放80端口的響應與放行就可以避免決大多數的攻擊了，80端口應該是只有別人請求進來，它才響應出去。只有這樣反彈式木馬在沒有人請求時才不能響應出去。這種功能在iptables中叫連接追蹤的功能，叫ip_conntrack，這是一個內核模塊，它能時時記錄着主機上客戶端，服務器端彼此正在建立的連接關系，並能追蹤到哪一個連接與其他連接之間處於什麼狀態並有什麼關系，所以上面的情況就可以判定只允許本地主機出去的連接必須爲某一種狀態，必須處於已經建立的連接，也就是必須是對別人的響應我們才允許出去，如果不是響應是決不放行的，這就靠ip_conntrack實現，ip_conntrack可根據IP報文來追蹤TCP和UDP與ICMP的連接。它可以根據請求方與響應方處理什麼過程。在/proc/sys/net/ipv4/ip_conntrack內核文件，它是位於內存當中的，因爲它在proc系統上，這個文件保存有當前系統上每一個客戶端和當前主機與每一個其他主機所建立的連接關系 </span><br><span class="line">cat /proc/sys/net/ipv4/ip_conntrack</span><br><span class="line"><span class="meta">#</span><span class="bash">顯示內容中每條記錄兩個來回的兩個通道的信息，並保存了當前會話所處的狀態。ip_conntrack的這種功能是靠ip_conntrack模塊實現的</span></span><br><span class="line"><span class="meta">#</span><span class="bash">用iptstate命令也可查看到這些信息</span></span><br><span class="line">iptstate -t		</span><br><span class="line"><span class="meta">#</span><span class="bash">顯示當前所有連接的個數</span></span><br><span class="line"><span class="meta">#</span><span class="bash">/proc/sys/net/ipv4/ip_conntrack_max是設置ip_conntrack的同時追蹤的最大值，默認是32768個，超出的連接會被超時丟棄，使用戶無法連接，如果訪問量過大最好不要啓動此模塊，如果不大最好調大此項的值，這個模塊是追蹤已連接的地址的。在iptables停止的狀態下，如果執行iptables -t nat -L命令就要激活ip_conntrack和nfnetlink模塊。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">iptables重啓會清空規則，重新加載/etc/sysconfig/iptables目錄中的文件，使用命令service iptables save可以保存規則。</span></span><br><span class="line"></span><br><span class="line">保存規則：</span><br><span class="line">service iptables save		</span><br><span class="line"><span class="meta">#</span><span class="bash">保存規則</span></span><br><span class="line"><span class="meta">#</span><span class="bash">默認保存在/etc/sysconfig/iptables</span></span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables.***		</span><br><span class="line"><span class="meta">#</span><span class="bash">手動指定保存位置</span></span><br><span class="line">iptables-restore &lt; /etc/sysconfig/iptables.***		</span><br><span class="line"><span class="meta">#</span><span class="bash">因爲手動指定保存位置所以無法加載，要用此條命令指定加載位置</span></span><br></pre></td></tr></table></figure>
<h2 id="開通服務器的sshd-httpd訪問端口"><a href="#開通服務器的sshd-httpd訪問端口" class="headerlink" title="開通服務器的sshd, httpd訪問端口"></a>開通服務器的sshd, httpd訪問端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">一臺服務器，地址172.16.100.7</span><br><span class="line">iptables -F		</span><br><span class="line"><span class="meta">#</span><span class="bash">清空規則</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">放行所有狀態是NEW,ESTABLISHED的訪問22號端口的連接，因爲是進來所以有NEW狀態</span></span><br><span class="line">lsmod | grep ip</span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p tcp --sport 22 -m state –state ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">這是出去所有只有ESTABLISHED已連接狀態</span></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">改變默認策略爲不允許連接</span></span><br><span class="line">iptables -L -n		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看現在的規則</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">再改80端口爲相同的規則</span></span><br><span class="line">iptstate		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看連接狀態</span></span><br><span class="line">sysctl -w net.ipv4.ip_conntrack_max=65536		</span><br><span class="line"><span class="meta">#</span><span class="bash">改最大值，臨時生效，要永久生效要寫在/etc/sysctl.conf中</span></span><br><span class="line">cat /proc/sys/net/ipv4/ip_conntrack_max		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看 </span></span><br><span class="line"><span class="meta">#</span><span class="bash">在/proc/sys/net/ipv4/netfilter目錄中保存了ip_conntrack的很多設置的值，其中的ip_conntrack_tcp_timeout_established中有tcp連接的保持時間，是120小時，這裏的默認單位的秒，建議將此值改小。ip_conntrack是可以追蹤三種協議tcp，udp，icmp，只是對udp，icmp只追蹤超時。</span></span><br><span class="line"></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p icmp --icmp-type 8 -m state --state NEW,ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">進規則</span></span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p icmp --icmp-type 0 -m state --state ESTABLISHED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">出規則</span></span><br><span class="line"><span class="meta">#</span><span class="bash">寫規則時按邏輯寫，像上面兩條是允許外面的主機ping我們的主機，所以要先寫進來的規則再寫出去</span></span><br><span class="line">iptables -L -n --line-numbers		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看規則，--line-numbers是顯示行號</span></span><br><span class="line">iptables -I OUTPUT -s 172.16.100.7 -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">用這一條規則可以檢查所有出去的響應，也就是不用再寫其他出去的規則了，這樣雖然默認的規則是DROP，但這條規則可以規定所有出去的規則</span></span><br><span class="line">iptables -D OUTPUT 2		</span><br><span class="line"><span class="meta">#</span><span class="bash">刪除OUTPUT的第二條</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT		</span><br><span class="line">iptables -A OUTPUT -o lo -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">放行本機的回環地址，因爲ftp服務要通過本機回環地址在mysql數據庫中查詢用戶名密碼，所以要放行才能使用ftp服務或iptables對ftp服務的規則才能生效;ftp服務中PORT表示主動模式，PASV表示被動模式，要使用被動模式因端口是隨機的，所以要使用iptables狀態中的RELATED（相關聯的，與之前的命令有關系）狀態在規則中。如：</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p tcp -m state --state RELATED -j ACCEPT</span><br><span class="line">iptables -R OUTPUT 1 -s 172.16.100.7 -m state --state ESTABLISHED,RELATED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">修改OUTPUT中的第一條</span></span><br><span class="line">iptables -R INPUT 6 -d 172.16.100.7 -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">修改INPUT中的第六條，因爲第一次加這條規則時沒有指明ESTABLISHED狀態，使ftp服務連接後不能查看數據。最後，要先裝載ip_conntrack_ftp和ip_nat_ftp模塊才可進行下面的步驟，裝載方法如下：</span></span><br><span class="line">vim /etc/sysconfig/iptables-config		</span><br><span class="line"><span class="meta">#</span><span class="bash">編輯此文件</span></span><br><span class="line">	IPTABLES_MODULES="ip_nat_ftp ip_conntrack_ftp"   </span><br><span class="line">iptables -I INPUT -d 172.16.100.7 -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">用這一條規則先來判斷連接的狀態，符合的就放行，這樣可以讓之後的規則不必再寫這兩種狀態</span></span><br><span class="line">service iptables save</span><br><span class="line">vim /etc/sysconfig/iptables		</span><br><span class="line"><span class="meta">#</span><span class="bash">直接編輯此文件來修改規則，刪除INPUT其他規則中的RELATED和ESTABLISHED</span></span><br><span class="line">service iptables reload</span><br><span class="line">iptables -L -n</span><br><span class="line">iptables -I INPUT 2 -d 172.16.100.7 -p tcp -m multiport --destination-ports 21,22,80 -m state --state NEW -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">加入到INPUT中的第二條，只要是21,22,80端口爲NEW狀態的就放行；另外，之前所有命令中都可以用！號取反，如：</span></span><br><span class="line">    -s ！ 172.16.100.7		</span><br><span class="line">    #表示除了100.7都可以</span><br><span class="line">	</span><br><span class="line">	-j TARGET</span><br><span class="line">		LOG：記錄日志信息，log與DROP、ACCEPT使用時要放在前面</span><br><span class="line">            --log-prefix "STRING"		</span><br><span class="line">            #指定LOG日志的前綴</span><br><span class="line"><span class="meta">			#</span><span class="bash">記日志最好加上速率限定，不然記錄太多，產生大量磁盤IO,使性能下降</span></span><br><span class="line">例：</span><br><span class="line">iptables -I INPUT 4 -d 172.16.100.7 -p icmp --icmp-type 8 -j LOG --logprefix "--firewall log for icmp--"</span><br><span class="line"><span class="meta">#</span><span class="bash">記錄ping本機的日志，在日志中加上一個字符串<span class="string">"--firewall log for icmp--"</span></span></span><br></pre></td></tr></table></figure>
<h2 id="自定義規則鏈並在主鏈中被調用"><a href="#自定義規則鏈並在主鏈中被調用" class="headerlink" title="自定義規則鏈並在主鏈中被調用"></a>自定義規則鏈並在主鏈中被調用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">iptables -N clean_in			</span><br><span class="line"><span class="meta">#</span><span class="bash">新建一條叫clean_in的規則鏈，其中references表示引用，也就是被主鏈調用</span></span><br><span class="line">iptables -A clean_in -d 255.255.255.255 -p icmp -j DROP         </span><br><span class="line"><span class="meta">#</span><span class="bash">添加一條規則</span></span><br><span class="line">iptables -L -n –line-numbers</span><br><span class="line">iptables -A clean_in -d 172.168.255.255 -p icmp -j DROP</span><br><span class="line">iptables -A clean_in -p tcp ! --syn -m state --state NEW -j DROP</span><br><span class="line">iptables -A clean_in -p tcp --tcp-flags ALL ALL -j DROP</span><br><span class="line">iptables -A clean_in -p tcp --tcp-flags ALL NONE -j DROP</span><br><span class="line">iptables -A clean_in -d 172.16.100.7 -j RETURN		</span><br><span class="line"><span class="meta">#</span><span class="bash">返回到主鏈上去</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -j clean_in</span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -o lo -j ACCEPT</span><br><span class="line">iptables -A INPUT -i eth0 -m multiport -p tcp --dports 53,113,135,137,139,445 -j DROP</span><br><span class="line">iptables -A INPUT -i eth0 -m multiport -p udp --dports 53,113.135.137.139.445 -j DROP</span><br><span class="line">iptables -A INPUT -i eth0 -p udp --dport 1026 -j DROP</span><br><span class="line">iptables -A INPUT -i eth0 -m multiport -p tcp --dports 1433,4899 -j DROP</span><br><span class="line">iptables -A INPUT -p icmp -m limit --limit 10/second -j ACCEPT</span><br><span class="line">iptables -I INPUT -j clean_in      </span><br><span class="line"><span class="meta">#</span><span class="bash">無論什麼地址，先交給clean_in處理一遍，clean_in如果沒有問題再返回主鏈第二條進行處理；如果要刪除自定義鏈要先刪除其中的鏈規則，再刪除自定義的鏈</span></span><br></pre></td></tr></table></figure>
<h2 id="利用iptables的recent模块来抵御DOS攻击"><a href="#利用iptables的recent模块来抵御DOS攻击" class="headerlink" title="利用iptables的recent模块来抵御DOS攻击"></a>利用iptables的recent模块来抵御DOS攻击</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ssh远程连接</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 3 -j DROP</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">利用connlimit模块将单IP的并发设置为3，会误杀使用NAT上网的用户，可以根据实际情况增大该值</span></span><br><span class="line"><span class="meta">#</span><span class="bash">利用recent和state模块限制单IP在300s内只能与本机建立3个新连接，被限制五分钟后即可恢复访问</span></span><br><span class="line">下面对最后两名做一个说明：</span><br><span class="line"><span class="meta">#</span><span class="bash">第二句是记录访问tcp22端口的新连接，记录名为SSH。--<span class="built_in">set</span>记录数据包的来源IP，如果IP已经存在将更新已经存在的条目</span></span><br><span class="line"><span class="meta">#</span><span class="bash">第三句是指SSH记录中的IP，300s内发起超过3次连接则拒绝此IP的连接。--update是指每次建立连接都更新列表；--seconds必须与--rcheck或者--update同时使用；--hitcount必须与--rcheck或者--update同时使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash">iptables的记录：/proc/net/ipt_recent/SSH</span></span><br><span class="line"><span class="meta">#</span><span class="bash">也可以使用下面的这句记录日志：</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --name SSH --second 300 --hitcount 3 -j LOG --log-prefix "SSH Attack"</span><br></pre></td></tr></table></figure>
<h2 id="测试4"><a href="#测试4" class="headerlink" title="测试4"></a>测试4</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">試驗在虛擬機中建三臺主機，一臺linux主機，一塊網卡橋接；一臺linux路由，一塊網卡橋接，地址172，一塊網卡用HOST ONLY,地址192；一臺win主機，網卡用HOST ONLY；這時linux主機可與linux路由通信，因爲都是橋接網卡；win主機也可與linux路由通信，因爲是HOST ONLY；而且兩臺主機可以ping通路由上的任一個地址，因爲路由上的兩個地址在一臺主機上，即使不在一個網段也可以通信。但linux主機不能與win主機通信，因爲沒有路由，這時改路由的/proc/sys/net/ipv4/ip_forward項爲1，那麼這臺主機就具有了路由功能。再將兩臺主機的網關指向路由的兩個IP地址，這時就能通信了，這時是用不到NAT功能的。因爲要與公網通信，私網地址不能在公網上路由，所以才用NAT；需要轉換時路由的NAT功能會自動完成，在做源地址轉換時也會做目標地址轉換，只是目標地址轉換是自動進行的</span><br></pre></td></tr></table></figure>
<h2 id="源地址转换"><a href="#源地址转换" class="headerlink" title="源地址转换"></a>源地址转换</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j SNAT --to-source 172.16.100.7	</span><br><span class="line"><span class="meta">#</span><span class="bash">要在nat表中創建，鏈是POSTROUTING。此条命令指對服務器來講，任何源地址是192.168.10.0/24網段的地址都轉換爲172.16.100.7。--to-source選項可指定一個地址範圍，如****-****，兩個地址間用橫線隔開來表示</span></span><br><span class="line">tcpdump -i eth0 -nn -X icmp</span><br><span class="line"><span class="meta">#</span><span class="bash">到10.7抓包</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT –to-source 123.2.3.2</span><br><span class="line"><span class="meta">#</span><span class="bash">在服務器上寫一條規則，讓所有同學可以訪問互聯網的任一網絡，公網IP地址是123.2.3.2</span></span><br></pre></td></tr></table></figure>
<h2 id="测试5"><a href="#测试5" class="headerlink" title="测试5"></a>测试5</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -s 192.168.10.0/24 -p icmp -j REJECT		</span><br><span class="line"><span class="meta">#</span><span class="bash">禁止192.168.10.0/24網段主機ping外網，此規則只是禁止了主機之間的ping，而沒有進入中間的防火牆服務器，所以不經過INPUT或OUTPUT進入服務器，而只是經過服務器轉發FORWARD</span></span><br></pre></td></tr></table></figure>
<h2 id="测试6"><a href="#测试6" class="headerlink" title="测试6"></a>测试6</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -A FORWARD -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">如果是已建立的連接都放行</span></span><br><span class="line">iptables -A FORWARD -s 192.168.10.0/24 -p tcp --dport 80 -m state --state NEW -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">出去的規則，如果訪問的是web服務都放行，這是只能從內網出去的，外網是進不來的</span></span><br><span class="line">IPTABLES -A FORWARD -s 192.168.10.0/24 -p icmp --icmp-type 8 -m state --state NEW -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">放行ping，可以ping其他主機。這是只能從內網出去的，外網是進不來的</span></span><br><span class="line">iptables -A FORWARD -s 192.168.10.0/24 -p tcp --dport 21 -m state --state NEW -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">放行ftp服務</span></span><br><span class="line">iptables -R FORWARD 1 -m state --state ESTABLISHED,RELATED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">用上面兩條規則可開放ftp服務，但不要忘記在/etc/sysconfig/iptables-config中加載ip_nat_ftp和ip_nat模塊</span></span><br></pre></td></tr></table></figure>
<h2 id="目标地址转换"><a href="#目标地址转换" class="headerlink" title="目标地址转换"></a>目标地址转换</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -d 172.16.100.7 -p tcp --dport 80 -j DNAT --to-destination 192.168.10.22		</span><br><span class="line"><span class="meta">#</span><span class="bash">目標地址轉換要在PREROUTING上做。訪問172主機80端口都以192的80端口返回結果，且只在請求80服務時才轉發</span></span><br><span class="line">iptables -t nat -R PREROUTING 1 -d 172.16.100.7 -p tcp --dport 80 -j DNAT --to-destination 192.168.10.22:8080	</span><br><span class="line"><span class="meta">#</span><span class="bash">改上一條規則，訪問172主機80端口的訪問結果都以192的8080端口返回，這就是PNAT：Port NAT 端口映射或端口轉換</span></span><br><span class="line">iptables -A FORWARD -m string --algo kmp --string "h7n9" -j DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">涉及到轉發與本機無關時一定是在FORWARD鏈上。這時沒有寫協議，所以是禁止訪問任何內容中有h7n9的</span></span><br></pre></td></tr></table></figure>
<h2 id="iptables脚本"><a href="#iptables脚本" class="headerlink" title="iptables脚本"></a>iptables脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">ipt=/usr/sbin/iptables</span><br><span class="line">einterface=eth1</span><br><span class="line">iinterface=eth0</span><br><span class="line"></span><br><span class="line">eip=172.16.100.7</span><br><span class="line">iip=192.168.10.6</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -t nat -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -t filter -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -t mangle -F</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -N clean_up</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -A clean_up -d 255.255.255.255 -p icmp -j DROP</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -A clean_up -j RETURN</span></span><br></pre></td></tr></table></figure>
<h2 id="测试7"><a href="#测试7" class="headerlink" title="测试7"></a>测试7</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -j LOG --log-prefix "Denied ICMP:" --log-level 7</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">每秒只响应一次ping，超过的记录日志并丢弃</span></span><br><span class="line">iptables -A INPUT -i eth0 -p icmp --icmp-type echo-request -m statistic --mode nth --every 2 --packet 0 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">每两个<span class="built_in">echo</span>-request就丢弃一个</span></span><br></pre></td></tr></table></figure>
<h2 id="测试8"><a href="#测试8" class="headerlink" title="测试8"></a>测试8</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">不允许接受icmp数据包到本地</span></span><br><span class="line">iptables -A INPUT -p all -m state --state INVALID -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">不允许发送未知数据包到本地</span></span><br><span class="line">iptables -A INPUT all -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">允许已经允许过的连接和被动请求数据包发送到本地</span></span><br><span class="line">iptables -A INPUT -p tcp --syn --dport 22 -m state --state NEW -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">检查该连接中第一个数据包，并检查该数据包是否包含syn标记，符合两项条件才允许进入。</span></span><br><span class="line">iptables -A INPUT -p tcp --syn -m state --state NEW -m multiport --dport 21,22,23,24,25 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">使用Multiport模块一次添加多个端口</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL SYN,FIN -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">检查所有 TCP-Flags，但只有syn及fin两个标记同时为1时，数据包才会被筛选出来</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">检查所有 TCP-Flags中syn及fin两个标记同时为1时，数据包才会被筛选出来</span></span><br></pre></td></tr></table></figure>
<h2 id="数据指添加"><a href="#数据指添加" class="headerlink" title="数据指添加"></a>数据指添加</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /root/mac_list.txt | while read MAC</span><br><span class="line">do     </span><br><span class="line">	MAC=$( echo $MAC | awk '&#123;print $1&#125;' )      </span><br><span class="line">	iptables -t filter -A FORWARD -i eth1 -o eth0 -m mac --mac-source $MAC -j ACCEPT</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="mangle表用法-MARK模块匹配（单数据包）"><a href="#mangle表用法-MARK模块匹配（单数据包）" class="headerlink" title="mangle表用法 MARK模块匹配（单数据包）"></a>mangle表用法 MARK模块匹配（单数据包）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -A PREROUTING -p tcp --dport 80 -j MARK --set-mark 80</span><br><span class="line">iptables -A FORWARD -p all -m mark --mark 80 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="管理用户或组模块"><a href="#管理用户或组模块" class="headerlink" title="管理用户或组模块"></a>管理用户或组模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A　OUTPUT -p tcp -m owner --uid--owner tom --dport 80 -j ACCEPT</span><br><span class="line">iptables -A　OUTPUT -p udp -m owner --uid--owner tom --dport 53 -j ACCEPT</span><br><span class="line">iptables -A　OUTPUT -p all -m owner --uid--owner tom -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="使用iprange模块添加ip范围"><a href="#使用iprange模块添加ip范围" class="headerlink" title="使用iprange模块添加ip范围"></a>使用iprange模块添加ip范围</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m iprange --src-range 192.168.0.2-192.168.0.61 -j DROP</span><br><span class="line">iptables -A INPUT -m iprange --dst-range 192.168.0.2-192.168.0.61 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="ttl值匹配模块"><a href="#ttl值匹配模块" class="headerlink" title="ttl值匹配模块"></a>ttl值匹配模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m ttl --ttl-eq 64 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash">--ttl<span class="_">-eq</span> 等于</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--ttl<span class="_">-lt</span> 小于</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--ttl<span class="_">-gt</span> 大于</span></span><br></pre></td></tr></table></figure>
<h2 id="IPSEC-SPI-值控制模块"><a href="#IPSEC-SPI-值控制模块" class="headerlink" title="IPSEC SPI 值控制模块"></a>IPSEC SPI 值控制模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -p ah -m ah --ahspi 300 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p esp -m esp --espspi 200 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h2 id="pkttype模块"><a href="#pkttype模块" class="headerlink" title="pkttype模块"></a>pkttype模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -p icmp -m pkttype --pky-type broadcast -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">unicast:数据包发送的对象时特定的，如主机A传输给主机B即为unicast类型</span></span><br><span class="line"><span class="meta">#</span><span class="bash">broadcast:数据包传送的对象为广播地址，如192.168.0.255</span></span><br><span class="line"><span class="meta">#</span><span class="bash">multicast:通常应用于网络的“音频”或“视频”广播，而Multicast数据包的特点是，其Source IP一定介于224.0.0.0/24之间。</span></span><br></pre></td></tr></table></figure>
<h2 id="length模块"><a href="#length模块" class="headerlink" title="length模块"></a>length模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp -type 8 -m length --length 92 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp -type 8 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">MTU=(IP包+ICMP包+DATA)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--length 50 匹配MTU值刚好为50字节的数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--length :100 匹配MTU值小于100个字节的数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--length 50:100 匹配MTU值介于50-100个字节的数据包</span></span><br></pre></td></tr></table></figure>
<h2 id="limit数据包重复率匹配"><a href="#limit数据包重复率匹配" class="headerlink" title="limit数据包重复率匹配"></a>limit数据包重复率匹配</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -m limit --limit 6/m --limit-burst 10 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">一分钟进入10个数据包以上，就会限制一分钟进入6个数据包，直到6*10s内没有收到数据包，将会解除</span></span><br></pre></td></tr></table></figure>
<h2 id="recent模块"><a href="#recent模块" class="headerlink" title="recent模块"></a>recent模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -m recent --name icmp_db --rcheck --second 60 --hitcount 6 -j DROP</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -m recent --set --name icmp_db</span><br><span class="line">cat /proc/net/xt_recent/icmp_db</span><br><span class="line">modprobe xt_recent ip_list_tot=1024 ip_pkt_list_tot=50</span><br><span class="line"><span class="meta">#</span><span class="bash">ip_list_tot设置ip上限条数，默认100</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ip_pkt_list_tot设置数据存储空间，默认20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">--name 设置跟踪数据库的文件名</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--<span class="built_in">set</span>将符合条件的来源数据添加到数据库中，但如果来源端数据已经存在，则更新数据库中的记录信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--rcheck只进行数据库中信息的匹配，并不会对已存在的数据做任何变更操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--update如果来源端的数据已存在，则将其更新；若不存在，则不做任何处理</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--remove如果来源端数据已存在，则将其删除，若不存在，则不做任何处理</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--seconds seconds当事件发生时，只会匹配数据库中前“几秒”内的记录，--seconds必须与--rcheck或--update参数共用</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--hitcount hits匹配重复发生次数，必须与--rcheck或--update参数共用</span></span><br></pre></td></tr></table></figure>
<h2 id="string模块-匹配字符串"><a href="#string模块-匹配字符串" class="headerlink" title="string模块 匹配字符串"></a>string模块 匹配字符串</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp -d $WEB_SERVER --dport 80 -m string --algo bm --string "system32" -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">--algo 字符串匹配算法的选择，string模块提供了两种不同的算法，分别是bm(Boyer-Moore)及kmp(Knuth-Pratt-Morris),其中bm算法平均速度会比kmp快，不过，你也不必太在意，因为我们匹配的对象不会太大，因此用哪种都差不多</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--from、--to设置匹配字符串的范围，我们可以使用--from来设置匹配的起点，并以--to来设置匹配的终点，其单位为字节，如--from 10意为从第10个字符串开始匹配，如果没有设置这个参数，那么匹配的范围将是整个数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--string匹配条件，如--string <span class="string">"system32"</span>是指要匹配的字符串为system32</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--hex-string匹配条件，但不同于--string参数的地方在于--hex-string是以16进制的方式进行匹配，特别适合用于非ascii字符串的匹配，其匹配条件的表示方法为--hex-string <span class="string">"|2e2f303132333435|"</span>，请注意实际匹配条件为2e2f303132333435，但其左右要使用<span class="string">"|"</span>符号</span></span><br></pre></td></tr></table></figure>
<h2 id="connlimit模块-匹配连接数"><a href="#connlimit模块-匹配连接数" class="headerlink" title="connlimit模块 匹配连接数"></a>connlimit模块 匹配连接数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp --syn -d $Web_Server --dport 80 -m connlimit --connlimit-above 30 --connlimit-mask 32 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--connlimit-above 指定最大连接数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--connlimit-mask 此参数为子网络掩码，用于匹配范围，例如 8A 16B 24C 25 1/2个c 32代表单一个IP</span></span><br></pre></td></tr></table></figure>
<h2 id="connbytes模块限制每个连接中所能传输的数据量"><a href="#connbytes模块限制每个连接中所能传输的数据量" class="headerlink" title="connbytes模块限制每个连接中所能传输的数据量"></a>connbytes模块限制每个连接中所能传输的数据量</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -p tcp -d $Web_Server --dport 80 -m connbytes --connbytes-dir reply --connbytes-mode bytes --connbytes 20971520: -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--connbytes-dir original来源方向 reply应答方向 both双向</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--connbytes-mode packets以数据包的数量来计算 bytes以数据量来计算</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--connbytes 10:匹配10个以上的单位量 :50匹配50个一下的单位量 10:50匹配10个-50个之间的单位量</span></span><br></pre></td></tr></table></figure>
<h2 id="quota模块-匹配每个ip限制流量（不会清除纪录，要刷新纪录）"><a href="#quota模块-匹配每个ip限制流量（不会清除纪录，要刷新纪录）" class="headerlink" title="quota模块 匹配每个ip限制流量（不会清除纪录，要刷新纪录）"></a>quota模块 匹配每个ip限制流量（不会清除纪录，要刷新纪录）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp --sport 80 -m quota --quota 524288000 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp --sport 80 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="time模块-设置规则生效时间"><a href="#time模块-设置规则生效时间" class="headerlink" title="time模块 设置规则生效时间"></a>time模块 设置规则生效时间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -o eth1 -d $SRV_FARM -m time --weekdays Mon,Tue,Wed,Thu,Fri --timestart 09:00 --timestop 21:00 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -o eth1 -d $SRV_FARM -j DROP </span><br><span class="line"><span class="meta">#</span><span class="bash">--datestart:YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--datestop</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--timestart:hh:mm[:ss]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--timestop</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--monthdays:day[,day]...1,2,3,4,5,6,7,8,9,10,31</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--weekdays:day[,day]...Mon,Tue,Wed,Thu,Fri,Sat,Sun</span></span><br></pre></td></tr></table></figure>
<h2 id="connmark模块匹配mark值（整条连接）"><a href="#connmark模块匹配mark值（整条连接）" class="headerlink" title="connmark模块匹配mark值（整条连接）"></a>connmark模块匹配mark值（整条连接）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m connmark --mark 1 -j DROP </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">conntrack模块匹配数据包状态，是state模块的加强版</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctstate:匹配数据包的状态，状态列表分别为NEW,ESTABLISHED,RELATED,INVALID,DNAT,SNAT</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctproto:用于匹配OSI七层中第四层的通信层，其功能与用法就如同iptables中的-p参数，如-p tcp,-p udp,-p 47等。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigsrc匹配连接发起方向的来源端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigdst匹配连接发起方向的目的端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctreplsrc匹配数据包应答方向的来源端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctrepldst匹配数据包应答方向的目的端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigsrcport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigdstport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctreplsrcport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctrepldstport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctexpire连接在Netfilter Conntrack数据库(/porc/net/nf_conntrack)的存活时间，使用方法如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">匹配特定的存活时间--ctexpire time</span></span><br><span class="line"><span class="meta">#</span><span class="bash">匹配特定区间的存活时间--ctexpire time:time</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--ctdir设置要匹配那个方向的数据包，使用方法如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">只匹配连接发起方向的数据包--ctdir ORIGINAL</span></span><br><span class="line"><span class="meta">#</span><span class="bash">只匹配数据包应答方向的数据包--ctdir REPLY</span></span><br><span class="line"><span class="meta">#</span><span class="bash">若没有设置这个参数，默认会匹配双向的所有数据包</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">iptables -F</span><br><span class="line">modprobe nf_conntrack_ftp</span><br><span class="line">iptables -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -s 192.168.1.0/24 --dport 21 -m state --state NEW -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 21 -j DROP </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">iptables -F</span><br><span class="line">modprobe nf_conntrack_ftp</span><br><span class="line">iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -m conntrack --ctproto tcp --ctorigsrc 192.168.1.0/24 --ctorigdstport 21 --ctstate NEW -j ACCEPT</span><br><span class="line">iptables -A INTPU -p tcp --dport 21 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="statistic模块进行比例匹配"><a href="#statistic模块进行比例匹配" class="headerlink" title="statistic模块进行比例匹配"></a>statistic模块进行比例匹配</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">以随机方式丢弃50%的数据包</span><br><span class="line">iptables -A INPUT -p icmp -m statistic --mode random --probability 0.5 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">按一定规律在每10个icmp包中丢弃1个icmp包</span></span><br><span class="line">iptables -A INPUT -p icmp -m statistic --mode nth --every 10 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">--mode:random以随机方式丢弃数据包，nth按一定规律丢弃数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--probability:此参数需结合random模式使用，例如--probability 0.4 即代表丢弃40%的数据，其中的数值为0-1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--every此参数需结合nth模式使用，例如--every 10代表在每10个数据包中要丢弃1个数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--packet此参数需要在nth模式与--every参数结合使用，例如--every 10 --packet5</span></span><br></pre></td></tr></table></figure>
<h2 id="layer7-–-17"><a href="#layer7-–-17" class="headerlink" title="layer7 – 17"></a>layer7 – 17</h2>
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/防火墙/" rel="tag"># 防火墙</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/27/iptables概念/" rel="next" title="iptables概念">
                <i class="fa fa-chevron-left"></i> iptables概念
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/30/jdyc测试环境搭建/" rel="prev" title="jdyc测试环境搭建">
                jdyc测试环境搭建 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概要
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">180</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">139</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#防火墙概念"><span class="nav-number">1.</span> <span class="nav-text">防火墙概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables概念"><span class="nav-number">2.</span> <span class="nav-text">iptables概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#四表五链"><span class="nav-number">2.1.</span> <span class="nav-text">四表五链</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#状态"><span class="nav-number">2.2.</span> <span class="nav-text">状态</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#规则及语法"><span class="nav-number">3.</span> <span class="nav-text">规则及语法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#语法"><span class="nav-number">3.1.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#規則：匹配標準"><span class="nav-number">3.2.</span> <span class="nav-text">規則：匹配標準</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用命令"><span class="nav-number">3.3.</span> <span class="nav-text">常用命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#動作（target）"><span class="nav-number">3.4.</span> <span class="nav-text">動作（target）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#保存"><span class="nav-number">3.5.</span> <span class="nav-text">保存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#例"><span class="nav-number">4.</span> <span class="nav-text">例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#查看规则"><span class="nav-number">4.1.</span> <span class="nav-text">查看规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试1"><span class="nav-number">4.2.</span> <span class="nav-text">测试1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试2"><span class="nav-number">4.3.</span> <span class="nav-text">测试2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试3"><span class="nav-number">4.4.</span> <span class="nav-text">测试3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#開通服務器的sshd-httpd訪問端口"><span class="nav-number">4.5.</span> <span class="nav-text">開通服務器的sshd, httpd訪問端口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定義規則鏈並在主鏈中被調用"><span class="nav-number">4.6.</span> <span class="nav-text">自定義規則鏈並在主鏈中被調用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用iptables的recent模块来抵御DOS攻击"><span class="nav-number">4.7.</span> <span class="nav-text">利用iptables的recent模块来抵御DOS攻击</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试4"><span class="nav-number">4.8.</span> <span class="nav-text">测试4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源地址转换"><span class="nav-number">4.9.</span> <span class="nav-text">源地址转换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试5"><span class="nav-number">4.10.</span> <span class="nav-text">测试5</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试6"><span class="nav-number">4.11.</span> <span class="nav-text">测试6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目标地址转换"><span class="nav-number">4.12.</span> <span class="nav-text">目标地址转换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables脚本"><span class="nav-number">4.13.</span> <span class="nav-text">iptables脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试7"><span class="nav-number">4.14.</span> <span class="nav-text">测试7</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试8"><span class="nav-number">4.15.</span> <span class="nav-text">测试8</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据指添加"><span class="nav-number">4.16.</span> <span class="nav-text">数据指添加</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mangle表用法-MARK模块匹配（单数据包）"><span class="nav-number">4.17.</span> <span class="nav-text">mangle表用法 MARK模块匹配（单数据包）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理用户或组模块"><span class="nav-number">4.18.</span> <span class="nav-text">管理用户或组模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用iprange模块添加ip范围"><span class="nav-number">4.19.</span> <span class="nav-text">使用iprange模块添加ip范围</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ttl值匹配模块"><span class="nav-number">4.20.</span> <span class="nav-text">ttl值匹配模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPSEC-SPI-值控制模块"><span class="nav-number">4.21.</span> <span class="nav-text">IPSEC SPI 值控制模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pkttype模块"><span class="nav-number">4.22.</span> <span class="nav-text">pkttype模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#length模块"><span class="nav-number">4.23.</span> <span class="nav-text">length模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#limit数据包重复率匹配"><span class="nav-number">4.24.</span> <span class="nav-text">limit数据包重复率匹配</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#recent模块"><span class="nav-number">4.25.</span> <span class="nav-text">recent模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#string模块-匹配字符串"><span class="nav-number">4.26.</span> <span class="nav-text">string模块 匹配字符串</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#connlimit模块-匹配连接数"><span class="nav-number">4.27.</span> <span class="nav-text">connlimit模块 匹配连接数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#connbytes模块限制每个连接中所能传输的数据量"><span class="nav-number">4.28.</span> <span class="nav-text">connbytes模块限制每个连接中所能传输的数据量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#quota模块-匹配每个ip限制流量（不会清除纪录，要刷新纪录）"><span class="nav-number">4.29.</span> <span class="nav-text">quota模块 匹配每个ip限制流量（不会清除纪录，要刷新纪录）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#time模块-设置规则生效时间"><span class="nav-number">4.30.</span> <span class="nav-text">time模块 设置规则生效时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#connmark模块匹配mark值（整条连接）"><span class="nav-number">4.31.</span> <span class="nav-text">connmark模块匹配mark值（整条连接）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#statistic模块进行比例匹配"><span class="nav-number">4.32.</span> <span class="nav-text">statistic模块进行比例匹配</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#layer7-–-17"><span class="nav-number">4.33.</span> <span class="nav-text">layer7 – 17</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
