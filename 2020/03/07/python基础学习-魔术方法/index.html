<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="特殊属性   属性 含义     __name__ 类、函数、方法等的名字   __module__ 类定义所在的模块名   __class__ 对象或类所属的类   __bases__ 类的基类的元组，顺序为它们在基类列表中出现的顺序   __doc__ 类、函数的文档字符串，如果没有定义则为None   __mro__ 类的mro, class.mro()返回的结果保存在__mro__中">
<meta name="keywords" content="python魔术方法">
<meta property="og:type" content="article">
<meta property="og:title" content="python基础学习-魔术方法">
<meta property="og:url" content="http://yoursite.com/2020/03/07/python基础学习-魔术方法/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:description" content="特殊属性   属性 含义     __name__ 类、函数、方法等的名字   __module__ 类定义所在的模块名   __class__ 对象或类所属的类   __bases__ 类的基类的元组，顺序为它们在基类列表中出现的顺序   __doc__ 类、函数的文档字符串，如果没有定义则为None   __mro__ 类的mro, class.mro()返回的结果保存在__mro__中">
<meta property="og:locale" content="zh-TW">
<meta property="og:updated_time" content="2020-04-17T09:32:07.602Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="python基础学习-魔术方法">
<meta name="twitter:description" content="特殊属性   属性 含义     __name__ 类、函数、方法等的名字   __module__ 类定义所在的模块名   __class__ 对象或类所属的类   __bases__ 类的基类的元组，顺序为它们在基类列表中出现的顺序   __doc__ 类、函数的文档字符串，如果没有定义则为None   __mro__ 类的mro, class.mro()返回的结果保存在__mro__中">






  <link rel="canonical" href="http://yoursite.com/2020/03/07/python基础学习-魔术方法/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>python基础学习-魔术方法 | ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/python基础学习-魔术方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">python基础学习-魔术方法
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-03-07 19:53:00" itemprop="dateCreated datePublished" datetime="2020-03-07T19:53:00+08:00">2020-03-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-04-17 17:32:07" itemprop="dateModified" datetime="2020-04-17T17:32:07+08:00">2020-04-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             閱讀次數： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="特殊属性"><a href="#特殊属性" class="headerlink" title="特殊属性"></a>特殊属性</h3><table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__name__</code></td>
<td>类、函数、方法等的名字</td>
</tr>
<tr>
<td><code>__module__</code></td>
<td>类定义所在的模块名</td>
</tr>
<tr>
<td><code>__class__</code></td>
<td>对象或类所属的类</td>
</tr>
<tr>
<td><code>__bases__</code></td>
<td>类的基类的元组，顺序为它们在基类列表中出现的顺序</td>
</tr>
<tr>
<td><code>__doc__</code></td>
<td>类、函数的文档字符串，如果没有定义则为None</td>
</tr>
<tr>
<td><code>__mro__</code></td>
<td>类的<code>mro</code>, <code>class.mro()</code>返回的结果保存在<code>__mro__</code>中</td>
</tr>
<tr>
<td><code>__dict__</code></td>
<td>类或实例的属性，可写的字典</td>
</tr>
</tbody>
</table>
<h3 id="查看属性"><a href="#查看属性" class="headerlink" title="查看属性"></a>查看属性</h3><table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__dir__</code></td>
<td>返回类或者对象的所有成员名称列表。<code>dir()</code>函数就是调用<code>__dir__()</code>。如果提供<code>__dir__()</code>，则返回属性的列表，否则会尽量从<code>__dict__</code>属性中收集信息。</td>
</tr>
</tbody>
</table>
<p>如果<code>dir([obj])</code>参数<code>obj</code>包含方法<code>__dir__()</code>，该方法将被调用。如果参数<code>obj</code>不包含<code>__dir__()</code>，该方法将最大限度地收集参数信息。</p>
<p><code>dir()</code>对于不同类型的对象具有不同的行为：</p>
<p>如果对象是模块对象，返回的列表包含模块的属性名。</p>
<p>如果对象是类型或者类对象，返回的列表包含类的属性名，及它的基类的属性名。</p>
<p>否则，返回列表包含对象的属性名，它的类的属性名和类的基类的属性名。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># animal.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    x = <span class="number">123</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self._name = name</span><br><span class="line">        self.__age = <span class="number">10</span></span><br><span class="line">        self.weight = <span class="number">20</span></span><br><span class="line">print(<span class="string">'animal Module\'s names = &#123;&#125;'</span>.format(dir()))   <span class="comment"># 模块的属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat.py</span></span><br><span class="line"><span class="keyword">import</span> animal</span><br><span class="line"><span class="keyword">from</span> animal <span class="keyword">import</span> Animal</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    x = <span class="string">'cat'</span></span><br><span class="line">    y = <span class="string">'abcd'</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__dir__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'dog'</span>]   <span class="comment"># 必须返回可迭代对象</span></span><br><span class="line">    </span><br><span class="line">print(<span class="string">'------------'</span>)</span><br><span class="line">print(<span class="string">'Current Module\'s names = &#123;&#125;'</span>.format(dir()))   <span class="comment"># 模块名词空间内的属性</span></span><br><span class="line">print(<span class="string">'animal Module\'s names = &#123;&#125;'</span>.format(dir(animal)))   <span class="comment"># 指定模块名词空间内的属性</span></span><br><span class="line">print(<span class="string">"object's __dict__    = &#123;&#125;"</span>.format(sorted(object.__dict__.keys()))) <span class="comment"># object的字典</span></span><br><span class="line">print(<span class="string">"Animal's dir() = &#123;&#125;"</span>.format(dir(Animal))) <span class="comment"># 类Animal的dir()</span></span><br><span class="line">print(<span class="string">"Cat's dir()    = &#123;&#125;"</span>.format(dir(Cat)))   <span class="comment"># 类Cat的dir()</span></span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">tom = Cat(<span class="string">'tome'</span>)</span><br><span class="line">print(sorted(dir(tom))) <span class="comment"># 实例tom的属性、Cat类及所有祖先类的类属性</span></span><br><span class="line">print(sorted(tom.__dir__()))   <span class="comment"># 同上</span></span><br><span class="line"><span class="comment"># dir()的等价，近似如下，__dict__字典中几乎包括了所有属性</span></span><br><span class="line">print(sorted(set(tom.__dict__.keys()) | set(Cat.__dict__.keys()) | set(object.__dict__.keys())))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Dog's dir = &#123;&#125;"</span>.format(dir(Dog)))</span><br><span class="line">dog = Dog(<span class="string">'snoppy'</span>)</span><br><span class="line">print(dir(dog))</span><br><span class="line">print(dog.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行结果</span></span><br><span class="line">animal Module<span class="string">'s names = ['</span>Animal<span class="string">', '</span>__builtins__<span class="string">', '</span>__cached__<span class="string">', '</span>__doc__<span class="string">', '</span>__file__<span class="string">', '</span>__loader__<span class="string">', '</span>__name__<span class="string">', '</span>__package__<span class="string">', '</span>__spec__<span class="string">']</span></span><br><span class="line"><span class="string">-----------------------------------</span></span><br><span class="line"><span class="string">Current Module'</span>s names = [<span class="string">'Animal'</span>, <span class="string">'Cat'</span>, <span class="string">'Dog'</span>, <span class="string">'__annotations__'</span>, <span class="string">'__builtins__'</span>, <span class="string">'__cached__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__file__'</span>, <span class="string">'__loader__'</span>, <span class="string">'__name__'</span>, <span class="string">'__package__'</span>, <span class="string">'__spec__'</span>, <span class="string">'animal'</span>]</span><br><span class="line">animal Module<span class="string">'s names = &lt;module '</span>animal<span class="string">' from '</span>/Users/shouyu/PycharmProjects/test/animal.py<span class="string">'&gt;</span></span><br><span class="line"><span class="string">object'</span>s __dict__  = [<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>]</span><br><span class="line">Animal<span class="string">'s dir() = ['</span>__class__<span class="string">', '</span>__delattr__<span class="string">', '</span>__dict__<span class="string">', '</span>__dir__<span class="string">', '</span>__doc__<span class="string">', '</span>__eq__<span class="string">', '</span>__format__<span class="string">', '</span>__ge__<span class="string">', '</span>__getattribute__<span class="string">', '</span>__gt__<span class="string">', '</span>__hash__<span class="string">', '</span>__init__<span class="string">', '</span>__init_subclass__<span class="string">', '</span>__le__<span class="string">', '</span>__lt__<span class="string">', '</span>__module__<span class="string">', '</span>__ne__<span class="string">', '</span>__new__<span class="string">', '</span>__reduce__<span class="string">', '</span>__reduce_ex__<span class="string">', '</span>__repr__<span class="string">', '</span>__setattr__<span class="string">', '</span>__sizeof__<span class="string">', '</span>__str__<span class="string">', '</span>__subclasshook__<span class="string">', '</span>__weakref__<span class="string">', '</span>x<span class="string">']</span></span><br><span class="line"><span class="string">Cat'</span>s dir()  = [<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>]</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">[<span class="string">'_Animal__age'</span>, <span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>, <span class="string">'_name'</span>, <span class="string">'weight'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>]</span><br><span class="line">[<span class="string">'_Animal__age'</span>, <span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>, <span class="string">'_name'</span>, <span class="string">'weight'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>]</span><br><span class="line">[<span class="string">'_Animal__age'</span>, <span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'_name'</span>, <span class="string">'weight'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>]</span><br><span class="line">Dog<span class="string">'s dir = ['</span>__class__<span class="string">', '</span>__delattr__<span class="string">', '</span>__dict__<span class="string">', '</span>__dir__<span class="string">', '</span>__doc__<span class="string">', '</span>__eq__<span class="string">', '</span>__format__<span class="string">', '</span>__ge__<span class="string">', '</span>__getattribute__<span class="string">', '</span>__gt__<span class="string">', '</span>__hash__<span class="string">', '</span>__init__<span class="string">', '</span>__init_subclass__<span class="string">', '</span>__le__<span class="string">', '</span>__lt__<span class="string">', '</span>__module__<span class="string">', '</span>__ne__<span class="string">', '</span>__new__<span class="string">', '</span>__reduce__<span class="string">', '</span>__reduce_ex__<span class="string">', '</span>__repr__<span class="string">', '</span>__setattr__<span class="string">', '</span>__sizeof__<span class="string">', '</span>__str__<span class="string">', '</span>__subclasshook__<span class="string">', '</span>__weakref__<span class="string">', '</span>x<span class="string">']</span></span><br><span class="line"><span class="string">['</span>dog<span class="string">']</span></span><br><span class="line"><span class="string">&#123;'</span>_name<span class="string">': '</span>snoppy<span class="string">', '</span>_Animal__age<span class="string">': 10, '</span>weight<span class="string">': 20&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="魔法方法"><a href="#魔法方法" class="headerlink" title="魔法方法 ***"></a>魔法方法 ***</h3><ul>
<li>分类<ul>
<li>创建、初始化与销毁<ul>
<li><code>__init__</code>与<code>__del__</code></li>
</ul>
</li>
<li>hash</li>
<li>bool</li>
<li>可视化</li>
<li>运算符重载</li>
<li>容器和大小</li>
<li>可调用对象</li>
<li>上下文管理</li>
<li>反射</li>
<li>描述器</li>
<li>其他杂项</li>
</ul>
</li>
</ul>
<h3 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h3><table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__hash__</code></td>
<td>内建函数<code>hash()</code>调用的返回值，返回一个整数。如果定义了这个方法，该类的实例就可hash。</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line">    </span><br><span class="line">print(hash(A(<span class="string">'tom'</span>)))</span><br><span class="line">print(A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>))</span><br><span class="line">print([A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>)])</span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">s = &#123;A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>)&#125;   <span class="comment"># set</span></span><br><span class="line">print(s)   <span class="comment"># 去重了吗，没有</span></span><br><span class="line">print(&#123;tuple(<span class="string">'t'</span>), tuple(<span class="string">'t'</span>)&#125;)</span><br><span class="line">print(&#123;(<span class="string">'tom'</span>,), (<span class="string">'tom'</span>,)&#125;)</span><br><span class="line">print(&#123;<span class="string">'tom'</span>, <span class="string">'tom'</span>&#125;)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line">tom tom</span><br><span class="line">[tom, tom]</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">&#123;tom, tom&#125;</span><br><span class="line">&#123;(<span class="string">'t'</span>,)&#125;</span><br><span class="line">&#123;(<span class="string">'tom'</span>,)&#125;</span><br><span class="line">&#123;<span class="string">'tom'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>上例中<code>set</code>为什么不能剔除相同的<code>key</code>？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span>   <span class="comment"># 这个函数作用？</span></span><br><span class="line">        <span class="keyword">return</span> self.name == other.name</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line">    </span><br><span class="line">print(hash(A(<span class="string">'tom'</span>)))</span><br><span class="line">print((A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>)))</span><br><span class="line">print([A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>)])</span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">s = &#123;A(<span class="string">'tom'</span>), A(<span class="string">'tom'</span>)&#125;   <span class="comment"># set</span></span><br><span class="line">print(s)</span><br><span class="line">print(&#123;tuple(<span class="string">'t'</span>), tuple(<span class="string">'t'</span>)&#125;)</span><br><span class="line">print(&#123;(<span class="string">'tom'</span>,), (<span class="string">'tom'</span>,)&#125;)</span><br><span class="line">print(&#123;<span class="string">'tom'</span>, <span class="string">'tom'</span>&#125;)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line">tom tom</span><br><span class="line">[tom, tom]</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">&#123;tom&#125;</span><br><span class="line">&#123;(<span class="string">'t'</span>,)&#125;</span><br><span class="line">&#123;(<span class="string">'tom'</span>,)&#125;</span><br><span class="line">&#123;<span class="string">'tom'</span>&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__eq__</code></td>
<td>对应<code>==</code>操作符，判断2个对象是否相等，返回<code>bool</code>值</td>
</tr>
</tbody>
</table>
<p><code>__hash__</code>方法只是返回一个hash值作为<code>set</code>的<code>key</code>，但是<code>去重</code>，还需要<code>__eq__</code>来判断2个对象是否相等。</p>
<p>hash值相等，只是hash冲突，不能说明两个对象是相等的。</p>
<p>因此，一般来说提供<code>__hash__</code>方法是为了作为<code>set</code>或者<code>dict</code>的<code>key</code>，所以<code>去重</code>要同时提供<code>__eq__</code>方法。</p>
<p>不可hash对象<code>isinstance(p1, collections.Hashable)</code>一定为False。</p>
<p><code>去重</code>需要提供<code>__eq__</code>方法。</p>
<p>思考：</p>
<p>list类实例为什么不可hash？</p>
<p>练习</p>
<p>设计二维坐标类Point，使其成为可hash类型，并比较2个坐标的实例是否相等？</p>
<p>list类实例为什么不可hash</p>
<p>源码中有一句<code>__hash__ = None</code>，也就是如果调用<code>__hash__()</code>相当于<code>None()</code>，一定报错。所有类都继承<code>object</code>，而这个类是具有<code>__hash__()</code>方法的，如果一个类不能被hash，就把<code>__hash__</code>设置为<code>None</code>。</p>
<p>练习参考</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Hashable</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> hash((self.x, self.y))</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        print(<span class="string">'*'</span>*<span class="number">100</span>)</span><br><span class="line">        print(self.x, self.y, other.x, other.y)</span><br><span class="line"><span class="comment"># 调用这个方法时，如print(p1 == p2)，这里的p1就是self，p2就是other</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">p2 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(hash(p1))</span><br><span class="line">print(hash(p2))</span><br><span class="line"></span><br><span class="line">print(p1 <span class="keyword">is</span> p2)</span><br><span class="line">print(p1 == p2)   <span class="comment"># True使用__eq__</span></span><br><span class="line">print(hex(id(p1)), hex(id(p2)))</span><br><span class="line">print(set((p1, p2)))</span><br><span class="line">print(isinstance(p1, Hashable))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">-1009709641759730766</span></span><br><span class="line"><span class="number">-1009709641759730766</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="number">0x10a336b20</span> <span class="number">0x10a336880</span></span><br><span class="line">&#123;&lt;__main__.Point object at <span class="number">0x10a336b20</span>&gt;&#125;</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<h3 id="bool"><a href="#bool" class="headerlink" title="bool"></a>bool</h3><table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__bool__</code></td>
<td>内建函数<code>bool()</code>，或者对象放在逻辑表达式的位置，调用这个函数返回布尔值。没有定义<code>__bool__()</code>，就找<code>__len__()</code>返回长度，非0为真。如果<code>__len__()</code>也没有定义，那么所有实例都返回真。</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 因为没有定义bool或len方法，所以返回全为真</span></span><br><span class="line">print(bool(A()))</span><br><span class="line"><span class="keyword">if</span> A():  </span><br><span class="line">    print(<span class="string">'Real A'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bool__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    </span><br><span class="line">print(bool(B))</span><br><span class="line">print(bool(B()))</span><br><span class="line"><span class="keyword">if</span> B():</span><br><span class="line">    print(<span class="string">'Real B'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">print(bool(C()))</span><br><span class="line"><span class="keyword">if</span> C():</span><br><span class="line">    print(<span class="string">'Real C'</span>)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line">Real A</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<h3 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h3><table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__repr__</code></td>
<td>内建函数<code>repr()</code>对一个对象获取字符串表达。调用<code>__repr__</code>方法返回字符串表达，如果<code>__repr__</code>也没有定义，就直接返回<code>object</code>的定义就是显示内存地址信息</td>
</tr>
<tr>
<td><code>__str__</code></td>
<td><code>str()</code>函数、内建函数<code>format()</code>、<code>print()</code>函数调用，需要返回对象的字符串表达。如果没有定义，就去调用<code>__repr__</code>方法返回字符串表达，如果<code>__repr__</code>没有定义，就直接返回对象的内存地址信息</td>
</tr>
<tr>
<td><code>__bytes__</code></td>
<td><code>bytes()</code>函数调用，返回一个对象的<code>bytes</code>表达，即返回<code>bytes</code>对象</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'repr: &#123;&#125;,&#123;&#125;'</span>.format(self.name, self.age)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'str: &#123;&#125;,&#123;&#125;'</span>.format(self.name, self.age)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bytes__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># return "&#123;&#125; is &#123;&#125;".format(self.name, self.age).encode()</span></span><br><span class="line">        <span class="keyword">import</span> json</span><br><span class="line">        <span class="keyword">return</span> json.dumps(self.__dict__).encode()</span><br><span class="line">    </span><br><span class="line">print(A(<span class="string">'tom'</span>))   <span class="comment"># print函数使用__str__</span></span><br><span class="line">print([A(<span class="string">'tom'</span>)])   <span class="comment"># []使用__str__，但其内部使用__repr__</span></span><br><span class="line">print(([str(A(<span class="string">'tom'</span>))]))   <span class="comment"># []使用__str__，str()函数也使用__str__</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'str:a,1'</span>)   <span class="comment"># 字符串直接输出没有引号</span></span><br><span class="line">s = <span class="string">'1'</span></span><br><span class="line">print(s)</span><br><span class="line">print([<span class="string">'a'</span>],(s,))   <span class="comment"># 字符串在基本数据类型内部输出有引号</span></span><br><span class="line">print(&#123;s, <span class="string">'a'</span>&#125;)</span><br><span class="line"></span><br><span class="line">print(bytes(A(<span class="string">'tom'</span>)))</span><br><span class="line">输出：</span><br><span class="line">str: tom,<span class="number">18</span></span><br><span class="line">[repr: tom,<span class="number">18</span>]</span><br><span class="line">[<span class="string">'str: tom,18'</span>]</span><br><span class="line">str:a,<span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">[<span class="string">'a'</span>] (<span class="string">'1'</span>,)</span><br><span class="line">&#123;<span class="string">'1'</span>, <span class="string">'a'</span>&#125;</span><br><span class="line"><span class="string">b'tom is 18'</span></span><br></pre></td></tr></table></figure>
<h3 id="运算符重载"><a href="#运算符重载" class="headerlink" title="运算符重载"></a>运算符重载</h3><p><code>operator</code>模块提供以下的特殊方法，可以将类的实例使用下面的操作符来操作</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>特殊方法</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt;, &lt;=, ==, &gt;, &gt;=, !=</td>
<td><code>__lt__</code>, <code>__le__</code>, <code>__eq__</code>, <code>__gt__</code>, <code>__ge__</code>, <code>__ne__</code></td>
<td>比较运算符</td>
</tr>
<tr>
<td>+, -, *, /, %, //, **, divmod</td>
<td><code>__add__</code>, <code>__sub__</code>, <code>__mul__</code>, <code>__truediv__</code>, <code>__mod__</code>, <code>__floordiv__</code>, <code>__pow__</code>, <code>__divmod__</code></td>
<td>算术运算符，移位、位运算也有对应的方法</td>
</tr>
<tr>
<td>+=, -=, *=, /=, %=, //=, **=</td>
<td><code>__iadd__</code>, <code>__isub__</code>, <code>__imul__</code>, <code>__itruediv__</code>, <code>__imod__</code>, <code>__ifloordiv__</code>, <code>__ipow__</code></td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=<span class="number">18</span>)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age - other.age</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__isub__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> A(self.name, self - other)</span><br><span class="line">    </span><br><span class="line">tom = A(<span class="string">'tom'</span>)</span><br><span class="line">jerry = A(<span class="string">'jerry'</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">print(tom - jerry)</span><br><span class="line">print(jerry - tom, jerry.__sub__(tom))</span><br><span class="line"></span><br><span class="line">print(id(tom))</span><br><span class="line">tom -= jerry</span><br><span class="line">print(tom.age, id(tom))</span><br></pre></td></tr></table></figure>
<p>练习：</p>
<p>完成<code>Point</code>类设计，实现判断点相等的方法，并完成向量的加法。</p>
<p>在直角坐标系里面，定义原点为向量的起点。两个向量和与差的坐标分别等于这两个向量相应坐标的和与差若向量的表示为<code>(x,y)</code>形式，<code>A(X1, Y1) B(X2, Y2)</code>，则<code>A+B=(X1+X2, Y1+Y2), A-B=(X1-X2, Y1-Y2)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Point(self.x + other.x, self.y + other.y)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (self.x + other.x, self.y + other.y)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;Point: &#123;&#125;,&#123;&#125;'</span>.format(self.x, self.y)</span><br><span class="line">    </span><br><span class="line">p1 = Point(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">p2 = Point(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">points = (p1, p2)</span><br><span class="line">print(points[<span class="number">0</span>].add(points[<span class="number">1</span>]))</span><br><span class="line"><span class="comment"># add方法就是运算符重载</span></span><br><span class="line">print(points[<span class="number">0</span>] + points[<span class="number">1</span>])</span><br><span class="line">print(p1 == p2)</span><br></pre></td></tr></table></figure>
<h4 id="运算符重载应用场景"><a href="#运算符重载应用场景" class="headerlink" title="运算符重载应用场景"></a>运算符重载应用场景</h4><p>往往是用面向对象实现的类，需要做大量的运算，而运算符是这种运算在数学上最常见的表达方式。例如，上例中的对<code>+</code>进行了运算符重载，实现了<code>Point</code>类的二元操作，重新定义为<code>Point + Point</code>。</p>
<p>提供运算符重载，比直接提供加法方法要更加适合该领域内使用者的习惯。</p>
<p><code>int</code>类，几乎实现了所有操作符，可以作为参考。</p>
<h3 id="functools-total-ordering-装饰器"><a href="#functools-total-ordering-装饰器" class="headerlink" title="@functools.total_ordering 装饰器"></a>@functools.total_ordering 装饰器</h3><p><code>__lt__</code>, <code>__le__</code>, <code>__eq__</code>, <code>__gt__</code>, <code>__ge__</code>是比较大小必须实现的方法，但是全部写完太麻烦，使用<a href="mailto:`@functools.tota" target="_blank" rel="noopener">`@functools.tota</a>l_ordering`装饰器就可以大大简化代码。</p>
<p>但是要求<code>__eq__</code>必须实现，其它方法<code>__lt__</code>, <code>__le__</code>, <code>__gt__</code>, <code>__ge__</code>实现其一</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> total_ordering</span><br><span class="line"></span><br><span class="line"><span class="meta">@total_ordering</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age == other.age</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age &gt; other.age</span><br><span class="line">    </span><br><span class="line">tom = Person(<span class="string">'tom'</span>, <span class="number">20</span>)</span><br><span class="line">jerry = Person(<span class="string">'jerry'</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">print(tom &gt; jerry)</span><br><span class="line">print(tom &lt; jerry)</span><br><span class="line">print(tom &gt;= jerry)</span><br><span class="line">print(tom &lt;= jerry)</span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>上例中大大简化代码，但是一般来说比较实现等于或者小于方法也就够了，其它可以不实现，所以这个装饰器只是看着很美好，且可能会带来性能问题，建议需要什么方法就自己创建，少用这个装饰器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age == other.age</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age &gt; other.age</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__ge__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.age &gt;= other.age</span><br><span class="line">    </span><br><span class="line">tom = Person(<span class="string">'tom'</span>, <span class="number">20</span>)</span><br><span class="line">jerry = Person(<span class="string">'jerry'</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">print(tom &gt; jerry)</span><br><span class="line">print(tom &lt; jerry)</span><br><span class="line">print(tom &gt;= jerry)</span><br><span class="line">print(tom &lt;= jerry)</span><br><span class="line"></span><br><span class="line">print(tom == jerry)</span><br><span class="line">print(tom != jerry)</span><br></pre></td></tr></table></figure>
<h3 id="容器相关方法"><a href="#容器相关方法" class="headerlink" title="容器相关方法"></a>容器相关方法</h3><table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__len__</code></td>
<td>内建函数<code>len()</code>，返回对象的长度（&gt;=0的整数），如果把对象当做容器类型看，就如同list或者dict。<code>bool()</code>函数调用的时候，如果没有<code>__bool__()</code>方法，则会看<code>__len__()</code>方法是否存在，存在返回非0为真</td>
</tr>
<tr>
<td><code>__iter__</code></td>
<td>迭代容器时，调用，返回一个新的迭代器对象</td>
</tr>
<tr>
<td><code>__contains__</code></td>
<td><code>in</code>成员运算符，没有实现，就调用<code>__iter__</code>方法遍历</td>
</tr>
<tr>
<td><code>__getitem__</code></td>
<td>实现<code>self[key]</code>访问。序列对象，<code>key</code>接受整数为索引，或者切片。对于set和dict，key为hashable。key不存在引发KeyError异常</td>
</tr>
<tr>
<td><code>__setitem__</code></td>
<td>和<code>__getitem__</code>的访问类似，是设置值的方法</td>
</tr>
<tr>
<td><code>__missing__</code></td>
<td>字典或其子类使用<code>__getitem__()</code>调用时，key不存在执行该方法</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(dict)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__missing__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        print(<span class="string">'Missing key :'</span>, key)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">a = A()</span><br><span class="line">print(a[<span class="string">'k'</span>])</span><br><span class="line">输出：</span><br><span class="line">Missing key : k</span><br><span class="line"><span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p>思考</p>
<p>为什么空字典、空字符串、空元组、空集合、空列表等可以等效为False？</p>
<p>练习</p>
<p>将购物车类改造成方便操作的容器类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cart</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.items = []</span><br><span class="line"><span class="comment"># 在初始化时自定义self.items = []，这样就定义了一个列表，之后用self.items就可以打印整个列表，self.items.append()可以向列表中添加内容。     </span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">additem</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        self.items.append(item)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> iter(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span>   <span class="comment"># 索引访问</span></span><br><span class="line">        <span class="keyword">return</span> self.items[index]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span>   <span class="comment"># 索引赋值</span></span><br><span class="line">        self.items[key] = value</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span> <span class="comment"># +</span></span><br><span class="line">        self.items.append(other)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">cart = Cart()</span><br><span class="line">cart.additem(<span class="number">1</span>)</span><br><span class="line">cart.additem(<span class="string">'abc'</span>)</span><br><span class="line">cart.additem(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 长度、bool</span></span><br><span class="line">print(len(cart))</span><br><span class="line">print(bool(cart))</span><br><span class="line">print(cart)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 迭代</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> cart:</span><br><span class="line">    print(x)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># in</span></span><br><span class="line">print(<span class="number">3</span> <span class="keyword">in</span> cart)</span><br><span class="line">print(<span class="number">2</span> <span class="keyword">in</span> cart)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引操作</span></span><br><span class="line">print(cart[<span class="number">1</span>])</span><br><span class="line">cart[<span class="number">1</span>] = <span class="string">'xyz'</span></span><br><span class="line">print(cart)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链式编程实现加法</span></span><br><span class="line">print(cart + <span class="number">4</span> + <span class="number">5</span> + <span class="number">6</span>)</span><br><span class="line">print(cart.__add__(<span class="number">17</span>).__add__(<span class="number">18</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line">[<span class="number">1</span>, <span class="string">'abc'</span>, <span class="number">3</span>]</span><br><span class="line"><span class="number">1</span></span><br><span class="line">abc</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line">abc</span><br><span class="line">[<span class="number">1</span>, <span class="string">'xyz'</span>, <span class="number">3</span>]</span><br><span class="line">[<span class="number">1</span>, <span class="string">'xyz'</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">[<span class="number">1</span>, <span class="string">'xyz'</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">17</span>, <span class="number">18</span>]</span><br></pre></td></tr></table></figure>
<h3 id="可调用对象"><a href="#可调用对象" class="headerlink" title="可调用对象"></a>可调用对象</h3><p>Python中一切皆对象，函数也不例外。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(foo.__module__, foo.__name__)</span><br><span class="line">    </span><br><span class="line">foo()</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">foo.__call__()</span><br><span class="line">输出：</span><br><span class="line">__main__ foo</span><br><span class="line">__main__ foo</span><br></pre></td></tr></table></figure>
<p>函数即对象，对象<code>foo</code>加上<code>()</code>，就是调用对象的<code>__call__()</code>方法</p>
<p>可调用对象</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__call__</code></td>
<td>类中定义一个该方法，实例就可以像函数一样调用</td>
</tr>
</tbody>
</table>
<p>可调用对象：定义一个类，并实例化得到其实例，将实例像函数一样调用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;Point &#123;&#125;:&#123;&#125;&gt;"</span>.format(self.x, self.y)</span><br><span class="line">    </span><br><span class="line">p = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p)</span><br><span class="line">print(p())</span><br><span class="line">输出：</span><br><span class="line">&lt;__main__.Point object at <span class="number">0x7fd3b9770a90</span>&gt;</span><br><span class="line">&lt;Point <span class="number">4</span>:<span class="number">5</span>&gt;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Adder</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">        ret = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> args:</span><br><span class="line">            ret += x</span><br><span class="line">        self.ret = ret</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    </span><br><span class="line">adder = Adder()</span><br><span class="line">print(adder(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line">print(adder.ret)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">15</span></span><br></pre></td></tr></table></figure>
<p>练习：</p>
<p>定义一个斐波那契数列的类，方便调用，计算第n项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fib</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.items = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">'Wrong Index'</span>)</span><br><span class="line">        <span class="keyword">if</span> index &lt; len(self.items):</span><br><span class="line">            <span class="keyword">return</span> self.items[index]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>, index+<span class="number">1</span>):</span><br><span class="line">            self.items.append(self.items[i<span class="number">-1</span>] + self.items[i<span class="number">-2</span>])</span><br><span class="line">     	<span class="keyword">return</span> self.items[index]</span><br><span class="line">    </span><br><span class="line">print(Fib()(<span class="number">100</span>))</span><br></pre></td></tr></table></figure>
<p>上例中，增加迭代的方法、返回容器长度、支持索引的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fib</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.items = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self[index]</span><br><span class="line"><span class="comment"># 当使用fib(5)，这样调用时，但调用call方法，之后会返回self[index]，self[index]会调用getitem方法，返回实际的数字    </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> iter(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">'Wrong Index'</span>)</span><br><span class="line">        <span class="keyword">if</span> index &lt; len(self.items):</span><br><span class="line">            <span class="keyword">return</span> self.items[index]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(self), index+<span class="number">1</span>):</span><br><span class="line">            self.items.append(self.items[i<span class="number">-1</span>] + self.items[i<span class="number">-2</span>])</span><br><span class="line">        <span class="keyword">return</span> self.items[index]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.items)</span><br><span class="line">    </span><br><span class="line">    __repr__ = __str__</span><br><span class="line">    </span><br><span class="line">fib = Fib()</span><br><span class="line">print(fib(<span class="number">5</span>), len(fib))   <span class="comment"># 全部计算</span></span><br><span class="line">print(fib(<span class="number">10</span>), len(fib))   <span class="comment"># 部分计算</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> fib:</span><br><span class="line">    print(x)</span><br><span class="line">print(fib[<span class="number">5</span>], fib[<span class="number">6</span>])  <span class="comment"># 索引访问 ，不计算。使用索引直接调用__getitem__方法，计算出索引位置的值。</span></span><br></pre></td></tr></table></figure>
<p>可以看出使用类来实现斐波那契数列也是非常好的实现，还可以缓存数据，便于检索。</p>
<h3 id="上下文管理"><a href="#上下文管理" class="headerlink" title="上下文管理"></a>上下文管理</h3><p>文件IO操作可以对文件对象使用上下文管理，使用<code>with...as</code>语法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'test'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>依照上例写一个自己的类，实现上下文管理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> p:   <span class="comment">#  AttributeError: __exit__</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>提示属性错误，没有<code>__exit__</code>，看来需要这个属性</p>
<h3 id="上下文管理对象"><a href="#上下文管理对象" class="headerlink" title="上下文管理对象"></a>上下文管理对象</h3><p>当一个对象同时实现了<code>__enter__()</code>和<code>__exit__()</code>方法，它就属于上下文管理的对象</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__enter__</code></td>
<td>进入与此对象相关的上下文 。如果存在该方法，<code>with</code>语法会把该方法的返回值绑定到<code>as</code>子句中指定的变量上</td>
</tr>
<tr>
<td><code>__exit__</code></td>
<td>退出与此对象相关的上下文</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> f:</span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br></pre></td></tr></table></figure>
<p>实例化对象的时候，并不会调用<code>enter</code>，进入<code>with</code>语句块应用<code>__enter__</code>方法，然后执行语句体，最后离开<code>with</code>语句块的时候，调用<code>__exit__</code>方法。</p>
<p><code>with</code>可以开启一个上下文运行环境，在执行前做一些准备工作，执行后做一些收尾工作。</p>
<h3 id="上下文管理的安全性"><a href="#上下文管理的安全性" class="headerlink" title="上下文管理的安全性"></a>上下文管理的安全性</h3><p>看看异常对上下文的影响</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">'error'</span>)</span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># init</span></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure>
<p>可以看出在<code>enter</code>和<code>exit</code>照样执行，上下文管理是安全的。</p>
<p>极端的例子</p>
<p>调用<code>sys.exit()</code>，它会退出当前解释器。</p>
<p>打开Python解释器，在里面敲入<code>sys.exit()</code>，窗口直接关闭了。也就是说碰到这一句，Python运行环境直接退出了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> f:</span><br><span class="line">    sys.exit(<span class="number">-100</span>)</span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br><span class="line">    </span><br><span class="line">print(<span class="string">'outer'</span>)</span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">enter</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p>从执行结果来看，依然执行了<code>__exit__</code>函数，哪怕是退出Python运行环境。</p>
<p>说明<strong>上下文管理很安全</strong></p>
<h3 id="with语句"><a href="#with语句" class="headerlink" title="with语句"></a>with语句</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:</span><br><span class="line">    print(p == f)  <span class="comment"># 为什么不相等</span></span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br></pre></td></tr></table></figure>
<p>问题在于<code>__enter__</code>方法上，它将自己的返回值赋给<code>f</code>。修改上例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:</span><br><span class="line">    print(p == f)</span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br></pre></td></tr></table></figure>
<p><code>__enter__</code>方法返回值就是上下文中使用的对象，<code>with</code>语法会把它的返回值赋给<code>as</code>子句的变量。</p>
<h3 id="enter-方法和-exit-方法的参数"><a href="#enter-方法和-exit-方法的参数" class="headerlink" title="__enter__方法和__exit__方法的参数"></a><code>__enter__</code>方法和<code>__exit__</code>方法的参数</h3><p><code>__enter__</code>方法没有其他参数。</p>
<p><code>__exit__</code>方法有3个参数：</p>
<p><code>__exit__(self, exc_type, exc_value, traceback)</code></p>
<p>这三个参数都与异常有关。</p>
<p>如果该上下文退出时没有异常，这3个参数都为None。</p>
<p>如果有异常，参数意义如下</p>
<p><code>exc_type</code>，异常类型</p>
<p><code>exc_value</code>，异常的值</p>
<p><code>traceback</code>，异常的追踪信息</p>
<p><code>__exit__</code>方法返回一个等效True的值，则压制异常；否则，继续抛出异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(exc_type)</span><br><span class="line">        print(exc_val)</span><br><span class="line">        print(exc_tb)</span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"abc"</span></span><br><span class="line">    </span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">'New Error'</span>)</span><br><span class="line">    print(<span class="string">'do sth.'</span>)</span><br><span class="line">    </span><br><span class="line">print(<span class="string">'outer'</span>)</span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">enter</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">Exception</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">New</span> <span class="title">Error</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">traceback</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x7f8171ce62c0</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">exit</span></span></span><br><span class="line"><span class="class"><span class="title">outer</span></span></span><br></pre></td></tr></table></figure>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p>为加法函数计时</p>
<p>方法1，使用装饰器显示该函数的执行时长</p>
<p>方法2，使用上下文管理方法来显示该函数的执行时长</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
<p>装饰器实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeit</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">'&#123;&#125; took &#123;&#125;s'</span>.format(fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@timeit</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span>   <span class="comment"># timeit(add)</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">输出：</span><br><span class="line">add took <span class="number">2.002056</span>s</span><br><span class="line"><span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>上下文实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeit</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">'&#123;&#125; took &#123;&#125;s'</span>.format(fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@timeit</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self.fn</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">"&#123;&#125; took &#123;&#125;s"</span>.format(self.fn.__name__, delta))</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> Timeit(add) <span class="keyword">as</span> fn:</span><br><span class="line">    <span class="comment"># print(fn(4, 6))</span></span><br><span class="line">    print(add(<span class="number">4</span>, <span class="number">7</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">11</span></span><br><span class="line">add took <span class="number">2.001579</span>s</span><br></pre></td></tr></table></figure>
<p>另一种实现，使用可调用对象实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeit</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">'&#123;&#125; took &#123;&#125;s'</span>.format(fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@timeit</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">"&#123;&#125; took &#123;&#125;s"</span>.format(self.fn.__name__, delta))</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        print(x, y)</span><br><span class="line">        <span class="keyword">return</span> self.fn(x, y)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> Timeit(add) <span class="keyword">as</span> timeitobj:</span><br><span class="line">    print(timeitobj(<span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line">输出：</span><br><span class="line"><span class="number">5</span> <span class="number">6</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line">add took <span class="number">2.001707</span>s</span><br></pre></td></tr></table></figure>
<p>根据上面的代码，能不能把类当做装饰器用？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeIt</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        self.delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">'&#123;&#125; took &#123;&#125;s. context'</span>.format(self.fn.__name__, self.delta))</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(Self, *args, **kwargs)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        ret = self.fn(*args, **kwargs)</span><br><span class="line">        self.delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">'&#123;&#125; took &#123;&#125;s. call'</span>.format(self.fn.__name__, self.delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    </span><br><span class="line"><span class="meta">@TimeIt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="string">"""This is add function."""</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(add.__doc__)</span><br><span class="line">输出：</span><br><span class="line">add took <span class="number">2.001804</span>s. call</span><br><span class="line"><span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p>思考</p>
<p>如何解决文档字符串问题？</p>
<p>方法一</p>
<p>直接修改<code>__doc__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeIt</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn=None)</span>:</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        <span class="comment"># 把函数对象的文档字符串赋给类</span></span><br><span class="line">        self.__doc__ = fn.__doc__</span><br></pre></td></tr></table></figure>
<p>方法二</p>
<p>使用<code>functools.wraps</code>函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps, update_wrapper</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="string">"""This is A Class"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        <span class="comment"># 把函数对象的文档字符串赋给类</span></span><br><span class="line">        <span class="comment"># self.__doc__ = fn.__doc__</span></span><br><span class="line">        <span class="comment"># update_wrapper(self, fn)</span></span><br><span class="line">        wraps(fn)(self)  <span class="comment"># 这是什么意思？</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">"&#123;&#125; took &#123;&#125;s. context"</span>.format(self.fn.__name__, delta))</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        ret = self.fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">"&#123;&#125; took &#123;&#125;s. call"</span>.format(self.fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Timeit</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="string">"""This is add function."""</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">10</span>, <span class="number">5</span>))</span><br><span class="line">print(add.__doc__)</span><br><span class="line"></span><br><span class="line">print(Timeit(add).__doc__)</span><br><span class="line">输出：</span><br><span class="line">add took <span class="number">2.002079</span>s. call</span><br><span class="line"><span class="number">15</span></span><br><span class="line">This <span class="keyword">is</span> add function.</span><br><span class="line">This <span class="keyword">is</span> add function.</span><br></pre></td></tr></table></figure>
<p>上面的类即可以用在上下文管理，又可以用做装饰器</p>
<h3 id="上下文应用场景"><a href="#上下文应用场景" class="headerlink" title="上下文应用场景"></a>上下文应用场景</h3><ol>
<li><p>增强功能</p>
<p>在代码执行的前后增加代码，以增强其功能。类似装饰器的功能。</p>
</li>
<li><p>资源管理</p>
<p>打开了资源需要关闭，例如文件对象、网络连接、数据库连接等</p>
</li>
<li><p>权限验证</p>
<p>在执行代码之前，做权限的验证，在<code>__enter__</code>中处理</p>
</li>
</ol>
<h3 id="contextlib-contextmanager"><a href="#contextlib-contextmanager" class="headerlink" title="contextlib.contextmanager"></a>contextlib.contextmanager</h3><p><code>contextlib.contextmanager</code></p>
<p>它是一个装饰器实现上下文管理，装饰一个函数，而不用像类一样实现<code>__enter__</code>和<code>__exit__</code>方法。</p>
<p>对下面的函数有要求，必须有<code>yield</code>，也就是这个函数必须返回一个生成器，且只有<code>yield</code>一个值。也就是这个装饰器接收一个生成器对象作为参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'enter'</span>)   <span class="comment"># 相当于__enter__()</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="comment"># yield 5，yield的值只能有一个，作为__enter__方法的返回值</span></span><br><span class="line">    print(<span class="string">'exit'</span>)  <span class="comment"># 相当于__exit__()</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> foo() <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># raise Exception()</span></span><br><span class="line">    print(f)</span><br><span class="line">输出：</span><br><span class="line">enter</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p><code>f</code>接收<code>yield</code>语句的返回值</p>
<p>上面的程序看似不错，但是，增加一个异常试一试，发现不能保证<code>exit</code>的执行，怎么办？</p>
<p>增加<code>try finally</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'enter'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span>   <span class="comment"># yield 5，yield的值只能有一个，作为__enter__方法的返回值</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> foo() <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">raise</span> Exception()</span><br><span class="line">    print(f)</span><br></pre></td></tr></table></figure>
<p>上例这么做有什么意义呢？</p>
<p>当<code>yield</code>发生处为生成器函数增加了上下文管理。这是为函数增加上下文机制的方式。</p>
<ul>
<li>把<code>yield</code>之前的当做<code>__enter__</code>方法执行</li>
<li>把<code>yield</code>之后的当做<code>__exit__</code>方法执行</li>
<li>把<code>yield</code>的值作为<code>__enter__</code>的返回值</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span>   <span class="comment"># 为生成器函数增加了上下文管理</span></span><br><span class="line">    start = datetime.datetime.now()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> x + y  <span class="comment"># yield 5，yield的值只能有一个，作为__enter__方法的返回值</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(delta)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> add(<span class="number">4</span>, <span class="number">5</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># raise Exception()</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(f)</span><br></pre></td></tr></table></figure>
<p>总结</p>
<p>如果业务逻辑简单可以使用函数加<code>contextlib.contextmanager</code>装饰器方式，如果业务复杂，用类的方式加<code>__enter__</code>和<code>__exit__</code>方法方便。</p>
<h3 id="反射概述"><a href="#反射概述" class="headerlink" title="反射概述"></a>反射概述</h3><p>运行时，区别于编译时，指的是程序被加载到内存中执行的时候。</p>
<p>反射，reflection，指的是运行时获取类型定义信息。</p>
<p>一个对象能够在运行时，像照镜子一样，反射出其类型信息。</p>
<p>简单说，在Python中，能够通过一个对象，找出其<code>type</code>、<code>class</code>、<code>attribute</code>或<code>method</code>的能力，称为反射或者自省。</p>
<p>具有反射能力的函数有：<code>type()</code>、<code>isinstance()</code>、<code>callable()</code>、<code>dir()</code>、<code>getattr()</code></p>
<h3 id="反射相关的函数和方法"><a href="#反射相关的函数和方法" class="headerlink" title="反射相关的函数和方法"></a>反射相关的函数和方法</h3><p>需求</p>
<p>有一个Point类，查看它实例的属性，并修改它。动态为实例增加属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Point(&#123;&#125;, &#123;&#125;)"</span>.format(self.x, self.y)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line">        </span><br><span class="line">p = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p)</span><br><span class="line">print(p.__dict__)</span><br><span class="line">p.__dict__[<span class="string">'y'</span>] = <span class="number">16</span></span><br><span class="line">print(p.__dict__)</span><br><span class="line">p.z = <span class="number">10</span></span><br><span class="line">print(p.__dict__)</span><br><span class="line">print(dir(p))  <span class="comment"># ordered list</span></span><br><span class="line">print(sorted(p.__dir__())) <span class="comment"># list</span></span><br><span class="line">输出：</span><br><span class="line">Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">5</span>&#125;</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">16</span>&#125;</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">16</span>, <span class="string">'z'</span>: <span class="number">10</span>&#125;</span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>, <span class="string">'show'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]</span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dict__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__module__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'__weakref__'</span>, <span class="string">'show'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]</span><br></pre></td></tr></table></figure>
<p>上例通过属性字典<code>__dict__</code>来访问对象的属性，本质上也是利用的反射的能力。</p>
<p>但是，上面的例子中，访问的方式不优雅，Python提供了内置的函数。</p>
<table>
<thead>
<tr>
<th>内建函数</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getattr(object,name[,default])</code></td>
<td>通过name返回object的属性值。当属性不存在，将使用default返回，如果没有default，则抛出AttributeError。name必须为字符串</td>
</tr>
<tr>
<td><code>setattr(object,name,value)</code></td>
<td>object的属性存在，则覆盖，不存在，新增</td>
</tr>
<tr>
<td><code>hasattr(object,name)</code></td>
<td>判断对象是否有这个名字的属性，name必须为字符串</td>
</tr>
</tbody>
</table>
<p>用上面的方法来修改上例的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Point(&#123;&#125;, &#123;&#125;)"</span>.format(self.x, self.y)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self)</span><br><span class="line">        </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">p2 = Point(<span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">print(repr(p1), repr(p2), sep=<span class="string">'\n'</span>)</span><br><span class="line">print(p1.__dict__)</span><br><span class="line">setattr(p1, <span class="string">'y'</span>, <span class="number">16</span>)</span><br><span class="line">setattr(p1, <span class="string">'z'</span>, <span class="number">10</span>)</span><br><span class="line">print(getattr(p1, <span class="string">'__dict__'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态调用方法</span></span><br><span class="line"><span class="keyword">if</span> hasattr(p1, <span class="string">'show'</span>):</span><br><span class="line">    getattr(p1, <span class="string">'show'</span>)()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 动态增加方法</span></span><br><span class="line"><span class="comment"># 为类增加方法</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> hasattr(Point, <span class="string">'add'</span>):</span><br><span class="line">    setattr(Point, <span class="string">'add'</span>, <span class="keyword">lambda</span> self,other: Point(self.x + other.x, self.y + other.y))</span><br><span class="line">    </span><br><span class="line">print(Point.add)</span><br><span class="line">print(p1.add)</span><br><span class="line">print(p1.add(p2))  <span class="comment"># 绑定</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为实例增加方法， 未绑定</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> hasattr(p1, <span class="string">'sub'</span>):</span><br><span class="line">    setattr(p1, <span class="string">'sub'</span>, lambds self,other: Point(self.x - other.x, self.y - other.y))</span><br><span class="line">    </span><br><span class="line">print(p1.sub(p1, p1))</span><br><span class="line">print(p1.sub)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add在谁里面，sub在谁里面</span></span><br><span class="line">print(p1.__dict__)</span><br><span class="line">print(Point.__dict__)</span><br><span class="line">输出：</span><br><span class="line">&lt;__main__.Point object at <span class="number">0x7f9a8bf6ea90</span>&gt;</span><br><span class="line">&lt;__main__.Point object at <span class="number">0x7f9a8bf88490</span>&gt;</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">5</span>&#125;</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">16</span>, <span class="string">'z'</span>: <span class="number">10</span>&#125;</span><br><span class="line">Point(<span class="number">4</span>, <span class="number">16</span>)</span><br><span class="line">&lt;function &lt;<span class="keyword">lambda</span>&gt; at <span class="number">0x7f9a8bf0a4c0</span>&gt;</span><br><span class="line">&lt;bound method &lt;<span class="keyword">lambda</span>&gt; of &lt;__main__.Point object at <span class="number">0x7f9a8bf6ea90</span>&gt;&gt;</span><br><span class="line">Point(<span class="number">14</span>, <span class="number">26</span>)</span><br><span class="line">Point(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">&lt;function &lt;<span class="keyword">lambda</span>&gt; at <span class="number">0x7f9a8bf0a700</span>&gt;</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">4</span>, <span class="string">'y'</span>: <span class="number">16</span>, <span class="string">'z'</span>: <span class="number">10</span>, <span class="string">'sub'</span>: &lt;function &lt;<span class="keyword">lambda</span>&gt; at <span class="number">0x7f9a8bf0a700</span>&gt;&#125;</span><br><span class="line">&#123;<span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>: &lt;function Point.__init__ at <span class="number">0x7f9a8bf0a550</span>&gt;, <span class="string">'__str__'</span>: &lt;function Point.__str__ at <span class="number">0x7f9a8bf0a5e0</span>&gt;, <span class="string">'show'</span>: &lt;function Point.show at <span class="number">0x7f9a8bf0a670</span>&gt;, <span class="string">'__dict__'</span>: &lt;attribute <span class="string">'__dict__'</span> of <span class="string">'Point'</span> objects&gt;, <span class="string">'__weakref__'</span>: &lt;attribute <span class="string">'__weakref__'</span> of <span class="string">'Point'</span> objects&gt;, <span class="string">'__doc__'</span>: <span class="keyword">None</span>, <span class="string">'add'</span>: &lt;function &lt;<span class="keyword">lambda</span>&gt; at <span class="number">0x7f9a8bf0a4c0</span>&gt;&#125;</span><br></pre></td></tr></table></figure>
<p>思考</p>
<p>这种动态增加属性的方式和装饰器修饰一个类、Mixin方式的差异？</p>
<p>这种动态增删属性的方式是运行时改变类或者实例的方式，但是装饰器或Mixin都是定义时就决定了，因此反射能力具有更大的灵活性。</p>
<p>练习</p>
<p>命令分发器，通过名称找对应的函数执行。</p>
<p>思路：名称找对象的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._run()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd1</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"I'm cmd1"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd2</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"I'm cmd2"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            cmd = input(<span class="string">'Plz input a command: '</span>).strip()</span><br><span class="line">            <span class="keyword">if</span> cmd == <span class="string">'quit'</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            getattr(self, cmd, <span class="keyword">lambda</span> : print(<span class="string">'Unknown Command &#123;&#125;.'</span>.format(cmd)))()</span><br><span class="line">            </span><br><span class="line">Dispatcher()</span><br></pre></td></tr></table></figure>
<p>上例中使用<code>getattr</code>方法找到对象的属性的方式，比自己维护一个字典来建立名称和函数之间的关系的方式好多了。</p>
<h3 id="反射相关的魔术方法"><a href="#反射相关的魔术方法" class="headerlink" title="反射相关的魔术方法"></a>反射相关的魔术方法</h3><p><code>__getattr__()</code>、<code>__setattr__()</code>、<code>__delattr__()</code>这三个魔术方法，分别测试</p>
<h4 id="getattr"><a href="#getattr" class="headerlink" title="__getattr__()"></a><code>__getattr__()</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Base)</span>:</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"missing &#123;&#125;."</span>.format(item)</span><br><span class="line">    </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.x)</span><br><span class="line">print(p1.z)</span><br><span class="line">print(p1.n)</span><br><span class="line">print(p1.t)   <span class="comment"># missing</span></span><br></pre></td></tr></table></figure>
<p>一个类的属性会按照继承关系找，如果找不到，就会执行<code>__getattr__()</code>方法，如果没有这个方法，就会抛出<code>AttributeError</code>异常表示找不到属性。</p>
<p>查找属性顺序为：</p>
<p><code>instance.__dict__ --&gt; instance.__class__.__dict__ --&gt; 继承的祖先类（直到object）的__dict__ --找不到--&gt; 调用__getattr__()</code></p>
<h4 id="setattr"><a href="#setattr" class="headerlink" title="__setattr__()"></a><code>__setattr__()</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Base)</span>:</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"missing &#123;&#125;"</span>.format(item)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(<span class="string">"setattr &#123;&#125;=&#123;&#125;"</span>.format(key, value))</span><br><span class="line">        </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.x)  <span class="comment"># missing, why</span></span><br><span class="line">print(p1.z)</span><br><span class="line">print(p1.n)</span><br><span class="line">print(p1.t)  <span class="comment"># missing</span></span><br><span class="line">p1.x = <span class="number">50</span></span><br><span class="line">print(p1.__dict__)</span><br><span class="line">p1.__dict__[<span class="string">'x'</span>] = <span class="number">60</span></span><br><span class="line">print(p1.__dict__)</span><br><span class="line">print(p1.x)</span><br></pre></td></tr></table></figure>
<p>实例通过<code>.</code>点设置属性，如同<code>self.x = x</code>，就会调用<code>__setattr__()</code>，属性要加到实例的<code>__dict__</code>中，就需要自己完成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Base)</span>:</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(Self)</span>:</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"missing &#123;&#125;"</span>.format(item)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(<span class="string">"setattr &#123;&#125;=&#123;&#125;"</span>.format(key, value))</span><br><span class="line">        self.__dict__[key] = value</span><br></pre></td></tr></table></figure>
<p><code>__setattr__()</code>方法，可以拦截对实例属性的增加、修改操作，如果要设置生效，需要自己操作实例的<code>__dict__</code>。</p>
<h4 id="delattr"><a href="#delattr" class="headerlink" title="__delattr__()"></a><code>__delattr__()</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    z = <span class="number">5</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'Can not del &#123;&#125;'</span>.format(item))</span><br><span class="line">        </span><br><span class="line">p = Point(<span class="number">14</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">del</span> p.x</span><br><span class="line">p.z = <span class="number">15</span></span><br><span class="line"><span class="keyword">del</span> p.z</span><br><span class="line"><span class="keyword">del</span> p.z</span><br><span class="line">print(Point.__dict__)</span><br><span class="line">print(p.__dict__)</span><br><span class="line"><span class="keyword">del</span> Point.z</span><br><span class="line">print(Point.__dict__)</span><br></pre></td></tr></table></figure>
<p>可以阻止通过实例删除属性的操作。但是通过类依然可以删除属性。</p>
<h4 id="getattribute"><a href="#getattribute" class="headerlink" title="__getattribute__"></a><code>__getattribute__</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Base)</span>:</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"missing &#123;&#125;"</span>.format(item)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">    </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.__dict__)</span><br><span class="line">print(p1.x)</span><br><span class="line">print(p1.z)</span><br><span class="line">print(p1.n)</span><br><span class="line">print(p1.t)</span><br><span class="line">print(Point.__dict__)</span><br><span class="line">print(Point.z)</span><br></pre></td></tr></table></figure>
<p>实例的所有的属性访问，第一个都会调用<code>__getattribute__</code>方法，它阻止了属性的查找，该方法应该返回（计算后的）值或者抛出一个<code>AttributeError</code>异常。</p>
<p>它的return值将作为属性查找的结果。如果抛出<code>AttributeError</code>异常，则会直接调用<code>__getattr__</code>方法，因为表示属性没有找到。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Base)</span>:</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"missing &#123;&#125;"</span>.format(item)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="comment"># raise AttributeError("Not Found")</span></span><br><span class="line">        <span class="comment"># pass</span></span><br><span class="line">        <span class="comment"># return self.__dict__[item]</span></span><br><span class="line">        <span class="keyword">return</span> object.__getattribute__(self, item)</span><br><span class="line">    </span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.__dict__)</span><br><span class="line">print(p1.x)</span><br><span class="line">print(p1.z)</span><br><span class="line">print(p1.n)</span><br><span class="line">print(p1.t)</span><br><span class="line">print(Point.__dict__)</span><br><span class="line">print(Point.z)</span><br></pre></td></tr></table></figure>
<p><code>__getattribute__</code>方法中为了避免在该方法中无限的递归，它的实现应该永远调用基类的同名方法以访问需要的任何属性，例如<code>object.__getattribute__(self, name)</code>。</p>
<p>注意，除非你明确地知道<code>__getattribute__</code>方法用来做什么，否则不要使用它。</p>
<p>总结</p>
<table>
<thead>
<tr>
<th>魔术方法</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__getattr__()</code></td>
<td>当通过搜索实例、实例的类及祖先类查不到属性，就会调用此方法</td>
</tr>
<tr>
<td><code>__setattr__()</code></td>
<td>通过<code>.</code>访问实例属性，进行增加、修改都要调用它</td>
</tr>
<tr>
<td><code>__delattr__()</code></td>
<td>当通过实例来删除属性时调用此方法</td>
</tr>
<tr>
<td><code>__getattribute__</code></td>
<td>实例所有的属性调用都从这个方法开始</td>
</tr>
</tbody>
</table>
<p>属性查找顺序：</p>
<p><code>实例调用__getattribute__() -&gt; instance.__dict__ -&gt; instance.__class__.__dict__ -&gt; 继承的祖先类（直到object）的__dict__ -&gt; 调用__getattr__()</code></p>
<h3 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">python的名词空间指模块或作用域</span><br><span class="line"></span><br><span class="line">dir()</span><br><span class="line"><span class="comment"># 收集当前模块的信息</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> test2</span><br><span class="line">print(dir(test2))</span><br><span class="line"><span class="comment"># 导入test2模块或叫导入名词空间。收集test2信息。这时test模块中会多一个test2。import就是导入名词空间的</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(x)</span>:</span></span><br><span class="line">    y = <span class="number">1</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(dir(foo))  <span class="comment"># 指定对foo进行搜集，可以看到foo继承的函数的所有属性</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    X = <span class="number">123</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.y = <span class="number">5</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">print(sorted(dir(A)))</span><br><span class="line">print(sorted(A.__dict__))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__dir__</span><span class="params">(self)</span>:</span>  <span class="comment"># 因为有self，所以会影响实例的dir.</span></span><br><span class="line"><span class="comment"># 在类里看方法的第一位置参数是谁那就是谁的，这里是self所以影响的是实例</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'abcdef'</span>]</span><br><span class="line"></span><br><span class="line">print(<span class="string">'B = '</span>, sorted(dir(B)))</span><br><span class="line">print(sorted(B.__dict__))</span><br><span class="line"></span><br><span class="line">b = B()</span><br><span class="line">print(sorted(dir(b)))</span><br><span class="line">print(sorted(b.__dict__))</span><br><span class="line"></span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">print(sorted(set(b.__dict__.keys()) | set(b.__class__.__dict__.keys()) | set(object.__dict__)))</span><br><span class="line"><span class="comment"># 自己凑一个。dir()显示的信息都是实例自己和类的属性，还有object类的属性。用set是为了去重。</span></span><br></pre></td></tr></table></figure>
<p>hash</p>
<p>用hash就是为了O1的时间复杂度。缓存的目的是再查，缓冲是为了匹配生产者与消费者的速度</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Hashable</span><br><span class="line"><span class="comment"># 3.8.2版本中如果没有collections模块，要用pip3 install collections-extended，使用时要用</span></span><br><span class="line"><span class="comment"># from _collections_abc import Hashable或用from collections.abc import Hashable，不然会提示:</span></span><br><span class="line"><span class="comment"># "DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' </span></span><br><span class="line"><span class="comment"># is deprecated since Python 3.3, and in 3.9 it will stop working"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    X = <span class="number">123</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, y)</span>:</span></span><br><span class="line">        self.y = y</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span><span class="params">(self)</span>:</span>  <span class="comment"># hash冲突。两个对象在一个hash的计算空间中，可能算出的两个key是一样的</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>   <span class="comment"># 这里只能用整型，不能用字符串</span></span><br><span class="line"><span class="comment">#    __hash__ = None</span></span><br><span class="line"><span class="comment"># 如果实例再调用hash就是在调用__hash__这个方法，这个方法就等于None，相当于调用None()。这时调用时会提示是不可hash类型。</span></span><br><span class="line"><span class="comment"># 不可hash类型就是这样实现的。</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="comment"># return True  # 这样定义，不管什么情况都认为两个实例相等，这时不管初始化时放什么值都相等了。如果把这里改成</span></span><br><span class="line"><span class="comment"># False，下面的显示结果也会是去重的，可能是set()先用了一个is来判断，之后再调用__eq__。也就是set先判断内存地址是否相同，相</span></span><br><span class="line"><span class="comment"># 同就去重</span></span><br><span class="line">    	<span class="keyword">return</span> self.y == other.y   <span class="comment"># 应该这样写，而不是简单的True或False</span></span><br><span class="line"><span class="comment"># 当前的实例对象self和另一个实例对象other把y拿出来比较数据属性是否相同</span></span><br><span class="line"><span class="comment"># self.y == other.y叫二元操作符，self.y叫对象，==是操作符，相当于self.y对象在调用__eq__方法，而后面的other.y做为</span></span><br><span class="line"><span class="comment"># other参数。self.y是什么类型就调用什么类型的__eq__方法，而不是这里定义的__eq__方法，比如这里初始化时定义了</span></span><br><span class="line"><span class="comment"># self.y = 'y'，那么self.y就会调用字符串的__eq__方法。这里要看自己的逻辑，如果初始化定义了两个属性，这里可以判断一个属性</span></span><br><span class="line"><span class="comment"># 相等就可以了，也可以判断两个属性相等才行，如return self.y == other.y and self.x == other.x</span></span><br><span class="line"><span class="comment"># 用取模算法去理解hash算法</span></span><br><span class="line">		</span><br><span class="line">    </span><br><span class="line"><span class="comment"># hash(o)  # 相当于调用o.__hash__()，None是不能调用的，所以o是不能调用的</span></span><br><span class="line"><span class="comment"># o.__hash__()</span></span><br><span class="line">print(hash(A(<span class="number">5</span>))) <span class="comment"># hash要对里面的对象调用hash的方法</span></span><br><span class="line"></span><br><span class="line">lst = [A(<span class="number">4</span>), A(<span class="number">5</span>)]  <span class="comment"># 因为A()是不可迭代类型，所以不能用list()，而用这种方法</span></span><br><span class="line">print(lst)</span><br><span class="line"></span><br><span class="line">s = set(lst)</span><br><span class="line">print(len(s))   <span class="comment"># </span></span><br><span class="line">print(s)  <span class="comment"># 这里只会打印一个hash值，因为set去重了</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> s:</span><br><span class="line">    print(hash(x))</span><br><span class="line"><span class="comment"># 显示hash值是相等的，都是1。所以仅用hash值不能验证两个实例是否相等。所以要用__eq__。</span></span><br><span class="line"></span><br><span class="line">可hash和去重是两个概念，可hash只是是否支持hash，能否给一个hash值。相等才会去重</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x % <span class="number">3</span>   <span class="comment"># 取模hash，有可能重复</span></span><br><span class="line"></span><br><span class="line">print(isinstance(A(<span class="number">4</span>), Hashable)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span></span><br><span class="line">[&lt;__main__.A object at <span class="number">0x10bdf0760</span>&gt;, &lt;__main__.A object at <span class="number">0x10be5c430</span>&gt;]</span><br><span class="line"><span class="number">1</span></span><br><span class="line">&#123;&lt;__main__.A object at <span class="number">0x10bdf0760</span>&gt;&#125;</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>eq</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a == b  <span class="comment"># 相当于下面。这就是二元操作符如何等价到一个方法</span></span><br><span class="line">a.__equal__(b)  <span class="comment"># b就是__eq__(self, other)中的other，a就是self</span></span><br></pre></td></tr></table></figure>
<p>练习</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设计二维坐标类Point，使其成为可hash类型，并比较2个坐标的实例是否相等？</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self <span class="keyword">is</span> other:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">p = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">p2 = Point(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">print(p)</span><br><span class="line">print(p == p1)</span><br><span class="line">print(p == p2)</span><br><span class="line">print(p.__eq__(p1))</span><br><span class="line">print(p.__eq__(p2))</span><br><span class="line">输出：</span><br><span class="line">&lt;__main__.Point object at <span class="number">0x7ff1f73c6a90</span>&gt;</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>bool</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self <span class="keyword">is</span> other:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>  <span class="comment"># 这里不能返回小于0的数</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bool_</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"><span class="comment"># 先找对象方法中是否定义了bool，如果没有再看是否有len，如果都没有定义，返回True。如果定义了，方法返回什么就返回什么 ，如上面__bool__中返回的是False。容器内一般都不实现bool方法，而用len方法  </span></span><br><span class="line">print(bool(Point(<span class="number">4</span>, <span class="number">5</span>)))</span><br></pre></td></tr></table></figure>
<p>可视化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self <span class="keyword">is</span> other:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(<span class="number">123</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(<span class="string">'abc'</span>)</span><br><span class="line"><span class="comment"># python默认使用repr对每个元素求打印，如果定义了str，就要用str对对象做强制转换。所以下面打印单个元素时都会调用str方法，包</span></span><br><span class="line"><span class="comment"># 括使用for循环时，也是一个个打印。在打印lst时调用了repr。如果不是直接使用print或format直接对函数起作用的话，就要用</span></span><br><span class="line"><span class="comment"># repr。否则使用str。也就是，如果print()直接作用于对象，就会强行调用对象的str方法，包括for循环也是直接作用于对象。但</span></span><br><span class="line"><span class="comment"># print(lst)时就要调用repr了，因为并不是print直接作用到对象上。所以可以将repr和str的返回值写成一样的</span></span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)  </span><br><span class="line">p2 = Point(<span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">print(p1)   <span class="comment"># __str__等效于print方法</span></span><br><span class="line">lst = [p1, p2]   </span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> lst:   <span class="comment"># for循环也会调用__str__方法</span></span><br><span class="line">    print(x)</span><br><span class="line"></span><br><span class="line">print(*lst)   <span class="comment"># 这相当于强行str了</span></span><br><span class="line">print(list(map(str, lst)))  <span class="comment"># map后是一个可迭代对象，所以返回的是地址。这也是强行str的方法</span></span><br><span class="line">print(lst)  <span class="comment"># lst里还有print，lst是找lst的print方法，lst里的元素不会这样处理。相当于元素没有直接被print打印出来。因为这是lst内部的元素，它要调用对象的另一种表达方法__repr__。如果不是用str()强制转换，或用format、print()直接对对象起作用的话，那就要用__repr__，这是python内部所使用的，默认会用内建函数__repr__来对每个元素求打印，也就是所谓的字符串输出。所以print()如果直接作用于对象，那就强行调用对象的str，所以返回abc，for循环也是一个个元素拿出来，对于每个元素来讲，就是直接用print来打印，所以还是调用__str__。但这里打印lst时相当于打印[p1, p2]，但print不知道[p1, p2]是什么，所以就尝试调用__repr__，因为并不是print函数直接作用在[p1, p2]上面的，所以打印的是123。</span></span><br><span class="line"><span class="comment"># 实际就是内建的几个函数，它直接作用在对象上，这样就会调用对象的str。如果并不直接作用在元素或对象上，就会调用它的repr方法 </span></span><br><span class="line">输出：</span><br><span class="line">abc</span><br><span class="line">abc</span><br><span class="line">abc</span><br><span class="line">abc abc</span><br><span class="line">[<span class="string">'abc'</span>, <span class="string">'abc'</span>]</span><br><span class="line">[<span class="number">123</span>, <span class="number">123</span>]</span><br></pre></td></tr></table></figure>
<p>运算符重载</p>
<p>运算符重载可以提高类的可用性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span><span class="params">(self, other)</span>:</span>  <span class="comment"># 减法</span></span><br><span class="line">        self.x = self.x - other.x</span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># 这是就地修改，下面是new一个新的。</span></span><br><span class="line">      <span class="comment">#   return A(self.x - other.x)   # 这一行相当于上面两行代码。这里也可以直接返回self.x - other.x。一般应该返回自己本身，所以这里返回数值不太合适，要用A()包装一下。只是要返回实例本身，要实现__str__方法才能打印出数值。具体打印出的是什么内容要看__str__方法是如何定义的。</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__ne__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x != other.x</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x &lt; other.x  <span class="comment"># 实现一个方法就行了，知道了小于，就知道大于和等于了</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.x)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iadd__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        self.x = self.x + other.x</span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># 这样就不用new了，像下面的语句一样。</span></span><br><span class="line">      <span class="comment">#  return A(self.x + other.x)</span></span><br><span class="line">        </span><br><span class="line">    __repr__ = __str__    </span><br><span class="line">    </span><br><span class="line">a1 = A(<span class="number">4</span>)</span><br><span class="line">a2 = A(<span class="number">10</span>)</span><br><span class="line">a3 = A(<span class="number">6</span>)</span><br><span class="line">print(a1 - a2)</span><br><span class="line">print(a1.__sub__(a2))  <span class="comment"># 这条等价于上面一条</span></span><br><span class="line"></span><br><span class="line">print(a1 == a2)</span><br><span class="line">print(a1 != a2)   <span class="comment"># 这里要使用什么符号，在类中就要定义什么方法，如这里使用不等，那么在类中也要定义__ne__方法</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lst = [a1, a2, a3]</span><br><span class="line">print(sorted(lst))</span><br><span class="line">print(list(reversed(sorted(lst))))</span><br><span class="line"><span class="comment"># 因为reversed反向排序后还是一个可迭代对象，所以要再包一层list。可以去掉sorted，这样就会直接反转，但没有排序。</span></span><br><span class="line"></span><br><span class="line">a1 += a2</span><br><span class="line">print(a1)</span><br><span class="line"><span class="comment"># 可以通过查看int的源码，查看大部分运算符方法的使用方法</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">-6</span></span><br><span class="line"><span class="number">-6</span></span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="keyword">True</span></span><br><span class="line">[<span class="number">4</span>, <span class="number">6</span>, <span class="number">10</span>]</span><br><span class="line">[<span class="number">10</span>, <span class="number">6</span>, <span class="number">4</span>]</span><br><span class="line"><span class="number">14</span></span><br><span class="line">===========================================================================================================</span><br><span class="line"><span class="comment"># 测试一下返回self如何打印</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span>              </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">        self.x = x    </span></span></span><br><span class="line"><span class="function"><span class="params">        self.y = y    </span></span></span><br><span class="line"><span class="function"><span class="params">                      </span></span></span><br><span class="line"><span class="function"><span class="params">    def __show__<span class="params">(self)</span></span></span></span><br><span class="line"><span class="function"><span class="params">        print<span class="params">(<span class="string">'self &#123;&#125;</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">        return self   </span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">                      </span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">    def __str__(self):</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">        return '</span>&#123;&#125; &#123;&#125;<span class="string">'</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">                      </span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">    __repr__ = __str__</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">                      </span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">p = A(3, 54)          </span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">print(p.__show__())   </span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">输出：</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">self 3 54</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="string">3 54</span></span></span></span></span><br></pre></td></tr></table></figure>
<p>练习</p>
<p>完成<code>Point</code>类设计，实现判断点相等的方法，并完成向量的加法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 答案1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        tmpx = self.x + other.x</span><br><span class="line">        tmpy = self.y + other.y</span><br><span class="line">        <span class="keyword">return</span> Point(tmpx, tmpy)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;Point: &#123;&#125;,&#123;&#125;&gt;'</span>.format(self.x, self.y)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;Point: &#123;&#125;,&#123;&#125;&gt;'</span>.format(self.x, self.y)</span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">p2 = Point(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">points = (p1, p2)</span><br><span class="line">print(points)</span><br><span class="line">print(points[<span class="number">0</span>] + points[<span class="number">1</span>])</span><br><span class="line">print(p1 == p2)</span><br><span class="line">输出：</span><br><span class="line">(&lt;Point: <span class="number">1</span>,<span class="number">1</span>&gt;, &lt;Point: <span class="number">1</span>,<span class="number">1</span>&gt;)</span><br><span class="line">&lt;Point: <span class="number">2</span>,<span class="number">2</span>&gt;</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>容器相关方法</p>
<p>练习</p>
<p>将购物车类改造成方便操作的容器类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, **kwargs)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self._spec = kwargs</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; = &#123;&#125;"</span>.format(self.name, self._spec.values())</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cart</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.items = []  <span class="comment"># 添加容器，购物车。可以在初始化时就把物品放进来，也可以在初始化后，有了容器再把物品放进来</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.items)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">additem</span><span class="params">(self, item)</span>:</span>  <span class="comment"># 这种方法与下面的__add__方法的作用是一样的，这种方法就是可以直接调用，下面的方法可以使用+号</span></span><br><span class="line">        self.items.append(item)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span>  <span class="comment"># 此方法对应加号，所以叫运算符重载</span></span><br><span class="line">        print(other)</span><br><span class="line">        <span class="keyword">if</span> isinstance(other, Item):</span><br><span class="line">        	self.items.append(other)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"><span class="comment"># 返回self，如果用self再加一个数字，那么self会跟着变化</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, item)</span>:</span>  <span class="comment"># 这里的item送进来什么就打印什么。是index</span></span><br><span class="line">        <span class="keyword">return</span> self.items[item]   <span class="comment"># item就是index，所以可以实现cart[1]这样的调用，超出会报异常。所以也可以把item改成index</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(key, value)</span><br><span class="line">        self.items[key] = value   <span class="comment"># 如果实例是列表，必须在已有的key上修改</span></span><br><span class="line">        <span class="comment"># self[key] = value  </span></span><br><span class="line"><span class="comment"># 这样写就递归了，因为这里的返回值就是__getitem__方法的返回值，__getitem__方法显示的</span></span><br><span class="line"><span class="comment"># self.items[item]就是value，那么这里也就成了value等于value。但有些场景可以用这种方法</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span>  <span class="comment"># __iter__方法要求返回一个迭代器</span></span><br><span class="line"><span class="comment"># 迭代的目的是把实例变成可迭代对象  </span></span><br><span class="line">		<span class="keyword">return</span> iter(self.items)  <span class="comment"># 使用iter()将实例变成迭代器</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__missing__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        print(<span class="string">"key ="</span>+key) <span class="comment"># 上面的__getitem__中的item如果超界的话，这里这样写是拦不住的。因为__missing__只是用在字典和set上的</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.items)</span><br><span class="line">    </span><br><span class="line">cart = Cart()</span><br><span class="line">print(len(cart + <span class="number">2</span> + <span class="number">3</span> + <span class="number">4</span> + <span class="number">5</span>))  <span class="comment"># 连加就是链式编程</span></span><br><span class="line">cart.__add__(<span class="number">2</span>).__add__(<span class="number">3</span>)  <span class="comment"># 这等价于上面的cart + 2 + 3 + 4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> cart:   <span class="comment"># cart如果不是迭代器iterator是不行的。因为for循环本质上是调用next()函数</span></span><br><span class="line">    print(x)  <span class="comment"># __iter__方法将实例变成了可迭代对象</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> cart.items:  </span><br><span class="line"><span class="comment"># 这样也可以实现上面的for循环的效果，但要如何包装需要自己考虑但这样写就把cart里面的东西暴露给用户，所以这样写不好。所以我们要把它包装成容器就要包装的彻底，对一个容器来讲最重要的方法就是迭代了。</span></span><br><span class="line">    print(x)</span><br><span class="line">    </span><br><span class="line">print(cart[<span class="number">1</span>])</span><br><span class="line">cart[<span class="number">500</span>] = <span class="number">500</span>  <span class="comment"># 查看__setitem__的反馈</span></span><br><span class="line">cart[<span class="number">3</span>] = <span class="number">500</span></span><br><span class="line">print(cart(<span class="number">3</span>))</span><br></pre></td></tr></table></figure>
<p>实现一个字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDict</span><span class="params">(dict)</span>:</span>  <span class="comment"># 直接继承</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>可调用对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">foo()  <span class="comment"># 加括号是调用，如果调用，一定要是可调用对象</span></span><br><span class="line">print(foo.__dict__)</span><br><span class="line">print(foo.__call__)  <span class="comment"># 打印的是地址</span></span><br><span class="line">print(dir(foo))  <span class="comment"># 如果是一个可调用对象，就应该有__call__这个魔术方法。因为函数是一个可调用对象，所以有这个魔术方法</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(x)</span>:</span></span><br><span class="line">    print(x)</span><br><span class="line">foo()  <span class="comment"># 加括号是调用，如果调用，一定要是可调用对象</span></span><br><span class="line">print(foo.__dict__)</span><br><span class="line">print(foo.__call__(<span class="number">5</span>))  </span><br><span class="line"><span class="comment"># 如果送进去一个5，相当于foo对象被调用了，并且把参数送进去了。这等价于foo(5)</span></span><br><span class="line">print(dir(foo))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">A()()</span><br><span class="line"><span class="comment"># 第一个括号是__init__实例化使用的，第二个括号是调用这个实例。这等价于a = A(), a()</span></span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">a(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<p>练习</p>
<p>定义一个斐波那契数列</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 答案1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fib</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.lst = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>]  <span class="comment"># 这是一种缓存的思想</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.lst)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> x &lt; len(self.lst):</span><br><span class="line">            <span class="keyword">return</span> self.lst</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, x):  <span class="comment"># 这里最好的2改成活动的</span></span><br><span class="line">            self.lst.append(self.lst[i<span class="number">-1</span>] + self.lst[i])</span><br><span class="line">        <span class="keyword">return</span> self.lst</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:  <span class="comment"># 这里认为不知道斐波那契数列的长度，所以不支持负索引</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; len(self):</span><br><span class="line">        	<span class="keyword">return</span> self.lst[item]</span><br><span class="line">        </span><br><span class="line">        self(index)</span><br><span class="line">    </span><br><span class="line">a = Fib()</span><br><span class="line">print(a(<span class="number">6</span>))</span><br><span class="line">print(a(<span class="number">5</span>))</span><br><span class="line">print(a(<span class="number">4</span>))</span><br><span class="line">print(a(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">print(a.lst)</span><br><span class="line">print(a[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">增加迭代的方法、返回容器长度的方法</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> iter(self.lst)</span><br></pre></td></tr></table></figure>
<p>上下文管理</p>
<p>通过上下文管理，我们可以只管打开，其他的不用关心，python解释器会为我们做，python会做一些自动化操作。你这段代理的上文和下文就是上下文</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># with open ('test') as f:</span></span><br><span class="line"><span class="comment">#    pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'init'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span>   <span class="comment"># 使用上下文管理__enter__方法也是必须的。这个方法是进去了帮我做的事情</span></span><br><span class="line">        print(<span class="string">'enter'</span>+self.__class__.__name__)</span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># 在这个语境下应该返回self,这样p和f就一样了。__enter__方法最后return的应该是一个文件对象类型。open()方法返回的实例也应该有上下文，返回一个文件对象类型</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span>  </span><br><span class="line">    <span class="comment"># 在上下文中使用类实例化时会提示类中要有__exit__方法。这个方法是离开的时候帮忙做的事情</span></span><br><span class="line">    	print(<span class="string">'Exit'</span>+self.__class__.__name__)</span><br><span class="line"> <span class="comment">#  __enter__和__exit__是实例的方法，没有实例也不会被调用</span></span><br><span class="line">		print(exc_type)   <span class="comment"># 这一句会打印raise的类型</span></span><br><span class="line">    	print(exc_val)   <span class="comment"># 这是异常类型的值 </span></span><br><span class="line">        print(exc_tb)   <span class="comment"># 执行这三条语句时还是用raise。这一句会打印traceback。这三行只在抛异常时才会有，如果没有异常，会返回None</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>  <span class="comment"># 这里的return的返回值可以决定异常是否向外抛出，这里如果返回True，就是这个方法里面管，外面可以正常执行，不会看到异常。如果返回一个等效False的，就会把异常抛出去，在外面可以看到。</span></span><br><span class="line">    </span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># with Point() as f:  # Point后面要有括号，不能直接使用。也就是类被实例化后才能使用</span></span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:   <span class="comment"># 这里会看实例p有没有__enter__，如果有就有会抛异常，然后请__enter__返回一个返回值，再把这个返回值给f,所以p和f是绝对不相等的</span></span><br><span class="line">   <span class="comment"># raise Exception('Error') # 有了这个raise，下面的语句就执行不到了。添加这句后，还是会执行__exit__方法的。下面也会抛异常</span></span><br><span class="line">    sys.exit()  <span class="comment"># 这句表示结束当前程序，使用这句，而不用上面的raise，还是会执行完__exit__结束</span></span><br><span class="line">    print(f == p)</span><br><span class="line">    print(f <span class="keyword">is</span> p)</span><br><span class="line"><span class="comment"># 这里会按Point类中定义的__enter__和__exit__方法做事情</span></span><br><span class="line"><span class="comment"># 打开文件的时候叫文件对象，文件对象内一定实现了__enter__和__exit__方法，在__enter__时一定维护了一个文件对象，当离开with语句块时with语句块自动调用__exit__方法把资源彻底施放掉。一些预加载预处理的工作可以交给with来做</span></span><br><span class="line">	print(p)</span><br><span class="line">    print(f)</span><br><span class="line">    </span><br><span class="line">print(<span class="string">'outer'</span>)</span><br><span class="line">输出：</span><br><span class="line">init</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">Point</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="title">False</span></span></span><br><span class="line"><span class="class"><span class="title">False</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">__main__</span>.<span class="title">Point</span> <span class="title">object</span> <span class="title">at</span> 0<span class="title">x00000000000000847B8</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">None</span></span></span><br><span class="line"><span class="class"><span class="title">Point</span></span></span><br><span class="line"># 抛出的异常中的traceback是追踪在堆栈中的执行过程,traceback打印的就是红色部分的内容，它在堆栈上追踪了整个异常调度过程，它也会显示异常抛出的内容，在第几行出了问题</span><br></pre></td></tr></table></figure>
<p>练习</p>
<p>为加法函数计时</p>
<ol>
<li>使用装饰器显示该函数的执行时长</li>
<li>使用上下文管理显示该函数的执行时长</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magedu</span><span class="params">(fn)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        time_start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        print(time_start - datetime.datetime.now())</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wapper</span><br><span class="line"><span class="meta">@magedu # add = magedu(add)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">40</span>, <span class="number">50</span>)</span><br><span class="line">============================================================</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">      </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeIt</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(delta)</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> TimeIt() <span class="keyword">as</span> f:</span><br><span class="line">	add(<span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">============================================================</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps      </span><br><span class="line">      </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeIt</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self._fn = fn</span><br><span class="line">        <span class="comment"># self.__doc__ = self._fn.__doc__</span></span><br><span class="line">        <span class="comment"># self.__name__ = self._fn.__name__</span></span><br><span class="line">        <span class="comment"># 加上这两条就可以调用add的doc和name方法了</span></span><br><span class="line">        wraps(fn)(self)  <span class="comment"># 这一句就是上面的两句</span></span><br><span class="line">      </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'enter'</span>)</span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="comment"># return self</span></span><br><span class="line">        <span class="keyword">return</span> self._fn</span><br><span class="line"><span class="comment"># 如果下面要使用with TimeIt(add) as foo这种方式，返回self是不行的，需要返回self._fn，这等于在初始化时送进去的是什么，这里就返回什么</span></span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'__call__'</span>)</span><br><span class="line">       <span class="comment">#  return self._fn(*args, **kwargs)</span></span><br><span class="line"><span class="comment"># 如果要在上下文中使用self()这种方式，可以这样写。要什么就送回去什么</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = self._fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">"dec &#123;&#125; took &#123;&#125;"</span>.format(self._fn.__name__, delta)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'exit'</span>)</span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">"context &#123;&#125; took &#123;&#125;"</span>.format(self._fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">      </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)  # a = wraps(fn)  ;  a(wrapper)  ;  @a</span></span><br><span class="line">              <span class="comment">#     @wraps(fn)(wrapper)，源是fn，目标是wrapper</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">"dec &#123;&#125; took &#123;&#125;"</span>.format(fn.__name__, delta)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="comment"># @logger</span></span><br><span class="line"><span class="meta">@TimeIt   # 这样使用类装饰器，这样就不需要函数装饰器了。类装饰器需要__call__方法，它可以把一个东西模拟成一个函数，像函数一样调用</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span>  <span class="comment"># add = TimeIt(add)</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">              </span><br><span class="line">print(add(<span class="number">10</span>, <span class="number">11</span>))</span><br><span class="line">              </span><br><span class="line">print(add.__doc__)  <span class="comment"># add现在已经被包装成一个可调用对象，这个对象是就是TimeIt的实例，实例调用__name__是调不出来的</span></span><br><span class="line">print(add.__name__)</span><br><span class="line">print(add.__dict__)  </span><br><span class="line">print(type(add))</span><br><span class="line">              </span><br><span class="line"><span class="keyword">with</span> TimeIt(add) <span class="keyword">as</span> f:  <span class="comment"># 这里的add是装饰器装饰过的</span></span><br><span class="line">	add(<span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">              </span><br><span class="line"><span class="keyword">with</span> TimeIt(add) <span class="keyword">as</span> foo:</span><br><span class="line">	foo(<span class="number">5</span>, <span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<p>contextlib.contextmanager</p>
<p>yield返回单值，如yield x,y就是返回单值，x,y也是单值，是被封装后的单值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'enter'</span>)  <span class="comment"># 这只是类似__enter__()，但并不是，只是模拟</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span>,<span class="number">5</span>  <span class="comment"># 这样会输出一个元组</span></span><br><span class="line">    print(<span class="string">'exit'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> foo() <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	<span class="keyword">raise</span> Exception</span><br><span class="line">    <span class="comment"># 加入raise后，上面的foo函数是执行不到yield的</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        print(<span class="string">'exit'</span>)   <span class="comment"># 如果要执行到这句，就要用这种方式</span></span><br><span class="line">    print(f)</span><br><span class="line">输出</span><br><span class="line">enter</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line">exit</span><br><span class="line"><span class="comment"># 输出把None加在了中间。foo函数生成器拿到后第一次做next()的话，执行到</span></span><br><span class="line"><span class="comment"># yield就停了，print('exit')不会被打印，做第二次next()时才会打印，然后</span></span><br><span class="line"><span class="comment"># 整个函数就return了，也就是print('exit')后面相当于有一句return，只是没</span></span><br><span class="line"><span class="comment"># 写出来。try是核心逻辑，finally是要做的清理工作。</span></span><br></pre></td></tr></table></figure>
<p>total_ordering</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> total_ordering</span><br><span class="line"><span class="comment"># 这个方法可以做所有的比较，这是一个装饰器。但一定要定义eq方法，其他的要使用</span></span><br><span class="line"><span class="comment"># 一个一般用lt方法</span></span><br><span class="line"><span class="meta">@total_ordering</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self. &lt; other.x</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x</span><br><span class="line">    </span><br><span class="line">print(A(<span class="number">5</span>) &gt;= A(<span class="number">6</span>))</span><br><span class="line">print(A(<span class="number">5</span>) &gt; A(<span class="number">6</span>))</span><br><span class="line">print(A(<span class="number">5</span>) &lt;= A(<span class="number">6</span>))</span><br><span class="line">print(A(<span class="number">5</span>) == A(<span class="number">6</span>))</span><br></pre></td></tr></table></figure>
<p>反射</p>
<p>理解反射先要理解什么是编译时什么是运行时，python是动态语言，更多的表现是在运行时，运行时指解释器加载代码后是什么状态，它更多的在意在执行的过程中是什么情况，执行过程中就是加载到内存中了。</p>
<p>反射指在运行时，它能够通过对象找到对象相关的类型信息，类型信息指我是什么类型，我有什么属性，因为有些类型在方法上，所以就要在运行时在类上找到他类型相关的所有信息。找信息与反射的关系是从它自身反射出了它的所有类型信息，这个过程就叫反射，通过这种机制，就可以在运行时掌握所有类型信息。一个对象可以在运行时反射出自己与类型相关的所有信息，这就是反射机制。反射也称为自省</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.x = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">setattr(A, <span class="string">'y'</span>, <span class="number">10</span>)   <span class="comment"># 给A类加一个y属性，值是10。属性必须是字符串，下面打印类的属性就可以看到了。这与实例无关</span></span><br><span class="line">print(A.__dict__)</span><br><span class="line">print(a.__dict__)</span><br><span class="line">print(getattr(a, <span class="string">'x'</span>))  <span class="comment"># 使用getattr方法取a实例的x属性的值</span></span><br><span class="line">print(getattr(a, <span class="string">'y'</span>))  <span class="comment"># 这样可以取到类上的属性值，这也是先找自己的dict，如果没有就找父类的dict</span></span><br><span class="line">print(getattr(a, <span class="string">'y'</span>, <span class="number">100</span>))  <span class="comment"># 这样是找不到的，所以给了一个缺省值100</span></span><br><span class="line"><span class="keyword">if</span> hasattr(a, <span class="string">'z'</span>):</span><br><span class="line">    print(getattr(a, <span class="string">'z'</span>))</span><br><span class="line">    </span><br><span class="line">setattr(a, <span class="string">'y'</span>, <span class="number">1000</span>)   <span class="comment"># 这相当于给a.y赋值，会覆盖上面的setattr(A, 'y', 10) </span></span><br><span class="line">print(A.__dict__)  <span class="comment"># 查找顺序还是自己优先，然后是父类，之后是祖先类</span></span><br><span class="line">print(a.__dict__)</span><br><span class="line">print(getattr(a, <span class="string">'y'</span>))</span><br><span class="line">print(getattr(A, <span class="string">'y'</span>))</span><br><span class="line"></span><br><span class="line">setattr(a, <span class="string">'mtd'</span>, <span class="keyword">lambda</span> self: <span class="number">1</span>)  <span class="comment"># mtd属性是加到实例上了</span></span><br><span class="line">print(A.__dict__)</span><br><span class="line">print(a.__dict__)</span><br><span class="line">a.mtd()  <span class="comment"># 这里会显示mtd有问题，因为是编译时加进去的，所以不用管。这样当执行到mtd时会去找lambda函数，之后返回1。这看似没有问题，但执行时会提示缺少self，没有把实例放到第一个参数上。如果把上面改成setattr(A, 'mtd', lambda self: 1)就没问题了，但这是把属性加到类上了。在类里定义会和实例绑定</span></span><br><span class="line">方法可以放在实例上，只是定义时没法写进去，因为定义时还没有实例，但运行时实例就可以存在，这样就可以在实例的字典里写上key和value，只是没有绑定。推荐加到类上。上面如果不想报错，又添加到实例上，可以写成a.mtd(a)</span><br></pre></td></tr></table></figure>
<p>在运行时需要添加属性，就需要上面的方法了。装饰器和Mixin是在编译期要定义好的，不能动态改变</p>
<p>练习</p>
<p>命令分发器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">    cmds = &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(cmd, fn)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(cmd, str):</span><br><span class="line">        	cmds[cmd] = fn</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'error'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        	cmd = input(<span class="string">"plz input command: "</span>)</span><br><span class="line">            <span class="keyword">if</span> cmd.strip() == <span class="string">'quit'</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            cmds.get(cmd.strip(), defaultfn)()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">defaultfn</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> reg, run</span><br><span class="line"></span><br><span class="line">reg,run = dispatcher()</span><br><span class="line">reg(<span class="string">'cmd1'</span>, <span class="keyword">lambda</span> : <span class="number">1</span>)</span><br><span class="line">reg(<span class="string">'cmd2'</span>, <span class="keyword">lambda</span> : <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">run()</span><br><span class="line">=================================================================================================</span><br><span class="line">把上面的分发器函数改成类</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dispatcher</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd1</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'cmd1'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(self, cmd, fn)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(cmd, str):</span><br><span class="line">            setattr(type(self), cmd, fn)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'error'</span>)</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            cmd = input(<span class="string">"plz input command: "</span>)</span><br><span class="line">            <span class="keyword">if</span> cmd.strip() == <span class="string">'quit'</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            getattr(self, cmd.strip(), self.defaultfn)()</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">defaultfn</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'default'</span>)</span><br><span class="line">        </span><br><span class="line">dis = dispatcher()</span><br><span class="line"></span><br><span class="line">dis.reg(<span class="string">'cmd2'</span>, <span class="keyword">lambda</span> self: print(<span class="number">2</span>))</span><br><span class="line">dis.reg(<span class="string">'cmd3'</span>, <span class="keyword">lambda</span> self: print(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">dis.run()</span><br></pre></td></tr></table></figure>
<p>反射相关的魔术方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'__getattr__'</span>, item)</span><br><span class="line">        </span><br><span class="line">print(A(<span class="number">10</span>).x)</span><br><span class="line">print(A(<span class="number">10</span>).y)</span><br><span class="line">=================================================================================================</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(Base)</span>:</span></span><br><span class="line">    m = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'__getattr__'</span>, item)</span><br><span class="line">        <span class="comment"># self.__dict__[item]  = # 找不到给一个缺省值 </span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(key, value)</span><br><span class="line"><span class="comment"># 当设置一个属性的时候，这个setattr方法是一定会被触发的，但是究竟放不放到里面去就是我们的事了   </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'delattr'</span>)   <span class="comment"># 删除实例属性</span></span><br><span class="line"><span class="comment"># setattr和delattr是不论是否找到了属性，就会被触发。getattr是如果找到了并且定义了才会被触发，不然即使找到也不会触发。一般delete都是删除自己有的属性，setattr有没有没关系，都可以加进来，getattr如果没有就找不到，应该抛异常的，但是因为有getattr方法，如果找不到getattr就会拦一道，有了这个拦截，异常就没有了。</span></span><br><span class="line">a = A(<span class="number">10</span>)</span><br><span class="line">a.x = <span class="number">100</span></span><br><span class="line">a.m = <span class="number">200</span></span><br><span class="line">print(a.__dict__)</span><br><span class="line">print(A.__dict__)</span><br><span class="line">a.y</span><br><span class="line">a.z</span><br><span class="line">a.m</span><br><span class="line">a.n  <span class="comment"># 这是测试__getattr__方法</span></span><br><span class="line"><span class="keyword">del</span> a.x</span><br><span class="line"><span class="keyword">del</span> a.m  <span class="comment"># 通过实例可以访问到的属性都可以删除</span></span><br></pre></td></tr></table></figure>
<p><code>__getattribute__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(Base)</span>:</span></span><br><span class="line">    m = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span><span class="params">(self, item)</span>:</span>  <span class="comment"># 这个方法会最先执行，但一般不用</span></span><br><span class="line">        print(<span class="string">'__getattribute__'</span>, item)</span><br><span class="line"><span class="comment"># get的意思就是拿回来，回去是靠return的，这些get方法一个return都没有，get方法一般就是把什么东西给人家送回去，但这里没有return，所以返回的是None。__getattr__方法是在翻了一遍字典没有翻到时执行的。__getattribute__是还没到字典去就起作用了，在找字典前，__getattribute__会拦住并执行一次</span></span><br><span class="line">		<span class="comment"># raise AttributeError(item)  # 这会跳过翻字典的过程，下面的getattr也会执行一次</span></span><br><span class="line">    	<span class="comment"># return self.__dict__[item]  # 这会产生递归调用，出现问题</span></span><br><span class="line">        <span class="keyword">return</span> object.__getattribute__(self, item)   <span class="comment"># 这样做是没必要的</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'__getattr__'</span>, item)</span><br><span class="line">        <span class="comment"># self.__dict__[item]  = # 找不到给一个缺省值 </span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(key, value)</span><br><span class="line"><span class="comment"># 当设置一个属性的时候，这个setattr方法是一定会被触发的，但是究竟放不放到里面去就是我们的事了   </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        print(<span class="string">'delattr'</span>)  </span><br><span class="line">        </span><br><span class="line">a = A(<span class="number">10</span>)</span><br><span class="line">print(a.x)  <span class="comment"># 这里getattribute调用了</span></span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python魔术方法/" rel="tag"># python魔术方法</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/07/python基础学习-多继承/" rel="next" title="python基础学习-多继承">
                <i class="fa fa-chevron-left"></i> python基础学习-多继承
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/08/python基础学习-描述器/" rel="prev" title="python基础学习-描述器">
                python基础学习-描述器 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概要
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">224</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">167</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#特殊属性"><span class="nav-number">1.</span> <span class="nav-text">特殊属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看属性"><span class="nav-number">2.</span> <span class="nav-text">查看属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#魔法方法"><span class="nav-number">3.</span> <span class="nav-text">魔法方法 ***</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hash"><span class="nav-number">4.</span> <span class="nav-text">hash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bool"><span class="nav-number">5.</span> <span class="nav-text">bool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#可视化"><span class="nav-number">6.</span> <span class="nav-text">可视化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运算符重载"><span class="nav-number">7.</span> <span class="nav-text">运算符重载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#运算符重载应用场景"><span class="nav-number">7.1.</span> <span class="nav-text">运算符重载应用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#functools-total-ordering-装饰器"><span class="nav-number">8.</span> <span class="nav-text">@functools.total_ordering 装饰器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#容器相关方法"><span class="nav-number">9.</span> <span class="nav-text">容器相关方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#可调用对象"><span class="nav-number">10.</span> <span class="nav-text">可调用对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上下文管理"><span class="nav-number">11.</span> <span class="nav-text">上下文管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上下文管理对象"><span class="nav-number">12.</span> <span class="nav-text">上下文管理对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上下文管理的安全性"><span class="nav-number">13.</span> <span class="nav-text">上下文管理的安全性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#with语句"><span class="nav-number">14.</span> <span class="nav-text">with语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#enter-方法和-exit-方法的参数"><span class="nav-number">15.</span> <span class="nav-text">__enter__方法和__exit__方法的参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习"><span class="nav-number">16.</span> <span class="nav-text">练习</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上下文应用场景"><span class="nav-number">17.</span> <span class="nav-text">上下文应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#contextlib-contextmanager"><span class="nav-number">18.</span> <span class="nav-text">contextlib.contextmanager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反射概述"><span class="nav-number">19.</span> <span class="nav-text">反射概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反射相关的函数和方法"><span class="nav-number">20.</span> <span class="nav-text">反射相关的函数和方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反射相关的魔术方法"><span class="nav-number">21.</span> <span class="nav-text">反射相关的魔术方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#getattr"><span class="nav-number">21.1.</span> <span class="nav-text">__getattr__()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setattr"><span class="nav-number">21.2.</span> <span class="nav-text">__setattr__()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#delattr"><span class="nav-number">21.3.</span> <span class="nav-text">__delattr__()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getattribute"><span class="nav-number">21.4.</span> <span class="nav-text">__getattribute__</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#笔记"><span class="nav-number">22.</span> <span class="nav-text">笔记</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
