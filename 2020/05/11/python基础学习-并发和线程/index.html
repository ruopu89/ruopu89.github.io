<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="并发基本概念并发和并行的区别并行，parallel 同时做某些事，可以互不干扰的同一个时刻做几件事 并发，concurrency 也是同时做某些事，但是强调，一个时段内有事情要处理 举例 乡村公路一条车道，半幅路面出现了坑，交警指挥交通。众多车辆在这一时段要通过路面的事件，这就是并发。交警指挥，车辆排队通过另外半幅路面，一个方向放行3分钟，停止该方向通行，换另一个方向放行。 高速公路的车道，双向4">
<meta name="keywords" content="python线程">
<meta property="og:type" content="article">
<meta property="og:title" content="python基础学习-并发和线程">
<meta property="og:url" content="http://yoursite.com/2020/05/11/python基础学习-并发和线程/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:description" content="并发基本概念并发和并行的区别并行，parallel 同时做某些事，可以互不干扰的同一个时刻做几件事 并发，concurrency 也是同时做某些事，但是强调，一个时段内有事情要处理 举例 乡村公路一条车道，半幅路面出现了坑，交警指挥交通。众多车辆在这一时段要通过路面的事件，这就是并发。交警指挥，车辆排队通过另外半幅路面，一个方向放行3分钟，停止该方向通行，换另一个方向放行。 高速公路的车道，双向4">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="http://yoursite.com/images/python线程与进程/线程与进程1.png">
<meta property="og:image" content="http://yoursite.com/images/python线程与进程/线程与进程2.png">
<meta property="og:updated_time" content="2020-09-09T08:26:03.267Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="python基础学习-并发和线程">
<meta name="twitter:description" content="并发基本概念并发和并行的区别并行，parallel 同时做某些事，可以互不干扰的同一个时刻做几件事 并发，concurrency 也是同时做某些事，但是强调，一个时段内有事情要处理 举例 乡村公路一条车道，半幅路面出现了坑，交警指挥交通。众多车辆在这一时段要通过路面的事件，这就是并发。交警指挥，车辆排队通过另外半幅路面，一个方向放行3分钟，停止该方向通行，换另一个方向放行。 高速公路的车道，双向4">
<meta name="twitter:image" content="http://yoursite.com/images/python线程与进程/线程与进程1.png">






  <link rel="canonical" href="http://yoursite.com/2020/05/11/python基础学习-并发和线程/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>python基础学习-并发和线程 | ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/python基础学习-并发和线程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">python基础学习-并发和线程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-05-11 09:22:33" itemprop="dateCreated datePublished" datetime="2020-05-11T09:22:33+08:00">2020-05-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-09-09 16:26:03" itemprop="dateModified" datetime="2020-09-09T16:26:03+08:00">2020-09-09</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             閱讀次數： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><h5 id="并发和并行的区别"><a href="#并发和并行的区别" class="headerlink" title="并发和并行的区别"></a>并发和并行的区别</h5><p>并行，parallel</p>
<p>同时做某些事，可以互不干扰的同一个时刻做几件事</p>
<p>并发，concurrency</p>
<p>也是同时做某些事，但是强调，一个时段内有事情要处理</p>
<p>举例</p>
<p>乡村公路一条车道，半幅路面出现了坑，交警指挥交通。众多车辆在这一时段要通过路面的事件，这就是并发。交警指挥，车辆排队通过另外半幅路面，一个方向放行3分钟，停止该方向通行，换另一个方向放行。</p>
<p>高速公路的车道，双向4车道，所有车辆（数据）可以互不干扰的在自己的车道上奔跑（传输）。在同一个时刻，每条车道上可能同时有车辆在跑，是同时发生的概念，这是并行。</p>
<h5 id="并发的解决"><a href="#并发的解决" class="headerlink" title="并发的解决"></a>并发的解决</h5><h6 id="食堂打饭模型"><a href="#食堂打饭模型" class="headerlink" title="食堂打饭模型"></a>食堂打饭模型</h6><p>中午12点，开饭啦，大家都涌向食堂，这就是并发。如果人很多，就是高并发。</p>
<ol>
<li>队列、缓冲区</li>
</ol>
<p>假设只有一个窗口，陆续涌入食堂的人，排队打菜是比较好的方式。所以，排队（队列）是一种天然解决并发的办法。排队就是把人排成队列，先进先出，解决了资源使用的问题。排成的队列，其实就是一个缓冲地带，就是缓冲区。</p>
<p>假设女生优先，那么这个窗口就得是两队，只要有女生来就可以先打饭，男生队列等着，女生队列就是一个优先队列。</p>
<p>例如queue模块的类Queue、LifoQueue、PriorityQueue</p>
<ol start="2">
<li>争抢</li>
</ol>
<p>只开一个窗口，有可能没有秩序，也就是谁挤进去就给谁打饭。挤到窗口的人占据窗口，直到打到饭菜离开。其他人继续争抢，会有一个人占据着窗口，可以视为锁定窗口，窗口就不能为其他人提供服务了。这是一种锁机制。谁抢到资源就上锁，排他性的锁，其他人只能等候。争抢也是一种高并发解决方案，但是，这样不好，因为有可能有人很长时间抢不到。</p>
<ol start="3">
<li>预处理</li>
</ol>
<p>如果排长队的原因，是由于每个人打菜等候时间长，因为要吃的菜没有，需要现做，没打着饭不走开，锁定着窗口。食堂可以提前统计大多数人最爱吃的菜品，将最爱的80%的热门菜，提前做好，保证供应，20%的冷门菜，现做。这样大多数人，就算锁定窗口，也很快就会释放窗口了。一种提前加载用户需要的数据的思路，预处理思想，缓存常用。</p>
<ol start="4">
<li>并行</li>
</ol>
<p>成百上千人同时来吃饭，一个队伍搞不定的，多开打饭窗口形成多个队列，如同开多个车道一样，并行打菜。开窗口就得扩大食堂，得多雇人在每一个窗口提供服务，造成成本上升。日常可以通过购买更多服务器，或多开进程、线程实现并行处理，来解决并发问题。注意这些都是水平扩展思想。</p>
<p>注：如果线程在单CPU上处理，就不是并行了。但是多数服务器都是多CPU的，服务的部署往往是多机的、分布式的，这都是并行处理。</p>
<ol start="5">
<li>提速</li>
</ol>
<p>提高单个窗口的打饭速度，也是解决并发的方式。打饭人员提高工作技能，或为单个窗口配备更多的服务人员，都是提速的办法。提高单个CPU性能，或单个服务器安装更多的CPU。这是一种垂直扩展思想。</p>
<ol start="6">
<li>消息中间件</li>
</ol>
<p>上地、西二旗地铁站外的九曲回肠的走廊，缓冲人流，进去之后再多口安检进站。常见的消息中间件有RabbitMQ、ActiveMQ (Apache)  、RocketMQ (阿里Apache)、kafka (Apache) 等。</p>
<p>当然还有其他手段解决并发问题，但是已经列举出了最常用的解决方案，一般来说不同的并发场景用不同的策略，而策略可能是多种方式的优化组合。例如多开食堂（多地），也可以把食堂建设到宿舍生活区（就近），所以说，技术来源于生活。</p>
<h4 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h4><p>在实现了线程的操作系统中，线程是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际动作单位。一个程序的执行实例就是一个进程。</p>
<p>进程（Process）是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。</p>
<p>进程和程序的关系是，程序是源代码编译后的文件，而这些文件存放在磁盘上。当程序被操作系统加载到内存中，就是进程，进程中存放着指令和数据（资源），它也是线程的容器。</p>
<p>Linux进程有父进程、子进程，windows的进程是平等关系。</p>
<p>线程，有时被称为轻量级进程（Lightweight Process, LWP），是程序执行流的最小单元。一个标准的线程由线程ID，当前指令指针（PC），寄存器集合和堆栈组成。在许多系统中，创建一个线程比创建一个进程快10-100倍。</p>
<p>进程、线程的理解</p>
<p>现代操作系统提出进程的概念，每一个进程都认为自己独占所有的计算机硬件资源。进程就是独立的王国，进程间不可以随便的共享数据。</p>
<p>线程就是省份，同一个进程内的线程可以共享进程的资源，每一个线程拥有自己独立的堆栈。</p>
<h4 id="线程的状态"><a href="#线程的状态" class="headerlink" title="线程的状态"></a>线程的状态</h4><table>
<thead>
<tr>
<th>状态</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>就绪（Ready）</td>
<td>线程能够运行，但在等待被调度。可能线程刚刚创建启动，或刚刚从阻塞中恢复，或者被其他线程抢占</td>
</tr>
<tr>
<td>运行（Running）</td>
<td>线程正在运行</td>
</tr>
<tr>
<td>阻塞（Blocked）</td>
<td>线程等待外部事件发生而无法运行，如I/O操作</td>
</tr>
<tr>
<td>终止（Terminated）</td>
<td>线程完成，或退出，或被取消</td>
</tr>
</tbody>
</table>
<p><img src="/images/python线程与进程/线程与进程1.png" alt=""></p>
<h4 id="Python中的进程和线程"><a href="#Python中的进程和线程" class="headerlink" title="Python中的进程和线程"></a>Python中的进程和线程</h4><p>进程会启动一个解释器进程，线程共享一个解释器进程</p>
<h4 id="Python的线程开发"><a href="#Python的线程开发" class="headerlink" title="Python的线程开发"></a>Python的线程开发</h4><p>Python的线程开发使用标准库<code>threading</code></p>
<h5 id="Thread类"><a href="#Thread类" class="headerlink" title="Thread类"></a>Thread类</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 签名</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, group=None, target=None, name=None, args=<span class="params">()</span>, kwargs=None, *, daemon=None)</span></span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>target</td>
<td>线程调用的对象，就是目标函数</td>
</tr>
<tr>
<td>name</td>
<td>为线程起个名字</td>
</tr>
<tr>
<td>args</td>
<td>为目标函数传递实参，元组</td>
</tr>
<tr>
<td>kwargs</td>
<td>为目标函数关键字传参，字典</td>
</tr>
</tbody>
</table>
<h5 id="线程启动"><a href="#线程启动" class="headerlink" title="线程启动"></a>线程启动</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最简单的线程程序</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"I'm working"</span>)</span><br><span class="line">    print(<span class="string">'Fineshed'</span>)</span><br><span class="line">    </span><br><span class="line">t = threading.Thread(target=worker, name=<span class="string">'worker'</span>)  <span class="comment"># 线程对象</span></span><br><span class="line">t.start()  <span class="comment"># 启动</span></span><br><span class="line">输出：</span><br><span class="line">I<span class="string">'m working</span></span><br><span class="line"><span class="string">Fineshed</span></span><br></pre></td></tr></table></figure>
<p>通过<code>threading.Thread</code>创建一个线程对象，<code>target</code>是目标函数，<code>name</code>可以指定名称。但是线程没有启动，需要调用<code>start</code>方法。</p>
<p>线程之所以执行函数，是因为线程中就是执行代码的，而最简单的封装就是函数，所以还是函数调用。函数执行完，线程也就退出了。那么，如果不让线程退出，或者让线程一直工作怎么办呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        print(<span class="string">"I'm working"</span>)</span><br><span class="line">    print(<span class="string">'Fineshed'</span>)</span><br><span class="line">t = threading.Thread(target=worker, name=<span class="string">'worker'</span>)  <span class="comment"># 线程对象</span></span><br><span class="line">t.start()  <span class="comment"># 启动</span></span><br></pre></td></tr></table></figure>
<h5 id="线程退出"><a href="#线程退出" class="headerlink" title="线程退出"></a>线程退出</h5><p>Python没有提供线程退出的方法，线程在下面情况时退出</p>
<ol>
<li>线程函数内语句执行完毕</li>
<li>线程函数中抛出未处理的异常</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">5</span>):</span><br><span class="line">            <span class="comment"># raise RuntimeError(count)</span></span><br><span class="line">            <span class="comment"># return</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        print(<span class="string">"I'm working"</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">t = threading.Thread(target=worker, name=<span class="string">'worker'</span>)  <span class="comment"># 线程对象</span></span><br><span class="line">t.start()  <span class="comment"># 启动</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'===End==='</span>)</span><br><span class="line">输出：</span><br><span class="line">=====end=====</span><br><span class="line">I<span class="string">'m working</span></span><br><span class="line"><span class="string">I'</span>m working</span><br><span class="line">I<span class="string">'m working</span></span><br><span class="line"><span class="string">I'</span>m working</span><br><span class="line">I<span class="string">'m working</span></span><br><span class="line"><span class="string">I'</span>m working</span><br></pre></td></tr></table></figure>
<p>Python的线程没有优先级、没有线程组的概念，也不能被销毁、停止、挂起，那也就没有恢复、中断了。</p>
<h5 id="线程的传参"><a href="#线程的传参" class="headerlink" title="线程的传参"></a>线程的传参</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,y)</span>:</span></span><br><span class="line">    print(<span class="string">'&#123;&#125; + &#123;&#125; = &#123;&#125;'</span>.format(x, y, x + y, threading.current_thread().ident))</span><br><span class="line">thread1 = threading.Thread(target=add, name=<span class="string">'add'</span>, args=(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">thread1.start()</span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">thread2 = threading.Thread(target=add, name=<span class="string">'add'</span>, args=(<span class="number">5</span>,), kwargs=&#123;<span class="string">'y'</span>:<span class="number">4</span>&#125;)  <span class="comment"># 线程对象</span></span><br><span class="line">thread2.start()  <span class="comment"># 启动</span></span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">thread3 = threading.Thread(target=add, name=<span class="string">'add'</span>, kwargs=&#123;<span class="string">'x'</span>:<span class="number">4</span>, <span class="string">'y'</span>:<span class="number">5</span>&#125;) <span class="comment"># 线程对象</span></span><br><span class="line">thread3.start() <span class="comment"># 启动</span></span><br></pre></td></tr></table></figure>
<p>线程传参和函数传参没什么区别，本质上就是函数传参。</p>
<h5 id="threading的属性和方法"><a href="#threading的属性和方法" class="headerlink" title="threading的属性和方法"></a>threading的属性和方法</h5><table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>current_thread()</td>
<td>返回当前线程对象</td>
</tr>
<tr>
<td>main_thread()</td>
<td>返回主线程对象</td>
</tr>
<tr>
<td>active_count()</td>
<td>当前处于alive状态的线程个数</td>
</tr>
<tr>
<td>enumerate()</td>
<td>返回所有活着的线程的列表，不包括已经终止的线程和未开始的线程</td>
</tr>
<tr>
<td>get_ident()</td>
<td>返回当前线程的ID，非0整数</td>
</tr>
</tbody>
</table>
<p><code>active_count</code>、<code>enumerate</code>方法返回的值还包括主线程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showthreadinfo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"currentthread = &#123;&#125;"</span>.format(threading.current_thread()))</span><br><span class="line">    print(<span class="string">"main thread = &#123;&#125;"</span>.format(threading.main_thread()))</span><br><span class="line">    print(<span class="string">"active count = &#123;&#125;"</span>.format(threading.active_count()))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    showthreadinfo()</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">5</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        print(<span class="string">"I'm working"</span>)</span><br><span class="line">        </span><br><span class="line">t = threading.Thread(target=worker, name=<span class="string">'worker'</span>)  <span class="comment"># 线程对象</span></span><br><span class="line">showthreadinfo()</span><br><span class="line">t.start()  <span class="comment"># 启动</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'===End==='</span>)</span><br></pre></td></tr></table></figure>
<h5 id="Thread实例的属性和方法"><a href="#Thread实例的属性和方法" class="headerlink" title="Thread实例的属性和方法"></a>Thread实例的属性和方法</h5><table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>只是一个名字，只是个标识，名称可以重免。<code>getName()</code>、<code>setName()</code>获取、设置这个名词</td>
</tr>
<tr>
<td>ident</td>
<td>线程ID，它是非0整数。线程启动后才会有ID，否则为None。线程退出，此ID依旧可以访问。此ID可以重复使用。线程ID在使用时是唯一的，活着的线程就有ID</td>
</tr>
<tr>
<td>is_alive()</td>
<td>返回线程是否活着</td>
</tr>
</tbody>
</table>
<p>注意：线程的name这是一个名称，可以重复；ID必须唯 一，但可以在线程退出后再利用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">5</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        print(threading.current_thread().name)</span><br><span class="line">        </span><br><span class="line">t = threading.Thread(name=<span class="string">'worker'</span>, target=worker)</span><br><span class="line">print(t.ident)</span><br><span class="line">t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> t.is_alive():</span><br><span class="line">        print(<span class="string">'&#123;&#125; &#123;&#125; alive'</span>.format(t.name, t.ident))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'&#123;&#125; &#123;&#125; dead'</span>.format(t.name, t.ident))</span><br><span class="line">        t.start()  <span class="comment"># 可以吗？</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>start()</td>
<td>启动线程。每一个线程必须且只能执行该方法一次</td>
</tr>
<tr>
<td>run()</td>
<td>运行线程函数</td>
</tr>
</tbody>
</table>
<p>为了演示，派生一个Thread的子类</p>
<h5 id="start-方法"><a href="#start-方法" class="headerlink" title="start 方法"></a>start 方法</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">5</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        print(<span class="string">'worker running'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'start~~~~~~~~~~~~~~'</span>)</span><br><span class="line">        super().start()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'run~~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">        super().run()</span><br><span class="line">        </span><br><span class="line">t = MyThread(name=<span class="string">'worker'</span>, target=worker)</span><br><span class="line">t.start()</span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">start~~~~~~~~~~~~</span><br><span class="line">run~~~~~~~~~~~~~~</span><br><span class="line">worker running</span><br></pre></td></tr></table></figure>
<h5 id="run方法"><a href="#run方法" class="headerlink" title="run方法"></a>run方法</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">5</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        print(<span class="string">'worker running'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'start~~~~~~~~~~~~~~'</span>)</span><br><span class="line">        super().start()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'run~~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">        super().run()</span><br><span class="line">        </span><br><span class="line">t = MyThread(name=<span class="string">'worker'</span>, target=worker)</span><br><span class="line"><span class="comment"># t.start()</span></span><br><span class="line">t.run()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">run~~~~~~~~~~~~~~~</span><br><span class="line">worker running</span><br></pre></td></tr></table></figure>
<p><code>start()</code>方法会调用<code>run()</code>方法，而<code>run()</code>方法可以运行函数。这两个方法看似功能重复了，这么看来留一个方法就可以了。是这样吗？</p>
<h5 id="start和run的区别"><a href="#start和run的区别" class="headerlink" title="start和run的区别"></a>start和run的区别</h5><p>在线程函数中，增加打印线程的名字的语句，看看能看到什么信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">5</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        print(<span class="string">'worker running'</span>)</span><br><span class="line">        print(threading.current_thread().name)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'start~~~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">        super().start()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'run~~~~~~~~~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">        super().run()</span><br><span class="line">        </span><br><span class="line">t = MyThread(name=<span class="string">'worker'</span>, target=worker)</span><br><span class="line">t.start()</span><br><span class="line"><span class="comment"># t.run()  # 分别执行start或者run方法</span></span><br></pre></td></tr></table></figure>
<p>使用start方法启动线程，启动了一个新的线程，名字叫做worker运行。但是使用run方法的，并没有启动新的线程，就是在主线程中调用了一个普通的函数而已。</p>
<h5 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h5><p>顾名思义，多个线程，一个进程中如果有多个线程，就是多线程，实现一种并发。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">5</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        print(<span class="string">'worker running'</span>)</span><br><span class="line">        print(threading.current_thread().name, threading.current_thread().ident)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'start~~~~~~~~~~~~~~'</span>)</span><br><span class="line">        super().start()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'run~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">        super().run()  <span class="comment"># 看看父类在做什么</span></span><br><span class="line">        </span><br><span class="line">t1 = MyThread(name=<span class="string">'worker1'</span>, target=worker)</span><br><span class="line">t2 = MyThread(name=<span class="string">'worker2'</span>, target=worker)</span><br><span class="line"></span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br></pre></td></tr></table></figure>
<p>可以看到worker1和work2交替执行</p>
<p>改成run方法试试看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">5</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        print(<span class="string">'worker running'</span>)</span><br><span class="line">        print(threading.current_thread().name, threading.current_thread().ident)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'start~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">        super().start()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'run~~~~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">        super().run()</span><br><span class="line">        </span><br><span class="line">t1 = MyThread(name=<span class="string">'worker1'</span>, target=worker)</span><br><span class="line">t2 = MyThread(name=<span class="string">'worker2'</span>, target=worker)</span><br><span class="line"></span><br><span class="line"><span class="comment"># t1.start()</span></span><br><span class="line"><span class="comment"># t2.start()</span></span><br><span class="line">t1.run()</span><br><span class="line">t2.run()</span><br></pre></td></tr></table></figure>
<p>没有开新的线程，这就是普通函数调用，所以执行完<code>t1.run()</code>，然后执行<code>t2.run()</code>，这里就不是多线程。当使用start方法启动线程后，进程内有多个活动的线程并行的工作，就是多线程。一个进程中至少有一个线程，并作为程序的入口，这个线程就是主线程。一个进程至少有一个主线程。其他线程称为工作线程。</p>
<h5 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h5><p>IPython中演示，python命令行、pycharm都不能演示出效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        print(<span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread().name))</span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> rnage(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">    name = <span class="string">"worker&#123;&#125;"</span>.format(x)</span><br><span class="line">    t = threading.Thread(name=name, target=worker)</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>
<p><img src="/images/python线程与进程/线程与进程2.png" alt=""></p>
<p>看代码，应该是一行行打印，但是很多字符串打在了一起，为什么？</p>
<p>说明，print函数被打断了，被线程切换打断了。print函数分两步，第一步打印字符串，第二步换行，就在这之间，发生了线程的切换。这说明print函数是线程不安全的。</p>
<blockquote>
<p>  线程安全指线程执行一段代码，不会产生不确定的结果，那这段代码就是线程安全的</p>
</blockquote>
<p>上例中，本以为print应该是打印文本之后紧跟着一个换行的，但是有时候确实好几个文本在一起，后面跟上换行，而且发生这种情况的时机不确定，所以，print函数不是线程安全函数。如果是这样，多线程编程的时候，print输出日志，不能保证一个输出一定后面立即换行了，怎么办？</p>
<ol>
<li>不让print打印换行</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        print(<span class="string">"&#123;&#125; is running. \n"</span>.format(threading.current_thread().name), end=<span class="string">''</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">    name = <span class="string">"worker&#123;&#125;.format(x)"</span></span><br><span class="line">    t = threading.Thread(name=name, target=worker)</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>
<p>字符串是不可变的类型，它可以作为一个整体不可分割输出。<code>end=&#39;&#39;</code>就不在让print输出换行了。</p>
<ol start="2">
<li>使用logging</li>
</ol>
<p>标准库里面的logging模块，日志处理模块，线程安全的，生成环境代码都使用logging</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        <span class="comment"># print("&#123;&#125; is running. \n".format(threading.current_thread().name), end='')</span></span><br><span class="line">        logging.warning(<span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread().name))</span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">    name = <span class="string">"worker&#123;&#125;"</span>.format(x)</span><br><span class="line">    t = threading.Thread(name=name, target=worker)</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>
<h5 id="daemon线程和non-daemon线程"><a href="#daemon线程和non-daemon线程" class="headerlink" title="daemon线程和non-daemon线程"></a>daemon线程和non-daemon线程</h5><p>注意：这里的daemon不是Linux中的守护进程</p>
<p>进程靠线程执行代码，至少有一个主线程，其它线程是工作线程。主线程是第一个启动的线程。</p>
<p>父线程：如果线程A中启动了一个线程B，A就是B的父线程。</p>
<p>子线程：B就是A的子线程</p>
<p>Python中，构造线程的时候，可以设置daemon属性，这个属性必须在start方法前设置好。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 源码Thread的__init__方法中</span></span><br><span class="line"><span class="keyword">if</span> daemon <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">    self._daemonic = daemon  <span class="comment"># 用户设定bool值</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    self._daemonic = current_thread().daemon</span><br><span class="line">self._ident = <span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p>线程daemon属性，如果设定就是用户的设置，否则就取当前线程的daemon值</p>
<p>主线程是non-daemon线程，即daemon = False</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">        print(i)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 主线程是non-daemon线程</span></span><br><span class="line">t = threading.Thread(target=foo, daemon=<span class="keyword">False</span>)</span><br><span class="line">t.start()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Main Thread Exiting'</span>)</span><br></pre></td></tr></table></figure>
<p>发现线程t依然执行，主线程已经执行完，但是一直等着线程t。</p>
<p>修改为<code>t = threading.Thread(target=foo, daemon=True)</code>试一试</p>
<p>程序立即结束了，根本没有等线程t</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>daemon属性</td>
<td>表示线程是否是daemon线程，这个值必须在start()之前设置，否则引发RuntimeError异常</td>
</tr>
<tr>
<td>isDaemon()</td>
<td>是否是daemon线程</td>
</tr>
<tr>
<td>setDaemon</td>
<td>设置为daemon线程，必须在start方法之前设置</td>
</tr>
</tbody>
</table>
<p>总结</p>
<p>线程具有一个daemon属性，可以显示设置为True或False，也可以不设置，则取默认值None。如果不设置daemon，就取当前线程的daemon来设置它。daemon如果不设置True或False，就要取父线程的daemon值。当前线程才能启动你，所以这也是你的父线程。主线程是non-daemon线程，即daemon = False。从主线程创建的所有线程的不设置daemon属性，则默认都是daemon = False，也就是non-daemon线程。Python程序在没有活着的non-daemon线程运行时退出，也就是剩下的只能是daemon线程，主线程才能退出，否则主线程就只能等待。</p>
<p>由于任何进程默认都会启动一个线程，我们把该线程称为主线程，其他非主线程称为工作线程，Python的<code>threading</code>模块有个<code>current_thread()</code>函数，它永远返回当前的线程的实例。</p>
<p>思考下面的程序的输出是什么？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line">    print(<span class="string">'bar'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">        print(i)</span><br><span class="line">    t = threading.Thread(target=bar, daemon=<span class="keyword">False</span>)</span><br><span class="line">    t.start()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 主线程是non-daemon线程</span></span><br><span class="line">t = threading.Thread(target=foo, daemon=<span class="keyword">True</span>)</span><br><span class="line">t.start()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Main Thread Exiting'</span>)</span><br></pre></td></tr></table></figure>
<p>上例中，会不会输出bar这个字符串，如果没有，如何修改才能打印出来？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line">print(<span class="string">'Main Thread Exiting'</span>)</span><br></pre></td></tr></table></figure>
<p>再看一个例子，看看主线程合适结束daemon线程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        print(i)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">t1 = threading.Thread(target=foo, args=(<span class="number">10</span>,), daemon=<span class="keyword">True</span>)  <span class="comment"># 调换10和20看看效果</span></span><br><span class="line">t1.start()</span><br><span class="line"></span><br><span class="line">t2 = threading.Thread(target=foo, args=(<span class="number">20</span>,), daemon=<span class="keyword">False</span>)</span><br><span class="line">t2.start()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line">print(<span class="string">'Main Thread Exiting'</span>)</span><br></pre></td></tr></table></figure>
<p>上例说明，如果有non-daemon线程的时候，主线程退出时，也不会杀掉所有daemon线程，直到所有non-daemon线程全部结束，如果还有daemon线程，主线程需要退出，会结束所有daemon线程，退出。</p>
<h5 id="join方法"><a href="#join方法" class="headerlink" title="join方法"></a>join方法</h5><p>先看一个简单的例子，看看效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        print(i)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">t1 = threading.Thread(target=foo, args=(<span class="number">10</span>,), daemon=<span class="keyword">True</span>)</span><br><span class="line">t1.start()</span><br><span class="line">t1.join()  <span class="comment"># 设置join，取消join对比一下</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'Main Thread Exiting'</span>)</span><br></pre></td></tr></table></figure>
<p>使用了join方法后，daemon线程执行完了，主线程才退出了。</p>
<p><code>join(timeout=None)</code>，是线程的标准方法之一。</p>
<p>一个线程中调用另一个线程的join方法，调用者将被阻塞，直到被调用线程终止。一个线程可以被join多次。timeout参数指定调用者等待多久，没有设置超时，就一直等到被调用线程结束。调用谁的join方法，就是join谁，就要等谁。</p>
<h5 id="daemon线程应用场景"><a href="#daemon线程应用场景" class="headerlink" title="daemon线程应用场景"></a>daemon线程应用场景</h5><p>简单来说就是，本来并没有daemon thread，为了简化程序员的工作，让他们不用去记录和管理那些后台线程，创造了一个daemon thread的概念。这个概念唯一的作用就是，当你把一个线程设置为daemon，它会随主线程的退出而退出。</p>
<p>主要应用场景有：</p>
<ol>
<li>后台任务。如发送心跳包、监控，这种场景最多。</li>
<li>主线程工作才有用的线程。如主线程中维护关公共的资源，主线程已经清理了，准备退出，而工作线程使用这些资源工作也没有意义了，一起退出最合适。</li>
<li>随时可以被终止的线程</li>
</ol>
<p>如果主线程退出，想所有其它工作线程一起退出，就使用daemon=True来创建工作线程。比如，开启一个线程定时判断WEB服务是否正常工作，主线程退出，工作线程也没有必要存在了，应该随着主线程退出一起退出。这种daemon线程一旦创建，就可以忘记它了，只用关心主线程什么时候退出就行了。</p>
<p>daemon线程，简化了程序员手动关闭线程的工作。</p>
<p>如果non-daemon线程A中，对另一个daemon线程B使用了join方法，这个线程B设置成daemon就没有什么意义了，因为non-daemon线程A总是要等待B。</p>
<p>如果在一个daemon线程C中，对另一个daemon线程D使用了join方法，只能说明C要等待D，主线程退出，C和D不管是否结束，也不管它们谁等谁，都要被杀掉。</p>
<p>举例</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        print(<span class="string">'bar'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"t1's daemon = &#123;&#125;"</span>.format(threading.current_thread().isDaemon()))</span><br><span class="line">    t2 = threading.Thread(target=bar)</span><br><span class="line">    t2.start()</span><br><span class="line">    print(<span class="string">"t2's daemon = &#123;&#125;"</span>.format(t2.isDaemon()))</span><br><span class="line">    </span><br><span class="line">t1 = threading.Thread(target=foo, daemon=<span class="keyword">True</span>)</span><br><span class="line">t1.start()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">print(<span class="string">'Main Thread Exiting'</span>)</span><br></pre></td></tr></table></figure>
<p>上例，只要主线程要退出，2个工作线程都结束。可以使用join，让线程结束不了，怎么做？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        print(<span class="string">'bar'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"t1's daemon = &#123;&#125;"</span>.format(threading.current_thread().isDaemon()))</span><br><span class="line">    t2 = threading.Thread(target=bar)</span><br><span class="line">    t2.start()</span><br><span class="line">    print(<span class="string">"t2's daemon = &#123;&#125;"</span>.format(t2.isDaemon()))</span><br><span class="line">    t2.join()</span><br><span class="line">    </span><br><span class="line">t1 = threading.Thread(target=foo, daemon=<span class="keyword">True</span>)</span><br><span class="line">t1.start()</span><br><span class="line"></span><br><span class="line">t1.join()</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">print(<span class="string">'Main Thread Exiting'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="threading-local类"><a href="#threading-local类" class="headerlink" title="threading.local类"></a>threading.local类</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 局部变量实现</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    x = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        time.sleep(<span class="number">0.0001</span>)</span><br><span class="line">        x += <span class="number">1</span></span><br><span class="line">    print(threading.current_thread(), x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    threading.Thread(target=worker).start()</span><br></pre></td></tr></table></figure>
<p>上例使用多线程，每个线程完成不同的计算任务。x是局部变量。能否改造成使用全局变量完成</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.x = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 全局对象</span></span><br><span class="line">global_data = A()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    global_data.x = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        time.sleep(<span class="number">0.0001</span>)</span><br><span class="line">        global_data.x += <span class="number">1</span></span><br><span class="line">    print(threading.current_thread(), global_data.x)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    threading.Thread(target=worker).start()</span><br></pre></td></tr></table></figure>
<p>上例虽然使用了全局对象，但是线程之间互相干扰，导致了错误的结果。能不能使用全局对象，还能保持每个线程使用不同的数据呢？</p>
<p>python提供<code>threading.local</code>类，将这个类实例化得到一个全局对象，但是不同的线程使用这个对象存储的数据其他线程看不见。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局对象</span></span><br><span class="line">global_data = threading.local()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    global_data.x = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        time.sleep(<span class="number">0.0001</span>)</span><br><span class="line">        global_data.x += <span class="number">1</span></span><br><span class="line">    print(threading.current_thread(), global_data.x)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    threading.Thread(target=worker).start()</span><br></pre></td></tr></table></figure>
<p>结果显示和使用局部变量的效果一样。再看看threading.local的例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">X = <span class="string">'abc'</span></span><br><span class="line">ctx = threading.local()  <span class="comment"># 注意这个对象所处的线程</span></span><br><span class="line">ctx.x = <span class="number">123</span></span><br><span class="line"></span><br><span class="line">print(ctx, type(ctx), ctx.x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    print(X)</span><br><span class="line">    print(ctx)</span><br><span class="line">    print(ctx.x)</span><br><span class="line">    print(<span class="string">'working'</span>)</span><br><span class="line">    </span><br><span class="line">worker()  <span class="comment"># 普通函数调用</span></span><br><span class="line">print()</span><br><span class="line">threading.Thread(target=worker).start()  <span class="comment"># 另起一个线程</span></span><br></pre></td></tr></table></figure>
<p>从运行结果来看，另起一个线程打印ctx.x出错了。</p>
<p><code>AttributeError: &#39;_thread._local&#39; object has no attribute &#39;x&#39;</code></p>
<p>但是，ctx打印没有出错，说明看到ctx，但是ctx中的x看不到，这个x不能跨线程。</p>
<p>threading.local类构建了一个大字典，其元素是每一线程实例的地址为key和线程对象引用线程单独的字典的映射，如下：<code>{ id(Thread) -&gt; (ref(Thread), thread-local dict) }</code>，通过threading.local实例就可在不同的线程中，安全地使用线程独有的数据，做到了线程间数据隔离，如同本地变量一样安全。</p>
<h5 id="定时器Timer-延迟执行"><a href="#定时器Timer-延迟执行" class="headerlink" title="定时器Timer/延迟执行"></a>定时器Timer/延迟执行</h5><p>threading.Timer继承自Thread，这个类用来定义多久执行一个函数。</p>
<p><code>class threading.Timer(interval, function, args=None, kwargs=None)</code></p>
<p>start方法执行之后，Timer对象会处于等待状态，等待了interval之后，开始执行function函数的。如果在执行函数之前的等待阶段，使用了cancel方法，就会跳过执行函数结束。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">FORMAT = <span class="string">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span></span><br><span class="line">logging.basicConfig(format=FORMAT, level=logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    logging.info(<span class="string">'in worker'</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">t = threading.Timer(<span class="number">5</span>, worker)</span><br><span class="line">t.setName(<span class="string">'w1'</span>)</span><br><span class="line">t.start()  <span class="comment"># 启动线程</span></span><br><span class="line">print(threading.enumerate())</span><br><span class="line">t.cancel()  <span class="comment"># 取消，可以注释这一句看看如何定时执行</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">print(threading.enumerate())</span><br></pre></td></tr></table></figure>
<p>如果线程中worker函数已经开始执行，cancel就没有任何效果了。</p>
<p>总结</p>
<p>Timer是线程Thread的子类，就是线程类，具有线程的能力和待征。</p>
<p>它的实例是能够延时执行目标函数的线程，在真正执行目标函数之前，都可以cancel它</p>
<p>提前cancel</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">FORMAT = <span class="string">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span></span><br><span class="line">logging.basicConfig(format=FORMAT, level=logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    logging.info(<span class="string">'in worker'</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">t = threading.Timer(<span class="number">5</span>, worker)</span><br><span class="line">t.setName(<span class="string">'w1'</span>)</span><br><span class="line">t.cancel()  <span class="comment"># 提前取消</span></span><br><span class="line">t.start()  <span class="comment"># 启动线程</span></span><br><span class="line">print(threading.enumerate())</span><br><span class="line">time.sleep(<span class="number">8</span>)</span><br><span class="line">print(threading.enumerate())</span><br></pre></td></tr></table></figure>
<h3 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h3><p>流式处理是串行的。栈是在线程中的，而不是在函数中。</p>
<p>现代操作系统提出进程的概念，每一个进程都认为自己独占所有的计算机硬件资源。进程就是独立的王国，进程间不可以随便的共享数据。</p>
<p>线程就是省份，同一个进程内的线程可以共享进程的资源，每一个线程拥有自己独立的堆栈。</p>
<p>资源是在进程上的，线程是共享进程的资源。进程之间是国与国的关系，线程之间是省与省的关系，大家可以共享国家内的资源。每个线程应该有自己的栈。最小的调度是线程，基本单位是进程。CPU天生就是时分复用的</p>
<p>Thread类</p>
<p>target 目标执行的函数是谁。我们在模块中写了很多类和方法，<strong><em>类的方法就是函数，线程中无非就是拿到某个实例然后执行它的方法，这还是在执行函数，所以主线程是在执行函数，其他线程也只是在执行函数而已，只是函数中使用什么数据结构是我们自己传递的。用对象的目的也就是用对象的方法，这也是函数。线程都是执行操作的，操作就是函数。</em></strong>name是给自己看的，所以可以重名</p>
<p>线程是用来解决并发的问题的，线程是一种假并行，如果只有一个CPU，就会每个线程都执行一会儿，只是调度太快，让人感觉像是并行。如果有多个CPU才是真并行</p>
<p>python中没有线程退出的方式，所以用达到某个条件退出，python中没有优先级和线程组的概念，也不能销毁</p>
<p>enumerate打印的是其他工作的线程和主线程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'welcome magedu'</span>)</span><br><span class="line">    print(<span class="string">'thread over'</span>)</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=worker)</span><br><span class="line"><span class="comment"># Thread是一个类，我们要给这个类实例化并传一个参数，这里不需要给worker函数传参，就不需要写args参数</span></span><br><span class="line">t.start()</span><br><span class="line">输出：</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line"><span class="comment"># 这里感觉不到有两个线程</span></span><br><span class="line">========================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        print(<span class="string">'welcome magedu'</span>)</span><br><span class="line">        print(<span class="string">'thread over'</span>)</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=worker)</span><br><span class="line">t.start()</span><br><span class="line"><span class="comment"># 主线程执行完t.start()后，def worker():才准备启动，这时主线程在等待。def worker():线程启动以后一直要</span></span><br><span class="line"><span class="comment"># 执行到这个函数执行完，函数执行完，这个线程就结束了，如果要让函数执行不完，就要把for循环改成while True循</span></span><br><span class="line"><span class="comment"># 环，这样t线程就不会结束，这样所在模块的主线程就会一直等待下去，一直要等待这个t线程执行结束，但因为是无限循</span></span><br><span class="line"><span class="comment"># 环，主线程就会一直等待</span></span><br><span class="line"><span class="comment"># 这是顺序执行的，所以执行到t.start()时，主线程已经执行完了。因为是顺序执行，t.start()是模块内最后一句代</span></span><br><span class="line"><span class="comment"># 码，所以执行完后，主线程也就执行完了，threading.Thread()是在工作线程中执行的，主线程会等待工作线程执行</span></span><br><span class="line"><span class="comment"># 完才结束</span></span><br><span class="line">输出：</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line"><span class="comment"># 线程是一种假并行，这是一种并发的解决方法，因为只有一个CPU，调度很快，所以感觉是并行。在多个CPU上同时跑是并行</span></span><br><span class="line">========================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        print(<span class="string">'welcome magedu'</span>)</span><br><span class="line">    print(<span class="string">'thread over'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        print(<span class="string">'welcome magedu......'</span>)</span><br><span class="line">    print(<span class="string">'thread over......'</span>)</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=worker, name=<span class="string">'w1'</span>)</span><br><span class="line">t.start()</span><br><span class="line"><span class="comment"># 启动之后就会被CPU调度。这里启动完就不用管了，所以名称给别人用也没有问题</span></span><br><span class="line">t = threading.Thread(target=worker1, name=<span class="string">'w1'</span>)</span><br><span class="line">t.start()</span><br><span class="line">输出：</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu ......</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu ......</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu ......</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu ......</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu ......</span><br><span class="line">welcome mageduwelcome magedu ......</span><br><span class="line"></span><br><span class="line">welcome magedu ......welcome magedu</span><br><span class="line"></span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu ......</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu ......</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">welcome magedu ......</span><br><span class="line">thread over ......</span><br><span class="line"><span class="comment"># 从结果可以看出是两个线程每个执行一次，基本是交替的执行，不能换行打印是print()函数有线程不安全的表现。当函</span></span><br><span class="line"><span class="comment"># 数执行完，这个线程也就该消亡了。</span></span><br><span class="line"><span class="comment"># 如果把第一个for循环改成while True，但看到提示永远执行不到print('thread over......')，如果要死循环退</span></span><br><span class="line"><span class="comment"># 出，在循环中加上某个标记即可。因为线程可以获取到进程的资源</span></span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        print(<span class="string">'welcome magedu'</span>)</span><br><span class="line">    print(<span class="string">'thread over'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker1</span><span class="params">()</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        print(<span class="string">'welcome magedu......'</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> count &gt; <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'New exception'</span>)</span><br><span class="line">    print(<span class="string">'thread over......'</span>)</span><br><span class="line"><span class="comment"># 这个循环会先退出，并抛出异常。但不会影响另一个线程。异常抛出到最外层就是当前线程，如果当前线程也没办法，就会终止</span></span><br><span class="line">t = threading.Thread(target=worker, name=<span class="string">'w1'</span>)</span><br><span class="line">t.start()</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=worker1, name=<span class="string">'w1'</span>)</span><br><span class="line">t.start()</span><br><span class="line">输出：</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu......</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu......</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu......</span><br><span class="line">Exception <span class="keyword">in</span> thread w1:</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/.pyenv/versions/3.8.0/lib/python3.8/threading.py"</span>, line <span class="number">932</span>, <span class="keyword">in</span> _bootstrap_inner</span><br><span class="line">    self.run()</span><br><span class="line">  File <span class="string">"/home/shouyu/.pyenv/versions/3.8.0/lib/python3.8/threading.py"</span>, line <span class="number">870</span>, <span class="keyword">in</span> run</span><br><span class="line">    self._target(*self._args, **self._kwargs)</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/并发与并行.py"</span>, line <span class="number">17</span>, <span class="keyword">in</span> worker1</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">'New exception'</span>)</span><br><span class="line">Exception: New exception</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu......</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">=======================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(n):</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        print(<span class="string">'welcome magedu'</span>)</span><br><span class="line">    print(<span class="string">'thread over'</span>)</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=worker, name=<span class="string">'w1'</span>, args=(<span class="number">5</span>,))</span><br><span class="line"><span class="comment"># 传参时用args更方便，要用元组的方式，不能直接写数值。如果用kwargs，要用字典，如kwargs=&#123;'n':5&#125;，这显得有些麻烦了</span></span><br><span class="line">t.start()</span><br><span class="line">输出：</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">=======================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">(n=<span class="number">5</span>)</span>:</span></span><br><span class="line">    print(threading.current_thread())  <span class="comment"># 返回当前线程对象</span></span><br><span class="line">    <span class="comment"># 这里会调用str方法，处于哪个线程中就是谁</span></span><br><span class="line">    print(threading.main_thread())  <span class="comment"># 返回主线程对象</span></span><br><span class="line"><span class="comment"># 当线程执行时才会执行到这里。从结果看，还没有启动线程前这里就显示已经停止了，但并没有死，对其他线程来说。这</span></span><br><span class="line"><span class="comment"># 两条拿到的都是对象，所以可以使用print(threading.current_thread().name)，因为是对象，所以其他属性也</span></span><br><span class="line"><span class="comment"># 可以拿到</span></span><br><span class="line">	print(threading.active_count())  <span class="comment"># 当前处于alive状态的线程个数</span></span><br><span class="line"><span class="comment"># 这里输出是2，表示有两个活着的线程，一个主线程一个工作线程</span></span><br><span class="line">	print(threading.enumerate())  <span class="comment"># 返回所有活着的线程的列表，不包括已经终止的线程和未开始的线程</span></span><br><span class="line"><span class="comment"># 这里可以看到打印出了两个活着的线程列表，一个主线程一个工作线程</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(n):</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        print(<span class="string">'welcome magedu'</span>)</span><br><span class="line">    print(<span class="string">'thread over'</span>)</span><br><span class="line"></span><br><span class="line">print(threading.current_thread())</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=worker, name=<span class="string">'w1'</span>, args=(<span class="number">5</span>,))</span><br><span class="line"><span class="comment"># 线程如果很多，可以用容器保存它</span></span><br><span class="line">t.start()</span><br><span class="line"></span><br><span class="line">print(threading.enumerate())</span><br><span class="line"><span class="comment"># 从这里的输出可以看出，是主线程停止了，但子线程还没在继续</span></span><br><span class="line">输出：</span><br><span class="line">&lt;_MainThread(MainThread, started <span class="number">140381055660672</span>)&gt;</span><br><span class="line"><span class="comment"># 这是主线程中的current_thread输出的</span></span><br><span class="line">&lt;Thread(w1, started <span class="number">140381044815616</span>)&gt;[&lt;_MainThread(MainThread, started <span class="number">140381055660672</span>)&gt;, &lt;Thread(w1, started <span class="number">140381044815616</span>)&gt;]</span><br><span class="line"><span class="comment"># &lt;Thread(w1, started 140381044815616)&gt;是工作线程的current_thread输出的，后面的列表是工作线程的enumerate输出的</span></span><br><span class="line"></span><br><span class="line">&lt;_MainThread(MainThread, stopped <span class="number">140381055660672</span>)&gt;</span><br><span class="line"><span class="comment"># 这是工作线程的main_thread输出的</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="comment"># 这是工作线程的active_thread输出的</span></span><br><span class="line">[&lt;_MainThread(MainThread, stopped <span class="number">140381055660672</span>)&gt;, &lt;Thread(w1, started <span class="number">140381044815616</span>)&gt;]</span><br><span class="line"><span class="comment"># 这还是工作线程的enumerate输出的</span></span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line"><span class="comment"># 到结束退出时，都未执行过主线程的enumerate</span></span><br></pre></td></tr></table></figure>
<p>Thread实例的属性和方法</p>
<p>上面说的都是在threading模块上的，下面说的是thread类的实例</p>
<p>ident表示线程ID，活着的线程的ID是唯一的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在多线程中，代码本身会执行一次，这就是主线程。t = threading.Thread()、t.start()会再执行一次，这是子线</span></span><br><span class="line"><span class="comment"># 程。多线程中，谁先执行是没法确定的，只能知道多线程都有机会执行到，线程越多情况越复杂</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">(n=<span class="number">5</span>)</span>:</span></span><br><span class="line">    print(threading.current_thread().name)</span><br><span class="line">    print(threading.main_thread().name)  <span class="comment"># 可以通过返回的线程对象拿名称</span></span><br><span class="line"><span class="comment"># 返回线程对象而不是确定值的原因是，通过这种方式可能拿到对象，对象的所有属性也都可以拿到，所以就没必要返回其他东西了</span></span><br><span class="line">    print(threading.active_count())</span><br><span class="line">    print(threading.enumerate())</span><br><span class="line">    print(threading.current_thread().is_alive())  <span class="comment"># 查看当前线程是否活着</span></span><br><span class="line">    print(<span class="string">"in worker. &#123;&#125;"</span>.format(threading.main_thread().is_alive()))</span><br><span class="line"><span class="comment"># 这里输出的False说明主线程已经停止了。is_alive()表示返回线程是否活着</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(n):</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        print(<span class="string">'welcome magedu'</span>)</span><br><span class="line">    print(<span class="string">'thread over'</span>)</span><br><span class="line"></span><br><span class="line">print(threading.current_thread())</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=worker, name=<span class="string">'w1'</span>, args=(<span class="number">5</span>,))</span><br><span class="line"><span class="comment"># Thread是一个类，我们要给这个类实例化并传一个参数，这里不需要给worker函数传参，就不需要写args</span></span><br><span class="line">t.start()</span><br><span class="line">t1 = threading.Thread(target=worker, name=<span class="string">'w1'</span>, args=(<span class="number">5</span>,))</span><br><span class="line">print(threading.enumerate())</span><br><span class="line">print(<span class="number">1</span>, threading.current_thread().is_alive())</span><br><span class="line"><span class="comment"># 这里的输出说明当前线程还是活着的</span></span><br><span class="line">输出：</span><br><span class="line">&lt;_MainThread(MainThread, started <span class="number">140525449664320</span>)&gt;</span><br><span class="line">w1</span><br><span class="line">MainThread</span><br><span class="line"><span class="number">2</span></span><br><span class="line">[&lt;_MainThread(MainThread, started <span class="number">140525449664320</span>)&gt;, &lt;Thread(w1, started <span class="number">140525438035712</span>)&gt;]</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="keyword">in</span> worker <span class="keyword">True</span></span><br><span class="line">[&lt;_MainThread(MainThread, started <span class="number">140525449664320</span>)&gt;, &lt;Thread(w1, started <span class="number">140525438035712</span>)&gt;]</span><br><span class="line"><span class="number">1</span> <span class="keyword">True</span></span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br></pre></td></tr></table></figure>
<p>start方法和run方法</p>
<p>start()启动线程，每个线程必须且只能执行该方法一次。run()运行线程函数</p>
<p>start()方法才会启用多线程。run()方法只是函数调用，是顺序执行的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span>  <span class="comment"># 继承</span></span><br><span class="line"><span class="comment"># 使用pycharm中右键里的Generate中的override重写下面两个方法，这两个方法是 threading.Thread的</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        print(<span class="string">'start'</span>)  <span class="comment"># 因为执行时什么都看不到，所以这里打印一个run</span></span><br><span class="line">        super().start()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        print(<span class="string">'run'</span>)   <span class="comment"># 这里也一样是为了看执行效果</span></span><br><span class="line">        super().run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">(n=<span class="number">5</span>)</span>:</span></span><br><span class="line">    print(threading.current_thread())</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(n):</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        print(<span class="string">'welcome magedu'</span>)</span><br><span class="line">    print(<span class="string">'thread over'</span>)</span><br><span class="line"></span><br><span class="line">print(threading.current_thread())</span><br><span class="line"></span><br><span class="line">t = MyThread(target=worker, name=<span class="string">'w1'</span>)</span><br><span class="line"><span class="comment"># Thread是一个类，我们要给这个类实例化并传一个参数，这里不需要给worker函数传参，就不需要写</span></span><br><span class="line">t.start()</span><br><span class="line"><span class="comment"># print('~~~~~~~~~~~~~~~~~~~~~~~')</span></span><br><span class="line"><span class="comment"># time.sleep(5)</span></span><br><span class="line"><span class="comment"># print("worker thread is &#123;&#125;".format(t.is_alive()))  </span></span><br><span class="line"><span class="comment"># 这可以看出t线程已经关闭了，但下面使用start依然会报错，提示 threads can only be started once</span></span><br><span class="line"><span class="comment"># t.start()  # 这里会报错，因为已经执行过一次了，执行到上面start方法的super().start()时，是调用父类的</span></span><br><span class="line"><span class="comment"># start方法，这时会报错：threads can only be started once</span></span><br><span class="line"><span class="comment"># t = MyThread(target=worker, name='w1')</span></span><br><span class="line"><span class="comment"># t.start()</span></span><br><span class="line"><span class="comment"># 如果要再用一次start，就要再写一次t = MyThread(target=worker, name='w1')</span></span><br><span class="line"><span class="comment"># t.run</span></span><br><span class="line"><span class="comment"># 如果删除run方法中的super().run()，可以执行两次run方法，否则也不可以执行两次。</span></span><br><span class="line"><span class="comment"># 这与继承也没有关系，将MyThread改为threading.Thread也没用，还是一样的</span></span><br><span class="line">输出：</span><br><span class="line">&lt;_MainThread(MainThread, started <span class="number">140479684605760</span>)&gt;</span><br><span class="line">start</span><br><span class="line">run</span><br><span class="line">&lt;MyThread(w1, started <span class="number">140446219572992</span>)&gt;</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line"><span class="comment"># 从t.start()结果看，调用了run方法，但实际并没有调用过run方法。如果调用run方法，这里还是会显示run。run方</span></span><br><span class="line"><span class="comment"># 法是调用terget所指的线程函数。如果使用两次t.start()，会抛出异常，因为start只能调用一次，如果要使用两次</span></span><br><span class="line"><span class="comment"># t.start，就要定义两次t变量。</span></span><br><span class="line"></span><br><span class="line">t.run()</span><br><span class="line">print(<span class="string">'=============================='</span>) </span><br><span class="line"><span class="comment"># 看等号什么时候出现。从输出结果可以看出先执行t.run()再执行t1.run()，这是顺序执行，这是函数调用。run方法就</span></span><br><span class="line"><span class="comment"># 是调用线程所指向的target函数，如t = MyThread(target=worker, name='w1')，这里的target就是worker。</span></span><br><span class="line"><span class="comment"># 函数没有返回，就不能走到下面去，这不是多线程，这是顺序执行，与多线程无关</span></span><br><span class="line"><span class="comment"># 如果将run改为start，执行时就会先打印等号，之后打印两个不同的start线程号</span></span><br><span class="line"><span class="comment"># 从以上事例可以说明，start用在多线程场景，run是函数调用，run是在当前线程中做函数的顺序执行的，它是一个函数</span></span><br><span class="line"><span class="comment"># 调用，因为主线程也是一个线程，所以可以在主线程或线程中做run，也就是说run()只有一个线程，所有代码都在主线程</span></span><br><span class="line"><span class="comment"># 中执行。start才是我们想要的，主线程启动一个，再启动一个工作线程</span></span><br><span class="line"><span class="comment"># start不仅仅是要启动线程，它的目标还要运行某一个函数，这个函数是用target传入的，这时候要调用run，只是在另</span></span><br><span class="line"><span class="comment"># 一个线程中要去执行这个函数中的内容。start启动线程后还要调用run方法，因为在线程里要执行一个函数，run方法是</span></span><br><span class="line"><span class="comment"># 函数调用</span></span><br><span class="line">t1 = MyThread(target=worker, name=<span class="string">'w2'</span>)</span><br><span class="line">t1.run()</span><br><span class="line"><span class="comment"># 从输出结果可以看出run()方法是顺序执行，而start()方法是开启线程的</span></span><br><span class="line">输出：</span><br><span class="line">&lt;_MainThread(MainThread, started <span class="number">140468961544000</span>)&gt;   </span><br><span class="line"><span class="comment"># 这是主线程中的print(threading.current_thread())，这个print函数也只打印了一次</span></span><br><span class="line">run</span><br><span class="line">&lt;_MainThread(MainThread, started <span class="number">140468961544000</span>)&gt;</span><br><span class="line"><span class="comment"># 这是worker函数中的print(threading.current_thread())</span></span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line">===================================</span><br><span class="line">run</span><br><span class="line"><span class="number">12345</span> &lt;_MainThread(MainThread, started <span class="number">140468961544000</span>)&gt;</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">welcome magedu</span><br><span class="line">thread over</span><br><span class="line"><span class="comment"># t.run()和t1.run()的执行结果，可以看到&lt;_MainThread(MainThread, started 140468961544000)&gt;中都是</span></span><br><span class="line"><span class="comment"># MainThread，证明只有主线程在运行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过run与start的运行结果可以看出，用start时显示在w1线程中，使用run时显示在MainThread中跑。显示为</span></span><br><span class="line"><span class="comment"># &lt;_MainThread(MainThread, started 6944)&gt;。这说明run就不开新线程了，run是在主线程调用，这是函数调用，与线程无关</span></span><br></pre></td></tr></table></figure>
<p>多线程</p>
<p>第一个启动的线程是主线程，主线程之外的线程称为工作线程。这与父线程子线程是两码事。主线程指启动时必须要有一个线程，它也不能再切换了，主线程必须存在，借用主线程再创建新的线程就是工作线程，工作线程可以创建很多个，工作线程中还可以创建工作线程，超过一个线程就是多线程</p>
<p><code>threading.Thread（）</code>就是开线程的方法</p>
<p>进程运行起来就必须有一个线程，这个线程必须有一个入口，不然不知道从哪儿开始执行。其他程序中有main函数，python中相当于把主模块模块名改了，改成<code>__main__</code>了，这个主模块就是入口，还可以带参数进来，带参数决定了程序在启动时应该拥有什么特性，因为在启动前就传入了</p>
<p>能不加锁，最好不加</p>
<p>logging日志模块。<code>logging.basicConfig()</code>是可以带格式输出的模块，非常重要</p>
<p>线程安全指在线程中这个函数、类、数据结构在使用过程中是不可以被线程随意打断的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        print(<span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread()))</span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    threading.Thread(target=worker, name=<span class="string">"worker-&#123;&#125;"</span>.format(x)).start()</span><br><span class="line">输出：</span><br><span class="line">&lt;Thread(worker<span class="number">-1</span>, started <span class="number">140441785194240</span>)&gt; <span class="keyword">is</span> running&lt;Thread(worker<span class="number">-0</span>, started <span class="number">140441767798528</span>)&gt; <span class="keyword">is</span> running            </span><br><span class="line">&lt;Thread(worker<span class="number">-4</span>, started <span class="number">140441359603456</span>)&gt; <span class="keyword">is</span> running                                                                  </span><br><span class="line">                                                                                                                        </span><br><span class="line">&lt;Thread(worker<span class="number">-3</span>, started <span class="number">140441759143680</span>)&gt; <span class="keyword">is</span> running                                                                  </span><br><span class="line">&lt;Thread(worker<span class="number">-2</span>, started <span class="number">140441776539392</span>)&gt; <span class="keyword">is</span> running&lt;Thread(worker<span class="number">-4</span>, started <span class="number">140441359603456</span>)&gt; <span class="keyword">is</span> running            </span><br><span class="line">&lt;Thread(worker<span class="number">-0</span>, started <span class="number">140441767798528</span>)&gt; <span class="keyword">is</span> running                                                                  </span><br><span class="line">                                                                                                                        </span><br><span class="line">&lt;Thread(worker<span class="number">-1</span>, started <span class="number">140441785194240</span>)&gt; <span class="keyword">is</span> running                                                                  </span><br><span class="line">&lt;Thread(worker<span class="number">-3</span>, started <span class="number">140441759143680</span>)&gt; <span class="keyword">is</span> running&lt;Thread(worker<span class="number">-0</span>, started <span class="number">140441767798528</span>)&gt; <span class="keyword">is</span> running            </span><br><span class="line">&lt;Thread(worker<span class="number">-4</span>, started <span class="number">140441359603456</span>)&gt; <span class="keyword">is</span> running&lt;Thread(worker<span class="number">-1</span>, started <span class="number">140441785194240</span>)&gt; <span class="keyword">is</span> running   </span><br><span class="line"><span class="comment"># 要在IPython中执行，可以看到print语句被打断了（两个print语句打印在一行，中间不换行），这就叫线程不安全。</span></span><br><span class="line"><span class="comment"># 这种可以被打断的就叫线程不安全，只有一直执行完函数再进行下一步才是线程安全。print在多线程中是不安全的</span></span><br><span class="line">========================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        print(<span class="string">"&#123;&#125; is running\n"</span>.format(threading.current_thread()), end=<span class="string">""</span>)</span><br><span class="line"><span class="comment"># 这是通过一种字符串拼接的方法解决线程不安全的问题   </span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    threading.Thread(target=worker, name=<span class="string">"worker-&#123;&#125;"</span>.format(x)).start()</span><br><span class="line">========================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="comment"># 这里level=logging.INFO可以调整日志级别高低，这样下面就可以打印了</span></span><br><span class="line"><span class="comment"># 通过这个模块也可以实现线程安全，这个模块不允许被打断</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">		msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">		logging.info(msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">	threading.Thread(target=worker, name=<span class="string">"worker-&#123;&#125;"</span>.format(x)).start()</span><br><span class="line"><span class="comment"># 这里不会有输出，因为logging.info()默认是warning级别，所以不会打印msg信息。所以要用logging.basicConfig</span></span><br></pre></td></tr></table></figure>
<p>个人理解，主线程就是工作线程执行的函数以外的代码，在模块中任何代码中使用的threading.Thread(target=, name=)就是在启动工作线程，函数外部的代码是主线程，比如使用join时，让工作线程全部结束后再执行主线程，也就是threading.Thread()执行完以后，再执行模块中最外层的代码。如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(p)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">0.001</span>)</span><br><span class="line">    print(p)</span><br><span class="line"></span><br><span class="line">ts = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">15</span>):</span><br><span class="line">    th = threading.Thread(target=test, args=[i])</span><br><span class="line">    ts.append(th)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ts:</span><br><span class="line">    i.start()</span><br><span class="line">    <span class="comment"># i.join()</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"it is end !"</span>)</span><br><span class="line">输出：</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">it <span class="keyword">is</span> end !  <span class="comment"># 主线程在工作线程之前结束了</span></span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in ts: 中加入 i.join()后的输出是等子线程都结束后再执行主线程，如下：</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span></span><br><span class="line">it <span class="keyword">is</span> end !</span><br></pre></td></tr></table></figure>
<p>就目前执行结果来看，1. 工作线程要执行的函数以外的属于主线程执行的部分，函数内的函数属于工作线程执行的部分；2. 在默认情况下，调用线程的部分（主线程）会先执行完，被调用的部分（工作线程）之后才会执行。比如，主线程使用<code>threading.Thread()</code>开启工作线程，那么主线程执行完以后，工作线程才会执行；3. 线程是执行函数的，可以在类中定义</p>
<p>daemon线程和non-daemon线程</p>
<p>daemon线程指后台线程，提供某种服务的，主线程看到有daemon为True，在主线程结束时会结束子线程。python要杀掉一个线程，首先看这个线程是不是daemon的，如果是，再看有没有non-daemon的，如果有，就会等一会这个线程，如果没有non-daemon的，全是daemon的时候，会把这些线程杀掉，然后自己结束。</p>
<p>如果是daemon的线程，在使用的时候不应该考虑它会从头至尾完全执行完，有可能在执行中就被杀掉了。如果要让一个线程完整的执行完，就要用non-daemon。daemon里要放一些随时启动或关闭都不影响的工作</p>
<p>daemon就是在后台，提供某种服务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line">        </span><br><span class="line">threading.Thread(target=worker, name=<span class="string">"$$$$worker-&#123;&#125;"</span>.format(<span class="number">0</span>), daemon=<span class="keyword">True</span>).start()</span><br><span class="line"><span class="comment"># 这是daemon的，下一条是non-daemon的，有non-daemon时就是等待，non-daemon执行完daemon的也会被终止，不</span></span><br><span class="line"><span class="comment"># 论daemon的是否执行完了</span></span><br><span class="line">threading.Thread(target=worker1, name=<span class="string">"worker1-&#123;&#125;"</span>.format(<span class="number">0</span>)).start()</span><br><span class="line"><span class="comment"># 这一句就开启了另一个线程，这是假并行的</span></span><br><span class="line">print(<span class="string">'ending'</span>)</span><br><span class="line"><span class="comment"># 结果显示主线程很早就结束了，打印了ending。每次执行的结果是不一样的</span></span><br><span class="line">print(threading.enumerate()) </span><br><span class="line"><span class="comment"># enumerate会返回活着的加主线程，主线程如果停了，其他线程都要结束，所以主线程要等待</span></span><br><span class="line"><span class="comment"># 输出中没有规律，是因为线程。logging自己会开启一个线程跑</span></span><br><span class="line">输出：</span><br><span class="line">ending</span><br><span class="line">[&lt;_MainThread(MainThread, started <span class="number">140719044067968</span>)&gt;, &lt;Thread(worker<span class="number">-0</span>, started <span class="number">140719032436480</span>)&gt;]</span><br><span class="line">INFO:root:&lt;Thread(worker<span class="number">-0</span>, started <span class="number">140719032436480</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker<span class="number">-0</span>, started <span class="number">140719032436480</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line"><span class="meta">... </span>...</span><br><span class="line">==========================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    threading.Thread(target=worker1, name=<span class="string">"worker1-&#123;&#125;"</span>.format(<span class="number">0</span>)).start()</span><br><span class="line"><span class="comment"># worker是daemon线程，如果不明确指定daemon，worker中的线程会从当前线程上直接把daemon拿过来，也是一个daemon线程，虽然这里没有设置daemon=True</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line">        </span><br><span class="line">threading.Thread(target=worker, name=<span class="string">"$$$$worker-&#123;&#125;"</span>.format(<span class="number">0</span>), daemon=<span class="keyword">True</span>).start()</span><br><span class="line"><span class="comment"># 这是daemon的，下一条是non-daemon的，有non-daemon时就是等待，non-daemon执行完daemon的也会被终止，不论daemon的是否执行完了</span></span><br><span class="line"><span class="comment"># 这里应该有三个线程，35行和46行，还有一个主线程，因为都是daemon，所以主线程不会等待</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'ending'</span>)</span><br><span class="line"><span class="comment"># 结果显示主线程很早就结束了，打印了ending</span></span><br><span class="line">print(threading.enumerate()) </span><br><span class="line">输出：</span><br><span class="line">ending</span><br><span class="line">[&lt;_MainThread(MainThread, started <span class="number">139644457051968</span>)&gt;, &lt;Thread($$$$worker<span class="number">-0</span>, started daemon <span class="number">139644445161216</span>)&gt;, &lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139644436768512</span>)&gt;]</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139644436768512</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread($$$$worker<span class="number">-0</span>, started daemon <span class="number">139644445161216</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139644436768512</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line"><span class="comment"># 每次执行的结果都不一样</span></span><br><span class="line">==========================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    threading.Thread(target=worker1, name=<span class="string">"worker1-&#123;&#125;"</span>.format(<span class="number">0</span>), daemon=<span class="keyword">False</span>).start()</span><br><span class="line"><span class="comment"># 主线程可以将daemon线程终止，但不是父线程。主线程运行到最后时，发现有daemon线程，直接kill掉，这是子线程</span></span><br><span class="line"><span class="comment"># 还没有运行起来的时候。如果子线程运行起来了，worker中的non-daemon线程就运行起来了，因为是non-daemon，</span></span><br><span class="line"><span class="comment"># 所以主线程会等待。父线程结束，子线程不会消亡。父子线程只能说明谁启动了谁，但并不代表父线程就管着子线程。主</span></span><br><span class="line"><span class="comment"># 线程才可以将daemon线程kill掉。主线程要杀掉一个线程，首先看这个线程是不是daemon的，如果要杀掉daemon线</span></span><br><span class="line"><span class="comment"># 程，还要看一下是否有non-daemon线程，如果有就会等待。如果只有daemon线程，就会kill掉daemon，并结束主线</span></span><br><span class="line"><span class="comment"># 程。主线程是non-daemon的</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125;, &#123;&#125; is running"</span>.format(x, threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line">        </span><br><span class="line">threading.Thread(target=worker, name=<span class="string">"$$$$worker-&#123;&#125;"</span>.format(<span class="number">0</span>), daemon=<span class="keyword">True</span>).start()</span><br><span class="line"><span class="comment"># 这是daemon的，下一条是non-daemon的，有non-daemon时就是等待，non-daemon执行完daemon的也会被终止，不</span></span><br><span class="line"><span class="comment"># 论daemon的是否执行完了</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'ending'</span>)</span><br><span class="line"><span class="comment"># 结果显示主线程很早就结束了，打印了ending</span></span><br><span class="line">print(threading.enumerate()) </span><br><span class="line">输出：</span><br><span class="line">ending</span><br><span class="line">[&lt;_MainThread(MainThread, started <span class="number">139695582807872</span>)&gt;, &lt;Thread($$$$worker<span class="number">-0</span>, started daemon <span class="number">139695570917120</span>)&gt;, &lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt;]</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:<span class="number">0</span>, &lt;Thread($$$$worker<span class="number">-0</span>, started daemon <span class="number">139695570917120</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker1<span class="number">-0</span>, started daemon <span class="number">139695489021696</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line"><span class="comment"># 每次输出结果都不一样，是否因为worker线程是daemon的，而worker1线程是non-daemon的，有可能执行worker线</span></span><br><span class="line"><span class="comment"># 程后，还没有来得及在worker线程中执行worker1线程就被主线程结束了，也可能在worker线程中执行了几个</span></span><br><span class="line"><span class="comment"># worker1线程当被执行的worker1线程执行完以后，就被主线程结束了。所以每次执行的结果不一样。</span></span><br><span class="line">==========================================================================================</span><br><span class="line"><span class="comment"># 线程并不是越多越好，数量增加，管理成本也会增加。简单才是美的</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line">		threading.Thread(target=worker1, name=<span class="string">"worker1-&#123;&#125;"</span>.format(<span class="number">0</span>), daemon=<span class="keyword">False</span>).start()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line">        </span><br><span class="line">threading.Thread(target=worker, name=<span class="string">"worker-&#123;&#125;"</span>.format(<span class="number">0</span>), daemon=<span class="keyword">True</span>).start()  </span><br><span class="line"><span class="comment"># 加入daemon后，打印几行不确定</span></span><br><span class="line">time.sleep(<span class="number">0.5</span>)  <span class="comment"># 唾一会就会让子线程开始运行，</span></span><br><span class="line">print(<span class="string">'ending'</span>)</span><br><span class="line">print(threading.enumerate())</span><br><span class="line"></span><br><span class="line">==========================================================================================</span><br><span class="line"><span class="comment"># 如果是一个daemon线程，在使用时，不应该考虑完整地从头到尾执行完。如果想让一个工作有始有终地执行完，就把它构建成一个non-daemon线程。daemon里要放一些随时启动关闭都不影响的工作。</span></span><br><span class="line"><span class="comment"># daemon如果不设置True或False，就要取父线程的daemon值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line">        print(threading.enumerate())</span><br><span class="line"></span><br><span class="line">threading.Thread(target=worker, name=<span class="string">"worker-&#123;&#125;"</span>.format(<span class="number">0</span>), daemon=<span class="keyword">True</span>).start()  </span><br><span class="line"><span class="comment"># 加入daemon后，打印几行不确定</span></span><br><span class="line">print(<span class="string">'ending'</span>)</span><br><span class="line">print(threading.enumerate())</span><br><span class="line">输出：</span><br><span class="line">ending[&lt;_MainThread(MainThread, started <span class="number">140621146665600</span>)&gt;, &lt;Thread(worker<span class="number">-0</span>, started daemon <span class="number">140621135034112</span>)&gt;]</span><br><span class="line"></span><br><span class="line">[&lt;_MainThread(MainThread, started <span class="number">140621146665600</span>)&gt;, &lt;Thread(worker<span class="number">-0</span>, started daemon <span class="number">140621135034112</span>)&gt;]</span><br><span class="line">[&lt;_MainThread(MainThread, stopped <span class="number">140621146665600</span>)&gt;, &lt;Thread(worker<span class="number">-0</span>, started daemon <span class="number">140621135034112</span>)&gt;]INFO:root:&lt;Thread(worker<span class="number">-0</span>, started daemon <span class="number">140621135034112</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">INFO:root:&lt;Thread(worker<span class="number">-0</span>, started daemon <span class="number">140621135034112</span>)&gt; <span class="keyword">is</span> running</span><br><span class="line">========================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line">        print(threading.enumerate())</span><br><span class="line">        threading.Thread(target=worker1, name=<span class="string">"worker-&#123;&#125;"</span>.format(<span class="number">0</span>), daemon=<span class="keyword">False</span>).start()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        msg = <span class="string">"$$$$$$$$$&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line"></span><br><span class="line">threading.Thread(target=worker, name=<span class="string">"worker-&#123;&#125;"</span>.format(<span class="number">0</span>), daemon=<span class="keyword">True</span>).start()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">0.5</span>)  <span class="comment"># 让主线程歇一会</span></span><br><span class="line">print(<span class="string">'ending'</span>)</span><br><span class="line">print(threading.enumerate())</span><br><span class="line"><span class="comment"># 线程不是越多越好，越多代表管理成本越高</span></span><br></pre></td></tr></table></figure>
<p>join</p>
<p>join是标准的线程函数之一，它的意思是等待，谁调用join谁等待，如下面的t.join()是被主线程调用的，那么主线程就会等t，可以理解为join(t)。这时的deamon和non-deamon就不起作用了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line">        print(threading.enumerate())</span><br><span class="line">        threading.Thread(target=worker1, name=<span class="string">"worker-&#123;&#125;"</span>.format(x), daemon=<span class="keyword">True</span>).start()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        msg = <span class="string">"$$$$$$$$$&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=worker, daemon=<span class="keyword">True</span>, name=<span class="string">"worker-&#123;&#125;"</span>.format(<span class="number">0</span>))</span><br><span class="line"><span class="comment"># 现在除了主线程，全部都是daemon的。</span></span><br><span class="line">t.start()</span><br><span class="line">t.join()</span><br><span class="line"><span class="comment"># 下面两句没执行？实际是早就执行过了，但并未退出</span></span><br><span class="line">print(<span class="string">'ending'</span>)</span><br><span class="line">print(threading.enumerate())</span><br><span class="line">============================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        msg = <span class="string">"&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line">        print(threading.enumerate())</span><br><span class="line">        t = threading.Thread(target=worker1, name=<span class="string">"worker-&#123;&#125;"</span>.format(x), daemon=<span class="keyword">True</span>).start()</span><br><span class="line">        t.start()</span><br><span class="line">        t.join()</span><br><span class="line">        <span class="comment"># 这样写只能执行几行，就被终止了。join写在这里没什么用</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        msg = <span class="string">"$$$$$$$$$&#123;&#125; is running"</span>.format(threading.current_thread())</span><br><span class="line">        logging.info(msg)</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=worker, daemon=<span class="keyword">True</span>, name=<span class="string">"worker-&#123;&#125;"</span>.format(<span class="number">0</span>))</span><br><span class="line"><span class="comment"># 现在除了主线程，全部都是daemon的。</span></span><br><span class="line">t.start()</span><br><span class="line"><span class="comment"># t.join()</span></span><br><span class="line"><span class="comment"># 下面两句没执行？实际是早就执行过了，但并未退出</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># t.join()是被主线程调用的，主线程就等待t，可以理解为join(t)。用了join后，daemon就没什么用了。在哪个线程里，谁调用我的join，谁就必须等我。上面worker中的join表示t线程必须等worker中的线程，但主线程不会等，所以会全部终止掉。这里可以理解为join到t上去了，当前线程是谁，谁就join谁，谁就要等谁。t.join()表示主线程join到t上去，主线程就要等t，即使t是daemon，也要等它执行完。</span></span><br><span class="line">print(<span class="string">'ending'</span>)</span><br><span class="line">print(threading.enumerate())</span><br></pre></td></tr></table></figure>
<p>threading.local类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    x = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        time.sleep(<span class="number">0.0001</span>)</span><br><span class="line">        x += <span class="number">1</span></span><br><span class="line">    print(threading.current_thread(), x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    threading.Thread(target=worker).start()</span><br><span class="line">输出：</span><br><span class="line">&lt;Thread(Thread<span class="number">-2</span>, started <span class="number">140586102150912</span>)&gt; <span class="number">100</span></span><br><span class="line">&lt;Thread(Thread<span class="number">-3</span>, started <span class="number">140586023646976</span>)&gt; &lt;Thread(Thread<span class="number">-5</span>, started <span class="number">140586006861568</span>)&gt;<span class="number">100</span></span><br><span class="line"> <span class="number">100</span></span><br><span class="line">&lt;Thread(Thread<span class="number">-4</span>, started <span class="number">140586015254272</span>)&gt; <span class="number">100</span></span><br><span class="line">&lt;Thread(Thread<span class="number">-1</span>, started <span class="number">140586110543616</span>)&gt; <span class="number">100</span></span><br><span class="line">&lt;Thread(Thread<span class="number">-8</span>, started <span class="number">140585981683456</span>)&gt;&lt;Thread(Thread<span class="number">-7</span>, started <span class="number">140585990076160</span>)&gt; <span class="number">100</span> </span><br><span class="line"><span class="number">100</span></span><br><span class="line">&lt;Thread(Thread<span class="number">-6</span>, started <span class="number">140585998468864</span>)&gt; <span class="number">100</span></span><br><span class="line">&lt;Thread(Thread<span class="number">-10</span>, started <span class="number">140585419667200</span>)&gt; <span class="number">100</span></span><br><span class="line">&lt;Thread(Thread<span class="number">-9</span>, started <span class="number">140585973290752</span>)&gt; <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数要往自己线程的栈里压，每次在同一个线程内调用同一个函数，每次压栈都不一样，这是局部变量的好处。局部变量</span></span><br><span class="line"><span class="comment"># 可以解决多线程里的问题，你要用的变量如果是全局的，其他线程也能用，大家都能用就没有隔离了</span></span><br><span class="line"><span class="comment"># 从一个函数来理解每一次线程的调用，是在栈上重新来做x，x是局部变量。换到另一个线程就不一样了，函数有自己的</span></span><br><span class="line"><span class="comment"># 栈，这就是隔离的概念。</span></span><br><span class="line"><span class="comment"># 没有多线程，函数一样要压栈，每次压栈的地址是不一样的。局部变量就是一小段内存地址是它自己用，和别的变量无</span></span><br><span class="line"><span class="comment"># 关。</span></span><br><span class="line"><span class="comment"># 函数本身就有个隔离，函数有自己的作用域。如果用全局变量就没法控制了。对线程来讲就是在不同的线程中使用或不使</span></span><br><span class="line"><span class="comment"># 用这个公共资源，线程就是执行函数，这和在主线程中执行函数一样。局部变量不用加锁</span></span><br><span class="line"><span class="comment"># 线程有自己的堆栈，函数是要压栈的，往自己的线程的栈压，每一次在同一个线程内调同一个函数每次压栈都不一样，每</span></span><br><span class="line"><span class="comment"># 次压栈局部变量的地址是不一样的，而且局部变量只有一小段是它自己用，这样天然就隔离了，这就是局部变量的好处。</span></span><br><span class="line"><span class="comment"># 局部变量可以解决多线程里的问题，如果用的变量是外部的，那其他线程也可以用，这样就不能隔离了，就会有资源争</span></span><br><span class="line"><span class="comment"># 抢，隔离不了，使用的时候就出问题了。对于线程来讲就是在不同的线程中使用公共资源还是不使用这个资源，线程就是</span></span><br><span class="line"><span class="comment"># 执行一个函数，执行的函数在另一个线程中，进程中的资源也是可以访问到的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        </span><br><span class="line">a = A(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    a.x = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        time.sleep(<span class="number">0.0001</span>)</span><br><span class="line">        a.x += <span class="number">1</span></span><br><span class="line">    print(threading.current_thread(), a.x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    threading.Thread(target=worker).start()</span><br><span class="line"><span class="comment"># 这样是不可以了，执行结果不可预测。因为使用了全局变量a。如果把全局变量用字典来定义，使用id来区分，也可以使</span></span><br><span class="line"><span class="comment"># 用全局变量</span></span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">x = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> x</span><br><span class="line">    x = <span class="number">0</span>  <span class="comment"># 这里写这句也没用，因为用了global，这一句就是在全局作用域名赋值即定义。这个代码的结果也不可预知。因为每个线程启动时都要重新将全局变量x赋值为0</span></span><br><span class="line"><span class="comment"># 没有多线程，函数一样要压栈，每次压栈局部变量的地址是不一样的，而且局部变量就是一小段地址自己用，所以函数天</span></span><br><span class="line"><span class="comment"># 生就是隔离的，因为函数有自己的作用域</span></span><br><span class="line"><span class="comment"># 对于线程来讲，就是在不同的线程中使用公共资源还是不使用公共资源。线程就是执行你的函数，执行的函数在另一个线</span></span><br><span class="line"><span class="comment"># 程中，进程中的资源它是一样可以访问到的。既然是一个线程，执行的是自己的函数的局部变量，我使用它有什么问题？</span></span><br><span class="line"><span class="comment"># 与在主线程里执行这个函数使用局部变量是一个道理</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        time.sleep(<span class="number">0.0001</span>)</span><br><span class="line">        x += <span class="number">1</span></span><br><span class="line">    print(threading.current_thread(), x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    threading.Thread(target=worker).start()</span><br><span class="line">===========================================================================================</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">a = threading.local()  <span class="comment"># threading.local()是一个类，这是一个实例化的过程</span></span><br><span class="line"><span class="comment"># 使用threading.local()可以解决使用全局变量的问题。在线程中使用时就像使用本地变量一样。这是保存线程ID的？</span></span><br><span class="line"><span class="comment"># 输出结果与上面相同。threading.local()可以用一个全局变量大胆地在各线程中用，但是在这个线程中用就相当于在</span></span><br><span class="line"><span class="comment"># 这个线程中用的是它的本地变量一样，与其他线程没有任何关系，也就是这里用的a和其他线程中的a是不一样的。这一段</span></span><br><span class="line"><span class="comment"># 有问题，a哪里有x属性？a.x从哪儿来的？这实际是要说明使用threading.local()在全局定义一个变量，之后在函数</span></span><br><span class="line"><span class="comment"># 中使用时可以为这个全局变量添加任何属性。比如a.x，都像使用局部变量一样。另外，也可以看到每个函数的字典是不</span></span><br><span class="line"><span class="comment"># 一样的</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个进程都认为自己独占所有系统资源，每个进程都有自己的入口。所以进程内的线程地址可能相同</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">()</span>:</span></span><br><span class="line">    a.x = <span class="number">0</span> </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        time.sleep(<span class="number">0.0001</span>)</span><br><span class="line">        a.x += <span class="number">1</span></span><br><span class="line">    print(threading.current_thread(), a.x)</span><br><span class="line">    print(a.x.__dict__)  <span class="comment"># 不同线程内有自己的字典</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    threading.Thread(target=worker).start()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># d[key][0].name 拿前面线程的name; d[key][1][key2]</span></span><br><span class="line"><span class="comment"># 不同进程中的线程地址有没有可能一样</span></span><br><span class="line"><span class="comment"># 操作系统原理决定编程的水平</span></span><br><span class="line">输出：</span><br><span class="line">&lt;Thread(Thread<span class="number">-2</span>, started <span class="number">140635497330432</span>)&gt;&lt;Thread(Thread<span class="number">-3</span>, started <span class="number">140635415770880</span>)&gt;  <span class="number">100</span></span><br><span class="line"><span class="number">100</span></span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">100</span>&#125;</span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">100</span>&#125;</span><br><span class="line">&lt;Thread(Thread<span class="number">-4</span>, started <span class="number">140635407378176</span>)&gt;&lt;Thread(Thread<span class="number">-5</span>, started <span class="number">140635398985472</span>)&gt; <span class="number">100</span> <span class="number">100</span></span><br><span class="line">&#123;<span class="string">'x'</span>: <span class="number">100</span>&#125;  <span class="comment"># 线程不安全</span></span><br><span class="line"><span class="meta">... </span>...</span><br><span class="line">==========================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">X = <span class="string">'abc'</span></span><br><span class="line">ctx = threading.local()</span><br><span class="line">ctx.x = <span class="number">123</span></span><br><span class="line"></span><br><span class="line">print(ctx, type(ctx), ctx.x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">()</span>:</span></span><br><span class="line">    print(X)</span><br><span class="line">    print(ctx)</span><br><span class="line">    ctx.x = <span class="number">878</span></span><br><span class="line">    ctx.y = <span class="number">222</span></span><br><span class="line">    print(ctx.x) <span class="comment"># 如果上面不定义ctx.x = 878，这里就会报错</span></span><br><span class="line">    print(<span class="string">'Good job'</span>)</span><br><span class="line">    print(ctx.__dict__)</span><br><span class="line">    </span><br><span class="line">threading.Thread(target=work).start()</span><br><span class="line">输出：</span><br><span class="line">Exception <span class="keyword">in</span> thread Thread<span class="number">-1</span>:</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/home/shouyu/anaconda3/lib/python3.7/threading.py"</span>, line <span class="number">917</span>, <span class="keyword">in</span> _bootstrap_inner</span><br><span class="line">    self.run()</span><br><span class="line">  File <span class="string">"/home/shouyu/anaconda3/lib/python3.7/threading.py"</span>, line <span class="number">865</span>, <span class="keyword">in</span> run</span><br><span class="line">    self._target(*self._args, **self._kwargs)</span><br><span class="line">  File <span class="string">"/home/shouyu/PycharmProjects/test/练习/进程和线程/课上练习.py"</span>, line <span class="number">300</span>, <span class="keyword">in</span> work</span><br><span class="line">    print(ctx.x)  <span class="comment"># 如果上面不定义ctx.x = 878，这里就会报错</span></span><br><span class="line">AttributeError: <span class="string">'_thread._local'</span> object has no attribute <span class="string">'x'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用当前线程的key来找，没有ctx.x属性，除非在work函数中再重新定义一次ctx.x = 878。这说明</span></span><br><span class="line"><span class="comment"># threading.local()与线程地址是有关系的，ctx.x = 123是在主线程定义的，在work函数中的线程里找不到，所以</span></span><br><span class="line"><span class="comment"># 要在work函数中重新定义。用threading.local()就解决了线程之间不共享数据，但又用同一个对象。本质就是在一</span></span><br><span class="line"><span class="comment"># 个超大字典中套了一个以线程的地址为key的一些元素，但这些元素里的键值对一个是它的地址，这是key，后面有它自</span></span><br><span class="line"><span class="comment"># 己的引用和它的自己的一个小字典，小字典中放的就是ctx.x = 878这些东西。如果启动n个线程，ctx.x或ctx.y都是</span></span><br><span class="line"><span class="comment"># 随机数的话，就会看到每个线程里的字典都与自己相关，与其他线程是不一样的。这个类是线程安全的</span></span><br></pre></td></tr></table></figure>
<p>Timer定时器</p>
<p>Timer也是执行一个线程，本质上这是一个线程类，它会在延迟某个时间后再去执行。它是延迟启动一个线程来执行的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    print(x + y)</span><br><span class="line"></span><br><span class="line">t = threading.Timer(<span class="number">3</span>, add, args=(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line"><span class="comment"># 第一个参数3是等待时间，第二个参数是调用的函数，第三个参数是给调用函数传的参数</span></span><br><span class="line">t.start()</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">7</span></span><br><span class="line">============================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    print(x + y)</span><br><span class="line">    print(threading.enumerate())  <span class="comment"># 这里会显示一个叫Timer的东西，就是线程</span></span><br><span class="line"></span><br><span class="line">t = threading.Timer(<span class="number">5</span>, add, args=(<span class="number">3</span>, <span class="number">4</span>))  <span class="comment"># 这里因为没有设置，所以应该是一个non-daemon</span></span><br><span class="line"><span class="comment"># 第一个参数3是等待时间，第二个参数是调用的函数，第三个参数是给调用函数传的参数</span></span><br><span class="line">t.start()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">2</span>)  <span class="comment"># 主线程睡两秒</span></span><br><span class="line">t.cancel() </span><br><span class="line"><span class="comment"># 在python中线程不能被结束掉，但继承就有了，本质并不是把线程cancel了，实际使用了event。在没有真正执行前是可以cencel掉的。cencel也不是必须放在start方法下面，只要还没有真执行，就可以cancel。这里主线程已经等了2秒，工作线程t要等5秒后再执行add函数，这里使用了t.cancel，就不会再等了，2秒后就结束了。不用等执行目标函数了，线程就可以结束了</span></span><br></pre></td></tr></table></figure>
<p>logging</p>
<p>这是一个模块，低于你设置的日志级别就不会打印了，使用filename将日志输出到文件。</p>
<p>默认情况下Python的logging模块将日志打印到了标准输出中，且只显示了大于等于WARNING级别的日志，默认的日志级别为WARNING。日志级别等级CRITICAL &gt; ERROR &gt; WARNING &gt; INFO &gt; DEBUG</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="comment"># 一般日志级别定到INFO，比这个级别低的就不打印了。level=logging.INFO是一个常量性的东西，默认是WARNING。下面函数中定义的日志级别比这里低，就不会打印了</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    logging.info(<span class="string">"&#123;&#125; &#123;&#125;"</span>.format(threading.enumerate(), x+y))</span><br><span class="line"><span class="comment"># 从输出结果可以看出是INFO级别，之后是用户名。默认格式就是级别:用户:打印的信息。如果这里改成logging.debug，就不会打印信息了，因为低于设置的INFO级别。如果改成logging.warning就可以打印出信息。级别至少应该大于等于设置的级别，才能打印出信息</span></span><br><span class="line">t = threading.Timer(<span class="number">1</span>, add, args=(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">t.start()</span><br><span class="line">输出：</span><br><span class="line">INFO:root:[&lt;_MainThread(MainThread, stopped <span class="number">140289543512704</span>)&gt;, &lt;Timer(Thread<span class="number">-1</span>, started <span class="number">140289531881216</span>)&gt;] <span class="number">7</span></span><br><span class="line"><span class="comment"># 输出结果里INFO表示级别，root是用户，后面是要打印的具体信息。这就是默认的格式</span></span><br><span class="line">===========================================================================================</span><br><span class="line">输出的信息格式是C风格的，如%(message)s，这里最后的s表示最后要被格式化为一个字符串类型，如果是d，表示将内容格式化为数字显示出来</span><br><span class="line">============================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(thread)d %(message)s"</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, format=FORMAT)</span><br><span class="line"><span class="comment"># 一般日志级别定到INFO，比这个级别低的就不打印了。format等于上面定义的FORMAT格式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    logging.info(<span class="string">"&#123;&#125; &#123;&#125;"</span>.format(threading.enumerate(), x+y))</span><br><span class="line"><span class="comment"># 从输出结果可以看出是INFO级别，之后是用户名。默认格式就是级别：用户：打印的信息</span></span><br><span class="line">t = threading.Timer(<span class="number">1</span>, add, args=(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">t.start()</span><br><span class="line">输出：</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-13</span> <span class="number">16</span>:<span class="number">52</span>:<span class="number">57</span>,<span class="number">002</span> <span class="number">140041765787392</span> [&lt;_MainThread(MainThread, stopped <span class="number">140041777418880</span>)&gt;, &lt;Timer(Thread<span class="number">-1</span>, started <span class="number">140041765787392</span>)&gt;] <span class="number">7</span></span><br><span class="line">========================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(thread)d %(message)s"</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, format=FORMAT, datefmt=<span class="string">"%Y-%m-%d-%H:%M:%S"</span>)</span><br><span class="line"><span class="comment"># 一般日志级别定到INFO，比这个级别低的就不打印了。可以使用datefmt重新定义日期格式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    logging.warning(<span class="string">"&#123;&#125; &#123;&#125;"</span>.format(threading.enumerate(), x+y))</span><br><span class="line"><span class="comment"># 从输出结果可以看出是INFO级别，之后是用户名。默认格式就是级别：用户：打印的信息</span></span><br><span class="line">	logging.info(<span class="string">"%s %s"</span>, x, y)</span><br><span class="line"><span class="comment"># "%s %s", x, y对应的是上面定义格式中的 %(message)s，与其他没有关系。%(asctime)s %(thread)d会取系统的信息保存下来</span></span><br><span class="line">t = threading.Timer(<span class="number">1</span>, add, args=(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">t.start()</span><br><span class="line">输出：</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-13</span><span class="number">-16</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">140696046307072</span> [&lt;_MainThread(MainThread, stopped <span class="number">140696057938560</span>)&gt;, &lt;Timer(Thread<span class="number">-1</span>, started <span class="number">140696046307072</span>)&gt;] <span class="number">7</span></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-13</span><span class="number">-16</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">140696046307072</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"><span class="comment"># 从输出可以看出，logging.info、logging.warning是设置日志内容的，logging.basicConfig是设置日志格式的</span></span><br><span class="line">========================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(thread)d %(message)s %(schoolname)s"</span>  <span class="comment"># 这里只能用C风格</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, format=FORMAT, datefmt=<span class="string">"%Y-%m-%d-%H:%M:%S"</span>)</span><br><span class="line"><span class="comment"># 一般日志级别定到INFO，比这个级别低的就不打印了</span></span><br><span class="line">d = &#123;<span class="string">"schoolname"</span>:<span class="string">'magedu.com'</span>&#125;</span><br><span class="line"><span class="comment"># 当输出的内容不在message中，要自定义名称，之后创建字典，最后下面引用这个字典中的内容</span></span><br><span class="line"><span class="comment"># 这种方法使用的并不多</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    logging.warning(<span class="string">"&#123;&#125; &#123;&#125;"</span>.format(threading.enumerate(), x+y),  extra=d)</span><br><span class="line"><span class="comment"># 从输出结果可以看出是INFO级别，之后是用户名。默认格式就是级别：用户：打印的信息</span></span><br><span class="line">    logging.info(<span class="string">"%s %s"</span>, x, y, extra=d)</span><br><span class="line"><span class="comment"># 这里的%s对应的是%(message)s，在日志级别中写的都是message。上面logging.*中使用的两种方法打印的风格都可以</span></span><br><span class="line">t = threading.Timer(<span class="number">1</span>, add, args=(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">t.start()</span><br><span class="line">输出：</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-13</span><span class="number">-17</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">140091149367040</span> [&lt;_MainThread(MainThread, stopped <span class="number">140091160998528</span>)&gt;, &lt;Timer(Thread<span class="number">-1</span>, started <span class="number">140091149367040</span>)&gt;] <span class="number">7</span> magedu.com</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-13</span><span class="number">-17</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">140091149367040</span> <span class="number">3</span> <span class="number">4</span> magedu.com</span><br><span class="line">========================================================================</span><br><span class="line"><span class="comment"># 把日志输出到文件</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(thread)d %(message)s %(schoolname)s"</span>  <span class="comment"># 这里只能用C风格</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, format=FORMAT, datefmt=<span class="string">"%Y-%m-%d-%H:%M:%S"</span>, filename=<span class="string">'/home/shouyu/下载/test.log'</span>)</span><br><span class="line"><span class="comment"># 使用filename一定要把完整的路径名称写出来</span></span><br><span class="line">d = &#123;<span class="string">"schoolname"</span>:<span class="string">'magedu.com'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    logging.warning(<span class="string">"&#123;&#125; &#123;&#125;"</span>.format(threading.enumerate(), x+y),  extra=d)</span><br><span class="line"><span class="comment"># 从输出结果可以看出是INFO级别，之后是用户名。默认格式就是级别：用户：打印的信息</span></span><br><span class="line">    logging.info(<span class="string">"%s %s"</span>, x, y, extra=d)</span><br><span class="line"><span class="comment"># 这里的%s对应的是%(message)s，在日志级别中写的都是message。上面logging.*中使用的两种方法打印的风格都可以</span></span><br><span class="line">t = threading.Timer(<span class="number">1</span>, add, args=(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">t.start()</span><br></pre></td></tr></table></figure>
<p>日志信息格式是C网络的，%()s，%()d，s表示最后将信息格式化为字符串，d表示将内容转换为数字显示出来</p>
<p>Logger类</p>
<p>getLogger默认是根。输出的日志文件默认都是追加模式</p>
<p>对我们来讲，如果要做一个logger的话，应该用logging.getLogger()返回一个实例，而这种返回实例的方式我们一般称为工厂方法的返回，我们不关心这些是怎么造出来的，我们只关心是否要这个东西，如果要，就用get方法去要，get方法会把造好的东西给我们，也就是把实例给我们，这就是工厂方法，工厂方法隐藏了对象实例化的细节。getLogger()中只要不给名字，返回的就是root，也就是不知道造什么东西出来，所以就返回根</p>
<p>如果没给<code>logging.getLogger()</code>名字，或是给了空字符串，会返回一个叫root的Logger类的实例。Logger是分层次的，所以会有根在这，层次间用点分隔。如果是Logger，就可以用<code>root.parent</code>这种东西</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(thread)d %(message)s %(schoolname)s"</span>  <span class="comment"># 这里只能用C风格</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, format=FORMAT, datefmt=<span class="string">"%Y-%m-%d-%H:%M:%S"</span>)</span><br><span class="line"><span class="comment"># 一般日志级别定到INFO，比这个级别低的就不打印了</span></span><br><span class="line">d = &#123;<span class="string">"schoolname"</span>:<span class="string">'magedu.com'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    log = logging.getLogger(<span class="string">'a'</span>)  </span><br><span class="line"><span class="comment"># 如果什么名字都不给，log.name叫root，否则给什么名字，就叫什么。</span></span><br><span class="line">    <span class="comment"># log = logging.getLogger('') # 这里用字符串为空，返回的也是root。只要不给名字，工厂就不知道造什么，所以把根给你</span></span><br><span class="line">    <span class="comment"># log = logging.getLogger()</span></span><br><span class="line">    print(log.name)  </span><br><span class="line">    print(log, type(log))</span><br><span class="line"></span><br><span class="line">    log.warning(<span class="string">"&#123;&#125; &#123;&#125;"</span>.format(threading.enumerate(), x+y),  extra=d)</span><br><span class="line"><span class="comment"># 从输出结果可以看出是INFO级别，之后是用户名。默认格式就是级别：用户：打印的信息</span></span><br><span class="line">    log.info(<span class="string">"%s %s"</span>, x, y, extra=d)   </span><br><span class="line"><span class="comment"># 这与logging.info输出的内容是关不多的</span></span><br><span class="line"><span class="comment"># log.通过拿到一个实例，我们就可以调用这个实例的warning，info等方法</span></span><br><span class="line">t = threading.Timer(<span class="number">1</span>, add, args=(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">t.start()</span><br><span class="line">输出：</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-14</span><span class="number">-08</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">140029311325952</span> [&lt;_MainThread(MainThread, stopped <span class="number">140029322957440</span>)&gt;, &lt;Timer(Thread<span class="number">-1</span>, started <span class="number">140029311325952</span>)&gt;] <span class="number">7</span> magedu.com</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-14</span><span class="number">-08</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">140029311325952</span> <span class="number">3</span> <span class="number">4</span> magedu.com</span><br><span class="line">a</span><br><span class="line">&lt;Logger a (INFO)&gt; &lt;<span class="class"><span class="keyword">class</span> '<span class="title">logging</span>.<span class="title">Logger</span>'&gt;</span></span><br><span class="line"><span class="class"># 对我们来讲，如果要做一个<span class="title">logger</span>的话，应该用<span class="title">logging</span>.<span class="title">getLogger</span><span class="params">()</span>，返回一个实例，这种返回实例的方式，我们叫工厂方法，我们向一个工厂<span class="title">logging</span>要，我们不关心是如何造出来的。如果要这个东西，就用<span class="title">get</span>方法，工厂来造，造好后把东西给你，也就是实例给你。工厂方法隐藏了对象实例化的细节。这样工厂还可以控制生产量</span></span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(thread)d %(message)s %(schoolname)s"</span>  <span class="comment"># 这里只能用C风格</span></span><br><span class="line">logging.basicConfig(level=logging.WARNING, format=FORMAT, datefmt=<span class="string">"%Y-%m-%d-%H:%M:%S"</span>)</span><br><span class="line"></span><br><span class="line">root = logging.getLogger()</span><br><span class="line">print(root, id(root))</span><br><span class="line">root.warning(<span class="string">'my root'</span>)</span><br><span class="line"></span><br><span class="line">loga = logging.getLogger(<span class="string">'a'</span>)</span><br><span class="line">print(loga, id(loga), id(loga.parent))</span><br><span class="line">loga.warning(<span class="string">'my loga'</span>)</span><br><span class="line"></span><br><span class="line">loga = logging.getLogger(<span class="string">'a.b'</span>)</span><br><span class="line">print(loga, id(loga), id(loga.parent))</span><br><span class="line"><span class="comment"># 通过loga及输出可以看出父子关系，这是要继承些东西</span></span><br><span class="line">loga.warning(<span class="string">'my a.b'</span>)</span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(thread)d %(message)s %(schoolname)s"</span>  <span class="comment"># 这里只能用C风格</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, format=FORMAT, datefmt=<span class="string">"%Y-%m-%d-%H:%M:%S"</span>)</span><br><span class="line"></span><br><span class="line">root = logging.getLogger()</span><br><span class="line">print(root, id(root))</span><br><span class="line"><span class="comment"># root.warning('my root')</span></span><br><span class="line"></span><br><span class="line">loga = logging.getLogger(__name__)</span><br><span class="line">print(loga, id(loga), id(loga.parent))</span><br><span class="line"><span class="comment"># loga.warning('my loga')</span></span><br><span class="line">print(loga.getEffectiveLevel())</span><br><span class="line"><span class="comment"># getEffectiveLevel表示获取有效级别，这里会得到WARNING对应级别的数字</span></span><br><span class="line">loga.info(<span class="string">'before'</span>)</span><br><span class="line">loga.setLevel(<span class="number">28</span>)</span><br><span class="line"><span class="comment"># 将级别调整为28。Logger可以从上面的level中继承级别，也可以在这里调整级别</span></span><br><span class="line">loga.info(<span class="string">'after'</span>)  <span class="comment"># 因为改变了级别的数字，所以这里就打印不出来了</span></span><br><span class="line">loga.warning(<span class="string">'after1'</span>)  <span class="comment"># 这里可以打印出来，因为这里比调整后的级别高</span></span><br><span class="line"></span><br><span class="line">loga = logging.getLogger(<span class="string">"&#123;&#125;.&#123;&#125;"</span>.format(__name__,<span class="string">'echo'</span>))</span><br><span class="line"><span class="comment"># __name__相当于模块，'echo'是模块下的某个函数或类产生的日志</span></span><br><span class="line">print(loga, id(loga), id(loga.parent))</span><br><span class="line"><span class="comment"># 通过loga及输出可以看出父子关系，这是要继承些东西</span></span><br><span class="line">loga.warning(<span class="string">'my a.b'</span>)</span><br></pre></td></tr></table></figure>
<p>Handler</p>
<p>控制日志信息输出的目的地，它可以单独设置时间与格式，设置过滤器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(thread)d %(message)s %(schoolname)s"</span>  <span class="comment"># 这里只能用C风格</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, format=FORMAT, datefmt=<span class="string">"%Y-%m-%d-%H:%M:%S"</span>)</span><br><span class="line"></span><br><span class="line">root = logging.getLogger()</span><br><span class="line">print(root, id(root))</span><br><span class="line"><span class="comment"># root.warning('my root')</span></span><br><span class="line"></span><br><span class="line">loga = logging.getLogger(<span class="string">'s'</span>)</span><br><span class="line">loga.setLevel(logging.WARNING)</span><br><span class="line">print(loga.getEffectiveLevel())</span><br><span class="line"></span><br><span class="line">log2 = logging.getLogger(<span class="string">'s.s1'</span>)  <span class="comment"># 创建了父子关系</span></span><br><span class="line">log2.setLevel(<span class="number">20</span>)  <span class="comment"># 如果这里将级别调低，下面设置成log2.info时也可以打印出信息</span></span><br><span class="line">log2.warning(<span class="string">'log2 warning'</span>)  <span class="comment"># 测试loga.setLevel设置为ERROR时没打印出log2.warning，设置成WARNING时可以打印出内容。如果这里改成log2.info，也打印不出内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子孙打印时要先看自己的有效级别，如果设置过，就用自己的。否则影响它最大的就是离它最近的祖先的日志级别，子孙级别是不能大于祖先的级别的，如果最近的祖先没有设置，就向上找，一直找到根，默认使用的是WARNING。</span></span><br><span class="line"></span><br><span class="line">hdlr = logging.StreamHandler()</span><br><span class="line">loga.addHandler(hdlr)</span><br><span class="line">===========================================================================================</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(thread)d %(message)s %(schoolname)s"</span>  <span class="comment"># 这里只能用C风格</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, format=FORMAT, datefmt=<span class="string">"%Y-%m-%d-%H:%M:%S"</span>)</span><br><span class="line"></span><br><span class="line">root = logging.getLogger()</span><br><span class="line">print(root, id(root))</span><br><span class="line"><span class="comment"># root.warning('my root')</span></span><br><span class="line"></span><br><span class="line">log1 = logging.getLogger(<span class="string">'s'</span>)</span><br><span class="line">log1.setLevel(logging.ERROR)</span><br><span class="line">print(loga.getEffectiveLevel())</span><br><span class="line"></span><br><span class="line"><span class="comment"># hdlr = logging.StreamHandler()。对ogger来讲，它的继承是从logger实例自己的级别上继承。handler的级别会影响信息可以控制信息进入后是否可以打印的问题。如下而的hdlr = logging.FileHandler('o:/log1hdlr.log') 。信息进入log1，但未必能打印出去。首先与自己的级别比较，如果通过了，就交给自己的handler处理，如果handler的级别高，就不处理了，反之就处理</span></span><br><span class="line"><span class="comment"># 一个数据产生后，先看自己的级别能不能搞定，如果不能搞定，就停止了。如果能解决，就产生一条消息记录，之后看在logger上是否有filter，如果有且无法通过，就会停止。如果能够通过，就转发给本级中所有的handler进行对比，如果大于等于handler的level，就处理，如果handler上定义了formater，就按formater做，否则按缺省formater做，缺省formater就是%&#123;message&#125;s，当handler处理完之后，会找自己的父logger，如果有父logger，就直接发给父logger的handler，父logger有一个属性叫propergate，这是传播的意思，如果当前logger的传播属性是false，就不再向自己的父logger传播了，如果允许传播，到达父logger后会发给父logger的所有handler，父的handler再判断你的消息级别与handler的级别的大小，再进行处理。如果父的传播属性是True，会再向上一级父logger的handler传播，就不会再向这一级的handler传播了，直播向父的handler传播，这会一直向上找，传播属性默认都是True</span></span><br><span class="line"><span class="comment"># 消息从这一级产生，就是这一级先过logger这一关，然后再到handler，再向上发就与父logger的level没有关系了，只与handler的level有关系，没有handler就继续向上发。这种东西用的不多。一般都是进来之后，这个模块上写一个getLogger(模块名)，不会再写几级，再写filter。一般把日志全部输出出来，对日志进行分析时再过滤</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hdlr = logging.FileHandler(<span class="string">'o:/log1hdlr.log'</span>)  <span class="comment"># 执行发现log1hdlr.log是空的</span></span><br><span class="line">hdlr.setLevel(logging.WARNING)</span><br><span class="line">loga.addHandler(hdlr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># hdlr对于log2没有影响</span></span><br><span class="line">log2 = logging.getLogger(<span class="string">'s.s1'</span>)  <span class="comment"># 创建了父子关系</span></span><br><span class="line"><span class="comment"># log2.setLevel(20)  # 如果这里将级别调低，下面设置成log2.info时也可以打印出信息</span></span><br><span class="line">print(log2.getEffectiveLevel())</span><br><span class="line">log2.info(<span class="string">'log2 warning'</span>) </span><br><span class="line"></span><br><span class="line">h2 = logging.StreamHandler()</span><br></pre></td></tr></table></figure>
<p>Formatter</p>
<p>重新定义字符串格式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">FORMAT = <span class="string">"%(asctime)s %(thread)d %(message)s %(schoolname)s"</span>  <span class="comment"># 这里只能用C风格</span></span><br><span class="line">logging.basicConfig(format=FORMAT, datefmt=<span class="string">"%Y-%m-%d-%H:%M:%S"</span>,level=logging.ERROR)</span><br><span class="line"></span><br><span class="line">root = logging.getLogger()</span><br><span class="line">print(root, id(root))</span><br><span class="line"><span class="comment"># root.warning('my root')</span></span><br><span class="line"></span><br><span class="line">log1 = logging.getLogger(<span class="string">'s'</span>)</span><br><span class="line">log1.setLevel(logging.WARNING)</span><br><span class="line">print(loga.getEffectiveLevel())</span><br><span class="line"></span><br><span class="line">hdlr = logging.FileHandler(<span class="string">'o:/log1hdlr.log'</span>)  <span class="comment"># 执行发现log1hdlr.log是空的</span></span><br><span class="line">hdlr.setLevel(logging.INFO)</span><br><span class="line">fmtr = logging.Formatter(<span class="string">'%(asctime)s %(thread)d %(threadName)s %(message)s'</span>)</span><br><span class="line">hdlr.setFormatter(fmtr)</span><br><span class="line">loga.addHandler(hdlr)</span><br><span class="line"></span><br><span class="line">log2 = logging.getLogger(<span class="string">'s.s1'</span>)  <span class="comment"># 创建了父子关系</span></span><br><span class="line">log2.setLevel(<span class="number">20</span>)  <span class="comment"># 如果这里将级别调低，下面设置成log2.info时也可以打印出信息</span></span><br><span class="line">print(log2.getEffectiveLevel())</span><br><span class="line">log2.info(<span class="string">'log2 warning'</span>) </span><br><span class="line"></span><br><span class="line">h2 = logging.StreamHandler()</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python线程/" rel="tag"># python线程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/08/转：在-Linux-上压缩文件的-5-种方法/" rel="next" title="转：在 Linux 上压缩文件的 5 种方法">
                <i class="fa fa-chevron-left"></i> 转：在 Linux 上压缩文件的 5 种方法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/11/python基础学习-线程同步/" rel="prev" title="python基础学习-线程同步">
                python基础学习-线程同步 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概要
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">265</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">185</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#并发"><span class="nav-number">1.</span> <span class="nav-text">并发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本概念"><span class="nav-number">1.1.</span> <span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#并发和并行的区别"><span class="nav-number">1.1.1.</span> <span class="nav-text">并发和并行的区别</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#并发的解决"><span class="nav-number">1.1.2.</span> <span class="nav-text">并发的解决</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#食堂打饭模型"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">食堂打饭模型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#进程和线程"><span class="nav-number">1.2.</span> <span class="nav-text">进程和线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#线程的状态"><span class="nav-number">1.3.</span> <span class="nav-text">线程的状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Python中的进程和线程"><span class="nav-number">1.4.</span> <span class="nav-text">Python中的进程和线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Python的线程开发"><span class="nav-number">1.5.</span> <span class="nav-text">Python的线程开发</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Thread类"><span class="nav-number">1.5.1.</span> <span class="nav-text">Thread类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#线程启动"><span class="nav-number">1.5.2.</span> <span class="nav-text">线程启动</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#线程退出"><span class="nav-number">1.5.3.</span> <span class="nav-text">线程退出</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#线程的传参"><span class="nav-number">1.5.4.</span> <span class="nav-text">线程的传参</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#threading的属性和方法"><span class="nav-number">1.5.5.</span> <span class="nav-text">threading的属性和方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Thread实例的属性和方法"><span class="nav-number">1.5.6.</span> <span class="nav-text">Thread实例的属性和方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#start-方法"><span class="nav-number">1.5.7.</span> <span class="nav-text">start 方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run方法"><span class="nav-number">1.5.8.</span> <span class="nav-text">run方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#start和run的区别"><span class="nav-number">1.5.9.</span> <span class="nav-text">start和run的区别</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#多线程"><span class="nav-number">1.5.10.</span> <span class="nav-text">多线程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#线程安全"><span class="nav-number">1.5.11.</span> <span class="nav-text">线程安全</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#daemon线程和non-daemon线程"><span class="nav-number">1.5.12.</span> <span class="nav-text">daemon线程和non-daemon线程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#join方法"><span class="nav-number">1.5.13.</span> <span class="nav-text">join方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#daemon线程应用场景"><span class="nav-number">1.5.14.</span> <span class="nav-text">daemon线程应用场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#threading-local类"><span class="nav-number">1.5.15.</span> <span class="nav-text">threading.local类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#定时器Timer-延迟执行"><span class="nav-number">1.5.16.</span> <span class="nav-text">定时器Timer/延迟执行</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#笔记"><span class="nav-number">2.</span> <span class="nav-text">笔记</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
