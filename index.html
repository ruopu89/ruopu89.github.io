<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜尋..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/24/windows10使用记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/24/windows10使用记录/" itemprop="url">
                  windows10使用记录
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-12-24 09:09:24" itemprop="dateCreated datePublished" datetime="2020-12-24T09:09:24+08:00">2020-12-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-12-25 14:37:25" itemprop="dateModified" datetime="2020-12-25T14:37:25+08:00">2020-12-25</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/windows系统/" itemprop="url" rel="index"><span itemprop="name">windows系统</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="WSL子系统"><a href="#WSL子系统" class="headerlink" title="WSL子系统"></a>WSL子系统</h1><h2 id="设置powerline主题"><a href="#设置powerline主题" class="headerlink" title="设置powerline主题"></a>设置powerline主题</h2><h3 id="下载字体"><a href="#下载字体" class="headerlink" title="下载字体"></a>下载字体</h3><p>地址：<a href="https://github.com/ryanoasis/nerd-fonts/releases，这是nerd-fonts的字体，还有其他字体，可以在oh-my-zsh的主页中查找到，地址：https://github.com/ohmyzsh/ohmyzsh，在其中搜索powerline" target="_blank" rel="noopener">https://github.com/ryanoasis/nerd-fonts/releases，这是nerd-fonts的字体，还有其他字体，可以在oh-my-zsh的主页中查找到，地址：https://github.com/ohmyzsh/ohmyzsh，在其中搜索powerline</a> fonts即可找到。到nerd-fonts主页中选择下载安装Ubuntu Moto 字体。在系统中安装此字体，wsl子系统需要宿主机有相应字体，才能正常显示。</p>
<h2 id="安装oh-my-zsh"><a href="#安装oh-my-zsh" class="headerlink" title="安装oh-my-zsh"></a>安装oh-my-zsh</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh -c "$(wget -O- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是安装的命令，但一般情况会报错，提示连接不上</span></span><br><span class="line">也可以到oh-my-zsh主页中，到tool目录中查看install.sh脚本的代码，直接复制下来，但因为git连接问题，可能依然会失败或速度缓慢</span><br></pre></td></tr></table></figure>
<h2 id="设置git"><a href="#设置git" class="headerlink" title="设置git"></a>设置git</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1. 修改wsl子系统的resolv.conf的地址</span><br><span class="line">cat /etc/resolv.conf</span><br><span class="line">nameserver 192.168.1.54  # 改成宿主机的地址</span><br><span class="line"></span><br><span class="line">2. 设置wsl子系统的环境变量</span><br><span class="line">export windows_host=`cat /etc/resolv.conf|grep nameserver|awk '&#123;print $2&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这条最好写入.zshrc中，这是将环境变量windows_host设置成宿主机的地址</span></span><br><span class="line"></span><br><span class="line">3.设置git代理，记得是使用命令行设置，不要在配置文件中直接添加，直接添加可能无效</span><br><span class="line">git config --global proxy.http socks5://$windows_host:10808</span><br><span class="line">git config --global proxy.https socks5://$windows_host:10808</span><br><span class="line"></span><br><span class="line">4. 设置v2ray允许局域网连接</span><br><span class="line"></span><br><span class="line">5. 设置允许v2ray进行公用和专用网络访问，测试中没有设置此项，可能是之前设置过了</span><br><span class="line">===============================================================================================================</span><br><span class="line">还有建议在wsl设置代理内容如下：</span><br><span class="line">vim ~/.bashrc</span><br><span class="line">export windows_host=`cat /etc/resolv.conf|grep nameserver|awk '&#123;print $2&#125;'`</span><br><span class="line">export ALL_PROXY=socks5://$windows_host:10808</span><br><span class="line">export HTTP_PROXY=$ALL_PROXY</span><br><span class="line">export http_proxy=$ALL_PROXY</span><br><span class="line">export HTTPS_PROXY=$ALL_PROXY</span><br><span class="line">export https_proxy=$ALL_PROXY</span><br><span class="line"></span><br><span class="line">if [ "`git config --global --get proxy.https`" != "socks5://$windows_host:10808" ]; then</span><br><span class="line">            git config --global proxy.https socks5://$windows_host:10808</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试失败，提示系统代理不能用socks5协议</span></span><br></pre></td></tr></table></figure>
<h2 id="设置oh-my-zsh"><a href="#设置oh-my-zsh" class="headerlink" title="设置oh-my-zsh"></a>设置oh-my-zsh</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim .zshrc</span><br><span class="line">ZSH_THEME="powerlevel10k/powerlevel10k"</span><br><span class="line">source ~/.zshrc</span><br><span class="line">重新加载后，会有一个powerlevel10k的安装提示，按需求选择喜欢的样式即可</span><br><span class="line"><span class="meta">#</span><span class="bash"> 有一点需要注意，wsl2子系统ping不通宿主机地址是因为打开了专用防火墙</span></span><br></pre></td></tr></table></figure>
<h2 id="设置powerlevel10k"><a href="#设置powerlevel10k" class="headerlink" title="设置powerlevel10k"></a>设置powerlevel10k</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~/.p10k.zsh</span><br><span class="line">在这里可以设置powerlevel10k的显示效果，如显示cpu情况的load，显示磁盘情况的disk_usage等，详细设置方法见官方主页：</span><br><span class="line">https://github.com/romkatv/powerlevel10k#oh-my-zsh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新配置方法</span></span><br><span class="line">p10k configure</span><br></pre></td></tr></table></figure>
<h2 id="设置端口转发"><a href="#设置端口转发" class="headerlink" title="设置端口转发"></a>设置端口转发</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">希望通过宿主机登录wsl2子系统，这需要在宿主机上设置端口转发</span><br><span class="line">语法：netsh interface portproxy add v4tov4 listenport=【宿主机windows平台监听端口】 listenaddress=0.0.0.0 connectport=【wsl2平台监听端口】 connectaddress=【wsl2平台ip】</span><br><span class="line"></span><br><span class="line">netsh interface portproxy add v4tov4 listenport=22 listenaddress=0.0.0.0 connectport=2222 connectaddress=172.22.208.118</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置端口转发，v4tov4应该指ipv4到ipv4</span></span><br><span class="line">netsh interface portproxy show all</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看现有的端口转发</span></span><br><span class="line">netsh interface portproxy delete v4tov4 listenport=9696 listenaddress=0.0.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除端口转发</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 实际wsl2子系统启动的端口应该会被自动映射到宿主机的127.0.0.1地址上，但可能由于杀毒软件的原因被阻拦，宿主机上看不到有监听的地址</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/22/python使用记录-操作S3对象存储/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/22/python使用记录-操作S3对象存储/" itemprop="url">
                  python使用记录-操作S3对象存储
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-12-22 10:15:36" itemprop="dateCreated datePublished" datetime="2020-12-22T10:15:36+08:00">2020-12-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-12-23 17:45:42" itemprop="dateModified" datetime="2020-12-23T17:45:42+08:00">2020-12-23</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>网络上操作S3类对象存储的文章并不多，一般都是操作AWS的S3对象存储，感谢nsloghe在<a href="https://blog.csdn.net/nslogheyang/article/details/100115336中所做的记录，帮助我解决了这个问题" target="_blank" rel="noopener">https://blog.csdn.net/nslogheyang/article/details/100115336中所做的记录，帮助我解决了这个问题</a></p>
<h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> boto3.session <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CephS3BOTO3</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        access_key = <span class="string">'xor12345678987654321'</span></span><br><span class="line">        secret_key = <span class="string">'xor12345678987654321xor12345678987654321'</span></span><br><span class="line">        self.session = Session(aws_access_key_id=access_key,aws_secret_access_key=secret_key)</span><br><span class="line">        self.url = <span class="string">'http://172.16.154.88:8060'</span></span><br><span class="line">        self.s3_client = self.session.client(<span class="string">'s3'</span>, endpoint_url=self.url)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_bucket</span><span class="params">(self)</span>:</span></span><br><span class="line">        buckets = [bucket[<span class="string">'Name'</span>] <span class="keyword">for</span> bucket <span class="keyword">in</span> self.s3_client.list_buckets()[<span class="string">'Buckets'</span>]]</span><br><span class="line">        print(buckets)</span><br><span class="line">        <span class="keyword">return</span> buckets</span><br><span class="line"><span class="comment"># 这里的问题是使用实例的list_buckets方法是没有提示的。s3_client.list_buckets()[‘Buckets’]对象是一个可以遍历用户Bucket信息的迭代器</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_bucket</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.s3_client.create_bucket(Bucket=<span class="string">'xor-media-3'</span>)</span><br><span class="line">        self.s3_client.create_bucket(Bucket=<span class="string">'xor-media-4'</span>,ACL=<span class="string">'public-read'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(self)</span>:</span></span><br><span class="line">        resp = self.s3_client.put_object(Bucket=<span class="string">'xor-media-1'</span>,Key=<span class="string">'test'</span>,Body=open(<span class="string">"C:\\Users\\Administrator\\PycharmProjects\\pythonProject\\冷门节目_20201022\\text.py"</span>).read()</span><br><span class="line">        print(resp)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line"><span class="comment"># put_object方法是将Body参数指定的文件打开，并将其中的文件保存到Key参数指定的文件中，如果key参数指定的文件没有写路径，就是将key参数指定的文件保存在bucket的</span></span><br><span class="line"><span class="comment"># 根目录下</span></span><br><span class="line">                                         </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(self)</span>:</span></span><br><span class="line">        resp = self.s3_client.upload_file(<span class="string">"C:\\Users\\Administrator\\PycharmProjects\\pythonProject\\冷门节目_20201022\\text.py"</span>,<span class="string">'xor-media-1'</span>,<span class="string">'/test/2020122201/text.py'</span>)</span><br><span class="line">        print(resp)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line"><span class="comment"># upload_file方法可以将文件上传到S3对象存储中，参数有三个，第一个是file_name，这是要上传的文件的名称，一定要写绝对路径；第二个是bucket，这是桶的名称；第三</span></span><br><span class="line"><span class="comment"># 个是object_name，这是要保存的路径，但也要写明保存时的名称，就像上面例子中的一样，都要写明是text.py</span></span><br><span class="line">                                         </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(self)</span>:</span></span><br><span class="line">        resp = self.s3_client.get_object(Bucket=<span class="string">'xor-media-1'</span>,Key=<span class="string">'key'</span>)</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"C:\\Users\\shouyu\\Desktop\\text.py"</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(resp[<span class="string">'Body'</span>].read())</span><br><span class="line"><span class="comment"># get_object方法应该也是写入到某个文件的，并非下载文件的方法</span></span><br><span class="line">                                         </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(self)</span>:</span></span><br><span class="line">		resp =self.s3_client.download_file(<span class="string">'xor-media-1'</span>,<span class="string">'test111.py'</span>,<span class="string">'C:\\Users\\Administrator\\Desktop\\test111.py'</span>)</span><br><span class="line"><span class="comment"># 下载文件需要使用download_file方法，与upload_file方法相同，需要指定bucket，要下载的文件的名称或绝对路径，最后是保存到本地的路径与名称</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ceph3_boto3 = CephS3BOTO3()</span><br><span class="line">    ceph3_boto3.get_bucket()</span><br><span class="line">    ceph3_boto3.upload()</span><br></pre></td></tr></table></figure>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br></pre></td><td class="code"><pre><span class="line">根据数据库中查找到的内容路径，将文件上传到S3OSS对象存储。脚本需要在linux系统中测试执行，因为windows系统挂载NFS文件系统有问题</span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Event, Thread</span><br><span class="line"><span class="keyword">from</span> boto3.session <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line">FORMAT = <span class="string">'%(asctime)s %(thread)d %(threadName)s %(message)s'</span></span><br><span class="line">logging.basicConfig(format=FORMAT, level=logging.INFO, filename=<span class="string">'/netdisk/znfjValue/offline_oss_update_database.log'</span>, filemode=<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CephS3BOTO3</span>:</span>   <span class="comment"># 初始化方法用于连接s3oss对象存储，upload方法用于上传文件</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        access_key = <span class="string">'xor12345678987654321'</span></span><br><span class="line">        secret_key = <span class="string">'xor12345678987654321xor12345678987654321'</span></span><br><span class="line">        self.session = Session(aws_access_key_id=access_key,aws_secret_access_key=secret_key)</span><br><span class="line">        self.url = <span class="string">'http://172.16.154.88:8060'</span></span><br><span class="line">        self.s3_client = self.session.client(<span class="string">'s3'</span>, endpoint_url=self.url)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(self,file_name,bucket_name,object_name)</span>:</span></span><br><span class="line">        self.s3_client.upload_file(file_name,bucket_name,object_name)</span><br><span class="line"></span><br><span class="line">ceph3_boto3 = CephS3BOTO3()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lengmen</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.db = pymysql.connect(<span class="string">"172.16.168.107"</span>, <span class="string">"soonet"</span>, <span class="string">"soonet"</span>, <span class="string">"soonetgh"</span>)</span><br><span class="line">        self.mysql = self.db.cursor()</span><br><span class="line">        self.handledID = set()   <span class="comment"># 保存已处理过的titleid</span></span><br><span class="line">        self.url = <span class="string">"http://172.16.189.27:9090/com.bgctv.sdp.platform.pubsub.pub"</span></span><br><span class="line">        self.data = &#123;&#125;</span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line">        self.uploadData = set()</span><br><span class="line">        self.event = Event()</span><br><span class="line">        self.handledurl = set()   <span class="comment"># 在upload_data方法中记录已处理过的url的titleid，避免重复上传数据</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">readfile</span><span class="params">(self)</span>:</span>  <span class="comment"># 读取从mysql中导出的文件，返回一个生成器</span></span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'znfj_mysql_backup_sort_202005-202011_20201217.txt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">                <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_reConn</span><span class="params">(self)</span>:</span>   <span class="comment"># 重连mysql</span></span><br><span class="line">        <span class="keyword">if</span> self.db.ping():</span><br><span class="line">            self.db = pymysql.connect(<span class="string">"172.16.168.107"</span>, <span class="string">"soonet"</span>, <span class="string">"soonet"</span>, <span class="string">"soonetgh"</span>)</span><br><span class="line">            self.mysql = self.db.cursor()  <span class="comment"># 获取游标</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将从数据库计算出来的冷门数据更新到172.16.168.107数据库</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_database</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.readfile():  <span class="comment"># 从mysql导出文件中拿到每一条id</span></span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'offline_handleURL.txt'</span>,<span class="string">'r+'</span>) <span class="keyword">as</span> f:  <span class="comment"># offline_handleURL.txt文件是在upload_data函数中的f.write中写入的</span></span><br><span class="line">                <span class="keyword">if</span> i <span class="keyword">in</span> f.read():  <span class="comment"># 如果取出的pid_paid在handleURL.txt中，就不再处理了，跳过。这里要用read()方法</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            pid = i.replace(<span class="string">"\n"</span>, <span class="string">""</span>).split(<span class="string">'_'</span>)[<span class="number">0</span>]  <span class="comment"># 切割id，去掉换行符，并以下划线为分割符</span></span><br><span class="line">            titleid = i.replace(<span class="string">"\n"</span>, <span class="string">""</span>).split(<span class="string">'_'</span>)[<span class="number">1</span>]</span><br><span class="line">            <span class="comment"># 10014_GTIT0120150923200361  pid与titleid混在了一起，前面是pid，后面是titleid</span></span><br><span class="line">            <span class="keyword">if</span> titleid <span class="keyword">in</span> self.handledID:  <span class="comment"># 已处理过的titleid列表，如果titleid在列表中就跳过，说明已经处理了</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            self._reConn()  <span class="comment"># 避免mysql断开，重连机制</span></span><br><span class="line">            sql = <span class="string">"SELECT * from resource_transcode WHERE Title_ID='&#123;&#125;'"</span>.format(titleid)  <span class="comment"># 要执行的sql语句，一段会有四条结果，执行结果写在最后</span></span><br><span class="line"><span class="comment"># 这里只做查询，没有更新。下一步还要更新这个数据库，之后下发通知。查询是为了知道这个节目的内容名称，再按名称找到路径，上传到阿里OSS</span></span><br><span class="line">            result = self.mysql.execute(sql)  <span class="comment"># 执行sql语句</span></span><br><span class="line">            results = self.mysql.fetchall()  <span class="comment"># 获取mysql执行后所有记录的列表</span></span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results:  <span class="comment"># 一条条打印出来</span></span><br><span class="line">                url = row[<span class="number">14</span>]  <span class="comment"># 获取结果中的url路径</span></span><br><span class="line">                <span class="keyword">if</span> url.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'trans'</span>:  <span class="comment"># 取第二段判断，因为第二段可能是trans，也可能是newtrans</span></span><br><span class="line">                    s3url = url.replace(<span class="string">'trans'</span>, <span class="string">'s3oss'</span>)  <span class="comment"># 生成s3url地址</span></span><br><span class="line">                <span class="keyword">elif</span> url.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'newtrans'</span>:</span><br><span class="line">                    s3url = url.replace(<span class="string">'newtrans'</span>, <span class="string">'s3oss'</span>)  <span class="comment"># 要更新的url</span></span><br><span class="line">                <span class="keyword">elif</span> url.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'newtrans2'</span>:</span><br><span class="line">                    s3url = url.replace(<span class="string">'newtrans2'</span>, <span class="string">'s3oss'</span>)  <span class="comment"># 要更新的url</span></span><br><span class="line"><span class="comment"># 原路径：/vod/newtrans2 /20200423/FMOV0120200423401905/FTIT0120200423401905_1200</span></span><br><span class="line"><span class="comment"># 更新路径：/vod/s3oss/20200423/FMOV0120200423401905/FTIT0120200423401905_1200</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    logging.info(<span class="string">"unknown url:&#123;&#125;"</span>.format(url))</span><br><span class="line">                    s3url = url</span><br><span class="line">                self.handledID.add(titleid)  <span class="comment"># 写在这里要重复加四次，self.handledID是set类型，个人感觉应该这样写，不然下面的yield又没法一次返回4条记录的结果，也就是一次只返回一个url，因为上面用self.mysql.fetchall()应该会查出来四条结果。似乎把这条语句放在这个循环的外面也可以，放在yield下面</span></span><br><span class="line">                logging.info(<span class="string">"handledID: &#123;&#125;"</span>.format(self.handledID))</span><br><span class="line">                <span class="keyword">yield</span> url, s3url, row[<span class="number">5</span>], row[<span class="number">4</span>], i  <span class="comment"># 返回url,aliurl,Asset_ID和MovieID，i是pid_titleid</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filenamejoin</span><span class="params">(self, path)</span>:</span>  <span class="comment"># 生成每个文件的绝对路径</span></span><br><span class="line">        <span class="keyword">for</span> subdir, dirs, files <span class="keyword">in</span> os.walk(path):</span><br><span class="line"><span class="comment"># os.walk()方法可以遍历路径，subdir是所有的目录的绝对路径，file是文件的名称，dirs是每一层目录下还有哪些目录，这是一个列表。</span></span><br><span class="line"><span class="comment"># 详见：https://www.runoob.com/python3/python3-os-walk.html</span></span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                <span class="keyword">yield</span> subdir+<span class="string">'/'</span>+file</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload_data</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> url, s3url, assetid, movieid, i <span class="keyword">in</span> self.update_database():</span><br><span class="line">            <span class="keyword">if</span> i.replace(<span class="string">"\n"</span>, <span class="string">""</span>).split(<span class="string">'_'</span>)[<span class="number">1</span>] <span class="keyword">in</span> self.handledurl:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">for</span> upload_Data <span class="keyword">in</span> self.filenamejoin(Path(url).parent):</span><br><span class="line">                <span class="keyword">if</span> upload_Data.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'trans'</span>:  <span class="comment"># 取第二段判断，因为第二段可能是trans，也可能是newtrans</span></span><br><span class="line">                    s3upload_Data = upload_Data.replace(<span class="string">'trans'</span>, <span class="string">'s3oss'</span>)  <span class="comment"># 要更新的url</span></span><br><span class="line">                <span class="keyword">elif</span> upload_Data.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'newtrans'</span>:</span><br><span class="line">                    s3upload_Data = upload_Data.replace(<span class="string">'newtrans'</span>, <span class="string">'s3oss'</span>)  <span class="comment"># 要更新的url</span></span><br><span class="line">                <span class="keyword">elif</span> upload_Data.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'newtrans2'</span>:</span><br><span class="line">                    s3upload_Data = upload_Data.replace(<span class="string">'newtrans2'</span>, <span class="string">'s3oss'</span>)</span><br><span class="line"><span class="comment"># \vod\trans\20140805\GMOV0120140805200535 &gt; \vod\s3oss\20140805\GMOV0120140805200535</span></span><br><span class="line">                <span class="keyword">with</span> open(<span class="string">'offline_handleURL.txt'</span>,<span class="string">'r+'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    count = len(f.readlines())</span><br><span class="line">                    <span class="keyword">if</span> count &gt;= <span class="number">10000</span>:</span><br><span class="line">                        exit()</span><br><span class="line">                    <span class="keyword">if</span> upload_Data.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'s3oss'</span> <span class="keyword">or</span> upload_Data.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'aliyunoss'</span>:</span><br><span class="line">                        print(<span class="string">'s3oss_OR_aliyunoss: '</span>,upload_Data)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">elif</span> <span class="keyword">not</span> os.path.exists(upload_Data):</span><br><span class="line">                        print(<span class="string">'not exists: '</span>,upload_Data)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">elif</span> upload_Data <span class="keyword">in</span> f.read():</span><br><span class="line">                        print(<span class="string">'upload_Data in f'</span>)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        print(<span class="string">'handler: '</span>,url)</span><br><span class="line">                        start = datetime.datetime.now()</span><br><span class="line">                        s1 = psutil.net_io_counters(pernic=<span class="keyword">True</span>)[<span class="string">'ens160'</span>]</span><br><span class="line">                        ceph3_boto3.upload(upload_Data,<span class="string">'xor-media-1'</span>,s3upload_Data.lstrip(<span class="string">'/'</span>))</span><br><span class="line"><span class="comment"># s3oss对象存储的路径需要去除开头的/，不然上传后会多一层/</span></span><br><span class="line">                        print(<span class="string">'upload: &#123;&#125;, s3upload_Data: &#123;&#125;'</span>.format(url,s3url))</span><br><span class="line">                        s2 = psutil.net_io_counters(pernic=<span class="keyword">True</span>)[<span class="string">'ens160'</span>]</span><br><span class="line">                        second = (datetime.datetime.now()-start).total_seconds()</span><br><span class="line">                        result = str((s2.bytes_sent-s1.bytes_sent)/<span class="number">1024</span>/<span class="number">1024</span>/second) + <span class="string">'Mb/s'</span></span><br><span class="line"><span class="comment"># 通过上面s1和s2两个变量统计到的网络流量计算出传输的网速</span></span><br><span class="line">                        f.write(<span class="string">'&#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;'</span>.format(datetime.datetime.now(),upload_Data,result,second,i))</span><br><span class="line"><span class="comment"># 记录已处理的信息，方便之后查询url是否被处理过</span></span><br><span class="line">                        print(<span class="string">'&#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;'</span>.format(datetime.datetime.now(),upload_Data,result,second,i))</span><br><span class="line">                        logging.info(<span class="string">'upload complete: &#123;&#125;'</span>.format(movieid))</span><br><span class="line">                self.handledurl.add(i.replace(<span class="string">"\n"</span>, <span class="string">""</span>).split(<span class="string">'_'</span>)[<span class="number">1</span>])   <span class="comment"># 将已处理的titleid记录下来</span></span><br><span class="line">                </span><br><span class="line">test = Lengmen()</span><br><span class="line">test.upload_data()</span><br><span class="line">=====================================================================================================================================</span><br><span class="line">调整上面的代码</span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Event, Thread</span><br><span class="line"><span class="keyword">from</span> boto3.session <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line">FORMAT = <span class="string">'%(asctime)s %(thread)d %(threadName)s %(message)s'</span></span><br><span class="line">logging.basicConfig(format=FORMAT, level=logging.INFO, filename=<span class="string">'/netdisk/znfjValue/offline_oss_update_database.log'</span>, filemode=<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CephS3BOTO3</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        access_key = <span class="string">'xor12345678987654321'</span></span><br><span class="line">        secret_key = <span class="string">'xor12345678987654321xor12345678987654321'</span></span><br><span class="line">        self.session = Session(aws_access_key_id=access_key,aws_secret_access_key=secret_key)</span><br><span class="line">        self.url = <span class="string">'http://172.16.154.88:8060'</span></span><br><span class="line">        self.s3_client = self.session.client(<span class="string">'s3'</span>, endpoint_url=self.url)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(self,file_name,bucket_name,object_name)</span>:</span></span><br><span class="line">        self.s3_client.upload_file(file_name,bucket_name,object_name)</span><br><span class="line"><span class="comment">#        print(resp)</span></span><br><span class="line"><span class="comment">#        return resp</span></span><br><span class="line"></span><br><span class="line">ceph3_boto3 = CephS3BOTO3()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lengmen</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.db = pymysql.connect(<span class="string">"172.16.168.107"</span>, <span class="string">"soonet"</span>, <span class="string">"soonet"</span>, <span class="string">"soonetgh"</span>)</span><br><span class="line">        self.mysql = self.db.cursor()</span><br><span class="line">        self.handledID = set()   <span class="comment"># 保存已处理过的titleid</span></span><br><span class="line">        self.url = <span class="string">"http://172.16.189.27:9090/com.bgctv.sdp.platform.pubsub.pub"</span></span><br><span class="line">        self.data = &#123;&#125;</span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line">        self.uploadData = set()</span><br><span class="line">        self.event = Event()</span><br><span class="line">        self.handledurl = set()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">readfile</span><span class="params">(self)</span>:</span>  <span class="comment"># 读取从mysql中生成的文件</span></span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'znfj_mysql_backup_sort_202005-202011_20201217.txt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">                <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_reConn</span><span class="params">(self)</span>:</span>   <span class="comment"># 重连mysql</span></span><br><span class="line">        <span class="keyword">if</span> self.db.ping():</span><br><span class="line">            self.db = pymysql.connect(<span class="string">"172.16.168.107"</span>, <span class="string">"soonet"</span>, <span class="string">"soonet"</span>, <span class="string">"soonetgh"</span>)</span><br><span class="line">            self.mysql = self.db.cursor()  <span class="comment"># 获取游标</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_database</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.readfile():</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'offline_handleURL.txt'</span>,<span class="string">'r+'</span>) <span class="keyword">as</span> f: </span><br><span class="line">                <span class="keyword">if</span> i <span class="keyword">in</span> f.read():</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            pid = i.replace(<span class="string">"\n"</span>, <span class="string">""</span>).split(<span class="string">'_'</span>)[<span class="number">0</span>]  </span><br><span class="line">            titleid = i.replace(<span class="string">"\n"</span>, <span class="string">""</span>).split(<span class="string">'_'</span>)[<span class="number">1</span>]</span><br><span class="line">            <span class="comment"># 10014_GTIT0120150923200361  pid与titleid混在了一起，前面是pid，后面是titleid</span></span><br><span class="line">            <span class="keyword">if</span> titleid <span class="keyword">in</span> self.handledID: </span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            self._reConn() </span><br><span class="line">            sql = <span class="string">"SELECT * from resource_transcode WHERE Title_ID='&#123;&#125;'"</span>.format(titleid)</span><br><span class="line">            result = self.mysql.execute(sql)</span><br><span class="line">            resultone = self.mysql.fetchone()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                url = resultone[<span class="number">14</span>]</span><br><span class="line">                <span class="keyword">if</span> url.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'trans'</span>:  </span><br><span class="line">                    s3url = url.replace(<span class="string">'trans'</span>, <span class="string">'s3oss'</span>)</span><br><span class="line">                <span class="keyword">elif</span> url.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'newtrans'</span>:</span><br><span class="line">                    s3url = url.replace(<span class="string">'newtrans'</span>, <span class="string">'s3oss'</span>) </span><br><span class="line">                <span class="keyword">elif</span> url.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'newtrans2'</span>:</span><br><span class="line">                    s3url = url.replace(<span class="string">'newtrans2'</span>, <span class="string">'s3oss'</span>) </span><br><span class="line">                <span class="comment"># 原路径：/ vod / newtrans2 / 20200423 / FMOV0120200423401905 / FTIT0120200423401905_1200</span></span><br><span class="line">                <span class="comment"># 更新路径：/ vod / aliyunoss / 20200423 / FMOV0120200423401905 / FTIT0120200423401905_1200</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    logging.info(<span class="string">"unknown url:&#123;&#125;"</span>.format(url))</span><br><span class="line">                    print(<span class="string">'FailID: '</span>,url)</span><br><span class="line">                    s3url = url</span><br><span class="line">                self.handledID.add(titleid)</span><br><span class="line">                logging.info(<span class="string">"handledID: &#123;&#125;"</span>.format(i))</span><br><span class="line">                print(self.handledID, url, s3url, resultone[<span class="number">5</span>], resultone[<span class="number">4</span>], i)</span><br><span class="line">                <span class="keyword">return</span> url, s3url, resultone[<span class="number">5</span>], resultone[<span class="number">4</span>], i </span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                logging.info(<span class="string">'problematicalID: '</span>.format(i))</span><br><span class="line"><span class="comment"># 因为下面的os.walk(path)方法会遍历目录中的所有文件，并生成绝对路径，所以这里调整为取一条sql语句执行结果，之前使用self.mysql.fetchall()方法时会把所</span></span><br><span class="line"><span class="comment"># 有的结果都取出来，因为每条sql语句会生成多个结果。现在通过这一条执行结果就可以取到全部的文件并上传了。另外，加入try...except语句，是因为sql执行的结果</span></span><br><span class="line"><span class="comment"># 可能是None，所以用except来处理这种情况，把有问题的pid_titleid记录下来</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filenamejoin</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> subdir, dirs, files <span class="keyword">in</span> os.walk(path):</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                <span class="keyword">yield</span> subdir+<span class="string">'/'</span>+file</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload_data</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            url, s3url, assetid, movieid, i = self.update_database()</span><br><span class="line">            <span class="keyword">if</span> i.replace(<span class="string">"\n"</span>, <span class="string">""</span>).split(<span class="string">'_'</span>)[<span class="number">1</span>] <span class="keyword">in</span> self.handledurl:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">for</span> upload_Data <span class="keyword">in</span> self.filenamejoin(Path(url).parent): </span><br><span class="line">                <span class="keyword">if</span> upload_Data.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'trans'</span>:  </span><br><span class="line">                    s3upload_Data = upload_Data.replace(<span class="string">'trans'</span>, <span class="string">'s3oss'</span>)  </span><br><span class="line">                <span class="keyword">elif</span> upload_Data.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'newtrans'</span>:</span><br><span class="line">                    s3upload_Data = upload_Data.replace(<span class="string">'newtrans'</span>, <span class="string">'s3oss'</span>)</span><br><span class="line">                <span class="keyword">elif</span> upload_Data.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'newtrans2'</span>:</span><br><span class="line">                    s3upload_Data = upload_Data.replace(<span class="string">'newtrans2'</span>, <span class="string">'s3oss'</span>)</span><br><span class="line">                <span class="keyword">with</span> open(<span class="string">'offline_handleURL.txt'</span>,<span class="string">'r+'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    count = len(f.readlines())</span><br><span class="line">                    <span class="keyword">if</span> count &gt;= <span class="number">300000</span>:</span><br><span class="line">                        sys.exit()</span><br><span class="line">                    <span class="keyword">if</span> upload_Data.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'s3oss'</span> <span class="keyword">or</span> upload_Data.split(<span class="string">'/'</span>)[<span class="number">2</span>] == <span class="string">'aliyunoss'</span>:</span><br><span class="line">                        print(<span class="string">'s3oss_OR_aliyunoss: '</span>,upload_Data)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">elif</span> <span class="keyword">not</span> os.path.exists(upload_Data):</span><br><span class="line">                        print(<span class="string">'not exists: '</span>,upload_Data)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">elif</span> upload_Data <span class="keyword">in</span> f.read():</span><br><span class="line">                        print(<span class="string">'handledUrl'</span>,upload_Data)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        print(<span class="string">'handler: '</span>,url)</span><br><span class="line">                        start = datetime.datetime.now()</span><br><span class="line">                        s1 = psutil.net_io_counters(pernic=<span class="keyword">True</span>)[<span class="string">'ens160'</span>]</span><br><span class="line">                        ceph3_boto3.upload(upload_Data,<span class="string">'xor-media-1'</span>,s3upload_Data.lstrip(<span class="string">'/'</span>))</span><br><span class="line">                        print(<span class="string">'upload: &#123;&#125;, s3upload_Data: &#123;&#125;'</span>.format(url,s3url))</span><br><span class="line">                        s2 = psutil.net_io_counters(pernic=<span class="keyword">True</span>)[<span class="string">'ens160'</span>]</span><br><span class="line">                        second = (datetime.datetime.now()-start).total_seconds()</span><br><span class="line">                        result = str((s2.bytes_sent-s1.bytes_sent)/<span class="number">1024</span>/<span class="number">1024</span>/second) + <span class="string">'Mb/s'</span></span><br><span class="line">                        f.write(<span class="string">'&#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;'</span>.format(datetime.datetime.now(),upload_Data,result,second,i))</span><br><span class="line">                        print(<span class="string">'&#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;'</span>.format(datetime.datetime.now(),upload_Data,result,second,i))</span><br><span class="line">                        logging.info(<span class="string">'upload complete: &#123;&#125;'</span>.format(movieid))</span><br><span class="line">                self.handledurl.add(i.replace(<span class="string">"\n"</span>, <span class="string">""</span>).split(<span class="string">'_'</span>)[<span class="number">1</span>])       </span><br><span class="line"></span><br><span class="line">test = Lengmen()</span><br><span class="line">test.upload_data()</span><br><span class="line"><span class="comment">#test.update_database()</span></span><br><span class="line"></span><br><span class="line">====================================================================================================================================</span><br><span class="line">mysql执行结果</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">                   ID: <span class="number">1249679</span></span><br><span class="line">               TaskID: <span class="number">1249678</span></span><br><span class="line">             Title_ID: GTIT0120150923200361</span><br><span class="line">          Provider_ID: <span class="number">10014</span></span><br><span class="line">               MOV_ID: GMOV0120150923200361</span><br><span class="line">             Asset_ID: GIPA0120150923200361</span><br><span class="line">           Asset_Name: 冰与火的青春<span class="number">03</span></span><br><span class="line">            AssetType: SYNC</span><br><span class="line">            TransType: <span class="number">1</span></span><br><span class="line">              Reso_ID: <span class="number">1</span></span><br><span class="line">                CT_ID: NULL</span><br><span class="line">              MovieID: <span class="number">624689</span></span><br><span class="line">              Chapter: <span class="number">3</span></span><br><span class="line">                 Path: /vod/media/<span class="number">20150923</span>/GMOV0120150923200361.ts</span><br><span class="line">                  URL: /vod/trans/<span class="number">20150923</span>/GMOV0120150923200361/GTIT0120150923200361.m3u8</span><br><span class="line">             Priority: <span class="number">6</span></span><br><span class="line">              Percent: <span class="number">100</span></span><br><span class="line">       VideoCodecInfo: H264;H264;H264</span><br><span class="line">       AudioCodecInfo: AAC;AAC;AAC</span><br><span class="line">              MuxInfo: hls;hls;hls;</span><br><span class="line">          RunTimeInfo: <span class="number">00</span>:<span class="number">46</span>:<span class="number">9</span></span><br><span class="line">       ResolutionInfo: <span class="number">1280</span>*<span class="number">720</span>;<span class="number">720</span>*<span class="number">576</span>;<span class="number">640</span>*<span class="number">480</span></span><br><span class="line">          BitRateInfo: <span class="number">1500</span>;<span class="number">1200</span>;<span class="number">800</span></span><br><span class="line">               Status: <span class="number">4</span></span><br><span class="line">              AddTime: <span class="number">2015</span><span class="number">-09</span><span class="number">-24</span> <span class="number">05</span>:<span class="number">31</span>:<span class="number">37</span></span><br><span class="line">            subset_id: NULL</span><br><span class="line">copyright_modify_time: NULL</span><br><span class="line">*************************** <span class="number">2.</span> row ***************************</span><br><span class="line">                   ID: <span class="number">1249681</span></span><br><span class="line">               TaskID: <span class="number">1249678</span></span><br><span class="line">             Title_ID: GTIT0120150923200361</span><br><span class="line">          Provider_ID: <span class="number">10014</span></span><br><span class="line">               MOV_ID: GMOV0120150923200361</span><br><span class="line">             Asset_ID: GIPB0120150923200361</span><br><span class="line">           Asset_Name: 冰与火的青春<span class="number">03</span></span><br><span class="line">            AssetType: SYNC</span><br><span class="line">            TransType: <span class="number">1</span></span><br><span class="line">              Reso_ID: <span class="number">1</span></span><br><span class="line">                CT_ID: NULL</span><br><span class="line">              MovieID: <span class="number">624689</span></span><br><span class="line">              Chapter: <span class="number">3</span></span><br><span class="line">                 Path: /vod/media/<span class="number">20150923</span>/GMOV0120150923200361.ts</span><br><span class="line">                  URL: /vod/trans/<span class="number">20150923</span>/GMOV0120150923200361/GTIT0120150923200361_1500.m3u8</span><br><span class="line">             Priority: <span class="number">6</span></span><br><span class="line">              Percent: <span class="number">100</span></span><br><span class="line">       VideoCodecInfo: H264</span><br><span class="line">       AudioCodecInfo: AAC</span><br><span class="line">              MuxInfo: hls</span><br><span class="line">          RunTimeInfo: <span class="number">00</span>:<span class="number">46</span>:<span class="number">9</span></span><br><span class="line">       ResolutionInfo: <span class="number">1280</span>*<span class="number">720</span></span><br><span class="line">          BitRateInfo: <span class="number">1500</span></span><br><span class="line">               Status: <span class="number">4</span></span><br><span class="line">              AddTime: <span class="number">2015</span><span class="number">-09</span><span class="number">-24</span> <span class="number">05</span>:<span class="number">31</span>:<span class="number">37</span></span><br><span class="line">            subset_id: NULL</span><br><span class="line">copyright_modify_time: NULL</span><br><span class="line">*************************** <span class="number">3.</span> row ***************************</span><br><span class="line">                   ID: <span class="number">1249683</span></span><br><span class="line">               TaskID: <span class="number">1249678</span></span><br><span class="line">             Title_ID: GTIT0120150923200361</span><br><span class="line">          Provider_ID: <span class="number">10014</span></span><br><span class="line">               MOV_ID: GMOV0120150923200361</span><br><span class="line">             Asset_ID: GIPC0120150923200361</span><br><span class="line">           Asset_Name: 冰与火的青春<span class="number">03</span></span><br><span class="line">            AssetType: SYNC</span><br><span class="line">            TransType: <span class="number">1</span></span><br><span class="line">              Reso_ID: <span class="number">1</span></span><br><span class="line">                CT_ID: NULL</span><br><span class="line">              MovieID: <span class="number">624689</span></span><br><span class="line">              Chapter: <span class="number">3</span></span><br><span class="line">                 Path: /vod/media/<span class="number">20150923</span>/GMOV0120150923200361.ts</span><br><span class="line">                  URL: /vod/trans/<span class="number">20150923</span>/GMOV0120150923200361/GTIT0120150923200361_1200.m3u8</span><br><span class="line">             Priority: <span class="number">6</span></span><br><span class="line">              Percent: <span class="number">100</span></span><br><span class="line">       VideoCodecInfo: H264</span><br><span class="line">       AudioCodecInfo: AAC</span><br><span class="line">              MuxInfo: hls</span><br><span class="line">          RunTimeInfo: <span class="number">00</span>:<span class="number">46</span>:<span class="number">9</span></span><br><span class="line">       ResolutionInfo: <span class="number">720</span>*<span class="number">576</span></span><br><span class="line">          BitRateInfo: <span class="number">1200</span></span><br><span class="line">               Status: <span class="number">4</span></span><br><span class="line">              AddTime: <span class="number">2015</span><span class="number">-09</span><span class="number">-24</span> <span class="number">05</span>:<span class="number">31</span>:<span class="number">37</span></span><br><span class="line">            subset_id: NULL</span><br><span class="line">copyright_modify_time: NULL</span><br><span class="line">*************************** <span class="number">4.</span> row ***************************</span><br><span class="line">                   ID: <span class="number">1249685</span></span><br><span class="line">               TaskID: <span class="number">1249678</span></span><br><span class="line">             Title_ID: GTIT0120150923200361</span><br><span class="line">          Provider_ID: <span class="number">10014</span></span><br><span class="line">               MOV_ID: GMOV0120150923200361</span><br><span class="line">             Asset_ID: GIPD0120150923200361</span><br><span class="line">           Asset_Name: 冰与火的青春<span class="number">03</span></span><br><span class="line">            AssetType: SYNC</span><br><span class="line">            TransType: <span class="number">1</span></span><br><span class="line">              Reso_ID: <span class="number">1</span></span><br><span class="line">                CT_ID: NULL</span><br><span class="line">              MovieID: <span class="number">624689</span></span><br><span class="line">              Chapter: <span class="number">3</span></span><br><span class="line">                 Path: /vod/media/<span class="number">20150923</span>/GMOV0120150923200361.ts</span><br><span class="line">                  URL: /vod/trans/<span class="number">20150923</span>/GMOV0120150923200361/GTIT0120150923200361_800.m3u8</span><br><span class="line">             Priority: <span class="number">6</span></span><br><span class="line">              Percent: <span class="number">100</span></span><br><span class="line">       VideoCodecInfo: H264</span><br><span class="line">       AudioCodecInfo: AAC</span><br><span class="line">              MuxInfo: hls</span><br><span class="line">          RunTimeInfo: <span class="number">00</span>:<span class="number">46</span>:<span class="number">9</span></span><br><span class="line">       ResolutionInfo: <span class="number">640</span>*<span class="number">480</span></span><br><span class="line">          BitRateInfo: <span class="number">800</span></span><br><span class="line">               Status: <span class="number">4</span></span><br><span class="line">              AddTime: <span class="number">2015</span><span class="number">-09</span><span class="number">-24</span> <span class="number">05</span>:<span class="number">31</span>:<span class="number">37</span></span><br><span class="line">            subset_id: NULL</span><br><span class="line">copyright_modify_time: NULL</span><br><span class="line">====================================================================================================================================</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/05/rclone使用方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/05/rclone使用方法/" itemprop="url">
                  rclone使用方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-12-05 22:30:30" itemprop="dateCreated datePublished" datetime="2020-12-05T22:30:30+08:00">2020-12-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-12-07 14:35:42" itemprop="dateModified" datetime="2020-12-07T14:35:42+08:00">2020-12-07</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h1><h2 id="rclone常用命令"><a href="#rclone常用命令" class="headerlink" title="rclone常用命令"></a>rclone常用命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rclone config - 以控制会话的形式添加rclone的配置，配置保存在.rclone.conf文件中。</span><br><span class="line">rclone copy - 将文件从源复制到目的地址，跳过已复制完成的。</span><br><span class="line">rclone sync - 将源数据同步到目的地址，只更新目的地址的数据。</span><br><span class="line">rclone move - 将源数据移动到目的地址。</span><br><span class="line">rclone delete - 删除指定路径下的文件内容。</span><br><span class="line">rclone purge - 清空指定路径下所有文件数据。</span><br><span class="line">rclone mkdir - 创建一个新目录。</span><br><span class="line">rclone rmdir - 删除空目录。</span><br><span class="line">rclone check - 检查源和目的地址数据是否匹配。</span><br><span class="line">rclone ls - 列出指定路径下所有的文件以及文件大小和路径。</span><br><span class="line">rclone lsd - 列出指定路径下所有的目录/容器/桶。</span><br><span class="line">rclone lsl - 列出指定路径下所有文件以及修改时间、文件大小和路径。</span><br><span class="line">rclone md5sum - 为指定路径下的所有文件产生一个md5sum文件。</span><br><span class="line">rclone sha1sum - 为指定路径下的所有文件产生一个sha1sum文件。</span><br><span class="line">rclone size - 获取指定路径下，文件内容的总大小。.</span><br><span class="line">rclone version - 查看当前版本。</span><br><span class="line">rclone cleanup - 清空remote。</span><br><span class="line">rclone dedupe - 交互式查找重复文件，进行删除/重命名操作。</span><br></pre></td></tr></table></figure>
<h2 id="rclone语法"><a href="#rclone语法" class="headerlink" title="rclone语法"></a>rclone语法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 本地到网盘</span></span><br><span class="line">rclone [功能选项] &lt;本地路径&gt; &lt;配置名称:路径&gt; [参数] [参数]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 网盘到本地</span></span><br><span class="line">rclone [功能选项] &lt;配置名称:路径&gt; &lt;本地路径&gt; [参数] [参数]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 网盘到网盘</span></span><br><span class="line">rclone [功能选项] &lt;配置名称:路径&gt; &lt;配置名称:路径&gt; [参数] [参数]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> [参数]为可选项</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 例：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制到网盘，并显示实时传输进度，设置并行上传数为8</span></span><br><span class="line"></span><br><span class="line">rclone copy -P /home/SunPma GD:/home/SunPma --transfers=8</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果需要服务端对服务端的传输可加以下参数（不消耗本地流量）</span></span><br><span class="line"></span><br><span class="line">rclone copy 配置名称:网盘路径 配置名称:网盘路径 --drive-server-side-across-configs</span><br></pre></td></tr></table></figure>
<h2 id="rclone-mount"><a href="#rclone-mount" class="headerlink" title="rclone mount"></a>rclone mount</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rclone mount remote:files /vps/hosts/gdrive --allow-other --allow-non-empty --vfs-cache-mode writes</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">rclone mount googledrice:/ /googledrive --allow-other --allow-non-empty --vfs-cache-mode writes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 把网盘的根目录挂载到本地的gllgledrive上</span></span><br></pre></td></tr></table></figure>
<h2 id="rclone-copy"><a href="#rclone-copy" class="headerlink" title="rclone copy"></a>rclone copy</h2><p>将文件从源复制到目的地址，跳过已复制完成的。命令格式如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rclone <span class="keyword">copy</span><span class="bash"> <span class="built_in">source</span>:sourcepath dest:destpsth</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">例：</span></span><br><span class="line"><span class="bash">rclone copy -LP --transfers=8 /media/shouyu/C64CC89B4CC8879F/Tools GoogleDrive:/Tools</span></span><br><span class="line"><span class="bash"><span class="comment"># -L选项是提示需要添加的选项，为了跟踪复制过程</span></span></span><br><span class="line"><span class="bash"><span class="comment"># -P选项可以显示复制信息，如复制的百分比</span></span></span><br><span class="line"><span class="bash"><span class="comment"># --transfers是设置进程数，这个选项大概就是同时上传多少个文件</span></span></span><br><span class="line"><span class="bash"><span class="comment"># 目标云盘路径可以没有，在执行命令后会自动创建</span></span></span><br></pre></td></tr></table></figure>
<p>注：<br>1、rclone copy复制总是指定路径下的数据；而不是当前目录。<br>2、–no-traverse 标志用于控制是否列出目的地址目录。</p>
<h2 id="rclone-sync"><a href="#rclone-sync" class="headerlink" title="rclone sync"></a>rclone sync</h2><p><code>sync</code> 操作使源和目标完全相同，并且仅修改目标。同步不会传输未更改的文件，并且会按大小和修改时间或 MD5SUM 进行测试。目标会更新为与源相匹配，包括根据需要删除文件。如果在此过程中任何时候发生任何错误，那么不会删除目标中的文件。同步的是目录的<em>内容</em>，而不是目录本身。<code>source:path</code> 是目录时，将复制的是 <code>source:path</code> 的内容，而不是目录名称和内容。如果 <code>dest:path</code> 不存在，那么会创建该路径，并会将 <code>source:path</code> 内容复制到其中。</p>
<p>注：由于这可能导致数据丢失，因此请首先使用 <code>--dry-run</code> 标志进行测试，以准确了解将复制和删除的内容。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone <span class="keyword">sync</span> <span class="keyword">source</span>:path des<span class="variable">t:path</span></span><br></pre></td></tr></table></figure>
<p>注：<br>1、同步数据时，可能会删除目的地址的数据；建议先使用–dry-run标志来检查要复制、删除的数据。<br>2、同步数据出错时，不会删除任何目的地址的数据。<br>3、rclone sync同步的始终是path目录下的数据，而不是path目录。（空目录将不会被同步）</p>
<h2 id="rclone-move"><a href="#rclone-move" class="headerlink" title="rclone move"></a>rclone move</h2><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone <span class="built_in">move</span> source:<span class="built_in">path</span> dest:<span class="built_in">path</span></span><br></pre></td></tr></table></figure>
<p>注：<br>1、同步数据时，可能会删除目的地址的数据；建议先使用–dry-run标志来检查要复制、删除的数据。</p>
<h2 id="rclone-purge"><a href="#rclone-purge" class="headerlink" title="rclone purge"></a>rclone purge</h2><p>清空path目录和数据。命令格式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone <span class="keyword">purge</span> remote:<span class="keyword">path</span></span><br></pre></td></tr></table></figure>
<p>注：<br>1、此命令，include/exclude 过滤器失效。<br>2、删除path目录下部分数据，请使用rclone delete 命令</p>
<h2 id="rclone-mkdir"><a href="#rclone-mkdir" class="headerlink" title="rclone mkdir"></a>rclone mkdir</h2><p>创建path目录。命令格式如下：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone <span class="built_in">mkdir</span> remote:<span class="built_in">path</span></span><br></pre></td></tr></table></figure>
<h2 id="rclone-rmdir"><a href="#rclone-rmdir" class="headerlink" title="rclone rmdir"></a>rclone rmdir</h2><p>删除一个空目录。命令格式如下：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone <span class="built_in">rmdir</span> remote:<span class="built_in">path</span></span><br></pre></td></tr></table></figure>
<p>注：<br>1、不能删除非空的目录，删除非空目录请使用 rclone purge。</p>
<h2 id="rclone-check"><a href="#rclone-check" class="headerlink" title="rclone check"></a>rclone check</h2><p>检查源和目标地址文件是否匹配。命令格式如下：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone<span class="built_in"> check </span>source:path dest:path</span><br></pre></td></tr></table></figure>
<p>注：<br>1、–size-only标志用于指定，只比较大小，不比较MD5SUMs。</p>
<h2 id="rclone-ls"><a href="#rclone-ls" class="headerlink" title="rclone ls"></a>rclone ls</h2><p>仅列出指定path下，所有的文件以及文件大小和路径。命令格式如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">rclone</span> <span class="selector-tag">ls</span> <span class="selector-tag">remote</span><span class="selector-pseudo">:path</span></span><br></pre></td></tr></table></figure>
<h2 id="rclone-lsd"><a href="#rclone-lsd" class="headerlink" title="rclone lsd"></a>rclone lsd</h2><p>仅列出指定path下，所有目录/容器/桶。命令格式如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">rclone</span> <span class="selector-tag">lsd</span> <span class="selector-tag">remote</span><span class="selector-pseudo">:path</span></span><br></pre></td></tr></table></figure>
<h2 id="rclone-lsl"><a href="#rclone-lsl" class="headerlink" title="rclone lsl"></a>rclone lsl</h2><p>仅列出对象的修改时间、大小和路径</p>
<h2 id="rclone-lsf"><a href="#rclone-lsf" class="headerlink" title="rclone lsf"></a>rclone lsf</h2><p>以易于解析的格式列出对象和目录</p>
<h2 id="rclone-lsjson"><a href="#rclone-lsjson" class="headerlink" title="rclone lsjson"></a>rclone lsjson</h2><p>以 JSON 格式列出对象和目录</p>
<h2 id="rclone-delete"><a href="#rclone-delete" class="headerlink" title="rclone delete"></a>rclone delete</h2><p>删除指定目录的内容。命令格式如下：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone <span class="keyword">delete</span> remote:<span class="keyword">path</span></span><br></pre></td></tr></table></figure>
<p>注：<br>1、不同于rclone purge，rclone delete 可使用 include/exclude 过滤器选择删除文件内容。<br>eg：<br>删除文件大小大于100M的文件</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 先检查哪些文件将被删除</span><br><span class="line">rclone --<span class="built_in">min</span>-<span class="built_in">size</span> <span class="number">100</span>M lsl remote:path                  # 使用rclone lsl 列出大于<span class="number">100</span>M的文件</span><br><span class="line">rclone --dry-<span class="built_in">run</span> --<span class="built_in">min</span>-<span class="built_in">size</span> <span class="number">100</span>M <span class="keyword">delete</span> remote:path    # 使用--dry-<span class="built_in">run</span> 检查将要被删除的文件</span><br><span class="line">	</span><br><span class="line"># 使用 rclone <span class="keyword">delete</span> 进行文件删除</span><br><span class="line">rclone --<span class="built_in">min</span>-<span class="built_in">size</span> <span class="number">100</span>M <span class="keyword">delete</span> remote:path</span><br></pre></td></tr></table></figure>
<h2 id="rclone-size"><a href="#rclone-size" class="headerlink" title="rclone size"></a>rclone size</h2><p>获取指定path下所有数据文件的总大小。命令格式如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone <span class="built_in">size</span> remote:path</span><br></pre></td></tr></table></figure>
<h2 id="more"><a href="#more" class="headerlink" title="more"></a>more</h2><p>更多rclone命令，详见<a href="http://rclone.org/commands/" target="_blank" rel="noopener">http://rclone.org/commands/</a> 。</p>
<h1 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h1><table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">-n = –dry-run</td>
<td style="text-align:left">测试运行，查看Rclon在实际运行中会进行哪些操作</td>
</tr>
<tr>
<td style="text-align:left">-P = –progress</td>
<td style="text-align:left">显示实时传输进度，500mS刷新一次，否则默认1分钟刷新一次</td>
</tr>
<tr>
<td style="text-align:left">–cache-chunk-size SizeSuffi</td>
<td style="text-align:left">块的大小，默认5M越大上传越快，占用内存越多，太大可能会导致进程中断</td>
</tr>
<tr>
<td style="text-align:left">–cache-chunk-total-size SizeSuffix</td>
<td style="text-align:left">块可以在本地磁盘上占用的总大小，默认10G</td>
</tr>
<tr>
<td style="text-align:left">–transfers=N</td>
<td style="text-align:left">并行文件数，默认为4</td>
</tr>
<tr>
<td style="text-align:left">–config string</td>
<td style="text-align:left">指定配置文件路径，string为配置文件路径</td>
</tr>
<tr>
<td style="text-align:left">–ignore-errors</td>
<td style="text-align:left">跳过错误。比如 OneDrive 在传了某些特殊文件后会提示<code>Failed to copy: failed to open source object: malwareDetected: Malware detected</code>，这会导致后续的传输任务被终止掉，此时就可以加上这个参数跳过错误。但需要注意 RCLONE 的退出状态码不会为<code>0</code>。</td>
</tr>
</tbody>
</table>
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><p>有4个级别的日志记录：<code>ERROR</code> <code>NOTICE</code> <code>INFO</code> <code>DEBUG</code><br>默认情况下<code>Rclon</code>将生成<code>ERROR</code> <code>NOTICE</code>日志</p>
<table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">-q</td>
<td style="text-align:left">rclone将仅生成ERROR消息</td>
</tr>
<tr>
<td style="text-align:left">-v</td>
<td style="text-align:left">rclone将生成ERROR NOTICE INFO 消息</td>
</tr>
<tr>
<td style="text-align:left">-vv</td>
<td style="text-align:left">rclone 将生成ERROR NOTICE INFO DEBUG 消息</td>
</tr>
<tr>
<td style="text-align:left">–log-level LEVEL</td>
<td style="text-align:left">标志控制日志级别</td>
</tr>
</tbody>
</table>
<p><strong>输出日志到文件</strong><br>使用<code>--log-file=FILE</code>选项<code>rclone</code>会将<code>Error</code>、 <code>Info</code>、 <code>Debug</code>消息以及标准错误重定向到<code>FILE</code>，这里的<code>FILE</code>是你指定的日志文件路径</p>
<h1 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h1><table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">–exclude</td>
<td style="text-align:left">排除文件或目录</td>
</tr>
<tr>
<td style="text-align:left">–include</td>
<td style="text-align:left">包含文件或目录</td>
</tr>
<tr>
<td style="text-align:left">–filter</td>
<td style="text-align:left">文件过滤规则，相当于上面两个选项的其它使用方式。包含规则以+开头，排除规则以-开头</td>
</tr>
</tbody>
</table>
<p><strong>文件类型过滤</strong><br>比如<code>--exclude &quot;*.bak&quot; --filter &quot;- *.bak&quot;</code>排除所有<code>bak</code>文件<br>比如<code>--include &quot;*.{png,jpg}&quot; --filter &quot;+ *.{png,jpg}&quot;</code>包含所有<code>png</code>和<code>jpg</code>文件，排除其他文件<br><code>--delete-excluded</code>删除排除的文件。需配合过滤参数使用，否则无效<br><strong>目录过滤</strong><br>目录过滤需要在目录名称后面加上<code>/</code>否则会被当做文件进行匹配<br>以<code>/</code>开头只会匹配根目录（指定目录下），否则匹配所目录，这同样适用于文件<br><code>--exclude &quot;.git/&quot;</code>排除所有目录下的<code>.git</code>目录<br><code>--exclude &quot;/.git/&quot;</code>只排除根目录下的<code>.git</code>目录<br><code>--exclude &quot;{Video,Software}/&quot;</code>排除所有目录下的<code>Video</code>和<code>Software</code>目录<br><code>--exclude &quot;/{Video,Software}/&quot;</code>只排除根目录下的<code>Video</code>和<code>Software</code>目录<br><code>--include &quot;/{Video,Software}/**&quot;</code>仅包含根目录下的<code>Video</code>和<code>Software</code>目录的所有内容<br><strong>大小过滤</strong><br>默认大小单位为<code>kBytes</code>但可以使用<code>k</code> <code>M</code>或<code>G</code>后缀<br><code>--min-size</code>过滤小于指定大小的文件。比如<code>--min-size 50</code>表示不会传输小于<code>50k</code>的文件。<br><code>--max-size</code>过滤大于指定大小的文件。比如<code>--max-size 1G</code>表示不会传输大于<code>1G</code>的文件。<br><strong>实际使用中发现大小过滤两个选项不能同时使用</strong><br><strong>过滤规则文件</strong><br><code>--filter-from &lt;规则文件&gt;</code>从文件添加包含<code>/</code>排除规则<br>比如<code>--filter-from filter-file.txt</code><br><strong>过滤规则文件示例：</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- secret*.jpg</span><br><span class="line">+ *.jpg</span><br><span class="line">+ *.png</span><br><span class="line">+ file2.avi</span><br><span class="line">- /dir/Trash<span class="comment">/**</span></span><br><span class="line"><span class="comment">+ /dir/**</span></span><br><span class="line"><span class="comment">- *</span></span><br></pre></td></tr></table></figure>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><p><code>rclone</code>中的每个选项都可以通过环境变量设置。环境变量的名称可以通过长选项名称进行转换，删除<code>--</code>前缀，更改<code>-</code>为<code>_</code>大写并添加前缀<code>RCLONE_</code>环境变量的优先级会低于命令行选项，即通过命令行追加相应的选项时会覆盖环境变量设定的值。<br>比如设置最小上传大小<code>--min-size 50</code>使用环境变量是<code>RCLONE_MIN_SIZE=50</code>当环境变量设置后，在命令行中使用<code>--min-size 100</code>那么此时环境变量的值就会被覆盖<br><strong>常用环境变量</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">RCLONE_CONFIG</td>
<td style="text-align:left">自定义配置文件路径</td>
</tr>
<tr>
<td style="text-align:left">RCLONE_CONFIG_PASS</td>
<td style="text-align:left">若 rclone 进行了加密设置，把此环境变量设置为密码，可自动解密配置文件</td>
</tr>
<tr>
<td style="text-align:left">RCLONE_RETRIES</td>
<td style="text-align:left">上传失败重试次数，默认 3 次</td>
</tr>
<tr>
<td style="text-align:left">RCLONE_RETRIES_SLEEP</td>
<td style="text-align:left">上传失败重试等待时间，默认禁用，单位s、m、h分别代表秒、分钟、小时</td>
</tr>
<tr>
<td style="text-align:left">CLONE_TRANSFERS</td>
<td style="text-align:left">并行上传文件数</td>
</tr>
<tr>
<td style="text-align:left">RCLONE_CACHE_CHUNK_SIZE</td>
<td style="text-align:left">块的大小，默认5M</td>
</tr>
<tr>
<td style="text-align:left">RCLONE_CACHE_CHUNK_TOTAL_SIZE</td>
<td style="text-align:left">块可以在本地磁盘上占用的总大小，默认10G</td>
</tr>
<tr>
<td style="text-align:left">RCLONE_IGNORE_ERRORS=true</td>
<td style="text-align:left">跳过错误</td>
</tr>
</tbody>
</table>
<p><strong>参考</strong></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/03/docker部署prometheus与Grafana/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/03/docker部署prometheus与Grafana/" itemprop="url">
                  docker部署prometheus与Grafana
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-12-03 14:19:30" itemprop="dateCreated datePublished" datetime="2020-12-03T14:19:30+08:00">2020-12-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-12-14 17:18:00" itemprop="dateModified" datetime="2020-12-14T17:18:00+08:00">2020-12-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><strong>Prometheus Server</strong>：Prometheus Sever是Prometheus组件中的核心部分，负责实现对监控数据的获取，存储及查询。Prometheus Server可以通过静态配置管理监控目标，也可以配合使用Service Discovery的方式动态管理监控目标，并从这些监控目标中获取数据。其次Prometheus Sever需要对采集到的数据进行存储，Prometheus Server本身就是一个实时数据库，将采集到的监控数据按照时间序列的方式存储在本地磁盘当中。Prometheus Server对外提供了自定义的PromQL，实现对数据的查询以及分析。另外Prometheus Server的联邦集群能力可以使其从其他的Prometheus Server实例中获取数据。</p>
<p><strong>Exporters</strong>：Exporter将监控数据采集的端点通过HTTP服务的形式暴露给Prometheus Server，Prometheus Server通过访问该Exporter提供的Endpoint端点，即可以获取到需要采集的监控数据。可以将Exporter分为2类：<br>直接采集：这一类Exporter直接内置了对Prometheus监控的支持，比如cAdvisor，Kubernetes，Etcd，Gokit等，都直接内置了用于向Prometheus暴露监控数据的端点。<br>间接采集：原有监控目标并不直接支持Prometheus，因此需要通过Prometheus提供的Client Library编写该监控目标的监控采集程序。例如：Mysql Exporter，JMX Exporter，Consul Exporter等。</p>
<p><strong>AlertManager</strong>：在Prometheus Server中支持基于Prom QL创建告警规则，如果满足Prom QL定义的规则，则会产生一条告警。在AlertManager从 Prometheus server 端接收到 alerts后，会进行去除重复数据，分组，并路由到对收的接受方式，发出报警。常见的接收方式有：电子邮件，pagerduty，webhook 等。</p>
<p><strong>PushGateway</strong>:Prometheus数据采集基于Prometheus Server从Exporter pull数据，因此当网络环境不允许Prometheus Server和Exporter进行通信时，可以使用PushGateway来进行中转。通过PushGateway将内部网络的监控数据主动Push到Gateway中，Prometheus Server采用针对Exporter同样的方式，将监控数据从PushGateway pull到Prometheus Server。</p>
<p><img src="/images/prometheus/prometheus.png" alt=""></p>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>因为是容器部署，所以提前把要使用的目录都创建出来</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -pv /home/shouyu/docker/prometheus/&#123;prometheus/data,alertmanager/&#123;storage,template&#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Prometheus-Server"><a href="#Prometheus-Server" class="headerlink" title="Prometheus Server"></a>Prometheus Server</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务器配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 大小写敏感</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用缩进表示层级关系</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 缩进时不允许使用Tab键，只允许使用空格。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</span></span><br><span class="line">vim /home/shouyu/docker/prometheus/prometheus/prometheus.yml</span><br><span class="line"><span class="meta">#</span><span class="bash"> my global config</span></span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # 设定抓取数据的周期，默认为1min</span><br><span class="line">  evaluation_interval: 15s # 设定更新rules文件的周期，默认为1min</span><br><span class="line"><span class="meta">  #</span><span class="bash"> scrape_timeout: 15s <span class="comment"># 设定抓取数据的超时时间，默认为10s</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> external_labels: <span class="comment"># 额外的属性，会添加到拉取得数据并存到数据库中</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash">   monitor: <span class="string">'codelab_monitor'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Alertmanager configuration</span></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets: ['10.0.30.51:9093'] # 设定alertmanager和prometheus交互的接口，即alertmanager监听的ip地址和端口，这里最好写IP地址，不要用localhost</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> rule配置，首次读取默认加载，之后根据evaluation_interval设定的周期加载</span></span><br><span class="line">rule_files:</span><br><span class="line">  - "alertmanager_rules.yml"</span><br><span class="line"><span class="meta">  #</span><span class="bash"> - <span class="string">"first_rules.yml"</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> - <span class="string">"second_rules.yml"</span></span></span><br><span class="line">  - "memory_over.yml"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Here it<span class="string">'s Prometheus itself.</span></span></span><br><span class="line">scrape_configs:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  - job_name: 'prometheus'  # job_name默认写入timeseries的labels中，可以用于查询使用</span><br><span class="line">    static_configs:  # 静态配置</span><br><span class="line">    - targets: ['localhost:9090']   # prometheus所要抓取数据的地址，即instance实例项</span><br><span class="line">  - job_name: 'node'  # Node Exporters的配置</span><br><span class="line">    scrape_interval: 8s  # 抓取周期，默认采用global配置</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['10.0.30.51:9100']  # 这里最好写IP地址，不要用localhost</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 告警模板定义</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试发现，要把模板文件和配置文件放在一层并挂载到容器的/etc/prometheus目录下，如果将模板放在rules目录中，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 挂载后在容器的/etc/prometheus/rules目录中，会找不到模板文件</span></span><br><span class="line">vim /home/shouyu/docker/prometheus/prometheus/alertmanager_rules.yml</span><br><span class="line">groups:</span><br><span class="line">  - name: test-rules</span><br><span class="line">    rules:</span><br><span class="line">    - alert: InstanceDown # 告警名称</span><br><span class="line">      expr: up == 0 # 告警的判定条件，参考Prometheus高级查询来设定</span><br><span class="line">      for: 2m # 满足告警条件持续时间多久后，才会发送告警</span><br><span class="line">      labels: #标签项</span><br><span class="line">        team: node</span><br><span class="line">      annotations: # 解析项，详细解释告警信息</span><br><span class="line">        summary: "&#123;&#123;$labels.instance&#125;&#125;: has been down"</span><br><span class="line">        description: "&#123;&#123;$labels.instance&#125;&#125;: job &#123;&#123;$labels.job&#125;&#125; has been down "</span><br><span class="line">        #        value: &#123;&#123;$value&#125;&#125;</span><br><span class="line"></span><br><span class="line">vim /home/shouyu/docker/prometheus/prometheus/memory_over.yml</span><br><span class="line">groups:</span><br><span class="line">- name: example</span><br><span class="line">  rules:</span><br><span class="line">  - alert: NodeMemoryUsage</span><br><span class="line">    expr: (1 - (node_memory_MemAvailable_bytes / (node_memory_MemTotal_bytes))) * 100 &gt; 80</span><br><span class="line"><span class="meta">#</span><span class="bash"> expr 是计算公式，(1 - (node_memory_MemAvailable_bytes / (node_memory_MemTotal_bytes))) * 100 表示获取内存使用率</span></span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "&#123;&#123;$labels.instance&#125;&#125;: High Memory usage detected"</span><br><span class="line">      description: "&#123;&#123;$labels.instance&#125;&#125;: Memory usage is above 80% (current value is:&#123;&#123; $value &#125;&#125;)"</span><br></pre></td></tr></table></figure>
<h3 id="动态更新prometheus的配置项"><a href="#动态更新prometheus的配置项" class="headerlink" title="动态更新prometheus的配置项"></a>动态更新prometheus的配置项</h3><p> 动态更新Prometheus的配置，即热更新加载，一共有两种方式：</p>
<p>1）向prometheus进程发送SIGHUP信号</p>
<p>2）<code>curl -X POST http://localdns:9090/-/reload</code></p>
<p>参考链接：<a href="https://songjiayang.gitbooks.io/prometheus/content/qa/hotreload.html" target="_blank" rel="noopener">https://songjiayang.gitbooks.io/prometheus/content/qa/hotreload.html</a></p>
<h3 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run  -d -p 9090:9090 --restart=always \</span><br><span class="line">-v home/shouyu/prometheus/prometheus/data:/prometheus \</span><br><span class="line">-v /home/shouyu/prometheus/prometheus:/etc/prometheus \</span><br><span class="line">--name pro prom/prometheus</span><br></pre></td></tr></table></figure>
<h3 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//localdns:9090/graph</span></span><br></pre></td></tr></table></figure>
<h2 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h2><h3 id="部署-2"><a href="#部署-2" class="headerlink" title="部署"></a>部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p -d  3000:3000 --name grafana grafana/grafana</span><br></pre></td></tr></table></figure>
<h3 id="访问与配置"><a href="#访问与配置" class="headerlink" title="访问与配置"></a>访问与配置</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//localhost:3000/</span></span><br><span class="line">默认用户名密码都是admin</span><br></pre></td></tr></table></figure>
<p><img src="/images/prometheus/Grafana1.png" alt=""></p>
<p>添加prometheus数据源</p>
<ul>
<li>点击主界面”Add your first data source”</li>
</ul>
<p><img src="/images/prometheus/Grafana2.png" alt=""></p>
<ul>
<li>选择Prometheus</li>
</ul>
<p><img src="/images/prometheus/Grafana3.png" alt=""></p>
<ul>
<li>填写数据源设置项</li>
</ul>
<p>URL处填写Prometheus服务所在的IP地址，如果填写localhost:9090会报错</p>
<p><img src="/images/prometheus/Grafana4.png" alt=""></p>
<p>点击下方 Save &amp; Test按钮，保存设置</p>
<p><img src="/images/prometheus/Grafana5.png" alt=""></p>
<ul>
<li>Dashboards页面选择“Prometheus 2.0 Stats”</li>
</ul>
<p>点击Dashboards选项卡，选择Prometheus 2.0 Stats</p>
<p><img src="/images/prometheus/Grafana6.png" alt=""></p>
<ul>
<li>查看监控</li>
</ul>
<p>点击Grafana图标，切换到Grafana主页面，然后点击Home，选择我们刚才添加的Prometheus 2.0 Stats，即可看到监控数据</p>
<p><img src="/images/prometheus/Grafana7.png" alt=""></p>
<p><img src="/images/prometheus/Grafana8.png" alt=""></p>
<p><img src="/images/prometheus/Grafana9.png" alt=""></p>
<p><img src="/images/prometheus/Grafana10.png" alt=""></p>
<h2 id="Node-Exporter"><a href="#Node-Exporter" class="headerlink" title="Node Exporter"></a>Node Exporter</h2><h3 id="部署-3"><a href="#部署-3" class="headerlink" title="部署"></a>部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">下载node-exporter地址：https://github.com/prometheus/node_exporter/releases</span><br><span class="line">tar xzf node_exporter-0.18.1.linux-amd64.tar.gz</span><br><span class="line">mv node_exporter-0.18.1.linux-amd64 /opt/node_exporter</span><br><span class="line">cd /opt/node_exporter</span><br><span class="line">./node_exporter</span><br></pre></td></tr></table></figure>
<h3 id="访问Node-Exporter"><a href="#访问Node-Exporter" class="headerlink" title="访问Node Exporter"></a>访问Node Exporter</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localhost:9100/metrics</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到采集到的主机硬件信息</span></span><br></pre></td></tr></table></figure>
<h3 id="访问Prometheus"><a href="#访问Prometheus" class="headerlink" title="访问Prometheus"></a>访问Prometheus</h3><p>在status -&gt; Targets中可以看到加入的Node Exporter，这是在prometheus.yml中定义好的</p>
<p><img src="/images/prometheus/prometheus2.png" alt=""></p>
<h2 id="Alertmanager"><a href="#Alertmanager" class="headerlink" title="Alertmanager"></a>Alertmanager</h2><h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务配置</span></span><br><span class="line">vim /home/shouyu/docker/prometheus/alertmanager/alertmanager.yml</span><br><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m  # 处理超时时间，默认为5min</span><br><span class="line">  smtp_smarthost: 'smtp.office365.com:587'  # 发件邮箱的smtp地址，这里必须加上端口</span><br><span class="line">  smtp_from: 'xxxxxxx@hotmail.com'          # 发送邮件的邮箱地址</span><br><span class="line">  smtp_auth_username: 'xxxxxxxx@hotmail.com' # 发送邮件的邮箱地址，这个地址和上面的地址是一样的</span><br><span class="line">  smtp_auth_password: 'xxxxxxxxxxx'           # 邮箱密码或授权码，qq邮箱要用授权码</span><br><span class="line">  smtp_require_tls: true  # 这一行要标明，如果有安全传输，用true，否则用false</span><br><span class="line"></span><br><span class="line">templates:  #定义模板</span><br><span class="line">  - 'template/*.tmpl'</span><br><span class="line">  </span><br><span class="line">route:  # 定义路由信息</span><br><span class="line">  group_by: ['alertname'] # 报警分组依据</span><br><span class="line">  group_wait: 10s         # 最初即第一次等待多久时间发送一组警报的通知</span><br><span class="line">  group_interval: 10s      # 在发送新警报前的等待时间</span><br><span class="line">  repeat_interval: 30m     # 发送重复警报的周期 对于email配置中，此项不可以设置过低，否则将会由于邮件发送太多频繁，被smtp服务器拒绝</span><br><span class="line">  receiver: 'mail'          # 发送警报的接收者的名称，这个参数是必选的，和下面receivers-&gt;name名要相同</span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line">- name: 'mail'            # 报警组名</span><br><span class="line">  email_configs: # 邮箱配置</span><br><span class="line">  - to: '1102998123@qq.com' # 发送给谁，接收警报的email配置</span><br><span class="line">    html: '&#123;&#123; template "test.html" . &#125;&#125;'  # 设定邮箱的内容模板，只需要改引号中的名称</span><br><span class="line">    send_resolved: true</span><br><span class="line">  webhook_configs: # webhook配置</span><br><span class="line">  - url: 'http://127.0.0.1:5001'</span><br><span class="line">    send_resolved: true</span><br><span class="line">  wechat_configs: # 企业微信报警配置</span><br><span class="line">  - send_resolved: true</span><br><span class="line">    to_party: '1' # 接收组的id</span><br><span class="line">    agent_id: '1000002' # (企业微信--&gt;自定应用--&gt;AgentId)</span><br><span class="line">    corp_id: '******' # 企业信息(我的企业--&gt;CorpId[在底部])</span><br><span class="line">    api_secret: '******' # 企业微信(企业微信--&gt;自定应用--&gt;Secret)</span><br><span class="line">    message: '&#123;&#123; template "test_wechat.html" . &#125;&#125;' # 发送消息模板的设定</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一个inhibition规则是在与另一组匹配器匹配的警报存在的条件下，使匹配一组匹配器的警报失效的规则。两个警报必须具有一组相同的标签。  </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">告警抑制</span></span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: 'critical'</span><br><span class="line">    target_match:</span><br><span class="line">      severity: 'warning'</span><br><span class="line">    equal: ['alertname', 'dev', 'instance']</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 模板配置</span></span><br><span class="line">vim /home/shouyu/docker/prometheus/alertmanager/template/test.tmpl</span><br><span class="line">&#123;&#123; define "test.html" &#125;&#125; # 这个名称与上面配置文件中的receivers:里的html: '&#123;&#123; template "test.html" . &#125;&#125;' 是对应的，如果名称不一样，alertmanager的日志会提示没有这个模板文件</span><br><span class="line">&lt;table border="1"&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;报警项&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;实例&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;报警阀值&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;开始时间&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; range $i, $alert := .Alerts &#125;&#125;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index $alert.Labels "alertname" &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index $alert.Labels "instance" &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index $alert.Annotations "value" &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; $alert.StartsAt &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; end &#125;&#125;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上述Labels项，表示prometheus里面的可选label项。Annotation项表示报警规则中定义的annotation项的内容。</span></span><br><span class="line">vim /home/shouyu/docker/prometheus/alertmanager/template/test_wechat.tmpl</span><br><span class="line">&#123;&#123; define "test.html" &#125;&#125; </span><br><span class="line">  &#123;&#123; range $i, $alert := .Alerts.Firing &#125;&#125;</span><br><span class="line">    [报警项]:&#123;&#123; index $alert.Labels "alertname" &#125;&#125;</span><br><span class="line">    [实例]:&#123;&#123; index $alert.Labels "instance" &#125;&#125;</span><br><span class="line">    [报警阀值]:&#123;&#123; index $alert.Annotations "value" &#125;&#125;</span><br><span class="line">    [开始时间]:&#123;&#123; $alert.StartsAt &#125;&#125;</span><br><span class="line">  &#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="访问Alertmanager"><a href="#访问Alertmanager" class="headerlink" title="访问Alertmanager"></a>访问Alertmanager</h3><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>//localdns:<span class="number">9093</span>/<span class="meta">#/alerts</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/prometheus/prometheus3.png" alt=""></p>
<p>可以通过重启prometheus服务触发邮件报警</p>
<h3 id="访问Prometheus-1"><a href="#访问Prometheus-1" class="headerlink" title="访问Prometheus"></a>访问Prometheus</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//192.168.253.42:9090/alerts</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/prometheus/prometheus4.png" alt=""></p>
<p>发送报警时，会在Pending中显示，发送完会在Firing中显示，如果没有收到邮件，可以到alertmanager日志中查看原因</p>
<h1 id="备忘"><a href="#备忘" class="headerlink" title="备忘"></a>备忘</h1><h2 id="Node-Exporter-采集数据注解"><a href="#Node-Exporter-采集数据注解" class="headerlink" title="Node Exporter 采集数据注解"></a>Node Exporter 采集数据注解</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">例：</span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP node_cpu Seconds the cpus spent <span class="keyword">in</span> each mode.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE node_cpu counter</span></span><br><span class="line">node_cpu&#123;cpu="cpu0",mode="idle"&#125; 362812.7890625</span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP node_load1 1m load average.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE node_load1 gauge</span></span><br><span class="line">node_load1 3.0703125</span><br><span class="line"></span><br><span class="line">其中HELP用于解释当前指标的含义，TYPE则说明当前指标的数据类型。在上面的例子中node_cpu的注释表明当前指标是</span><br><span class="line">cpu0上idle进程占用CPU的总时间，CPU占用时间是一个只增不减的度量指标，从类型中也可以看出node_cpu的数据类型是</span><br><span class="line">计数器(counter)，与该指标的实际含义一致。又例如node_load1该指标反映了当前主机在最近一分钟以内的负载情况，</span><br><span class="line">系统的负载情况会随系统资源的使用而变化，因此node_load1反映的是当前状态，数据可能增加也可能减少，从注释中可以</span><br><span class="line">看出当前指标类型为仪表盘(gauge)，与指标反映的实际含义一致。</span><br><span class="line"></span><br><span class="line">除了这些以外，在当前页面中根据物理主机系统的不同，你还可能看到如下监控指标：</span><br><span class="line">node_boot_time：系统启动时间</span><br><span class="line">node_cpu：系统CPU使用量</span><br><span class="line">nodedisk*：磁盘IO</span><br><span class="line">nodefilesystem*：文件系统用量</span><br><span class="line">node_load1：系统负载</span><br><span class="line">nodememeory*：内存使用量</span><br><span class="line">nodenetwork*：网络带宽</span><br><span class="line">node_time：当前系统时间</span><br><span class="line">go_*：node exporter中go相关指标</span><br><span class="line">process_*：node exporter自身进程相关运行指标</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/01/docker部署portainer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/01/docker部署portainer/" itemprop="url">
                  docker部署portainer
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-12-01 13:49:03" itemprop="dateCreated datePublished" datetime="2020-12-01T13:49:03+08:00">2020-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-12-14 17:10:09" itemprop="dateModified" datetime="2020-12-14T17:10:09+08:00">2020-12-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 搜索镜像</span></span><br><span class="line">docker search portainer/portainer</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拉取镜像</span></span><br><span class="line">docker pull portainer/portainer</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行镜像</span></span><br><span class="line">docker run -d -p 9000:9000 --restart=always -v /root/portainer:/data -v /var/run/docker.sock:/var/run/docker.sock --name dev-portainer portainer/portainer</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> -d <span class="comment">#容器在后台运行</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -p 9000:9000 <span class="comment"># 宿主机9000端口映射容器中的9000端口</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -v /var/run/docker.sock:/var/run/docker.sock </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 挂载这个文件是因为启动后要连接本地的docker服务，portainer要求这样挂载</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -v /root/portainer:/data <span class="comment"># 这是一个数据目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> –name dev-portainer <span class="comment"># 指定运行容器的名称</span></span></span><br></pre></td></tr></table></figure>
<p>创建容器后，登录localhost:9000，设置密码，选择localhost -&gt; Create即可</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/19/python基础学习-SQLAlchemy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/19/python基础学习-SQLAlchemy/" itemprop="url">
                  python基础学习-SQLAlchemy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-11-19 11:27:58" itemprop="dateCreated datePublished" datetime="2020-11-19T11:27:58+08:00">2020-11-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-12-01 16:11:20" itemprop="dateModified" datetime="2020-12-01T16:11:20+08:00">2020-12-01</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SQLAlchemy"><a href="#SQLAlchemy" class="headerlink" title="SQLAlchemy"></a>SQLAlchemy</h1><p>SQLAlchemy是一个ORM框架<br>大量使用了元编程</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><code>pip install sqlalchemy</code></p>
<h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p>官方文档<br><a href="http://docs.sqlalchemy.org/en/latest/" target="_blank" rel="noopener">http://docs.sqlalchemy.org/en/latest/</a></p>
<p>查看版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line">print(sqlalchemy.__version__)</span><br></pre></td></tr></table></figure>
<h2 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h2><p>SQLAlchemy内部使用了连接池</p>
<h3 id="创建连接"><a href="#创建连接" class="headerlink" title="创建连接"></a>创建连接</h3><p>数据库连接的事情，交给引擎</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysqldb的连接</span><br><span class="line">mysql+mysqldb://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;[:&lt;port&gt;]/&lt;dbname&gt;</span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">"mysql+mysqldb://wayne:wayne@127.0.0.1:3306/magedu"</span>)</span><br><span class="line"></span><br><span class="line">pymysql的连接</span><br><span class="line">mysql+pymysql://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;/&lt;dbname&gt;[?&lt;options&gt;]</span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">"mysql+pymysql://wayne:wayne@127.0.0.1:3306/magedu"</span>)</span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">"mysql+pymysql://wayne:wayne@127.0.0.1:3306/magedu"</span>,</span><br><span class="line">echo=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">echo=<span class="keyword">True</span></span><br><span class="line">引擎是否打印执行的语句,调试的时候打开很方便。</span><br></pre></td></tr></table></figure>
<h3 id="Declare-a-Mapping-创建映射"><a href="#Declare-a-Mapping-创建映射" class="headerlink" title="Declare a Mapping 创建映射"></a>Declare a Mapping 创建映射</h3><h4 id="创建基类"><a href="#创建基类" class="headerlink" title="创建基类"></a>创建基类</h4><p>数据库连接的事情，交给引擎</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="comment"># 创建基类,便于实体类继承</span></span><br><span class="line">Base = declarative_base()</span><br></pre></td></tr></table></figure>
<h4 id="创建实体类"><a href="#创建实体类" class="headerlink" title="创建实体类"></a>创建实体类</h4><p>student表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE student (</span><br><span class="line">    id INTEGER NOT NULL AUTO_INCREMENT,</span><br><span class="line">    name VARCHAR(64) NOT NULL,</span><br><span class="line">    age INTEGER,</span><br><span class="line">    PRIMARY KEY (id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建实体类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="comment"># 指定表名</span></span><br><span class="line">    __tablename__ = <span class="string">'student'</span></span><br><span class="line">    <span class="comment"># 定义属性对应字段</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line">    age = Column(Integer)</span><br><span class="line">    <span class="comment"># 第一参数是字段名,如果和属性名不一致,一定要指定</span></span><br><span class="line">    <span class="comment"># age = Column('age', Integer)</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; id=&#123;&#125; name=&#123;&#125; age=&#123;&#125;"</span>.format(</span><br><span class="line">            self.__class__.__name__, self.id, self.name, self.age)</span><br></pre></td></tr></table></figure>
<p><code>__tablename__</code> 指定表名<br>Column类指定对应的字段，必须指定</p>
<h4 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a>实例化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s = Student(name=<span class="string">'tom'</span>)</span><br><span class="line">print(s.name)</span><br><span class="line">s.age = <span class="number">20</span></span><br><span class="line">print(s.age)</span><br></pre></td></tr></table></figure>
<h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><p>可以使用SQLAlchemy来创建、删除表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除继承自Base的所有表</span></span><br><span class="line">Base.metadata.drop_all(engine)</span><br><span class="line"><span class="comment"># 创建继承自Base的所有表</span></span><br><span class="line">Base.metadata.create_all(engine)</span><br></pre></td></tr></table></figure>
<p>生产环境很少这样创建表，都是系统上线的时候由脚本生成。<br>生成环境很少删除表，宁可废弃都不能删除。</p>
<h4 id="创建会话session"><a href="#创建会话session" class="headerlink" title="创建会话session"></a>创建会话session</h4><p>在一个会话中操作数据库，会话建立在连接上，连接被引擎管理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建session</span></span><br><span class="line">Session = sessionmaker(bind=engine) <span class="comment"># 返回类</span></span><br><span class="line">session = Session() <span class="comment"># 实例化</span></span><br></pre></td></tr></table></figure>
<p>session对象线程不安全。所以不同线程使用不用的session对象。<br>Session类和engine都是线程安全的，有一个就行了。</p>
<h4 id="CRUD操作"><a href="#CRUD操作" class="headerlink" title="CRUD操作"></a>CRUD操作</h4><h5 id="增"><a href="#增" class="headerlink" title="增"></a>增</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line">host = <span class="string">'192.168.142.140'</span></span><br><span class="line">user = <span class="string">'wayne'</span></span><br><span class="line">password = <span class="string">'wayne'</span></span><br><span class="line">port = <span class="number">3306</span></span><br><span class="line">database = <span class="string">'test'</span></span><br><span class="line"></span><br><span class="line">conn_str = <span class="string">"mysql+pymysql://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;"</span>.format(</span><br><span class="line">    user, password, host, port, database</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(conn_str, echo=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建基类</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建实体类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="comment"># 指定表名</span></span><br><span class="line">    __tablename__ = <span class="string">'student'</span></span><br><span class="line">    <span class="comment"># 定义属性对应字段</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    age = Column(Integer)</span><br><span class="line">    <span class="comment"># 第一参数是字段名,如果和属性名不一致,一定要指定</span></span><br><span class="line">    <span class="comment"># age = Column('age', Integer)</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; id=&#123;&#125; name=&#123;&#125; age=&#123;&#125;"</span>.format(self.__class__.__name__, self.id, self.name, self.age)</span><br><span class="line">    </span><br><span class="line">s = Student(name=<span class="string">'tom'</span>) <span class="comment"># 构造的时候传入</span></span><br><span class="line">print(s.name)</span><br><span class="line">s.age = <span class="number">20</span> <span class="comment"># 属性赋值</span></span><br><span class="line">print(s.age)</span><br><span class="line"></span><br><span class="line"><span class="comment"># # 删除继承自Base的所有表</span></span><br><span class="line"><span class="comment"># Base.metadata.drop_all(engine)</span></span><br><span class="line"><span class="comment"># # 创建继承自Base的所有表</span></span><br><span class="line"><span class="comment"># Base.metadata.create_all(engine)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建session</span></span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line">session.add(s)</span><br><span class="line">print(s)</span><br><span class="line">session.commit()</span><br><span class="line">print(s)</span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    session.add_all([s])</span><br><span class="line">    print(s)</span><br><span class="line">    session.commit() <span class="comment"># 提交能够成功吗</span></span><br><span class="line">    print(s)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    session.rollback()</span><br><span class="line">    <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>
<p><code>add_all()</code>方法不会提交成功的，不是因为它不对，而是s，s成功提交后，s的主键就有了值，所以，只要s没有修改过，就认为没有改动。如下，s变化了，就可以提交修改了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s.name = <span class="string">'jerry'</span> <span class="comment"># 修改</span></span><br><span class="line">session.add_all([s])</span><br></pre></td></tr></table></figure>
<p>s主键没有值，就是新增；主键有值，就是找到主键对应的记录修改。</p>
<h5 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h5><p>使用<code>query()</code>方法，返回一个Query对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">students = session.query(Student) <span class="comment"># 无条件</span></span><br><span class="line"><span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">    print(student)</span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~'</span>)</span><br><span class="line"></span><br><span class="line">student = session.query(Student).get(<span class="number">2</span>) <span class="comment"># 通过主键查询</span></span><br><span class="line">print(student)</span><br></pre></td></tr></table></figure>
<p>query方法将实体类传入，返回类的对象可迭代对象，这时候并不查询。迭代它就执行SQL来查询数据库，封装数据到指定类的实例。<br>get方法使用主键查询，返回一条传入类的一个实例。</p>
<h5 id="改"><a href="#改" class="headerlink" title="改"></a>改</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">student = session.query(Student).get(<span class="number">2</span>)</span><br><span class="line">print(student)</span><br><span class="line">student.name = <span class="string">'sam'</span></span><br><span class="line">student.age = <span class="number">30</span></span><br><span class="line">print(student)</span><br><span class="line">session.add(student)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>
<p>先查回来，修改后，再提交更改。</p>
<h5 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h5><p>先看下数据库，表中有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 tom 20</span><br><span class="line">2 sam 30</span><br><span class="line">3 jerry 20</span><br><span class="line">4 ben 20</span><br><span class="line">5 ben 20</span><br></pre></td></tr></table></figure>
<p>编写如下程序来删除数据，会发生什么?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    student = Student(id=<span class="number">2</span>, name=<span class="string">"sam"</span>, age=<span class="number">30</span>)</span><br><span class="line">    session.delete(student)</span><br><span class="line">    session.commit()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    session.rollback()</span><br><span class="line">    print(<span class="string">'~~~~~~~~'</span>)</span><br><span class="line">    print(e)</span><br></pre></td></tr></table></figure>
<p>会产生一个异常</p>
<p><code>Instance &#39;&lt;Student at 0x3e654e0&gt;&#39; is not persisted</code> 未持久的异常！</p>
<h5 id="状态"><a href="#状态" class="headerlink" title="状态 **"></a>状态 **</h5><p>每一个实体，都有一个状态属性<code>_sa_instance_state</code>，其类型是<code>sqlalchemy.orm.state.InstanceState</code>，可以使用<br><code>sqlalchemy.inspect(entity)</code>函数查看状态。<br>常见的状态值有transient、pending、persistent、deleted、detached。</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>transient</td>
<td>实体类尚未加入到session中，同时并没有保存到数据库中</td>
</tr>
<tr>
<td>pending</td>
<td>transient的实体被add()到session中，状态切换到pending，但它还没有flush到数据库中</td>
</tr>
<tr>
<td>persistent</td>
<td>session中的实体对象对应着数据库中的真实记录。pending状态在提交成功后可以变成persistent状态，或者查询成功返回的实体也是persistent状态</td>
</tr>
<tr>
<td>deleted</td>
<td>实体被删除且已经flush但未commit完成。事务提交成功了，实体变成detached,事务失败，返回persistent状态</td>
</tr>
<tr>
<td>detached</td>
<td>删除成功的实体进入这个状态</td>
</tr>
</tbody>
</table>
<p>新建一个实体，状态是transient临时的。<br>一旦add()后从transient变成pending状态。<br>成功commit()后从pending变成persistent状态。<br>成功查询返回的实体对象，也是persistent状态。<br>persistent状态的实体，修改依然是persistent状态。<br>persistent状态的实体，删除后，flush后但没有commit，就变成deteled状态，成功提交，变为detached状态，提交失败，还原到persistent状态。flush方法，主动把改变应用到数据库中去。<br>删除、修改操作，需要对应一个真实的记录，所以要求实体对象是persistent状态。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line">connstr = <span class="string">"&#123;&#125;://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;"</span>.format(</span><br><span class="line">    <span class="string">'mysql+pymysql'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>,</span><br><span class="line">    <span class="string">'192.168.142.140'</span>, <span class="number">3306</span>, <span class="string">'test'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">engine = create_engine(connstr, echo=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建实体类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="comment"># 指定表名</span></span><br><span class="line">    __tablename__ = <span class="string">'student'</span></span><br><span class="line">    <span class="comment"># 定义属性对应字段</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>, autoincrement=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    age = Column(Integer)</span><br><span class="line">    <span class="comment"># 第一参数是字段名,如果和属性名不一致,则一定要指定</span></span><br><span class="line">    <span class="comment"># age = Column('age', Integer)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; id=&#123;&#125; name=&#123;&#125; age=&#123;&#125;"</span>.format(self.__class__.__name__, self.id, self.name,self.age)</span><br><span class="line">    </span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm.state <span class="keyword">import</span> InstanceState</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getstate</span><span class="params">(entity, i)</span>:</span></span><br><span class="line">    insp = sqlalchemy.inspect(entity)</span><br><span class="line">    state = <span class="string">"sessionid=&#123;&#125;, attached=&#123;&#125;\ntransient=&#123;&#125;, persistent=&#123;&#125;\npending=&#123;&#125;, deleted=&#123;&#125;,</span></span><br><span class="line"><span class="string">detached=&#123;&#125;"</span>.format(</span><br><span class="line">        insp.session_id,</span><br><span class="line">        insp._attached,</span><br><span class="line">        insp.transient,</span><br><span class="line">        insp.persistent,</span><br><span class="line">        insp.pending,</span><br><span class="line">        insp.deleted,</span><br><span class="line">        insp.detached</span><br><span class="line">    )</span><br><span class="line">    print(i, state)</span><br><span class="line">    print(insp.key)</span><br><span class="line">    print(<span class="string">'-'</span>*<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">student = session.query(Student).get(<span class="number">2</span>)</span><br><span class="line">getstate(student, <span class="number">1</span>) <span class="comment"># persistent</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    student = Student(id=<span class="number">2</span>, name=<span class="string">"sam"</span>, age=<span class="number">30</span>)</span><br><span class="line">    getstate(student, <span class="number">2</span>) <span class="comment"># transit</span></span><br><span class="line">    student = Student(name=<span class="string">"sammy"</span>, age=<span class="number">30</span>)</span><br><span class="line">    getstate(student, <span class="number">3</span>) <span class="comment"># transit</span></span><br><span class="line">    session.add(student) <span class="comment"># add后变成pending</span></span><br><span class="line">    getstate(student, <span class="number">4</span>) <span class="comment"># pending</span></span><br><span class="line">    <span class="comment"># session.delete(student) # 删除的前提是persistent,否则抛异常</span></span><br><span class="line">    <span class="comment"># getstate(student, 5)</span></span><br><span class="line">    session.commit()</span><br><span class="line">    getstate(student, <span class="number">6</span>) <span class="comment"># persistent</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    session.rollback()</span><br><span class="line">    print(<span class="string">'~~~~~~~~'</span>)</span><br><span class="line">    print(e)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line"><span class="number">1</span> sessionid=<span class="number">1</span>, attached=<span class="keyword">True</span></span><br><span class="line">transient=<span class="keyword">False</span>, persistent=<span class="keyword">True</span></span><br><span class="line">pending=<span class="keyword">False</span>, deleted=<span class="keyword">False</span>, detached=<span class="keyword">False</span></span><br><span class="line">(&lt;class '__main__.Student'&gt;, (2,))</span><br><span class="line">------------------------------</span><br><span class="line"><span class="number">2</span> sessionid=<span class="keyword">None</span>, attached=<span class="keyword">False</span></span><br><span class="line">transient=<span class="keyword">True</span>, persistent=<span class="keyword">False</span></span><br><span class="line">pending=<span class="keyword">False</span>, deleted=<span class="keyword">False</span>, detached=<span class="keyword">False</span></span><br><span class="line"><span class="keyword">None</span></span><br><span class="line">-----------------------------<span class="number">-3</span> sessionid=<span class="keyword">None</span>, attached=<span class="keyword">False</span></span><br><span class="line">transient=<span class="keyword">True</span>, persistent=<span class="keyword">False</span></span><br><span class="line">pending=<span class="keyword">False</span>, deleted=<span class="keyword">False</span>, detached=<span class="keyword">False</span></span><br><span class="line"><span class="keyword">None</span></span><br><span class="line">------------------------------</span><br><span class="line"><span class="number">4</span> sessionid=<span class="number">1</span>, attached=<span class="keyword">True</span></span><br><span class="line">transient=<span class="keyword">False</span>, persistent=<span class="keyword">False</span></span><br><span class="line">pending=<span class="keyword">True</span>, deleted=<span class="keyword">False</span>, detached=<span class="keyword">False</span></span><br><span class="line"><span class="keyword">None</span></span><br><span class="line">------------------------------</span><br><span class="line">sqlalchemy.engine.base.Engine COMMIT</span><br><span class="line"><span class="number">6</span> sessionid=<span class="number">1</span>, attached=<span class="keyword">True</span></span><br><span class="line">transient=<span class="keyword">False</span>, persistent=<span class="keyword">True</span></span><br><span class="line">pending=<span class="keyword">False</span>, deleted=<span class="keyword">False</span>, detached=<span class="keyword">False</span></span><br><span class="line">(&lt;class '__main__.Student'&gt;, (3,))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">student = session.query(Student).get(<span class="number">2</span>)</span><br><span class="line">getstate(student, <span class="number">10</span>) <span class="comment"># persistent</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    session.delete(student) <span class="comment"># 删除的前提是persistent</span></span><br><span class="line">    getstate(student, <span class="number">11</span>) <span class="comment"># persistent</span></span><br><span class="line">    session.flush()</span><br><span class="line">    getstate(student, <span class="number">12</span>) <span class="comment"># deleted</span></span><br><span class="line">    session.commit()</span><br><span class="line">    getstate(student, <span class="number">13</span>) <span class="comment"># persistent</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    session.rollback()</span><br><span class="line">    print(<span class="string">'~~~~~~~~'</span>)</span><br><span class="line">    print(e)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line"><span class="number">10</span> sessionid=<span class="number">1</span>, attached=<span class="keyword">True</span></span><br><span class="line">transient=<span class="keyword">False</span>, persistent=<span class="keyword">True</span></span><br><span class="line">pending=<span class="keyword">False</span>, deleted=<span class="keyword">False</span>, detached=<span class="keyword">False</span></span><br><span class="line">(&lt;class '__main__.Student'&gt;, (2,))</span><br><span class="line">------------------------------</span><br><span class="line"><span class="number">11</span> sessionid=<span class="number">1</span>, attached=<span class="keyword">True</span></span><br><span class="line">transient=<span class="keyword">False</span>, persistent=<span class="keyword">True</span></span><br><span class="line">pending=<span class="keyword">False</span>, deleted=<span class="keyword">False</span>, detached=<span class="keyword">False</span></span><br><span class="line">(&lt;class '__main__.Student'&gt;, (2,))</span><br><span class="line">------------------------------</span><br><span class="line">sqlalchemy.engine.base.Engine DELETE FROM student WHERE student.id = %(id)s</span><br><span class="line">sqlalchemy.engine.base.Engine &#123;<span class="string">'id'</span>: <span class="number">2</span>&#125;</span><br><span class="line"><span class="number">12</span> sessionid=<span class="number">1</span>, attached=<span class="keyword">True</span></span><br><span class="line">transient=<span class="keyword">False</span>, persistent=<span class="keyword">False</span></span><br><span class="line">pending=<span class="keyword">False</span>, deleted=<span class="keyword">True</span>, detached=<span class="keyword">False</span></span><br><span class="line">(&lt;class '__main__.Student'&gt;, (2,))</span><br><span class="line">------------------------------</span><br><span class="line">sqlalchemy.engine.base.Engine COMMIT</span><br><span class="line"><span class="number">13</span> sessionid=<span class="keyword">None</span>, attached=<span class="keyword">False</span></span><br><span class="line">transient=<span class="keyword">False</span>, persistent=Falsepending=<span class="keyword">False</span>, deleted=<span class="keyword">False</span>, detached=<span class="keyword">True</span></span><br><span class="line">(&lt;class '__main__.Student'&gt;, (2,))</span><br><span class="line">------------------------------</span><br></pre></td></tr></table></figure>
<h5 id="复杂查询"><a href="#复杂查询" class="headerlink" title="复杂查询"></a>复杂查询</h5><p>实体类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, Date, Enum, ForeignKey, create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">import</span> enum</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">connstr = <span class="string">"&#123;&#125;://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;"</span>.format(</span><br><span class="line">    <span class="string">'mysql+pymysql'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>,</span><br><span class="line">    <span class="string">'192.168.142.140'</span>, <span class="number">3306</span>, <span class="string">'test'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">engine = create_engine(connstr, echo=<span class="keyword">True</span>)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyEnum</span><span class="params">(enum.Enum)</span>:</span></span><br><span class="line">    M = <span class="string">'M'</span></span><br><span class="line">    F = <span class="string">'F'</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="comment"># 指定表名</span></span><br><span class="line">    __tablename__ = <span class="string">'employees'</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 定义属性对应字段</span></span><br><span class="line">    emp_no = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    birth_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    first_name = Column(String(<span class="number">14</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    last_name = Column(String(<span class="number">16</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    gender = Column(Enum(MyEnum), nullable=<span class="keyword">False</span>)</span><br><span class="line">    hire_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; no=&#123;&#125; name=&#123;&#125; &#123;&#125; gender=&#123;&#125;"</span>.format(</span><br><span class="line">        self.__class__.__name__, self.emp_no, self.first_name, self.last_name,</span><br><span class="line">        self.gender.value</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 打印函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(emps)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> emps:</span><br><span class="line">        print(x)</span><br><span class="line">    print(<span class="string">'~~~~~~~~~~~~~~~'</span>,end=<span class="string">'\n\n'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 简单条件查询</span></span><br><span class="line">emps = session.query(Employee).filter(Employee.emp_no &gt; <span class="number">10015</span>)</span><br><span class="line">show(emps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与或非</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> or_, and_, not_</span><br><span class="line"><span class="comment"># AND 条件</span></span><br><span class="line">emps = session.query(Employee).filter(Employee.emp_no &gt; <span class="number">10015</span>).filter(Employee.gender ==</span><br><span class="line">MyEnum.F)</span><br><span class="line">show(emps)</span><br><span class="line"></span><br><span class="line">emps = session.query(Employee).filter(and_(Employee.emp_no &gt; <span class="number">10015</span>, Employee.gender ==</span><br><span class="line">MyEnum.M))</span><br><span class="line">show(emps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &amp; 一定要注意&amp;符号两边表达式都要加括号</span></span><br><span class="line">emps = session.query(Employee).filter((Employee.emp_no &gt; <span class="number">10015</span>) &amp; (Employee.gender == MyEnum.M))</span><br><span class="line">show(emps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># OR 条件</span></span><br><span class="line">emps = session.query(Employee).filter((Employee.emp_no &gt; <span class="number">10018</span>) | (Employee.emp_no &lt; <span class="number">10003</span>))</span><br><span class="line">show(emps)</span><br><span class="line">emps = session.query(Employee).filter(or_(Employee.emp_no &gt; <span class="number">10018</span>, Employee.emp_no &lt; <span class="number">10003</span>))</span><br><span class="line">show(emps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Not</span></span><br><span class="line">emps = session.query(Employee).filter(not_(Employee.emp_no &lt; <span class="number">10018</span>))</span><br><span class="line">show(emps)</span><br><span class="line"><span class="comment"># 一定注意要加括号</span></span><br><span class="line">emps = session.query(Employee).filter(~(Employee.emp_no &lt; <span class="number">10018</span>))</span><br><span class="line">show(emps)</span><br><span class="line"><span class="comment"># 总之,与或非的运算符&amp;、|、~,一定要在表达式上加上括号</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># in</span></span><br><span class="line">emplist = [<span class="number">10010</span>, <span class="number">10015</span>, <span class="number">10018</span>]</span><br><span class="line">emps = session.query(Employee).filter(Employee.emp_no.in_(emplist))</span><br><span class="line">show(emps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># not in</span></span><br><span class="line">emps = session.query(Employee).filter(~Employee.emp_no.in_(emplist))</span><br><span class="line">show(emps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># like</span></span><br><span class="line">emps = session.query(Employee).filter(Employee.last_name.like(<span class="string">'P%'</span>))</span><br><span class="line">show(emps)</span><br></pre></td></tr></table></figure>
<p>ilike可以忽略大小写匹配</p>
<h5 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 排序</span></span><br><span class="line"><span class="comment"># 升序</span></span><br><span class="line">emps = session.query(Employee).filter(Employee.emp_no &gt; <span class="number">10010</span>).order_by(Employee.emp_no)</span><br><span class="line">emps = session.query(Employee).filter(Employee.emp_no &gt; <span class="number">10010</span>).order_by(Employee.emp_no.asc())</span><br><span class="line">show(emps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 降序</span></span><br><span class="line">emps = session.query(Employee).filter(Employee.emp_no &gt; <span class="number">10010</span>).order_by(Employee.emp_no.desc())</span><br><span class="line">show(emps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多列排序</span></span><br><span class="line">emps = session.query(Employee).filter(Employee.emp_no &gt;</span><br><span class="line"><span class="number">10010</span>).order_by(Employee.last_name).order_by(Employee.emp_no.desc())</span><br><span class="line">show(emps)</span><br></pre></td></tr></table></figure>
<h5 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分页</span></span><br><span class="line">emps = session.query(Employee).limit(<span class="number">4</span>)</span><br><span class="line">show(emps)</span><br><span class="line"></span><br><span class="line">emps = session.query(Employee).limit(<span class="number">4</span>).offset(<span class="number">18</span>)</span><br><span class="line">show(emps)</span><br></pre></td></tr></table></figure>
<h5 id="消费者方法"><a href="#消费者方法" class="headerlink" title="消费者方法"></a>消费者方法</h5><p>消费者方法调用后，Query对象(可迭代)就转换成了一个容器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 总行数</span></span><br><span class="line">emps = session.query(Employee)</span><br><span class="line">print(len(list(emps))) <span class="comment"># 返回大量的结果集,然后转换list</span></span><br><span class="line">print(emps.count()) <span class="comment"># 聚合函数count(*)的查询</span></span><br><span class="line"><span class="comment"># 取所有数据</span></span><br><span class="line">print(emps.all()) <span class="comment"># 返回列表,查不到返回空列表</span></span><br><span class="line"><span class="comment"># 取首行</span></span><br><span class="line">print(emps.first()) <span class="comment"># 返回首行,查不到返回None</span></span><br><span class="line"><span class="comment"># 有且只能有一行</span></span><br><span class="line"><span class="comment">#print(emps.one()) #如果查询结果是多行抛异常</span></span><br><span class="line">print(emps.limit(<span class="number">1</span>).one())</span><br><span class="line"><span class="comment"># 删除 delete by query</span></span><br><span class="line">session.query(Employee).filter(Employee.emp_no &gt; <span class="number">10018</span>).delete()</span><br><span class="line"><span class="comment">#session.commit() # 提交则删除</span></span><br></pre></td></tr></table></figure>
<h5 id="聚合、分组"><a href="#聚合、分组" class="headerlink" title="聚合、分组"></a>聚合、分组</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 聚合函数# count</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func</span><br><span class="line">query = session.query(func.count(Employee.emp_no))</span><br><span class="line">print(query.one()) <span class="comment"># 只能有一行结果</span></span><br><span class="line">print(query.scalar()) <span class="comment"># 取one()返回元组的第一个元素</span></span><br><span class="line"><span class="comment"># max/min/avg</span></span><br><span class="line">print(session.query(func.max(Employee.emp_no)).scalar())</span><br><span class="line">print(session.query(func.min(Employee.emp_no)).scalar())</span><br><span class="line">print(session.query(func.avg(Employee.emp_no)).scalar())</span><br><span class="line"><span class="comment"># 分组</span></span><br><span class="line">print(session.query(Employee.gender,</span><br><span class="line">func.count(Employee.emp_no)).group_by(Employee.gender).all())</span><br></pre></td></tr></table></figure>
<h5 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h5><p><img src="/images/数据库/数据库6.png" alt=""></p>
<p>从语句看出员工、部门之间的关系是多对多关系。<br>先把这些表的Model类和字段属性建立起来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建实体类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="comment"># 指定表名</span></span><br><span class="line">    __tablename__ = <span class="string">'employees'</span></span><br><span class="line">    <span class="comment"># 定义属性对应字段</span></span><br><span class="line">    emp_no = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    birth_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    first_name = Column(String(<span class="number">14</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    last_name = Column(String(<span class="number">16</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    gender = Column(Enum(MyEnum), nullable=<span class="keyword">False</span>)</span><br><span class="line">    hire_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    <span class="comment"># 第一参数是字段名,如果和属性名不一致,一定要指定</span></span><br><span class="line">    <span class="comment"># age = Column('age', Integer)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; no=&#123;&#125; name=&#123;&#125; &#123;&#125; gender=&#123;&#125;"</span>.format(</span><br><span class="line">            self.__class__.__name__, self.emp_no, self.first_name, self.last_name,</span><br><span class="line">            self.gender.value</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Department</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'departments'</span></span><br><span class="line"></span><br><span class="line">    dept_no = Column(String(<span class="number">4</span>), primary_key=<span class="keyword">True</span>)</span><br><span class="line">    dept_name = Column(String(<span class="number">40</span>), nullable=<span class="keyword">False</span>, unique=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; no=&#123;&#125; name=&#123;&#125;"</span>.format(</span><br><span class="line">            type(self).__name__, self.dept_no, self.dept_name)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dept_emp</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">"dept_emp"</span></span><br><span class="line">    demp_no = Column(Integer, ForeignKey(<span class="string">'employees.emp_no'</span>,ondelete=<span class="string">'CASCADE'</span>),primary_key=<span class="keyword">True</span>)</span><br><span class="line">    dept_no = Column(String(<span class="number">4</span>), ForeignKey(<span class="string">'departments.dept_no'</span>, ondelete=<span class="string">'CASCADE'</span>), primary_key=<span class="keyword">True</span>)</span><br><span class="line">    from_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    to_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; empno=&#123;&#125; deptno=&#123;&#125;"</span>.format(</span><br><span class="line">            type(self).__name__, self.emp_no, self.dept_no)</span><br></pre></td></tr></table></figure>
<p><code>ForeignKey(&#39;employees.emp_no&#39;, ondelete=&#39;CASCADE&#39;)</code> 定义外键约束</p>
<p>需求<br>查询10010员工的所在的部门编号<br>1、使用隐式内连接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询10010员工所在的部门编号</span></span><br><span class="line">results = session.query(Employee, Dept_emp).filter(Employee.emp_no ==</span><br><span class="line">Dept_emp.emp_no).filter(Employee.emp_no == <span class="number">10010</span>).all()</span><br><span class="line">show(results)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询结果</span></span><br><span class="line">(Employee no=<span class="number">10010</span> name=Duangkaew Piveteau gender=F, Dept_emp empno=<span class="number">10010</span> deptno=d004)</span><br><span class="line">(Employee no=<span class="number">10010</span> name=Duangkaew Piveteau gender=F, Dept_emp empno=<span class="number">10010</span> deptno=d006)</span><br></pre></td></tr></table></figure>
<p>这种方式产生隐式连接的语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM employees, dept_emp</span><br><span class="line">WHERE employees.emp_no = dept_emp.emp_no AND employees.emp_no = %(emp_no_1)s</span><br></pre></td></tr></table></figure>
<p>2、使用join</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询10010员工所在的部门编号</span></span><br><span class="line"><span class="comment"># 第一种写法</span></span><br><span class="line">results = session.query(Employee).join(Dept_emp).filter(Employee.emp_no == <span class="number">10010</span>).all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种写法</span></span><br><span class="line">results = session.query(Employee).join(Dept_emp, Employee.emp_no ==</span><br><span class="line">Dept_emp.emp_no).filter(Employee.emp_no == <span class="number">10010</span>).all()</span><br><span class="line"></span><br><span class="line">print(results)</span><br></pre></td></tr></table></figure>
<p>这两种写法，返回都只有一行数据，为什么?<br>原因在于 <code>query(Employee)</code> 这个只能返回一个实体对象中去，为了解决这个问题，需要修改实体类Employee，增加属性用来存放部门信息<br><code>sqlalchemy.orm.relationship(实体类名字符串)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="comment"># 指定表名</span></span><br><span class="line">    __tablename__ = <span class="string">'employees'</span></span><br><span class="line">    <span class="comment"># 定义属性对应字段</span></span><br><span class="line">    emp_no = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    birth_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    first_name = Column(String(<span class="number">14</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    last_name = Column(String(<span class="number">16</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    gender = Column(Enum(MyEnum), nullable=<span class="keyword">False</span>)</span><br><span class="line">    hire_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    </span><br><span class="line">    dept_emps = relationship(<span class="string">'Dept_emp'</span>) <span class="comment">#</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; no=&#123;&#125; name=&#123;&#125; &#123;&#125; gender=&#123;&#125; no=&#123;&#125;"</span>.format(</span><br><span class="line">            self.__class__.__name__, self.emp_no, self.first_name, self.last_name,self.gender.value, self.dept_emps</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>查询信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询10010员工所在的部门编号</span></span><br><span class="line"><span class="comment"># 第一种</span></span><br><span class="line">results = session.query(Employee).join(Dept_emp).filter(Employee.emp_no ==</span><br><span class="line">Dept_emp.emp_no).filter(Employee.emp_no == <span class="number">10010</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种</span></span><br><span class="line">results = session.query(Employee).join(Dept_emp, Employee.emp_no ==</span><br><span class="line">Dept_emp.emp_no).filter(Employee.emp_no == <span class="number">10010</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三种</span></span><br><span class="line">results = session.query(Employee).join(Dept_emp, (Employee.emp_no == Dept_emp.emp_no) &amp;</span><br><span class="line">(Employee.emp_no == <span class="number">10010</span>))</span><br><span class="line"></span><br><span class="line">show(results.all())</span><br></pre></td></tr></table></figure>
<p>第一种方法<code>join(Dept_emp)</code>中没有等值条件,会自动生成一个等值条件，如果后面有filter，哪怕是<br><code>filter(Employee.emp_no == Dept_emp.emp_no)</code>这个条件会在where中出现。第一种这种自动增加join的等值条件的方式不好，不要这么写<br>第二种方法在join中增加等值条件，阻止了自动的等值条件的生成。这种方式推荐<br>第三种方法就是第二种，这种方式也可以。<br>再看一个现象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="comment"># 指定表名</span></span><br><span class="line">    __tablename__ = <span class="string">'employees'</span></span><br><span class="line">    <span class="comment"># 定义属性对应字段</span></span><br><span class="line">    emp_no = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    birth_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    first_name = Column(String(<span class="number">14</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    last_name = Column(String(<span class="number">16</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    gender = Column(Enum(MyEnum), nullable=<span class="keyword">False</span>)</span><br><span class="line">    hire_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    </span><br><span class="line">    dept_emps = relationship(<span class="string">'Dept_emp'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; no=&#123;&#125; name=&#123;&#125; &#123;&#125; gender=&#123;&#125; no=&#123;&#125;"</span>.format(</span><br><span class="line">            self.__class__.__name__, self.emp_no, self.first_name, self.last_name,</span><br><span class="line">self.gender.value, self.dept_emps <span class="comment"># 修改self.dept_emps为self.emp_no,再看运行结果</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>产生的SQL语句可以看出，不会有查询dept_emp表的语句产生</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>在开发中，一般都会采用ORM框架，这样就可以使用对象操作表了。<br>定义表映射的类，使用Column的描述器定义类属性，使用ForeignKey来定义外键约束。<br>如果在一个对象中，想查看其它表对应的对象的内容，就要使用relationship来定义关系。<br>是否使用外键?<br>1、力挺派<br>能使数据保证完整性一致性<br>2、嫌弃派<br>开发难度增加，大数据的时候影响插入、修改、删除的效率。<br>在业务层保证数据的一致性。</p>
<p>完整代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, Date, Enum, ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, relationship</span><br><span class="line"></span><br><span class="line">host = <span class="string">'192.168.142.135'</span></span><br><span class="line">user = <span class="string">'wayne'</span></span><br><span class="line">password = <span class="string">'wayne'</span></span><br><span class="line">port = <span class="number">3306</span></span><br><span class="line">database = <span class="string">'test'</span></span><br><span class="line"></span><br><span class="line">conn_str = <span class="string">"mysql+pymysql://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;"</span>.format(</span><br><span class="line">    user, password, host, port, database</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(conn_str, echo=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建基类</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> enum</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyEnum</span><span class="params">(enum.Enum)</span>:</span></span><br><span class="line">    M = <span class="string">'M'</span></span><br><span class="line">    F = <span class="string">'F'</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 创建实体类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="comment"># 指定表名</span></span><br><span class="line">    __tablename__ = <span class="string">'employees'</span></span><br><span class="line">    <span class="comment"># 定义属性对应字段</span></span><br><span class="line">    emp_no = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    birth_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    first_name = Column(String(<span class="number">14</span>), nullable=<span class="keyword">False</span>)last_name = Column(String(<span class="number">16</span>), nullable=<span class="keyword">False</span>)</span><br><span class="line">    gender = Column(Enum(MyEnum), nullable=<span class="keyword">False</span>)</span><br><span class="line">    hire_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    dept_emps = relationship(<span class="string">'Dept_emp'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; no=&#123;&#125; name=&#123;&#125; &#123;&#125; gender=&#123;&#125; no=&#123;&#125;"</span>.format(</span><br><span class="line">            self.__class__.__name__, self.emp_no, self.first_name, self.last_name, self.gender.value, self.dept_emps <span class="comment"># 修改self.dept_emps为self.emp_no,再看运行结果</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Department</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'departments'</span></span><br><span class="line"></span><br><span class="line">    dept_no = Column(String(<span class="number">4</span>), primary_key=<span class="keyword">True</span>)</span><br><span class="line">    dept_name = Column(String(<span class="number">40</span>), nullable=<span class="keyword">False</span>, unique=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; no=&#123;&#125; name=&#123;&#125;"</span>.format(</span><br><span class="line">            type(self).__name__, self.dept_no, self.dept_name)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dept_emp</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">"dept_emp"</span></span><br><span class="line">    emp_no = Column(Integer, ForeignKey(<span class="string">'employees.emp_no'</span>,</span><br><span class="line">    ondelete=<span class="string">'CASCADE'</span>),primary_key=<span class="keyword">True</span>)</span><br><span class="line">    dept_no = Column(String(<span class="number">4</span>), ForeignKey(<span class="string">'departments.dept_no'</span>, ondelete=<span class="string">'CASCADE'</span>),</span><br><span class="line">primary_key=<span class="keyword">True</span>)</span><br><span class="line">    from_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line">    to_date = Column(Date, nullable=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; empno=&#123;&#125; deptno=&#123;&#125;"</span>.format(</span><br><span class="line">            type(self).__name__, self.emp_no, self.dept_no)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># # 删除继承自Base的所有表</span></span><br><span class="line"><span class="comment"># Base.metadata.drop_all(engine)</span></span><br><span class="line"><span class="comment"># # 创建继承自Base的所有表</span></span><br><span class="line"><span class="comment"># Base.metadata.create_all(engine)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建session</span></span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(emps)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> emps:</span><br><span class="line">        print(x)</span><br><span class="line">    print(<span class="string">'~~~~~~~~~~~~~~~'</span>,end=<span class="string">'\n\n'</span>)</span><br><span class="line"><span class="comment"># 查询10010员工所在的部门编号</span></span><br><span class="line">results = session.query(Employee).join(Dept_emp, Employee.emp_no ==</span><br><span class="line">Dept_emp.emp_no).filter(Employee.emp_no == <span class="number">10010</span>)</span><br><span class="line">show(results.all())</span><br></pre></td></tr></table></figure>
<h3 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h3><p>实例类：实实在在地放着数据</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/19/python基础学习-元编程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/19/python基础学习-元编程/" itemprop="url">
                  python基础学习-元编程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-11-19 11:15:32 / 修改時間：11:27:34" itemprop="dateCreated datePublished" datetime="2020-11-19T11:15:32+08:00">2020-11-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="元编程"><a href="#元编程" class="headerlink" title="元编程"></a>元编程</h1><p>元编程概念来自LISP和smalltalk。<br>我们写程序是直接写代码，是否能够用代码来生成未来我们需要的代码吗？这就是元编程<br>用来生成代码的程序称为元程序metaprogram，编写这种程序就称为元编程metaprogramming<br>Python语言能够通过反射实现元编程。</p>
<h2 id="type类"><a href="#type类" class="headerlink" title="type类"></a>type类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">type</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(cls, what, bases=None, dict=None)</span>:</span> <span class="comment"># known special case of type.__init__</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        type(object_or_name, bases, dict)</span></span><br><span class="line"><span class="string">        type(object) -&gt; the object's type</span></span><br><span class="line"><span class="string">        type(name, bases, dict) -&gt; a new type</span></span><br><span class="line"><span class="string">        # (copied from class doc)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p><code>type(object) -&gt; the object&#39;s type</code> ，返回对象的类型，例如type(10)<br><code>type(name, bases, dict) -&gt; a new type</code> 返回一个新的类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">XClass = type(<span class="string">'myclass'</span>, (object,), &#123;<span class="string">'a'</span>:<span class="number">100</span>, <span class="string">'b'</span>:<span class="string">'string'</span>&#125;)</span><br><span class="line">print(XClass)</span><br><span class="line">print(XClass.__dict__)</span><br><span class="line">print(XClass.__name__)</span><br><span class="line">print(XClass.__bases__)</span><br><span class="line">print(XClass.mro())</span><br></pre></td></tr></table></figure>
<p>上例并不稀奇，我们用它创建更加复杂的类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.x = <span class="number">1000</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">    print(self.__dict__)</span><br><span class="line">    </span><br><span class="line">XClass = type(<span class="string">'myclass'</span>, (object,), &#123;<span class="string">'a'</span>:<span class="number">100</span>, <span class="string">'b'</span>: <span class="string">'string'</span>, <span class="string">'show'</span>:show, <span class="string">'__init__'</span>:__init__&#125;)</span><br><span class="line">print(XClass)</span><br><span class="line">print(XClass.__name__)</span><br><span class="line">print(XClass.__dict__)</span><br><span class="line">print(XClass.mro())</span><br><span class="line"></span><br><span class="line">XClass().show()</span><br></pre></td></tr></table></figure>
<p>可以借助type构造任何类，用代码来生成代码，这就是元编程。<br>换一种写法，可以使用继承type的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelMeta</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        print(cls)</span><br><span class="line">        print(args)</span><br><span class="line">        print(kwargs)</span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls, *args,**kwargs)</span><br></pre></td></tr></table></figure>
<p>继承自type，相当于 <code>ModelMeta = type(&#39;ModelMeta&#39;, bases, dict)</code><br>可以认为ModelMeta就是元类，它可以创建出类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelMeta</span><span class="params">(type)</span>:</span> <span class="comment"># 继承自type</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        print(cls)</span><br><span class="line">        print(args)</span><br><span class="line">        print(kwargs, <span class="string">'-------------'</span>)</span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls, *args, **kwargs)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 第一种 使用metaclass关键字参数指定元类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(metaclass=ModelMeta)</span>:</span></span><br><span class="line">    id = <span class="number">100</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'~~A.init~~'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 第二种 B继承自A后,依然是从ModelMeta的类型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'~~B.init~~'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 第三种 元类就可以使用下面的方式创建新的类</span></span><br><span class="line">D = ModelMeta(<span class="string">'D'</span>, (), &#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># C、E是type的实例</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span><span class="keyword">pass</span> <span class="comment"># C = type('C', (), &#123;&#125;)</span></span><br><span class="line">E = type(<span class="string">'E'</span>, (), &#123;&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span><span class="params">(ModelMeta)</span>:</span><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~'</span>)</span><br><span class="line">print(type(A))</span><br><span class="line">print(type(B))</span><br><span class="line">print(type(D))</span><br><span class="line">print(type(C))</span><br><span class="line">print(type(E))</span><br><span class="line">print(type(F))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">ModelMeta</span>'&gt;<span class="params">(<span class="string">'A'</span>, <span class="params">()</span>, &#123;<span class="string">'__init__'</span>: &lt;function A.__init__ at <span class="number">0x0000000001148C80</span>&gt;, <span class="string">'__qualname__'</span>: <span class="string">'A'</span>,</span></span></span><br><span class="line"><span class="class"><span class="params"><span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'id'</span>: <span class="number">100</span>&#125;)</span></span></span><br><span class="line">&#123;&#125; -------------</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">ModelMeta</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="params">(<span class="string">'B'</span>, <span class="params">(&lt;class <span class="string">'__main__.A'</span>&gt;,)</span>, &#123;<span class="string">'__qualname__'</span>: <span class="string">'B'</span>, <span class="string">'__module__'</span>: <span class="string">'__main__'</span>, <span class="string">'__init__'</span>:</span></span></span><br><span class="line"><span class="class"><span class="params">&lt;function B.__init__ at <span class="number">0x0000000001148D08</span>&gt;&#125;)</span></span></span><br><span class="line">&#123;&#125; -------------</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">ModelMeta</span>'&gt;</span></span><br><span class="line"><span class="class"><span class="params">(<span class="string">'D'</span>, <span class="params">()</span>, &#123;&#125;)</span></span></span><br><span class="line">&#123;&#125; -------------</span><br><span class="line">~~~~~~~~~~~~</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">ModelMeta</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">ModelMeta</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">ModelMeta</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">type</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">type</span>'&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">type</span>'&gt;</span></span><br></pre></td></tr></table></figure>
<p>从运行结果还可以分析出 <code>__new__(cls, *args, **kwargs)</code> 的参数结构<br>中间是一个元组 <code>(&#39;A&#39;, (), {&#39;__init__&#39;: &lt;function A.__init__ at 0x0000000000B6E598&gt;, &#39;__module__&#39;:
&#39;__main__&#39;, &#39;__qualname__&#39;: &#39;A&#39;, &#39;id&#39;: 100})</code><br>对应<code>(name, bases, dict)</code><br>修改代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelMeta</span><span class="params">(type)</span>:</span> <span class="comment"># 继承自type</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, dict)</span>:</span></span><br><span class="line">        print(cls)</span><br><span class="line">        print(name)</span><br><span class="line">        print(bases)</span><br><span class="line">        print(dict, <span class="string">'-------------'</span>)</span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls, name, bases, dict)</span><br></pre></td></tr></table></figure>
<h2 id="元类的应用"><a href="#元类的应用" class="headerlink" title="元类的应用"></a>元类的应用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fieldname=None, pk=False, nullable=True)</span>:</span></span><br><span class="line">        self.fieldname = fieldname</span><br><span class="line">        self.pk = pk</span><br><span class="line">        self.nullable = nullable</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;Field &#123;&#125;&gt;"</span>.format(self.fieldname)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelMeta</span><span class="params">(type)</span>:</span> <span class="comment"># 继承自type</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs:dict)</span>:</span></span><br><span class="line">        print(cls)</span><br><span class="line">        print(name)</span><br><span class="line">        print(bases)</span><br><span class="line">        print(attrs, <span class="string">'-------------'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'__tablename__'</span> <span class="keyword">not</span> <span class="keyword">in</span> attrs.keys():</span><br><span class="line">            attrs[<span class="string">'__tablename__'</span>] = name</span><br><span class="line">            </span><br><span class="line">        primarykeys = []</span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> isinstance(v, Field):</span><br><span class="line">                <span class="keyword">if</span> v.fieldname <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                    v.fieldname = k <span class="comment"># 没有名字则使用属性名</span></span><br><span class="line">                <span class="keyword">if</span> v.pk:</span><br><span class="line">                    primarykeys.append(v)</span><br><span class="line">        attrs[<span class="string">'__primarykeys__'</span>] = primarykeys</span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls, name, bases, attrs)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelBase</span><span class="params">(metaclass=ModelMeta)</span>:</span></span><br><span class="line">    <span class="string">'''从ModelBase继承的类的类型都是ModelMeta'''</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(ModelBase)</span>:</span></span><br><span class="line">    id = Field(pk=<span class="keyword">True</span>, nullable=<span class="keyword">False</span>)</span><br><span class="line">    name = Field(<span class="string">'username'</span>, nullable=<span class="keyword">False</span>)</span><br><span class="line">    age = Field()</span><br><span class="line">    </span><br><span class="line">print(Student.__dict__)</span><br></pre></td></tr></table></figure>
<h2 id="元编程总结"><a href="#元编程总结" class="headerlink" title="元编程总结"></a>元编程总结</h2><p>元类是制造类的工厂，是生成类的类。<br>定义一个元类，需要使用<code>type(name, bases, dict)</code>，也可以继承type。<br>构造好元类，就可以在类定义是使用关键字参数metaclass指定元类，可以使用最原始的<code>metatype(name, bases,
dict)</code>的方式构造一个类。<br>元类的 <code>__new__()</code> 方法中，可以获取元类信息、当前类、基类、类属性字典。<br>元编程一般用于框架开发中。</p>
<blockquote>
<p>  开发中除非你明确的知道自己在干什么，否则不要随便使用元编程<br>  99%的情况下用不到元类，可能有些程序员一辈子都不会使用元类</p>
</blockquote>
<p>Django、SQLAlchemy使用了元类，让我们使用起来更方便。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/19/python基础学习-pymysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/19/python基础学习-pymysql/" itemprop="url">
                  python基础学习-pymysql
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-11-19 10:44:25 / 修改時間：11:13:21" itemprop="dateCreated datePublished" datetime="2020-11-19T10:44:25+08:00">2020-11-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数据库开发"><a href="#数据库开发" class="headerlink" title="数据库开发"></a>数据库开发</h1><h2 id="驱动"><a href="#驱动" class="headerlink" title="驱动"></a>驱动</h2><p>MySQL基于TCP协议之上开发，但是网络连接后，传输的数据必须遵循MySQL的协议。<br>封装好MySQL协议的包，就是驱动程序。<br>MySQL的驱动<br>MySQLdb<br>最有名的库。对MySQL的C Client封装实现,支持Python 2，不更新了，不支持Python3<br>MySQL官方Connector<br>pymysql<br>语法兼容MySQLdb，使用Python写的库，支持Python 3</p>
<h2 id="pymysql使用"><a href="#pymysql使用" class="headerlink" title="pymysql使用"></a>pymysql使用</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><code>pip install pymysql</code></p>
<h3 id="创建数据库和表"><a href="#创建数据库和表" class="headerlink" title="创建数据库和表"></a>创建数据库和表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE IF NOT EXISTS school;</span><br><span class="line">SHOW DATABASES;</span><br><span class="line">USE school;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `student` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(255) NOT NULL,</span><br><span class="line">  `age` int(11) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<h3 id="连接Connect"><a href="#连接Connect" class="headerlink" title="连接Connect"></a>连接Connect</h3><p>首先，必须建立一个传输数据通道——连接。<br><code>pymysql.connect()</code>方法返回的是Connections模块下的Connection类实例。connect方法传参就是给Connection类的 <code>__init__</code> 提供参数</p>
<table>
<thead>
<tr>
<th>Connection初始化常用参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>host</td>
<td>主机</td>
</tr>
<tr>
<td>user</td>
<td>用户名</td>
</tr>
<tr>
<td>password</td>
<td>密码</td>
</tr>
<tr>
<td>database</td>
<td>数据库</td>
</tr>
<tr>
<td>port</td>
<td>端口</td>
</tr>
</tbody>
</table>
<p>Connection.ping()方法，测试数据库服务器是否活着。有一个参数reconnect表示断开与服务器连接是否重连。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    conn = pymysql.connect(<span class="string">'192.168.142.135'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>, <span class="string">'school'</span>)</span><br><span class="line">    print(conn.ping(<span class="keyword">False</span>))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="keyword">if</span> conn:</span><br><span class="line">        conn.close()</span><br><span class="line">    print(conn.ping(<span class="keyword">False</span>))</span><br></pre></td></tr></table></figure>
<h3 id="游标Cursor"><a href="#游标Cursor" class="headerlink" title="游标Cursor"></a>游标Cursor</h3><p>操作数据库，必须使用游标，需要先获取一个游标对象。<br><code>Connection.cursor(cursor=None)</code> 方法返回一个新的游标对象。<br>连接没有关闭前，游标对象可以反复使用。<br>cursor参数，可以指定一个Cursor类。如果为None，则使用默认Cursor类。</p>
<h3 id="操作数据库"><a href="#操作数据库" class="headerlink" title="操作数据库"></a>操作数据库</h3><p>数据库操作需要使用Cursor类的实例，提供<code>execute()</code> 方法，执行SQL语句，成功返回影响的行数。</p>
<h3 id="新增记录"><a href="#新增记录" class="headerlink" title="新增记录"></a>新增记录</h3><p>使用<code>insert into</code>语句插入数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    conn = pymysql.connect(<span class="string">'192.168.142.135'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>, <span class="string">'school'</span>)</span><br><span class="line">    print(conn.ping(<span class="keyword">False</span>))</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    insert_sql = <span class="string">"insert into student (name,age) values('tom',20)"</span></span><br><span class="line">    rows = cursor.execute(insert_sql)</span><br><span class="line">    print(rows)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="keyword">if</span> conn:</span><br><span class="line">        conn.close()</span><br></pre></td></tr></table></figure>
<p>发现数据库中没有数据提交成功，为什么?<br>原因在于，在Connection类的<code>__init__</code> 方法的注释中有这么一句话<br>autocommit: Autocommit mode. None means use server default. (default: False)<br>那是否应该开启自动提交呢?<br>不用开启，一般我们需要手动管理事务。</p>
<h3 id="事务管理"><a href="#事务管理" class="headerlink" title="事务管理"></a>事务管理</h3><p>Connection类有三个方法：<br>begin 开始事务<br>commit 将变更提交<br>rollback 回滚事务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">conn = pymysql.connect(<span class="string">'192.168.142.135'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>, <span class="string">'school'</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    insert_sql = <span class="string">"insert into student (name,age) values('tom',20)"</span></span><br><span class="line">    rows = cursor.execute(insert_sql)</span><br><span class="line">    print(rows)</span><br><span class="line">    conn.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    conn.rollback()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="keyword">if</span> cursor:</span><br><span class="line">        cursor.close()</span><br><span class="line">    <span class="keyword">if</span> conn:</span><br><span class="line">        conn.close()</span><br></pre></td></tr></table></figure>
<p>批量增加数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">conn = pymysql.connect(<span class="string">'192.168.142.135'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>, <span class="string">'school'</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        insert_sql = <span class="string">"insert into student (name,age) values('tom&#123;0&#125;',20+&#123;0&#125;)"</span>.format(i)</span><br><span class="line">        rows = cursor.execute(insert_sql)</span><br><span class="line">    conn.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    conn.rollback()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="keyword">if</span> cursor:</span><br><span class="line">        cursor.close()</span><br><span class="line">    <span class="keyword">if</span> conn:</span><br><span class="line">        conn.close()</span><br></pre></td></tr></table></figure>
<h3 id="一般流程"><a href="#一般流程" class="headerlink" title="一般流程"></a>一般流程</h3><ul>
<li>建立连接</li>
<li>获取游标</li>
<li>执行SQL</li>
<li>提交事务</li>
<li>释放资源</li>
</ul>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>Cursor类的获取查询结果集的方法有fetchone()、fetchmany(size=None)、fetchall()。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">conn = pymysql.connect(<span class="string">'192.168.142.135'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>, <span class="string">'school'</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line">sql = <span class="string">'select * from student'</span></span><br><span class="line">rows = cursor.execute(sql) <span class="comment"># 返回影响的行数</span></span><br><span class="line"></span><br><span class="line">print(cursor.fetchone())</span><br><span class="line">print(cursor.fetchone())</span><br><span class="line">print(<span class="string">'1 -----------'</span>)</span><br><span class="line">print(cursor.fetchmany(<span class="number">2</span>))</span><br><span class="line">print(<span class="string">'2 ~~~~~~~~~~~'</span>)</span><br><span class="line">print(cursor.fetchmany(<span class="number">2</span>))</span><br><span class="line">print(<span class="string">'3-----------'</span>)</span><br><span class="line">print(cursor.fetchall())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cursor:</span><br><span class="line">    cursor.close()</span><br><span class="line"><span class="keyword">if</span> conn:</span><br><span class="line">    conn.close()</span><br></pre></td></tr></table></figure>
<p><code>fetchone()</code>方法，获取结果集的下一行<br><code>fetchmany(size=None)</code>方法，size指定返回的行数的行，None则返回空元组。<br><code>fetchall()</code>方法，获取所有行。<br>返回多行，如果走到末尾，就返回空元组，否则返回一个元组，其元素就是每一行的记录。<br>每一行的记录也封装在一个元组中。<br><code>cursor.rownumber</code> 返回当前行号。可以修改，支持负数。<br><code>cursor.rowcount</code> 返回的总行数<br>注意：fetch操作的是结果集，结果集是保存在客户端的，也就是说fetch的时候，查询已经结束了。</p>
<h3 id="带列名查询"><a href="#带列名查询" class="headerlink" title="带列名查询"></a>带列名查询</h3><p>Cursor类有一个Mixin的子类DictCursor。<br>只需要 <code>cursor = conn.cursor(DictCursor)</code>就可以了</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 返回结果</span></span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'tom'</span>, <span class="string">'age'</span>: <span class="number">20</span>, <span class="string">'id'</span>: <span class="number">4</span>&#125;</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'tom0'</span>, <span class="string">'age'</span>: <span class="number">20</span>, <span class="string">'id'</span>: <span class="number">5</span>&#125;</span><br></pre></td></tr></table></figure>
<p>返回一行，是一个字典。<br>返回多行，放在列表中，元素是字典，代表行。</p>
<h3 id="SQL注入攻击"><a href="#SQL注入攻击" class="headerlink" title="SQL注入攻击"></a>SQL注入攻击</h3><p>找出用户id为6的用户信息的SQL语句如下<br><code>SELECT * from student WHERE id = 6</code><br>现在，要求可以找出某个id对应用户的信息，代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">userid = <span class="number">5</span> <span class="comment"># 用户id可以变</span></span><br><span class="line">sql = <span class="string">'SELECT * from student WHERE id = &#123;&#125;'</span>.format(userid)</span><br></pre></td></tr></table></figure>
<p>userid可以变，例如从客户端request请求中获取，直接拼接到查询字符串中。<br>可是，如果userid = ‘5 or 1=1’呢?</p>
<p><code>sql = &#39;SELECT * from student WHERE id = {}&#39;.format(&#39;5 or 1=1&#39;)</code><br>运行的结果竟然是返回了全部数据。<br>SQL注入攻击<br>猜测后台数据库的查询语句使用拼接字符串的方式，从而经过设计为服务端传参，令其拼接出特殊字符串，返回用户想要的结果。<br>永远不要相信客户端传来的数据是规范的及安全的！！！<br>如何解决注入攻击？<br>参数化查询，可以有效防止注入攻击，并提高查询的效率。<br><code>Cursor.execute(query, args=None)</code><br>args，必须是元组、列表或字典。如果查询字符串使用%(name)s，就必须使用字典。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> pymysql.cursors <span class="keyword">import</span> DictCursorconn = pymysql.connect(<span class="string">'192.168.142.135'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>, <span class="string">'school'</span>)</span><br><span class="line">cursor = conn.cursor(DictCursor)</span><br><span class="line"></span><br><span class="line">userid = <span class="string">'5 or 1=1'</span></span><br><span class="line">sql = <span class="string">'SELECT * from student WHERE id = %s'</span></span><br><span class="line">cursor.execute(sql, (userid,)) <span class="comment"># 参数化查询</span></span><br><span class="line">print(cursor.fetchall())</span><br><span class="line">print(<span class="string">'~~~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">sql = <span class="string">'SELECT * from student WHERE name like %(name)s and age &gt; %(age)s'</span></span><br><span class="line">cursor.execute(sql, &#123;<span class="string">'name'</span>:<span class="string">'tom%'</span>, <span class="string">'age'</span>:<span class="number">25</span>&#125;) <span class="comment"># 参数化查询</span></span><br><span class="line">print(cursor.fetchall())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cursor:</span><br><span class="line">    cursor.close()</span><br><span class="line"><span class="keyword">if</span> conn:</span><br><span class="line">    conn.close()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 运行结果</span></span><br><span class="line">\Python35\lib\site-packages\pymysql\cursors.py:<span class="number">323</span>: Warning: (<span class="number">1292</span>, <span class="string">"Truncated incorrect DOUBLE value: '5 or 1=1'"</span>)</span><br><span class="line">self._do_get_result()</span><br><span class="line">[&#123;<span class="string">'age'</span>: <span class="number">20</span>, <span class="string">'id'</span>: <span class="number">5</span>, <span class="string">'name'</span>: <span class="string">'tom0'</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>参数化查询为什么提高效率？<br>原因就是——SQL语句缓存。<br>数据库服务器一般会对SQL语句编译和缓存，编译只对SQL语句部分，所以参数中就算有SQL指令也不会被执行。<br>编译过程,需要词法分析、语法分析、生成AST、优化、生成执行计划等过程，比较耗费资源。<br>服务端会先查找是否对同一条查询语句进行了缓存，如果缓存未失效，则不需要再次编译，从而降低了编译的成本，降低了内存消耗。<br>可以认为SQL语句字符串就是一个key，如果使用拼接方案，每次发过去的SQL语句都不一样，都需要编译并缓存。<br>大量查询的时候，首选使用参数化查询，以节省资源。<br>开发时，应该使用参数化查询。<br>注意：这里说的是查询字符串的缓存，不是查询结果的缓存。</p>
<h3 id="上下文支持"><a href="#上下文支持" class="headerlink" title="上下文支持"></a>上下文支持</h3><p>查看连接类和游标类的源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Context manager that returns a Cursor"""</span></span><br><span class="line">        <span class="keyword">return</span> self.cursor()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc, value, traceback)</span>:</span></span><br><span class="line">        <span class="string">"""On successful exit, commit. On exception, rollback"""</span></span><br><span class="line">        <span class="keyword">if</span> exc:</span><br><span class="line">            self.rollback()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.commit()</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 游标类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cursor</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, *exc_info)</span>:</span></span><br><span class="line">        <span class="keyword">del</span> exc_info</span><br><span class="line">        self.close()</span><br></pre></td></tr></table></figure>
<p>连接类进入上下文的时候会返回一个游标对象，退出时如果没有异常会提交更改。<br>游标类也使用上下文，在退出时关闭游标对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">conn = pymysql.connect(<span class="string">'192.168.142.135'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>, <span class="string">'school'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">            insert_sql = <span class="string">"insert into student (name,age) values('tom&#123;0&#125;',20+&#123;0&#125;)"</span>.format(i)</span><br><span class="line">            rows = cursor.execute(insert_sql)</span><br><span class="line">    conn.commit()</span><br><span class="line">    <span class="comment"># 如果此时使用这个关闭的cursor,会抛异常</span></span><br><span class="line">    <span class="comment"># sql = "select * from student"</span></span><br><span class="line">    <span class="comment"># cursor.execute(sql)</span></span><br><span class="line">    <span class="comment"># print(cursor.fetchall())</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    print(e)</span><br><span class="line">    conn.rollback()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    conn.close()</span><br></pre></td></tr></table></figure>
<p>换一种写法，使用连接的上下文</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">conn = pymysql.connect(<span class="string">'192.168.142.135'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>, <span class="string">'school'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> conn <span class="keyword">as</span> cursor:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        insert_sql = <span class="string">"insert into student (name,age) values('tom&#123;0&#125;',20+&#123;0&#125;)"</span>.format(i)</span><br><span class="line">        rows = cursor.execute(insert_sql)</span><br><span class="line">        </span><br><span class="line">sql = <span class="string">"select * from student"</span></span><br><span class="line">cursor.execute(sql)</span><br><span class="line">print(cursor.fetchall())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>
<p>conn的with进入是返回一个新的cursor对象，退出时，只是提交或者回滚了事务。并没有关闭cursor和conn。<br>不关闭cursor就可以接着用，省的反复创建它。<br>如果想关闭cursor对象，这样写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">conn = pymysql.connect(<span class="string">'192.168.142.135'</span>, <span class="string">'wayne'</span>, <span class="string">'wayne'</span>, <span class="string">'school'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> conn <span class="keyword">as</span> cursor:</span><br><span class="line">    <span class="keyword">with</span> cursor:</span><br><span class="line">        sql = <span class="string">"select * from student"</span></span><br><span class="line">        cursor.execute(sql)</span><br><span class="line">        print(cursor.fetchall())</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>
<p>通过上面的实验，我们应该知道，连接应该不需要反反复复创建销毁，应该是多个cursor共享一个conn。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/19/python基础学习-数据库概述/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/19/python基础学习-数据库概述/" itemprop="url">
                  python基础学习-数据库概述
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-11-19 09:38:35 / 修改時間：10:43:43" itemprop="dateCreated datePublished" datetime="2020-11-19T09:38:35+08:00">2020-11-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>数据库：按照数据结构来组织、存储、管理数据的仓库。</p>
<p>诞生<br>计算机的发明是为了做科学计算的，而科学计算需要大量的数据输入和输出。<br>早期，可以使用打孔卡片的孔、灯泡的亮灭来表示数据输入、输出。<br>后来，数据可以存储在磁带上，顺序的读取、写入磁带。<br>1956年IBM发明了磁盘驱动器这个革命性产品，支持随机访问。<br>随着信息化时代的到来，有了硬件存储技术的发展，有大量的数据需要存储和管理，数据库管理系统DBMS就诞生了。<br>不管使用什么存储介质，数据库的数据模型才是其核心和基础。</p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><p>按照数据模型分类：网状数据库、层次数据库、关系型数据库</p>
<h2 id="层次数据库"><a href="#层次数据库" class="headerlink" title="层次数据库"></a>层次数据库</h2><p>以树型结构表示实体及其之间的联系。关系只支持一对多。代表数据库IBM IMS。</p>
<p><img src="/images/数据库/数据库1.png" alt=""></p>
<h2 id="网状数据库"><a href="#网状数据库" class="headerlink" title="网状数据库"></a>网状数据库</h2><p>通用电气最早在1964年开发出网状数据库IDS，只能运行在GE自家的主机上。</p>
<p><img src="/images/数据库/数据库2.png" alt=""></p>
<p>结点描述数据，结点的联系就是数据的关系。<br>能够直接描述客观世界，可以表示实体间多种复杂关系，而这是层次数据模型无法做到的。比如，一个结点可以有多个父结点，结点之间支持可以多对多关联。</p>
<h2 id="关系数据库"><a href="#关系数据库" class="headerlink" title="关系数据库"></a>关系数据库</h2><p>使用行、列组成的二维表来组织数据和关系，表中行(记录)即可以描述数据实体，也可以描述实体间关系。<br>关系模型比网状模型、层次模型更简单，不需要关系数存储的物理细节，专心于数据的逻辑构建，而且关系模型有论文的严格的数学理论基础支撑。</p>
<p><img src="/images/数据库/数据库3.png" alt=""></p>
<p>1970年，IBM的研究员E.F.Codd发表了名为“A Relational Model of Data for Large Shared Data Banks”的论文，提出了关系模型的概念，奠定了关系模型的理论基础。<br>关系模型，有严格的数学基础,抽象级别较高，简单清晰，便于理解和使用。<br>经过几十年的发展，关系数据库百花齐放，技术日臻成熟和完善。</p>
<p>基于关系模型构建的数据库系统成为RDBMS(Relational DataBase System)。<br>IBM DB2、Oracle的Oracle和Mysql、微软的MS SQL。以前的infomix、Sybase等。</p>
<h3 id="Oracle的发展"><a href="#Oracle的发展" class="headerlink" title="Oracle的发展"></a>Oracle的发展</h3><p>拉里·埃里森(Larry Ellison)仔细阅读了IBM的关系数据库的论文，敏锐意识到在这个研究基础上可以开发商用软件系统。他们决定开发通用商用数据库系统Oracle，这个名字来源于他们曾给中央情报局做过的项目名。几个月后，他们就开发了Oracle 1.0。Oracle快速的被推销，但是很不稳定。直到1992年的时候，Oracle7才逐渐稳定下来，并取得巨大成功。2001年的9i版本被广泛应用。<br>2009年4月20日，甲骨文公司宣布将以每股9.50美元,总计74亿美金收购sun(计算机系统)公司。2010年1月成功收购。<br>2013年，甲骨文超过IBM，成为继微软之后的全球第二大软件公司。</p>
<h3 id="Mysql发展"><a href="#Mysql发展" class="headerlink" title="Mysql发展"></a>Mysql发展</h3><p>1985年几个瑞典人为大型零售商的项目设计了一种利用索引顺序存取数据的软件,这就是MyISAM的前身。1996年，MySQL 1.0发布，随后发布了3.11.1版本，并开始往其它平台移植。2000年MySQL采用GPL协议开源。<br>MySQL 4.0开始支持MyISAM、InnoDB引擎。2005年10月，MySQL 5.0成为里程碑版本。<br>2008年1月被Sun公司收购。<br>2009年1月，在Oracle收购MySQL之前,Monty Widenius担心收购，就从MySQL Server 5.5开始一条新的GPL分支，起名MariaDB。<br>MySQL的引擎是插件化的，可以支持很多种引擎：<br>MyISASM，不支持事务,插入、查询速度快。<br>InnoDB，支持事务，行级锁，MySQL 5.5起的默认引擎</p>
<h3 id="去IOE"><a href="#去IOE" class="headerlink" title="去IOE"></a>去IOE</h3><p>它是阿里巴巴造出的概念。其本意是，在阿里巴巴的IT架构中，去掉IBM的小型机、Oracle数据库、EMC存储设备，取而代之使用自己在开源软件基础上开发的系统。传统上，一个高端大气的数据中心，IBM小型机、Oracle数据库、EMC存储设备，可以说缺一不可。而使用这些架构的企业,不但采购、维护成本极高,核心架构还掌握在他人手中。<br>对于阿里巴巴这样大规模的互联网应用,应该采用开源、开放的系统架构。这种思路并不是阿里巴巴的新发明，国外的谷歌、Facebook、亚马逊等早已为之。只不过它们几乎一开始就有没有采用IT商业公司的架构，所以他们也不用“去IOE”。<br>去IOE，转而使用廉价的架构，稳定性一定下降，需要较高的运维水平解决。</p>
<h2 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a>NoSQL</h2><p>NoSQL是对非SQL、非传统关系型数据库的统称。<br>NoSQL一词诞生于1998年，2009年这个词汇被再次提出指非关系型、分布式、不提供ACID的数据库设计模式。<br>随着互联网时代的到来，数据爆发式增长，数据库技术发展日新月异，要适应新的业务需求。<br>随着移动互联网、物联网的到来，大数据的技术中NoSQL也同样重要。<br>数据库流行度排名 2017.12</p>
<p><img src="/images/数据库/数据库4.png" alt=""></p>
<p>数据库流行度排名 2018.6</p>
<p><img src="/images/数据库/数据库5.png" alt=""></p>
<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><p>MySQL是一种关系型数据库管理软件，支持网络访问,默认服务端口3306。<br>MySQL通信使用mysql协议。<br>问题<br>MySQL应该基于什么网络协议通信？</p>
<p>连接字符串参考<br><a href="https://dev.mysql.com/doc/connector-net/en/connector-net-connection-options.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/connector-net/en/connector-net-connection-options.html</a><br>“server=127.0.0.1;uid=root;pwd=12345;database=test”</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>使用yum安装rpm包，Centos自带的版本太低，建议官方下载安装5.5以上版本。<br>推荐安装MariaDB，或者Percona版本。<br>Percona安装在第十章介绍过，这里不再赘述。<br>找一台虚拟机,安装好MySQL，充当数据库服务器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install Percona-Server-shared-55-5.5.45-rel37.4.el6.x86_64.rpm Percona-Server-client-55-5.5.45-rel37.4.el6.x86_64.rpm Percona-Server-server-55-5.5.45-rel37.4.el6.x86_64.rpm</span><br><span class="line">service mysql start</span><br><span class="line">mysql_secure_installation</span><br><span class="line">mysql -uroot -p &lt; test.sql</span><br></pre></td></tr></table></figure>
<p>test.sql 为测试用脚本</p>
<h3 id="SQL语句"><a href="#SQL语句" class="headerlink" title="SQL语句"></a>SQL语句</h3><p>SQL是结构化查询语言Structured Query Language。1987年被ISO组织标准化。<br>所有主流的关系型数据库都支持SQL，NoSQL也有很大一部分支持SQL。<br>SQL语句分为<br>DDL数据定义语言，负责数据库定义、数据库对象定义，由CREATE、ALTER与DROP三个语法所组成<br>DML数据操作语言，负责对数据库对象的操作，CRUD增删改查<br>DCL数据控制语言，负责数据库权限访问控制，由 GRANT 和 REVOKE 两个指令组成<br>TCL事务控制语言，负责处理ACID事务，支持commit、rollback指令<br>SQL语句大小写不敏感。<br>SQL语句末尾应该使用分号结束。</p>
<h3 id="DCL"><a href="#DCL" class="headerlink" title="DCL"></a>DCL</h3><p>GRANT授权、REVOKE撤销</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL ON employees.* TO &apos;wayne&apos;@&apos;%&apos; IDENTIFIED by &apos;wayne&apos;;</span><br><span class="line">REVOKE ALL ON *.* FROM wayne;</span><br></pre></td></tr></table></figure>
<p><code>*</code>为通配符，指代任意库或者任意表。 <code>.</code> 所有库的所有表；<code>employees.*</code> 表示employees库下所有的表<br><code>%</code> 为通配符，它是SQL语句的通配符，匹配任意长度字符串</p>
<h3 id="DDL"><a href="#DDL" class="headerlink" title="DDL"></a>DDL</h3><p>删除用户（慎用）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP USER wayne;</span><br></pre></td></tr></table></figure>
<p>创建数据库<br>库是数据的集合，所有数据按照数据模型组织在数据库中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE IF NOT EXISTS gogs CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;</span><br></pre></td></tr></table></figure>
<p>CHARACTER SET指定字符集。utf8mb4是utf8的扩展，支持4字节utf8mb4，需要MySQL5.5.3+。<br>COLLATE指定字符集的校对规则，用来做字符串的比较的。例如a、A谁大？<br>删除数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP DATABASE IF EXISTS gogs;</span><br></pre></td></tr></table></figure>
<p>创建表<br>表分为行和列，MySQL是行存数据库。数据是一行行存的，列必须固定多少列。<br>行Row，也称为记录Record，元组。<br>列Column，也称为字段Field。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `employees` (</span><br><span class="line">`emp_no` int(11) NOT NULL,</span><br><span class="line">`birth_date` date NOT NULL,</span><br><span class="line">`first_name` varchar(14) NOT NULL,</span><br><span class="line">`last_name` varchar(16) NOT NULL,</span><br><span class="line">`gender` enum(&apos;M&apos;,&apos;F&apos;) NOT NULL,</span><br><span class="line">`hire_date` date NOT NULL,</span><br><span class="line">PRIMARY KEY (`emp_no`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<p>反引号标注的名称，被认为是非关键字。<br>DESC<br>查看列信息<br>{DESCRIBE | DESC} tbl_name [col_name | wild]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DESC employees;</span><br><span class="line">DESC employees &apos;%name&apos;;</span><br></pre></td></tr></table></figure>
<p>练习<br>设计一张表，记录登录账户的，应该存储用户的姓名、登录名、密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DROP DATABASE IF EXISTS test;</span><br><span class="line">CREATE DATABASE IF NOT EXISTS test CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;</span><br><span class="line">CREATE TABLE `reg` (</span><br><span class="line">`id` int(11) NOT NULL,</span><br><span class="line">`loginname` varchar(50) DEFAULT NULL,</span><br><span class="line">`name` varchar(64) DEFAULT NULL,</span><br><span class="line">`password` varchar(128) DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB;</span><br></pre></td></tr></table></figure>
<h3 id="PRIMARY-KEY-主键"><a href="#PRIMARY-KEY-主键" class="headerlink" title="PRIMARY KEY 主键"></a>PRIMARY KEY 主键</h3><p>表中一列或者多列组成唯一的key，也就是通过这一个或者多个列能唯一的标识一条记录。<br>主键的列不能包含空值null。主键往往设置为整型、长整型，且自增AUTO_INCREMENT。<br>表中可以没有主键，但是，一般表设计中，往往都会有主键。</p>
<h3 id="索引Index"><a href="#索引Index" class="headerlink" title="索引Index"></a>索引Index</h3><p>可以看做是一本字典的目录，为了快速检索用的。空间换时间，显著提高查询效率。<br>可以对一列或者多列字段设定索引。<br>主键索引，主键会自动建立主键索引，主键本身就是为了快速定位唯一记录的。<br>唯一索引，表中的索引列组成的索引必须唯一，但可以为空，非空值必须唯一<br>普通索引，没有唯一性的要求，就是建了一个字典的目录而已。</p>
<h3 id="约束Constraint"><a href="#约束Constraint" class="headerlink" title="约束Constraint"></a>约束Constraint</h3><p>UNIQUE约束(唯一键约束)<br>定义了唯一键索引，就定义了唯一键约束。</p>
<h3 id="PRIMARY-KEY-约束"><a href="#PRIMARY-KEY-约束" class="headerlink" title="PRIMARY KEY 约束"></a>PRIMARY KEY 约束</h3><p>定义了主键，就定义了主键约束。</p>
<h3 id="外键约束Foreign-Key"><a href="#外键约束Foreign-Key" class="headerlink" title="外键约束Foreign Key"></a>外键约束Foreign Key</h3><p>外键，在表B中的列，关联表A中的主键，表B中的列就是外键。<br>如果在表B插入一条数据，B的外键列插入了一个值，这个值必须是表A中存在的主键值。<br>修改表B的外键值也是同样，外键值同样要在表A中存在。<br>如果表A要删除一条记录，那么就等于删除一个主键，那么如果表B中引用到了这个主键，就必须先删除表B中引用这个主键的记录，然后才能删除表A的记录，否则删除失败。<br>修改表A的主键，由于主键的唯一性，修改的主键相当于插入新主键，那么表B引用过这个主键，将阻止表A的主键修改，必须删除表B的相关记录后，才可修改表A的主键。<br>外键约束，是为了保证数据完整性、一致性,杜绝数冗余、数据讹误。</p>
<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>视图，也称虚表，看起来像表。它是由查询语句生成的。可以通过视图进行CRUD操作。<br>视图的作用<br>简化操作，将复杂查询SQL语句定义为视图，可以简化查询。<br>数据安全，视图可以只显示真实表的部分列，或计算后的结果，从而隐藏真实表的数据</p>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>MySQL中的数据类型</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>tinyint</td>
<td>1字节，带符号的范围是-128到127。无符号的范围是0到255。bool或boolean，就是tinyint，0表示假，非0表示真</td>
</tr>
<tr>
<td>smallint</td>
<td>2字节，带符号的范围是-32768到32767。无符号的范围是0到65535</td>
</tr>
<tr>
<td>int</td>
<td>整型，4字节，同Integer，带符号的范围是-2147483648到2147483647。无符号的范围是0到4294967295</td>
</tr>
<tr>
<td>bigint</td>
<td>长整型，8字节，带符号的范围是-9223372036854775808到9223372036854775807。无符号的范围是0到18446744073709551615</td>
</tr>
<tr>
<td>float</td>
<td>单精度浮点数精确到大约7位小数位</td>
</tr>
<tr>
<td>double</td>
<td>双精度浮点数精确到大约15位小数位</td>
</tr>
<tr>
<td>DATE</td>
<td>日期。支持的范围为’1000-01-01’到’9999-12-31’</td>
</tr>
<tr>
<td>DATETIME</td>
<td>支持的范围是’1000-01-01 00:00:00’到’9999-12-31 23:59:59’</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>时间戳。范围是’1970-01-01 00:00:00’到2037年</td>
</tr>
<tr>
<td>char(M)</td>
<td>固定长度，右边填充空格以达到长度要求。M为长度，范围为0~255。M指的是字符个数</td>
</tr>
<tr>
<td>varchar(M)</td>
<td>变长字符串。M 表示最大列长度。M的范围是0到65,535。但不能突破行最大字节数65535</td>
</tr>
<tr>
<td>text</td>
<td>大文本。最大长度为65535(2^16-1)个字符</td>
</tr>
<tr>
<td>BLOB</td>
<td>大字节。最大长度为65535(2^16–1)字节的BLOB列</td>
</tr>
</tbody>
</table>
<p>LENGTH函数返回字节数。而char和varchar定义的M是字符数限制。<br>char可以将字符串变成等长的，空间换时间，效率略高；varchar变长，省了空间。</p>
<h3 id="关系操作"><a href="#关系操作" class="headerlink" title="关系操作"></a>关系操作</h3><p>关系：在关系数据库中，关系就是二维表。<br>关系操作就是对表的操作。<br>选择(selection)：又称为限制，是从关系中选择出满足给定条件的元组。<br>投影(projection)：在关系上投影就是从选择出若干属性列组成新的关系。<br>连接(join)：将不同的两个关系连接成一个关系。</p>
<h3 id="DML-——-CRUD-增删改查"><a href="#DML-——-CRUD-增删改查" class="headerlink" title="DML —— CRUD 增删改查"></a>DML —— CRUD 增删改查</h3><h4 id="Insert语句"><a href="#Insert语句" class="headerlink" title="Insert语句"></a>Insert语句</h4><p><code>INSERT INTO table_name (col_name,...) VALUES (value1,...);</code><br>向表中插入一行数据，自增字段、缺省值字段、可为空字段可以不写<br><code>INSERT INTO table_name SELECT ... ;</code><br>将select查询的结果插入到表中</p>
<p><code>INSERT INTO table_name (col_name1,...) VALUES (value1,...) ON DUPLICATE KEY UPDATE col_name1=value1,...;</code><br>如果主键冲突、唯一键冲突就执行update后的设置。这条语句的意思，就是主键不在新增记录，主键在就更新部分字段。<br><code>INSERT IGNORE INTO table_name (col_name,...) VALUES (value1,...);</code><br>如果主键冲突、唯一键冲突就忽略错误，返回一个警告。</p>
<h4 id="Update语句"><a href="#Update语句" class="headerlink" title="Update语句"></a>Update语句</h4><p><code>UPDATE [IGNORE] tbl_name
SET col_name1=expr1 [, col_name2=expr2 ...]
[WHERE where_definition]
IGNORE 意义同Insert语句
UPDATE reg SET name=&#39;张三&#39; WHERE id=5;</code></p>
<h4 id="Delete语句"><a href="#Delete语句" class="headerlink" title="Delete语句"></a>Delete语句</h4><p><code>DELETE [IGNORE] FROM tbl_name
[WHERE where_definition]</code><br>删除符合条件的记录</p>
<h4 id="Select语句"><a href="#Select语句" class="headerlink" title="Select语句"></a>Select语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">[DISTINCT]</span><br><span class="line">select_expr, ...</span><br><span class="line">[FROM table_references</span><br><span class="line">[WHERE where_definition]</span><br><span class="line">[GROUP BY &#123;col_name | expr | position&#125;</span><br><span class="line">[ASC | DESC], ... [WITH ROLLUP]]</span><br><span class="line">[HAVING where_definition]</span><br><span class="line">[ORDER BY &#123;col_name | expr | position&#125;</span><br><span class="line">[ASC | DESC] , ...]</span><br><span class="line">[LIMIT &#123;[offset,] row_count | row_count OFFSET offset&#125;]</span><br><span class="line">[FOR UPDATE | LOCK IN SHARE MODE]]</span><br></pre></td></tr></table></figure>
<p>FOR UPDATE会把行进行写锁定，这是排它锁。<br>查询<br>查询的结果成为结果集recordset。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT 1;</span><br><span class="line">-- 最简单的查询</span><br><span class="line">SELECT * FROM employees;</span><br><span class="line">-- 字符串合并</span><br><span class="line">SELECT emp_no, first_name + last_name FROM employees;</span><br><span class="line">SELECT emp_no, CONCAT(first_name,&apos; &apos;,last_name) FROM employees;</span><br><span class="line">-- AS 定义别名,可选。写AS是一个好习惯</span><br><span class="line">SELECT emp_no as `no`, CONCAT(first_name,&apos; &apos;,last_name) name FROM employees emp;</span><br></pre></td></tr></table></figure>
<p>Limit子句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 返回5条记录</span><br><span class="line">SELECT * FROM employees emp LIMIT 5;</span><br><span class="line">-- 返回5条记录,偏移18条</span><br><span class="line">SELECT * FROM employees emp LIMIT 5 OFFSET 18;</span><br><span class="line">SELECT * FROM employees emp LIMIT 18, 5;</span><br></pre></td></tr></table></figure>
<p>Where子句</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>=</code></td>
<td>等于</td>
</tr>
<tr>
<td><code>&lt;&gt;</code></td>
<td>不等于</td>
</tr>
<tr>
<td><code>&gt;</code>、<code>&lt;</code>、<code>&gt;=</code>、<code>&lt;=</code></td>
<td>大于、小于、大于等于、小于等于</td>
</tr>
<tr>
<td>BETWEEN</td>
<td>在某个范围之内，<code>between a and b</code>等价于<code>[a,b]</code></td>
</tr>
<tr>
<td>LIKE</td>
<td>字符串模式匹配，<code>%</code>表示任意多个字符，<code>_</code>表示一个字符</td>
</tr>
<tr>
<td>IN</td>
<td>指定针对某个列的多个可能值</td>
</tr>
<tr>
<td>AND</td>
<td>与</td>
</tr>
<tr>
<td>OR</td>
<td>或</td>
</tr>
</tbody>
</table>
<p>注意：如果很多表达式需要使用AND、OR计算逻辑表达式的值的时候，由于有结合律的问题，建议使用小括号来避免产生错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- 条件查询</span><br><span class="line">SELECT * FROM employees WHERE emp_no &lt; 10015 and last_name LIKE &apos;P%&apos;;</span><br><span class="line">SELECT * FROM employees WHERE emp_no BETWEEN 10010 AND 10015 AND last_name LIKE &apos;P%&apos;;</span><br><span class="line">SELECT * FROM employees WHERE emp_no in (10001, 10002, 10010);</span><br></pre></td></tr></table></figure>
<p>Order by子句<br>对查询结果进行排序，可以升序ASC、降序DESC。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 降序</span><br><span class="line">SELECT * FROM employees WHERE emp_no in (10001, 10002, 10010) ORDER BY emp_no DESC;</span><br></pre></td></tr></table></figure>
<p>DISTINCT<br>不返回重复记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- DISTINCT使用</span><br><span class="line">SELECT DISTINCT dept_no from dept_emp;</span><br><span class="line">SELECT DISTINCT emp_no from dept_emp;</span><br><span class="line">SELECT DISTINCT dept_no, emp_no from dept_emp;</span><br></pre></td></tr></table></figure>
<p>聚合函数</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>COUNT(expr)</td>
<td>返回记录中记录的数目，如果指定列，则返回非NULL值的行数</td>
</tr>
<tr>
<td>COUNT(DISTINCT expr,[expr …])</td>
<td>返回不重复的非NULL值的行数</td>
</tr>
<tr>
<td>AVG(GISTINCT expr)</td>
<td>返回平均值，返回不同值的平均值</td>
</tr>
<tr>
<td>MIN(expr), MAX(expr)</td>
<td>最小值，最大值</td>
</tr>
<tr>
<td>SUM([DISTINCT] expr)</td>
<td>求和，Distinct返回不同值求和</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 聚合函数</span><br><span class="line">SELECT COUNT(*), AVG(emp_no), SUM(emp_no), MIN(emp_no), MAX(emp_no) FROM employees;</span><br></pre></td></tr></table></figure>
<p>分组查询<br>使用Group by子句，如果有条件，使用Having子句过滤分组、聚合过的结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-- 聚合所有</span><br><span class="line">SELECT emp_no, SUM(salary), AVG(salary), COUNT(emp_no) from salaries;</span><br><span class="line">-- 聚合被选择的记录</span><br><span class="line">SELECT emp_no, SUM(salary), AVG(salary), COUNT(emp_no) from salaries WHERE emp_no &lt; 10003;</span><br><span class="line">-- 按照不同emp_no分组,每组分别聚合</span><br><span class="line">SELECT emp_no, SUM(salary), AVG(salary), COUNT(emp_no) from salaries WHERE emp_no &lt; 10003 GROUP</span><br><span class="line">BY emp_no;</span><br><span class="line">-- HAVING子句对分组结果过滤</span><br><span class="line">SELECT emp_no, SUM(salary), AVG(salary), COUNT(emp_no) from salaries GROUP BY emp_no HAVING</span><br><span class="line">AVG(salary) &gt; 45000;</span><br><span class="line">-- 使用别名</span><br><span class="line">SELECT emp_no, SUM(salary), AVG(salary) AS sal_avg, COUNT(emp_no) from salaries GROUP BY emp_no</span><br><span class="line">HAVING sal_avg &gt; 60000;</span><br><span class="line">-- 最后对分组过滤后的结果排序</span><br><span class="line">SELECT emp_no, SUM(salary), AVG(salary) AS sal_avg, COUNT(emp_no) from salaries GROUP BY emp_no</span><br><span class="line">HAVING sal_avg &gt; 60000 ORDER BY sal_avg;</span><br></pre></td></tr></table></figure>
<p>子查询<br>查询语句可以嵌套，内部查询就是子查询。<br>子查询必须在一组小括号中。<br>子查询中不能使用Order by。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 子查询</span><br><span class="line">SELECT * FROM employees WHERE emp_no in (SELECT emp_no from employees WHERE emp_no &gt; 10015)</span><br><span class="line">ORDER BY emp_no DESC;</span><br><span class="line">SELECT emp.emp_no, emp.first_name, gender FROM (SELECT * from employees WHERE emp_no &gt; 10015) AS</span><br><span class="line">emp WHERE emp.emp_no &lt; 10019 ORDER BY emp_no DESC;</span><br></pre></td></tr></table></figure>
<p>连接Join<br>交叉连接cross join<br>笛卡尔乘积，全部交叉<br>在MySQL中，CROSS JOIN从语法上说与INNER JOIN等同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- 工资40行</span><br><span class="line">SELECT * FROM salaries;</span><br><span class="line">-- 20行</span><br><span class="line">SELECT * FROM employees;</span><br><span class="line">--- 800行</span><br><span class="line">SELECT * from employees CROSS JOIN salaries;</span><br></pre></td></tr></table></figure>
<p>注意：departments和employees并没有直接的关系，做笛卡尔乘积只是为了看的清楚<br>内连接<br>inner join，省略为join。<br>等值连接，只选某些field相等的元组(行)，使用On限定关联的结果<br>自然连接，特殊的等值连接，会去掉重复的列。用的少。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-- 内连接,笛卡尔乘积 800行</span><br><span class="line">SELECT * from employees JOIN salaries;</span><br><span class="line">SELECT * from employees INNER JOIN salaries;</span><br><span class="line">-- ON等值连接 40行</span><br><span class="line">SELECT * from employees JOIN salaries ON employees.emp_no = salaries.emp_no;</span><br><span class="line">-- 自然连接,去掉了重复列,且自行使用employees.emp_no = salaries.emp_no的条件</span><br><span class="line">SELECT * from employees NATURAL JOIN salaries;</span><br></pre></td></tr></table></figure>
<p>外连接<br>outer join，可以省略为join<br>分为左外连接，即左连接；右外连接，即右连接；全外连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- 左连接</span><br><span class="line">SELECT * from employees LEFT JOIN salaries ON employees.emp_no = salaries.emp_no;</span><br><span class="line">-- 右连接</span><br><span class="line">SELECT * from employees RIGHT JOIN salaries ON employees.emp_no = salaries.emp_no;</span><br><span class="line">-- 这个右连接等价于上面的左连接</span><br><span class="line">SELECT * from salaries RIGHT JOIN employees ON employees.emp_no = salaries.emp_no;</span><br></pre></td></tr></table></figure>
<p>左外连接、右外连接<br>看表的数据的方向，谁是主表，谁的所有数据都显示<br>自连接<br>表自己和自己连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select manager.* from emp manager,emp worker where manaer.empno=worker.mgr and worker.empno=1;</span><br><span class="line">select manager.* from emp manager inner join emp worker on manaer.empno=worker.mgr where</span><br><span class="line">worker.empno=1;</span><br></pre></td></tr></table></figure>
<h2 id="事务Transaction"><a href="#事务Transaction" class="headerlink" title="事务Transaction"></a>事务Transaction</h2><p>InnoDB引擎，支持事务。<br>事务，由若干条语句组成的，指的是要做的一系列操作。<br>关系型数据库中支持事务，必须支持其四个属性(ACID)：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>原子性（atomicity）</td>
<td>一个事务是一个不可分割的工作单位,事务中包括的所有操作要么全部做完,要么什么都不做</td>
</tr>
<tr>
<td>一致性（consistency）</td>
<td>事务必须是使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的</td>
</tr>
<tr>
<td>隔离性（isoiation）</td>
<td>一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的,并发执行的各个事务之间不能互相干扰</td>
</tr>
<tr>
<td>持久性（durability）</td>
<td>持久性也称永久性(permanence),指一个事务一旦提交,它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响</td>
</tr>
</tbody>
</table>
<blockquote>
<p>  原子性，要求事务中的所有操作，不可分割，不能做了一部分操作，还剩一部分操作;<br>  一致性，多个事务并行执行的结果，应该和事务排队执行的结果一致。如果事务的并行执行和多线程读写共享资源一样不可预期，就不能保证一致性。<br>  隔离性，就是指多个事务访问共同的数据了，应该互不干扰。隔离性,指的是究竟在一个事务处理期间，其他事务能不能访问的问题<br>  持久性，比较好理解，就是事务提交后，数据不能丢失。</p>
</blockquote>
<p>MySQL隔离级别<br>隔离性不好，事务的操作就会互相影响，带来不同严重程度的后果。<br>首先看看隔离性不好，带来哪些问题：</p>
<ol>
<li>更新丢失Lost Update<br>事务A和B，更新同一个数据，它们都读取了初始值100，A要减10，B要加100，A减去10后更新为90，B加100更新为200，A的更新丢失了，就像从来没有减过10一样。</li>
<li>脏读<br> 事务A和B，事务B读取到了事务A未提交的数据（这个数据可能是一个中间值，也可能事务A后来回滚事务）。事务A是否最后提交并不关心。只要读取到了这个被修改的数据就是脏读。</li>
<li>不可重复读Unrepeatable read<br> 事务A在事务执行中相同查询语句，得到了不同的结果，不能保证同一条查询语句重复读相同的结果就是不可以重复读。<br> 例如，事务A查询了一次后，事务B修改了数据，事务A又查询了一次，发现数据不一致了。<br> 注意，脏读讲的是可以读到相同的数据的，但是读取的是一个未提交的数据，不是提交的最终结果。</li>
<li>幻读Phantom read<br> 事务A中同一个查询要进行多次，事务B插入数据，导致A返回不同的结果集，如同幻觉,就是幻读。<br> 数据集有记录增加了，可以看做是增加了记录的不可重复读。<br> 有了上述问题，数据库就必须要解决，提出了隔离级别。<br> 隔离级别由低到高，如下表</li>
</ol>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>READ UNCOMMITTED</td>
<td>读取到未提交的数据</td>
</tr>
<tr>
<td>READ COMMITTED</td>
<td>读已经提交的数据，ORACLE默认隔离级别</td>
</tr>
<tr>
<td>REPEATABLE READ</td>
<td>可以重复读，MySQL的 默认隔离级别。</td>
</tr>
<tr>
<td>SERIALIZABLE</td>
<td>可串行化。事务间完全隔离，事务不能并发，只能串行执行</td>
</tr>
</tbody>
</table>
<p>隔离级别越高，串行化越高，数据库执行效率低;隔离级别越低，并行度越高，性能越高。<br>隔离级别越高，当前事务处理的中间结果对其它事务不可见程度越高。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-- 设置会话级或者全局隔离级别</span><br><span class="line">SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL</span><br><span class="line">&#123;READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE&#125;</span><br><span class="line">-- 查询隔离级别</span><br><span class="line">SELECT @@global.tx_isolation;</span><br><span class="line">SELECT @@tx_isolation;</span><br><span class="line">SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line">SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br></pre></td></tr></table></figure>
<p>SERIALIZABLE，串行了，解决所有问题<br>REPEATABLE READ，事务A中同一条查询语句返回同样的结果，就是可以重复读数据了。例如语句为<code>(select * from user)</code>。解决的办法有：</p>
<ol>
<li><p>对select的数据加锁，不允许其它事务删除、修改的操作</p>
</li>
<li><p>第一次select的时候，对最后一次确切提交的事务的结果做快照</p>
</li>
</ol>
<p>解决了不可以重复读，但是有可能出现幻读。因为另一个事务可以增删数据。</p>
<p>READ COMMITTED，在事务中，每次select可以读取到别的事务刚提交成功的新的数据。因为读到的是提交后的数据，解决了脏读，但是不能解决不可重复读和幻读的问题。因为其他事务前后修改了数据或增删了数据。READ UNCOMMITTED，能读取到别的事务还没有提交的数据，完全没有隔离性可言，出现了脏读，当前其他问题都可能出现。</p>
<p>事务语法</p>
<p>START TRANSACTION或BEGIN开始一个事务，START TRANSACTION是标准SQL的语法。</p>
<p>使用COMMIT提交事务后，变更成为永久变更。<br>ROLLBACK可以在提交事务之前，回滚变更,事务中的操作就如同没有发生过一样（原子性）。<br>SET AUTOCOMMIT语句可以禁用或启用默认的autocommit模式，用于当前连接。SET AUTOCOMMIT = 0禁用自    动提交事务。如果开启自动提交,如果有一个修改表的语句执行后,会立即把更新存储到磁盘。</p>
<h2 id="数据仓库和数据库的区别"><a href="#数据仓库和数据库的区别" class="headerlink" title="数据仓库和数据库的区别"></a>数据仓库和数据库的区别</h2><p>本质上来说没有区别，都是存放数据的地方。但是数据库关注数据的持久化、数据的关系,为业务系统提供支持，事务支持；数据仓库存储数据的是为了分析或者发掘而设计的表结构，可以存储海量数据。<br>数据库存储在线交易数据OLTP(联机事务处理OLTP，On-line Transaction Processing)；数据仓库存储历史数据用于分析OLAP(联机分析处理OLAP，On-Line Analytical Processing)。<br>数据库支持在线业务，需要频繁增删改查；数据仓库一般囤积历史数据支持用于分析的SQL，一般不建议删改。</p>
<h2 id="其他概念"><a href="#其他概念" class="headerlink" title="其他概念"></a>其他概念</h2><h3 id="游标Cursor"><a href="#游标Cursor" class="headerlink" title="游标Cursor"></a>游标Cursor</h3><p>操作查询的结果集的一种方法。<br>可以将游标当做一个指针，指向结果集中的某一行。</p>
<h3 id="存储过程、触发器"><a href="#存储过程、触发器" class="headerlink" title="存储过程、触发器"></a>存储过程、触发器</h3><p>存储过程(Stored Procedure)，数据库系统中，一段完成特定功能的SQL语句。编写成类似函数的方式,可以传参并调用。支持流程控制语句。<br>触发器(Trigger)，由事件触发的特殊的存储过程，例如insert数据时触发。<br>触发器功能虽然强大，但是会有性能问题。<br>这两种技术，虽然是数据库高级内容，但基本很少用了。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/29/python基础学习-WEB框架高级功能之模板、拦截器、Json、打包/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/29/python基础学习-WEB框架高级功能之模板、拦截器、Json、打包/" itemprop="url">
                  python基础学习-WEB框架高级功能之模板、拦截器、Json、打包
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2020-10-29 16:24:02" itemprop="dateCreated datePublished" datetime="2020-10-29T16:24:02+08:00">2020-10-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2020-11-17 08:58:32" itemprop="dateModified" datetime="2020-11-17T08:58:32+08:00">2020-11-17</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="类Flask框架实现"><a href="#类Flask框架实现" class="headerlink" title="类Flask框架实现"></a>类Flask框架实现</h1><h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>目前在框架中返回的是字符串，这些字符串返回时会被webob包装成Response对象，这些就是HTTP响应的正文。<br>这种方式有一个问题，就是数据和HTML混合在一起，也就是数据和数据的格式混在了一起。能否将数据和格式分离?</p>
<p>思路<br>request请求被handler处理后得到数据，设计一个HTML网页，其中设置一些特殊的字符，将数据插入到这个HTML网页中指定的位置，生成新的HTML，返回浏览器端。<br>设计首页HTML模板index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"</span></span><br><span class="line"><span class="meta">	"http://www.w3.org/TR/html4/loose.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Magedu<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">显示数据<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">&#123;&#123;id&#125;&#125; &#123;&#123;name&#125;&#125; &#123;&#123;age&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在网页中使用双花括号来表示占位符，例如<code></code>，以后只需要找到这个位置，从数据中找到对应名称的数据替换即可。<br>为此，提供一个字典 <code>{&#39;id&#39;:5, &#39;name&#39;:&#39;tom&#39;, &#39;age&#39;:20}</code> ，将这些数据插入对应的占位符中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO, BytesIO</span><br><span class="line"></span><br><span class="line">d = &#123;<span class="string">'id'</span>:<span class="number">5</span>, <span class="string">'name'</span>:<span class="string">'tom'</span>, <span class="string">'age'</span>:<span class="number">20</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span>:</span></span><br><span class="line">    _pattern = <span class="string">'&#123;&#123;([a-zA-Z0-9_]+)&#125;&#125;'</span></span><br><span class="line">    regex = re.compile(_pattern)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(cls, template, data:dict)</span>:</span></span><br><span class="line">        html = StringIO()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> open(template, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                start = <span class="number">0</span></span><br><span class="line">                newline = <span class="string">''</span></span><br><span class="line">                <span class="keyword">for</span> matcher <span class="keyword">in</span> cls.regex.finditer(line):</span><br><span class="line">                    newline += line[start:matcher.start()]</span><br><span class="line">                    print(matcher, matcher.group(<span class="number">1</span>))</span><br><span class="line">                    key = matcher.group(<span class="number">1</span>)</span><br><span class="line">                    tmp = data.get(key, <span class="string">''</span>)</span><br><span class="line">                    newline += str(tmp)</span><br><span class="line">                    start = matcher.end()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    newline += line[start:]</span><br><span class="line">                html.write(newline)</span><br><span class="line">            print(html.getvalue())</span><br><span class="line">        html.close()</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 模板渲染</span></span><br><span class="line">filename = <span class="string">'index.html'</span></span><br><span class="line">Template.render(filename, d)</span><br></pre></td></tr></table></figure>
<h3 id="jinja2"><a href="#jinja2" class="headerlink" title="jinja2"></a>jinja2</h3><p>基于Python的模板引擎。设计思想来自Django的模板引擎，和其非常相似。<br>文档<br>官网 <a href="http://jinja.pocoo.org/docs/2.10/" target="_blank" rel="noopener">http://jinja.pocoo.org/docs/2.10/</a><br>中文 <a href="http://docs.jinkan.org/docs/jinja2/" target="_blank" rel="noopener">http://docs.jinkan.org/docs/jinja2/</a></p>
<p>安装<br><code>pip install jinja2</code><br><code>pip install MarkupSafe</code></p>
<p>模板构建<br>在当前项目下，新建包webarch，其下新建一个目录templates，该目录下新建一个HTML模板文件index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"</span></span><br><span class="line"><span class="meta">	"http://www.w3.org/TR/html4/loose.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Magedu<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">显示数据<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% for id,name,age in userlist %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;loop.index&#125;&#125; &#123;&#123;id&#125;&#125;, &#123;&#123;name&#125;&#125;, &#123;&#123;age&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">总共&#123;&#123;usercount&#125;&#125;人</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>加载模板代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment, PackageLoader, FileSystemLoader</span><br><span class="line"></span><br><span class="line"><span class="comment">#env = Environment(loader=PackageLoader('webarch', 'templates')) # 包加载器</span></span><br><span class="line">env = Environment(loader=FileSystemLoader(<span class="string">'webarch/templates'</span>)) <span class="comment"># 文件系统加载器</span></span><br><span class="line"></span><br><span class="line">template = env.get_template(<span class="string">'index.html'</span>) <span class="comment"># 搜索模块</span></span><br><span class="line"></span><br><span class="line">userlist = [</span><br><span class="line">    (<span class="number">3</span>, <span class="string">'tom'</span>, <span class="number">20</span>),</span><br><span class="line">    (<span class="number">5</span>, <span class="string">'jerry'</span>, <span class="number">16</span>),</span><br><span class="line">    (<span class="number">6</span>, <span class="string">'sam'</span>, <span class="number">23</span>),</span><br><span class="line">    (<span class="number">8</span>, <span class="string">'kevin'</span>, <span class="number">18</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">d = &#123;<span class="string">'userlist'</span>:userlist, <span class="string">'usercount'</span>:len(userlist)&#125;</span><br><span class="line">print(template.render(**d))</span><br></pre></td></tr></table></figure>
<p>提供模板模块template.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment, PackageLoader, FileSystemLoader</span><br><span class="line"></span><br><span class="line"><span class="comment">#env = Environment(loader=PackageLoader('webarch', 'templates')) # 包加载器</span></span><br><span class="line">env = Environment(loader=FileSystemLoader(<span class="string">'webarch/templates'</span>)) <span class="comment"># 文件系统加载器</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(name, data:dict)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    模板渲染</span></span><br><span class="line"><span class="string">    :param name: 去模板目录搜索此模板名的文件</span></span><br><span class="line"><span class="string">    :param data: 字典</span></span><br><span class="line"><span class="string">    :return: HTML字符串</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    template = env.get_template(name) <span class="comment"># 搜索模块index.html</span></span><br><span class="line">    <span class="keyword">return</span> template.render(**data)</span><br></pre></td></tr></table></figure>
<p>代码中增加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Router对象</span></span><br><span class="line">idx = Router()</span><br><span class="line">py = Router(<span class="string">'/python'</span>)</span><br><span class="line">user = Router(<span class="string">'/user'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册</span></span><br><span class="line">App.register(idx, py)</span><br><span class="line">App.register(user)</span><br><span class="line"></span><br><span class="line"><span class="meta">@user.get(r'^/?$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">userhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    userlist = [</span><br><span class="line">        (<span class="number">3</span>, <span class="string">'tom'</span>, <span class="number">20</span>),</span><br><span class="line">        (<span class="number">5</span>, <span class="string">'jerry'</span>, <span class="number">16</span>),</span><br><span class="line">        (<span class="number">6</span>, <span class="string">'sam'</span>, <span class="number">23</span>),</span><br><span class="line">        (<span class="number">8</span>, <span class="string">'kevin'</span>, <span class="number">18</span>)</span><br><span class="line">    ]</span><br><span class="line">    d = &#123;<span class="string">'userlist'</span>: userlist, <span class="string">'usercount'</span>: len(userlist)&#125;</span><br><span class="line">    <span class="keyword">return</span> render(<span class="string">'index.html'</span>, d)</span><br></pre></td></tr></table></figure>
<h2 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h2><p><img src="/images/python-WEB开发/WEB开发7.png" alt=""></p>
<p>包webarch<br>template.py模块移入此包<br>新建web.py模块，将AttrDict、Router、App类放入其中<br>将路由定义、注册代码、handler定义挪入 webarch/<strong>init</strong>.py 中<br>在项目根目录下，建一个app.py，里面放入启动server的代码</p>
<h2 id="拦截器-interceptor"><a href="#拦截器-interceptor" class="headerlink" title="拦截器 interceptor"></a>拦截器 interceptor</h2><p>拦截器，就是要在请求处理环节的某处加入处理，有可能是中断后续的处理。<br>根据拦截点不同，分为:<br>1、请求时拦截<br>2、响应时拦截</p>
<p>根据影响面分为:<br>1、全局拦截<br>在App中拦截<br>2、局部拦截<br>在Router中拦截</p>
<p><img src="/images/python-WEB开发/WEB开发8.png" alt=""></p>
<p>拦截器可以是多个，多个拦截器执行是有顺序的<br>数据response前执行的命名为preinterceptor，之后的命名为postinterceptor。</p>
<p>加入拦截器功能的方式<br>1、App和Router类直接加入<br>把拦截器的相关方法、属性分别添加到相关类中<br>实现简单<br>2、Mixin<br>App和Router类都需要这个拦截器功能，这两个类有没有什么关系，可以使用Mixin方式,将属性、方法组合进来<br>但是，App类拦截器适合使用第二种，但是Router的拦截器是每个实例不一样的，所以使用第一种方式实现</p>
<p>拦截函数fn的设计<br>fn不能影响数据继续向下一级的传递，也就是它是“透明”的。<br>handle之前，函数签名应该如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn</span><span class="params">(request:Request)</span> -&gt; Request:</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>引入app，是为了以后从Application上获取一些全局信息。<br>handle执行之后，有了response对象，所以函数签名应该如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn</span><span class="params">(request:Request, request:Response)</span> -&gt; Response:</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>拦截器代码实现，见本文最后的完整代码</p>
<h3 id="IP拦截"><a href="#IP拦截" class="headerlink" title="IP拦截"></a>IP拦截</h3><p><code>/python</code> 只允许192开头的IP访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Router对象</span></span><br><span class="line">idx = Router()</span><br><span class="line">py = Router(<span class="string">'/python'</span>)</span><br><span class="line">user = Router(<span class="string">'/user'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册</span></span><br><span class="line">App.register(idx, py)</span><br><span class="line">App.register(user)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ip</span><span class="params">(request:Request)</span>:</span></span><br><span class="line">    print(request.remote_addr, <span class="string">'~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">    print(type(request.remote_addr))</span><br><span class="line">    <span class="keyword">if</span> request.remote_addr.startswith(<span class="string">'192.'</span>):</span><br><span class="line">    	<span class="keyword">return</span> request</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	<span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">    </span><br><span class="line">py.register_preinterceptor(ip)</span><br></pre></td></tr></table></figure>
<h2 id="Json支持"><a href="#Json支持" class="headerlink" title="Json支持"></a>Json支持</h2><p>webob.response.Response支持json，如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@py.get('^/&#123;id&#125;$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    userlist = [</span><br><span class="line">        (<span class="number">3</span>, <span class="string">'tom'</span>, <span class="number">20</span>),</span><br><span class="line">        (<span class="number">5</span>, <span class="string">'jerry'</span>, <span class="number">16</span>),</span><br><span class="line">        (<span class="number">6</span>, <span class="string">'sam'</span>, <span class="number">23</span>),</span><br><span class="line">        (<span class="number">8</span>, <span class="string">'kevin'</span>, <span class="number">18</span>)</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    d = &#123;<span class="string">'userlist'</span>: userlist, <span class="string">'usercount'</span>: len(userlist)&#125;</span><br><span class="line">    res = Response(json=d)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">======================</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jsonify</span><span class="params">(**kwargs)</span>:</span>  <span class="comment"># ify表示什么化，如这里就是json化</span></span><br><span class="line">    content = json.dumps(kwargs)  <span class="comment"># 不用文件对象，用dumps方法，用文件对象时，用dump方法</span></span><br><span class="line">    <span class="keyword">return</span> MagWeb.Response(content, <span class="string">'200 OK'</span>, content_type=<span class="string">'application/json'</span>, charset=<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure>
<p>测试 <a href="http://127.0.0.1:9999/python/123，返回" target="_blank" rel="noopener">http://127.0.0.1:9999/python/123，返回</a> <code>{&quot;userlist&quot;:[[3,&quot;tom&quot;,20],[5,&quot;jerry&quot;,16],[6,&quot;sam&quot;,23],
[8,&quot;kevin&quot;,18]],&quot;usercount&quot;:4}</code></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><p>熟悉WSGI的编程接口</p>
</li>
<li><p>强化模块化、类封装的思想</p>
</li>
<li><p>增强分析业务的能力</p>
</li>
</ol>
<p>这个框架基本具备了WSGI WEB框架的基本功能，其他框架都类似。<br>权限验证、SQL注入检测的功能使用拦截器实现。</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p><code>webarch/__init__.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="comment"># 模板</span></span><br><span class="line"><span class="keyword">from</span> .template <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> .web <span class="keyword">import</span> Router, App</span><br><span class="line"><span class="comment"># 用点导入模块内自己的方法，import后是要暴露出来的方法，其他方法就被保护起来了，如果要访问，要用template.test这样的方式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Router对象</span></span><br><span class="line">idx = Router()</span><br><span class="line">py = Router(<span class="string">'/python'</span>)</span><br><span class="line">user = Router(<span class="string">'/user'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册</span></span><br><span class="line">App.register(idx, py)</span><br><span class="line">App.register(user)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip拦截</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ip</span><span class="params">(request:Request)</span>:</span></span><br><span class="line">    print(request.remote_addr, <span class="string">'~~~~~~~~~~~~~~~'</span>)</span><br><span class="line">    print(type(request.remote_addr))</span><br><span class="line">    <span class="keyword">if</span> request.remote_addr.startswith(<span class="string">'192.'</span>):</span><br><span class="line">    	<span class="keyword">return</span> request</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	<span class="keyword">return</span> <span class="keyword">None</span> <span class="comment"># 返回None将截断请求</span></span><br><span class="line">    </span><br><span class="line">py.register_preinterceptor(ip)</span><br><span class="line"></span><br><span class="line"><span class="meta">@idx.get(r'^/$')</span></span><br><span class="line"><span class="meta">@idx.route(r'^/&#123;id:int&#125;$') # 支持所有方法访问</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    id = <span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span> request.vars:</span><br><span class="line">        id = request.vars.id</span><br><span class="line">        print(type(id))</span><br><span class="line">	<span class="keyword">return</span> <span class="string">'&lt;h1&gt;马哥教育欢迎你&#123;&#125;. magedu.com&lt;/h1&gt;'</span>.format(id)</span><br><span class="line"></span><br><span class="line"><span class="meta">@py.get('^/&#123;id&#125;$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pythonhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    userlist = [</span><br><span class="line">        (<span class="number">3</span>, <span class="string">'tom'</span>, <span class="number">20</span>),</span><br><span class="line">        (<span class="number">5</span>, <span class="string">'jerry'</span>, <span class="number">16</span>),</span><br><span class="line">        (<span class="number">6</span>, <span class="string">'sam'</span>, <span class="number">23</span>),</span><br><span class="line">        (<span class="number">8</span>, <span class="string">'kevin'</span>, <span class="number">18</span>)</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    d = &#123;<span class="string">'userlist'</span>: userlist, <span class="string">'usercount'</span>: len(userlist)&#125;</span><br><span class="line">    res = Response(json=d)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="meta">@user.get(r'^/?$')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">userhandler</span><span class="params">(request)</span>:</span></span><br><span class="line">    userlist = [</span><br><span class="line">        (<span class="number">3</span>, <span class="string">'tom'</span>, <span class="number">20</span>),</span><br><span class="line">        (<span class="number">5</span>, <span class="string">'jerry'</span>, <span class="number">16</span>),</span><br><span class="line">        (<span class="number">6</span>, <span class="string">'sam'</span>, <span class="number">23</span>),</span><br><span class="line">        (<span class="number">8</span>, <span class="string">'kevin'</span>, <span class="number">18</span>)</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    d = &#123;<span class="string">'userlist'</span>: userlist, <span class="string">'usercount'</span>: len(userlist)&#125;</span><br><span class="line">    <span class="keyword">return</span> render(<span class="string">'index.html'</span>, d)</span><br></pre></td></tr></table></figure>
<p><code>webarch/web.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> wsgify</span><br><span class="line"><span class="keyword">from</span> webob <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="keyword">from</span> webob.exc <span class="keyword">import</span> HTTPNotFound</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttrDict</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, d:dict)</span>:</span></span><br><span class="line">    	self.__dict__.update(d <span class="keyword">if</span> isinstance(d, dict) <span class="keyword">else</span> &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="comment"># 不允许修改属性</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> <span class="string">"&lt;AttrDict &#123;&#125;&gt;"</span>.format(self.__dict__)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> len(self.__dict__)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>:</span></span><br><span class="line">    <span class="comment">############# 正则转换</span></span><br><span class="line">    __regex = re.compile(<span class="string">r'/&#123;([^&#123;&#125;:]+):?([^&#123;&#125;:]*)&#125;'</span>)</span><br><span class="line">    </span><br><span class="line">    TYPEPATTERNS = &#123;</span><br><span class="line">        <span class="string">'str'</span>: <span class="string">r'[^/]+'</span>,</span><br><span class="line">        <span class="string">'word'</span>: <span class="string">r'\w+'</span>,</span><br><span class="line">        <span class="string">'int'</span>: <span class="string">r'[+-]?\d+'</span>,</span><br><span class="line">        <span class="string">'float'</span>: <span class="string">r'[+-]?\d+\.\d+'</span>,  <span class="comment"># 严苛的要求必须是 15.6这样的形式</span></span><br><span class="line">        <span class="string">'any'</span>: <span class="string">r'.+'</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    TYPECAST = &#123;</span><br><span class="line">        <span class="string">'str'</span>: str,</span><br><span class="line">        <span class="string">'word'</span>: str,</span><br><span class="line">        <span class="string">'int'</span>: int,</span><br><span class="line">        <span class="string">'float'</span>: float,</span><br><span class="line">        <span class="string">'any'</span>: str</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__parse</span><span class="params">(self, src: str)</span>:</span></span><br><span class="line">        start = <span class="number">0</span></span><br><span class="line">        repl = <span class="string">''</span></span><br><span class="line">        types = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        matchers = self.__regex.finditer(src)</span><br><span class="line">        <span class="keyword">for</span> i, matcher <span class="keyword">in</span> enumerate(matchers):</span><br><span class="line">            name = matcher.group(<span class="number">1</span>)</span><br><span class="line">            t = matcher.group(<span class="number">2</span>)</span><br><span class="line">            </span><br><span class="line">            types[name] = self.TYPECAST.get(matcher.group(<span class="number">2</span>), str)</span><br><span class="line">            </span><br><span class="line">            repl += src[start:matcher.start()]  <span class="comment"># 拼接分组前</span></span><br><span class="line">            tmp = <span class="string">'/(?P&lt;&#123;&#125;&gt;&#123;&#125;)'</span>.format(</span><br><span class="line">                matcher.group(<span class="number">1</span>),</span><br><span class="line">                self.TYPEPATTERNS.get(matcher.group(<span class="number">2</span>), self.TYPEPATTERNS[<span class="string">'str'</span>])</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">			repl += tmp <span class="comment"># 替换</span></span><br><span class="line">	            </span><br><span class="line">			start = matcher.end()  <span class="comment"># 移动</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">        	repl += src[start:]  <span class="comment"># 拼接分组后的内容</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> repl, types</span><br><span class="line">    </span><br><span class="line">    <span class="comment">############ 实例</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, prefix:str=<span class="string">''</span>)</span>:</span></span><br><span class="line">        self.__prefix = prefix.rstrip(<span class="string">'/\\'</span>) <span class="comment"># 前缀,例如/product</span></span><br><span class="line">        self.__routetable = [] <span class="comment"># 存四元组,列表,有序的</span></span><br><span class="line">        </span><br><span class="line">		<span class="comment"># 拦截器</span></span><br><span class="line">        self.pre_interceptor = []</span><br><span class="line">        self.post_interceptor = []</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 拦截器注册函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register_preinterceptor</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.pre_interceptor.append(fn)</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register_postinterceptor</span><span class="params">(self, fn)</span>:</span></span><br><span class="line">        self.post_interceptor.append(fn)</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, rule, *methods)</span>:</span> <span class="comment"># 注册路由,装饰器</span></span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(handler)</span>:</span></span><br><span class="line">            <span class="comment"># /student/&#123;name:str&#125;/xxx/&#123;id:int&#125; =&gt;</span></span><br><span class="line">            <span class="comment"># '/student/(?P&lt;name&gt;[^/]+)/xxx/(?P&lt;id&gt;[+-]?\\d+)'</span></span><br><span class="line">            pattern, trans = self.__parse(rule) <span class="comment"># 用户输入规则转换为正则表达式</span></span><br><span class="line">            self.__routetable.append(</span><br><span class="line">                (tuple(map(<span class="keyword">lambda</span> x: x.upper(), methods)),re.compile(pattern), <span class="comment"># 编译</span></span><br><span class="line">                trans,</span><br><span class="line">                handler)</span><br><span class="line">            ) <span class="comment"># (方法元组,预编译正则对象,类型转换,处理函数)</span></span><br><span class="line">			<span class="keyword">return</span> handler</span><br><span class="line">		<span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self.route(pattern, <span class="string">'GET'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> self.route(pattern, <span class="string">'POST'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">head</span><span class="params">(self, pattern)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> self.route(pattern, <span class="string">'HEAD'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="comment"># 必须先匹配前缀</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.path.startswith(self.__prefix):</span><br><span class="line">        	<span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 是此Router的请求,开始拦截,处理request</span></span><br><span class="line">        <span class="keyword">for</span> fn <span class="keyword">in</span> self.pre_interceptor:</span><br><span class="line">            request = fn(request)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> request:</span><br><span class="line">            	<span class="keyword">return</span> <span class="keyword">None</span> <span class="comment"># 请求为None将不再向后传递,截止</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 前缀匹配,说明就必须这个Router实例处理,后续匹配不上,依然返回None</span></span><br><span class="line">        <span class="keyword">for</span> methods, pattern, trans, handler <span class="keyword">in</span> self.__routetable:</span><br><span class="line">            <span class="comment"># not methods表示一个方法都没有定义,就是支持全部方法</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> methods <span class="keyword">or</span> request.method.upper() <span class="keyword">in</span> methods:</span><br><span class="line">                <span class="comment"># 前提已经是以__prefix开头了,可以replace,去掉prefix剩下的才是正则表达式需要匹配的路径</span></span><br><span class="line">                matcher = pattern.match(request.path.replace(self.__prefix, <span class="string">''</span>, <span class="number">1</span>))</span><br><span class="line">				<span class="keyword">if</span> matcher: <span class="comment"># 正则匹配</span></span><br><span class="line">                    newdict = &#123;&#125;</span><br><span class="line">                    <span class="keyword">for</span> k,v <span class="keyword">in</span> matcher.groupdict().items(): <span class="comment"># 命名分组组成的字典</span></span><br><span class="line">						newdict[k] = trans[k](v)</span><br><span class="line">                    <span class="comment"># 动态为request增加属性</span></span><br><span class="line">                    request.vars = AttrDict(newdict) <span class="comment"># 属性化</span></span><br><span class="line">                    response = handler(request)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 依次拦截,处理响应</span></span><br><span class="line">                    <span class="keyword">for</span> fn <span class="keyword">in</span> self.post_interceptor:</span><br><span class="line">						response = fn(request, response)</span><br><span class="line">					<span class="keyword">return</span> response</span><br><span class="line">                </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line"><span class="comment">#    Router = _Router</span></span><br><span class="line"><span class="comment">#    Request = Request</span></span><br><span class="line"><span class="comment">#    Response = Response</span></span><br><span class="line"><span class="comment"># 通过上面这种方法，使用一个与类名称相同的名称，并类赋值给新名称，这样在导入这个模块时，就可以使用原来类中的</span></span><br><span class="line"><span class="comment"># 方法了，如Router = _Router，_Router是类，在导入当前这个模块后，就可以使用_Router类的方法了。    </span></span><br><span class="line">    </span><br><span class="line">    _ROUTERS = [] <span class="comment"># 存储所有一级Router对象</span></span><br><span class="line">    <span class="comment"># 全局拦截器</span></span><br><span class="line">    PRE_INTERCEPTOR = []</span><br><span class="line">    POST_INTERCEPTOR = []</span><br><span class="line">    <span class="comment"># 全局拦截器注册函数</span></span><br><span class="line"><span class="meta">	@classmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">register_preinterceptor</span><span class="params">(cls, fn)</span>:</span></span><br><span class="line">        cls.PRE_INTERCEPTOR.append(fn)</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">register_postinterceptor</span><span class="params">(cls, fn)</span>:</span></span><br><span class="line">        cls.POST_INTERCEPTOR.append(fn)</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 注册路由</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(cls, *routers:Router)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> router <span class="keyword">in</span> routers:</span><br><span class="line">        	cls._ROUTERS.append(router)</span><br><span class="line">            </span><br><span class="line"><span class="meta">    @wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        <span class="comment"># 全局拦截请求</span></span><br><span class="line">        <span class="keyword">for</span> fn <span class="keyword">in</span> self.PRE_INTERCEPTOR:</span><br><span class="line">			request = fn(request)</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 遍历_ROTERS,调用Router实例的match方法,看谁匹配</span></span><br><span class="line">        <span class="keyword">for</span> router <span class="keyword">in</span> self._ROUTERS:</span><br><span class="line">			response = router.match(request)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 全局拦截响应</span></span><br><span class="line">            <span class="keyword">for</span> fn <span class="keyword">in</span> self.POST_INTERCEPTOR:</span><br><span class="line">				response = fn(request, response)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> response: <span class="comment"># 匹配返回非None的Router对象</span></span><br><span class="line">        		<span class="keyword">return</span> response <span class="comment"># 匹配则立即返回</span></span><br><span class="line">        <span class="keyword">raise</span> HTTPNotFound(<span class="string">'&lt;h1&gt;你访问的页面被外星人劫持了&lt;/h1&gt;'</span>)</span><br></pre></td></tr></table></figure>
<p><code>webarch/template.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment, PackageLoader, FileSystemLoader</span><br><span class="line"></span><br><span class="line"><span class="comment">#env = Environment(loader=PackageLoader('webarch', 'templates')) # 包加载器</span></span><br><span class="line">env = Environment(loader=FileSystemLoader(<span class="string">'webarch/templates'</span>)) <span class="comment"># 文件系统加载器</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(name, data:dict)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    模板渲染</span></span><br><span class="line"><span class="string">    :param name: 去模板目录搜索此模板名的文件</span></span><br><span class="line"><span class="string">    :param data: 字典</span></span><br><span class="line"><span class="string">    :return: HTML字符串</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    template = env.get_template(name) <span class="comment"># 搜索模块index.html</span></span><br><span class="line">    <span class="keyword">return</span> template.render(**data)</span><br></pre></td></tr></table></figure>
<p><code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">from</span> webarch <span class="keyword">import</span> App</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ip = <span class="string">'0.0.0.0'</span></span><br><span class="line">    port = <span class="number">9999</span></span><br><span class="line">    server = make_server(ip, port, App())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	server.serve_forever() <span class="comment"># server.handle_request() 一次</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br></pre></td></tr></table></figure>
<h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><p><code>setup.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> distutils.core <span class="keyword">import</span> setup</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入setup函数并传参</span></span><br><span class="line">setup(name=<span class="string">'webarch'</span>,</span><br><span class="line">    version=<span class="string">'0.1.0'</span>,</span><br><span class="line">    description=<span class="string">'Python WSGI WEB Framework'</span>,</span><br><span class="line">    author=<span class="string">'wayne'</span>,</span><br><span class="line">    author_email=<span class="string">'wayne@magedu.com'</span>,</span><br><span class="line">    url=<span class="string">'https://www.magedu.com'</span>,</span><br><span class="line">    <span class="comment">#packages=['m', 'm.m1', 'm.m2', 'm.m2.m21'],</span></span><br><span class="line">    packages=[<span class="string">'webarch'</span>],</span><br><span class="line">    <span class="comment">#data_files=['webarch/templates/index.html']</span></span><br><span class="line">    data_files=glob.glob(<span class="string">'webarch/templates/*'</span>) <span class="comment"># 返回列表</span></span><br><span class="line">    )</span><br><span class="line"><span class="comment"># name名字</span></span><br><span class="line"><span class="comment"># version 版本</span></span><br><span class="line"><span class="comment"># packages=[] 打包列表,</span></span><br><span class="line"><span class="comment"># packages=['magweb'],指定magweb,就会把magweb所有的非目录子模块打包</span></span><br><span class="line"><span class="comment"># description 描述信息</span></span><br><span class="line"><span class="comment"># author 作者</span></span><br><span class="line"><span class="comment"># author_email 作者邮件</span></span><br><span class="line"><span class="comment"># url 包的主页,可以不写</span></span><br><span class="line"><span class="comment"># data_files 配置文件、图片等文件列表。参看distutils.command.sdist.sdist#add_defaults</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包</span></span><br><span class="line">$ python setup.py sdist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ pip install webarch<span class="number">-0.1</span><span class="number">.0</span>.zip</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">265</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">185</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    本站总访问量: <span id="busuanzi_value_site_pv"></span>次
  </span>
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="訪客總數">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="總瀏覽次數">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
